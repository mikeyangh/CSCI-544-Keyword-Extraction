Page1耦合几何特征的高精度流体动画建模方法刘弘1),2)1)(山东师范大学信息科学与工程学院济南250014)2)(山东省分布式计算机软件新技术重点实验室济南250014)3)(中国科学院计算技术研究所北京100190)摘要动漫制作中涉及到大量的流体动画特效,视觉逼真性是它们的基本追求.然而,传统的物理模型计算代价高、效率低且流体细节易丢失.针对这些问题,文中提出一种耦合几何特征的高精度流体动画生成方法,通过利用不同流体细节(如水面和水花)之间的相关性提高计算效率和计算精度.该方法首先建立几何模型,对流体表面易于产生流体细节的区域即细节敏感区域进行定位、量化和跟踪.然后将几何模型与高精度流体动画物理模型相耦合,通过将几何模型中的定位量化函数映射为粒子密度函数,以此调整物理模型中的粒子集,从而更有效地产生高精度的流体水面和水花等细节效果.实验结果表明,文中方法能够提高流体动画计算的效率和精度,高效地生成更具有视觉真实感的流体动画.关键词几何特征;高精度流体动画;粒子分布;粒子水平集;光滑粒子流体动力学;纳维-斯托克斯方程1引言近年来,动漫制作产业已经成为我国重要的产业之一.动漫制作中涉及到大量的流体动画特效如水、烟、火等.在这些流体动画中,视觉逼真性是基本的追求.然而流体运动极其复杂,如何自动计算并渲染生成具有丰富细节的高精度流体动画是一项很有挑战性的课题.目前,为了生成视觉逼真的流体动画,研究者通常使用流体物理模型计算动态变化的速度场,并对流体介质进行建模和渲染来完成[1].但流体物理模型的数值求解产生的耗散问题会使尖锐和突变的几何特征平滑化,导致流体细节缺失,影响流体动画的效果[2].为此,研究人员使用多物理模型方法克服上述问题.该方法通过在流体运动模型的基础上,耦合其他物理模型(如高精度表面跟踪模型[3]、波浪模型[4]、水花模型[5]、气泡模型[6]等)从而产生流体高精度细节.由于需要求解多个物理模型,此方法存在运算复杂、计算代价高的问题.另外一种常用方法就是自适应方法[7-8].该方法在细节丰富区域或用户感兴趣区域使用高精度计算,而在其他区域使用低精度计算的方式,以缓解计算消耗大的问题.然而目前的自适应技术(如空间网格的自适应[7]、拉格朗日粒子集的自适应[8]等)基本上在单一物理模型上展开,难以同时表达流体运动的多尺度细节.事实上,高精度流体动画包含了丰富的几何信息,如拓扑多变的水面、飞溅的水花等.这些信息是流体运动行为的外在表现,是在有限计算资源条件下增强流体动画视觉效果的有效途径.本文将高精度流体运动的几何信息体现的特点归为两个:(1)不同流体细节之间存在密切相关性.例如,只有在水面产生大的几何变形或具有尖锐几何特征时,才会产生丰富的水花效果.当前方法中没有考虑到流体不同细节之间的相关性,并未据此实现对计算资源的优化配置.(2)同一种细节在不同区域存在差异性.例如,水面上有些区域相对平坦细节较少、而有些区域相对湍急细节较多.当前的自适应的方法特别是网格自适应技术往往对靠近流体表面所有区域使用相同的计算精度,没有考虑表面细节的差异性.针对以上分析,本文挖掘并利用流体动画中不同细节效果之间的相关性,同时考虑同一细节在不同区域的差异性,提出了一种耦合几何特征的高精度流体动画建模方法.该方法通过几何模型定位和跟踪流体表面上易于丢失细节的局部区域,并对细节缺失程度进行量化,以此控制物理模型并最终产生高精度流体细节.同时,本文方法还能有效利用细节之间的相关性以及表面不同区域的差异性进行合理的资源分布.本文方法只对粒子集进行控制,使用的是结构化网格,因此具备计算简单、高效的特性.控制后的物理模型不仅能提高水面模拟的精度,而且能够生成丰富的水花细节.2相关工作流体动画作为自然现象模拟的重要分支,是计算机动画的研究热点之一.在过去的十几年里,该领域一直致力于研究如何生成具有真实感的流体运动.它涉及两项关键技术:一是计算动态变化的流体速度场;二是对流体介质的建模与渲染.在实时游戏中,流体效果的产生通常是将上述两项关键技术合并在一起处理.常见的方法有[9-10]:快速傅里叶变换、表面法向扰动、过程纹理等.它们主要应用于模拟理想天气下的流体运动如风平浪静的效果或简单的水花,很难表达物理上真实的运动如流固耦合等.此外,该方法的视觉效果主要来自美工的手动调试或者程序员的设计,场景依赖性强,重复利用率不高.为了有效获得动态变化的流体速度场,一些研究者开始关注并使用纳维-斯托克斯(Navier-Stokes,NS)方程,奠定了在流体动画领域使用物理模型的里程碑[1].此后,基于物理的流体动画方法基本上分为两大类:一类是欧拉法[1,7],通过在计算域网格中求解NS方程获得流体速度场.另一类是拉格朗日法[8,11],利用粒子携带质量、速度等属性计算流体速度场.在拉格朗日方法中,光滑粒子流体动力学(SmoothParticleHydrodynamics,SPH)模型最具代表性[8,11-13].基于物理的方法可以获得任意初始条件和边界条件下的流体速度场,能够有效模拟流体的复杂运动.速度场的获得还为驱动流体介质运动、获得具有视觉真实感的流体动画奠定了基础.视觉逼真的流体动画离不开对流体介质的建模和渲染.对此,拉格朗日法和欧拉法分别使用不同的方式.拉格朗日法使用粒子模拟流体运动,液体表面的获取需要对粒子集使用插值方法[14-15]以生成多边形网格,此类方法很难获得光滑表面.而在欧拉法中,研究者最初提出使用隐式表面对液体表面进Page3行建模和表达.典型的方法有水平集(LevelSet,LS)[16]和粒子水平集(ParticleLevelSet,PLS)[1]等.隐式曲面方法使用符号距离场函数表达液体表面,通过求解LS方程获得每个时刻运动后的表面.该方法能够很自然的处理液体表面的复杂运动导致的拓扑变化问题,可生成光滑的流体表面,因此在流体动画领域得到了广泛的应用.然而,上述方法需要求解NS和LS两组偏微分方程,由于使用有限差分方法逼近偏微分方程,两者之间的误差会产生数值耗散问题.数值耗散相当于对流场添加人工粘性,使尖锐和突变的几何特征被平滑化,分辨率降低,从而导致流体细节缺失.故此类方法的计算精度严重依赖于网格分辨率,在粗糙网格下,容易产生流体细节丢失[2].为了提高液体表面建模和渲染的精度,研究者还提出使用显式表面的方法解决隐式表面精度不高的问题[3,17-18].其基本原理是在低精度计算网格中嵌入高精度的表面跟踪方法.该方法使用显式多边形网格表达液体表面,因此,液体表面的精度不再依赖于底层的计算网格,能较好地保持流体表面的细节.然而,显式表面的方法需要设计有效算法处理拓扑变化时的多边形表面.此外,高精度的显式表面和低精度物理模型耦合时,计算网格中不能捕捉到的高精度细节会产生细节残留,导致物理上不正确的结果和视觉错误[19-20].上述分析表明,相对于显式曲面方法,隐式曲面能更自然地处理拓扑变化,非常适合表示动态液体表面.因此,本文使用隐式曲面的方法———PLS方法跟踪流体表面.然而,如前所述,隐式曲面方法在粗糙网格中易于产生细节缺失问题.因此,研究者提出诸多方法解决该问题.目前,最典型的方法有两类:一类是多物理模型的方法,另一类是自适应方法.多物理模型通过耦合多个不同物理模型的方法产生复杂水面、水花等细节[4,21-22].例如,Losasso等人[4]首先使用二维NS方程预计算海浪形状;然后使用三维NS方程,同时耦合PLS模型和SPH模型,捕捉波浪、水花细节.Chentanez等人[21]使用了包括高度场模型和粒子模型在内的两个物理模型,同时通过处理复杂的边界条件模拟河流表面及水花.Kim等人[22]使用最近点方法在三维流体表面上计算二维波动方程以增加流体表面的细节.此外,研究者还在流体动力学模型及流体表面跟踪模型的基础上,通过耦合水花模型[5]、气泡模型[6]等,产生丰富的流体动画效果.上述方法集中在选择什么物理模型以及如何耦合这些物理模型方面,其模型计算代价高.自适应方法可以有效缓解模型计算量大的问题[23-25].该方法中最具代表性的工作就是空间网格的自适应细分,如八叉树的方法[26]、非结构化的四面体网格法等[27-29]、有限元四面体网格法等[30-31].此类方法中网格大小可随需求光滑变化,其形状也很容易达到与复杂边界对齐的目标,所以能够捕捉到高精度流体细节.然而,四面体网格法的计算精度依赖于网格生成的质量,而高质量的、与复杂边界对齐的网格生成往往需要花费大量的计算时间,成为此类方法的瓶颈问题[32].为了避免处理四面体网格,English等人[33]通过使用多种不同精度的规则网格实现自适应计算.此外,Irving等人[34]及Chentanez等人[7]只是在计算域的垂直方向进行自适应处理,通过在距离表面较远的位置使用细长网格以节省计算资源.尽管空间网格的自适应细分能够根据需求计算高精度细节,但其产生的非结构化或半结构化的网格会导致计算复杂性增加[35],制约了其可用性.除了对网格的自适应划分,研究者还将自适应思想引入到拉格朗日方法中.例如,Ando等人[32]利用粒子在空间上的自适应分布,模拟流体的细长面片.在SPH方法中,空间自适应方法[15]和双尺度方法[8]也被相继提出和应用.拉格朗日法中的自适应技术无需生成复杂的四面体网格,因此计算简单、高效.然而,针对拉格朗日粒子集设计的自适应方法很难直接应用于欧拉法中.因此,目前的自适应方法不能充分利用拉格朗日法和欧拉法两类方法的优势表现流体运动的多种细节.与已有方法不同,本文方法可以应用于欧拉法和拉格朗日法相结合的流体模型中,能够同时表达流体动画中的多种细节,如光滑水面、飞溅的水花等.为达成上述目标,本文挖掘并利用流体动画中细节效果之间的相关性,通过欧拉法获取流体表面数据并建立几何模型计算细节敏感区域.然后将获取的几何特征与物理模型相耦合,指导粒子集的自适应分布,以有效利用细节之间的相关性以及表面不同区域之间的差异性等几何特征.实验结果表明,本文方法能够高效生成流体的多种细节.此外,由于我们使用的是结构化网格,因此具备计算简单、高效的特性.Page43算法综述本文方法包括几何模型、物理模型以及耦合模型3个部分.其中,物理模型是基础,它能够精确刻画流体的运动特征;几何模型是关键,该模型能够高效光滑地定位、量化和跟踪流体细节敏感区域;耦合模型是接口,它使用几何模型控制物理模型,提高流体表面计算的精度和刻画水花细节.本文方法的输入是流体动画的初始条件和边界条件.其中,初始条件包括初始化的液体表面和流体速度场、粒子集等.边界条件是将流体运动所在的环境模型利用体素化方法转化为方程计算时可识别的边界[36].它包含两个部分:固体与液体边界和空气图1本文方法的框架4基于物理模型的参数获取物理模型中的参数获取有两个方面的作用:一是获取的参数用于几何特征的计算;二是获取参数用于真实感渲染,生成动画效果.为了完成上述两个方面的需求,本文需要获取以下参数:(1)符号距离场函数.几何特征的计算利用了流体细节之间的相关性.只有在水面产生大的几何变形或具有尖锐几何特征时,才会产生丰富的水花效果.因此需要获取水面参数,即符号距离场函数;(2)流体动态速度场.由于几何特征是随时间变化的,因此还需要计算动态变化的流体速度场;(3)三角形网格表面.流体动画的真实感渲染需要流体表面和水花粒子形成的三角形网格表面.令Ω表示计算域,计算域网格记为G.令符号距离场函数(狓,t)表示液体表面,其函数值为t时刻网格中心狓到液体表面的符号距离[1].显然,在液体表面上,满足(狓,t)=0,记为Ω;液体内部满足(狓,t)<0,记为Ω-;在液体外部满足(狓,t)>0,记为Ω+.4.1流体动态速度场的获取设当前时间步为n,计算域网格G中的流体速与液体边界.如图1所示,给定输入后,本文方法的主要步骤有3个,即基于物理模型的参数获取、几何模型的建立、几何模型与物理模型的耦合.首先在初始条件和边界条件的基础上计算物理模型,获取几何计算所需的参数,如窄带上的符号距离场函数、速度场.其次,根据上述参数计算几何特征.本文定义并计算细节敏感区域的动态定位量化函数,实现对大曲率、细长、边界等细节敏感区域的光滑定位、量化和跟踪.第三,根据动态定位量化函数,更新物理模型中的粒子集,实现几何模型与物理模型的耦合.最后,从数值计算结果中提取流体表面和流体水花的几何表示,结合真实感渲染技术即可获得每帧的流体动画[1].我们将在下面的几个小节中介绍本文方法的细节.度场为狌n,SPH粒子集Ps中的粒子速度为狌n计算n+1时刻动态流体速度场狌n+1,需要求解流体运动的NS方程其中,dρ/dt=ρ/t+狌·ρ,ρ为密度,狌为流体速度,p为压强,t为时间,犳为外力,·为散度,为梯度.求解步骤如下:(1)计算流体中间速度场狌对于Ω-∪Ω区域上的每个网格单元,已知当前时刻流体速度场狌n,可通过执行对流和添加外力两个步骤得到中间速度场狌.其中,对流步骤可以使用半拉格朗日法[37]求解狌/t=-(狌·)狌.添加外力步骤可表示为狌=狌(狓)+Δt犳(狓,t),Δt为时间步长.对于Ω+区域,需计算Ps粒子集所在的每个网格单元中的狌.为此,我们首先添加外力得狌狌p+Δt犳,然后再将其投影到网格G中,得网格点狓处的中间速度狌(狓)=∑狌粒子的贡献大小ωp(狓)=Page5c为控制常数,狓p为Ps粒子的位置,rp为粒子半径.(2)根据狌,计算流体速度场狌n+1获得狌后,方程(2)右侧只剩下-1/ρp,利用有限差分展开两侧同时取散度,得压强泊松方程在式(4)中,·狌n+1在计算域的不同位置取值不同.Ω-∪Ω区域属于液体内部,具有严格的不可压缩性,故·狌n+1=0.而在Ω+区域,液态粒子与空气混合,具有一定可压缩性,·狌n+1≠0,其值可以根据网格单元中Ps粒子个数与目标粒子数估计[4].这样,方程(4)右侧为已知,方程(4)即可转化为关于压强p的线性方程组,然后再利用预条件共轭梯度法高效求解.最后将p代入式(3),可得流体区域中新的速度场.最后用速度外推方法[1]将流体区域中的速度外推到空气网格中获取背景网格G中的速度场狌n+1.该速度场用于动态跟踪几何特征的变化.4.2水面参数的获取几何特征的计算还需要获取符号距离场函数(狓,t).给定当前时间步n,对应的符号距离场函数为n,我们需要计算更新后的符号距离场函数n+1,为此,利用半拉格朗日法[37]求解LS方程得未校正的符号距离场函数n+1更新后的流体速度场.为了避免使用半拉格朗日法进行对流所产生的过大误差,还需要使用检测校正粒子集Pn终获得更新后的符号距离场函数n+1.流体动画的真实感渲染还需要获取流体表面和水花粒子形成的三角形网格表面.为此,我们使用移动立方体算法提取=0的液体表面所对应的三角形网格[1].对于流体水花而言,在更新Ps中所有粒子的位置狓n+1表示水花的高精度三角形网格.对上述水面、水花的三角形网格进行真实感渲染后即可获得每帧的流体动画.5几何模型流体动画中的几何信息是流体运动行为的外在表现,也是在有限资源下增强真实感的有效途径.本文利用已获取的参数进行几何特征的计算,其目的是充分利用细节之间的相关性以及表面不同区域之间的差异性进行合理的资源分布.几何特征的计算主要包括两个部分:一是对细节敏感区域的定位和量化;二是对该区域的动态跟踪.5.1细节敏感区域的定位和量化细节敏感区域位于流体表面易于产生流体细节的位置,这些位置也往往是细节丢失最为严重的区域,如大曲率、细长区域和界面边界等区域[2,15,22].我们将所获取的水面参数作为输入,通过计算定位和量化函数,实现对大曲率、细长、边界等细节敏感区域的光滑定位和量化.该函数可确定整个计算域中细节所在的区域以及细节的多少.5.1.1定位和量化函数的定义本文定义了定位量化函数(LocationandQuanti-zationFunction,LF),其定义域为液体表面及其周围的窄带Ωb=Ω+外侧三层网格区域,Ω-区域.给定计算域上的一个封闭流形(由封闭流体界面或者非封闭的流体界面与计算域边界形成),定义局部中轴(LocalMedialAxis,LMA)为该封闭流形位于窄带Ωb上的内接圆圆心的轨迹.LMA为一个点集,由于该点集是封闭流形在Ωb区域上的内接圆圆心,因此,LMA上的每个点狆M到流体表面的最近点至少有两个.显然,LMA是位于窄带Ωb上的中轴(MedialAxis,MA)[38],是MA的子集.令狓为计算域上的任意一点,则函数LF定义为LF(狓)=其中,k为控制参数,控制界面内LF的值随距离变化的剧烈程度,本文实验中取k=2.狔为界面Ω上距离狓的最近点,L(狓,LMA)表示界面上的点狓到LMA的距离,可表示为由于本文LMA是MA的子集,因此,式(6)中基于LMA的LF函数很难完整的表达整个几何形状的厚度.例如在图2中,边界上的点狓1和狓2到LMA的距离存在L(狓1,LMA)<L(狓2,LMA)的关系.两点所在的形状的厚度分别为它们到MA的距Page6离,即d1和d2.从图中可以看出d1>d2,这与上述L函数的计算结果L(狓1,LMA)<L(狓2,LMA)恰好相反.事实上,在实际应用中,尽管点狓1和狓2处的厚度有区别,但这种区别已经不会影响我们对细节最敏感部位如狓所在区域的定位.因此,为防止出现上述问题,对于式(7)中的L函数,我们约定,如果L(狓,LMA)λ,则令L(狓,LMA)=λ,即L(狓,LMA)=min(inf其中,inf为下界值.在本文实验中,取λ=10Δh,Δh为空间步长,一般定义为网格单元的大小.在式(6)中,在窄带外部,LF的值定义为一个大常数.对于流体边界上的点,其LF值为该点到LMA距离的下界值;对于其他窄带域上的点,其LF值为该点到边界的距离加上边界到LMA距离的下界值.因此,式(6)表明,流体表面边界上的点具有最小的LF值;在高曲率区域和细长区域,LMA与界面的距离较近,因此都具有较小的LF值,而其图3散度判断法计算LMA他区域LF函数值大.所以,LF函数能够定位和量化高曲率、细长区域以及界面边界等细节敏感区域.利用文献[38]的方法,可以证明本文定义的LF在窄带域上是k-Lipschitz连续的,满足光滑性特征.5.1.2定位和量化函数的计算LF的计算步骤是:首先根据上节所获取的表面参数,即符号距离场函数=n+1计算LMA;然后再计算流体表面Ω上网格点的LF;最后计算窄带域上其他网格点的LF值.下面详细介绍.(1)计算LMA本文使用散度值判断法计算窄带上的中轴LMA.由于LMA上的点是流体内部的中心点,符号距离场函数在该点处具有最小值.因此,在LMA两侧,的梯度正好相反.而在同一侧,的梯度方向基本相同,如图3(a)所示.根据以上分析,我们可以通过计算窄带域上每个网格单元中的梯度的散度值即2判断该网格单元是否包含LMA上的点.对于包含LMA的网格单元,其边界位于LMA的两侧,故边界上的梯度方向相反,其散度值大于零.而在其他网格单元上,由于的连续性,其梯度的散度值接近于零.例如,在图3(b)中,网格单元C0包含LMA上的点,该网格单元的上侧面和下侧面的梯度方向都是指向外侧较大函数值的方向,故其散度值为非零.而在网格单元C1上,由于的连续性,其梯度的散度值接近于零.Page7符号距离场函数的梯度的散度表示为D=·()=如果绝对值fabs(D)>一定阈值(本文实验中,取含LMA点.然后用该网格点狓近似LMA上的点狆M,并入到已有的LMA点集中,即LMA=LMA∪狓.图3(c)、(d)分别给出一个2D形状的符号距离场函数的梯度的散度值和LMA点集示例.图中显示,形状内部中心区域的网格散度值大,而窄带上其他区域的散度值接近0,因此散度判断法逼近LMA上的点集是一种行之有效的方法.由于使用网格中心点代替LMA点集中的点,因此,本文散度判断法求LMA的误差为O(Δh).流体动画中需要设置很小的Δh以保持计算稳定性和计算精度,故散度判断法的误差非常小.(2)计算流体表面Ω上网格点的LF值在获取LMA之后,我们计算流体表面Ω上网格点的LF值.根据式(6)~(8),需要从LMA中搜索出离网格点狓∈Ω最近的点狆M.为提高搜索效率,本文构建kd(k-dimensional)树存储LMA点集.LMA的kd树构建使用LMA点集中具有最大跨度值的维度作为切分维度、用该维度上的均值作为切分值.由于kd树是一种基于统计优化的数据结构,kd树搜索的平均计算复杂度为O(NllogNl),这里Nl为LMA集合大小.因此本文方法可以快速从LMA点集中获取距离狓最近的点狆M.最后,根据式(8)计算表面Ω上网格点狓的LF值.(3)计算Ωb-Ω上网格点的LF值对于窄带域上的非表面网格点狓,其LF值为该点到界面的距离与界面上相应点LF值叠加后的下界.本文利用法向外推方法,将已知的LF值在界面上(向内或向外)外推.故窄带中的任意网格点,都可以根据外推来的LF值,计算自己的LF函数值.为此,本文将Ω上的LF值分两个阶段、分别外推到Ω+我们以Ω-算法1.Ω-输入:Ω上的LF值,Ω-输出:Ω-1.初始化网格点集合.建立3个集合Far,Close和Accepted;将Ω所在的网格点置入Accepted中,并将这些网格点的位于Ω-剩余的网格点置入Far中;2.初始化LF值:Accepted中所有网格点的LF值为算法的输入,即Ω上的LF值;Close集合和Far集合中所有网格点的LF值初始化为一个大常数,即LF=;3.建立以LF值为指标的最小堆,用于保存Close集合;4.更新Close集合中所有网格点狓的LF值:令Z={狕}为狓在Accepted集合中的邻居网格点集合,则狓的LF值更新为5.根据上述重新计算的LF值更新保存Close集的最小堆;6.选择最小堆顶元素Trial(即Close集合中具有最小LF值的网格点),将其置入Accepted集合;将Trail中的所有位于Far集合中的邻居点转移到Close集合中;7.转到步4,迭代运行直到最小堆为空,终止.算法结束时,Accepted集合中所有Ω-格点的LF值即为所求.将算法1中的Ω-b,可以获得Ω+Ω+以上方法获取Ωb-Ω上所有网格点的LF值时,其时间复杂度为O(NblogNb),这里,Nb为Ωb-Ω上的所有网格点的个数.与已有的计算几何特征的函数[38]相比,本文定义的LF函数不仅能够正确反映水面几何形状的复杂程度,而且有效提升了计算效率.效率的提高主要得益于以下两个方面:首先,由于窄带域上的LMA是MA的子集,缩小了在流体表面上求解LF函数时的搜索空间.其次,LF值的计算只需要在窄带域上进行,计算空间由原来的整个计算域变为在流体表面周围,大大降低了计算网格的个数.其计算复杂度由O(N)降低到O(N2/3),其中N为计算域内网格单元总数.在第7节实验部分,我们给出了具体的示例分析.5.2细节敏感区域的动态跟踪定位量化函数LF是对流体表面几何特征的表达,由于流体是不断运动的,因此该函数也具有动态性.为此,本文提出LF函数的动态跟踪算法,实现对细节敏感区域的有效的动态跟踪.LF函数的动态跟踪的基本步骤是:首先需要计算一段时间内的流体表面变形程度,如果变形程度小于一定阈值,则需要对LF函数进行对流更新;否则需要对LF函数进行重新初始化.流体表面变形函数S定义为一段时间流体表面所包围的流体体积的变化率Page8S(ti,ti-1)=∑其中,ti-1和ti分别上次重采样时刻和当前时刻,Δt为时间步长,A(t)为t时刻被流体界面包围的流体体积,表示为其中,δ为Smeared-outHeaviside函数的导数δ()=这里,ε=1.5Δh.在计算中,式(9)可转化为A(t)=∑(i,j,k)∈Ωb其中(i,j,k)为Ωb上的网格点.这样,根据第4节获取的参数,我们就可以计算出表面变形程度S.然后,根据表面变形程度S的值确定更新LF函数的方式.如果S的值小于阈值,说明表面变形不大,无需对几何特征进行重新计算.只需像流体表面一样,对其进行对流更新即可.如果变形程度大于阈值,说明表面发生了大的形变,需要对LF函数进行重新初始化.因此,需要重新初始化的时间步为本文实验中取=10%,在时间步ti(ti∈TF)上按照5.1节的方法重新计算LF的值.而在其他时间步上,LF的更新表示为其中,F=LF(狓,t),狌=狌n+1为当前时刻已获取的网格G中的流体速度场.这样根据当前时刻的LF值即LFn和更新后的G中速度场狌n+1,利用半拉格朗日法[37]求解式(10),即可获得更新后的LF值LFn+1.上述LF函数对细节敏感区域的定位、量化和动态跟踪,充分利用了流体的多种细节之间存在密切相关性这一特点.我们通过提取流体表面的几何特征,为其他细节的产生提供支持.此外,本文的几何特征在流体表面及其周围的窄带区域具有非均匀特征,高效且正确地反映了流体运动的特点,为提高计算精度和效率奠定了基础.6几何模型与物理模型的耦合由于流体水面和水花细节的产生密切相关,本文将几何模型计算的动态LF函数应用于物理模型粒子集的控制中,以提高水面模拟的精度,同时生成丰富的水花细节.几何模型与物理模型耦合的基本思路是,将几何特征计算获得的定位量化函数映射成物理模型中的粒子密度.然后,通过粒子密度调整物理模型中的粒子集Pc和Ps,从而在细节敏感区域分布更多的粒子.调整后的粒子集将完成两个目标:一是提高细节敏感区域的表面的精度,生成具有丰富细节的流体水面;二是为粒子水花提供更合理的源,更高效地产生水花飞溅的效果.算法2.几何与物理模型的耦合算法.输入:狌n+1,狌,n+1输出:Pn+11.将LF函数值LFn映射为粒子的分布密度Pn(狓);2.根据Pn(狓)计算需要增/删的粒子数Nn3.在网格单元狓中增加或删除Nn4.对Pnew5.利用狌n+1更新Pnew6.利用狌n+17.利用Pn+18.对Pnew9.利用狌n+1和狌更新Pnew10.利用狌n+1算法2给出了本文几何与物理模型耦合的基本步骤.下面我们详细介绍这些步骤中的操作.(1)首先将LF函数映射为粒子分布密度Pn(狓).由于LF在大曲率、细长区域以及边界区域的函数值较小,而这些区域所需的粒子反而较多,因此,先对LF进行变换Pn(狓)=1.0-这样,LF值较小的网格(即大曲率、细长区域和界面边界等)Pn(狓)值较大,从而满足在这些区域分布更多粒子的需求.然后将Pn(狓)归一化,获取粒子的分布密度(2)在每个网格中需要删除或增加的粒子个数为NnPage9其中,Nn为计算域中粒子总个数,κ为控制参数,控制粒子个数变化的剧烈程度.(3)在每个网格单元狓中,如果Nn在网格内随机删除Nndel(狓)个粒子,粒子位置在网格单元狓内部随机产Nn生,速度初始化为零.新粒子生成后还需判断分类并分别置入Pn子pnew,令其位置为狓pnew粒子位于Ω-则,则该粒子位于Ω+的ω层(ω=3)网格内,即0<n+1则该粒子属于PnΔh,则粒子属于Pn(4)对Pnew次线性插值的方法从G中速度场狌n+1获取.即c=Lerp(狌n+1,狓n狌n+1以狌n+1c作为输入,通过求解方程d狓/dt=狌n+1c中移除,添加到Pnew获得更新后的粒子位置狓n+1逃逸到液体表面三层网格之外的空气网格中,则将其从Pnew度和位置更新后,即可得新的粒子集Pn+1集可用于对符号距离场函数的检测和校正.在4.2节中,通过使用半拉格朗日法[37]求解LS方程(式(5))可以获得对流后的符号距离场函数n+1免粗糙网格引起的计算误差,研究者使用粒子检测和校正n+1c的分布是根据几何特征计算所得的,因此它对Pn+1n+1m中的误差可以进行更精确的检测和更准确的校正,提高流体表面的精度.具体的,令sp为粒子符号,如果存在则说明粒子逃逸,即检测到流体表面计算存在误差.此时,需要利用逃逸粒子定义局部LS函数p(狓)=sp(rp-狓-狓n+1点位置.校正时,需要首先计算逃逸正负粒子集E+和E-在所有网格点上的局部LS的最大值和最小值:+=max逃逸粒子集所在网格点狓中将两个距离场进行融合.如果+(狓)-(狓),则c(狓)=+(狓),否则c(狓)=-(狓).将所得c(狓)值替换狓位置处的距离场函数值n+1表面n+1.(5)SPH粒子集Pnew是产生水花细节,因此需要求解方程(1)、(2)对粒子速度进行更新.在4.1节中,我们已经获取到网格G中速度场狌n+1.由于狌n+1的计算结果是将粒子速度投影到网格中并求解网格和粒子耦合的压强方程获取的.因此,只需将狌n+1反投影到粒子上即可获得新的粒子速度.具体的,我们首先把中间速度场狌到狌n+1的增量反投影到粒子上,即Δ狌p=∑(狌n+1-狌)ωp(狓),则更新后的粒子速度为狌n+1示粒子速度受压强的影响程度.根据狌n+1d狓/dt=狌n+1子运动到流体表面以内,即n+1(狓n+1Pnews中移除该粒子.Pnew即得新的粒子集Pn+1从耦合模型中计算出新的符号距离场函数n+1和SPH粒子集Pn+1提取流体水面和水花的多边形网格,最后进行真实感渲染生成流体动画.7实验与分析本文实验采用的机器配置为酷睿2双核处理器,主频为3.30GHz,2GB内存.实验结果由3个部分组成:第1部分测试几何模型的有效性;第2部分测试几何与物理耦合模型在数值计算精度和效率方面的性能;第3部分为流体动画的实例.7.1犔犉函数本文分别选择2D和3D模型测试LF函数的有效性.图4给出了2DZalesak’sDisk测试函数[39]对应的结果.图4(a)表示整个计算域上的中轴,图4图4测试函数的中轴,局部特征尺寸函数,LMA和LFPage10(b)给出对应的局部特征尺寸函数值(LocalFeatureSize,LFS)[38],其中深色代表数值较小,浅色代表数值较大.图4(c)中的符号距离场函数只在窄带上定义,内部线条即是由本文算法得到的LMA,显然,LMA是MA的子集.中间缺失的部分表明其中轴点已位于窄带之外.尽管如此,在图4(d)中,基于LMA计算的LF仍然能够很好的定位Zalesak’sDisk中的大曲率、细长和边界区域.在图5中,本文计算了3组3D模型对应的LF值.如图5(a)、(b)中,3D球由于流场拉伸的作用产生了细薄区域,在这些细薄区域LF值较小,而在其他区域LF值较大,说明本文定义的LF函数能够很好地体现模型的几何性质.图5(c)、(d)给出了一个3D人物模型对应的LMA和LF值.LMA上的图62DDeformationfield测试函数的测试结果点基本上分布在具有较多细节的区域,如人物模型的耳朵、鼻子、眼睛、嘴巴和脚等位置,由此计算的LF值能够对这些区域进行精确的定位和量化.第5.1节分析指出,LF的定义还极大地提高了计算效率.表1给出了本文算法与LFS的计算效率对比.从表中可以看出,LF求解比LFS求解效率高得多,例如在3D人模型示例中,求解效率提高了近100倍.2DZalesak’sDisk图3(a)3Dmodel3Dhuman7.2几何模型与物理模型耦合的数值分析本文以2D变形场测试基准函数[38]为例进行分析,测试几何与物理耦合模型在界面跟踪的精度和效率方面性能.其中,2D变形场测试的是将一个圆置入由16个漩涡组成的变形场中,该测试函数可以测试数值格式的大变形适应能力.测试所用网格规模为200×200.图6展示了本文方法在流体表面计算精度和效率方面的提高.该图描述了粒子总数N=80k(1k=1000),800帧内的耗散率和效率.其中耗散率表示流体体积缺少的程度,耗散率越大、体积缺失越多,计算越不精确.图6中效率的波动是由于PLS算法[1,39]中的粒子重采样产生的.从图6(b)中可以看出,本文算法在粒子数80k的耗散率与PLS算法粒子数320k的耗散率相当,但效率提高了43.9%.相同粒子规模N=80k时,本文精度提高了16.6%.表2列出了不同粒子数下的平均耗散率和平均效率,结果表明本文方法无论在计算精度还是在计算效率方面,都有很大提高.Page11表22DDeformationField平均耗散率与平均效率N=80k,PLSN=160k,PLSN=320k,PLSN=80k,Ours7.3流体动画应用本实验所有流体动画示例中,初始条件设置为在每侧ω=3层网格的每个单元分布32个粒子,初始化SPH粒子集为空,如果在Ω+子,则将其加入到SPH粒子集中.图7给出了相同初始条件下本文方法与文献[1]的对比.在该示例中,计算域的长为0.6m,宽为0.65m,高为1.0m.在果盘上初始化水球半径为0.15m,速度为(0.0,-1.0,0.0)m/s.计算域分辨率为120×130×200.图7(a)是由文献[1]的方法产生的效果,图7(b)是本文方法产生的效果.相对于文献[1]的方法,本文的方法不仅能够生成拓扑多变的流体表面,而且能够生成水花飞溅效果,因此所表现出来的流体细节更丰富.该示例也表明,本文的方法能够有效生成流体细节,提高流体动画的真实感.图8给出了相同粒子数下本文方法与文献[4]的对比.在该示例中,计算域为长和宽均为1m,高为0.4m的水潭,潭内共有25个柱子,其半径为0.05m,高0.1m.注水水柱位置为(0.1,0.175,0.5),水柱高度为0.15m,半径为0.035m,水源流速为(-2.4,-2.0,0)m/s,计算域网格分辨率为200×80×200.图8(a)是由文献[4]的方法产生的效果,图8(b)是本文方法产生的效果.从图中可以看出,本文的方法水花飞溅细节更多,在撞击圆柱时更明显.图8(b)右上方墙壁处产生的表面弯曲则更直观地反映了粒子的优化分布对于提高表面精度的作用.该示例表明本文方法不仅能够生成丰富的水花飞溅等细节效果,还可以产生高精度的流体表面效果.图8本文方法与文献[4]中的方法效果对比除了在流体精度方面的提高,本文通过几何特征的优化方法还进一步提高了动画生成的效率.以上述示例为例,本文方法的计算效率提高了25%以上.表3给出图8示例1000帧的平均性能与传统物理模型[4]的对比.在相同计算精度情况下,本文算法的效率高于物理模型的效率.从表3中可以看出,粒子计算(包括流体水面的校正和水花模拟)在整个流体计算中都占有相当大的比例.而几何特征的方法通过在细节敏感区域更加合理地分布粒子,有效利用计算资源.整个计算中,粒子计算所占比例降低15.59%,而流体计算效率提高了25.46%.文献[4]结果本文结果提高在基于隐式曲面的流体动画方法中,流体表面的多边形网格是从底层网格的隐式曲面函数获取的.因此在粗糙网格的情况下,流体动画中的很多细节往往难以在单个网格中表达从而导致表面体积缺失,影响真实感,如图9(a)所示.本文基于表面几何特征的方法分布粒子,能够在表面细节敏感的区域提高流体细节的表达能力.如图9(b)所示,在表面破碎和表面逐渐消失时转化为具有亚网格精度的粒子表示,有助于表面细节的保留.本文的耦合几何特征的方法,能够在细长区域、大曲率位置以及边界区Page12图10流体动画序列8结论与下一步研究本文提出了一种耦合几何特征的高精度流体动画建模方法.该方法挖掘并利用流体动画中细节效果之间的相关性,利用几何模型在流体表面上定位易于丢失细节的局部区域,并对细节缺失程度进行量化和动态跟踪.通过动态的定位量化函数控制物域等细节敏感区域分布更多的计算资源,有效弥补此类区域的表面体积的缺失问题.因此,本文耦合几何特征的方法能够有效解决隐式曲面方法中表面体积缺失导致的失真现象.为了验证算法适用性,图10展示了3组本文方法生成的高精度流体动画序列.其中图10(a)和(b)分别为水潭注水及果盘落水的示例,算法的输入与初始条件如前所述.图10(c)给出了一个水马落水示例,在该例子中,计算域分辨率为53×150×212,水马下落的初始速度为(0.0,-1.0,0.0)m/s,重力加速度为9.8m/s2.从图中看出,本文方法能够很好的展示流体动画中的流体表面细节和小尺度水花飞溅的效果.由于粒子的分布与流体表面的几何特征密切相关,而流体运动的很多细节都是在流体表面变化程度较大位置产生的.该实验也说明,本文方法非常适合在水面变化较为剧烈的应用中生成高精度水面和水花效果.理模型,从而在这些敏感区域提高水面模拟的精度并生成丰富的水花细节.本文的方法可以方便的嵌入到传统的基于物理的流体动画模型中,获得比传统方法更好的精度和更高的效率.在实验中我们也发现,本文方法更适合于流体表面变形程度较大的应用,对于变形程度较小的场景其效果并不明显.另外,耦合几何特征的高精度流体动画的在大规模流体模拟中的刻画能力仍然是有Page13限的.目前我们方法的改进方向主要有3个:(1)设计算法检测水面运动的剧烈程度,当水面较为平静时无需再进行几何特征的计算及与物理模型的耦合.一个可行的方案就是获取水面平均曲率的统计数据,如均值和方差等,以此判断水面是否足够平静;(2)将本文方法扩展到大尺度空间的流体动画(如海浪)的应用中;(3)进一步拓展本文方法的应用范围,例如将该方法应用到流体动画的控制中[40-42],为在流体角色动画保持角色形状的同时生成丰富的流体细节提供帮助.我们下一步工作的重点将是解决上述问题,我们现在也在考虑如何结合类似文献[22]的方法生成多尺度细节来降低流体动画技术对计算资源的依赖.
