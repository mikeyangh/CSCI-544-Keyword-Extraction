Page1基于共享与分布随机数的并行粒子发射算法陈军(北京应用物理与计算数学研究所高性能计算中心北京100094)摘要对高功率微波三维电磁PIC数值模拟中采用束流发射方式的粒子随机生成规律进行了研究.提出了一种基于共享与分布随机数的并行粒子发射算法,以满足多个处理机对单个随机数产生器产生的随机数序列的共享和分布需求,即共享部分随机数,而分别使用其他随机数.这些共享和分布需求在程序运行前是非确定性的.将该并行算法用于一典型高功率微波源器件中模拟,数值实验表明并行程序可以较好地吻合串行程序得到的粒子相空间物理图像.关键词并行算法;随机数生成;粒子发射1引言PIC(Particle-In-Cell)模拟[1]是等离子体数值模拟中一种常见的计算方法.在高功率微波源器件模拟中,通过模拟等离子体与电磁场的相互作用,从Page2些领域,例如电子加速器并行模拟[3],其初始电子束发射等均强烈依赖于并行随机数的实现.在高功率微波源器件模拟采用的束流发射方式中,它限制发射面电流大小,并根据本网格与周围网格的电场信息,决定在本网格是否发射粒子.如果发射粒子,那么随机确定粒子的初始空间位置和动量.在这里,需要多次使用随机数,且次数依赖于运行时信息.本文分析了束流发射方式下的粒子随机生成规律.为实现并行模拟,对同一个随机数序列,多个处理机需要共享其中的多个随机数,并分开使用其他随机数.这种共享和分布需求在程序运行前是非确定性的,即在程序运行前无法确定要共享哪些随机数.因此,在并行粒子发射算法的研究中,要求研究满足上述共享和分布特性的并行随机数生成方法.在并行随机数生成方面,大量的研究集中在并行蒙特卡罗应用方面[4-6].在这类应用中,随机数产生器的质量非常重要.它必须满足如下特性:每个处理机上产生的随机数之间要求是统计无关的.传统上,并行化蒙特卡罗应用有两种方法:(1)参数化.通过一个带可变参数的递归函数来定义一组随机数产生器.每个参数值导致一次递归,从而产生一个独一无二的随机数序列,这个序列可在特定的处理机上使用.对于NP个处理机,每个处理机可使用不同的参数值,从而可以并行生成不同的随机数序列.(2)分组.由单个随机数产生器产生的随机数序列被分成多个子序列,每个子序列被用于不同处理机上.文献[7]探讨了并行随机数生成的一般方法,文献[8]给出了一种在机群上生成并行随机数的方法.目前有一些高质量的并行随机数生成软件,例如SPRNG[9]并行随机数生成库,已得到广泛应用.上述方法的目标是使各个处理机使用不同的随机数子序列,且各个随机数之间是统计无关的.然而对于本文的高功率微波源器件模拟应用存在的共享和分布需求,这些方法无法满足.为此,本文首先分析了束流发射方式下的粒子随机生成规律,并提出了一种基于共享与分布随机数的并行粒子发射算法,以满足多个处理机对同一随机数产生器产生的多个随机数的共享和分布需求.这些共享和分布需求在程序运行前是非确定性的.上述并行粒子发射算法被应用到高功率微波源器件模拟并行程序NEPTUNE3D[10-11]中,模拟了多种源器件,计算结果与国际同类软件进行了比对[12-13],获得了较好的效果.本文的贡献在于:根据应用对随机数的共享与分布需求,将非确定性的并行随机数生成问题分解为两部分,即共享区随机数生成和分布区随机数生成问题,并分别生成相应的随机数.本文第2节分析束流发射方式下的粒子随机生成规律,并阐述本文要求解的问题;第3节给出我们的并行粒子发射算法;第4节给出在具有上百台处理机的并行机上的实验结果;最后总结全文.2问题描述通常,可发射粒子的区域是整个计算模拟区域的一部分.假设发射区域已被离散为N个网格,且已排序,索引为1到N,束流发射方式下的粒子发射算法如下.算法1.束流发射方式下的粒子发射算法.输入:发射区网格、电场E、已发射电子电荷量输出:更新的已发射电子电荷量,新发射的0或多个粒子FORiterationlDO两次随机抽样获得网格序号G1和G2;由G1和G2确定实际发射区序号起点M1与终点M2;DOi=M1,M2//对第i个发射网格qiIF(qiENDDOENDFOR同余序列产生器:在上述算法中,对于每次迭代,有两处要用到随机数生成:(1)随机抽样获得网格序号G1和G2.(2)在第i个发射网格上,随机发射粒子.这里,随机数产生器random采用常用的线性其中,0<a<M和0c<M,M=230p,p为一小的整数,Un为[0,1]空间上所需的随机数.以Un=random(Vn-1)来表示.图1中显示了在串行随机数生成序列中第l和第(l+1)次迭代对应的随机数片段.相邻两个黑点表示随机抽样获得发射网格序号G1和G2所需的随机数,白点则是在不同发射网格上随机发射粒子对应的Page3随机数.例如,在第l次迭代的随机数子序列上,首先是两个黑点,根据这两个随机数分别获得发射网格序号G1和G2;然后为发射阶段:首先是对应第M1个发射网格的所需的IM1个随机数,接着是对应第M1+1个,…,第M2个发射网格所需的IM2个随机数.图1粒子发射中用到的串行随机数序列示例对于一个被选中发射粒子的网格单元,它发射粒子的个数是根据当前时刻电场的情况来确定,可能是零或多个,所以在程序运行前,每个发射网格在随机数序列中对应的长度IM1,IM1+1,…,IM2是不确定的,因此,黑点在随机数序列上的位置也是未知的.在并行算法设计中,需要对以下两种需求做不同的处理:(1)所有进程并行获取用于确定发射区间的网格序号G1和G2.在同一迭代时刻,所有进程应获得相同的序号G1和G2.即在同一迭代时刻,它们对应于随机数序列中的相同的两个位置,即黑点,以下称之为共享点.(2)第i个发射网格上随机发射事先未知个数的粒子.这里,同一个发射网格对应随机数序列中的多个不同随机数.当多个发射网格被分配到不同处理机上时,它们对应的随机数子序列是不同的.在以网格划分进行的并行计算中,计算区域通常被分解为多块,每个块由不同处理机处理,因此,每个处理机必须处理它所包含的发射网格的粒子发射问题.在同一迭代时刻,上述需求反映了在对待随机数生成上的两方面特性:(1)共享特性.即在第l次迭代中,多个处理机共享随机数序列中的相邻两个值(即黑点对应的值)来获得确定发射区间的网格序号G1和G2.(2)分布特性.即在第l次迭代中,多个发射网格分布在不同处理机上,每个处理机对应了随机数序列中多个长度变化的片段,每个片段的长度在程序运行前未知.图2显示了在第l次迭代中处理机Pk(k=1,…,NP)的随机数子序列.其中,各个子序列中黑点对应的随机数相同.Ii,Ij,Io和Iq分别对应不同的网格单元,每个长度在程序未执行前未知.同时,在多次迭代中,共享点之间的距离在程序未执行前也是未知的.图2在第l次迭代中各个处理机的随机数子序列3基于共享与分布随机数的并行粒子发射算法在我们的算法中,每个处理机共享与串行程序有相同的随机数生成器.针对不同处理机之间对随机数的共享和分布特性,将该随机数生成器产生的随机数序列分成两部分:(1)该序列的前2N个随机数组成共享区.第2l-1和2l个随机数对应第l次迭代(l=1,…,N).其中N为程序终止时所需的迭代次数.(2)从该序列的第2N+1个随机数起,组成分布区.3.1共享区随机数生成在初始化部分,每个处理机将上述的随机数产生器产生的前2N个随机数保存起来,记为Ai.这2N个随机数组成了共享区.3.2分布区随机数生成对于上述随机数产生器产生的随机数序列,从2N+1个开始的多个随机数组成了分布区.对第p个处理机,每次从分布区间隔NP个获得下一个随机数.记为xjNP,j=1,…,Jl代中第p个处理机从分布区获取的随机数个数.不同处理机的Jl的值.图3给出了第l次迭代中不同处理机的随机Page4数分组示意图.图3中xj3.3并行粒子发射算法假设在第l次迭代中,每个处理机均已拥有其所分配的子网格及影像单元的电场数据,根据上述对共享区和分布区随机数的产生方法,形成如下的并行粒子发射算法.算法2.并行粒子发射算法.输入:发射区网格、电场E、已发射电子电荷量输出:更新的已发射电子电荷量,新发射的0或多个粒子FORallpiniterationldo从共享区获得随机数A2l-1和A2l,分别用于计算网格序号G1和G2;根据G1和G2确定实际发射区间网格序号的起点M1和终点M2;DOi=M1,M2IF(网格i在处理机p中)ENDFOR3.4分析注意到上述并行算法中,Ai和xj数序列中出现的位置与串行算法已完全不同.但是,如果多个处理机所共享的随机数序列可以保证每个随机数之间是统计无关的,那么在上述并行算法中,仍然可以保证如下3个特性:(1)共享区多个随机数Ai之间是统计无关的.(2)分布区多个随机数xj(3)共享区和分布区之间的随机数是统计无关的.在上述并行粒子发射算法中,由于每个处理机独立地完成粒子随机发射,不需要通信,因此,如果粒子发射网格均匀分布在处理机上时,上述算法的加速比将正比于处理机的个数NP.4应用将上述并行算法应用于三维电磁PIC模拟程序NEPTUNE3D中,该程序的基本框架如图4所示.在每次迭代中,均需要多个处理机并行执行粒子发射模块.在迭代到一定次数满足相关条件后,随着高功率微波源器件内的电磁场变化,该器件内部的发射区域将发射出粒子.图5给出了一典型高功率微波源器件———带支撑杆的MILO(磁绝缘体振荡器)器件的几何图像.图5(a)为三维透视图,图5(b)为YZ截面图.在长方体网格上,以1184635个网格单元离散计算区域.图6给出了在128台处理机上,粒子个数随时间的变化曲线.在零时刻,粒子个数为0,表明器件中无粒子存在;随着时间的推移,器件内发射出粒子,在5ns左右粒子个数激增到上百万个;随后在10ns左右粒子个数趋于稳定.图6粒子数时变曲线(横轴为模拟时间,纵轴为粒子数)Page5粒子相空间分析是物理定量分析的重要组成部分.在高功率微波电磁PIC模拟程序中采用上述的并行粒子发射算法,图7中给出了在128台处理机上程序执行到15.5ns后得到的粒子相空间图像,其中横轴为粒子在z向的位置,纵轴为粒子动量.该图图7t=15.5ns时Pz-Z粒子相空间图像采用上述并行粒子发射算法的NEPTUNE3D程序已应用于多种高功率微波源器件的模拟设计中,例如,磁绝缘振荡器、相对论返波管(RBWO)等,并与国际公认的同类软件KARAT3D的计算结果进行了比对.由于微观的粒子发射最终会影响宏观的物理量,因此我们在NEPTUNE3D上采用400万个网格单元、150万个粒子模拟相对论返波管时,分别与KARAT3D软件比较了稳态后器件中关键的几个物理量,包括二极管电压、电流、输出能量和频率,结果与KARAT3D基本相当.更详细的结果可参见文献[12-13].表1NEPTUNE3D与KARAT3D模拟RBWO的计算结果比较(400万网格、150万粒子、采用算法2和选自文献[13])程序二极管NEPTUNE3D7505.03509.3KARAT3D7624.93609.35结论和下一步工作在高功率微波源器件三维电磁PIC数值模拟中,粒子发射是其中一个重要环节.本文首先研究了束流方式下的粒子并行随机生成规律.在该应用中,对随机数序列中的随机数存在两种需求:其中一些随机数需要在多台处理机上共享,而其他随机数则分布在不同处理机中.这种共享与分布需求存在非反映了在累积到一定时刻后整个器件中粒子速度与空间位置之间的关系,可以帮助物理人员分析粒子动能与电磁能量之间的转换.图7中也给出了串行程序的粒子相空间图像,可看出,并行程序可以较好地吻合串行程序得到的粒子相空间物理图像.确定性,即在程序运行前多台处理机共享随机数序列中的哪些随机数是未知的.为满足对并行随机数的共享和分布需求,本文提出了一种基于共享与分布随机数的粒子并行发射算法.对于同一随机数序列,将该序列分为共享区和分布区,多台处理机将拥有共享区的全部随机数,而将分布区的随机数按照进程号分组,并分布在不同处理机上.数值实验表明,在采用该并行算法的情况下,用我们的三维电磁PIC并行程序模拟一典型高功率微波源器件,得到的粒子相空间物理图像可以较好地与串行结果吻合.目前,本文的粒子并行随机生成算法中,仍然采用的是与串行程序一样的线性同余随机数生成器.随着粒子规模的增大,对随机数生成器的质量要求愈高.下一步的工作包括采用高质量的随机数生成工具,例如SPRNG,来进行比较和分析.致谢感谢北京应用物理与计算数学研究所的董烨,他提供了计算模型参数!
