Page1一种基于DOCSIS上行信道的自适应补偿定时同步算法王沁1)郭艳飞1)宋丽华1),2)杜立国1)1)(北京科技大学信息工程学院北京100083)2)(北方工业大学信息工程学院北京100144)摘要基于DOCSIS规范,在分析CM(CableModem)定时同步机制的基础上,文中首先提出了一种自适应补偿定时同步算法.通过准确预测定时误差发生时刻并及时给予误差补偿,该算法能够使CM在HFC网络上行TDMA信道上与CMTS建立精确的全局定时同步,为CM正确接入信道并实现业务传输提供了保证.其次,文中进一步将算法包含的乘除运算优化为加减运算,提高算法的通用性,降低其实现的复杂度.该算法目前已经应用在一款自主研发的CMSoC芯片中,实际环境测试结果表明该算法的定时精度为DOCSIS要求的10.24倍,并表现出优良的可靠性.关键词定时同步;HDTV;DOCSIS;CM;混合同轴光纤1引言HFC(HybridFiber-Coax,混合同轴光纤)宽带接入是广电行业发展起来的一种重要宽带接入技术,其充分利用HFC网络覆盖范围广、高宽带,能同时传输语音、数据、视频等信息的特点,使其成为“三网融合”的最佳解决平台之一.利用HFC可以方便地开展基于IP的各种业务,如VOIP、VOD、I-HDTV(交互式高清晰数字电视)、ITV(普通交互式有线电视)、高速Web浏览等业务,使CATV用户从HFC网络的多数据业务中获得真正的多媒体数字高速公路.目前负责制定HFC技术相关标准的组织主要有3家:DVB/DAVIC、IEEE802.14小组和MCNS(多媒体电缆网络系统),其中最有影响力的是MCNS制定的DOCSIS协议标准,该标准已经被正式纳入ITU-T(ITU-TJ.112B)标准.本文以HFC网络双向接入核心设备CM(CableModem)的SoC(SystemonChip)芯片开发为背景,重点研究了DOCSIS协议MAC层上行信道接入的关键技术———定时同步技术,并提出了一种自适应补偿定时同步算法(AdaptiveCompensationTim-ingSynchronizationAlgorithm,ACTSA),该算法能够高效、精准地实现上行时分复用(TimeDivisionMultipleAccess,TDMA)信道全局定时,为CM能够精确接入信道并实现数字业务奠定了基础.本文第2节简要介绍DOCSIS上行信道接入机制;第3节详细阐述自适应补偿定时同步算法及其优化;第4节详细介绍算法的实现、测试及性能分析;最后为全文总结.2DOCSIS上行信道接入机制分析2.1HFC网络系统拓扑结构双向HFC网络系统拓扑结构如图1所示,其主要由3部分组成:物理传输介质(光纤或同轴)、图2上行信道带宽分配模型若干CM和一个电缆调制解调终端系统(CableModemTerminationSystem,CMTS).CMTS是HFC网络的中央控制机构.HFC网络采用频分复用技术,将5~1000MHz的频段分割分为上行和下行信道,5~65MHz为上行信道,87~1000MHz为下行信道.HFC网络的下行信道是一对多的树型分支结构,CMTS是该方向上的唯一发送端,其以MPEG-2格式将各种数据和管理信息广播给下行信道上的CM.上行信道是多对一的总线结构,多个CM共享同一个上行信道,在CMTS的调度下以TDMA的方式接入信道.2.2DOCSIS上行信道带宽分配机制为了解决上行共享信道的资源占用和带宽分配问题,DOCSIS规范定义了MAC层协议来合理分配上行带宽资源,实现CM的随机接入,并解决竞争冲突.其采用TDMA技术将上行信道模型化为一连串的微时隙流,并采用上行带宽分配表MAP管理机制,将未来一段时间内的上行带宽微时隙分配情况描述在MAP管理报文中,通过下行信道广播给共享同一上行信道的CM.MAP定义了3类基本微时隙,如图2所示.维护时隙用于测距,其中初始维护时隙为CM竞争接入网络提供传输机会,站维护时隙为CM进行常规网络维护及获取定时偏移提供传输机会.数据预留时隙为指定CM提供专用上行数据传输机会.竞争时隙为CM争用上行信道提供传输机会.其中,在数据预留时隙和站维护时隙CM独占上行信道不会产生传输冲突.而在竞争时隙和初时维护时隙多个CM争用信道传输,因此Page3会引起冲突,由于HFC网络上、下行信道在频段上相互隔离,处于分支节点处的CM无法监听上行信道的信号,也就不能采用以太网的载波监听多路访问/冲突检测(CSMA/CD)机制,而是采用二进制指数退避竞争算法来解决传输冲突.2.3DOCSIS上行信道定时同步机制CM为了识别MAP中描述的带宽分配微时隙,并使其上行传输能够在指定的微时隙内到达CMTS,CM必须在本地与CMTS建立精确的定时同步,如此CM需要完成如下两步工作:(1)建立全局定时基准.CMTS周期性地在下行信道广播时间戳(TimeStamp,TS)同步报文SYNC(见图2),CM必须将本地实际时间与收到的时间戳相比较,并调整它们各自的定时基准.(2)获得定时偏移.CM必须在初时维护和站维护时隙进行测距,以获得定时偏移ΔT解决信道延迟补偿.如图2所示,为使测距请求(RNG-REQ)、数据请求(DATA-REQ)以及上行数据帧(DATA)能够在指定时隙内到达CMTS,CM必须在本地定时基准t5、t8和t11时刻提前ΔT开始其传输.关于测距机制详细介绍参见文献[1].3全局定时同步算法3.1全局定时误差分析全局定时基准建立过程中CMTS的TS表示的是这样一瞬间的定时计数状态:时间同步报文SYNC的第一字节从下行传输汇集层到物理媒介依赖子层时,CMTS内以10.24MHz时钟为基准的32位计数器的计数状态.理想情况下,CM同样建立10.24MHz的32位定时计数器,并根据收到的TS更新该定时器便可建立全局定时基准.设t为某次TS到达CM时刻,此时CMTS和CM全局定时器计数值分别Tcmts和Tcm,上下行的传输及物理层处理延迟分别为ΔTu和ΔTd,测距获的定时偏移ΔT,则有因此由式(1)和式(2)及图2可知,CM通过定时偏移ΔT便可将其传输与正确的微时隙界限相对齐.但问题是CM与CMTS中同样以10.24MHz驱动的两个全局定时器真的能同步计数吗?CMTS与CM工作在两个完全不同的物理环境中.设CMTS和CM的环境参数集分别为Pcmts(y1,y2,…,ym)和Pcm(x1,x2,…,xm),则有Pcmts(y1,y2,…,ym)≠Pcm(x1,x2,…,xm)(3)在信道传输中,由晶振精度、电压、温度等寄生参数引起的时钟漂移问题往往是研究的重点.因此,由式(3)需要怀疑式(1)的可靠性.由DOCSIS规范知相邻两次SYNC到达时间间隔Isy最大值为200ms.为分析时钟漂移引起的CM定时同步问题,本文首先对此间隔建立局部定时误差模型(PartialTimingErrorModel,PTEM),其定义如下:(1)设标准参考时钟频率和周期分别为fs=10.24MHz,Ts=1漂移为clkcmts_skew=0,ΔTd相对稳定,则CM可将SYNC中的TS作为精确的定时参考基准,CM定时误差皆归咎于CM时钟漂移clkcm_skew≠0引起.CMTS与CM全局定时器时钟频率分别为fcmts=fs和fcm=(fs±Δf)MHz,其中Δf为频率偏移量.(2)设Pcmts和Pcm相对稳定,即有fcm/fcmts=C,C为常量.(3)设相邻两次TS到达时刻分别为A1和A2,时间间隔为Isy=A2-A1.(4)设s(t)和r(t)分别为CMTS和CM定时器在时刻t的计数值函数,t∈[A1,A2).实际上s(t)和r(t)只在离散时间序列{ti}上取值有效,ti∈{A1,A1+Ts,…,A1+iTs,…},i=0,1,…,Isy便分析,本文在PTEM中暂将s(t)和r(t)视作连续函数进行分析.由上述模型定义可知,函数s(t)和r(t)可按如下线性关系描述:(1)当t=A1时,TS到达其值为ts0,据此CM(2)当A1<t<A2时有置r(A1)=ts0.其中,ε(t)为随机噪声引起的定时偏差,假设此随机噪声为高斯噪声,其数学期望E[ε(t)]=0,方差Var[ε(t)]=σ2(3)相应的,CMTS定时器计数值函数s(t)为s(t)=fcmts×[(t-A1)+ΔTd]+ts0,t∈[A1,A2)由文献[2]知测距通过调整CM的ΔT使其看起来正好位于CMTS附近,因此PTEM中由ΔTd引入的固定定时误差,可在测距过程中由ΔT补偿.同时为简化分析,忽略随机噪声对定时的影响.因Page4此,对式(4)和(5)可做如下约舍:则式(4)、(5)的简化形式为(a)舍去ΔTd.(b)令σ2r(t)=fcm×(t-A1)+ts0,s(t)=fcmts×(t-A1)+ts0,t∈[A1,A2)(6)Te(t)=s(t)-r(t)=(fcmts-fcm)×(t-A1)令Te(t)为t时刻CM的定时误差,则有由式(7)描述的CM定时误差如图3所示,根据Δf>0,Δf<0,Δf=0分为3种情况.为解决网络发送端和接收端的时钟同步问题,文献[4-5]详细介绍了基于TS的各种同步调整算法,如LRT(LinearRegressionAlgorithm)、DLST(DiscountedLeast-SquaresAlgorithm)、DST/AST(DirectSmoothingAlgorithm/AdaptiveSmoothingAlgorithm)等等,这些算法将同步问题转化为根据历史定时误差信息对将来估值问题,通过对TS进行k次采样,并将误差序列Te(t)输入环路滤波LF(LoopFilter)器计算频率误差Δf,以此控制压控振荡器(VoltageControlledOscillator,VCO)或数控振荡器(DigitallyControlledOscillator,DCO)调整本地频率.使用上述算法时钟频率误差的数学期望最终可收敛为0,算法精度高.但是,这些算法在解决PTEM描述的定时误差上具有如下缺点:(1)算法需连续采样k个Te以估计未知参数bi(i=1,2,…,n),运算时间代价较大.(2)算法实现涉及相位检测器、LF、VCO/DCO,硬件实现复杂,规模代价高.(3)一次频率同步调整周期为k个TS周期,调整周期长,收敛速度慢.(4)算法调整的对象是接收端时钟频率,而非其定时器输出值.由DOCSIS知CM定时器在任意时刻t都需与CMTS精确同步,以此保证其随机接入时同正确的微时隙界限相对齐,不可能允许连续k个Isy的非精确定时.同时,基于硬件实现复杂度和规模考虑,下面章节中本文提出了一种自适应补偿定时同步算法.3.2自适应补偿定时同步算法不同于文献[4-5],本文将研究的重点定位于Isy内并提出新算法ACTSA,该算法能预测定时误差将发生时刻并及时给予补偿,以此实现任意Isy内任意时刻CM同CMTS的精确定时同步.在上节PTEM基础上将定时误差模型扩展为连续Isy上的全局定时误差模型(GlobalTimingErrorModel,GTEM),模型扩展定义如下:(1)设TS到达时刻序列为{Tk:k=0,1,2,…},其中k表示第k+1个同步报文的到达.(2)设{T(m)时补偿时刻序列,不妨令T(0)(3)设{f(k-1)上的定时器时钟频率,{Δf(k)Tk)和(Tk,Tk+1)上f(k-1)cm-f(k-1)f(k)并无此频率误差约束.令f(-1)定时器时钟频率.对应的定时补偿值,Eval(t)为(Tk,t)上所有Δcomp(T(m)导过程如下:基于上述GTEM模型假设的ACTSA详细推(1)对于t∈{Tk,k=0,1,2,…}有Eval(t)=0.(2)在GTEM下CM定时器计数值r(t)表达(4)设Δcomp(T(m)式如下:r(t)=(3)对于t∈(T0,T1)由式(7)可得Te(t)=(fcmts-f(0)由式(6)、(8)可得Page5则由式(10)、(11)得将式(12)代入式(9)得上式表明当t∈(T0,T1)时Te(t)是斜率为s(T1)-r(T1)T1-T0(4)由GTEM假设(3)可知,(Tk,Tk+1)上的定时误差可根据(Tk-1,Tk)上的定时误差预测,因此由式(13)可估计(T1,T2)上的定时误差Te(t).在实际中CMTS和CM的定时器为递增单位为1的离散计数器,因此为使CM同CMTS定时精确同步,算法期望任意时刻t定时误差|Te(t)|1,这等于将问题转化为:令|Δcomp(T(m)确的定时补偿时刻{T(m)(T(0)1,T2)时有则待求误差补偿时刻T(1)s(T1)-r(T1)T1-T0×(T(1)对于Eval(t),当t∈(T(0)Eval(T(0)Eval(T(1)其中,Δcomp(T(1)符号函数.(5)当t∈(T(m-1)式(14)~(16)同理可得误差补偿时刻T(m)当t∈(T(m-1)当t=T(m)Eval(T(m)其中(6)推广为GTEM中一般情况,对于t∈k,Tk+1),由式(17)~(19)可得(T(m-1)误差补偿时刻T(m)当t∈(T(m-1)当t=T(m)Eval(T(m)其中定时器输出值,则有设tmcm(t)为t时刻经上述算法校正后的CMtmcm(t)=R(t)+Eval(t),t∈[0,+)(23)推导至此,算法分别给出了定时误差计算方程(20)、定时补偿时刻计算方程(21)、定时补偿值累积量计算方程(22)以及校正定时输出计算方程(23).由于算法可根据(Tk-1,Tk)阶段的定时误差自动调节式(20)的斜率以反映f(k-2)正确预测(Tk,Tk+1)阶段的定时误差,因此称该算法具有“自适应性”.由算法推导过程可知,在任意时刻t都有|s(t)-tmcm(t)|1,t∈[0,+),即算法保证了CM同CMTS在全局定时上的精确同步.3.3自适应补偿定时同步算法优化上节GTEM下给出的ACTSA适合连续定义域t∈[0,+)上的定时误差补偿,但实际中CM的定时器是在周期为1升沿)驱动下工作,这样由式(21)得到的定时补偿时刻不一定恰好与该脉冲的上升沿时刻(离散时间点)对齐.针对该问题本文将把GTEM转化为离散定时误差模型(GlobalDispersionTimingErrorModel,GDTEM),并推导GDTEM下的ACTSA算法.该GDTEM定义如下:(1)n表示系统启动到当前时刻定时器已经历的脉冲数.(2)设定时器在脉冲上升沿检测TS,则TS到达时所对应的n值序列为{Nk:k=0,1,2,…},该序列对应于GTEM中的{Tk},其中k表示第k+1个TS的到达.(3)设{N(m)补偿点的n值序列,令N(0)(4)设{F(k-1)时器时钟频率,ΔF(k)中(3)定义的约束.(5)设ΔCOMP(N(m)Page6值,EVAL(n)为(Nk,n)上所有ΔCOMP(N(m)CM定时器计数值,TNe(n)为定时器误差.推导过程如下:(6)设S(Nk)为Nk点对应的TS值,R(n)为基于上述GDTEM离散模型的ACTSA算法(1)对于n∈{Nk,k=0,1,2,…}有EVAL(n)=0.(2)GDTEM下CM定时器计数值R(n)表达式如下:R(n)=.(3)对于n∈(N0,N1],设CM定时器第n个周期上升沿时刻为tn,则由式(13)可得TNe(n)=Te(tn)=s(T1)-r(T1)(4)对于n∈(N(0)TNe(n)=S(N1)-R(N1)GDTEM下在求(N(m-1)直接套用式(21),因为CM发生定时误差等于1的时刻点不一定恰好与n对齐.本文在GDTEM下采用延迟补偿策略,即将补偿点延迟到定时误差等于1的时刻点后最近的一个n点,则(N(0)的计算方程如下:1=minnn:S(N1)-R(N1)N(1)对于EVAL(n),当n∈(N(0)EVAL(n-1)=EVAL(N(0)EVAL(N(1)其中,ΔCOMP(N(1)(5)对于n∈(N(1)1=minnn:S(N1)-R(N1)N(2)sgn(S(N1)-R(N1]))+=minnn:S(N1)-R(N1)sgn(S(N1)-R(N1))}1对于EVAL(n),当n∈(N(1)其中S(N1)-R(N1)R(N1))项为由于定时误差补偿点延迟到N(1)成的累积补偿误差.EVAL(n-1)=EVAL(N(1)EVAL(N(2)其中,ΔCOMP(N(2)(6)由数学归纳法可得,对于n∈(N(m-1)1=minnn:S(N1)-R(N1)N(m)对于EVAL(n),当n∈(N(m-1)EVAL(n-1)=EVAL(N(m-1)EVAL(N(m)其中ΔCOMP(N(m)(7)推广为GDTEM下最一般形式,对于n∈(N(m-1)k,Nk+1]有TNe(n)=S(Nk)-R(Nk)k=min{nn:S(Nk)-R(Nk)N(m)对于EVAL(n),当n∈(N(m-1)EVAL(n-1)=EVAL(N(m-1)EVAL(N(m)其中,ΔCOMP(N(m)校正后的CM定时输出值,则有设TMcm(n)为n时刻经上述GDTEM下ACTSATMcm(n)=R(n)+EVAL(n),n∈[0,+)(34)通过上述连续定时误差模型到离散定时误差模型的ACTSA推导变换,得到了离散模型下的定时误差计算方程(31)、定时补偿时刻计算方程(32)、定时补偿值累积量计算方程(33)以及校正定时输出计算方程(34).Page7但是,算法实现时式(31)、(32)表示的计算方程并不完美,因为它们涉及到硬件以及嵌入式系统实现所不期望的乘法和除法运算.为了消除ACTSA中的乘除运算使其能更广泛、更便捷地应用到实际系统实现中,本文将对上述计算结果进行优化.k=minn{n:|[(S(Nk)-R(Nk))×(n-Nk)]-N(m)sgn(S(Nk)-R(Nk))]|(Nk-Nk-1)}:对于n∈(N(m-1)k=min{nn:∑nN(m)(Nk-Nk-1)}通过优化式(32)计算所需的乘除运算在式(35)中消失了,算法得到了更为简便的计算方程.由式(35)可知,计算(Nk,Nk+1]上第m个定时补偿时刻只需知道(Nk-1,Nk]上Nk点的定时误差值S(Nk)-图4ACTSA计算流程图4.1算法级仿真验证本文首先在MATLAB中对算法建模仿真,仿真模型结构如图5所示,仿真参数见表1.算法仿真结果如图6所示.图6(a)、(b)分别描绘了Δf>0,Δf<0两种情况下CM的定时误差.R(Nk)以及第k和第k+1个TS到达对应的定时间隔Nk-Nk-1即可.设式(35)中决定补偿时刻点k的因子为Estep(N(m)N(m)则有Estep(N(m)∑m-1j=0至此,ACTSA给出了CM进行定时补偿所需的全部计算方程式,这些计算方程式不仅能够使CM精确同步于CMTS,而且能够方便地适用于硬件及嵌入式系统实现.4算法实现、测试及性能分析下面本文将给出ACTSA的具体实现步骤,并对其进行测试和性能分析.算法计算流程如图4所示.样本采样点为CM定时器工作脉冲上升沿.图中N1~N5为TS到达点,线L1和线L2分别表示未使用和使用ACTSA算法两种情况下的定时误差.图中L2上出现±1“定时误差尖峰”原因为Page8表1算法模型仿真参数频率偏差方向Δf>010.20Δf<010.28±0.0410.24[-5,+5]≈1fcm+F(k)(1)算法采用误差延迟补偿策略,因而会短暂出现定时误差已为1但没立即补偿现象.(2)CM的定时器频率在相邻TS到达间隔(Nk-1,Nk)和(Nk,Nk+1)上具有ΔF(k)率偏移,算法根据(Nk-1,Nk)上已发生的定时误差估计(Nk,Nk+1)上将发生的定时误差,因此由式(35)、(36)计算得到定时误差补偿点与实际发生定时误差等于1的时刻存在微小偏差.由图6所示的仿真结果可知,未使用ACTSA时,每个Isy内CM定时误差随时间呈线性趋势增参数cm/HzIsy/ms采样频率/MHz每个Isy内采样数长,在离散点采样的表现结果呈现为图中所示的阶梯状上升,而采用ACTSA时,即使在较大Δf偏差(本例Δf=±0.04MHz)情况下,CM的定时误差被限制在{-1,0,1}内.上述MATLAB算法仿真结果与算法设计期望结果一致,初步验证了本文算法的正确性.4.2SoC平台算法实现本文的项目背景为交互式有线数字电视CMSoC芯片的研制和开发,为该项目开发的具有自主知识产权的CMSoC芯片(SIP-CM)简化系统结构如图7(a)所示.其中CPU为我国自主研发的龙芯.Ethernet模块支持Ethernet/802.3用户端协议栈,是CM与CPE(用户专用设备)之间的通信接口.Tuner将下行高频信号转换为中频信号,其输出连Page9接到下行物理层解调模块DownDemodulator.DocsisPPU(ProtocolProcessUnit)为Docsis协议处理器,包括下行同步、数据接收和发送等等,UpModulator完成上行信号调制及发射.其中Timing模块实现了本文所提出的ACTSA.在SIP-CM开发验证阶段,我们为其设计了基于XilinxXC2VP70FPGA的开发验证平台(SIP-CM-XL)以验证其功能.下面主要介绍基于SIP-CM-XL的ACTSA验证过程.为验证ACTSA在CMTS与CM的实际交互环境中的正确性和定时精度,本文搭建了图7(b)所示的测试环境.该环境中CM与CMTS距离约为30m,通过Cable线连接,CMTS为Cisco7114E.测试环境温度为30左右.电源为DH1718E-4型双路跟踪稳压稳流电源.CPE和PC均为DELLDe-mension3100微型机.此外CM和CMTS周围均无其它电气设备.算法正确性验证1.借助与CM相连的CPE上的ping程序产生上行用户数据来检验ACTSA在控制接入上行TDMA信道的正确性.其中CM分别采用Motorola5100和本文的SIP-CM,SIP-CM的Timing使用10.24MHz的晶体振荡器作为时钟源,两者的测试结果见表2,结果表明SIP-CM在功能上与Motorola5100完全等同,验证了本文算法的正确性.表3SIP-CM平台实际捕获样本样本号123456表2SIP-CM与MotorolaCM的Ping程序测试统计数据CMMotorola5100SIP-CM算法定时精度验证2.与验证1不同,本测试在SIP-CM中嵌入XilinxDCMIPcore,以40.90MHz的晶体振荡器作为该DCM输入时钟源,并使其产生10.225MHz的4分频时钟作为Timing模块的输入时钟.即SIP-CM定时器的参数为fcm=10.225MHz,Δf=0.015MHz.同时,为Timing模块编写Monitor硬件逻辑,将每个TS到达点的TS值、测距定时偏移量Time_Offset及经算法调整和未调整的定时器计数值Cor_Tm和Err_Tm输出到SDRAM,并由运行在龙芯上的软件程序通过串口输出到CPE.该实验测试结果见表3和图8.其中,表3列出了6组随机采样的样本点,并计算出经算法调整和未调整的CM定时误差Cor_TNE和Err_TNE.图8绘制了1000个随机样本点对应的Cor_TNE和Err_TNE.该测试结果表明E(Cor_TNE)=1,出现Cor_TNE=2的原因解释为:算法未考虑CMTS本身时钟频率偏差、信道变化及SIP-CM-XL上的其它噪声影响.参数本节测试证明ACTSA在实际环境中具有同仿真同样的正确性和定时精度.定时精度为该精度是CMTS允许的定时偏移误差1μs的10.24倍[2],由此可见,本文所提出的ACTSA对于提高CM定时精度有显著的效果.5结论本文为HFC网络CM与CMTS的全局定时同Page10步提出了一种自适应补偿定时同步算法,该算法采用线性延迟补偿策略准确定位CM定时误差补偿时刻,使CM能够在本地建立准确的定时基准,同步于CMTS,为CM准确的上行传输提供了保证.通过理论推导、Matlab算法级仿真以及实际网络环境下的测试,充分验证了本文算法的正确性和定时精度.实现有本文算法的SIP-CM已成功应用于HDTV双向点播系统、VOD、VoIP、Internet网络通信等应用中并表现出优良的性能和可靠性.
