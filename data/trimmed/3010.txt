Page1可避免数据包乱序的网络层软切换方法及其性能分析舒童1),2)刘敏1)李忠诚1)1)(中国科学院计算技术研究所网络技术研究中心北京100190)2)(中国科学院研究生院信息科学与工程学院北京100190)摘要随着异构无线网络的融合和全IP网络的推广,网络层软切换方法不断演进,用以提高垂直切换的性能.但是,现有的软切换方法在下行垂直切换过程中会造成严重的数据包乱序.为此,文中在讨论下行垂直切换时数据包乱序的原因之后,提出了一种新型网络层软切换方法———SHORDER.该方法根据移动终端与其家乡代理之间的交互信令对终端所收数据包进行适当的缓存,能有效避免移动终端因下行垂直切换接收到乱序的数据包.该方法所具有的网络层独立性使其能与各种传输层协议及其改进协议相兼容.此外,文中还从理论上定量地分析了所提方法对TCP应用的切换时延、有效吞吐量及拥塞窗口的影响,并与现有的典型网络层软切换方法进行了比较.通过比较,得出了SHORDER机制的适用条件,并基于此,进一步改进了SHORDER方法.最后,在原型系统上的实验显示出了所提机制便于部署的优点以及该机制在其适用条件下的良好性能.此外,实验结果还显示出与数值分析结果的一致性.关键词下行软切换;数据包乱序;TCP吞吐量;快速重传;异构无线网络1引言随着无线通信技术的迅猛发展,各种无线通信网络突显出自身优势.但是,目前还没有一种单独的网络能够满足移动用户对覆盖无缝化与通信宽带化的双重要求.无线广域网(WWAN)以较低的数据传输率可以保证移动终端任意时刻和无处不在的连通性.无线局域网(WLAN)以低廉的价格为高密度用户提供较高的数据传输率,但只能覆盖较小的范围.由于不同无线网络之间的互补性,4G网络将这两种无线技术整合起来,不仅可以更好地满足移动用户的各种需求,而且能给服务提供商带来更大的经济利益.为了实现一个真正的无缝移动环境,除水平切换(HHO)外,垂直切换(VHO)已成为4G网络实现的主要挑战.HHO是指移动终端在同构网络(基于同种链路层技术的网络)内不同接入点之间的切换,而VHO是指移动终端在异构网络(基于不同链路层技术的网络)之间的切换.从无线重叠网络覆盖的角度,VHO又分为上行垂直切换(UVHO)和下行垂直切换(DVHO).UVHO是从覆盖面积小的无线网络切换到覆盖面积大的无线网络,如从WLAN切换到3G网络.DVHO则是从覆盖面积大的无线网络切换到覆盖面积小的无线网络,如从3G网络切换到WLAN[1].传统的切换一般为硬切换,即移动节点(MN)释放与先前接入点(AP)或基站(BS)的无线链路后,再建立起与新AP或BS的无线链路.MN如果使用硬切换,那么它在任何时候只能维护与一个AP或BS的连接[2].由于执行硬切换的MN先停止从先前网络接收数据包再立即开始等待从新网络接收数据包,所以,有些发向先前网络的数据包会因尚在传输途中而无法被MN接收,这些数据包只能由数据源重新发送[3].软切换与硬切换不同,它是指MN先建立起与新AP或BS的无线链路之后,再释放与先前AP或BS的无线链路.执行软切换的MN在重叠切换区域可以维护与两个以上AP或BS的连接[2].MN位于双重覆盖区域是软切换实现的必要条件.而DVHO恰好满足这一条件.然而,软切换会带来数据包的乱序.众所周知,数据包乱序会降低上层应用的性能.Tandjaoui等人讨论了乱序数据包到达MN后对TCP和UDP应用所造成的不良影响.他们认为乱序数据包不仅会引起TCP接收端返回重复的ACK,使发送端启用TCP的拥塞控制算法,并调用数据包重传过程,而且还会要求实时业务具备更多的缓冲区和更复杂的机制用于数据流的正确处理[4].为了避免VHO过程中的数据包乱序,本文提出了一种网络层的软切换方法SHORDER.它能以很小的消息开销有效地防止MN在VHO时接收到乱序的数据包.与现有文献相比,本文的主要贡献在于:所提出的可避免数据包乱序的网络层软切换方法独立于传输层协议,并能与各种TCP改进协议相兼容.本文从切换时延、有效吞吐量及拥塞窗口等方面分析并比较了所提方法和现有的典型方法对TCP性能的影响.原型系统实验显示出SHORDER方法因无需修改数据发送端而在实际应用方面所带来的优势.同时,实验结果还验证了本文理论分析的正确性.本文第2节分析国内外的相关研究现状;第3节提出一种可避免数据包乱序的网络层软切换方法,并阐述它的有效性和前提条件;第4节通过与现有方法相比较,分析所提方法对TCP性能的影响并讨论它的适用条件;第5节给出实际异构无线环境中的实验结果;第6节根据前文的对比分析和实验结果,进一步改进了SHORDER方法;最后,第7节总结全文.2现有技术分析国际组织IETF(Internet工程任务组)提出的移动IPv6(MIPv6)协议[5],可以支持多模移动终端的HHO和VHO.但是,当MN切换时,它和通信节点(CN)之间数据包会发生丢失.由于MN移动Page3到WLAN中时一般处于WWAN的覆盖范围,所以软切换方法可以用于DVHO来避免数据包的丢失.Chakravorty等人改进标准的MIPv6机制,提出了基于终端的网络层软切换(CSH)方法[3],用以提高VHO的性能.CSH方法在MN的网络层增加了一个软切换模块.每当MN触发VHO后,此模块从MN先前的网络接口读取CN发给它的数据包,并将其交给上层应用.同时,MN向家乡代理(HA)进行注册,之后从新网络接口发送数据包.该方案在CN无需发送重复数据包的情况下能保证MN在切换过程中同时从新旧网络接口接收数据包,使得到达先前网络接口的数据包不会被丢弃.但是,CSH方法却未解决DVHO过程中数据包乱序的问题.Chakravorty等人也指出其所提方法会引起DVHO时的数据包乱序,导致TCP发送端因接收到MN生成的重复ACK而进入快重传模式,继而使拥塞窗口减半.DVHO时CSH方法引发数据包乱序的原因在于:由于从HA经WLAN到MN的时延小于经WWAN的时延,所以HA更新绑定之后向WLAN转发的部分数据包会先于更新绑定之前向WWAN转发的部分数据包而到达MN,导致MN接收到乱序的数据包.目前解决乱序数据包的常见办法是在数据包的网络层报头中加入序列号,由接收方自行匹配或排序.这样,网络层每收到一个数据包就需要判断其排序的位置,以及哪些数据包能够提交给上层.所以,该方法的时间复杂度为O(nlogn),其中n为乱序数据包个数.文献[4]针对减少MN水平切换时的乱序包问题,提出了相应的解决方法.当新旧外地代理(FA)与HA间的路径时延相近时,数据包乱序的持续时间近似等于新旧FA间的链路延时,但这种方法不适用于异构环境下的VHO场景,因为在这种情况下新旧FA之间的时延一般都很大.因而,本文针对VHO场景提出了线性时间复杂度的网络层软切换方法.还有一些研究者也关注于防止DVHO中乱序数据包对TCP性能的负面影响,提出了各种解决方案.在一些机制中,当切换即将发生时,接收端会通知发送端其接入链路的改变.在文献[6-7]中,Daniel等人提出了一种发送端的改进算法,用于抵制从低速链路向高速链路切换时的乱序数据包.所提算法根据新链路的带宽和延时,动态改变重复确认的阈值,从而避免不必要的重传.王能中等人也提出了一种方法[8]:当发送端通过新链路收到来自接收端的切换通知时,它可以获得与接收端的往返时延(RTT),继而暂停某些超时计时器参数并冻结数据传输.然后,发送端用指数加权滑动平均方法重新调整慢启动阈值,并根据快速估计的可用带宽来更新拥塞窗口的值.然而,这些机制都要求修改TCP发送端的协议,因而不易于实际部署.所以,本文提出一种无需修改发送端的解决方案.另一些研究者以移动接收端为核心设计松散耦合的跨层方案.在文献[9]中,Hansmann等人提出了Nodupack方法,该方法在满足一定条件时会抑制切换过程中重复确认的传输.其条件包括:(1)从新链路上接收到报文;(2)传输的重复确认数量小于预定阈值;(3)新链路上的报文是按顺序接收的.在文献[10]中,Rutagemwa等人还提出了一种主动的RTT均衡机制,通过调整所有数据包所经历的RTT,来防止DVHO过程中乱序数据包所引起的伪快速重传.但是,这些方法不适用于TCP报文中有时间戳选项的情况[11].时间戳选项用于TCP序列号的回卷保护,是很重要的任选要求,现已实现在各种Linux内核版本中.在本文中,所提出的可避免数据包乱序的网络层软切换方法也是以移动接收端为核心的,但是它将独立于传输层,并与TCP时间戳选项相兼容.3可避免数据包乱序的网络层软切换方法为了解决DVHO时的数据包乱序问题,本文以移动终端进行下行垂直切换时WWAN本身不产生乱序数据包为前提,改进CSH方法,提出了一种新型网络层软切换方法———SHORDER方法.本节将描述SHORDER方法的详细步骤,并讨论该方法的性能及其必要条件.3.1SHORDER方法SHORDER方法的核心思想是,一方面,在DVHO开始后的一段时间内MN和HA需要维护MN先前CoA与HA之间的隧道,以保证那些双IPv6报头的数据包能被正确解析,从而正常地被接收或转发.另一方面,当DVHO被触发后,MN的网络层需要把从新网络接收的数据包放入缓存队列,暂不提交上层.当它把HA经先前网络向其转发的数据包全部接收后,才把缓存的数据包按接收顺序提交上层,并且不再缓存从新网络接收的数据包,从而使MN的上层无法感知到因切换而产生的数据Page4包乱序.下面将具体描述SHORDER方法的详细步骤,如图1所示.t1:当DVHO被触发后,MN立即建立一条从新CoA到HA的IPv6-in-IPv6隧道接口,并从新网络接口向HA发送第一绑定更新(BU)消息,其中的新增标志位S被置为1.此后,MN仍保留着从先前CoA到HA的IPv6-in-IPv6隧道接口,并继续通过先前隧道向CN发送数据包.另外,MN创建一个先进先出(FIFO)的缓存队列,若从新网络接收到来自CN的数据包,则将其依次放入此缓存队列,暂不提交上层.t2:HA接收到标志位S为1的第一BU消息后,它立即更新MN对应的绑定缓存表项,建立一条从HA到MN新CoA的IPv6-in-IPv6隧道接口,并修改到MN家乡地址(HoA)的路由,使得再截获发向MN的数据包时,通过新隧道将其转发给MN.接下来,HA向MN的新CoA和先前CoA同时发送同序列号的第一绑定确认(BA)消息,通知MN绑定更新成功,其中的新增标志位S均置为1.此后,HA在一段足够长的时间内仍保留到MN先前CoA的IPv6-in-IPv6隧道接口.t3:若经新网络的路径时延低于经先前网络的路径时延,则经新网络的第一BA消息会先于经先前网络的第一联播BA消息而到达MN.当MN从新网络接口接收到先返回的第一BA消息时,若消息指示绑定更新成功,则MN修改路由,使数据包从新隧道发出,并以先前网络接口上的CoA为源地址经先前网络向HA发送第二BU消息,其中的标志位S置为0.t4:当MN接收到返回的另一个第一BA消息时,它删除从先前CoA到HA的IPv6-in-IPv6隧道接口,并判断缓存队列是否为空.如果否,则按FIFO原则把缓存的数据包提交上层,销毁该缓存队列,之后不再缓存从新网络接口接收到的数据包,而是将其直接提交给上层.t5:HA接收到标志位S为0的第二BU消息后,删除到MN先前CoA的IPv6-in-IPv6隧道接口,并向MN的先前CoA发送第二BA消息,其中的标志位S置为0.t6:MN接收到第二BA消息,DVHO完成.注意,若MN从先前网络接口接收到先返回的第一BA消息,则说明从HA经新网络到MN的时延大于经先前网络的时延,不会发生数据包的乱序.此时,MN不必再发送第二BU消息;而HA在等待一段足够长的时间后,直接删除到MN先前CoA的IPv6-in-IPv6隧道接口即可.SHORDER方法支持MN发生连续的切换.所谓连续切换,是指在t4时刻前,MN又切换到另一个新的网络,并接收到该网络的数据包.在这种情况下,后续切换仍可使用相同的切换步骤.但不同的是,MN要为后续的每次切换另外创建新的缓存队列,并且在需要提交此缓存队列中的数据包时,判断之前切换所建的缓存队列是否存在.若存在,则将这些数据包依次放入其中最近一次切换所建的缓存队列里.3.2性能分析本节将证明SHORDER方法能有效地消除DVHO过程中的数据包乱序,并从时间复杂度和时延开销两个方面分析该方法的性能.这里假设当MN和CN之间的路径不改变时,MN不会接收到乱序的数据包.该假设的有效性将在3.3节加以说明.基于这一假设,有如下定理.定理1.如果从CN经HA到MN的新旧路径上均不发生数据包乱序,那么MN用SHORDER方法进行VHO时MN的传输层不会接收到乱序的数据包.证明.用Dp和Dn分别表示从HA到MN先前CoA和新CoA的路径时延.若DpDn,则路径的改变不会引起数据包的乱序.考虑Dp>Dn的情况.令发向MN的数据包序列{p1,p2,…,pm,…,pn}于时间序列{t1,t2,…,tm,…,tn}到达HA,其中t1<t2<…<tm<…<tn;且HA于th时刻接收到BU并更新了MN的绑定注册.不失一般性,假设tm<th<tm+1,因此,数据包序列{p1,p2,…,pm,pm+1,…,pn}于时间序列{t1+Dp,t2+Dp,…,tm+Dp,tm+1+Dn,…,tn+Dn}到达MN.如果ti+Dn<th+Dp(m+1in),那么在SHORDER方法中,Page5由于MN在th+Dp时刻才接收到第一BA的第二个副本,所以发向MN新CoA的数据包pi会按顺序地被暂时缓存在MN的网络层.也就是说,数据包序列{p1,p2,…,pm,pm+1,…,pn}是在时间序列T={t1+Dp,t2+Dp,…,tm+Dp,max(tm+1+Dn,th+Dp),…,max(tn+Dn,th+Dp)}时被提交给MN的传输层的.而这个时间序列T是单调增的,即MN的传输层接收到的数据包与CN发送数据包的原始顺序相同.另外,SHORDER方法在解决DVHO所带来的乱序数据包方面具有良好的性能.这不仅体现在它能避免DVHO过程中的数据包乱序上,而且表现在它具有很低的时间复杂度和极短的冗余时延上.SHORDER方法排序数据包的时间复杂度很低.由于SHORDER方法把第一BA的第二副本到达MN作为MN已收到来自先前网络所有数据包的重要标志,所以使用FIFO队列就可以从DVHO引发的乱序数据包中恢复出原始的数据包序列,因而,SHORDER方法把数据包整序的时间复杂度降为了O(n).随着网络应用流量和异构网络链路时延差的增大,DVHO所产生的乱序数据包数目会大幅度增加,而SHORDER方法对大量乱序数据包的快速整序能力将表现得更为明显.并且,在SHORDER方法中,数据包因缓存而被滞后的时延接近于保证数据包顺序接收的最短时延.具体来说,MN的传输层收到经新网络传输且被缓存的数据包的时间与收到经先前网络发来的最后一个数据包的时间之差是一个从0到数据包发送间隔的均匀分布的随机变量.也就是说,从统计意义上讲,SHORDER方法所引入的不必要的平均时延是平均数据包发送间隔的一半.所以,SHORDER方法缓存数据包所带来的时延不会影响上层应用的性能.注意,虽然SHORDER方法在切换时需要MN对数据包进行缓存,但是,切换频率与缓存大小并没有直接的关系.为了便于表述,令MN先前的网络为N0,新网络为N1,而后MN在t2+T2,t2+T3,…时刻依次切换到新网络N2,N3,…;假设从HA经网络Ni到MN的时延和带宽分别为Di和Bi(i=0,1,…).若经网络N2的数据包在t4时刻后到达MN,则MN已把来自网络N1的数据包提交给上层,并销毁了缓存这些数据包的队列Q1.所以,后续切换不会影响本次切换的缓存大小,即为B1(D0-D1).如果增大切换频率,使得在t4时刻前MN收到了来自网络N2,N3,…,Nr的数据包,那么MN需要分i=2Bimin{Ti+1-Ti,max{D0-Di-Ti,0}}+别为每个新网络分配一个缓存队列Qi.在这种情况下,本次切换的缓存大小是指在t4时刻所有缓存队列的长度之和,为B1min{D0-D1,T2}+∑r-1Br(D0-Dr-Tr)B1T2+∑r-1BjT2+∑r-1Br(D0-Dr-Tr),(j=argmax1irBi)=Br(D0-Dr-Tr)+BjTr所以,缓存的大小不会随切换频率的增加而增大.3.3前提假设的适用范围由于路由器的并行处理,数据流在多路径上的传输,以及无线链路协议的重传机制,使得网络有可能会零星地颠倒一条数据流中几个数据包之间的顺序.但是,当前的许多研究都指出当传输路径固定时在绝大多数的情况下实际网络中是不发生数据包乱序的.也就是说,本文的假设在大多数场景下都成立.从表1中网络内乱序数据包的测量结果[12]可以看到,有线网上很少发生数据包的乱序.文献[13]中所有固定比特率UDP流的实验分析显示,在所测的CDMA2000网络中没有乱序数据包.我们在CDMA和GPRS公网中对数据包乱序的测试结果(参见表7)也表明数据包出现乱序的概率很小.此外,IEEE802.11的MAC层协议也不会有意地打乱MAC服务数据单元的顺序.实际上,目前已有许多避免网络中数据包乱序的有效方法.在文献[14]中,3GPP规定了在WCDMA环境中保证数据包顺序传输的方法.IEEE802.11规范也为不容忍乱序的上层协议定义了可选的严格依序服务等级[15].4网络层软切换对TCP性能的影响TCP应用在当今的网络应用中占据着绝对的Page6统治地位,所以本文将从理论上分析网络层软切换方法对TCP应用性能的影响.本节集中探讨CSH方法和SHORDER方法对TCP应用的切换时延、切换过程中有效吞吐量和切换后拥塞窗口的影响以及两种方法各自的适用条件.4.1TCP应用的切换时延和切换过程中的有效吞吐量为了下文表述的简洁,令CN与HA之间的双向时延均为D,从HA经WLAN到MN的时延为DL,带宽为BL,而经WWAN的时延为DW(>DL),带宽为BW(<BL).从MN经WLAN到HA的时延为DL,而经WWAN的时延为DW.鉴于MN上的TCP流量以下行为主,本文重点关注CN向MN传输数据的情况.当MN触发DVHO时,向HA发送一个BU消息.在th时刻,HA接收到此消息,并更新了对MN的绑定.此时从HA经WWAN到MN的链路上还滞留有总数据量为BWDW的数据包.随后,HA继续接收到从CN发来的数据包.这些数据包被HA经WLAN转发给MN,并于th+DL时刻开始陆续达到MN.但此时从HA经WWAN到MN的链路上还滞留有数据量为BW(DW-DL)的数据包,所以经WLAN的数据包是先于CN之前发送的那些数据包而到达MN的.对于CSH方法,从th+DL时刻开始,MN上的TCP协议层通过判断所收数据包的序列号和时间戳发现了乱序现象,于是不断地向CN返回重复的ACK.这些ACK在th+DL+DL+D时刻后相继达到CN.CN接收到这些重复的ACK后,通过WLAN路径先重传数据量为BW(DW-DL)的数据包,再继续发送新数据.所以,MN在th+DL时刻后先从WLAN收到数据量为BW(DL+DL+2D)的数据包,再从WLAN收到重传的那些数据包.这些重传的数据包从CN开始发送起,经过D+DL+[BW(DW-DL)/BL]时间后,被MN全部接收.此后,MN会继续从WLAN以高数据速率接收数据,切换过程到此结束.所以,对于TCP应用来说,从th时刻起,整个DVHO的时延为tCSH=2DL+DL+2D+[BW(DW-DL)/BL]=DWBW/BL+DL(2-BW/BL)+DL+2D(1)在这段时间内MN接收到的数据量为对于SHORDER方法,MN的网络层会缓存从WLAN到达的数据包,等th+DW时刻接收到经WWAN到达的全部数据包后,再提交这些从WLAN到达的数据包.因此,从th时刻起,TCP应用的整个DVHO时延为在这段时间内MN接收到的数据量为dSHORDER=BWDW+BW(DW-DL)=2BWDW-BWDL如果式(5)和式(6)均成立,tSHORDER<tCSHdSHORDER+BL(tCSH-tSHORDER)>dCSH(6)那么移动终端用SHORDER方法就可以更快地完成DVHO,使得TCP应用能更早地享用WLAN的高带宽,同时在切换过程中接收到更多的数据.将式(1)和式(3)代入式(5),可得DW<(2BL-BW)DL+BLDL+2BLD把式(1)~(4)代入式(6),可知当BL2BW时,式(6)恒成立;当BL>2BW时,式(6)等价于DW<(2BL-3BW)DL+(BL-BW)DL+2(BL-BW)D=2DL+DL+2D+BW(DL+DL+2D)由于BWBL且DL≈DL,所以式(7)和式(8)均可简化为式(9)所以,当式(9)成立时,用SHORDER方法进行DVHO可以提高TCP应用的有效吞吐量.也就是说,SHORDER方法适用于CN与HA的距离很远,或者从HA经WWAN到MN的时延小于3倍的从HA经WLAN到MN的时延的情况.在上述分析的基础上,用MATLAB分别计算出使用CSH和SHORDER方法进行DVHO的TCP应用切换时延和此过程中的平均有效吞吐量.这里,切换过程中的平均有效吞吐量是指从切换起始时刻th开始到切换完成时刻截止,MN所确认收到的数据量与切换时延的比值.根据IEEE802.11规定,802.11b系统包括1,2,5.5,11Mbps4种数据速率.据有关的产品说明所述,中兴ZXTRB30基站的下行最大用户数据速率为384kbps.此外,我们在CDMA1xEVDO网点的实际测量结果表明CDMA1xEVDO终端与其接入路由器之间的往返时延(RTT)约为150ms.由此,在数值仿真中选用表2中所示的参数值.通常,在Page7WLAN中,MN与其接入路由器之间的链路时延很短,约为1~2ms,所以MN与HA之间经WLAN的链路时延主要由WLAN的接入路由器和HA之间的有线网链路时延所引起.因而,这里假设DL等于DL.数值仿真的具体参数值详见表2.参数BL数值2Mbps384kbps80ms图2和图3中显示了数值仿真结果.图2显示图2TCP应用的软切换时延图3网络层软切换过程中的平均有效吞吐量在3G网络和WiMax网络广泛部署后,SHORDER方法将发挥更重要的作用.目前各种网络的具体带宽和时延值详见表3.与2.5G网络(如CDMA网络和GPRS网络)相比,3G网络和WiMax网络的带宽进一步增加,致使DVHO过程中乱序的数据包更多,也更需要解决数据包乱序的问题.与此同时,3G网络和WiMax网络的下行链路时延进一步降低,使得式(9)中SHORDER方法的适用条件更容易被满足.典型的有线网时延在几毫秒(本地以太网)到上百毫秒(Internet宽带链路)之间变化.对于3GLTE网络来说,当DW接近10ms时,通常情况下,式(9)都成立,也就是说SHORDER出当CN向MN进行TCP数据传输时网络层软切换的切换时延.图3展示了基于CSH方法在切换过程[th,th+tCSH]中的平均有效吞吐量(goodput)以及基于SHORDER方法在切换过程[th,th+tSHORDER]中的平均有效吞吐量.从中可以清楚地看出,随着D和DL的增加,SHORDER方法在切换时延和有效吞吐量方面逐渐优于CSH方法.近似地,当3倍的DL与2倍的D之和大于80ms时,在CN向MN的数据传输过程中,基于SHORDER方法的DVHO时延更短,且TCP有效吞吐量更高.方法会优于CSH方法.类似地,这意味着从3G网络或WiMax网络切向WLAN时在绝大多数场景下使用SHORDER方法都能获得更好的性能.WWANWLANIEEE802.11n[19]600Mbps1~3HSDPAandbeyond.见http://faculty.stut.edu.tw/~cwycwy/951/N9490006.pdfPage84.2拥塞窗口本节将进一步讨论使用CSH方法和SHORDER方法进行DVHO时,TCP拥塞窗口的变化.CWNDW和CWNDL(以字节为单位)分别表示WLAN路径上和WWAN路径上TCP连接的平均拥塞窗口值.由于BWBL,所以当式(9)成立时,有CWNDW<CWNDL.此外,令报文长度为S个字节.因为平均拥塞窗口等于路径的带宽时延积,于是,有为了计算拥塞窗口的精确值,关注以下时间点:在th时刻,HA接收到BU,改变了到MN的路径;使用CSH方法,在t1=th+DL+DL+D时刻,CN接收到从WLAN返回的第一个确认;根据CSH方法,在t2=t1+2S/BW时刻,CN接收到第3个重复的确认;按照CSH方法,在t3=t2+DL+DL+2D时刻,被重传报文的确认到达CN;基于SHORDER方法,在t4=th+DW+DL+D时刻,CN接收到最后一个经WWAN发向MN的报文的确认.通过分析在不同时段确认返回的情况,可以计算出CN发出新报文的数量和重传报文的数量,详见表4和表5.时间段(th,t1]BW(DL+DW+D)(t1,t2]表5基于SHORDER方法CN所发送的数据量时间段(th,t4]BW[(DW+DL+D)+(DW-DL)+(DW-DL)]0假设th时刻的拥塞窗口值为CWNDh∈[2CWNDW/3,4CWNDW/3].基于上述计算,能推出用CSH方法时在t1时刻的拥塞窗口值为CWNDCSH(t1)=基于CSH方法,TCP发送端会进入快速重传阶段,使得拥塞窗口值在t2时刻变为CWNDCSH(t2)=3S+CWNDCSH(t1)/2.当TCP发送端完成快速恢复后,按照CSH方法,DVHO结束.t3时刻的拥塞窗口值为CWNDCSH(t3)=S+CWNDCSH(t1)/2若使用SHORDER方法,则不会出现乱序的报文和重传的报文.所以,DVHO完成后t4时刻的拥塞窗口值为CWNDSHORDER(t4)=CWNDh+S2≈CWNDh+SBW(2DW-DL+DW+D)比较式(10)和式(11),可知当CWNDh2S时,CWNDSHORDER(t4)>CWNDCSH(t3).一般地,除了在慢启动初始阶段,TCP的拥塞窗口是不会小于2倍的报文长度的.因此,用SHORDER方法进行DVHO后的拥塞窗口将会大于用CSH方法完成DVHO后的拥塞窗口.正是因为TCP的发送端基于SHORDER方法不会引起拥塞窗口的减半,所以,所提的机制在DVHO后不会带来吞吐量的骤减.基于上述分析,用MATLAB分别计算出基于CSH和SHORDER方法在DVHO后TCP拥塞窗口的大小.在数值仿真中选用表6中所示参数值.参数BWDWDWS数值384kbps80ms120ms1400Byte图4和图5中展示了数值仿真结果.图4描绘出当DL为25ms且D为40ms时切换前TCP拥塞窗口的不同值所对应的切换后TCP拥塞窗口的值.图5展现了在切换前拥塞窗口的值等于先前网络中TCP连接的平均拥塞窗口值的情况下,当DL和D为不同值时,切换后TCP拥塞窗口值的变化.很明图4切换前拥塞窗口值对切换后拥塞窗口值的影响Page9显,用SHORDER方法切换后的TCP拥塞窗口值远高于用CSH方法切换后的TCP拥塞窗口值.这意味着移动终端基于SHORDER方法切换到WLAN后的一段时间内,它的TCP吞吐量更高,因为它在很大程度上省去了CSH方法切换后TCP拥塞窗口加性增长以匹配WLAN高带宽的过程.图5新网络路径时延对切换后TCP拥塞窗口值的影响图6实验平台拓扑图通过实际测试,移动终端与WLAN的接入路由器,CDMA网络的接入路由器和GPRS网络的接入路由器之间的RTT分别约为2~3ms,400ms和800ms.此外,IPv6局域网中的主机与FTP服务器之间的RTT约为35ms.5.1WWAN中包乱序程度的测试SHORDER方法防止移动终端在DVHO时发生数据包乱序的前提是在移动终端的切换过程中表7经WWAN数据包的乱序程度CDMA公网GPRS公网在试验中,移动终端与IPv6主机之间经CDMA公网的数据包没有发生乱序现象,从IPv6主机经GPRS公网到移动终端的数据包也没有出5系统实验为了进一步验证所提方法的可行性和有效性,本文给出原型系统实验.基于对支持MIPv6协议的MIPL(MobileIPv6forLinux)开源代码①的修改,原型系统中分别实现了CSH方法和SHORDER方法.实验环境的网络拓扑如图6所示,是一个WWAN和WLAN松散耦合的试验台.实验平台处于WWAN(CDMA网络和GPRS网络)的覆盖之下.其中布有两个AP,它们通过IPv6路由器接入到一个IPv6局域网,形成两个WLAN.其中,一个WLAN为家乡网络,另一个为外地网络.此外,IPv6局域网还与公共IPv6网络相连,该局域网中的任何一台主机都能通过IPv6从公网上的一台FTP服务器上下载文件.WWAN本身不发生数据包的乱序,所以,首先需要在试验台上验证该假设的正确性.于是,分别针对CDMA公网和GPRS公网进行测试.移动终端接入到CDMA公网或GPRS公网后,分别从IPv6主机向移动终端和从移动终端向IPv6主机以0.1s为间隔发送了100000个数据包,并在对端检查接收情况,结果如表7所示.现乱序.而从移动终端经GPRS公网到IPv6主机的99748个数据包中有16个包发生了乱序,其中1个①http://www.mobile-ipv6.org/Page10数据包前移3个包位置,2个数据包前移2个包位置,3个数据包前移1个包位置,10个数据包滞后1个包位置.由此可见,在公共WWAN中,数据包发生乱序的概率很小,而又恰在移动终端进行DVHO时发生数据包乱序的概率就更小了.所以,SHORDER方法的前提条件在试验台上通常是成立的.5.2SHORDER方法的实施效果3.2节已经证明了如果从CN经HA到MN的新旧路径上均不发生数据包乱序,那么MN用SHORDER方法进行VHO时MN的传输层不会接收到乱序的数据包.本节通过实际系统实验,来演示SHORDER方法防止DVHO过程中发生数据包乱序的良好效果.为了便于观察实验现象,此实验选用GPRS网络作为WWAN.在实验中,当IPv6主机向移动终端每隔50ms图7网络层软切换时MN所接收到的数据包上述实验重复了10次,获得了类似的实验结果.这些实验充分说明了在实际环境中SHORDER方法能够有效地避免移动终端因DVHO而接收到乱序的数据包.5.3网络层软切换方法对TCP应用吞吐量的影响本节将以文件传输业务为例,比较CSH方法和SHORDER方法对TCP有效吞吐量的影响.在随后的实验中,移动终端从FTP服务器下载文件的同时,先后用CSH方法和SHORDER方法进行DVHO.所得的实验结果可以验证前文对CSH和SHORDER方法适用场景分析的正确性.不过,鉴于实验平台不在3G网络的覆盖下,所以在本节的实验选用与GPRS网络相比链路延迟较低的CDMA网络作为WWAN,以替代3G网络.(1)式(9)中条件成立的情况为了观察在满足式(9)要求的情况下CSH方发送1个内含序号的UDP数据包时,分别用CSH方法和SHORDER方法进行DVHO,并观察此过程中网络接口收到UDP包的时间以及网络层提交UDP包的时间,如图7所示.图7(a)中所示的实验结果表明UDP包全部被移动终端接收,但是,由于网络层把收到的UDP包立即提交给了UDP协议层,使得在1.1~1.3s间MN的UDP协议层所接收到的序号从17~22的UDP包依次滞后于序号从23~27的UDP包.图7(b)中的实验结果显示,移动终端的网络层不仅接收到全部的UDP包,而且把它们按发送顺序提交给了UDP协议层.从图中可以看出,经GPRS网络的最后一个UDP包(序号为23)于1.2s到达移动终端,过了10ms后,移动终端就向UDP协议层提交了缓存队列中序号从24~27的UDP包.法和SHORDER方法对TCP有效吞吐量的影响,对图6所示的实验场景进行了调整,在HA和WLAN外地接入路由器上增加了数据包转发延时模块,使得WLAN外地接入路由器与HA之间的双向路径时延都变为100ms,而HA与FTP服务器之间的双向路径时延均增加150ms.而后,在调整过的实验环境中进行DVHO实验.图8记录了移动终端在文件接收过程中返回的所有ACK.图8(a)和(b)分别反映了在3倍的DL与2倍的D之和略大于DW的情况下基于CSH方法和SHORDER方法的TCP有效吞吐量.根据实验结果统计,在DVHO开始后的2s内,基于CSH方法的TCP平均有效吞吐量为92.1kbps,而基于SHORDER方法的TCP平均有效吞吐量为112.4kbps.明显地,与4.1节中的分析相同,在这种实验条件下,SHORDER方法优于CSH方法.Page11图8式(9)成立时网络层软切换方法对TCP性能的影响根据图8(a)所示,移动终端基于CSH方法在2.98s时发生了DVHO,其TCP协议层返回了许多重复的ACK,导致FTP服务器重传了先前经CDMA网络传输但尚在途中的那些数据包.由于移动终端与FTP服务器经WLAN的路径时延较高,所以FTP服务器在切换发生后用了1.2s才完成对旧数据包的重传.根据图8(b)所示,移动终端用SHORDER方法在2.89s时发起了DVHO,并一直等待接收并提交完经CDMA网络到达的全部数据包后,于3.27s时把经WLAN接收的数据包提交给上层的TCP协议层,而后继续从WLAN接收FTP服务器发来的新数据包.所以,在此场景下,与CSH方法相比,SHORDER方法可以使移动终端更早地完成切换,同时避免伪快速重传和拥塞窗口减半,从而获得更高的吞吐量.图9式(9)不成立时网络层软切换方法对TCP性能的影响根据图9(a)所示,移动终端在2.99s时开始DVHO,由于MN的TCP协议层先收到了从WLAN到达的后续数据包,并返回了一连串重复的ACK,所以,FTP服务器重传了先前发送的经CDMA网络传输的那些数据包.在3.21s时,FTP服务器完成了数据重传,继续经WLAN向移动终端传输数据.在3.21s后,移动终端返回的重复ACK是由从WWAN接收到的时间戳已过时的数据包所引起的.从图9(b)中可以看出,移动终端在(2)式(9)中条件不成立的情况接下来,考察式(9)不成立的情况.此时可以直接使用图6所示的拓扑环境进行DVHO实验.在此场景中,接入CDMA网络的移动终端与FTP服务器之间的RTT至少为450ms,且随着流量的增大,时延会更长;而接入WLAN的移动终端与FTP服务器之间的RTT一般只有37ms,所以此时式(9)并不成立.图9记录了移动终端在文件接收过程中返回的所有ACK.图9(a)和(b)分别示例了在3倍的DL与2倍的D之和远小于DW的情况下基于CSH方法和SHORDER方法的TCP有效吞吐量.从图中可以看出,在当前的实验条件下,基于CSH方法的TCP有效吞吐量高于基于SHORDER方法的TCP有效吞吐量.这与4.1节中的分析相一致.2.86s时触发了DVHO,并且一直等待把经CDMA网络到达的数据包都接收并提交后,才于5.4s时把经WLAN接收的数据包提交给上层的TCP协议层.所以,移动终端的TCP协议层按顺序接收到了切换过程中的所有数据包,没有返回重复的ACK,也没有引发FTP服务器的数据包重传.但是由于经CDMA网络的路径时延过长,对CDMA网络中数据包的等待贻误了移动终端享用WLAN高带宽的时机,致使在切换开始后2.5s,TCP的吞吐量才得以Page12提升.这个实验表明,在不满足式(9)的网络环境下,若要TCP应用有更高的吞吐量,则使用CSH方法更为合适.6SHORDER方法的改进近似地,在式(9)成立时,SHORDER方法优于CSH方法;而在式(9)不成立时,CSH方法优于SHORDER方法.由于这两种方法的互补性,如果能将两种方法综合起来,那么将能进一步改善DVHO的性能.因此,SHORDER方法中可以加入对式(9)成立与否的判断.令RTTL为MN与HA间经WLAN的往返时延,RTTW为MN与HA间经WWAN的往返时延,RTT为MN与CN间经WWAN的往返时延.假设DL≈DL且DW≈DW,则式(9)可转化为RTTW<3RTTL+2(RTT-RTTW)(12)下面粗略估计RTTL,RTTW和RTT的值.根据MIPv6协议,每当MN移动到一个新的网络时,或者MN的注册即将过期前,MN都要向HA发送BU消息,并接收HA返回的BA消息.这段注册时延即为MN与HA之间经当前网络的往返时延.所以,RTTW为MN之前最近一次绑定的注册时延.若MN在WWAN中因注册过期而进行了多次绑定更新,则可用这几次注册时延的均值来估算RTTW的值.在当前的绑定更新过程中,于t3时刻(参见图1),MN从新网络接口接收到第一BA消息,即可得到本次绑定的注册时延,于是令RTTL=t3-t1.TCP协议定义了一个时间戳选项,其功能之一就是用于测量端到端的往返时延,因此RTT的值可通过TCP协议的往返时延测量机制[11]获得.这样,在t3时刻,MN就能估算出RTTL,RTTW和RTT的值,继而判决是否在网络层缓存从新网络接收的数据包.所以,对SHORDER方法进行如下改进:在t3时刻,MN估算出RTTL,RTTW和RTT的值后,若式(12)成立,则MN按原SHORDER方法继续执行相应操作,否则MN修改路由,使数据包从新隧道发出,但不再发送第二BU消息,也不再缓存从新网络接口接收到的数据包.7结语随着软切换技术的发展,新兴的网络层软切换机制,已可以避免垂直切换过程中的数据包丢失.但是,现有的软切换方法仍会引起严重的数据包乱序,从而降低上层应用的性能,尤其影响TCP应用的吞吐量.为了解决这一问题,本文提出了一种网络层软切换方法SHORDER.该方法根据移动终端与其家乡代理之间的交互信令对终端所收数据包进行适当的缓存,能有效地防止移动终端因下行垂直切换而接收到乱序的数据包.该方法所具有的网络层独立性使其能与各种传输层协议及其改进协议相兼容.并且,它恢复乱序数据包原始顺序的时间复杂度仅为O(n),且引入的额外延迟不超过相邻数据包的时间间隔.随后,本文通过与现有的典型网络层软切换方法CSH相比较,从切换时延,有效吞吐量和拥塞窗口等方面定量地分析了所提机制对TCP性能的影响,并指出SHORDER机制的适用条件为DW<3DL+2D,其中,DL和DW分别为从家乡代理经先前网络和新网络到移动终端的路径时延,而D为通信节点与家乡代理之间的路径时延.基于此,本文进一步改进了SHORDER方法.最后,本文通过原型系统实验,显示出所提方法在其适用场景中的良好性能以及实验结果与数值分析之间的一致性.
