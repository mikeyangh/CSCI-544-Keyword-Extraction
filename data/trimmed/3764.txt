Page1一种互联网的稳定路由选择策略李琦徐明伟吴建平(清华大学计算机科学与技术系北京100084)摘要互联网中网络故障频繁,域间路由协议(BGP)并不能很好地适应网络故障.一般情况下,域间路由协议会经历一个比较漫长的路由搜索过程,导致互联网中大量的数据包丢包.虽然目前已提出了很多改进的BGP算法,但这些算法复杂度非常高,给路由器增加很多额外的计算代价.为了解决这个问题,作者提出了一个稳定的域间路由选择算法sBGP.在sBGP中,当路由器收到由故障触发的路由通告后,采用启发式的路由选择算法选择目前可选的最稳定路由为最佳路由.通过稳定路由选择,路由器可以选择有效的稳定路由,以避免无效的路由搜索以及路由不断更新引入的路由器处理开销.分析和模拟实验表明sBGP不仅能够有效提高BGP的收敛性能,而且可以减少收敛过程中的通信开销.关键词域间路由协议;BGP;稳定路由选择;sBGP;路由收敛1引言边界网关协议BGP[1]是互联网域间路由的标准协议.BGP路由的可用性和稳定性对整个互联网路由有很大的影响.Labovitz等人[2]发现实际网络中BGP路由会经历漫长的路由搜索过程.互联网上的测量研究表明,80%左右的网络故障延时不超过180s[3-4].然而,这些故障导致的路由失效和无效路由切换导致的BGP路由收敛延时会长达几十分Page2钟[5].无效的路由搜索不仅增加了路由器的处理开销,并且延长了互联网路由中的路由黑洞和回路.由此进一步增加了数据包在网络中的传输延时和丢包率[6],并直接影响现有各种互联网实时应用的性能[7].在BGP中,链路或者设备故障会使网络中一些路由成为无效路由.这些无效路由是同一事件引起的相关路由,不会立即从网络中消失.路由器不断地在无效路由中搜索最优路由并传播,直到稳定的可靠路由被选择为止.路径搜索过程大大增加了BGP路由收敛延时[8].为了解决这些路由的慢收敛问题,本文提出了一种稳定的BGP稳定路由选择算法(sBGP),利用路由相关性使稳定路由得到更多的机会被选为最优路由,缩短路径搜索过程以改善BGP路由收敛性能.稳定路由选择机制的基本思想是,记录Adj-RIBs-IN中每条路由的申明时间,根据多条路由在Adj-RIBs-IN的时间判断它们的稳定性.一旦路由发生变化则Adj-RIBs-IN中路由计时将被清零.当链路发生故障以后,由该故障链路触发的路由更新携带故障源信息.当路由器收到路由更新,则sBGP将首先判断当前所选的路由是否受故障影响.如果其中所选的路由受影响,则BGP重新执行路由选择,并选择Adj-RIBs-IN中最稳定的路由.如果路由不受影响,则sBGP直接忽略这个由于故障触发的病态路由更新事件.于是,sBGP在路由选择算法的简单修改不仅改进了BGP的收敛性能,而且限制了故障信息传播范围并提高了BGP的稳定性.目前我们已经在自主研发的虚拟路由器[9]中实现了sBGP方案,下一步将在CERNET2中进行大规模部署以研究和分析sBGP在真实互联网中的性能.本文第2节介绍BGP路由选择策略和问题,包括BGP路由传播过程选路问题、由此形成的域间路由收敛问题和BGP路由的主要问题以及相关的研究工作;第3节介绍sBGP启发式路由选择机制的原理,并给出具体关闭算法以及实例分析;第4节通过模拟实验的结果评价了sBGP和相关BGP改进方案的性能;最后第5节总结全文.2BGP路由选择策略和问题本节首先分析BGP路由的基本思想以及存在的问题,接着分析和评价现有BGP路由选择的改进方案.2.1BGP选路问题互联网由不同的自治系统(AS)组成,各个自治系统通过BGP协议互联.BGP路由信息封装在BGP的通告消息中,其中包括路由的声明和路由撤销消息.当一个BGP路由器发现一条新路由,路由声明消息将这条路由传播给邻居路由器.这条路由声明消息包括目前网络的IP地址前缀以及描述这条路由的属性信息;当一个BGP路由器发现到某个目的网络的路由不可用,则向邻居路由器发送路由撤销的通告消息;当BGP路由器发生路由改变(由于路由策略配置变化或者收到路由变化的通告消息),就向邻居路由器发送路由声明消息,在这种情况下缺省取消前面已使用的路由.BGP会话分为内部的BGP会话(iBGP)以及外部的BGP会话(eBGP).iBGP仅在一个自治系统中发送路由通告消息以达到自治系统内路由的一致性,而eBGP提供BGP路由器向其它自治性的邻居路由器发送路由通告消息.iBGP和eBGP会话路由决策过程是相同的,唯一的区别是BGP收到的iBGP通告消息后决策得到的路由不会继续向自治系统内的其它BGP通告.BGP路由器收到BGP通告消息以后将执行的路由选路决策过程如表1所示,即每一个路由器的路由决策结果由BGP通告消息中的属性来决定.表1中的每一步的计算结果是从前一步的计算结果重新选择获得一个路由的子集合.通过增加、修改和过滤通告消息中的属性值,管理员可以控制到达目的网络的路由选择决策过程.2.2BGP和改进BGP方案的问题由于域间路由协议BGP的设计原则路径向量路由的特点以及策略配置的灵活性[1]导致了整个互联网路由的慢收敛甚至不收敛.我们通过采用同步网络模型分析B-团(B-clique4)网络的路由收敛过程来分析这些问题.如图1所示,由6个AS组成全连接B-团拓扑,AS0的网络设备发生故障后,到达目的结点的路由会在AS1,AS2,AS3和AS4中经历路径搜索过程.在图1中,带下划线的路由表示Page3AS当前所选择的最优路由,[]表示没有到达目的结点的路由,实线方框中的路由表示该AS本轮发送给邻居的路由,没有使用实线方框围起来的表示上一轮发送给邻居的路由,w表示发送的是路由取消.为了便于分析,本文采用同步网络模型描述到达目的结点的路由的收敛过程.同步网络具有3个含义:(1)任意AS间的传输延时都是固定值,本文的例子设为1s;(2)网络中的AS同时收到邻居在上一轮发送来的路由消息,选择新的最优路由并传播出去;(3)AS优先选择优先级高的路由.图1所示BGPAdj-RIBs-IN中的路由已按优先级高低排列.当AS0和AS5之间的链路失效以后,在t=1时刻,AS1和AS2删除来自AS5的所有路由,在AS1,AS2,AS3,AS4都存在到达目的地址的路由,路径分别为[205],[105],[105],[3105].尽管这3条路由由于AS5和AS0的链路故障成为无效路由,但是AS1和AS2都无法知道这个信息.于是分别从所选择的[205]和[105]作为新路由,并发送[1205]和[2105]给邻居.在t=2时刻,所有AS同图1B-团拓扑的路由搜索过程一般来说,域间路由协议BGP的以下几个问题导致了整个互联网路由的慢收敛甚至不收敛:(1)故障的错误检测.在BGP协议中,路由器通过基于TCP可靠连接的Keepalive消息来检测邻居路由器,但是TCP会话的异常终止会引起BGP路由器不必要的路由重计算.这种不必要的路由重时收到邻居t=1时刻发送过来的路由声明,更新对应的Adj-RIBs-IN并重新选择路由.由于收到的来自AS1和AS2的路由,收到AS1的[1205],AS3选择[1205]为最优路由,并通告给邻居.类似地,当t=3时刻,当由于收到来自AS3和AS4的路由形成了回路,AS1不再有到达目的地址的路由,向邻居发送路由撤销通告.同样AS2也检测到回路,撤销路由.由于AS3先收到AS1的路由撤销通告,AS3将选择[2105].但由于受MARI限制,AS3不会马上发送[32105]给邻居.当t=4时刻,AS3在MARI时钟超时前收到了AS2发送的路由撤销通告.同时,AS4收到AS2的撤销通告,从Adj-RIBs-IN中删除[2105].直到t=4+t时刻,AS3收到AS2的撤销通告,删除Adj-RIBs-IN中的路由,并发送撤销通告给邻居.AS4收到路由撤销通告,删除Adj-RIBs-IN中所有路由,路由收敛过程结束.可见,在BGP路由收敛的过程中,每个AS会在所有邻居的Adj-RIBs-IN中不断搜索、选择和传播无效路由,直到所有AS的Adj-RIBs-IN中都不再存在任何路由.计算会引起全局相关BGP路由的重计算,从而导致网络的不稳定.(2)路由计算时间过长.不同于域内协议,作为一个路径向量协议,BGP协议在路由被取消或路由发生切换时可能会经历时间较长的路径搜索过程,在路由重计算过程中,BGP路由器经常选择的一些Page4路由可能已不再可用,这样的搜索过程导致了整个Internet中BGP路由收敛时间过长[8].(3)路由传播时延过长.BGP协议中的一些改进机制也直接影响到BGP中的路由更新传播.例如,BGP协议中规定BGP路由器向其邻居发送到达同一目的网络路由的最小时间间隔值限定为一确定值MRAI(MinimumRouteAdvertisementIn-terval).MARI虽然可以在一定程度上减小通信开销,但同时也增加了路由收敛时间[8].(4)BGP路由不收敛.BGP策略设置的灵活性和隐蔽性可能导致路由的不收敛.不同的AS分别由不同的组织或机构管理,它们根据自身的需要设置不同的BGP路由策略,具有很大的灵活性.此外,由于出于安全性等方面的考虑,各个AS的BGP路由策略通常是不对外公开的,具有很强的隐蔽性.BGP策略的这种特性使得每个AS都无法获得全部路由策略信息,不能判断策略冲突,可能最终导致路由的不收敛[10].很多改进的BGP方案缓解或者解决了上面的4个问题,但是由于这些方案本身设计的缺点并不能实际部署,以有效提高BGP收敛性能.RCN[8]和EPIC[11]通过在BGP通告消息中增加路由变化的根源信息以加快路由的收敛,但它们的改进性能在很大程度上依赖于网络的拓扑结构,而且这些方案并不支持增量部署.CA方案[12]通过检测路由通告中的无效路由加快路由收敛,但这个方案给路由器增加了很大的计算负载.GhostFlushing方案[13]通过在通告新路由前撤销旧路由加快路由收敛,但无法避免路由的无效搜索过程.此外,GhostFlushing方案增加了很多BGP通告消息,而且这个方案会恶化故障恢复时的收敛性能.由于BFD方案[14]已经解决了BGP协议的故障检测问题,所以,本文将重点解决问题2、3和4.3稳定路由选择本节将介绍稳定路由选择方案(sBGP).路由稳定选择方案将有效避免由于不稳定路由或者无效路由引起的互联网路由的有效性和稳定性问题.通过这个方案,路由的有效性和稳定性将大幅度提高.首先改进域间路由协议(StableBGP)的基本原则,其次介绍稳定路由选择路由协议的基本算法,最后通过实例分析介绍稳定路由选择的有效性.3.1基本思想和原则域间路由协议的目标是确保互联网路由的有效和稳定性,特别在发生网络故障的情况下的路由有效性和稳定性.由于域间路由本身的设计原则,路由选择的决策并不准确,短暂的网络故障会导致域间路由的很多问题,例如路由收敛过程中漫长的路由搜索过程以及域间路由的不稳定性问题.为了解决这些问题,我们提出一个启发式的BGP路由选择算法,StableBGP(sBGP).有别于目前的BGP协议,sBGP的目标是通过稳定路由选择本地化处理路由故障,尽量使路由变化再小范围内发生.我们在sBGP决策过程中增加了额外的两个路由选择,即选择目前可用路由和选择运行时间最长的路由.表2所示sBGP的路由选择决策过程.表中步骤1和步骤2是sBGP路由的核心过程.选择最佳的路由的第1个步骤是优先选择目前可用的路由避免了不必要的路由重计算过程.由于收到一个新路由通告消息可能是由于旧路由无效的事件触发,所以在路由器通告中增加一个属性来标识路由变化的事件源.第2个步骤选择运行时间最长的路由,确保sBGP选择最稳定的路由以减少由于不稳定路由导致的路由不稳定情况.由于目前的主流路由器,例如Cisco路由器,已经在Adj-RIBs-IN中标识了已选的最佳路由以及记录了每条路由的达到时间,所以sBGP没有增加改进路由选择的实现复杂度.需要注意的是,在sBGP中,路由器缺省将采用初始BGP的路由决策过程,而启发式路由选择仅在路由发生变化时执行.这种启发式的路由决策过程保留了原始BGP路由的所有特征,例如确保基于路由策略的路由优先选择.通过这种方式可以在保证管理员策略配置有效的情况下提供域间路由的有效性.3.2sBGP的路由选择算法与传统的BGP协议不同,sBGP不是仅仅在Page5BGP通告消息标识路由变化的事件源,它提供的启发式的路由决策过程选择最稳定路由.由于sBGP能够准确识别可选的最稳定路由,有效避免了BGP不断地选择无效路由,从而确保了域间路由选择的稳定性和有效性.在sBGP协议的设计中,我们的目标是解决BGP的路径搜索时间长、路由的传播时间长以及路由策略导致的路由不收敛问题①.表2中的步骤1和步骤2分别是实现sBGP稳定路由选择的核心,解决了目前BGP路由的问题.具体来说,路由决策过程中的这两个步骤通过识别路由变化的故障源以及所有不稳定的路由以实现稳定路由选择的决策.sBGP通过识别路由变化的故障源,避免了路由器收到撤销消息后搜索无效的路由,所以避免了漫长的路由搜索时间.sBGP路由器只有在当前路由无效的时候才会进行路由的重新决策,因此sBGP路由器每次声明出来的路由总是当前路由中最稳定的,有效避免了路由的反复声明而引起的路由抑制.类似地,由于sBGP路由器只有当当前路由不可用时进行路由重新决策,而决策过程中仅选择自己可选的最稳定路由,因此sBGP不会出现由于路由策略问题而导致的路由不收敛问题.在sBGP路由决策步骤2中,如果路由的有效时间小于τ,则采用收到的新申明路由.我们通过τ来进行稳定路由选择的判断.具体算法如算法1所示,我们首先选择路由运行时间最长的路由,而且该路由的有效时间超过了τ.如果目前所有路由的有效时间都没有超过τ,则选择收到的新声明的路由,这时所选择的路由也是稳定的路由.这个原则也是BGP的稳定路由的选择策略,因为sBGP有以下的定理.算法1.sBGP路由决策算法.avail(r):returntheavailabletimeofroutercontains(u,v):returniftheroutecontainsthefailedlink输入:Routeriswithdrawnorreplaced,whichis图2sBGP在B-团拓扑中的收敛过程输出:thebestrouter1.//ASdeterminesthecurrentrouterisimpacted2.Ifr.contains(u,v)==FALSEThen3.return;4.Else//ASneedstorecomputedthebestrouters5.chooserinRIB-INwiththelongestavailable6.while(r!=null){7.Ifr.contains(u,v)==FALSEThen8.r=r;9.break;10.Else11.re-chooserinRIB-INwiththesub-longest12.Endif13.}14.If(avail(r)<τ)Then15.//AvailabletimeofallroutesinRIB-Inisless16.IfexistsannouncedrouterThen17.selecttheannouncedrouter;18.Endif19.Endif20.Endif定理1.在sBGP中,由于新申明的路由是邻居路由器采用的最长时间的可用路由,所以当本地无可用稳定路由时选择收到的申明路由也是一种稳定路由的选择策略.在sBGP中当AS收到上层AS所选的稳定路由,则说明这条路由在网络中的稳定时间已经大于τ.所以,当路由发生改变而当本地无可选的稳定路由时(即路由有效时间大于τ),sBGP可以选择上层AS所选择的稳定路由作为自己的稳定路由.这个定理比较简单,详细的证明在本文中省略.3.3sBGP实例分析为了便于与传统的BGP比较和分析,我们同样采用同步网络模型来分析sBGP的性能.如图2所①本文仅关注路由发生变化以后导致的路由不收敛问题.Page6示,AS5和AS0的链路失效,AS0发布给AS1和AS2路由撤销路由通告.由于撤销通告包含了故障链路信息,AS1和AS2会选择一个不受故障影响的路由.但是,由于AS1和AS2中不存在可用路由,所以它们在t=1时刻分别发布带有链路故障信息的路由撤销.t=2时刻,AS3和AS4分别收到来自AS1和AS2的路由撤销.同样,由于AS3和AS4均无可用的稳定路由.到t=3时刻,所有AS删除所有故障路由,达到稳定状态.与传统的BGP相比(如图1所示),sBGP在这个拓扑中缩短了2+t的收敛时间.在发生故障后sBGP采用稳定路由选择策略,可以有效避免由于故障导致的路由不收敛问题.我们采用文献[10]中的拓扑和策略配置实例进行分析和比较.如图3所示,如果AS0和AS4链路发生故障,传统的BGP选择路由会导致各个AS将处在不断在Adj-RIBs-IN中选择路由而导致路由不收敛[10].sBGP很好地解决了这个问题.当链路发生故障以后,t=2时刻AS2和AS3分别收到新的路由通告以后,由于当前路由不受故障影响.AS2和AS3路由不受变化,此时路由收敛.3.4sBGP讨论sBGP在选择稳定路由的过程中提供了路由的可用性.由于所选择的是稳定路由,sBGP极大地减少了路由变化次数,消除了路由收敛过程中的无效路由搜索,提高了路由的稳定性.路由重计算仅在当前所选路由受故障影响的路由器中进行,所以路由故障信息只在有限结点中传播,解决了路由传播时间过长的问题;在Adj-RIBs-IN中不存在两个具有相同稳定性的路由,所以sBGP解决了路由故障发生后的不收敛问题.此外,sBGP可以灵活支持增量部署,解决了BGP改进方案的部署复杂性问题.但是,sBGP可能会引入路径长度延长以及选择非最优路由问题.现有研究表明80%左右的网络故障都是短暂的,一般故障延时都小于180s[3-4].sBGP会在发生这些故障时快速找到有效路径从而有效避免无效路由的搜索以及路由黑洞和回路.然而,当发生网络故障以后,sBGP可能会选择一些ISP中设置低优先级的路由.我们认为从保证全局路由可用性和稳定性的角度来看,sBGP取得了比较好的折中方案.特别当故障发生后出现路由不收敛的时候,sBGP可以选择稳定路由来中止路由不收敛.sBGP中还实现了恢复正常路由选择机制.sBGP在选择稳定路由后启动一个稳定选择计时器.如果路由在计时器超时时间内不发生变化,则计时器超时后路由器将重新启用传统的路由选择算法.如果计时器超时之前路由发生了变化,则计时器重新启动.4性能分析4.1实验环境和设置为了评价sBGP的性能,我们在模拟软件SSFNet①的BGP代码里实现了sBGP.实验中使用了简单网络拓扑和由SSFNet提供的真实互联网拓扑.简单拓扑分别使用了包含15个AS的二叉树拓扑,5个AS的环拓扑,32个AS的B-团拓扑,5个AS的线拓扑,6个AS的团拓扑和16个AS的网格拓扑等几种典型的拓扑.真实的互联网拓扑采用了包含6个AS,29个AS,110个AS以及208个AS的拓扑,其中后面3个拓扑是根据真实互联网中路由信息提出构造[9].在路由模拟中,每个AS都通告各自的前缀信息.由于GhostFlushing方案[13]和ConsistencyAssertions方案[12]无法有效避免无效路径的搜索,所以本文将不对这两类方案进行分析和评价.在不同的拓扑上分别对传统BGP,RCN方案[8,11]以及sBGP进行了模拟,并分析和评价不同方案的收敛时间以及更新消息数量.4.2性能评价首先,为了分析稳定路由的性能我们分别用不同τ取值在32个AS的B-团拓扑和110个AS的真实拓扑进行模拟.由于模拟环境无法准确刻画互联网的故障特性,因而无法准确学习到τ的最优取值.如图4所示,在简单拓扑和真实拓扑中分别只有一个故障的性能受τ的设置影响,但收敛时间①TheSSFnetproject.http://www.ssfnet.org/homepage.Page7的影响仅在1%以内.这是由于发生故障以后,在Adj-RIBs-IN中所有的稳定路由比较多.因此,根据模拟实验可知τ的选取对sBGP收敛性能影响不大.在本文的实验中,我们取τ为45s.图4不同延迟参数τ对BGP收敛性能的影响图5分别对不同的简单拓扑的收敛性和更新消息数量进行分模拟.如图5(a)所示,RCN和sBGP在B-团的拓扑中消除了无效路径搜索,收敛时间分别改进了96%和94%.在网格拓扑中,由于故障链路没有引入无效搜索,RCN获得了和传统BGP同样的性能.但sBGP有效消除了无效的路由计算,因此改进了21%的收敛性能.其它拓扑中不存在无效路由,而且拓扑中不存在很多有效的路由,因此RCN、sBGP以及传统BGP的收敛性能类似.图5(b)为各个拓扑的更新数量,B-团拓扑中,RCN和sBGP都减少了75%和的消息数量.其它拓扑中,3种方案的更新数量类似.图6显示了不同网络规模的性能.在6个AS和29个AS的拓扑中没有很多可选的稳定路由,RCN、sBGP和传统BGP的性能是类似的.但随着网络规模的变大,sBGP的收敛性能改进越多.例如,在110个AS和208个AS的网络拓扑中,sBGP获得了比较好的性能改进.RCN获得了传统BGP类似的性能,这是由于故障的链路并部没有引入大量的无效路由搜索.在110个AS的拓扑中,与RCN和传统BGP相比,sBGP的收敛性能分别改进了77%和79%,更新消息数分别减少了1%和31%.在208个AS的拓扑中,sBGP改进了大约64%的收敛时间以及减少了34%的更新消息数量.由此可以看出,sBGP随着网络规模的增加,性能改进的效果越好.因此,sBGP能够提高现有互联网路由性能应对网络故障并提高收敛性能.5结束语BGP路由慢收敛问题直接影响互联网路由的性能.本文提出了稳定路由选择(sBGP)的算法以改Page8善BGP路由收敛.首先检测了算法路由的有效性.只有当目前所选路由受故障影响,sBGP才会重新选择路由.不同于传统的BGP,sBGP选择可选的最稳定路由作为最佳选择.模型分析和模拟实验结果表明sBGP能够大大缩短BGP路由收敛时间并且有效减少收敛过程中的BGP路由更新消息数量.目前我们已经在自主研发的虚拟路由器中实现了sBGP方案,下一步将在CERNET2中进行大规模部署以研究和分析sBGP在真实互联网中的性能.
