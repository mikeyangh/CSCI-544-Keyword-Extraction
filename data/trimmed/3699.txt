Page1一种缩短下载时间优先的自适应BitTorrent激励协议李治军姜守旭(哈尔滨工业大学计算机科学技术学院哈尔滨150001)摘要BitTorrent激励机制的目标是保证节点上传和下载之间的公平性,但相比公平性而言,实际应用中的节点更优先考虑的是文件下载时间,据此文中提出了一种缩短文件下载时间优先的自适应BitTorrent激励协议AIPS.文中首先基于Markov模型对BitTorrent现有激励机制的效果给出了定量分析,分析了激励机制下的文件传输结构,并用概率分析方法给出了该传输结构下最小化文件下载时间的条件.应用分析结果文中定义了一个以缩短文件下载时间为效用的博弈,在该博弈达到Nash平衡时各节点采用的策略就是激励协议AIPS.模拟实验表明文中提出的AIPS较现有的BitTorrent激励协议能明显提高文件共享系统性能,提高文件下载效率.关键词BitTorrent;激励机制;自适应激励;Nash平衡1引言eMule②中,下载到部分文件的节点就能给其它节点上传,正是由于每个节点都能提供上传服务,所以系统总的服务能力会随着下载节点个数的增加而增加,使系统具有良好的可扩展性[1].这也是P2P在现有的P2P文件共享系统,如BitTorrent①、Page2网络和P2P文件共享系统得到广泛应用的根本原因,德国互联网调研机构ipoque的统计结果表明,2007年互联网总流量中的50%~90%都来自P2P程序,而在这些P2P程序里,BitTorrent占据了P2P流量中的50%~70%,在2008年的统计结果中,BitTorrent仍然占据P2P流量的第一位①.激励机制对提高BitTorrent的性能具有非常重要的作用,如果没有激励机制,BitTorrent中的许多节点就会变成只下载文件而拒绝上传的freeriders(搭便车节点),系统不再是一个P2P系统,而退化为传统的C/S系统,系统的总服务能力会显著降低[2].目前BitTorrent采用的激励机制包括tit-for-tat(以下简称TFT)和optimisticunchoking(以下简称OU)两个策略.在节点选择给哪些节点进行上传时,TFT策略选择提供最大下载带宽的nut(默认nut=4)个节点上传,OU策略随机选取nuo(默认nuo=1)个节点上传.TFT策略可以保证提供上传带宽的节点才能交换到下载带宽,有效地抑制了搭便车行为,而OU策略的目的是试探那些未连接过的节点,找到更适合的带宽交换节点[2].不难看出,TFT激励机制会导致节点贡献的上传带宽接近于其获得的下载带宽,实现了公平性,但相比这个公平性而言,实际系统中的节点更关心文件下载时间:如果能缩短文件下载时间,节点愿意贡献比其下载带宽更多的上传带宽.而现在的BitTorrent激励机制只是根据带宽这一个因素来制定激励策略,无法实现面向缩小文件下载时间的激励机制,据此本文针对BitTorrent设计了一种以最小化文件下载时间为目标的自适应激励协议AIPS(self-AdaptiveIncentiveProtocolsforfileSwarming).AIPS的核心是将文件下载时间作为效用函数,将节点带宽分配作为策略进行相互博弈(传统的BitTorrent激励是一种以公平性为效用,带宽分配为策略的博弈[3]),而在这个博弈达到Nash均衡时各节点采用带宽分配策略就是本文给出的以最小化文件下载时间为目标的自适应激励协议AIPS.本文的主要贡献如下:(1)本文用马尔可夫过程分析了TFT作用下进行文件块相互传输的节点集合具有的数量特征,用fluid模型分析了激励机制作用下的文件共享结构,揭示了文件共享结构对文件交换效率的影响,为BitTorrent激励机制的分析和改进奠定了量化基础.(2)本文提出了以最小化文件下载时间为效用函数的节点博弈模型,分析了该博弈的Nash平衡点,给出了达到Nash平衡时各类节点采取的激励策略,完成了BitTorrent激励机制的改进.(3)本文设计了一种易于实现的自适应激励协议AIPS,并用模拟实验验证了AIPS对文件下载性能的影响,平均能提高文件下载效率20%左右.本文第2节介绍相关工作;第3节对现有BitTorrent激励机制进行理论建模和定量分析;第4节对激励下的BitTorrent文件传输结构进行建模分析,据此定义了以最小化文件下载时间为效用的博弈模型并得出其Nash平衡,最后设计了一个可直接用于BitTorrent的自适应激励协议AIPS;第5节是对AIPS的模拟实验结果;第6节是本文的结论.2相关工作针对文件传输和激励机制进行分析是P2P网络和P2P文件共享的一项重要研究,Qiu等人[3]用fluid模型对BitTorrent的文件传输性能进行了详细的理论分析,针对激励机制,文献[3]得出的结论是节点在带宽分配博弈中存在Nash平衡点:具有相同上传带宽的节点会形成一个组相互传输,但文献[3]并没有定量分析激励机制对文件传输性能的具体影响.其它针对BitTorrent的研究也都没有给出激励机制对文件共享性能影响的定量分析结果,如Clevenot等人[4]使用fluid模型对P2PWeb缓存系统的性能进行了理论分析,Clevenot等人[5]使用多阶fluid模型对异构P2P文件共享系统进行建模分析,但给出的分析结果都没有考虑激励机制.Liao等人[6]给出了激励机制下BitTorrent系统的分析,但该文得到的结果不够精确,如该文仍然没有量化地描述系统平稳时的状态,另外在文献[6]的分析中假设高、低带宽节点之间的比例为定值,由于不同带宽节点在系统中的停留时间不一样,所以这个比例应该不断变化,导致文献[6]仍然没有精确描述P2P文件共享的结构.Legout等人[7]就激励机制对BitTorrent的影响给出详细的实验分析,由于只有实验结果,无法实现对BitTorrent激励机制的深入改进.本文定量地分析了激励机制对P2P文件①Ipoque.http://www.ipoque.com/resources/internet-studies/internet-study-2007,2009Page3共享结构及其性能的具体影响,并以此为基础给出以提高文件共享性能为目标的BitTorrent激励机制.通过改进激励机制来提高BitTorrent性能也是一类重要研究,Zhao等人[8]给出了一个一般性的框架来分析具有自适应能力的激励协议,但文献[8]的分析针对了系统鲁棒性,而本文的目标是提高文件共享性能.Huang等人[9]给出了一种称为动态配额分配的上传节点选择策略,其基本思想是动态调整节点上传带宽分配中TFT和OU所占的配额(BitTorrent中这个配额固定为41),用来解决该文中提出的供应和需求之间的paradox问题.虽然本文对激励机制的改进采用了相似的思想,但本文的研究以严格的理论分析为基础,并以文件共享性能优化为目标,而不是解决供求paradox问题.Fan等人[10]也给出通过控制TFT和OU之间的配额来实现文件平均下载时间和系统公平性之间的折中,但该研究假设文件下载时间和系统公平性之间相互独立,而实际系统中差的公平性会导致大量搭便车节点,降低共享效率(文献[10]没有考虑这种情况),所以合适的激励协议应该以保证公平为基础,同时能将单纯的公平性扩展为对系统性能的提高,这正是本文的主要工作.3激励机制下的BitTorrent文件传输模型3.1BitTorrent激励定义1.集合D(p,t)为t时刻向节点p提供下载的节点集合;集合U(p,t)为t时刻从节点p处下载数据(即节点p提供上传)的节点集合.节点p从D(p,t)中的节点下载数据,给U(p,t)中的节点上传数据,如图1所示.由于D(p,t)决定了节点p收到的下载速率,所以D(p,t)直接决定p的文件下载时间,这就需要分析D(p,t)的变化.根据BitTorrent的激励策略TFT和OU,p从D(p,t)中选择nut个提供下载带宽最大的节点、随机选择nuo个节点形成U(p,t+1)(记|U(p,t)|=m,BitTorrent中nut=4,nuo=1,m=5).而U(p,t+1)中的节点在时刻t+1会根据同样的策略调整时刻t+2给节点p的上传带宽,也就是会影响D(p,t+2),所以就有D(p,t)影响U(p,t+1),而U(p,t+1)又影响D(p,t+2),等等,该依赖关系表示为图2.图1节点p的下载节点集合D(p,t)和上传节点集合U(p,t)类似于很多相关研究[6-10],本文根据上传带宽将节点分为两类:高上传带宽节点集Ph和低上传带宽节点集Pl,对应上传带宽uh和ul,本文记Nh=|Ph|,Nl=|Pl|,N=Nh+Nl.由于激励策略表现为nut和nuo之间的比值[8-10],所以为了建模分析的方便,本文假定nuo等于1,nut=m-1,由于此时m2,所以该假设会导致nut:nuo1,表示激励占据更大的比重,这对于无中心控制的开放P2P系统而言是合理的.此时节点在执行OU时,找到nuo=1个高(低)上传带宽节点的概率为α=Nh/N(1-α=Nl/N).3.2高带宽节点的上传节点集定义2.定义Up(nh,nl,t)为节点p在t时刻的上传状态,其中nh和nl分别表示U(h,t)中高上传带宽节点个数和低上传带宽节点个数.由BitTorrent激励策略可知,节点p选择哪些节点上传文件只与p前一时刻的下载节点集D(p,t)有关,因此以状态集合Up(nh,nl|nh+nl=m)(即{Up(0,m),Up(1,m-1),…,Up(m,0)})形成马尔可夫链,本文将该链记为{Up(t):t=0,1,2,…},其概率转移矩阵记为犘u(p).定理1.对于高带宽节点h,其概率转移矩阵犘u(h)为(0,m)(1,m-1)…(m-1,1)(m,0)(0,m)(1,m-1)(2,m-2)(m-1,1)(m,0)…证明.以犘u(h)[(2,m-2),(2,m-2)]为例,即当t时刻节点h的上传节点集U(h,t)中高、低上传带宽节点的个数分别为2与m-2时,U(h,t+2)Page4中高、低上传带宽节点个数仍为2与m-2的概率.事件“U(h,t+2)中高、低上传带宽节点个数分别为2与m-2”按全概率公式可分为两种情况:(1)节点h从D(h,t+1)中根据TFT协议选择2个高上传带宽节点和m-3个低上传带宽节点(该事件用T2表示),再用OU协议随机选择到1个低上传带宽节点(该事件用O0表示);(2)节点h从D(h,t+1)中根据TFT协议选择1个高上传带宽节点和m-2个低上传带宽节点(该事件用T1表示),再用OU协议随机选择1个高上传带宽节点(该事件用O1表示).由于TFT和OU进行独立选择,所以犘u(h)[(2,m-2),(2,m-2)]=因为U(h,t)中高、低上传带宽节点个数分别为2与m-2,根据TFT协议U(h,t)中的节点都会选择向高带宽节点(节点h是高带宽节点)上传,U(h,t)D(h,t+1),所以D(h,t+1)中至少有2个高上传带宽节点.用事件D2和D3+分别表示D(h,t+1)中有2个高上传带宽节点的事件和有不少于3个高上传带宽节点的事件.出现D3+是因为有高上传带宽节点OU到了节点h.事件D2的概率为Nh个高上传带宽节点都没有OU到节点h的概率,由于节点之间相互独立且节点h被另一节点hOU到的概率为1/N,所以Pr(D2)=(1-1/N)Nh=1-α+o(α)≈1-α;又由于D(p,t+1)只能出现上述这两种情况,所以Pr(D3+=α).根据TFT协议,Pr(T2|D3+)=0,同理可知Pr(T2|D2)=1.因此Pr(T2)=Pr(T2|D3+)×Pr(D3+)+当m-12时,由于D(h,t+1)中的高上传带宽节点个数至少为2,根据TFT协议有Pr(T1)=0.因此,当m4时犘u(h)[(2,m-2),(2,m-2)]=(1-α)×(1-α)+0×α=(1-α)2.当m=2时,节点h用TFT协议从D(h,t+1)中选出1个节点,U(h,t)D(h,t+1)导致该节点一定是高上传带宽节点,所以Pr(T2)=0,Pr(T1)=1,所以犘u(h)[(2,m-2),(2,m-2)]=α.当m=3时,节点h会用TFT协议从D(h,t+1)中选出2个节点,U(h,t)D(h,t+1)导致这2个节点一定都是高上传带宽的节点,Pr(T2)=1,Pr(T1)=0,有犘u(h)[(2,m-2),(2,m-2)]=1-α.由于概率转移矩阵与m有关,因此可用犘u,m(h)来表示不同m取值下的概率转移矩阵,有犘u,3(h)=找到这些矩阵的共同规律即得出式(1).证毕.对于BitTorrent,{Uh(t):t=0,1,2,…}上的状态转移,如图3所示.图3BitTorrent中{Uh(t):t=0,1,2,…}上的状态转移3.3高带宽节点犝犺(狋):狋=0,1,2,…的极限分布定理2.令犘u(h)=limn→犘n(0,m)(1,m-1)…(m-1,1)(m,0)(0,m)(1,m-1)…(m-1,1)(m,0)证明.令犘kUh(l)=i),犘u(h)[ij]=limk→犘k时刻0从状态i出发在时刻k首次到达状态j的概率.以m=5(即BitTorrent)为例来分析,为了描述的方便,将状态Uh(0,5),Uh(1,4),Uh(2,3),Uh(3,2)记为0,1,2,3,将状态Uh(4,1),Uh(5,0)记为4,5,将犘k状态0,1,2,3为非常返态,状态4,5为常返态,因此犘ij=0|i∈{0,1,2,3,4,5};j∈{0,1,2,3}.接下来需要计算犘ij|i∈{0,1,2,3,4,5};j∈{4,5}.44=∑5犘22(1-α)α+(1-α)×(1-α)+(1-α)×α=1-α,同样的方法得出,犘2学归纳法假设犘k44=∑5据犘k+11-α.同样归纳出犘现在求犘limk→∑Kt=1Page5t=1limk→∑Kft44+limk→∑k犘44=∑犘t=1显然,∑t=1这一事件记为A)的概率,定义B1为从状态1出发且在到达状态5之前先到达状态4的事件;而B2为从状态1出发且在到达状态4之前先到达状态5事件.由状态迁移图3可知,从状态1出发最终必定到达状态{4,5},所以Pr(B1∪B2)=1,而显然有B1和B2不可能同时发生,即Pr(B1∩B2)=0.因此可用全概率公式得出∑Pr(A|B2)Pr(B2),而其中Pr(A|B1)=1;Pr(A|B2)=∑54=(1-α)+(1-α)α+(1-α)α2+…=ft(1-α)/(1-α)=1.因此就有∑Pr(B2)=1,也就有犘以求出犘对于其它m取值,由于满足犘2(m-1)(m-1)=∑m犘(m-1)x×犘x(m-1)=0+0+…+0+(1-α)×x=0(1-α)+(1-α)×α=1-α,其中的0项是由于犘(m-1)x=0或犘x(m-1)=0,所以求出的犘u,m(h)[ij]和m=5时有类似的结果,即式(2).证毕.3.4高上传带宽节点的聚簇定理3.高上传带宽节点h其{Uh(t):t=0,1,2,…}的极限分布πu(h)=(0,…,1-α,α),并且与初始分布无关.证明.设高上传带宽节点h的初始上传状态的分布为ω,则其极限分布:定理3的结果表明,随着TFT和OU对上传节点的逐步选择,具有高上传带宽的节点最终将选择给同样具有高上传带宽的节点进行数据上传.定量地说,一个高上传带宽节点平均会将其(1-α)×(m-1)/m+α×m/m=(m-1+α)/m的上传带宽分配给其它高带宽节点.3.5节点聚簇后的宏观带宽分配特征由于BitTorrent文件共享系统中的总上传带宽等于总下载带宽,在这样的平衡条件下,可以分析出节点聚簇以后高带宽节点集合Ph和低带宽节点集合Pl上带宽分配的宏观特征,该特征如图4所示,其中的Uhl表示Ph提供给Pl的总上传带宽.根据定理3聚簇以后的高带宽节点会以(1-α)的概率将其带宽的1/m分配给Pl节点,以α的概率不分配带宽给Pl中的节点,所以图4高、低上传带宽节点簇在文件共享系统中的传输结构现通过对D(h)的分析来求Ull和Ulh:由于节点h是高上传带宽节点,所以U(h)中的节点给h提供下载带宽(TFT的结果),所以D(h)中将至少有m个节点形成{n1,n2,…,nm-1,nm},其中{n1,n2,…,nm-1}是高带宽节点(这是定理3的结果).系统中其它N-1-m(节点h和n1,n2,…,nm-1,nm除外)个节点也可能给节点h上传,因为这些节点OU到节点h,而任一节点OU到节点h的概率为1/N.对于节点nm,该节点是低上传带宽节点的概率为1-α,所以该节点对Ulh的贡献的期望为(1-α)ul/m.对于剩下的节点ni|i=m+1,…,N-1,这些节点是低带宽节点的概率为1-α,都以1/N的概率给节点h提供上传,这些节点对Ulh的贡献为∑i=m+1,…,N-1ul/m=(1-α)(N-m-1)/N×ul/m≈(1-α)ul/m(假定mN),所以分析结果表明Ph和Pl之间的数据传输相比集合内部的传输要少很多,且这种聚类会随着m的增大而加剧.式(4)~式(7)定量地说明了激励协议对BitTorrent文件传输的影响,而这些数量结果正是Page6本文的研究基础.3.6激励机制下的文件传输结构对于fileswarming系统而言,影响文件传输性能的关键是下载同一文件的节点集合(记为ΨF)内各节点间文件块交换的效率.由于节点会动态加入,会在下载完成后离开,所以ΨF是一个随时间变化的动态系统,记ΨF(t)为t时刻的ΨF.在BitTorrent激励机制下,ΨF(t)根据节点上传带宽形成若干个紧密连续的部分:高(低)上传带宽节点更多的是和高(低)上传带宽节点进行传输.不失一般性,此处仍假定ΨF(t)中包含高上传带宽节点和低上传带宽节点两类,并令t时刻ΨF(t)中高上传带宽节点的个数为h(t),低上传带宽节点的个数为l(t).由于一个新的下载者会以参数为λ的泊松过程进入ΨF(t).所以h(t)(l(t))会以参数(h(t)+l(t))h(t)l(t())=-μhηh-μhηl/m0-(m-1)μhηh/m-μlηl/mλhλh4缩短下载时间优先的BitTorrent激励协议4.1BitTorrent文件下载时间定义3.对于任意节点p∈ΨF,p的文件下载时间tF(p)就是指通过ΨF中节点间的文件块交换使节点p下载完成F={c1,c2,…,ck}的时间.定义4.从P2P文件共享系统角度,文件传输性能体现为平均文件下载时间TF:节点p以参数为λ的泊松过程在t1时刻进入系统,会在t2时刻下载完文件F后马上离开ΨF,显然tF(p)=t2-t1,TF是系统平稳后节点在系统ΨF(t)中停留的平均时间.4.2BitTorrent激励对文件下载时间的影响在激励机制下,ΨF(t)会根据其带宽而汇聚成多个节点类,而节点类内部的文件块交换就成为BitTorrent文件块交换的绝对主体.由于交换对方没有的文件块是文件块交换的前提,而交换节点集合的规模又会随着节点聚簇而缩小,所以节点找到提供感兴趣文件块的节点的机会就会减少,导致有些下载周期会因找不到有效下载节点而浪费,使文为λh(λl)的泊松过程变成h(t)+1(l(t)+1),其中λh+λl=λ.本文假定节点在下载完F后马上离开系统,且不在下载中途离开,seed节点只对文件交换初始化起作用,并令高、低上传带宽节点的下载带宽分别为ch和cl,高、低上传带宽节点的文件共享效率为ηh和ηl,借助文献[3-4,11]采用的fluid模型,可以构造:dh(t)/dt=λh-min(chh(t),ηhUhh+ηlUlh),dl(t)/dt=λl-min(cll(t),ηlUll+ηhUhl),其中Uij|{i,j}∈{h,l}就是式(4)~(7)给出的结果,只是其中的Nh和Nl在这里相应地变成h(t)和l(t),而α=h(t)/(h(t)+l(t)).对于通常的网络,上传带宽是网络的瓶颈,如ADSL的上行带宽就和下行带宽不对称,且大多数P2P系统和研究都做同样假定[3-4,11-12],所以有chh(t)ηhUhh+ηlUlh.此时有件下载时间增长.首先需对这一影响进行定量分析,其定量特征就体现为式(8)中的η,就是概率值:Pr{节点p能向其连接节点提供感兴趣文件块}=1-∏q∈N(p)Pr(C(p)C(q))=1-Pr(C(p)C(q))|N(p)|,其中N(p)是节点p连向的邻居节点,C(p)是节点p已经下载获得的文件块集合,上式的推导中假定各节点的文件下载是独立的.文献[3]得出η值接近1,表明在BitTorrent中的rarestfirst块选择策略下,文件交换效率很高,但在文献[3]的分析中假定所有文件块都能交换的事实,当出现节点聚簇时,文件块集合也会聚簇,导致一个节点类集合内并不一定总能交换所有的文件块,更可能的情况是当一个节点簇中的文件块交换完成时,其它簇向该簇引入的文件块数量可能不满足簇内带宽的消费,此时就会出现下载带宽浪费.对于由高、低两类带宽组成的共享系统中,由于高带宽节点簇能很快将簇中的文件块交换完,所以高带宽节点集合会出现上述饥饿现象.为保证文件块交换的效率,要求低带宽节点集合向高带宽节点集合引入的“新文件块”数量大于高带宽节点集合的总下载能力,即Page7Y×S×|Ph|S/ul×uh×|Ph|Yuh/ul其中,Y是低带宽给高带宽节点引入的新文件块数量;S是每个文件块的大小;Y×S×|Ph|表示低带宽节点集合向高带宽节点集合引入的可供传输的新数据量;S/ul是Y个文件块由低带宽节点并行上传给高带宽节点的时间,乘以uh和|Ph|是这段时间高带宽节点集合所能下载的总数据量,也就是下载能力.式(10)中的Y与高、低带宽节点集合之间的连接数量、节点集合已经下载的文件块数量、文件块在节点上的分布等因素有关.令C(p)表示节点p已经下载到的文件块集合,高、低带宽节点集合之间的连接一个割L[Ph,Pl].通过割L中的边将C(Pl)中的不在C(P)中的新块加入C(P)中,这个新块数量是一个随机变量,本文将分析其期望(即Y).图5给出L、“新块”、C(P)、C(Pc)、c(p)等对象之间的关系(其中的P就是Ph).图5C(P),C(Pc),割L等集合之间的关系对于割L中的连接l=(p,p),定义随机变量Xl为为完成L共引入新块个数的计算,不失一般性假定l引入新块的过程是有序的,规定这个连接顺序为1,2,…,l,….再将上面的Xl=1修改为在1,2,…,l-1完成加入后,l又引入一个“新块”.定义Yl-1=X1+X2+…+Xl-1后有Pr(Xl=1|Yl-1=0)(|C(p)-C(P)|)/(|C(p)-C(p)|),相应就有Pr(Xl=1|Yl-1=i)(|C(p)-C(P)|-i|C(p)|/|C(PcL)|)/(|C(p)-C(p)|).其中|C(p)|/|C(PcL)|表示已经被连接1,2,…,l-1引入到C(P)的新块再落入C(p)中的概率,这是由于(文献[3]表明采用了)rarestfirst块选择策略后,每个节点下载到的文件块可认为是F上的均匀分布,即任一块等概率的出现在C(p)∪C(p)中(均匀分布的并仍然是均匀分布),所以每个块将等概率地属于C(PcL).而被连接1,2,…,l-1引入的某块b落入C(p)中的概率就是Pr(b∈C(p)|b∈C(Pc=Pr(b∈C(p)∩C(Pc=Pr(b∈C(p))/Pr(b∈C(Pc=|C(p)|/|C(Pc据此可以求出Yl的数学期望(详细推导见附录I):E[Yl]c1(1-(1-c2)l)/c2,c1=E[(|C(p)-C(P)|)/(|C(p)-C(p)|)]c2=E[|C(p)|/(|C(Pc因此在满足下面条件时,高、低带宽节点聚簇不会对文件下载时间产生大的影响.由于只有高带宽节点交换完簇内文件块以后才需要从低带宽节点引入新文件块(此时C(p)=C(P)),代入后有c1=1,此时式(12)的左边随c2单调递减:(1)当c2=o(1/|L|)时,条件(12)变为c2=o(1/|L|)意味着|C(P)|较小,割L对应的低带宽节点下载到的文件块集合不相交,OU和rarestfirst机制下此时的|L|应该很小,在系统中的节点规模较大时,该条件发生的可能性很低.(2)当c2是一个属于(1/|L|,uh/ul)的常数时,条件(12)变为(3)而当c2uh/ul时,条件(12)不满足,此时高带宽节点内部没有可供交换的文件块,尽量和低带宽节点相连.4.3以文件下载时间为效用的博弈BitTorrent的文件下载是一个典型的博弈过程:不同种类的节点通过不断调整其带宽分配策略来达到收益的最大化,虽然一些相关工作也定义和分析了这个博弈[3],但文献[3]的博弈效用定义为节点付出带宽与接收带宽的差值(即公平性),相比这一公平性,在实际的BitTorrent文件共享中,用户更关心的节点收益应该是文件下载时间,因此本文将分析以文件下载时间为效用、以上传节点选择为策略的文件块交换博弈.定理4.在节点理性假设下,P2P文件交换系统中的高带宽节点h采用如下上传节点选择策略时节点h达到Nash平衡:(1)当|C(h)|<YP时,h选取上传节点时m值Page8应满足ρλ/((1-1/m)(uh-ul))(2)当|C(h)|>YP时,h全选择低带宽节点进行上传.其中YP是一个临界值YP=k-β,k是文件F={c1,c2,…,ck}的块数,β=uh/ul.证明.根据式(12)和(14),c2=1/β就是临界条件.在rarestfirst机制下可以认为|C(p)|/|C(PcL)|≈1/2,而对于文件块ci,Pr(ci∈C(p))×Pr(ciC(p))=(k-|C(p)|)/2k,根据数学期望的加和特性,|C(p)-C(p)|的均值为(k-|C(p)|)/2.联立以后就有临界条件C(h)=k-β.此时c2≈1/(k-|C(h)|),将该值代入式(15)有|L|log1-1/(k-|C(h)|)1-β/(k-|C(h)|).现分析|L|,应该有|L|=Ulh/(ul/m),但不能用式(6)的Ulh代入计算,这是由于在以文件下载时间为效用的博弈下,低带宽节点会采取不同于以往的节点选择策略.在以下载时间为效用的博弈中,高带宽节点之所以unchoking低带宽节点原因是内部已无文件可传,而不是由于低带宽节点OU到了高带宽节点,因此在该博弈的Nash平衡时低带宽选择的策略只OU低带宽节点,只有在高带宽节点OU到低带宽节点时才TFT到高带宽节点.根据低带宽节点在博弈中选择的策略,式(6)变成Ulh=(1-α)ulNh/m,将其代入后可得条件h(t)(1-α)log1-1/(k-|C(h)|)1-β/(k-|C(h)|).再综合式(8)的结果,在系统稳定时就有条件(15)(详细证明见附录II).当1/(k-|C(h)|)很小时,(1-1/(k-|C(h)|))β≈1-β/(k-|C(h)|),此时log1-1/(k-|C(h)|)1-β/(k-|C(h)|)≈β,1/(k-|C(h)|)很小是由于k通常很大,如1000(文件块大小通常为256KB,一个数百MB的文件有1000块左右).此时式(15)可以近似为应用式(20),h(t)=mρλ/((m-1)uh),l(t)=((m-1-mρ)λ)/((m-1)ul)和N=h(t)+l(t),式(16)变为Nm(β-1)(1+β/ρ-β)m-β(β-1)/ρ(17)表1给出了两类典型场景下m的取值(其中ρ设为0.2).从表1的数值可以看出:(1)对于一定的β,如果N足够大(大于表1中给出的“N的临界值”),m可以任意取值,这是由于此时很大的N使得h(t)也大到无需从l(t)那里获得新数据块来维持下载效率;(2)随着β的增大,对N的要求迅速增大(随O(β2)增大),实际上当β很大时,如β100时,OU的比率必需很大,否则会导致高带宽节点无文件可传,而OU比率很大时高节点处的公平性会很差,但在实际文件系统中还是应该选择加大OU比率,因为可以缩短下载时间,这也是本文工作的出发点;(3)在β适中时,如10β30时(是有线P2P网络中的典型情况),适当控制swarm的规模和适当控制m的大小都能显著提高文件下载效率,文献[13]的工作从侧面反映了这一结果的正确性,另一个有趣的现象是β和N适中时,此处的m和5(这是实际BitTorrent协议中采用的数值)相差不大,在β=10,N=280时算出的m正好是5.βN(节点规模)N的临界值m取值58010300369m6.51001000039699m1.67100定理5.在节点理性的假设下,对于P2P文件交换系统中的低带宽节点l而言,当l采取的上传节点选择策略为:节点l只选择低带宽节点进行OU,并采用和TFT一样的choking策略时,节点l将在本文提出的BitTorrent文件交换博弈模型下达到Nash平衡.证明.在定理4的证明中已给出,此处略去.4.4缩短下载时间优先的激励协议综合上面给出的理论分析结果,本文针对BitTorrent设计了一个缩短下载时间优先的自适应激励协议AIPS(self-AdaptiveIncentiveProtocolsforfileSwarming),如图6所示,其核心是高带宽节图6缩短下载时间优先激励协议AIPS的会话图Page9点要根据|C(p)|、k-β的关系和式(17)对应的等式来决定上传连接中OU的数量,低带宽节点只向低带宽节点发起OU,两类节点的TFT原则和现在的BitTorrent一样.5实验验证及结果分析5.1模拟实验平台及参数本文采用NetLogo模拟工具对PLXU进行实验验证.NetLogo是一个基于多Agent的AI群落模拟工具①,由于Agent对象间的通信轻便,特别合适于模拟大规模系统在应用层上的性能表现,TFT和OU机制对BitTorrent文件交换性能的影响都是典型的应用层表现.用NetLogo中的一个Agent来模拟BitTorrent中的一个leecher,并给每个进入系统的节点初始化随机分配若干文件块.实验中假定低带宽类节点的带宽为256kbps,假定文件块数为1000,文件块大小为256kb.模拟时将时间分为周期,每个模拟周期所有节点执行一遍TFT算法,每隔一定数量的模拟周期后(实验中设为3)所有节点执行一遍OU算法.实验中用到的符号如表2所示.符号Nβ高低带宽节点的带宽之比ρ进入系统中高带宽节点所占的比率0.2m上传节点选择中TFT和OU之比(m-11)55.2实验结果与分析5.2.1节点按带宽聚类的效果当节点按带宽聚类时,和节点交互节点的带宽(表现为节点收到的带宽)会接近节点自身的带宽,所以图7用节点获得带宽和自身带宽之间的差说明节点聚类特性,由于这个插值随时间下降且停到一个较小的数值上,说明BitTorrent激励机制下的节点会出现聚类现象.另一方面,该差值并不收敛到0,这是由于高、低带宽节点之间发生的少量数据传输造成的,高带宽节点上述差值的理论计算结果为|Uhh+Ulh-Nhuh|/Nh=(1-α)(β-2)ul/m;对低带宽节点该理论值为|Ull+Uhl-Nlul|/Nl=α(β-2)ul/m.图7的实验参数设定为β=10,α=0.2,m=5,ul=256,可算出|Uhh+Ulh-Nhuh|/Nh=327.68,|Ull+Uhl-Nlul|/Nl=81.92(图7中的两条横线),侧面验证了本文给出的理论分析结果,另外图7的结果说明低带宽节点收敛结果平稳,N越大收敛结果越平稳,这是随机过程的必然结果.图7节点在BitTorrent文件传输中按带宽聚类的现象5.2.2AIPS对高带宽节点文件下载时间的影响AIPS和BitTorrent激励机制的本质区别在于BitTorrent中的TFT和OU所占的配额是固定的,而AIPS是自适应变化的,是随着环境(如网络规模,高低带宽节点所占比例等)的变化而自适应地发生变化.所以分析AIPS对下载效率的影响集中在下载效率与m关系上.表3给出了几类典型环境(不同的β,N,ρ)下BitTorrent和AIPS对高带宽节点文件下载时间的对比,由于AIPS的核心思想是用带宽换取文件块,所以AIPS对高带宽节点下载的效率提高是显著的.结果表明在这个环境下,AIPS对高带宽节点文件下载效率的提高接近20%.环境参数设置高带宽节点平均下载时间/sβ=10,N=300,ρ=0.21988159719.6β=10,N=300,ρ=0.12233184417.4β=10,N=400,ρ=0.12184179118β=20,N=300,ρ=0.21565123621β=20,N=1000,ρ=0.21559125719.4①WilenskyU.Netlogo.http://ccl.northwestern.edu/netlogoPage10图8给出了β=10,N=300,ρ=0.2和β=20,N=1000,ρ=0.2两类环境中文件下载时间(time)随m的变化关系.式(17)的计算结果表明在下载时间优先的激励机制下两类条件下m的取值分别为6.5和3.5.图8的实验结果表明当m小于理论计算阈值(式(17)的计算结果)时,会使过多的高带宽上传连接被unchoking到低带宽节点那里,当然同时也从低带宽节点获得了大量的新文件块,因此此时高带宽节点的下载时间会因为用过多的高上传带宽换取了低下载带宽而增加,当然低带宽节点的文件下载时间会减小,此时由于高低带宽节点之间的文件块交换频繁,不会由于文件块缺乏而导致带宽浪费,系统平均下载时间会减小.另一方面,当m大于计算阈值时,尤其是m很大时,高带宽节点从低带宽节点那里换取的新文件块不足以支持满负荷下载,所以文件的下载时间要增加,而低带宽节点由于很少能从高带宽节点那里获取高下载带宽,其文件下载时间也要增加,当然平均文件下载时间也增加.因此合适的m取值对系统中各类节点文件下载效率的提高与折中具有重要影响.5.2.3非诚实环境下AIPS的效果分析如果是在诚实环境下,单从系统平均文件下载时间出发,应该是让m越小越好,此时文件块可在系统中的所有节点之间频繁交换,因没有文件块交换而导致下载效率降低的可能性很低.但另一方面,很小的m导致大量的OU,而OU正是导致freeriders的根本原因[2,14],所以在存在大量搭便车节点的非诚实环境下,m值的选取又是越大越好,而AIPS激励协议是折中上述两种情况的结果,从缩短文件下载时间角度,要求m满足定理4;从公平性角度(抵抗搭便车行为),要求m尽量大,所以本文的AIPS就采用满足定理4的那个临界值,虽然文献[9-10]也讨论了OU和TFT配额对共享效率的影响,但都没有在非诚实环境下面向系统效率针对这一配额给出定量结果.图9给出了搭便车环境下AIPS和其它配额调整(包括了文献[9-10]的调整方法)对系统效率影响,选择β=10,N=300,ρ=0.2;β=20,N=1000,ρ=0.2两类参数进行实验,并假定其中随机选取20%节点作为搭便车节点.结果表明存在搭便车节点时AIPS能显著缩短平均下载时间.图9搭便车环境下不同m取值对文件下载时间的影响6结束语由于上传节点的选择会直接导致节点接收到的下载带宽,所以选择哪些节点进行上传将直接影响Page11BitTorrent中的节点下载时间以及文件共享系统的效率.BitTorrent系统中的节点采用TFT协议,用大的上传带宽去换取大的下载带宽,提高公平性,但从节点的QualityofExperience角度出发,用“大的上传带宽换取到大的下载带宽”目标是为了提高文件下载效率,此时必需满足条件:从换取到下载带宽的节点那里得到想要的文件块.因此相比上述抽象的公平性而言,实际使用中更加合理的选择策略是用带宽去换取有用的数据块下载.为了完成这一问题的形式化定义与求解,本文扩展了传统的以公平性为效用的BitTorrent节点选择博弈模型,提出了以缩短文件下载时间为效用的博弈模型,综合地刻画出了带宽换带宽以及带宽换文件块的更符合实际环境的节点间博弈结构.综合随机过程与博弈论等数学手段得出节点在以其缩短文件下载时间优先的博弈中应该采取的策略:(1)高带宽节点h在满足k-|C(h)|<β条件时,选择满足条件Nm(β-1)(1+β/ρ-β)m-β(β-1)/ρ的参数m来用其高带宽换取一定量的高带宽及一定量的新文件块;在满足条件k-|C(h)|>β时,选择完全用其高带宽来换取有用文件块.(2)低带宽节点总采取用其文件块换取高带宽的策略.其中的N,ρ,β都是能从实际系统中测量出来的参数.最后的模拟实验结果可反映出本文给出的理论结果及相应策略的正确性和有效性.
