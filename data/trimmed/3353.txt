Page1CFD非结构化网格格心格式数据高质量体绘制方法马千里1)李思昆1)白晓征2)程志全1)徐华勋1)1)(国防科学技术大学计算机学院长沙410073)2)(国防科学技术大学航天与材料工程学院长沙410073)摘要3D非结构化网格格心格式数据是近年流场数值模拟结果的常见形式,目前的可视化方法无法直接绘制此类数据,通常采用外推技术将其转换为格点格式数据后再进行绘制,导致数据精度损失,严重影响绘制质量.在多遍光线投射算法框架下,设计一种非结构化网格格心格式数据直接采样计算方法(避免外推),使采样过程中的所有计算任务基于原始数据完成,以提高采样计算精度.具体为:设计了基于胞心值和单元梯度的采样点流场数据重构方法;采用基于面通量的格林公式计算单元梯度;考虑流场中物理量的相互关联,首次在流场可视化中引入Roe平均方法,用相邻单元胞心值构造面通量.分析和实验表明,该方法能明显提高采样计算精度,产生高质量的体绘制图像,使用户更准确地洞察和分析流场特性.关键词计算流体力学;非结构化网格;格心格式数据;流场可视化;体绘制1引言随着数值模拟精度的日益攀升,CFD领域常用非结构化网格(尤其是四面体网格)划分空间,并以此为基础完成数值计算.形式上相同的网格布局,当采用不同的数值计算方法时,网格和节点具有不同的含义和作用[1].有限元法(FEM)常将物理量(流场数据)存储在真实的网格顶点上,将单元看作由周边节点及形函数构成的统一体,计算产生格点格式数据(后称格点数据,如图1(a));有限体积法(FVM)往往将物理量存储在网格单元中心,将单元看作是围绕中心的控制体,计算产生格心格式数据(后称格心数据,如图1(b)).FVM具有明确的物理含义[1-3],它保证了物理量在任意控制体内都满足积分守恒,且计算效率高,近年来发展十分迅速,在CFD中广泛应用.然而,目前的可视化方法(包括体绘制、等值面提取和流线跟踪等)均以插值为基础获得绘制数据,而格点数据是实现插值计算的前提条件[4-11].以体绘制为例,在采样过程中,目前方法或是由单元各顶点数据,经“全线性插值”重构该单元采样点处的流场值[12-13];或是先基于单元各顶点数据估计单元梯度(流场在单元内的变化趋势),再经该单元任意顶点数据和单元梯度重构采样点处流场值[4-5].因此只能直接绘制格点数据.而对于格心数据,目前的做法是:采用外推技术将格心数据转换为格点数据后再进行绘制[8-9,14].但就格心数据而言,绘制过程中的所有计算任务均建立在外推后的格点数据基础上,这种“间接”绘制不可避免地造成数据精度损失,导致计算误差.此外,外推技术本质上是某种平均计算(如算术平均、距离加权平均),而格点数据是共用该点的点相邻单元格心数据的平均值.因此,外推后的格点数据值域是原始格心数据的真子集,这导致部分数据信息丢失,并引发流场中某些特征区域范围的变化.同时,这种“平均”计算抹平了数值解中的间断和尖峰,使外推后的数值耗散增大(如图2),偏离真实流场值[1-2,15-16].上述问题迫使可视化结果不能如实反映真实数值计算结果,严重影响了绘制精度.由此可见,对于CFD非结构化网格格心数据,目前的可视化方法尚未满足绘制需求.本文以光线投射算法为框架,设计一种非结构化网格格心数据高质量体绘制方法,直接基于原始格心数据完成采样过程中的所有计算任务(避免外推计算),使可视化结果能如实反映数值计算结果.主要贡献有:(1)设计了直接基于格心数据和单元梯度完成采样点数据重构的计算方法,这种直接重构思想不局限于体绘制,对于等值面提取和流线跟踪等其它可视化方法也同样适用,有效提高绘制精度;(2)采用基于面通量的格林公式,由格心数据直接计算单元梯度,该方法不仅与FVM守恒性思想相一致,而且计算精度高,灵活性和适应性好;(3)为精确构造面通量,考虑流场中各物理量间的关联关系,首次在流场可视化中引入Roe平均方法,由面相邻单元格心数据的Roe均值构造面通量.误差分析和实验结果表明,与目前的间接绘制方法相比,本文方法明显提高了重构精度,绘制结果与原始数值计算结果更为一致,使科学计算人员更准确地洞察和分析流场特性.2算法设计光线投射算法是目前绘制精度最高的体绘制方法,在流场可视化中广泛应用[6-7,9-11].3D非结构化网格数据拓扑结构复杂,需要使用多遍(multi-pass)光线投射算法完成绘制[4-5,11-13].本文以此为框架,设计基于格心数据(简称胞心值)的直接采样点数据重构方法,实现高质量体绘制.对视点方向上的每条光线,算法每次循环对一个单元进行采样(光线与出口面交点为采样点),将数据重构结果(采样点处流场值)转换成颜色和不透明度,合成到相应像素.为加速合成,采用预积分(pre-integral)技术[4,17],预先建立3D预积分颜色查找表(一种3D传递函数),绘Page3制阶段通过查表完成颜色转换与合成.图3显示了算法流程,在预处理和绘制阶段分别完成如下任务:1)预处理阶段(1)构造面通量.根据物理量类型,采用Roe平均方法,由面相邻单元胞心值构造面通量(第3.3节).(2)计算单元梯度.基于面通量,采用格林公式计算单元梯度(第3.2节).2)绘制阶段(一次采样循环)(1)基于胞心值进行直接流场数据重构(第3节).①计算采样点位置.判断单元出口面;计算单元出口位置;确定出口单元(第3.1节).图3算法流程3基于格心数据的直接流场数据重构原理为实现基于格心数据的直接流场数据重构,关键是设计由胞心值获得采样点处流场值的计算方法.本文用基于胞心值的线性梯度重构方法计算单元面上采样点处的流场值,该方法源自FVM求解思想[1-3].如图4,光线在投射过程中相继与两面相邻单元(记作Cc和Cn)相交,获得采样点Sc和Sn,分别位于单元Cc和Cn的出口面上.若用Qi表示物理量,点Sc(Sn)处的流场值可由单元Cc(Cn)的胞心值及单元梯度来重构.以单元Cc为例,若分别用狉Cc和Qi表示其格心位置和单元梯度,则采样点Sc处的流场值(记作Qi梯度重构采样点处流场值.②采样点流场数据重构.用当前单元胞心值和(2)基于预积分进行颜色转换与合成(第4节).①计算相交线段长度.恢复算法前次循环中单元出口(即当前单元入口)位置;由当前单元入口和出口位置计算相交线段长度.②颜色转换与合成.恢复前次循环中单元出口(前次采样点)处流场值;以当前单元入口和出口处流场值及相交线段长度为索引,查询3D预积分颜色查找表,获得当前单元对屏幕像素的颜色贡献并累加.其中,狉Sc为点Sc位置,Qi值.假设单元内流场呈线性变化,则Qi性梯度重构方法计算:3.1采样点位置计算采样点位置经光线与网格单元的相交计算获得.如图5,若用狀i表示单元的第i个面法向,狏i表示与第i个面相对的顶点位置,犲和狉分别为视点位置和光线方向,通过计算并比较光线与单元各表面(或表面的支撑面)的相交参数λi(i∈{0,1,2,3})来确定交点位置[18]:上式中,当分母(狉·狀i)为正时,单元出口面对应最小的λi值(记作λmin),进而获得采样点(出口)位置犲+λmin·狉,并根据单元间的面相邻关系确定出口单Page4本文直接基于原始格心数据完成采样过程中的元,而当前单元的出口即为出口单元的入口.采样过程循环推进,每次对光线方向上的一个新单元进行采样,判断并计算其出口位置,直到网格边界.3.2基于格林公式的单元梯度计算所有计算任务,对于式(2)中的单元梯度Qi基于胞心值的格林公式计算.格林公式的计算原理与FVM的“守恒性”思想相一致,且对于网格中质量较差的扁平单元,也能很好地反映出单元内流场变化趋势[3,15,19],产生高精度的梯度计算结果.如图6,假设单元Ck(k∈{1,2,3,4})是单元C0的面相邻单元,邻接面为k.若用Qk和狀k表示邻接面k的通量(面心处流场值)和面法向.根据格林公式,单元C0内的流场梯度Qi其中V和S是单元C0的体积和表面积.若用Sk表示邻接面k的面积,则上式可变换为如下线性方程:对于面通量Qi联,采用CFD中广泛应用的Roe平均方法,根据物理量类型,经面k处的相邻单元C0和Ck的胞心值(用QiC0和Qi3.3基于Roe均值的面通量构造CFD中提供了多种计算格式,通过相邻单元胞心值,近似构造面通量,其中,Roe格式具有很高的分辨率和计算精度,是目前应用广泛、评价极高的计算格式[2-3,15,19],而Roe平均是用Roe格式求解流场的重要环节[20].CFD数值计算结果包含的基本物理量有密度ρ、速度狏和压强p,本文考虑流场中各物理量间的相互关联,根据物理量类型,选用不同的Roe平均公式来构造面通量.对于不同物理量,式(6)可具体展开如下:(1)密度ρ的Roe平均(2)速度狏的Roe平均狏k=(ρC槡0·狏C0+ρC槡k·狏Ck)/(ρC槡0+ρC槡k)(8)(3)压强p的Roe平均欲获得压强p的Roe均值,先经下式求得单元C0和Ck的焓值(记作hC0和hCk):其中r为比热比,相对于空气,r=1.4.再用焓的Roe平均公式计算关于焓的面通量(记作hk):hk=(ρC槡0·hC0+ρC槡k·hCk)/(ρC槡0+ρC槡k)流场中任意点处的压强p和焓h具有下述关联:因此,压强p的Roe均值为4颜色转换与合成采用上述方法完成采样点流场数据重构以后,需要设计相应的颜色转换与合成方案,将重构结果(采样数据)映射成光学属性(颜色和不透明度)并累加到相应像素,合成最终的体绘制图像.本文采用“预积分”技术[4,16],基于预先建立的3D预积分颜色查找表(3DLUT),同时完成颜色转换与合成,以加速绘制.本质上,3DLUT是以单元入口点和出口点处流场值以及光线在单元内的相交线段长度为自变量的3D传递函数.对于物理量Qi,算法在采样循环的重构阶段,计算当前单元Cc出口点(Sc)处的流场值Qi成阶段,需要恢复入口单元出口点(即当前单元入口点)处的流场值.如图7,光线相继与面相邻单元Cl、Cc和Cn相交.假设当前采样单元为Cc,则Cc的入口点(Sl)处流场值是算法前次循环中计算的单元Cl的出口点(Sl)处流场值(记作Qi复前次采样点Sl的空间位置,以便计算光线在当前单元内的相交线段长度.最后,将当前单元入口点流场值Qi索引,查询3DLUT,得到当前单元对屏幕像素的颜色贡献并累加到相应帧缓存,合成最终的体绘制图像.Page55数据重构精度分析与比较5.1间接绘制方法的精度分析为分析基于外推的间接绘制方法的流场数据重构精度,先简单介绍目前基于格点数据完成重构的基本原理.经外推计算将格心数据转换为格点数据后,为重构单元面上采样点处的流场值,目前有两种方法:基于面顶点的全线性插值[12-13]和基于单元顶点数据的线性梯度重构[4-5].后者的提出是为降低前者的插值计算量,两者在本质上完全相同,具有相同的重构结果和精度.如图8,V0、V1、V2、V3是单元Cc的顶点,采样点Sc位于顶点V1、V2和V3围成的单元面上.假设外推计算后顶点Vk(k∈{0,1,2,3})处的流场值为Qi基于面顶点的全线性插值方法根据采样点位置(狉Sc),用顶点V1、V2和V3的位置及其流场值(QiV2和QiQiSc).为降低全线性插值的计算量,基于单元顶点(Qi数据的线性梯度重构方法先基于各顶点数据计算单元梯度(记作Qi),再任选一顶点为参考点,用该顶点数据和单元梯度重构采样点处流场值.其中,梯度计算采用距离加权法,建立如下线性方程组:图8基于格点数据的采样点流场重构原理图其中狉Vk是顶点Vk的空间位置.此后,任选单元一顶点为参考点(假设V0),重构采样点处流场值:综上所述,间接绘制方法的采样点数据重构过程主要包括3个计算步骤:(1)外推计算(误差记作in;(2)梯度估计(误差记作O2O1构(误差记作O3制格心数据,通常采用的外推方法是简单平均外推和反转距离外推.如图9,假设单元C0,C1,…,Cn-1是共用顶点V0的点相邻单元,若用QCi表示单元Ci(i∈{0,1,…,n-1})的胞心值,则简单平均外推计算这组点相邻单元胞心值的算术平均(如图9(a)),以此近似顶点V0处的流场值,即QV0=∑i该方法计算简单,是目前可视化中最常用的外推方法,但精度较差[14-15].反转距离外推将各单元中心到其公共顶点V0距离(记作di)的倒数作为权重(如图9(b)),用加权平均计算V0处的流场值,即QV0=QCi/d()i∑i∑i具有1.85阶精度,优于简单平均外推[16].不妨假设间接绘制方法采用反转距离外推,则O1O(Δx1.85,Δy1.85).假设用距离加权法计算单元梯度的误差为Ov,则O2采样点处流场值具有二阶精度,即O3Δy2,ΔxΔy).根据式(14),间接绘制方法在采样点流场数据重构过程中产生的累积误差(记作Oin)为Oin=O(Δx1.85,Δy1.85)+Ov·(狉S-狉V0)+5.2直接绘制方法的精度分析如前所述,本文直接绘制方法基于原始格心数据重构采样点处流场值,与间接绘制方法相比,避免了外推计算误差(O1(1)梯度估计(误差记作O2差记作O3Oc,则O2Page6值具有二阶精度,即O3式(2),直接绘制方法在采样点流场数据重构过程中产生的累积误差(记作Od)为Od=Oc·(狉Sc-狉Cc)+O(Δx2,Δy2,ΔxΔy)(16)对比式(15)和(16)中的误差项,直接绘制方法避免了外推计算误差项O(Δx1.85,Δy1.85).为计算单元梯度,间接绘制方法采用距离加权法,误差较大(尤其当网格中包含扁平单元时)[2,15,19];而直接绘制方法采用基于面通量的格林公式,计算精度高,且灵活性和适应性好[1,3,15,19].同时,本文用Roe平均方法构造面通量,进一步提高了计算精度[1-3],因此Ov>Oc,而在平均状况下,狉Sc-狉V0≈狉Sc-狉Cc,故明显有Od<Oin.上述分析表明,本文的直接绘制方法具有更高的采样点流场数据重构精度.此外,外推计算是基于平均方法的,这不仅抹平了数值计算结果中的间断和尖峰,使外推后的数值耗散增大,远离真实流场值;而且导致外推后的格点数据范围小于原始格心数据,造成部分数据信息丢失.间接绘制方法以此为数据基础重构采样点处的流场值,不仅无法完整显示流场的全局特征,而且局部特征区域范围也随之改变,进一步影响了绘制精度.6算法实现与实验结果6.1算法的GPU实现本文采用GPU加速技术,在配置为IntelPentiumDual1.60GHz处理器(2048MB)和NVIDIAGeForce9800GTX显卡(512MB)的PC机上,基于VisualC++.net2005开发环境,实现了上述算法.对于较大规模CFD非结构化网格格心格式数据,绘制性能可满足实时交互.GPU与CPU之间的数据传输瓶颈是算法设计时需考虑的重要问题.解决方案之一是将光线投射过程中的所有计算任务交由GPU完成,避免执行阶段GPU和CPU间的数据等待与交换.为此,文献[5]设计了两个2DGPU纹理数据结构:格点数据纹理和采样数据纹理.前者以单元为单位存储网格数据,为每个单元存储其顶点的空间位置和流场数据,以及单元面法向和面相邻单元纹理坐标;后者存放实时采样结果.本文在此基础上修改网格数据纹理,用格心数据取代格点数据,以实现对格心数据的直接绘制.为实现基于预积分的颜色转换与合成,采样数据纹理中需存放每次循环结束后的采样点位置和流场重构结果,以及累加后的像素颜色值.6.2测试数据与实验结果前述分析可知,直接绘制方法能明显提高重构精度,为用户提供高质量的体绘制图像.为进一步验证其正确性,本文分别用间接和直接绘制方法,对实际CFD工程中三组格心格式数据进行测试并比较其绘制结果.6.2.1StaticMixer数据集该数据集网格模型包含60796个顶点和103762个单元(如图10).对压力场进行绘制,在相同的3D传递函数下,图11是采用反转距离外推,基于格点数据的间接绘制效果;图12是本文基于原始格心数据的直接绘制效果,并注明了各自压力场数值范围.可见,格点数据值域是原始格心数据的真子集,即外推过程损失了部分数值计算结果.对比如图11和图12中的白色标注区域,容易发现,间接绘制方法无法显示流场全貌,造成局部重要特征丢失.此外,外推计算的“平均”思想抹平了数值解中的间断和尖峰,导致数值耗散增大,远离真实流场值,以此为数据基础重构采样点处的流场值将引起误差传播,使可视化结果不能准确反映数值计算结果和实际流场状态,严重影响了分析的有效性.6.2.2接触间断数值模拟图13显示了某接触间断流场数值模拟使用的网格模型,包含68032个顶点和131836个单元.分别用两种方法对密度场进行绘制,在相同3D的传递函数下,图14是采用反转距离外推,基于格点数据的间接绘制效果;图15是基于原始格心数据的直接绘制效果,并注明了各自密度场数值范围.图中红色拱形标注出流场中的接触间断特征,理论上,其跨度大约为2~3个网格单元且显示为纯色[21].对比两者,容易发现,图15显示的流动间断特征更为合理、逼真,准确地反映了数值计算结果和实际流场状态.Page7图11间接绘制效果图(反转距离外推,压力场[25149.236,112826.745]Pa)图12直接绘制效果图(压力场[23042.768,137402.683]Pa)图14间接绘制效果图(密度场[0.8475,2.2476]kg/m3)图15直接绘制效果图(密度场[0.7614,2.4984]kg/m3)6.2.3单机翼流场数值模拟图16显示的网格模型用于模拟某单机翼周围流场,包含7342个顶点和35812个单元.分别用两种方法对密度场进行绘制,在相同的3D传递函数下,效果如图17和图18所示.对比两者,不难发现,图17间接绘制方法效果(密度场[0.553662,1.46706]kg/m3)Page8直接绘制方法能更加清晰而准确地显示机翼周围流场特征,帮助用户更加有效地洞察和分析数值计算结果.图18直接绘制方法效果图(密度场[0.532351,1.59506]kg/m3)7结论高精度的流场数值模拟需要高精度的可视化算法与之匹配.对于FVM产生的CFD非结构化网格格心格式数据,区别于目前基于外推的间接可视化方法,本文结合FVM求解思想并考虑流场中物理量间的相互关联,设计实现了一种避免外推的直接可视化方法(该思想并不局限于体绘制,对等值面提取和流线跟踪也同样适用),并以光线投射体绘制算法为例验证了直接可视化方法的绘制精度和效果.从理论上证明了直接绘制方法的采样点数据重构精度明显优于间接绘制方法.通过实验证实了本文方法能有效保护原始数值计算结果,为科学计算人员提供高质量的体绘制图像.
