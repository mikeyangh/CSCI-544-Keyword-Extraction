Page1基于混合优化的快速隐式曲面采样方法李伟涛1)周元峰1)高珊珊2)张彩明1),2)1)(山东大学计算机科学与技术学院济南250101)2)(山东财经大学山东省数字媒体技术重点实验室济南250014)摘要该文提出了一种新的隐式曲面快速采样方法,该方法首先提出了一种新的采样点互斥能量目标函数,基于该目标函数,通过一种混合优化方法来求解采样点的分布.第1步为采样点的局部优化,通过对采样点移动速度的控制参数调整,避免了大量Hessian矩阵的求逆操作,使得采样点能够根据互斥半径快速覆盖整个隐式曲面,得到初始采样点集;第2步为采样点的全局优化,采用L-BFGS方法对所有采样点进行优化,得到最终的高质量采样结果.通过实验表明,新方法的采样速度大大提高,并能够获得较好的隐式曲面采样点分布.关键词隐式曲面;动态采样;优化;目标函数1引言近年来,随着CAGD、CAD、计算机仿真技术的发展,基于隐式曲面的建模方法得到了越来越广泛的关注和应用.在曲面建模中,与参数曲面相比,基于隐式曲面的建模具有以下优势:可以提供更为简洁直观的表达方法;具有很高的连续性;能够容易地表示拓扑复杂的曲面,并且容易改变曲面的拓扑结构;空间点与隐式曲面的相对位置容易判断.隐式曲Page2面绘制方法一般有两种:光线跟踪方法和多边形化方法.光线跟踪方法可以得到隐式曲面的高质量的图像显示,但是需要进行大量的光线与隐式曲面求交运算,因此绘制速度受到影响,快速高质量的隐式曲面采样有助于提高光线投射算法效率.同时,高效的隐式曲面采样方法可以有助于对隐式曲面进行显示和控制.因此,隐式曲面采样问题在科学计算可视化、隐式曲面绘制、计算机动画等领域有很高的应用价值.目前在计算机图形学领域中,隐式曲面的采样方法已经被应用于隐式曲面绘制[1]、形状控制[2]、曲面多边形化[3-8]、动画设计[9]、纹理映射[10]等应用中,在这些应用中,如何快速获得高质量的采样结果是其中的关键问题之一.利用粒子采样对隐式曲面进行建模和绘制的方法[11-12]最先由Szeliski和Tonnesen等人提出,该方法能够对变形曲面模型计算有向粒子采样,称为粒子系统(ParticleSystem),是目前使用较多的隐式曲面采样与绘制方法之一.Witkin等人[13]基于优化方法提出了一种用采样粒子对隐式曲面进行采样和控制的方法,该方法将一组粒子约束在曲面上,粒子之间的互斥力使粒子均匀地分布在曲面上,从而实现对曲面的采样.该方法可以实现动态、实时地在曲面上去掉或者增加粒子,但是该方法需要求解大量参数,其优化方法无法达到稳定收敛效果,难以获得一组稳定的采样粒子.在Witkin方法的基础上,提出了一些对该方法的改进,如文献[14-16]中能够根据曲率变化约束粒子的数量,在曲率高的地方生成较多的采样点,Hart等人[17]改进了Witkin的方法,给出了一种自动确定参数的方法,能够对较为复杂的隐式曲面进行采样,但这些方法的不足仍然是采样过程不够稳定.Heckbert等人[18]提出了一种采样粒子影响半径估计方法,为每个粒子设定一个不同的影响区域,方法的优点是在计算互斥能量时只需要考虑该区域内的采样点,缺点是需要不断更新每个采样粒子的包围球.Meyer等人[14]采用了一种优化的方法求解曲率约束下的粒子采样,该方法计算稳定(本文称为Meyer方法),对拓扑复杂的曲面能够获得好的采样结果,但因为在调整采样点位置时需要大量重复计算目标函数的Hessian矩阵及其逆矩阵,求解过程缓慢,因此难以达到快速采样的效果.基于以上问题,本文提出了一种对隐式曲面快速采样的新方法,能够快速获得隐式曲面上高质量的采样结果.如图1所示,给出了一个对于球面进行表面采样的结果.新方法采用两步优化方法对隐式曲面进行快速高质量采样,分别是采样点的局部优化和全局优化.为了能够使采样点快速分布到整个隐式曲面上,本文提出了一种新的能量目标函数,首先采用牛顿法获得每个粒子的移动速率及方向,通过对移动速率的调整获得隐式曲面的初始采样,在初始采样的基础上,利用全局优化方法L-BFGS(LimitedMemoryBFGS)方法对采样点进行进一步优化,从而获得稳定的采样结果.本文的主要创新点如下:(1)提出了一种新的采样点互斥能量目标函数,该函数具有更快的下降速度,能够快速获得采样点在隐式曲面上的初始分布;(2)采用一种新的采样点更新策略获得初始采样,避免了大量重复Hessian矩阵的求逆计算;(3)引入L-BFGS方法,对隐式曲面初始采样结果进行进一步优化,从而获得高质量稳定的采样点集.2基于粒子系统的隐式曲面采样方法Witkin等人[13]提出的隐式曲面建模方法基于粒子系统,可以实时地显示和交互控制隐式曲面.在此我们简单介绍一下Witkin粒子采样方法的基本思想.首先给出采样粒子的定义:对隐式曲面,定义约束在f上的一个点为该曲面上的一个采样粒子.假定狆为f上的一个粒子,狆满足如下约束:这里f可看作随时间t变化的动态隐式曲面,狆i(t)为约束于隐式曲面上的第i个粒子位置,狇i(t)为隐式曲面的系数向量.利用式(1)将一定数量的粒子约束在隐式曲面上,可以构成对隐式曲面的表面Page3采样.Witkin方法为每个粒子定义一个与其相邻粒子间的互斥作用力,互斥力将粒子与粒子之间分隔出一定的距离,当所有粒子的互斥作用达到均衡时,可以将粒子均匀地分布在曲面之上.根据高斯函数,粒子与j粒子之间的互斥能量定义为其中:|rij|为两个粒子之间的距离;σi为局部互斥半径,并根据粒子的局部能量值进行变化;α为可调互斥参数.第i个粒子的能量定义为Ei=∑j度下降法知,粒子沿能量Ei的梯度方向移动能量减小最快.由式(2)知,粒子移动速率可由对互斥能量求导得到vi=-(σi)2EiPi=(σi)2∑n当粒子的能量不满足一定阈值时,将vi投影到粒子所在的局部切平面,使得粒子沿vi进行移动,此时粒子可能会脱离隐式曲面,可以将更新后的粒子再反投影到隐式曲面上.Witkin采样方法采用粒子动态分裂/死亡机制将粒子约束在曲面上,初始给定一个随机粒子和一个比较大的互斥半径,用迭代方法对粒子进行分裂或者死亡,若粒子的互斥半径大于设定的半径阈值或者粒子能量大于设定的能量阈值,则将该粒子一分为二,并减少粒子之间的互斥半径;反之,若粒子的互斥半径过小,则该粒子死亡.迭代重复上述步骤,直至所有粒子满足能量和互斥半径约束条件.Meyer等人[14]在此基础上提出了一种更为稳定的隐式曲面采样方法,该方法采用Levenberg-Marquardt方法局部优化采样点位置,通过调整目标能量函数的Hessian矩阵来更新采样点移动的速率及方向.该方法需要多次计算Hessian矩阵并求逆,因此计算量大,采样点移动速度慢.图2采样点能量函数比较3混合优化的隐式曲面采样方法本文提出了一种新的隐式曲面采样方法,方法可以分为两个步骤:第1步建立采样点互斥能量目标函数,利用牛顿法动态获得一个隐式曲面上的初始采样点集;第2步,采用全局优化方法L-BFGS方法对初始采样点集进行进一步优化,从而获得更为理想的采样点集位置.本节我们详细介绍一下新的采样方法.3.1新的能量目标函数建立对于隐式曲面采样问题,粒子系统(ParticleSystem)能够通过优化采样点间的互斥能量函数调整采样点的位置,逐步达到采样点在隐式曲面上均匀分布.在Meyer方法中[14],作者采用了三角函数来定义两个采样点之间的互斥力能量函数,通过对该能量函数求一阶导数得到采样点的移动速度,并进行采样点更新.在本文中,我们提出一种新的采样点间的互斥能量函数,为了能使采样点获得更快的更新速度,采用双曲函数定义采样点之间的互斥能量:其中,a为可调节参数,在此一般取a=e2.当采样点能量不满足给定阈值时,将采样点沿着函数(4)的梯度在其切平面的投影进行调整,能量函数的梯度表达式为vi=-a图2给出了对于新的能量目标函数同Meyer方法中的目标函数的比较,通过对能量函数,能量函数的一阶导数与二阶导数的比较可以看出,当两个采样点之间的距离接近给定阈值σ时,能量函数具有更平缓的变化,采用局部调整方法能够快速获得隐式曲面的初始采样.Page43.2采样点局部快速调整在建立了采样点间的互斥能量函数之后,本文首先采用Meyer方法中的Gauss-Siedel更新策略对所有采样点进行局部调整,获得一个初始采样结果.采样点进行局部更新,通过调整采样点移动的速率大小使得互斥能量下降,并且该采样点的移动方向仅根据其周围最近的若干采样点进行计算.首先介绍一下对每个采样点的局部更新策略.以一个粒子pki为例,根据牛顿法,能量下降的梯度方向可以表示为其中,Hi,Di分别表示能量函数Ei的Hessian矩阵和梯度,其中Hi=2EiDi=∑m将采样点移动速度向量投影到该采样点在曲面上的切平面上,待采样点按照该投影向量进行位置调整后,新的采样点位置pk+1i可以表示为pk+1i=pki+I-FiFi其中,αi∈(0,1]是采样点移动速度控制参数,用于控制粒子在vi方向上运动的长度.然后使用Newton-Rhapson方法将调整之后的采样点重新投影到隐式曲面上:通过调整控制参数αi的大小,对隐式曲面上的每个采样点沿着能量下降的方向进行调整,若采样点调整后不满足能量下降条件,则逐步调整αi的值降低采样点移动速度,该调整能够控制采样点的移动范围,使得最终采样点达到稳定的状态.本节提出的采样点局部调整算法如算法1.算法1.采样点快速局部调整算法.给定一组采样点集队列:1.如果当前采样点pi达到稳定,则调整采样点队列中2.计算Ei,Di,Hi,并根据牛顿法求解采样点移动速3.根据vi尝试更新采样点,并计算采样点在新位置处的下一个采样点,否则转步2;度vi;的能量Enew4.如果Enewvi=vi·αi(0<α<1),转步3;5.如果Enew一个采样点.当采样点试图移动到一个能量较高的位置时,新的局部调整算法不需要多次重复执行L-M算法计算采样点的速度,新方法通过调整当前速度尝试让采样点在一个局部范围内进行调整,从而可以克服能量突然上升的问题,计算复杂度更低.采样点局部调整算法能够快速获得分布于隐式曲面上的采样点集,但是采样点的分布质量较差.因此我们引入了准牛顿算法L-BFGS方法来进一步优化采样点的位置.3.3基于L-BFGS的采样点全局优化采用算法1可以快速获得分布于隐式曲面上的采样点集,但是由于初始采样点分布质量较差,这里我们采用一种全局优化的方法L-BFGS方法对采样点集进行进一步优化.L-BFGS方法是一种准牛顿方法[19],用于求解无约束的非线性优化问题,该方法可以通过对前m次迭代的目标函数梯度和目标函数值的逼近得到第k次迭代Hessian矩阵的近似逆矩阵[19],本文实验中采用m=7.L-BFGS变量更新公式为其中,^Hk为函数F在狓k处Hessian矩阵的逼近,δ为控制参数用于调整步长大小.当采用算法1获得了隐式曲面上的一个初始采样后,该采样结果可以作为L-BFGS算法的一个比较好的输入.图3给出了一个对算法1获得隐式曲面初始采样后进一步对采样点集进行优化的结果,其中图3(a)为采用算法1图3L-BFGS优化结果比较(其中混合优化方法运行时间为0.841s,Meyer方法运行时间为2.273s)Page5获得的初始采样点集(740个采样点),图3(b)为经过L-BFGS优化后得到的采样点集,迭代次数为36次,图3(c)为采用Meyer方法得到的采样点集(670个采样点).从图中可以看出,经过L-BFGS方法全局优化的采样点集分布更加均匀,从时间比较上看,本文的混合优化方法速度更快.本文提出的隐式曲面混合优化采样算法如算法2.算法2.基于混合优化的隐式曲面采样算法.输入:隐式曲面F.输出:采样点集S.1.在空间中随机给定一定数量的采样点集,并将其投影到隐式曲面上;2.使用算法1调整每个采样点的位置;3.对每一个采样点pi:I.如果λi>0,转队列中的下一个采样点,否则转II;II.如果Ei<0.35^E,那么在该粒子的周围插入一个新的采样点.4.如果步2和步3得到的采样点的位置变化小于一个给定的阈值,则认为所有的采样点集进入稳定状态,将得到的采样点集作为输入,调用L-BFGS算法对所有采样点进行进一步优化调整,反之转步2.图4Doll、Bunny、Dragon模型采样结果4实验结果比较本节给出了新的混合优化方法与文献[14]中提出的方法比较的结果.本文中所有实验结果均是在Inter(R)Xeon(R)CPUE5504,主频2.00GHz,8GB内存的计算机上运行得到.图4给出了采用新的混合优化方法对3个隐式曲面模型:Doll,Bunny和Dragon的采样结果.其中,Doll模型为Blobby曲面[20],Bunny和Dragon模型是变分曲面[21].分别对这3个模型进行不同密度的均匀采样,并给出了文献[14]中Meyer算法和本文算法的算法运行时间比较结果.从采样结果可以看出,Meyer算法和本文算法都能够使粒子均匀的分布到曲面上,即每个采样点周围都有6个或者接近6个成六边形分布的邻接采样点.图5给出了图4中各模型的算法运行时间统计结果,从直方图的对比中可以明显看出当采样点数一致时,本文提出的基于混合优化的采样算法比Meyer采样方法要快很多,Meyer方法与本文算法的运行时间之比在2~8.5之间.Page6为使粒子能够根据曲面的局部几何特征自适应分布,Meyer方法提出了一种基于曲率约束的采样策略,即为每一个采样点引入一个互斥影响因子βi,并将此影响因子代入到采样点能量公式,梯度公图6曲率自适应采样结果对于互斥能量式(4)来说,不同的互斥半径σ会得到不同数目的采样点分布.因此,我们通过给出不同的互斥半径σ验证算法的有效性.由于单位球表示形式简单,其函数值和各阶导数的计算方便且快速,所以单位球的均匀采样时间将由算法的速度直接决定.在这里以一个单位球为例,通过比较采样点的期望半径和采样时间统计曲线,来比较本文算法和Meyer算法的速度.如图7所示,虚线和实线分别表示Meyer算法和本文算法的算法收敛时间和期望半径σ之间的关系.从图中可以看出,在算法执行开始时,σ比较大,因此每个采样点的影响范围比较大,隐式曲面上分布的采样点数量比较少,Meyer算法和本文算法的收敛时间大致相似.但随着σ的不断减小,采样点数量不断增加,Meyer算法和本文算法的收敛时间之差不断加大,当σ=0.05时,Meyer算法的收敛时间大约是本文方法的4倍.此结果说明了本文方法与Meyer方法相比,收敛速度更快.如图2(a)所示,当两个采样点之间的距离逐式和Hessian矩阵的计算中.其影响因子可以表示为文献[14]中指出,当υ=0.75,γ=0.1,d=2,k∈[0,20]时,采样点能够较好的依据曲面的曲率自适应分布,其中曲率的计算采用文献[22]中的方法.我们将该曲率影响因子引入到新方法中,图6给出了新方法和Meyer方法分别对Doll模型和Bunny模型进行曲率自适应采样的结果,其中采样点的大小反应了该点出曲率的大小.从图6可以看出,对于曲率自适应方法的采样,新方法能够避免多次计算能量函数Hessian矩阵,并且采样点曲率求解次数也相应减少,因此相比Meyer方法,采样速度得到了大大提高.渐接近期望距离(0.57σ)时,本文能量函数的下降速度明显大于Meyer能量函数.通过比较图2(b)、图2(c)中采样点速度曲线、加速度曲线可知:随着采样点之间的距离由近及远逐渐接近期望距离(0.57σ),本文采样点速度的变化率更大,即本文算法能量能够快速促使采样点由高速度的不稳定状态收敛到低速度的稳定状态.Page7图8分别给出了Bunny模型自适应采样的三角化结果[7]、总能量和迭代次数、总能量的梯度模长和迭代步数之间的关系.根据图8(a)中三角形大小和分布,可以直观的看出,Bunny模型的自适应采样依据曲面的曲率自适应分布,且能够表现原始曲面图8三角化结果及其能量梯度下降曲线为比较新算法和Meyer算法采样结果的质量,本文使用采样点间平均平方距离来衡量采样点的分布质量,该能量函数可以表示为其中:n,r分别是采样点数和采样点查询半径,狓为采样点位置.对于一个模型,在采样点数,采样点查询半径相同,并且采样点完全覆盖原始模型的情况下,距离d越小,说明采样点分布越均匀.在采样点数相同且固定的情况下,使用本文算法和Meyer方法对图4中模型进行均匀重采样,并计算各模型的平均距离d.表1列出了各模型的统计数据,可以直观地看出,新算法采样点间平均距离和Meyer算法的平均距离接近,说明新算法的采样质量和Meyer算法的采样质量相近.模型采样点个数Doll12800.227524000.22482900Bunny25040.030126100.03114520Dragon19830.005540130.00530264从以上实验结果比较来看,新方法能够通过快速的局部调整获得隐式曲面上的初始采样,全局优化方法能够进一步将所有采样点的位置进行调整,从而获得高质量的采样分布.与Meyer方法相比,的细节特征.图8(b)、(c)中函数曲线直观的体现了随着迭代次数的增加,粒子系统总能量及其梯度模长都在不断减少.此外,当迭代次数大于等于15时,系统趋于稳定,且收敛速度快.在获得同样高质量采样结果的前提下,新方法比Meyer方法要快.5结论隐式曲面动态采样是几何造型中的热点研究问题,本文提出了一种基于混合优化的快速隐式曲面采样方法.新的能量函数具有更快的梯度下降,并且通过调整其速度能够快速获得分布在隐式曲面表面的初始采样点集.然后采用L-BFGS方法对初始采样点集进行全局优化,使得采样点均匀分布在曲面上.混合优化方法的优势在于既具有局部优化方法的优势,可以快速获得初始采样点,又具有全局优化方法的优势,能够得到高质量的采样点集合,在大大提升采样速度的同时不会降低采样质量.我们下一步的工作是根据混合优化方法获取隐式曲面上的具有蓝噪声特性的采样点集.
