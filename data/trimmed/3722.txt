Page1基于发布订阅结构的计算机视觉跟踪研究刘海洋刘元安高锦春马晓雷刘春旭(北京邮电大学安全生产智能监控北京市重点实验室北京100876)摘要文中报道了使用发布订阅中间件搭建的一个跟踪系统,通过单摄像头采集图像,经过分析处理,计算出运动物体的相对位置,同时控制摄像头转动,对运动物体进行实时追踪.整个系统主要包括4个方面,以发布/订阅为中心结构连接3个子系统、目标获取、目标跟踪、采集摄像头控制.文中为卡尔曼滤波定义了新的向量,预测目标运动趋势;根据物体的运动信息自行设计了摄像头控制程序.算法有充分的理论依据和实验验证.关键词发布订阅;视觉追踪;背景减除;CamShift;卡尔曼滤波器1引言视觉跟踪是计算机研究领域中的一个重要课题,是指对图像序列中的运动目标进行检测、提取、识别和跟踪,获得运动目标的运动参数,如位置、速度以及运动轨迹,从而进一步处理与分析,实现对运动目标的追踪.本文采用了发布订阅机制把整个系统分成3部分,第1个子系统只负责由外部采集设备中不断地从视频中采集帧;第2个子系统由多台工作站组成,从发布订阅中间件中获得采集帧进行Page22发布订阅构架由于视觉跟踪中图像处理计算量大,如果把采集系统、分析系统、控制系统放在一台服务器上,很难保证跟踪过程中的实时性.以数据为中心的发布订阅[1]系统主要的特点包括松耦合性和实时性,正好可以满足视觉跟踪系统的结构.采集节点作为原始图像发布者,不断地向分析节点发送图像;分析节点得到原始图像后分析当前运动物体位移和运动趋势,再以发布者的身份发布数据到控制节点;控制节点得到信息后对采集设备进行控制.发布订阅结构可以采用DDS[2](DataDistributeService)规范进行构建(DDS是对象管理组织OMG[3]的有关分布式实时系统中数据发布的一个规范).DDS以数据为中心来进行数据分发,用QoS参数对资源状况、期待程度、网络情况等进行描述,提高系统的灵活性.在研究过程中,遇到实时性和各流程间的并行处理问题,经多方调研分析,本文提出了采用实时发布订阅[4]机制构建系统,适用于采用多终端视频采集设备的环境,部署集中/分布式视觉追踪构架,消除过程间的依赖性,此方法有如下优势:(1)摄像头采集图像的速度远远大于进行图像分析的速度.如果只有一台工作站分析图像,很可能在分析过程中,大量新采集到的实时图像被遗漏;如果采用几台工作站协同进行图像分析,因为图像分析算法的处理时间不确定,图像采集系统不能按照顺序发送数据,同时还要考虑网络连接、图像重发、选择图像处理工作站等问题.在图像采集端和图像分析端,增加一个发布订阅中间件可以降低整个系统的复杂度,多个工作站可平衡图像分析的负载.(2)在增加发布订阅中间件后,控制系统不用再考虑数据的来源,直接从中间件中取得最新的数据源的位置,取得最新的数据,保证了控制的实时性与连续性.(3)这种结构设计有很好的扩充性,可以根据所采用摄像头的功能,增加其它的实际要求,只需简单的扩充其它图像分析功能的工作站,配置发布订阅主题控制端增加一点逻辑,就可以改进系统.本文只讨论根据运动物体的位移方面的需求,进行云台的控制,如果需要添加新的功能,例如:对于多目的视觉跟踪系统,根据运动物体的像素数,调整摄像头的焦距,都可以在这种系统结构下很轻松的改造升级.3目标检测与跟踪分析首先要对采集的图像进行预处理,包括边缘处理、高斯平滑.图像经过处理后,通过背景差的方法,分离运动目标.背景差法的第1步是在背景稳定且没有物体进入检测范围时,采集连续的背景序列图像,通过计算每帧平均值的算法建立背景模型[5].经过背景差得到的运动目标区域,由于光线的原因常连带着一些阴影,所以需要通过阴影检测[6],将阴影分离开,让目标跟踪的更加准确.经过阴影祛除后,可以较精确地确定运动目标点.将采集的RGB图像转化为HSV图像,分离H通道建立彩色直方图,给CamShift[7]跟踪算法提供判断依据.CamShift算法的基础是均值移位算法———MeanShift[8]算法,又称均值移位算法,是一个非常实用的进行局部最优解求取的算法,具有快速高效的特点,从候选目标中找到最接近已给定的目标模型.MeanShift算法是一种密度函数估计的非参数方法,它依据概率分布的梯度寻找最近的极值,基于目标的颜色概率分布信息进行快速有效的跟踪,还可以有效地去除序列图像中的噪声及干扰,算法鲁棒性好.MeanShift算法在视觉跟踪中,采用不断调整区域质心,使质心不断地趋近于获取区域的中心位置,来达到跟踪目的.计算出搜索区域的质心位置后,把搜索窗口的中心位置移到质心位置,根据新的中心位置再计算质心,不断地迭代计算,直到计算出的质心收敛.此时检测设备就锁定了跟踪目标.搜索窗口的质心位置可以由零阶矩和一阶矩确定.零阶矩的计算公式:x和y的一阶矩计算:Page3搜索窗口的质心计算:连续自适应的MeanShift算法(即CamShift算法)在跟踪过程中可以不断地调整搜索窗口的大小,保证搜索窗口能跟随采集物体图像的面积的变化而变化,这样就可以连续不断地实时而准确地跟踪物体.计算在采集图像中已被匹配窗口的二阶矩:x,y,xy方向的二阶矩M20,M02,M11为计算3个运算参数:注.M00xcyc是匹配成功后窗口(当搜索窗口超出采集图像的边界时,需要对窗口进行调整再计算)的零阶矩和xy中心.搜索窗口的追踪方向角度、长宽为CamShift算法流程如下:1.初始化搜索窗口.把在目标检测阶段获得的坐标信息,处理为矩形区域,作为初始的搜索窗口.搜索窗口包括窗口的大小、窗口在整个图像(原始图像的反向投影)的位置.2.提取搜索窗口.根据搜索窗口的信息从图像中抽取,需要计算的矩形子图像.3.计算质心与中心.获取搜索窗口的宽高中点得到中心位置,质心通过一阶矩比零阶矩的方法获得.4.改变搜索窗口信息.根据质心与中心的距离修改搜索窗口的信息(主要是搜索窗口在图像中位置的信息),回到第2步.程序已经完成了给定的执行次数时,退出搜索程序.5.搜索完成.当质心与中心的距离小于设定参数,或者CamShift算法需要不断的迭代计算,以上一个位置为基准,逐步匹配到目标在当前时刻出现的位置.为了提高系统效率,需要引用一个预估器对目标的运动趋势进行预测,计算出在下一时刻运动目标可能出现的位置,以此位置为基准进行迭代计算,其中卡尔曼预估器[9]就是一个很好的选择.4运动趋势预测卡尔曼滤波是一种高效率的递归滤波器,能够从一系列不包含噪声的测量中,估计动态系统的状态.卡尔曼滤波器由一系列递归数学公式描述.它们提供了一种高效可计算的方法来估计过程的状态,并使估计均方误差最小.卡尔曼滤波器应用的领域广泛并且功能强大,在不确定模型的确切性质的情况下,不但能估计信号过去和当前的状态,还能估计将来的状态.卡尔曼滤波器用反馈控制的方法估计过程状态:滤波器估计过程某一时刻的状态,然后以(含噪声的)测量变量的方式获得反馈.因此卡尔曼滤波器可分为两个部分:时间更新方程和测量更新方程.时间更新方程负责及时向前推算当前状态变量和误差协方差估计的值,以便为下一个时间状态构造先验估计.测量更新方程负责反馈,将先验轨迹和新的测量变量结合构造改进的后验估计.卡尔曼滤波器时间更新方程(离散):卡尔曼滤波器状态更新方程(离散):为了预测出在下一时间,追踪目标的位置,需要为控制摄像头系统提供位移、速度信息,将向量定义为一个四维向量:α(k)=[x(k),vx(k),y(k),vy(k)]T.x(k)为x轴方向位移;vx(k)为x轴方向速度;y(k)为y轴方向位移;vy(k)为y轴方向速度.状态增益矩阵设置为犃=移进行预测,并且对向量不进行额外控制.矩阵中速度设置为1,表示以每次采集间隔时间会逐渐趋近于相同.犎=Page4由CamShift跟踪算法得到质点坐标以及物体的速度矢量,不再进行别的加工处理.预测位置zk=犃×α(k),线性预测出运动目标出现的位置,CamShift算法根据预测出的追踪目标位置,进行追踪,可以提高匹配的速度,降低迭代的次数,保持稳定的跟踪状态,并且使每次的运算时间相对稳定,可以反过来为卡尔曼滤波的稳定估值提供帮助.目前在研究卡尔曼滤波预测的视觉跟踪算法中向量只是定义了两个位置坐标的分量,在固定的采集设备中是可以满足需要的,但并不扩展满足自动跟踪系统,分量中没有描述目标的运动方向和速度,所以在向量中增加速度矢量,并加以完善分析,是本文对向量定义的重要改进:第一,在向量中,vx(k),vy(k)的速度与通常定义的速度是不一致的,通常定义速度是:距离/单位时间(秒、分或小时),而在这里单位时间并不是一个标准值,而是以每次跟踪目标的处理时间为单位,运动目标在采集图像中移动了多少像素.因此,一开始由于系统的处理速度不稳定,导致每次的处理时间也不稳定,所以每次采集到图像的间隔时间也不同,而导致物体在每次处理期间内移动的距离也不相同.但是,随着卡尔曼估计器的估计误差越来越稳定,预测的位置与追踪目标的实际位置越来越接近,并保持在一个稳定的范围时,CamShift跟踪算法的迭代次数也会保持稳定,运算时间也就会接近一个常量,从而保证了每次采集图像中,追踪目标移动距离的稳定.第二,考虑控制摄像头转动,使物体保持在监控范围内,需要使用速度矢量,因为位移信息只能表示物体当前的位置,而不能表示当前物体的运动方向和趋势,控制系统可据此预判出转动方向和速度,从而更加有效地跟踪目标.5控制算法本文除了部署系统的新构架和改进运动目标向量,最重要的就是设计摄像头控制算法,首先要维持运动目标不脱离监控范围,然后维持运动目标在监控坐标系内保持平稳、连续,保证视觉分析系统效率和准确性,对于非固定视频采集设备场景,有长远的研究价值和实用意义.控制算法需要运动目标的速度矢量,来判断物体的运动趋势,根据运动趋势控制云台转动,调整检测画面中的物体趋近于中心位置.由于监测系统需自动地从静止开始捕捉到目标,再保持跟踪目标,所以控制云台转动速度的快慢分为两个阶段,一个是当追踪系统捕捉到运动目标新的位置和速度时,对云台转动速度进行合理的调整.另一个是在控制系统不能得到新的跟踪目标的运动信息时,对云台转动速度进行保守的调整,使物体的成像逐渐趋近于中心.这两个阶段是必不可少的,需要在刚获得物体的运动信息处于相对准确时,迅速调整云台转动速度,保持和运动物体之间的运动趋势相对静止,也需要在没有新的信息时,维持物体仍在监控范围内,为下一次的追踪提供准备.整个控制系统以监控中心为坐标原点,控制的预期目标就是使运动目标位置趋近于原点,处于相对静止的位置.当运动目标的速度大于0时,说明目标远离中心,有移动到监控边缘的趋势,于是要增加摄像头的转动速度,相对使目标的速度降低,回归于原点.当目标的位移已经处于监控边缘,需立刻调整最大的速度,使监控系统能继续捕捉到目标.当运动速度的方向与上次不一致,同时位移却在同一个方向时,说明目标运动与采集设备转动处于相对静止的位置.这是由于控制采集设备是数字量输出,很难保证与运动目标速度相同,才会出现速度不同,位移方向相同的情况.应当在保证采集设备转动的速度不变的情况下,在当前的控制流程中,略微调整速度,慢慢使目标趋于中心位置.控制算法如下:While(是否停止跟踪)【取得位置信息:坐标速度】if新采集位置!=上次位置else结合图像跟踪分析系统设计出的控制设备系统,是在当前视觉追踪的研究中很少提及的,这种设计显然有更好的实用价值,形成一个完整的系统,因为采集设备的转动使目标尽量保持在中心,减少了此Page5次位置与下次位置之间的距离,可以提高CamShift算法的效率,即增加了跟踪效率;由于采集设备的自行转动,在确定运动目标后,增加了可监控的范围.而且,由于自动调节转动速度,可以极大地减少由于目标的非线性运动而引起的卡尔曼滤波估算错误.所以本文中提出的将视觉跟踪系统与控制系统整体考虑的方案,是非常有实际意义的.6实验验证硬件环境使用了4台计算机进行模拟,3台计算机上安装了MicrosoftWindowsXP,一台安装了图2物体跟踪结果的帧截图图3根据目标的运动信息制作的图表LinuxRedHat.采集摄像头使用SONYEVID70P,该摄像头支持SONY公司的VISCA协议,通过串口可对摄像头进行操作.Windows计算机上使用了OpenCV[10]开源软件,对视频进行采集和分析.一台图像模拟采集工作站,一台模拟图像分析工作站,一台模拟设备控制工作站.Linux计算机上安装了OpenDDS开源软件,模拟订阅发布系统的结构.物体运动位移及速度如图3.图3(a)是根据手的质心移动的轨迹,横纵坐标是像素的位置.图3(b)是每次采集分析运动物体移动像素的个数,当物体刚进入检测范围时,由于控制算法为使运动物体在监采集分析实验过程如图2.Page6测中心位置,所以反向朝物体转动,导致一开始的速度最大.经过运动趋势的预测,控制算法逐渐保持运动物体在监测中心.如果运动物体始终保持匀速运动,摄像头通过一定的速率转动可实时跟踪到运动物体,图3(a)是当运动物体改变运动速度时,调整摄像头的转动速度.一般摄像头的转动控制,不能做到模拟量输出的精确控制,只能设置数字量为转动参数,进行控制.图4所示为控制系统根据目标的运动信息,判断出以开关量输出的数值控制速度转动摄像头.速度补偿不是一个恒定的速度设置,每次只对当前控制周期应用一次,下次控制再根据运动物体的位移情况,进行判断补偿.主要应用在两种情况下:(1)摄像头转动的速度已经与物体的速度保持相对静止,可以不断地调整速度补偿使监控中心逐渐靠近运动目标;(2)物体已经运动到采集范围边界,必须紧急调整速度,避免物体逃离监控范围,不图5摄像头补偿速度的调整7结论本文基于发布订阅结构设计了一个视频跟踪系统,多个研究问题结合在一起,搭建了整体的框架,其较已有系统更具实用价值:(1)改进运动目标的速度参数.为采集时间间隔内移动的像素数,调整了当前研究中速度是以秒为单位移动的距离,使卡尔曼滤波器更加适用于图像处理时间不恒定的情况.(2)有效地把图像跟踪分析系统与采集设备控制系统结合在一起,在当前的研究中,视觉跟踪理论与采集设备控制理论处于分离状态,跟踪系统不考虑如何为采集设备提供运动信息,所以当前的研究只提供目标的位移信息,而不考虑运动趋势(速度矢量).同时已有采集系统理想地认为每次都可以得到处理后的最新数据,不考虑运动信息未及时更新或部分数据丢失的情况,因此本文的控制算法很好地解决了这方面的问题.能再捕捉到新的图像.图5给出了一个补偿示意图.一开始物体刚出现在检测范围边缘时,系统控制摄像头的速度方向与物体的运动方向相反,立刻捕捉到物体.在运动平稳后速度补偿只有几次变化,是在运动物体速度方向突然发生变化时产生的.(3)创新地将发布订阅机制应用于视觉跟踪系统,可以更好地协调采集、分析、控制子系统的运行.已有系统的局限性主要在于当目标的速度快并且非线性运动时,控制系统快速地调整方向及转动速度,导致CamShfit的匹配速度降低,卡尔曼滤波的预估与实际值误差较大.解决跟踪非线性快速移动物体的问题,需要目标运动的具体实际条件并根据情况建立模型,设计特定的算法进行搜索.实验证明,本系统是一个实时性好、扩展性强、有实用价值的视频跟踪系统.
