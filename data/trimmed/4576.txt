Page1基于局部方差与残差复杂性的医学图像配准卢振泰张娟冯前进陈武凡(南方医科大学生物医学工程学院广州510515)摘要文中提出了一种新的基于局部方差与残差复杂性的相似性测度.传统的基于灰度的相似性测度易受噪声、灰度偏移场和造影剂的影响造成误配.残差复杂性在一定程度上可以克服这一难点,但该测度对初始参数非常敏感,参数设置不正确往往达不到好的配准效果.文中利用图像的局部方差信息构造权重函数,在图像残差比较大的地方给予小的权重约束,在残差比较小的地方给予大的约束,计算约束后残差图像的残差复杂性作为新的相似性测度.新测度更平滑、鲁棒性更好,不容易陷入局部极值.对模拟数据和真实数据的实验表明新测度对噪声、灰度偏移场、造影剂和初始参数具有更高的鲁棒性,更加适合于医学图像配准.关键词局部方差;指数函数;残差复杂性;鲁棒估计;图像配准1引言医学图像配准是指对一幅医学图像寻求一种空投稿日期:2014-12-18;最终修改稿收到日期:2015-03-10.本课题得到国家自然科学基金(31000450)、广东省自然科学基金(2014A030313316)和广州市珠江科技新星专项基金项目(2012J2200041)资助.卢振泰,男,1981年生,博士,副教授,主要研究方向为医学图像配准与融合、图像检索及模式识别.E-mail:xylzj123@126.com.张娟,女,1986年生,博士,主要研究方向为医学图像配准.冯前进(通信作者),男,1974年生,博士,教授,博士生导师,主要研究领域为医学图像处理、模式识别.E-mail:qianjinfeng@gmail.com.陈武凡,男,1949年生,教授,博士生导师,主要研究领域为图像处理、模式识别、广义模糊随机场模型.间变换,使得该图像与另一幅医学图像上的对应点在解剖结构和空间位置上达到一致.当两幅图像配准后,我们可以对它们进行比较和分析.医学图像往往是在不同时间同一成像设备或者不同时间不同成Page2像设备上获取的,临床上常常需要将病人的图像信息融合起来,便于医生更准确地诊断和治疗疾病,而图像配准是图像融合的前提和关键步骤[1].在计算机辅助手术中,外科医生根据配准结果来精确定位病灶,以便进行手术跟踪[2].另外,图像配准在乳腺及肝部疾病的发现和治疗、心脏运动估计[3]、医学图谱的制作等方面也有重要意义.在医学图像配准中,相似性测度是其中的一个重要组成部分.常用的基于灰度的相似性测度有平方差(SumofSquaredDifferences,SSD)、绝对差(SumofAbsoluteDifferences,SAD)、相关系数(CorrelationCoefficient,CC)、互信息量(MutualInformation,MI).基于灰度的相似性测度只定义了对应像素的灰度关系,没有考虑像素之间的空间依赖性,对于增强前后的图像或含有灰度偏移场和噪声的图像,这类相似性测度鲁棒性差,往往不能产生满意的配准结果.Ardekani等人[4]提出在以每个像素为中心的小窗口内,用局部相关系数作为相似性测度.Hermosillo等人[5]通过局部化相关比和MI,提出一个局部相似性测度的框架.Zhao和Soatto[6]考虑到局部归一化互信息对明暗不均匀不敏感,全局归一化互信息不容易陷入局部极值的特点,从而将两者结合起来.这类基于局部相似性测度的方法认为在小邻域范围内,可将图像视为明暗均匀的.虽能对明暗不均匀的图像产生较好的配准结果,但由于在小窗口内进行统计,将会使目标函数产生更多的局部极值,且此类方法对噪声和出格点比较敏感.El-Baz等人[7]提出使用Markov-Gibbs随机场学习一幅图像的先验表观模型,再对第二幅图像进行变换使其概率最大.Wyatt和Noble[8]提出使用Markov随机场模型迭代地分割和配准图像的类标签.Zheng和[9]提出基于灰度相似性测度的最大后验概率-Zhang马尔可夫随机场框架.这些基于MRF的方法严重依赖于局部灰度的关系和初始参数的选择.Friston等人[10]提出使用非线性灰度变换和卷积滤波对图像进行灰度校正,再使用SSD测度进行图像配准,但针对不同的问题,必须手动选择不同的卷积滤波.Ashburner和Friston[11]提出关于联合配准、灰度归一化和分割的概率框架,这类方法虽然可以产生较准确的配准结果,但需要手动选择参数且计算量大.Myronenko等人[12]提出基于残差复杂性(ResidualComplexity,RC)的相似性测度,通过解析方法求取灰度偏移场并推导出RC.与前述方法的不同之处在于,RC的表达式中不含灰度偏移场,从而自适应地约束了灰度偏移场,保证了需要配准的两幅图在灰度空间上的一致.但该方法对参数较敏感、抗噪能力较弱、鲁棒性较差.这是因为传统RC对残差图像中出格点、噪声点和其它点的约束相同,即没有考虑残差图像自身的特征,因而产生误配.鲁棒估计是基于鲁棒统计学提出的,主要研究能够容忍一定量离群数据的估计问题.为了减少出格点或噪声点对目标函数的影响,受鲁棒估计[13]的启发,本文利用参考图像的局部方差构造权重函数,在残差图像灰度值比较大的地方,分配小的权值,而在残差图像灰度值比较小的地方分配大的权值.将加权后残差图像的残差复杂性作为新的相似性测度.2残差复杂性假设待配准图像犐和犑存在如下关系:其中:S是灰度偏移场,η是均值为零的高斯噪声,τ为变形场.通过最大化后验概率的方法估计S和τ.P(τ,S犐,犑)∝P(犐,犑τ,S)P(τ)P(S)(2)假设S和τ独立,P(犐,犑|τ,S)是似然项,P(τ)是变形场τ的先验,P(S)是灰度偏移场S的先验,一般可用P(S)∝e-β犘犛E(犛,τ)=犐-犑(τ)-犛2+β犘犛2(3)其中,犐,犑,犛分别为参考图像、浮动图像、灰度偏移场的矢量表示.计算式(3)关于犛的导数并置为0,可以求取灰度偏移场犛,并将犛代入式(3),得其中犐犱为单位矩阵,狉=犐-犑(τ)为残差图像.由于方阵犘犘T对称且半正定,所以可以进行谱分解犘T犘=犙Λ犙T,Λ=d[λ1,…,λN],λi0,则其中:d()表示对角矩阵,犃=犙犔犙T,犔=d(l1,…,lN)=d(βλi/1+βλi),1li0.算子犘犘T有相同的特征向量基犙、不同的特征值.我们使用DCT作为特征向量的基.因为犔是λ的函数,由此当犔为单位矩阵时,E(犔,τ)=狉2即为SSD测度,这等价于对灰度偏移场犛不施加任何约束.当犔为零矩阵时,目标函数E获得了我们并不感兴趣的最小值.为了避免上述情况的发生,对犔施加约束Page3其中R(犔)=-∑i[狇1,…,狇N],狇i为特征向量.对目标函数(7)求取关于犔的导数,并置为0,可以得到犔的表达式,将其代入式(6),可得基于RC的相似性测度的表达式:E(τ)=-∑3基于局部方差与残差复杂性的图像配准3.1局部方差图像的局部方差[14],可以表示图像局部区域中各个像素之间的关系,体现了图像的结构信息.图像犐的局部方差可以表示为V(x,y,z)=R为计算局部方差的邻域半径,N=(2R+1)×(2R+1)×(2R+1)为邻域大小,图1显示了一幅脑部MR图像在邻域大小为N=3×3、N=5×5、N=7×7下的局部方差图.图1脑部MR图在不同邻域大小下的局部方差图匀质区域内局部方差小,非匀质区域处的局部方差大.N较小时,局部方差图包含的图像信息更清楚、更丰富;N较大时,局部方差图包含的图像信息相对模糊.N会影响局部方差图的平滑性.3.2基于局部方差与残差复杂性的相似性测度统计学中,出格点被认为是一组数据中的离群点,容易对统计产生负面影响,使得统计结果受到严重挑战.鲁棒估计最初源于鲁棒统计学,主要研究能够容忍一定量离群数据的方法,即当观测数据中,部分样本不符合统计模型假设时,如何保证参数估计和统计推断的准确性.传统的鲁棒估计有M-估计、LMedS估计、LTS估计、MCD估计等.其中,M-估计在运动估计中应用的基本思想是通过选择不同的损失函数实现加权最小二乘估计,抑制离群数据的影响,从而实现鲁棒估计.图2(a)、(b)为待配准的两幅乳腺图像,图2(c)为图(a)与图(b)的残差图像.对照图2右侧的灰度条可知:在残差图像中,像素的亮度越亮(越接近灰度条中200)或越暗(越接近灰度条中-200)表示残差值越大,像素的亮度越灰(越接近灰度条中0)表示残差值越小.观察图(c),不难发现:在残差图像中,未配准区域的残差值较大.残差图像中残差值较大的像素点通常可以视为出格点或者噪声点.为了抑制出格点或噪声的影响,受M估计的启发,我们需要设计一个权重函数,该函数可以容忍大的残差值,可以使用不同的函数值来加权不同像素的残差值.当残差值较大时,权重函数值较小,当残差值误差较小时,权重函数的值相对较大.也就是说,对于出格点或者噪声点,权重函数给予较小的惩Page4罚约束,对于其余点则给予相对大的惩罚约束.另外,我们发现未配准区域的残差值比较大,对应着局部方差比较大的区域.由于图像的局部方差,可以表示图像局部区域中各个像素之间的关系,体现了图像的结构信息.因而,我们可以充分利用图像自身的信息构造权重函数,以此来自适应地加权残差图像中的像素灰度值.为了满足上述的自适应的加权法则,我们引入局部方差,利用指数函数构造权重函数:V(x,y,z)0,显然,0<ω(x,y,z)1,m×n×s为图像体素的数量.用p=V(x,y,z)∑V(x,y,z)来表示归一化的局部方差.由于归一化的局部方差p的取值普遍偏小,使得ω的取值过于集中,将导致残差图像中不同灰度值的加权值非常相近,这与实际情况相违背.因而,我们加入系数ε来调节权重ω范围的参数.则实验中取经验值ω=0.01,使得归一化后ω的最小值接近于0,而最大值接近于1.由此,将式(12)代入式(8)中,得到新的相似性测度(LVRC)可以表示为E(τ)=-∑其中,ω为权重矩阵,ω(x,y,z)是ω的元素.比较式(8)与式(13),不难发现,式(8)没有使用加权函数ω来加权残差图像,即残差图像所有体素的灰度值图4不同相似性测度的曲线的权值均为ω=1.如果对残差图像中出格点或者噪声点分配的权值等同于对残差图像中其它体素分配的权值,则会扩大出格点或噪声点对目标函数的影响.因此,本文引入一个由局部方差构造的加权项来有效地解决上述问题.为了减少出格点或噪声点对目标函数的影响,当残差图像中体素的灰度值较大时,加权函数分配其较小的权值,反之,残差图像中体素的灰度值较小时,加权函数给予其较大的权值.下面是一组明暗不均匀的灰度带图像,分别使用SAD、MI、RC以及LVRC测度进行图像配准的对比实验.该实验旨在说明相似性测度的特性.图3(a)为参考图像,对图3(a)对称裁剪,并施加灰度不均匀场得到图3(b),定义其为浮动图像.先将浮动图像图沿着x轴平移-50~50像素,再计算相似性测度.显然,当浮动图像平移0个像素时,两幅图像达到完全配准.SAD、RC、LVRC值达到最小,MI值达到最大.图4描绘了使用不同相似性测度的曲线图,显Page5然SAD和MI均不能在两幅图像正确配准时达到最值;RC值和LVRC值在浮动图像平移的像素为零时,曲线值均达到最小,但RC不够平滑,且多处出现局部极小值,而LVRC曲线平滑性好,无局部极小值.3.3基于局部方差与残差复杂性图像配准本文使用自由形变模型(Free-FormDeforma-tion,FFD)建模变形场T[15],FFD是一种空间变换模型,通过先求取网格控制点处的位移量,再使用B样条插值求得图像中每个像素点的位移量而获取变换后的浮动图像.浮动图像犑中任意一个体素点(x,y,z)的形变可以通过B样条加权相邻的4×4×4控制点的位置来表示:l=0∑τ(狓)=∑φ为控制点的位置,网格大小为nx×ny×nz.Bl是B样条的的第l个基函数.i=x/nx-1,j=y/ny-1,k=z/nz-1,u=x/nx-x/nx,v=y/ny-y/ny,w=z/nz-z/nz.本文选用梯度下降法迭代地优化目标函数,进而更新变形场.我们提出的LVRC的导数表达式如下:E=-狇-12狇(狉ω)/α其中:狇和狇-1分别表示正向和逆向的离散余弦换;犑为浮动图像的梯度;θ表示变换参数;α为约束犔的权重,见式(7).本文提出的基于LVRC的算法的流程如图5所示.首先,计算参考图像的局部方差图,利用该局部方差图构造指数函数形式的加权函数.再计算参考图像和浮动图像之间的残差图像.使用加权函数自适应地加权参考图像和浮动图像之间的残差图像,从而得到本文提出的相似性测度LVRC.本文利用梯度下降法迭代地更新变形场,再使用FFD变换更新浮动图像.如此循环,直到得到最优的变形场,最终输出变形后的浮动图像.为提高计算效率,避免陷入局部极值,采用多分辨率技术优化配准过程.在当前水平获得的变形参数值将作为下一水平参数的初始值.由于在一个分辨率水平下,参考图像不变,所以参考图像的局部方差图只需计算一次.图5的虚线框表示每次迭代所包含的步骤.4实验结果和分析为了验证LVRC具有对参数值不敏感、抗噪能力强、鲁棒性好等特点,我们用Matlab7.12.0在PC机(IntelCore2QuadCPU2.33GHz,8GB内存)上进行实验,并与MI和RC进行了比较.定义绝对残差图像为配准后两幅图像相减后的绝对值.为了评估配准效果,我们以配准后两副图像的互信息MI、绝对残差图像的均值μ和方差σ作为评价标准.为了避免混淆,用MIsim表示配准后两幅图像的互信息.μ、σ的值越小,表明配准的精确度越高,反之,配准效果越差.若MIsim的值越大,则参考图像和最终变换后的浮动图像间的相似程度越大,即配准效果越好,反之亦然.实验1.噪声和灰度偏移场对配准的影响.实验选用源于BrainWeb①的脑部MR数据.我们对其进行人工形变并施加灰度不均匀场和不同程度的高斯噪声.图6显示了待配准的两组图像.图6①http://mouldy.bic.mni.mcgill.ca/brainweb/Page6(a)、(b)为第1组待配准的两幅图像,其中图6(a)是加入均值为0、方差为0.01的高斯噪声后的脑部图像,图6(b)是加入均值为0、方差为0.001的高斯噪声后的非均匀脑部图像.图像6(c)、(d)为第2组待配准的两幅图像,均是加入均值为0、方差为0.001的高斯噪声后的明暗不均匀的脑部图像.我们将图6(a)、(c)作为参考图像,图6(c)、(d)作为浮动图像.分别使用MI、RC、LVRC这3种测度进行配准对比实验.第1组实验的参数取值为α=0.8,网格间距δ=8,第2组实验的参数取值为α=0.6,δ=7.图7的两列分别对应两组实验的结果,3行分别对应使用MI、RC、LVRC方法配准后的结果图,包括变换后(配准后)的浮动图像和形变网格.观察第1组实验结果发现:使用MI测度后的浮动图像在脑部多处均未配准,且形变网格出现大的折叠现象;使用图73种方法配准后的浮动图像和形变网格实验2.局部方差邻域尺度对配准的影响.本实验旨在验证局部方差的邻域尺度N是否会对局部方差产生影响.图8为两组真实的乳腺动态增强磁共振图像(DCE-MRI).图8(a)、(b)分别对应病人1在增强后不同时间的乳腺图像,图8(c)、RC的只在脑桥处没有配准,且形变网格在小范围内出现折叠现象,而使用LVRC的在脑部各处均配准且形变网格光滑,并未出现折叠现象.观察第2组的实验结果发现:使用MI后的浮动图像完全误配,且形变网格出现大规模的折叠现象;使用RC后的在直回、眶回、眶内眼球和脑壳处没有配准,形变网格在小范围内出现折叠现象;而使用LVRC的方法在脑部各处均配准且形变网格光滑,未出现折叠现象.这是由于MI对噪声敏感,易受明暗不均匀性的影响;RC可以自适应地约束灰度偏移场,所以配准结果比MI有所提高,但该方法的鲁棒性差,如图7中的第2行,形变网格出现折叠现象.而本文算法利用参考图像的局部方差信息,针对残差图像自身的特征赋予不同的权重,使得配准效果明显提升.可见MI不适合处理明暗不均匀图像,而LVRC优于RC配准.(d)分别对应病人2在增强后不同时间的乳腺图像.由于增强后,造影剂会逐渐地被人体代谢,因此可将增强后不同时间的图像视为明暗不均匀的图像.定义图8(a)、(c)为参考图像,图8(b)、(d)为浮动图像.该实验使用LVRC在N=3×3,N=5×5,N=Page77×7下,对这两组乳腺DCE-MRI进行配准.图9两组实验在不同邻域尺度下配准结果图10不同邻域尺度下的局部方差的配准结果本实验中,图9显示了3个不同的邻域尺度下,使用LVRC配准前后的绝对残差图.第1行为使用病人1的图像进行实验的结果图,第2行为使用病人2的图像进行实验的结果图.显然,使用LVRC配准可以提高配准精确度.然而,计算局部方差选用的邻域尺度对配准结果并无太大影响.为了更准确地分析邻域尺度是否对配准结果有影响,我们对两组实验结果进行了关于μ和MIsim的定量分析.图10(a)中病人1、病人2分别对应上述两组实验,柱状图中,纹理“\”表示配准前的μ,纹理“-”、“×”、“·”分别对应3个邻域尺度下的μ.显然使用LVRC后的配准结果比配准前有很大提高.另外,当邻域尺度N改变时,μ和MIsim数值变化的数量级范围在[10-2,10-3],即取值非常接近,因而在实际中可以忽略不计.由此可以看出,无论从定性还是定量上分析,局部方差的邻域尺度对图像配准的结果并无太大影响.Page8实验3.网格间距对配准结果的影响.本实验采用乳腺DCE-MRI,如图11(a),定义其为参考图像.对该图像进行人工变形并施加少量不均匀性,将此图像定义为浮动图像,见图11(b).分别使用RC和LVRC在δ=6和δ=10时进行图像配准,采用N=3×3.本部分的所有实验均使用相同的参数α=0.05.图12的第1行、第2行分别显示了δ=6,δ=10的配准结果.图12(a)、(c)分别为使用RC配准后输出的浮动图像和形变网格,图12(b)、(d)分别为使用LVRC配准后输出的浮动图像和形变网格.当网格间距δ=6,使用RC配准后的浮动图像在多处未配准,且最终的形变网格也出现不同程度的折图12不同网格大小的配准结果我们在不同网格间距下,分别使用RC和LVRC对配准结果进行统计.包括μ,σ,MIsim.由表1发现:当网格间距一定时,使用LVRC测度配准后的μ,σ总是要比使用RC测度配准后的小;且使用LVRC测度配准后的MIsim总是比使用RC测度配准后的大.这说明在处理明暗不均匀图像时,LVRC测度比RC测度更有效.δ=10δ=6实验4.人工变形的2D数据.叠现象.当网格间距δ=10时,使用RC测度产生了完全错误的配准,且最终的形变网格也出现大范围的折叠现象,如图12所示.而利用LVRC进行配准,得到的形变网格光滑、无折叠现象.取来自不同病人的4幅真实乳腺DCE-MRI,见图13的首行(a)~(d),定义其均为参考图像.对每一幅图像进行人工形变,并施加少量灰度不均匀性得到4幅形变图像,定义其均为浮动图像,见图13末行(e)~(h).本实验中,分别使用MI、RC和LVRC对这4组图像进行配准,并对配准结果作了定性和定量分析.本实验中,配准前两组图像时α=0.05,δ=6,配准第3组图像和第4组图像的参数分别为α=0.9,δ=8和α=0.5,δ=6.图14中每一列为使用3种测度配准一组图像后的实验结果;每一行代表使用一种相似性测度配准后产生的残差图像,从第1行到第3行依次为MI、RC、LVRC.由右边的颜色条知,如果两幅图像成功配准,残差图像的灰度值为0,Page9否则残差值的绝对值较大,在视觉上表现为过亮或过暗的像素点.当使用我们提出的LVRC测度时,残差图中很少出现过量或者过暗的像素点,见图14的最后一行(i)~(l).当使用RC测度时,残差图中出现少量的过亮或者过暗的像素点,见图14的中间一行(e)~(h).当使用MI测度时,残差图中出现大量的过亮或者过暗的像素点,见图14的第1行(a)~(d).显而易见,LVRC是一种比MI或RC更有效的相似性测度.使用RC比使用MI配准后的效果图134个不同病人的真实数据以及人工变形的数据图14使用MI、RC、LVRC对4组病人数据配准后的残差图像有所提升.另外,乳腺图像中通常含有大量的噪声,从图中可以明显地观察到LVRC对噪声的鲁棒性好.为了更准确地反映配准结果,图15绘制了使用3种方法配准后的绝对残差图的μ和MIsim.显然,使用MI配准后产生的μ最大,其次是RC,本文提出的测度最小;而使用本文测度配准后产生的MIsim最大,其次为RC,最后为MI;这是由于LVRC考虑了局部方差信息,自适应地赋予残差图像权重,使得配准效果明显有所提升.Page10图153种配准方法的配准结果实验5.真实数据.为了有效地帮助医生更多地获取信息来准确地诊断肝脏疾病,常常需要配准平扫图像和增强图像.该实验取3D肝部增强数据对LVRC测度进行验证.文中采用的增强前后的3D肝脏数据由天津医科大学总医院提供,由飞利浦64排CT在注入造影剂后的动脉期和静脉期扫描获得.图像大小均为512×512×397,体素大小为0.68mm×0.68mm×0.50mm.分别使用RC和LVRC进行比对实验,并对配准结果做了定性和定量分析.分别将增强后的图像(图16(a))、增强前的图像(图16(b))定义为参考图像和浮动图像.该实验取参数α=0.0001,δ=5,为了便于观察,图17显示了配准前后的三视图,第1列到第3列图173D数据配准前后的绝对残差色图分别为配准前、使用RC和LVRC配准后的绝对残差色图.首行(图17(a)~(c))分别为横断面第90层的绝对残差色图,中间行(图17(d)~(f))为冠状面的第64层绝对残差色图,末行(图17(g)~(i))为矢状面第83层的绝对残差色图.虽然使用RC配准Page11的结果比配准前有所提高,但并没有使得增强前后的图像完全配准,具体可见各器官的边缘处.LVRC结合参考图像的局部方差信息,以指数函数的形式有针对性地自动约束残差图像.当残差值小时,赋予残差图像大的权重;当残差值大时,赋予残差图像小的权重.从而保证了目标函数的鲁棒性.同样地,即使两幅图像完全配准时,绝对残差色图像某些区域的残差值仍然不小,这是由于注入造影剂引起的.同样地,我们对使用RC测度和LVRC测度的配准结果进行定量分析,包括均值μ、方差σ、相似性MIsim.表2列出了配准前后的统计结果.不难发现,使用RC测度和LVRC测度配准后的结果均比配准前的结果有所提高.在数值上表现为μ、σ减小、MIsim增大.这进一步说明:对于明暗不均匀图像的配准,LVRC是一种比RC更有效的相似性测度.配准前RCLVRC5结论图像的局部方差信息描述了局部区域中各像素之间的关系,反映图像信息的丰富程度.受鲁棒估计的启发,我们利用局部方差构造权重函数,在图像残差比较大的地方,给予小的权重约束,而在图像残差比较小的地方,给予大的权重约束从而得到新的相似性测度,减少了出格点和噪声点对目标函数的影响.我们使用5组对比实验来验证该算法的可行性.结果表明:MI不适合处理非均匀图像,而LVRC算法具有对参数值不敏感、抗噪能力强、鲁棒性好等特点,比RC更适用于非均匀医学图像的配准.然而,我们对LVRC的计算是以参考图像与浮动图像之间的残差图像为基础的.因而本文提出的相似性测度有一定的局限性:只适用于单模态图像配准.后续工作可以考虑将该方法扩展到多模态图像配准中.
