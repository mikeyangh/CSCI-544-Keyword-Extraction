Page1SAM:一种容错的末级缓存可扩展地址映射方法李崇民汪东升王海霞薛一波(清华信息科学技术国家实验室(筹)北京100084)摘要随着半导体工艺进步,多核处理器超过60%的片上面积由片上缓存占据.由于特征尺寸缩小及供电电压下降,片上缓存较以往更容易发生错误.缓存错误包括可恢复的软错误(softerror)及不可恢复的不稳定位(erraticbit)失效.传统容错技术主要研究针对单个缓存模块的保护.当缓存中包含成百上千个模块时,即使单个缓存模块出错的概率很低,系统中有一个或多个缓存出错的概率也相对较高.文中提出可扩展地址映射(SAM)方法,支持对可缓存地址空间灵活高效的映射,提高末级缓存的可靠性.通过对末级缓存地址空间进行重构,只要有末级缓存模块可以工作,SAM就能够保证系统正确运行.SAM可应用于共享或集群缓存组织方式.文中提出的算法能根据末级缓存中出错缓存模块的数目变化,动态调整集群缓存组织方式下的集群大小.实验结果表明,SAM方法可在多种出错环境下保证系统功能正确,且性能平滑下降.关键词多核处理器;高速缓存;地址映射;容错;可靠性1引言随着半导体工艺不断进步,每一代产品的集成度都在增加,在一个芯片上可以集成多个处理器核.在不久的将来,片上多处理器中会包含有成百上千个处理器核[1].片上存储资源也将占据超过60%的芯片面积,缓存的可靠性对芯片的可靠性有较大影响.导致片上缓存错误的原因主要有粒子撞击(软错误)或不稳定位(erraticbit)失效[2].软错误是瞬时的、可恢复的,而不稳定位失效是不可恢复的.这两种错误都与工艺参数密切相关.随着特征尺寸减小,出错概率呈指数式增加.许多研究关注高速缓存的可靠性,如CPPC[3]、ZerehCache[4-5]等,这些技术为单个缓存模块(module)提供容错机制.目前片上多处理器的缓存普遍采用非均一性缓存结构[6](Non-UniformCacheArchi-tecture,NUCA),末级缓存由多个缓存模块组成,目的是减少数据访问的延迟与竞争①.即使单个缓存模块出错的概率很低,片上所有缓存模块中有至少一个模块出错的概率还是相当可观的.NUCA结构中,末级缓存的可缓存地址空间由所有缓存模块组成.当一个模块出现不可恢复错误时,整个地址空间的完整性将被破坏,影响到整个缓存系统的正确性.这比某个一级缓存出现不可恢复错误更加严重,因为系统可以关闭出错的一级缓存模块,在损失部分性能后系统仍然能够正确运行.目前的相关研究主要关注单个缓存模块的可靠性,考虑末级缓存系统整体可靠性的研究较少.本文提出可扩展地址映射(SAM)方法,可以在大规模缓存系统中进行灵活的地址映射.当末级缓存中有缓存模块出现不可恢复错误时,SAM将缺失的那部分地址空间重新分配到其他功能正常的缓存模块来重构可缓存地址空间.在重新配置之后,可缓存地址空间重新变得完整,系统可以继续运行,因此能够提高系统的可靠性.极端情况下,SAM可以保证系统在所有末级缓存全部失效之前,系统仍然能正确运行.SAM可应用于共享与集群缓存组织方式.在集群组织方式(clusterorganization)下,当出错缓存模块数目过多时,SAM可以动态将集群规模调整到一个适当大小并保证性能的平滑下降.SAM可与其它末级缓存容错技术共存.本文对64核瓦片(TILE)结构的片上多处理器进行模拟实验,结果表明,SAM可以在不同出错情况下保证系统性能的平稳下降.本文主要工作包括:(1)指出在末级缓存中,即使单个缓存模块出错的概率很低,但整个系统中存在出错缓存模块的概率相对较高.(2)提出可扩展地址映射方法,可以以较小硬件代价完成可缓存地址空间的重新构建.(3)在SAM对地址空间重构过程中,能够动态调整集群组织方式下每个集群规模的大小,以保证缓存性能的平滑下降.2背景与动机2.1背景在当前多数片上多处理器中,SRAM缓存占据了一半以上的芯片面积.缓存出错通常由缓存位失效引发,缓存位失效可以分为永久失效与非永久失效两大类.永久性失效主要是由随机掺杂波动[7](RandomDopantFluctuation,RDF)引起的.Kulkarni等人[8]指出缓存位失效的概率随着供电电压的下降成指数上升.永久性失效对芯片的产出率有较大影响,但在对多处理器缓存可靠性的影响中所占比例不大.非永久性失效包括软错误和不稳定位失效[1].其中软错误由宇宙射线/粒子撞击导致,软错误已对微电子工业产生影响,有厂商称软错误已经成为客户站点中断的主要原因[9].软错误属于瞬时错误,可以通过如ECC[10]纠错码等方式纠正.不稳定位失效会导致SRAM单元Vccmin的波动[11],不过很难得到关于不稳定位失效的详细信息与物理模型.在低供电电压情况下,不稳定位失效会直接导致一个缓存单元的故障率升高,需要引起重视.单个缓存单元的可靠性通常用FIT(FailuresInTime)表示,即一个缓存单元在109个小时内的故障次数.非永久性失效发生的概率随着工艺的进步而不断上升,研究表明,每一代工艺进步,单个缓存单元发生软错误的概率增加约8%[12].根据摩尔定律,每一代产品芯片上的晶体管数目约增加一倍,因此芯片上缓存出错的概率成指数式增加.例如将来16nm工艺下芯片的失效概率是180nm工艺下的100倍左右[12].老化现象也对晶体管性能有较大影响,导致晶体管的饱和电流逐渐降低.研究认为当工艺达到32nm后老化现象会更加明显.在45nm工①为简单起见且不失普遍性,本文假定片上共有两级存储,二Page3艺下,缓存单元的临界电压(thresholdvoltage)会有30mV的标准差,缓存的出错概率会达到10-3[13].当特征尺寸减小时,缓存的出错概率会更高.图1给出了元器件在不同工艺中,时间与电压的可靠性变化趋势.除了缓存单元出错之外,一个缓存模块还会受其它故障的影响,如控制逻辑出错,数据链路断开,缓存中的标志或目录出错等[14],实际上缓存模块的出错概率还会更高.2.2动机对采用NUCA结构的片上多处理器,如果一个末级缓存模块出错,则整个末级缓存将无法工作.假定末级缓存中共有n个缓存模块,每个缓存模块出错的概率是p,且各缓存模块之间相互独立,则整个末级缓存出错的概率为图2(a)给出了缓存模块数目从64增加到2048,p为10-4~10-3时,整个末级缓存出错的概率.当p=10-3,n>128时,整个末级缓存的出错概率超过了10%.当n>1024时,即使p=10-4,整个末级缓存的出错概率也超过了10%.因此末级缓存的可靠性设计面临巨大的挑战.当末级缓存中包含成百上千个缓存模块时,虽然至少一个缓存模块出错的概率相当高,但多个二级缓存模块同时出错的概率是相对较低的.n个模块中有m个出错的概率为图2(b)给出了在不同缓存模块数目n下,恰好有m个缓存模块出错的概率.若有一种具有容错能力的设计方案,在包含n个缓存模块的末级缓存结构中,能够容忍不多于m个缓存模块出错,整个缓存系统功能正常的概率为图3给出在不同n值和m值下缓存系统功能正常的概率.例如当p=10-3,n=1024时,如果能够允许不超过5个缓存模块出错,整个系统功能出错的概率小于10-4.式(3)是本文提出的可扩展地址映射方法的动机.SAM通过对可缓存地址空间进图3如果能容忍m个缓存模块故障,系统功能完好的概率Page4行重构,能在多个二级缓存模块出错的情况下保证系统正确运行.针对集群组织方式,SAM能动态调整区域的规模.SAM保证只要有一个末级缓存模块工作,缓存系统就能正确运行,这同时也允许系统通过关闭部分二级缓存模块来降低系统功耗.3相关工作提高系统可靠性的研究主要可以分为三部分:首先是电路级解决方法,此类方法目标是提高单个缓存单元的可靠性.动态电压/频率调整(DVFS)技术对较易出错的SRAM单元施以较高的电压或较低的频率.此类方法需要识别出一列缓存单元中最易出错的那一个,同时访问延迟也是由最易出错的那个单元决定,因而会影响系统性能.其它研究试图去改变传统SRAM单元的结构以提高可靠性[8,15],代价是芯片面积增加.第二种方法是编码解决方法,此类方法适用于故障率较低且以瞬时错误为主的情况.错误检测码(EDC)与纠错码(ECC)[10]可用来探测/纠正缓存中的错误.二维错误检测码[16]将EDC同时应用到数据阵列的行和列上.多位纠错码可以容忍更高的出错概率,但会带来延迟、面积与功耗上的开销.CPPC方法[3]用两个寄存器对缓存中的写回操作提供奇偶校验保护.最后一类是利用体系结构方法来提高缓存的可靠性.最有效的提高存储结构可靠性的方法是多模冗余,但是其面积与功耗开销太大[17].冗余行或列可以提高存储结构的可靠性[18].有研究将多个损坏的缓存行/块/字合并成一个功能正常的缓存行/块/字[7,19-20],代价是增加了面积和访问延迟.NUCA结构[6]最早是由Kim等人提出,S-NUCA[21]可灵活支持不同的共享度(区域大小).Hammoud等人[22]提出了根据缓存缺失率及平均延迟来调整共享度的方法.此外还有将缓存划分为私有与共享区域[23]及将缓存用虚拟层次[24]进行组织的方法.4可扩展地址映射方案设计4.1常规地址映射NUCA结构通过地址映射确定每个可缓存地址所对应的缓存模块.常规地址映射可以分为三类:高位交错、低位交错和地址偏离(addressskewing).这三种映射方式实现较为简单,且具有确定性,即一个地址对应的缓存块只能存在于由地址映射所确定的缓存模块中.如果一个缓存模块出现故障,即使其它绝大部分缓存模块都功能正常,整个缓存系统也不能再正确工作.如果能够利用功能正常的缓存模块重新构建可缓存地址空间,缓存系统的可靠性将大大增加.要重建可缓存地址空间,就需要设计出新的地址映射方法,将可缓存地址空间重新分配到功能完好的缓存模块上.完成地址重新分配后,一级缓存需要知道去哪里寻找一个地址所对应的缓存块.为说明简便且不失一般性,本文应用一个16核TILE结构的片上多处理器来说明SAM机制的原理与实现.如图4(a)所示,所有节点通过二维mesh网络互连,每个节点中包括一个处理器核,私有的一级数据/指令缓存,和共享的二级缓存,通过路由器与片上网络连接.每一个二级缓存负责1/16的可缓存地址空间,并通过片上网络接收来自其它节点的请求.图4(b)给出了4×4集群的组织方式.H和R分别代表全局宿主与区域宿主节点.4.2共享方式下的可扩展地址映射在大规模片上多处理器中,末级缓存中一般采用目录一致性协议维护数据的一致性.在共享组织方式下,对每个保存在缓存中的数据,都有一个由地址映射确定的宿主节点,在该节点末级缓存中有对应的目录项来记录对应数据共享副本的位置.在一级缓存发生缺失时,会向对应末级缓存发送数据请求.如果宿主节点发生永久故障或者频繁的非永久Page5故障,属于该部分地址空间的数据就会失去控制,不能保证系统运行正确.如果缺失的地址空间可以重新映射到功能正常的一个或多个缓存模块上,就能保持系统正确运行.本文提出的可扩展地址映射(SAM)方法可以实现上述功能.图5用一个简单的例子来说明SAM容错功能的实现机制.示例系统中包含两个处理器核,末级缓存由两个二级缓存模块组成.在没有故障发生时,两个二级缓存模块都能正常工作,每个二级缓存模块负责一半的可缓存地址空间.如果其中一个缓存模块出现故障,则整个系统都不能正常工作.而通过应用SAM机制,可以将整个可缓存地址空间都映射到功能正常的二级缓存模块上,整个系统可以继续正确运行.此时所有一级缓存的请求都会发送到左侧完好的二级缓存模块,其接收的请求数量将会是之前的2倍.这会影响到系统性能,但系统仍能正确运行.设计SAM机制的关键是将整个可缓存地址空图6共享方式下的可扩展地址映射间重新分配给功能正常的缓存模块,从而提高末级缓存系统的可靠性.重新分配可缓存地址空间的关键是确定一个可缓存地址的宿主节点,这样一级缓存发生缺失后,就可以将请求发送到对应的二级缓存模块.因此一级缓存必须知道可缓存地址空间重新分配的方案.为解决上述问题,SAM在每个一级缓存中增加了一个全局宿主节点配置表(GlobalHomenodeConfigurationTable,GNCT).该配置表的项数与二级缓存模块数目一样,按照传统地址映射方式所确定的全局宿主节点编号进行索引.每个表项内容为新的全局宿主节点编号.当所有二级缓存模块功能正常时,表项中的内容与索引相同.当有二级缓存模块出现故障时,表项内容更新为经过对可缓存地址空间重新分配后的新宿主节点编号.图6给出了对16核片上多处理器可缓存地址空间进行重新分配的例子.最初所有二级缓存模块都正常工作,图6(a)中宿主节点配置表中的节点编号也与常规地址映射一样.当图6(b)中有一个二级缓存出现故障后,配置表中的内容被重置,其中第6个表项的宿主节点编号由5变为4.此时编号为4的二级缓存会承受之前约2倍的缓存请求.图6(c)和图6(d)给出二级缓存故障增加时配置表内容的变化情况.考虑到负载平衡,SAM将缺失的可缓存地址空间分布到多个二级缓存中,由于对全局宿主节点配置表的查找并不在缓存访问的关键路径上,对系统的性能不会产生影响.Page64.3集群方式下的可扩展地址映射随着片上处理器核数目的增加,共享组织方式下的目录存储开销也呈线性增加.例如当缓存行大小为64字节时,一个512核TILE结构的片上多处理器的目录存储开销与数据存储开销相等.采用集群组织方式可以节省目录存储开销,同时降低数据的访问延迟.集群组织方式具有较好的可扩展性,是设计未来众核存储系统的一种选择.在集群方式下,末级缓存被划分为多个区域,每个区域内的二级缓存可组成一个完整的可缓存地址空间.在一级缓存发生缺失时,首先向区域宿主节点发送请求,如果区域宿主节点缺失再向全局宿主节点发送请求.集群方图7集群方式下的可扩展地址映射实现如果一个区域中的故障二级缓存过多,该区域的缓存性能会受到较大影响.SAM提供重新调整区域大小的机制来减少这种影响,该机制的伪代码在图8中给出.该算法可以调整一个区域内的二级缓存模块数目.图9给出了两个例子来说明对区域大小的重新调整.在图9(a)中,只有L2-1出现故障,此时SAM将其地址空间重新分配到L2-0上,整个系统仍然由4个区域组成.而在图10(b)中,共有4个二级缓存出现故障,此时SAM将区域数目由4个减少到2个.通过动态调整区域规模,SAM可以避免缓存请求过多地集中到某个二级缓存,同时也能保证系统性能的平滑下降.由于每个区域内包含的二级缓存和一级缓存节点会在调整后发生改变,同时一个地址对应的区域宿主节点也会改变.此时在全局宿主节点需要记录每个区域宿主节点的位置,同时区域宿主节点也需要记录每个一级缓存子节点的位置.为记录这些信息,SAM在每个二级缓存中增加子节点配置表(SubNodeConfigurationTable,SNCT).SNCT由两部分组成,分别用来记录区域宿主节点的位置和式下区域宿主节点的确定通常采用常规地址映射方法.对任意一个可缓存数据,其区域宿主节点和全局宿主节点(可能会映射到同一缓存模块)都是确定的.为在集群方式下实现容错机制,SAM在一级缓存中增加了一个区域宿主节点配置表(RegionalhomeNodeConfigurationTable,RNCT),其结构与全局宿主节点配置表类似,只是每个表项中的编号是区域宿主节点.在集群方式下,全局宿主节点不再由一级缓存直接访问,而是通过二级缓存中的区域宿主节点访问,因此将全局宿主节点配置表移到二级缓存中.集群方式下SAM的具体设计如图7所示.一级缓存子节点的位置.SNCT依照节点在目录中的位置来索引,表项中的值则是子节点的具体编号,同时每个表项中增加1位以标记对应编号是区域宿主子节点还是一级缓存子节点.4.4可扩展地址映射的硬件开销共享组织方式下,SAM设计的硬件开销仅为全Page7图9集群方式下SAM自动调整示例局宿主节点配置表.配置表项数与二级缓存数目相同,每一个表项需要log2n位来存储新的全局宿主节点.共享方式SAM的硬件开销是nlog2n位.集群组织方式下,需要增加3个配置表,即全局宿主节点配置表、区域宿主节点配置表与子节点配置表.前两个配置表的硬件开销在最坏情况下与共享组织方式相同,而子节点配置表每个表项还需要额外1位来标记表项是二级缓存还是一级缓存.表1给出了在每个二级缓存模块大小为1MB时,不同规模的片上多处理器实现SAM机制所需的硬件开销.在1024核时,集群方式下SAM(SAM-C)的硬件开销要小于1%.表1每个缓存模块为1MB时SAM-C的存储开销节点数目HNCT+RNCTSNCT总开销/位占二级缓存64128256512102420485实验评测5.1实验设置为验证可扩展地址映射方法的效果,我们利用Simics①和GEMS[25]建立实验环境.Simics是一个事件驱动的全系统模拟平台.Wisconsin大学的GEMS在Simics的基础之上实现了完整的片上存储层次,为片上存储层次研究提供了平台.表2中给出了片上多处理器系统的配置,二级缓存与一级缓存的数据是全包含关系,片上网络中传输的是所有维护一致性所需的消息.为评估SAM的效果,本文分别将共享方式与集群方式作为对比的基准系统,同时分别用1个或8个二级缓存模块出错时的系统性能与缓存性能作为对比.表3给出了不同方案的简写及其描述.CMP规模缓存行大小L1I-Cache大小/相连度L1D-Cache大小/相连度L1延迟L1替换策略L2Cache大小/相连度L2延迟L2替换策略网络拓扑每跳延迟片外存储延迟①https://www.simics.net/Page8方案名称BASESAM-1SAM-8BASE-CSAM-C1SAM-C方式,有1个二级缓存出错SAM-C8SAM-C方式,有8个二级缓存出错实验选择的基准测试程序来自SPLASH-2[26]和PARSEC[27]测试程序集,这些程序覆盖科学计算及通用数据处理.表4给出了本文选择的测试程序及问题规模.本文采用执行时间作为系统性能的标准,并用平均片上延迟作为评价缓存性能的标准.负载名称fftluradixoceanfmmvolrend(vol.)barnes(barn.)cholesky(chol.)Tkl5.obodytrack(bod.)Simsmallfluidanimate(flui.)Simsmallx264vipsswaption(swap.)Simsmall5.2共享方式下SAM的性能图10给出了SAM-1和SAM-8方案下整个系图10共享组织方式下的系统性能图11共享组织方式下的缓存性能统与基准系统BASE相对比的性能.在SAM-8方案中,系统性能下降最大的程序为lu,下降了约10%,其它程序的性能下降幅度都低于7%.SAM-1和SAM-8的系统性能平均分别下降了1.9%和3.1%.图11给出了SAM-1和SAM-8的缓存性能.其中SAM-8在bodytrack程序上缓存性能下降最大,性能下降达15%.SAM-1和SAM-8的系统性能平均分别下降了2.0%和5.9%.5.3集群方式下SAM的性能图12给出了SAM-C1和SAM-C8方案下整个系统与基准系统BASE相对比的性能.在SAM-8方案中,系统性能下降最大的程序为volrend,下降了约9%.SAM-1和SAM-8的系统性能平均分别下降了1.0%和2.7%.图13给出了SAM-1和SAM-8的缓存性能.其中SAM-8在fluidanimate程序上缓存性能下降最大,达12%.SAM-1和SAM-8的系统性能平均分别下降了1.9%和4.3%.5.4敏感性分析为研究重建可缓存地址空间对缓存系统性能的影响,选择fft和radix程序测试从1个二级缓存故障直到32个二级缓存故障时的缓存系统性能.图14和图15分别给出了共享方式与集群方式下缓存系统的相对性能.在共享方式下,fft与radix的缓存性能分别平滑下降到了基准系统的69%和80%.在集群方式下,最初系统是由16个区域组成,每个区域内包含4个节点.当出故障的二级缓存数目超Page9图12集群组织方式下的系统性能图13集群组织方式下的缓存性能图14共享组织方式下缓存性能下降曲线过16时,SAM-C将系统动态调整为4个区域,每个区域包含16个节点.从图15中可以看出,当二级缓存故障数目达到17个时,缓存系统的性能出现了波动,这说明了动态调整片上区域划分方法的效果.图15集群组织方式下缓存性能下降曲线6结论片上多处理器的片上末级缓存通常采用NUCAPage10结构,即使单个缓存模块的出错概率较低,当NUCA中包含成百上千个缓存模块时,整个缓存出错的概率也较为可观.本文提出可扩展地址映射(SAM)方法,目的是提高片上末级存储系统的可靠性.SAM在不十分可靠的缓存模块基础上构建了高度可靠的片上存储系统.SAM的硬件开销较小,对由1024个1MB模块组成的二级缓存,实现SAM所需的硬件开销小于1%.SAM能够在相当数量的二级缓存出现故障时保证系统的正确运行.SAM机制可以应用在共享缓存组织方式和集群缓存组织方式下.在集群方式下,SAM可以通过动态算法选择一个适当的区域大小.模拟实验表明,在两种组织方式下,SAM都能够实现系统性能的平滑下降.SAM可以与其它提高系统可靠性的方案共同工作.SAM对提高将来大规模众核处理器存储系统可靠性是一个可行的设计方案.
