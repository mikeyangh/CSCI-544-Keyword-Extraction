Page1基于Snake模型的血管树骨架三维重建技术曹治国1)彭博1),2)桑农1)张天序1)1)(华中科技大学图像识别与人工智能研究所武汉430074)2)(湖北航天技术研究院总体设计所武汉430034)摘要从两幅不同角度的造影图像实现血管树的三维骨架重建,传统重建方法常常需要较多的人工干预,才能为每一点找到准确的对应点.文中研究了一种基于Snake模型的重建方法.它在采用多尺度Gabor滤波提取造影血管中轴线的基础上,选取血管树分叉点,优化几何变换矩阵,提高用以初始化Snake的对应点的准确性;然后,针对血管的特性,文中采用GVF(GradientVectorFlow)流量场作为三维Snake的外部能量场,并给出最小化血管Snake模型能量函数的表达式,使Snake保持自身平滑连续的同时在空间中发生形变以逼近真实轮廓.实验结果表明,该方法与传统的重建方法相比,不但减少了人工干预,而且有效地提高了重建精度.关键词血管造影;三维重建;Snake模型;GVF1引言依据.血管的三维重建技术不仅能为医生提供形象、直观的三维血管形状图像,而且可以辅助测量血管的有关参数(如直径大小、血管长度和截面积等),从血管造影图像(DSA)是临床诊治冠心病的主要而有助于冠心病的诊断和治疗.因此根据血管造影Page2图像重建血管的三维骨架具有很好的临床意义和很高的应用价值.在传统的双平面造影图像重建方法中,大部分都是采用自底向上的重建方法,这种方法是基于图像的特征提取并通过找到每一对对应点进行重建[1-2].这类方法最大的问题是,找到全部完全准确的对应点很困难,从而使得重建结果不精确.一些研究人员在寻找对应点方面做了大量的改进[3-4],这些方法虽然提高了寻找的对应点的精确度,但同时也大大增加了计算的复杂性和计算量.文献[5]提出了采用Snake模型[6]重建血管造影图像的自顶向下的方法,与传统的方法相比,它只需选用少量可以描述血管轮廓的点作为对应点即可,并且Snake的自动性较好,它通过同时结合两幅图像上的特征,使Snake在空间中不断发生形变,从而逼近真实轮廓,获得较高的重建精度.Radeva和Toledo等在此基础上重新定义了Snake的外部能量场,并给出了基于三维Snake模型重建任意角度的造影图像的一般方法[7].上述这些工作都只给出单根血管的重建方法,并且他们是将血管分割与重建同时进行的,由于成像质量的影响和分割技术的局限性,影响了寻找的对应点之间的准确性,并最终影响重建精度.文献[8]则是采用Snake模型实现血管树骨架三维重建,不过,它与上述文献均未考虑对成像参数的校正,而未经校正的造影系统的参数(如造影角度、X射线源到接受平面的距离等)总是不可避免地存在一定的误差,从而造成在实际应用中所得结果也会产生一定误差.针对这些问题,本文研究了一种基于Snake模型的血管树骨架三维重建方法.它在采用多尺度Gabor滤波提取造影血管中轴线的基础[9]上,根据血管中轴的树状结构选取血管树分叉点,用以优化几何变换矩阵,提高用以初始化Snake的对应点的准确性;然后,本文针对血管的特性,提出采用GVF(GradientVectorFlow)流量场[10]作为三维Snake模型的外部能量场,并给出血管的非闭合轮廓能量函数最小化的最佳表达式,使Snake保持自身平滑连续的同时在空间中发生形变以逼近真实轮廓.由于采用多尺度Gabor滤波器提取中轴的方法我们已在文献[9]中进行了详细的描述,因此,本文不再赘述,其它内容则按以下结构组织:第2节简单给出X射线造影系统的几何描述和基于几何关系重建的一般方法;第3节介绍初始化Snake,并给出利用对应点对优化几何变换矩阵方法;第4节分析利用Snake重建三维血管树的过程;最后,对实验结果进行讨论并出结论.2造影图像几何关系标准的造影设备由两个独立的、可以自由旋转的X光系统组成[11].两个旋转轴可以在水平和垂直方向上运动.两光轴交于光心O,X光源A,B到两图像平面的距离SIDA,SIDB已知.三维的坐标重建需要一个世界坐标系.我们假设两光轴互相垂直,世界坐标系的原点在光心,X,Y,Z轴如图1所示,A点发出的光线与X轴重合,B点发出的光线与Z轴重合.A,B各自的坐标系如图1,uAvA为平面A上的坐标系统,uBvB为平面B上的坐标系统.另外存在世界坐标系的同时,光源A,B也存在各自的坐标系.在图1中,A光源坐标系的x轴与世界坐标系的X轴重合,y,z轴分别与Y,Z轴平行.假设P点在光源A坐标系下的坐标为(xA,yA,zA),在光源B坐标系下的坐标为(xB,yB,zB).则它们之间满足的关系可以写为其中(犚,狋)为几何变换矩阵,与造影角度和X射线源到接受平面的距离等有关[11].犚是旋转矩阵,狋是平移向量.图1双平面造影系统结构(两光源夹角为90°)在此三维空间中,一个点P在一幅图像上的投影可以定义为光源发出的光束经过该点与图像平面的交点PA,PB,如图即为直线APA,BPB的交点.当两幅图像上的对应点已知,两条光线将在空间中交于一点.在这种情况下,如果成像系统的几何关系已知,并且一对对应点已找到,空间中的三维点是可以重建出来的.然而实际的情况是,这两束光线可能并不相交,Page3如图2,这主要是因为系统的误差和图像间几何关系的不精确度造成的.为了解决这个问题,一般是将到两条直线距离最近的点作为真实的点的存在位置[2],如图2.3基于几何变换矩阵优化的Snake模型初始化对于传统的重建方法而言,找到准确的对应点是十分重要的工作.其准确与否直接影响到重建的结果.文献[3-4]在寻找对应点方面做了大量的改进.而一些研究人员[5,7-8]则把三维的Snake模型应用于血管的重建上,避免了为血管上的每一点寻找对应点的问题,只需要寻找若干对对应点(如起止和分叉点)即可描述出血管的大致轮廓.再结合Snake投影到两幅图像上的信息使Snake不断发生形变,直到它的投影与两幅图像完全重合.Snake是一个含有参数的模型[6],它实际上是一个可以不断发生形变的参数样条曲线,三维Snake模型定义为v(s)=(x(s),y(s),z(s)),其中x(s),y(s),z(s)为Snake上沿X,Y,Z轴的分量,s为弧长参数,在[0,1]之间.为了得到血管的三维Snake模型,我们需要重建几对对应点作为样条曲线的控制点,从而能够表达三维血管的大致轮廓.一旦定义了初始的Snake模型,Snake就可以根据它在两幅图像上的投影与原图特征的结合使Snake自身的形态逐渐发生改变.与此同时,Snake自身的特点也会保持本身的平滑与连续性.为了得到血管的初始Snake轮廓,对于单根血管而言,需要两对以上的对应点按照第2节所述的几何关系对它们进行重建,从而得到三维空间中血管的大致轮廓,初始化Snake.对于血管树,由于其特殊的树状结构,文献中一般给出血管的起止点,并选定分叉点描述血管,进行Snake初始化,如图3(a)所示.如果血管形态较为复杂,则对于弯曲度较大的部分,只选取起止,分叉点描述血管的初始轮廓是不够的,此时需要多寻找几个点才能较好表达血管形状如图3(b)中的参考点.在一幅已提取血管中轴的图像上选定了一组描述血管大致轮廓的点后,需要在另一幅图上找到它们的对应点.虽然采用Snake模型后,需要求取的对应点大为减少,但对应点间的匹配准确性仍非常重要.尽管对于血管树特殊的树状结构而言,可认为分叉点是准确对应的,但对于除分叉点之外的点则都需要用外极线方法寻找对应点,并寻找匹配的血管分支[8].不过,由于获取的图像中有些来源于未经校正的造影系统,其系统参数(如造影角度、X射线源到接受平面的距离等)不可避免地存在一定的误差,因此原参数不能很好地反映两幅图像间的几何变化关系,这样会导致外极线的位置发生偏移,从而影响外极线匹配的准确性,并最终影响到重建结果.针对这样的问题,本文提出利用准确对应的血管树上的分叉点来优化几何变换矩阵犌犜,在此基础上,再通过外极线法求取其它表达初始轮廓的点的对应点,从而提高对应点的匹配准确性.具体方法如下.假设已经匹配好的共轭点对(本文选择血管树中轴上的分叉点对)是[(p11,p21),…,(p1n,p2n)],可以按照第2节所述方法计算出三维点[P1,P2,…,Pn]的坐标.将[P1,P2,…,Pn]按原投影角度分别反投影得到新的对应点对[(p11,p21),…,(p1n,p2n)].通过比较(p1i,p1i),(p2i,p2i),这里i=1,2,…,n,可以计算重建误差:ε(p1i,p2i)=‖p1i-p1i‖+‖p2i-p2i‖(2)由此得到目标函数:F(犚,狋)=∑nPage4其中‖·‖表示2-范数,‖p1i-p1i‖表示p1i与p1i之间的欧式距离.N表示n对从图像中提取的对应点,公式中头两个表达式是计算原第一幅图像上的二维输入点与通过计算得到的相应第i个三维点重新投影到第一个图像平面上的二维点之间距离的平方.后两个表达式同样也是定义在第二幅图像上的二维误差.由于两个成像系统间的关系可以由旋转矩阵犚和平移向量狋来表示,因此式(3)可以表示为F(犚,狋)=∑n上式中犮k表示矩阵犚中第k列向量.通过最小化目F(珘q,狋)=∑nηi-并且上述公式还有以下约束条件:C1:s2+w21+w22+w23=1,C2:zi>0,i=1,2,…,n,C3:2(w1w3+sw2)xi+2(w2w3-sw1)yi+其中约束条件C1是四元素的标准规范,约束条件C2,C3保证了深度信息zi,zi必须在X射线光源的前面.另外对于心血管而言约束条件C2,C3还可写成C2C3:d-δh<zi=2(w1w3+sw2)xi+2(w2w3-sw1)yi+2s2+w23-()1如图4所示,其中d为焦点S到光心O的距离.δh≈12.5±2.0cm表示心脏在长轴上的最大长度.对空间中每一个三维点而言,发光源发出的光线,经过空间中的点并与图像平面相交,因此除了上面对zi和zi的约束,还有两个约束条件限制空间中每一个三维点的x,x,y,y坐标:z()iC4:ξi-xi标函数优化几何变换矩阵犌犜,使得造影图像与反投影图像上对应点的欧式距离最小.对于形态简单的血管,采用上式目标函数即可.若能获取大量匹配准确对应点,可以采用更优的优化方法.众所周知,刚体变换可以由绕通过坐标原点的的单位向量狏u旋转的θ角度分解为旋转矩阵和平移矩阵,用四元素法表示:令w=sin(θ/2)狏u,s=cos(θ/2),珘q=(s,w)=(s,w1,w2,w3).可以得出下式:s2+w21-1熿犚=2燀采用这种四元素表示法,式(4)可以重新写为)12xi+2(w1w2+sw3)yi+2(w1w3-sw2)zi+txC5:ξi-xiz()i如图4约束条件δc表示图中圆面的半径,比如是20个像素,圆面的中心在(ξi,ηi)或者(ξi,ηi).正如图中所示,约束条件C3到C5为每一个空间三维点形成了一个锥形边界区域,并且每一个这样的锥形区域的顶点是焦点,底面则是以(ξi,ηi)或者(ξi,ηi)为圆心,δc为半径的圆面.因此所求之点被限定在这样一个空间的圆锥中.结合这些约束条件,对目标函Page5数F(珘q,狋)进行优化,从而得到更准确的几何变换矩阵犌犜.与文献[8-9]提到的重建方法不同的是,本文通过分叉点优化几何变换矩阵,使找到的描述血管初始轮廓的对应点更加准确,从而为精确得到血管中轴Snake模型的位置和完整的血管轮廓奠定了基础.4采用Snake进行三维重建在对Snake模型初始化后,Snake将要在空间中不断发生形变,使它在两幅图上的投影逐渐逼近真实的血管位置.Snake不断趋近于图像特征与Snake的外部能量有关,与此同时令Snake保持平滑连续是与它内部能量有关的,解决Snake问题就是要解决能量最小化问题.4.1能量函数定义Snake能量函数[6]:其中v(s)=(x(s),y(s),z(s))是Snake曲线的三维空间表达式.Eint为内部能量,定义为Eint=(α(s)vs(s)2+β(s)vss(s)2)/2(8)从物理意义上来说,内部能量使Snake具有张力和硬度,α(s),β(s)分别表示Snake弹力和硬度的权值,为了简单起见,设定它们为常数α,β.由于在透视投影的情况下不能保证物体的平滑性这一属性,因此为了保证在三维空间中重建出来的形状是平滑的,我们应该在三维空间中定义Snake的内部能量,而不是在每一幅二维的投影图上定义.外部能量使Snake收敛于图像的明显的特征,如明亮的或者黑暗的区域、边缘等.最简单的外部能量函数是未处理的图像强度本身Eext=I(x,y)[6],如果以此为外部能量函数,则Snake将会吸引到图像中的明亮的曲线部分.求解Snake模型的目标就是要找到在式(7)中定义的E的局部最小值[6].要满足该条件,基于变量的微积分学知识,只有当Eular-Lagrange微分方程满足其中vss(s),vssss(s)分别为v(s)对s的二阶和四阶导数.Eext表示对x,y或者z分量求导.当Snake在两幅图像上的投影与血管中轴重合时外部能量Eext达到最小值.为使Snake在三维空间中不断发生形变,需要结合从两幅投影图像上得到的外部能量.文献[7]提出了三维Snake外部能量的一般表达式,本文为了便于解释,抽象出造影角度为90°的特殊情况,对此时Snake的外部能量作出直观的分析.Snake上每一个点的外部能量函数是一个包含X,Y,Z方向上的三维的向量犈ext(X,Y,Z).在图1中,两光轴互相垂直,并且世界坐标系中X轴与光源A的光轴重合,Z轴与光源B的光轴重合.这意味着在世界坐标系中,只有一个轴能同时投影到两个图像平面上,在图1中即为Y轴,而X和Z轴只能分别在平面A和平面B上有投影.于是反映到Snake上每一点的能量函数的分量犈ext(X),犈ext(Z)可以分别从图像平面A,B中得到,犈ext(Y)则是从两幅图像上获得的能量的平均.如前所述,外部能量从图像特征中获得,最简单的外部能量可以定义为Eext=I(x,y),若是令Snake吸引到具有较大图像梯度的边缘,则定义:Eext=-|I(x,y)|2[6],表示图像的梯度.但是由于血管弯曲的特性,必然存在许多弯曲度较大的区域,在Snake中,深度凹陷区域的拟合是一个难点,为此我们采用文献[10]提出的GVFSnake模型极大地改善了这个问题.将原始的能量场方程(9)中的Eext由GVF场G(x,y)代替,αvss(s)-βvssss(s)+G=0,G(x,y)=(u(x,y),v(x,y))是可以最小化能量方程ε=μ(u2x+u2的向量场,其中f(x,y)是边缘信息,μ为归一化参数.4.2最小化能量函数总的Snake能量为内部能量和外部能量之和E=Eint+Eext.Snake模型的目标就是要找到在式(10)中定义的E的局部最小值.由于该能量函数可以得到独立的欧拉方程(9),因此,寻找能量最小化的Snake的运动过程就等同于找到这个偏微分方程的解.假设Snake上有N个点,vj(j=1,2,…,N)为其中一点.我们采用semi_implicit最小化方法[12]得到迭代函数:pvt+1其中t代表迭代次数,p,q,r分别代表相应的权Page6值[15],由此可见Snake上的每一点是受其前后5个点共同影响的,于是可得到矩阵方程:rqppq熿qrqpppqrqpppqrq燀qppq但由此方程可以看到,头两点v0,v1受尾两点vN-1,vN-2影响,反之,尾两点vN-1,vN-2也是受头两点v0,v1影响,由于血管的Snake模型并不是一个闭合轮廓,因此需要对此方程做相应的变化.在这里,通过第3节的Snake模型的初始化,我们认为选定的初始点是准确的,则需要对由每两个相邻的初始点确定的线段做Snake形变.令每条这样的线段的头尾点为v0,vN-1,因为他们是选定的初始点,因此他们不需要在空间中有任何变化.并且由于Snake上的点是紧密相连的,认为紧挨着初始点的Snake上的第2个点v1,vN-2也是不变的.为此,我们将方程(11)重新写为rqp熿qrqppqrqp燀燅烐烏其中于是,结合GVF外部能量函数原方程可简写为vt+1=犕-1(vt+δt·G-犆).令此目标函数分别对x(s),y(s),z(s)进行迭代,直到重建出来的血管在两幅图像上的投影与血管的真实轮廓间的误差达到要求的误差范围即可.5实验结果这里我们采用两幅经过预处理的成像夹角为90°的血管造影图像来进行重建,如图5.其中,已知X光源到两个平面的距离SID为600mm,到光心的距离为200mm,图像分辨率为28像素/cm.图6为采用Gabor滤波器提取的中轴,并选定左图中血管的起止点,分叉点描述血管树大致轮廓,在右图中采用外极线方法寻找匹配的血管分支,并找到相应的对应点.其中不同的血管分支上的点用不同的形状的点表示.图6采用Gabor滤波器提取中轴并选定对应点(1)优化几何变换矩阵前后的实验结果比较图7(a)为未经过几何变换矩阵优化的初始Snake在平面图像上的投影,可以看到由于造影角度,X射线源到接受平面的距离等存在一定的误差,不能很好地反应两幅图像间的几何变化关系.从而图7经过几何变换矩阵优化前后的初始Snake形态对比Page7导致外极线的位置发生偏移,从而影响外极线匹配的准确性,并且直接影响到重建结果,使由对应点重建出来的三维控制点的投影与原对应点不能完全重合,存在一定的误差.在优化几何变换矩阵之后,我们得到两幅图像真实的夹角约为89.5°,两光源到左右两图像平面的距离分别为591mm和595mm.可以看到在这种情况下将重建出的控制点投影到图像上的与原对应点完全重合.(2)选择不同外部能量场的实验结果比较图8为对图6已提取中轴的图像采用图像强度I作为外部能量场与采用GVF计算外部能量场的图8采用图像强度I作为外部能量场与采用GVF图9未经过几何变换矩阵优化和采用标准能量场的Snake重建血管中轴的过程(实线表示真实造影血管中区别示意图,从图8(a)和(b)中可以看出,传统的外部能量场中,在远离血管轮廓的时候外部能量迅速消失,而在GVF能量场中,可以看到它拥有更大的外部能量捕获范围,这将使得即使Snake初始轮廓在离真实轮廓较远的位置,也能被迅速吸引到真实轮廓处.从图8(d)局部放大的能量场中可以看出在GVF向量血管顶端的的凹陷处有向上和向两侧的分量,由此可以将Snake吸引到血管中的凹陷部分,而这个与标准外部能量场图8(c)中方向杂乱的向量有着很大的区别,也是对其很明显的改善.(3)不同方法的重建精度实验结果比较图9、图10显示了重建过程中Snake不断发生形变的过程,其中T表示迭代次数,T=0时,为初始的Snake到两幅已提取血管中轴的图像的投影.图9表示的是未经过几何变换矩阵优化并且采用标准能量场的Snake的重建过程.图10表示的是经过几何变换矩阵优化并且采用GVF能量场代替标准能量场的Snake的重建过程.可以看出图9中,由于没有得到准确的图像间的几何关系,造成血管的重建精度不高.另外由图9、图10对比看出在使用GVF能量场代替标准能量场后,Snake的收敛速度较快.在经过60次的迭代后,图10空间中的Snake在两幅图像上的投影与真实的血管中轴轮廓重合,而在图9中明显还未达到.我们以式(4)来表示三维血管树上每一点的重建误差.图11是迭代过程中,不同重建方法的误差示意图,它表示了未经过几何变换矩阵优化并且采Page8图10经过几何变换矩阵优化和采用GVF作为能量场的Snake三维重建血管中轴的过程(实线表示真实用标准能量场的Snake与经过几何变换矩阵优化并且采用GVF能量场代替标准能量场的Snake的重建平均误差(分别以和表示,每迭代10次计算一次平均误差).其中横轴表示迭代次数,纵轴表示重建平均误差,单位为像素.可以看到,两种情况下,初始状态时,误差在8像素左右,在迭代过程中,采用GVF能量场的Snake的重建误差迅速下降,当迭代次数到达60左右的时候,平均误差趋于稳定在不到一个像素的范围.而采用标准能量场的Snake迭代80次后才基本达到稳定,同时平均误差在不到2个像素的范围内.图11不同重建方法的平均误差示意图(表示未经过几何变换矩阵优化并且采用标准能量场的Snake的平均重建误差.表示经过几何变换矩阵优化并且采用GVF能量场代替标准能量场的Snake的平均误差)表1为两种情况下的重建误差统计表,从表中可以看到优化并采用GVF能量场的重建结果明显好于未优化并采用标准能量场的重建结果,达到了较高的重建精度.未优化并采用标准能量场3.201.00.22优化并采用GVF能量场0.500.30.12图12为从两个视角观察重建的三维血管的结果.在重建过程中,所有的中间过程Snake的形态都代表了可能的重建结果.在规定了重建误差之后,可以令Snake反复迭代直到达到误差范围之内停止.图12从两个视角观察三维重建血管的结果6结论本文提出了一种新的基于Snake模型的血管树骨架三维重建方法.首先,采用基于多尺度Gabor滤波的方法对DSA图像自动提取血管中轴,该方法能够很好地跟踪血管粗细的变化,从而保证了血管中轴的准确性.在中轴上选取对应点比起直接在血管上选取对应点更有利于提高准确性和稳定性,并且在提取中轴的同时,还可记录下中轴上每一点对Page9应的血管半径的大小,为最后恢复血管表面打下基础.其次,本文根据血管树特殊的树状结构,利用血管树上的分叉点来优化几何变换矩阵,根据透视投影的特点提出6大约束条件,从而得到准确的成像参数,以保证接下来的对应点的寻找和重建的准确度.然后我们给定一幅图像上一组能够表达血管中轴大致轮廓的点,并采用外极线方法寻找另一幅图像上匹配的血管分支和血管上的对应点,将这些对应点作为固定点用以确定Snake模型的初始轮廓,这样将Snake应用于这些固定点之间的部分,从而使血管上的每一点都对重建工作有贡献.在Snake模型迭代求解过程中,深度凹陷区域的拟合是一个难点,而弯曲的血管又必然存在许多凹陷的区域,因此,本文提出了采用GVF流量场作为Snake的外部能量场,从而可以较好地表达血管的这一特性.在求解能量最小化时,Snake的运动是以一个偏微分方程为模型,寻找能量最小化的过程等同于找到这个方程的解.本文采用了semi_implicit最小化方法,但是此方法是基于一个闭合的轮廓,由于血管的Snake模型是一个非闭合轮廓,因此本文对原方程做了相应的改造,重新得到了非闭合轮廓能量函数最小化的最佳表达式,从而最终得到了精确的重建结果,为恢复血管表面的工作打下了良好的基础.实验结果表明,本文提出的重建方法与传统的重建方法相比,不但减少了人工干预,还在重建精度上得到了较大的改善.论文下一步的工作将在恢复了三维血管树骨架的基础上,利用记录的血管粗细和血管分割的结果实现血管表面三维重建.
