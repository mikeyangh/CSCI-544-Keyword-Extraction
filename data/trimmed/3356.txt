Page1一种面向大尺度变形的非刚性注册算法李俊程志全李宏华陈寅姜巍党岗金士尧(国防科学技术大学计算机学院并行与分布处理重点实验室长沙410073)摘要动态几何模型表示了随时间演变的动态对象,通过非刚性注册匹配离散的帧模型是重建动态几何模型的核心问题.文中提出了一种鲁棒的成对非刚性注册算法,算法分为显式对应关系计算与全局变形优化两步:第1步,分析源模型和目标模型的滑动特征,提取显著特征点,建立特征点间的对应关系;第2步,利用显示的对应关系,求解全局变形优化完成非刚性注册,通过最小化能量函数,实现源模型和目标模型的最优匹配.实验表明,对于扫描获取和人工合成的数据,新算法突破了小尺度变形的限制,可以完成大尺度变形模型的成对注册.关键词动态几何模型;非刚性注册;对应关系;全局变形优化;匹配1引言动态几何模型表示了物理世界中随时间演化的动态对象,在演化过程中,动态对象随时间不断进行非刚性变形.动态几何模型真实模拟动态对象的方式使其成为一个强有力的建模手段,所以动态几何模型的重建问题受到学术界和相关产业界的高度关注.当前,扫描获取和基于变形工具的手工合成两种方法提供了用于建立动态几何模型的离散帧模型.对于离散帧模型,必须通过注册完成帧模型的精确匹配(alignment),即建立不同时刻不同坐标系下各帧上顶点间的对应关系,恢复出自然的非刚性变形过程.因为求解的变形是非刚性的,故动态几何模型的注册称为非刚性注册,它是目前国际学术前沿关注的热点问题.在非刚性注册课题的研究中,会面对很多困难的而且经常是病态的问题.一方面,需要显式地提供各帧中顶点间的对应关系.而众所周知,求解顶点之间的对应关系是一个典型的NP难问题.这是因为,即使给定两个相等的顶点集合,建立对应关系的计算复杂度也是O(n!)(n为顶点数目);但通常,对于扫描获取的动态离散帧模型,相邻帧的顶点数目往往是不同的.从而,非刚性注册处理的实为NP难的局部映射(partialmapping)问题;另一方面,如何求解自然的非刚性变形也是复杂的非线性问题,这是因为该变形中的基本要素———局部旋转———求解本身就是非线性的.更重要的是,求解出的非刚性变形过程应该是自然的,不但不能有畸变,更要与真实的动态对象的演化过程相一致.目前,非刚性的最近迭代点(IterativeClosestPoint)算法[1]和光流方法[2-3]已尝试解决非刚性注册问题,但这些算法工作的前提是源模型和目标模型之间非刚性变形的尺度足够小.本文采取将显式图2算法流程框图2相关工作非刚性注册研究的主题包括:(1)计算离散模对应关系计算与全局变形优化相结合的方法,突破小尺度变形的限制,有效地完成大尺度变形的动态几何模型的注册(图1).1.1算法框架概述算法的总体框架如图2所示.对于输入的变形数据,首先基于显著特征分析建立显示对应关系.该过程包括3个步骤:特征点提取、特征点匹配和刚性对准(文章第3节阐述技术细节).接下来,通过全局变形优化(第4节)完成模型的非刚性注册,该非线性优化是一个迭代求解过程,每次迭代求解非刚性变形的参数,调整对应关系并更新相应的权重.对于扫描获取和人工合成的离散帧模型,文章第五节对算法进行了充分测试.实验表明,通过结合显示对应关系计算和全局变形优化,本文算法不仅可以完成动态几何模型的非刚性注册,而且提升了算法的功能性,增大了可处理模型的范围,克服了既有算法只能处理小尺度变形的限制.型间的对应关系;(2)求解非刚性变形的参数.以下将从上述两个主题阐述相关工作.如何建立源模型和目标模型顶点间的对应关系一直是一项充满挑战性的课题.对于非刚性注册,在Page3早期的工作中,对应关系是通过标记点跟踪或是人为选择建立的.后续工作为了克服人工设置的局限性,展开了自动建立对应关系的研究工作.最简单的对应关系是通过最近迭代点(ICP)建立的,即为每个源模型上的顶点与目标模型上与之最近的顶点建立对应关系.最近点迭代点算法有很多扩展,但是这些方法都不适用于变形较大的模型.为了克服小尺度变形的限制,研究人员通过分析模型的显著几何特征,显示地建立模型间的几何对应关系.Zhang等人[4]采用变形驱动的策略查找稀疏对应关系的组合空间.Lipman和Funkhouser[5]提出了使用Mbius群建立相似或局部保体的表面对应关系.Tevs等人[6]采用RANSAC滤波算法对通过滑动特征分析[7]建立的对应关系中不正确的匹配进行剔除.但是上述方法在时间方面的开销很难令人满意.在本文的算法中,基于几何特征建立对应关系和Tevs等人的工作最接近.但是本文采取了谱滤波方法,能够更高效地建立对应关系.更重要的是,建立的稀疏几何对应关系被结合在后继的全局变形优化过程中,实现非刚性变形的相关参数的求解.诉诸于迭代的优化方法进行非刚性注册是通过基于空间渐近启发式原则建立能量函数,求解非刚性变形的相关参数.Mitra等人[8]和Huang等人[9]采取局部近似刚性的变形迭代优化方法,而Li等人[10]和Sharf等人[11]则显式地定义能量函数来度量全局的外在变化.Pauly等人[12]和Bronstein等人[13]通过相关度量函数来保持测地距的近似相等达到保体的效果.这类方法的主要问题是,如果不考虑几何特征信息,很难建立起数量可观正确率又高的对应关系.所以此类方法无法处理姿态或初始位置存在大尺度差异的两帧模型的非刚性注册.本文首次将显式计算对应关系与全局变形优化相结合,并用于非刚性注册.在两帧形态相差不大的时候,依据ICP方法建立的稠密对应关系可以有效地引导非刚性注册,并达到很好的匹配效果.但是在两帧差别很大的时候,依据ICP方法建立的对应关系绝大部分都是错误的,ICP方法将不再适用.本文不仅采用ICP的方法建立稠密的对应关系,而且利用可信度高的几何特征建立的显示对应关系来引导大尺度变形.基于几何特征建立的显示对应关系具有较高的正确性,能够引导大尺度下的非刚性变形,减小两帧模型的姿态差异,使得源模型逐渐靠近目标模型;当源模型和目标模型表面接近时,本文算法借助于ICP方法建立的稠密对应关系完成高质量的模型匹配.采用两种对应关系计算结合的方法,可以在非刚性注册的不同阶段发挥两种对应关系的作用.两者的结合可以大大地提高非刚性注册的正确性和效率,而且扩大了可处理模型的范围.3显示对应关系的计算在显示对应关系的计算过程中,首先基于多尺度的滑动特征分析[14],提取一系列显著的特征点,建立特征点间显示的对应关系,然后根据对应关系完成刚性对准.3.1基于滑动特征的几何特征点提取对于源模型S和目标模型T,通过分析模型的滑动特征[14],本文为每个模型提取出一个特征点集合.如果一个点的邻域相对于自身是不可滑动的,则确定此点为显著的特征点;然后,基于高斯曲率,为每个特征点建立一个表示其局部几何信息特征描述符;最后,通过特征描述符的两两匹配,确定初始的候选对应关系.3.1.1滑动特征分析对于模型表面上的一点p,其坐标和法向分别表示为狆i=(pix,piy,piz)T和狀i=(nix,niy,niz)T.刚性运动M由两部分组成:狉=(rx,ry,rz)T表示一个3×1的旋转向量(绕x,y,z坐标轴),狋=(tx,ty,tz)T表示一个3×1的平移向量.如果在M的作用下,狆i的邻域内的每个点的瞬时运动速度都与表面相切,即满足则称M相对于狆i的邻域是一个滑动运动.式(1)可认为是一个最小二乘问题的求解:式(2)等同于求解线性方程犆狓=0,犆表示目标函数二次偏导的协方差矩阵:犆=∑ni=1其中cik=(狆i×狀i)k,k=x,y,z.对犆进行特征值分解犆=犡Λ犡T,与零特征值相Page4对应的特征向量即表示了M相对于狆i的邻域的一个滑动运动.在实际情况中,犆很有可能是一个满秩矩阵,所以只要特征值足够小,就可认为对应了一个滑动运动.假定λ1λ2λ3λ4λ5λ6是矩阵犆的6个特征值,如果只考虑犆特征值中最小值λ1来进行滑动性的判别,这种分析在多尺度邻域的划分下将是不稳定的.所以,本文同时考虑最大特征值λ6,并定义点p的滑动特征指示符=λ1/λ6(任何条件下,最大特征值λ6总是一个非零值).本文采用指示符对p的邻域的滑动性进行状态估计,的值大小认为分别对应着不可滑动运动与滑动运动.3.1.2特征点提取通过在多尺度邻域下寻找滑动特征指示符的局部极大值,可以得到一系列顶点,这些顶点的相应邻域相对其自身认为是不可滑动的,即为本文所求的特征点.需要指明的是,低曲率区域的表面是平坦的,没有显著的几何特征.在进行滑动特征分析之前,根据曲率对整个模型上的顶点进行筛选,排除掉最小和最大主曲率都接近于0的顶点,这将会优化特征点提取和匹配的时间开销.3.2特征点对应关系的建立和精化基于高斯曲率为每个特征点定义柱状图描述符[7],并根据柱状图描述符对源模型和目标模型上的特征点进行两两匹配,可以建立初始的候选对应关系集合.但是集合中不仅包括正确的对应关系,同时也不可避免地存在很多错误的对应关系,需要采取有效的策略对错误的对应关系进行剔除.不同于Tevs等人[6]的方法,本文采取一种基于PROSAC(PROgressiveSAmpleConsensus)[15]框架的方法,可以称之为spectral-PROSAC,对候选对应关系集合进行高效筛选,建立高可信度的对应关系集合.基于模型表面的测地距,首先定义对应关系的相容性判别.假定源模型和目标模型之间的形状变化是保长的,那么对于两组对应关系:(狊i,狋i)和(狊j,狋j),狊i,狊j表示源模型S上的顶点,狋i,狋j表示目标模型T上的顶点,如果同一模型上的两个顶点的测地距离近似相等,dg(狊i,狊j)≈dg(狋i,狋j)(dg(·)表示两点之间的测地距离).则认为这两组对应关系相容一致的.即采用测地距离对相容性进行度量.spectral-PROSAC首先利用全局的谱裁剪算法[16],即根据测地距为所有的对应关系构建相容矩阵犆,其中,cij=mindg(si,sj)c0表示进行相容性判别的阈值,在本文中取c0=0.7,cij表示两组对应关系的相容性度量.相容矩阵犆的最大特征值的特征向量[w1,w2,w3,…]T的每个元素即为每组对应关系定义了一个权值.选取高权值的对应关系构成采样集合H.接下来,对于H中的每三组对应关系,检查它们的相容性.如果这三组对应关系彼此相容,则将它们加入到相容集合K中(集合K初始为空).然后依据每组对应关系相应权值,从高到低依次向K中加入新的对应关系.每次需要对待加入的对应关系进行相容性的判别,如果待加入的对应关系与K中的每组对应关系的相容性度量大于等于0.7,则将其加入集合K,否则舍弃.这样,对于H中的每三组对应关系都能得到与之对应的集合K.集合K内的对应关系都是彼此相容的,K中的对应关系组数表明了该集合对于全局对应关系的相容能力,相容能力越强,可信度越高.选取包含元素最多的K集合即为本文所求高可信度的对应关系子集合.基于spectral-PROSAC方法,可以高效地建立起可信度高的对应关系.与Tevs等人[6]的工作相比,基于本文算法得到的对应关系数目更可观.同时在时间开销上,对于相同或相似的模型,本文算法比Tevs等人[6]的算法提高了近7倍.3.3刚性对准对于上一节中求得的对应关系集合,从中选取20个置信度最高的对应关系进行刚性的外形对准(alignment)[17].刚性对准实质上是求解一个3×3的旋转矩阵,时间消耗相对于非线性优化过程可以忽略不计.因为极分解不能区分映像和旋转,故采用奇异值分解(SVD)的方法代替文献[17]的极分解.基于奇异值分解得到的一个或多个负奇异值表示映像,正奇异值表示旋转,从而可以达到真正意义上的旋转分解.刚性对准为接下来的非线性优化提供了很好的初始条件,保证了大尺度情况下非线性优化过程的收敛和正确求解.4非线性优化结合滑动特征分析得到的对应关系,采用非线Page5性优化方法进行非刚性注册.与既有工作[9-10]不同,本文利用高可信度的显示对应关系提高注册算法的效率和正确性.本文提出的非线性能量函数包括与非刚性变形模型和对应关系相关的组成成分.4.1非刚性变形模型采用Sumner等人[18]提出的嵌入变形框架,本文利用表面均匀采样得到的变形控制节点对三维空间进行离散化.每个控制节点的局部作用空间定义了一个3×3的矩阵犚和一个3×1的平移向量狋,表示一个仿射变换.所有节点的仿射变换及对其邻近空间的作用构成了全局的非刚性变形.基于局部的一致性和效率的考虑,指定源模型上的每个顶点只受其最近的k个节点的影响(本文中取k=4).如果两个节点的作用区域包含相同的顶点,则建立它们的邻接关系,即这两个节点互为相邻节点.在整个优化过程中,两个能量函数项用于控制源模型非刚性变形.第一个能量函数项用于Erigid度量矩阵犚与真正意义上的刚性旋转的差异,以保持模型表面的几何信息.这种约束是非线性的.Erigid将每个节点的仿射变换的旋转度量误差相加:其中,Rot(犚)=(犮T1犮2)2+(犮T1犮3)2+(犮T2犮3)2+犮1、犮2和犮3表示犚i的列向量.式(5)表示每个犚i需要满足以下条件:每个列向量为单位长度,同时两两正交.因为相近节点的仿射变换存在相交重叠的作用区域,所以必须保证这些仿射变换彼此之间的一致性.第2个能量函数项Esmooth对这种一致性进行度量,以保证变形的平滑:Esmooth=∑m其中犵j表示节点的空间坐标,N(j)表示节点j的相邻节点.4.2对应关系的加权处理在整个优化的过程中,对应关系作为位置约束引导全局的非刚性变形,构成非线性优化过程中的第3个能量函数项:狊表示源模型S变形后的顶点坐标,狋i表示目标模型上与之对应的空间位置,其中既包括了基于几何特征建立的对应关系,也包括基于ICP算法[19]为每个变形控制节点计算得到的稠密对应关系.不论是基于几何特征还是ICP算法得到的对应关系都不可避免的存在错误,错误的对应关系将会对全局变形产生影响,严重地将导致出现变形失真,错误地扭曲或拉伸模型表面,影响注册结果.为了防止变形过程中产生失真,本文为每个对应关系都设置一个置信度量.所以采用这种置信度策略可以提高整个优化过程对错误的对应关系的容错能力.由于为每个对应关系指定了一个置信变量w,式(7)修改为cor通过基于滑动特征分析得到的特征点的Einitial对应关系进行计算,而EICP为每个节点建立的对应关系进行计算.由于加入了置信度量,相应地需要为非线性优化定义下一个能量函数项:wi的值接近1,则表示该对应关系对全局非刚性变形具有高可信度的引导,相反的,wi接近0则隐含的表示了该对应关系会引起Erigid和Esmooth的显著增加,在变形过程中可以忽略该对应关系.能量函数项Econf促使wi向1逼近,达到源模型S与目标模型T的最优化匹配.4.3非线性优化的数值求解体能量函数Etotal为综上所述,本文的非线性优化求解的最小化总Etotal=αrigidErigid+αsmoothEsmooth+αinitialEinitial每个节点相应的仿射变换的犚中有9个变量,狋中有3个变量,而每组对应关系都有1个相应的置信变量,所以整个优化过程中一共有13n+m个未知变量.n表示变形控制节点的数目,m表示基于滑动特征分析得到的对应关系数目.总体能量函数Etotal的最小化是一个非线性问题,对应着全局非刚性变形相关参数的求解.本文采用高斯-牛顿方法[20]进行迭代求解.首先设置相关参数的初始值:每个节点对应的仿射变换中R=I,t=0;相应能量项的控制权重arigid=1000,asmooth=100,aconf=100,ainitial=10.在每次迭代中,动态更新控制权重的值以避免局部最优解.当|Fk-Fk-1|<10-5(1+F)k时(Fk=E(δk)表示残差),arigid,asmooth,Page6aconf,ainitial的值更新为原值的1/2,值得注意的是,aconf的更新会在aconf<1的时候停止,ainitial的更新会在ainitial<0.1的时候停止.αICP在整个优化过程中保持固定值0.1.同一般的非线性优化问题一样,本文的非线性优化系统需要经过多次迭代求解才能达到最终的非刚性注册.本文设定整个优化过程在arigid<0.01或是迭代次数大于50的时候停止.5结果在DellInspiron530(2.4GHz主频,2GB内存)机器上,采用VisualStudioC++2005和OpenGL实现了本文所提出的算法,并采用了不同的模型对算法进行充分测试.测试模型既包括基于深度激光扫描仪获取的不完整模型,也包括用变形工具手工图3performer2与walk-elephant模型(同一灰度的顶点即为一组对应关系)对于姿态相似模型,本文与Tevs等人的算法[6]进行了比较(图4),求得的对应关系组数分别为197组和75组,本文算法不仅在对应关系的数目上高了近3倍,而且在时间开销上降低了近7倍.对于图4中的模型,Tevs等人的算法[6]的预处理时间图4guy模型图4和图5中标记出的特征点表明,本文算法在对应关系的计算上存在一定的局限性.对于cat模型,Lipman和Funkhouser[5]的算法和本文算法都会得到某些偏差较大的对应关系.本文方法同一般的基于测地距离的匹配算法一样,会遇到一个不合成的动作序列库中选取的完整模型.实验表明,本文算法不仅能够获得高质量的注册效果,而且具有很好的鲁棒性,能够有效处理大尺度变形的模型.5.1显式对应关系的计算首先,本文对所提出的显示对应关系计算算法进行了测试,结果表明,本文算法能够建立起数量可观的且可信度高的对应关系.图3中performer模型展示了对存在大尺度变形的两个模型求取对应关系的结果.这两个模型表示了一个表演者两个不同的姿态:站立和倒立.即使两个模型姿态差异很大,而且表演者穿戴宽松的衣物,表面细节复杂,但是仍然能够得到23组正确率高的对应关系.而对于walk-elephant的小尺度变形模型,则建立了234组对应关系.是9m4s,其RANSAC算法耗时36.1s,对应关系的建立耗时3m40s.而本文算法极大地节省了时间开销,预处理耗时25.4s,特征点提取4.1s,建立对应关系的时间耗时为32.9s.可避免的问题:无法准确判别与相容集合的测地距离相同的特征点构成的对应关系.不过幸运地是,本文的全局优化函数具有很好的容错处理能力,通过在优化过程中动态更新置信权重,完成源模型和目标模型的最优匹配.Page7图5cat模型对于图5中cat模型,Lipman和Funkhouser[5]和本文建立的对应关系都会产生错误,但本文算法能在非线性优化过程中自动调整对应关系的权重,完成模型的非刚性注册.5.2非刚性注册正如图1和图4、图5所示,本文的非刚性注册算法能对存在大尺度变形的闭合模型完成高质量的非刚性注册.为了检验算法的鲁棒性,本文深入地测图6elephant模型与Haotorso模型对于图7中的arm模型,本文算法能够很好地克服非刚性迭代最近点[12]的局限性,解决基于最近点建立临时对应关系导致的局部最优解问题,完成更合理的非刚性注册.为了验证非刚性注册结果的精确性,本文使用相对的最大距离和相对的均方根距离衡量注册后的源模型与目标模型间的误差.对于图1中的performer和图6中的elephant模型,源模型和目标模型顶点数目相同且顶点间的对应关系是已知的.基于已知的双射对应关系,计算注册后源模型上所有顶点到试了由激光扫描设备所获取的真实数据(局部开放模型).正如图6所示,对于局部开放模型,本文的算法也能够完成源模型和目标模型间的精确匹配.特别是,图中Haotorso的非刚性注册结果说明了本文算法能够真正解决非刚性注册所面临的局部映射问题,而且可以利用源模型和目标模型的几何信息进行补洞,增强几何细节信息.目标顶点的最大距离和均方根距离.为了统一地可视表现(图8),将上述两距离除以相应模型的包围图8以相对最大距离(MaxDis)和相对均方根距离Page8盒对角线长度,计算出相对的最大距离(MaxDis)和相对的均方根距离(RMSDis).对于文中使用的模型,表1统计了相应的指标.表中第1列为模型名称,第2列为源和目标模型顶表1非刚性注册过程中各项数据的统计模型数据源/目标模型顶点数目提取特征点耗时/s建立对应关系耗时/s对应关系组数迭代次数非刚性注册耗时/sguy(图4)Performer1(图1)10k/10kelephant(图6)24k/24khaotorso(图6)135k/120k6结论通过结合显示对应关系计算和全局变形迭代的优点,本文提出了一种鲁棒的成对非刚性注册算法,建立源模型和目标模型间的对应关系,求解出非刚性变形的过程,完成了源模型和目标模型的最优匹配.实验结果表明,本文算法突破了既有技术对变形尺度较小的限制条件,能够完成大尺度模型的非刚性注册.动态几何模型的非刚性注册是一项充满挑战的问题,没有一种算法适用于所有情况.但本文方法在大尺度变形的情况下得到了较好的效果,是将非刚性注册算法应用于动态几何模型重建的新的探索.在未来工作中,我们将尝试成组离散模型的非刚性注册问题的研究,以及采用改进的自适应变形节点也是后续的研究方向.
