Page1TM:一种新的片上网络拓扑结构王新玉1),3)向东2)虞志刚3)1)(东北财经大学管理科学与工程学院辽宁大连116025)2)(清华大学软件学院北京100084)3)(清华大学计算机科学与技术系北京100084)摘要片上网络拓扑结构对芯片的性能有直接的影响.文中提出了一种新的拓扑结构TM,它结合了torus网络和mesh网络的优点.对于n×n的网络,在物理链路数方面,TM和mesh网络相同,比torus网络少2n;在拓扑直径方面,TM的拓扑直径为n,而torus和mesh网络的拓扑直径分别为2×(n/2)和2×(n-1);在完全适应性路由算法设计方面,torus网络需要的虚拟通道数至少为3,且虚拟网络划分机制不能直接应用其中,然而,虚拟网络划分机制适用于mesh和TM网络,且它们只需要2条虚拟通道.文中从理论和模拟实验两方面对TM网络进行了验证,实验结果表明无论在均衡负载还是非均衡负载下,TM的性能都要优于mesh网络,在大部分情况下,TM的性能介于mesh和torus之间,在某些通信模型下,torus的性能比TM差,主要原因在于这些通信模型下torus网络中虚通道使用不均衡.关键词片上网络;拓扑结构;mesh;torus1引言随着半导体工艺技术的提高,在一个芯片上集成的晶体管的数目越来越多,单一芯片上集成的核的数目越来越多,如何连接如此之多的核至关重要,片上网络互连结构比总线结构具有更好的通信性能,并且具有更低的通信功耗,从而使得网络互连结构代替了总线结构.片上网络拓扑结构对片上多处理器的性能和功耗的影响越来越重要[1].在许多的实例中,尤其是细粒度的并行计算机中,通信部件对性能的影响远远大于计算部件对性能产生的影响,通信部件成为并行计算机系统的性能瓶颈.片上网络设计包括3大要素:拓扑结构、路由算法和交换机制.典型的网络拓扑结构有环型、mesh、torus、星型、树型、立方环[2]、deBruijin[3]、超立方、分级环[4]等.在这些结构中,mesh是最流行的拓扑结构,并被广泛应用于许多的商用和实验机器中,如J-machine[5]、M-machine[6]、ReliableRouter[7]等.低维的、简单的二维mesh拓扑结构具有如此的吸引力是因为它具有如下优点:通道长度短、路由器设计简单、易于片上布线[8].然而,当网络规模增大时,mesh的网络拓扑直径和网络平均距离大大增加,从而直接影响网络的性能.并行计算机系统的关键部件是其通信结构,通信速度(而非处理速度)是目前许多算法执行的瓶颈[6].为了有效地执行这些程序,设计一种低延迟、高吞吐量的拓扑结构是迫切并且有意义的.吞吐量和延迟是评价网络性能的两个重要指标.在片上网络设计之初,要考虑尽可能地提高网络的吞吐量,降低网络的通信延迟.影响这两个指标的参数有:(1)网络跳步数;(2)路由器内部延迟.其中前者依赖于具体的网络拓扑结构以及路由算法,尤其当路由算法为最短路由时,只依赖于网络拓扑结构;而后者依赖于路由器设计的复杂性.本文中我们主要研究网络拓扑结构对片上网络的性能影响.片上网络设计受到严格的面积约束和路由器引脚数约束[9].当前的片上网络拓扑结构设计和路由算法设计中,虫孔交换已经成为一种主流的交换方式[9-10].本文中我们只考虑虫孔交换和基于虫孔交换的路由算法.2Dmesh结构在每一行和每一列上都没有环,这使得mesh结构上的无死锁路由算法设计变得简单.mesh网络中,路由器最大端口数为5,网络上的完全适应性无死锁路由算法只需要2条虚拟通道.另外,对于一个n×n的mesh结构,它的链路数目是2×n×(n-1),网络平均跳步数是2n/3,网络拓扑直径是2×(n-1).2Dtorus结构是一个完全对称的结构,它的每一行(列)都自成一环,在torus上进行无死锁路由算法设计时,需要的虚拟通道的个数增加.如torus网络实现完全适应性最短路由(Duato协议[6])至少需要3条虚拟通道,而且这3条虚拟通道的使用不均衡;而Ramanujam等人[11]提出的W2TURN非最短路径路由算法至少需要4条虚拟通道.虚拟通道的个数直接影响片上网络路由器的缓冲区需求、面积开销、交换开关和仲裁机制的设计复杂性.本文第2节介绍相关工作和TM网络的思路来源;第3节给出TM网络的定义及其拓扑特性的分析;接下来在第4节和第5节中分别给出死锁避免机制和TM网络中的路由算法;在第6节进行实验结果分析;最后对本文工作进行总结.2相关工作和TM网络的思路来源为了降低mesh网络的平均跳步数和网络拓扑直径,前人也做过大量的研究工作.一种常见的方法是在mesh网络中插入一些长线,使得某些原本在mesh网络中不相邻的路由器间有直接的链路连接,从而降低网络的拓扑直径和网络的平均距离.另一种方法是改变传统的路由器和处理单元(ProcessingElement,PE)之间的一对一映射关系,转换为一对多的映射,减少路由器的个数,降低网络规模,从而降低网络的拓扑直径和平均距离.在长线插入方面,Fuks和Lawniczak[12]研究了在mesh网中增加随机长线对网络性能的影响,这种方法虽然能够提高网络的性能,但是作者在分析这种方法时是基于均衡通信模型和无限缓冲区的假设,更加值得思考的是,作者并未给出增加随机长线后网络的死锁避免问题;Dally[13]提出了expresscube的概念,这种方法是在mesh网络中增加同一维度上的有规律的长线,如长线增加为固定长度,或者是一个固定的长度范围,这种方法是以面积开销的增加来换取性能的提高[14];Ogras和Marculescu[15]从贪心算法的角度给出了一种新的长线插入的方法以减少消息路由跳步数,以提高网络的性能,但是这种方法的路由算法设计复杂,使得路由单元的实现非常困难.朱晓静等人[16]提出了一种Xmesh结构,这种结构是在mesh结构的基础上Page3增加主对角线和副对角线上的2×(n-1)条链路及2条对角线链路,这种方法增加的链路数为2n,但是网络中的某些路由器的交换开关(crossbar)的复杂性大大增加,对于一个n×n的Xmesh网络,当n为奇数时,交换开关的端口数最大为9,当n为偶数时,交换开关的端口数最大为7,而mesh网中交换开关的端口数最大为5,另外,作者在Xmesh结构上给出了确定性非最短路由算法,原因在于Xmesh上的最短路由算法容易造成两条对角线的拥塞,适应性算法却不能体现出Xmesh结构的优势.在映射关系改变方面,Balfour和Dally[17]提出了Cmesh(Concentratedmesh)的概念,该结构中一个路由器节点可以连接到多个处理单元,降低网络规模,从而进一步减少处理单元之间的通信距离,提高了系统的性能,但是这种方法增加了交换开关的复杂性,对于一个4-路的Cmesh来说,交换开关的端口数由5增加到9,这将大大提高单个路由器上的功耗,产生热点问题;赵宏智[18]提出了一种混合拓扑结构,名为SSBM,该结构是在2Dmesh结构的基础上引入一个中间层次的2×2的星型子网,而每一个2×2的星型子网由一个交换机实现,这种方法减少了通信节点之间的距离,却需要较大规模的交换机支持.前人工作中无论是增加长线,还是改变路由器和处理单元之间的映射关系,都会增加路由器的端口数,从而增加交换开关的复杂性.交换开关端口数增加,一方面会提高路由和开关分配逻辑的复杂性,另一方面,由于每个端口都需要分配缓冲区,因此也会增加缓冲区需求.此外,增加的长线会产生额外的图18×8的网络拓扑结构为了便于分析网络拓扑直径,我们将2DTM重新布局.下面我们从映射的角度给出如何从一个原始的TM网络布局得到新的TM网络布局.对于节点(x,y),如果x+y<n,这个节点在新的TM网面积开销,当长线过长时还需要插入中继器.本文旨在设计一种新的网络拓扑结构,克服mesh网络在拓扑直径和平均跳步数方面的缺点,同时能够克服torus网络中虚拟通道数目过多、虚通道不均衡使用的缺点;新的网络拓扑结构是在mesh网络路由器设计复杂性的基础上提高网络的性能.由于这种新的网络拓扑结构兼具torus网络和mesh网络的一些优点,我们取torus和mesh的第一个字母TM为这种新的网络命名.3TM网络结构网络拓扑结构可以用图G(V,E)来表示,其中V是节点的集合,E是边的集合[6].对于v∈V,它表示网络中的一个路由器,对于e∈E,它表示相应的两个路由器之间的有一条直接的链路相连.3.1TM网络的定义对于一个n×n的TM网络,它的图G(VTM,ETM)可以表示如下:VTM=Vmesh,ETM=Etorus-E,E={(u,v),(v,u)|(u,v)∈Etorus,u=(x1,y1),v=(x2,y2),且((x1+y1==nx1==x2)‖(x1+y1==n-1y1==y2))}.简单地说,2DTM是2Dtorus的子网,TM网络中的节点和torus(mesh)网络的节点相同,但是TM网络中每一行(列)比torus相应行(列)少一条链路,缺少的链路满足定义中给出的条件.图1(a)~(c)中给出了8×8的mesh,torus和TM网络拓扑结构.参照foldedtorus网络的定义[19]给出foldedTM网络,如图1(d)所示.络布局中映射到点(x,y);否则,这个节点在新的网络布局中映射到点(x,y-n).我们称原始布局的TM网络布局为初始TM布局,重新布局的TM网络为新的TM布局.每个节点有两个坐标,一个来Page4自于初始TM布局,称为初始坐标,另一个来自于新的TM布局,称为改进坐标.图2(a)给出一个8×8的新的TM布局,图中的点A,它的初始坐标和改进坐标相同,图中的点B,它的初始坐标和改进坐标不同,分别为(4,6)和(4,-2).改进距离.对于TM网络中的点c(xc,yc)和d(xd,yd),我们可以计算出这两个点的改进坐标,记为(x1,y1)和(x2,y2),c和d之间的改进距离记为RD,RD=|x1-x2|+|y1-y2|.实际距离.对于TM网络中的点c(xc,yc)和d(xd,yd),l是c和d之间的一条最短路径,c和d之间的实际距离等于路径l的长度,记为AD.上三角子网络(UpTriangle).该子网是TM网络的一部分,点A(x,y)属于TM网络,A的改进坐标为(x1,y1),点A属于上三角子网当且仅当x10;所有属于上三角子网的点和这些点之间在TM网络中的连线构成了上三角子网络.下三角子网络(DownTriangle).同样的,该子网是TM网络的一部分,点A(x,y)属于TM网络,A的改进坐标为(x1,y1),点A属于下三角子网当且仅当x10;所有属于下三角子网的点和这些点之间在TM网络中的连线构成了下三角子网络.图2(b)和(c)给出了8×8的TM网络的上三角子网和下三角子网.从图和定义中我们可以看出,Y维坐标为0的点既属于上三角子网络又属于下三角子网络,X维的回转链路既不属于上三角子网络又不属于下三角子网络.所以,对于Y维坐标为0的点,根据具体的情况选择上三角还是下三角.这样,我们可以给出如下结论:在重新布局的TM中,点A(x1,y1)和B(x2,y2),如果y1×y20,则A和B属于同一个三角子网络,否则A和B属于不同的三角子网络.3.2TM网络结构分析对于一个n×n的TM网络,(1)网络中节点的度为2或4,度为2的节点有2n;(2)网络中总的链路数目为2n×(n-1),与mesh网络中的链路数目相同,比torus网络的链路数目少2n;(3)TM网络拓扑直径为n,当n为偶数时,TM网络拓扑直径与torus网络拓扑直径相同,当n为奇数时,TM网络拓扑直径比torus网络的拓扑直径大1,而mesh网络拓扑直径为2(n-1);(4)TM网络的平均距离介于mesh网络的平均距离和torus网络的平均距离的中间位置.无负载条件下的平均延迟等于报文长度和网络平均距离之和,网络平均距离是影响平均延迟的重要因素.图3给出了mesh、TM和torus网络在不同网络规模下的平均跳步数,TM的平均跳步数介于mesh和torus网络的中间位置.下面证明n×nTM的网络直径是n.在证明之前,我们先给出两个引理.引理1.假设节点s(xs,ys)和节点d(xd,yd)是TM网络中的两个节点,(x1,y1)和(x2,y2)是s和d的改进坐标,若它们属于同一个三角网络,当下述条件之一满足时,s和d之间的实际距离一定小于n.(1)x1x2并且y1y2.(2)x1x2并且y1y2.证明.我们只在上三角网络中对该引理进行证明,对于下三角网络中的证明,可以同理推出.很明显,在上三角网络中,所有的节点都在直线x+y=0和x+y=n-1之间.当x1x2并且y1y2时,AD(s,d)RD(s,d)=(x2-x1)+(y2-y1)Page5同样地,当x1x2并且y1y2时,AD(s,d)RD(s,d)=(x1-x2)+(y1-y2)引理2.假设节点s(xs,ys)和节点d(xd,yd)是TM网络中的两个节点,(x1,y1)和(x2,y2)是s和d的改进坐标,若它们属于不同的三角网络,当下述条件之一满足时,s和d之间的实际距离一定小于n.(1)x1x2并且y1y2.(2)x1x2并且y1y2.证明.我们只给出条件(1)满足时结论成立,对于条件(2)的情况,可以同理推出.s属于上三角网络,而d属于下三角网络.如图4所示,需要两条辅助线,一条是经过s的竖直线,另一条是经过d的水平线,则AD(s,d)RD(s,d)=l1+l2l1+l3定理1.TM网络的拓扑直径为n.证明.该定理可以转化为:对于TM网络中的任何两个节点,都可以找到一条长度不大于n的路径.假设节点s(xs,ys)和节点d(xd,yd)是TM网络中的任何两个节点,(x1,y1)和(x2,y2)是s和d的改进坐标,不失一般性,我们可以假设x1x2.则RD(s,d)=|x2-x1|+|y2-y1|.若RD(s,d)n,则我们可以找到一条长度为RD(s,d)的从s到d的路径,该路径不包括X方向的回转链路;若RD(s,d)>n,总共有如下3种情况.(1)s和d同属上三角网络,根据x1x2和定理1,可知y1>y2,可以找到如下从s到d的路径:(x1,y1)→…→(0,y1)→(n-1,y1-n)→…→(x2,y2).设这条路径的长度为L,则L=RD(s,(0,y1))+1+RD((n-1,y1-n),d)=x1+1+(n-1-x2)+(y2-y1+n)=2n-RD<n.(2)s和d同属于下三角网络,证明同上.(3)s和d属于不同的三角网络,根据x1x2和引理2,得到y1>y2,可以找到如下从s到d的路径:(x1,y1)→…→(0,y1)→(n-1,y1-n)→…→(x2,y2).L=RD(s,(0,y1))+1+RD((n-1,y1-n),d)设这条路径的长度为L:当y2-y1+n0时,=x1+1+(n-1-x2)+|y2-y1+n|=x1+1+(n-1-x2)+(y2-y1+n)=2n-RD<n;当y2-y1+n<0时,L=(x1+y1)-(x2+y2)n-1-0<n.基于上述分析,在n×n的TM网络中,网络的拓扑直径为n.4死锁避免机制在片上网络拓扑结构设计中,死锁避免是一个非常重要的问题.对于一个新的网络拓扑结构,我们需要为其设计出无死锁路由算法.4.1虚拟网络划分虚拟网络的概念最早在文献[20]中提出,许多路由算法设计人员利用该思想解决网络中的容错问题[24]和死锁避免问题.可以将一个n×n的TM网络划分成4个虚拟网络,从最右端到最左端的回转链路属于x+,从最上端到最下端的回转链路属于y+,反之同理.4个虚拟网络为:(1)x+y+(cx,1+,cy,1+);(2)x+y-(cx,2+,cy,2-);(3)x-y+(cx,2-,cy,2+);(4)x-y-(cx,1-,cy,1-).图5给出了8×8TM网络的4个虚拟网络,其中虚拟网络(1)和(4)分配虚拟通道c1(cx,1和cy,1),(2)和(3)分配虚拟通道c2(cx,2和cy,2).从图中可以看出,虚拟网络(1)和(4)中不含环,而(2)和(3)中含有环.为了避免虚拟网络(2)和(3)中的环形通道依赖,借鉴通道重叠思想[22-24].对于虚拟网络(1)和(4),消息在这两个子网中路由时只使用虚拟通道c1,对于(2)和(3),消息在这两个子网中路由时分为两种情况:(a)消息不需要通过X方向的回转链路,则只使用虚拟通道c2;(b)消息需要通过X方向的回转链路,则消息在通过X方向的回转链路和在此之前使用c2通道,之后使用c1通道.Page6图5TM网络中的4个虚拟网络简单地说,虚拟网络(1)和(4)只能使用虚拟通道c1;在虚拟网络(2)和(3)路由的消息,消息在经过X方向的回转链路和在此之前使用虚拟通道c2,在经过X方向的回转链路之后使用虚拟通道c1.因此,通道依赖关系有3种:(1)c1到c1;(2)c2到c2;(3)c2到c1.这个结论对于无死锁证明是十分重要的.4.2虚拟网络选择在TM网络中,消息根据其源节点和目的节点可以划分成4类:(1)x+y+;(2)x+y-;(3)x-y+;(4)x-y-.在mesh网络中,类型为(i)的消息落入虚拟网络(i)进行路由.在TM网络中,虚拟网络选择不仅与消息的类型有关,还与消息的源节点和目的节点坐标有关.源节点和目的节点的改进距离不大于网络拓扑直径时,选择的虚拟网络的类型和消息类型一致;源节点和目的节点的改进距离大于网络拓扑直径时,还要考虑源节点和目的节点的坐标.第1类.源、目的节点属于同一个三角网络.源节点的x坐标小于目的节点的x坐标时,选择虚拟网络x-y+,否则选择虚拟网络x+y-.第2类.源节点属于上三角网络,目的节点属于下三角网络.源节点的y坐标小于目的节点的y坐标时,选择虚拟网络x-y+;否则选择虚拟网络x-y-.第3类.源节点属于下三角网络,目的节点属于上三角网络.源节点的y坐标小于目的节点的y坐标时,选择虚拟网络x+y+;否则选择虚拟网络x+y-.4.3无死锁证明死锁问题是片上网络设计中一个非常棘手但是又必须解决的问题.片上网络通常采用死锁避免方法,保证网络不会产生死锁状态.这一部分,我们将证明TM网络的虚拟网络划分机制和虚拟通道使用方法在进行最短路由时将不会引起死锁.引理3.TM的虚拟网络(1)和(4)中无死锁存在.证明.图5子图(a)和(d)给出了虚拟网络x+y+和x-y-,我们可以证明这两个虚拟网络中没有环型通道依赖存在.以虚拟网络(1)为例,在该虚拟网络中画一条辅助线x+y=n.辅助线的左边无环存在,右边也无环存在.若形成环,环中必定Page7有两条链路横跨辅助线,一条从左向右,另一条从右向左.然而,该虚拟网络中没有一条链路从左向右穿越辅助线.综上,虚拟网络中(1)无环型通道依赖存在,即虚拟网络(1)中无死锁存在.同理可证虚拟网络(4)中无死锁存在.引理4.TM虚拟网络(2)和(3)中无死锁存在.证明.图5子图(b)和(c)给出了虚拟网络x+y-和x-y+,我们可以证明这两个虚拟网络中没有环型通道依赖存在.以虚拟网络(2)为例,在该虚拟网络中画一条辅助线x+y=n.很明显,辅助线的左边无环存在,辅助线的右边无环存在.因此,若形成环,环中必定有两条链路横跨辅助线,一条从左向右,另一条从右向左.图6给出了一个满足该条件的环.根据前面虚拟通道使用方法,A到B(B到C)的虚拟通道必定是c2,C到D的虚拟通道必定是c1,这样一来,在这个环中必定有某个通道依赖是从c1到c2.根据前面的通道依赖结论,这种依赖关系是不存在的,故这样的环型通道依赖不存在.综上,虚拟网络(2)中无死锁存在.同理可证虚拟网络(3)中无死锁存在.拟通道使用方法在整个网络中无死锁存在.定理2.TM网络的虚拟网络划分机制和虚证明.4个虚拟网络由虚拟通道c1联系到一起.当无虚拟网络(2)和(3)参与时,(1)和(4)肯定不会形成死锁;当有(2)和(3)参与时,(2)和(3)中消息只有经过某个X方向的回转链路之后才会申请c1,需要虚拟通道c2到c1的依赖关系,要想形成依赖环,必定要有反向的(即c1到c2)的通道依赖关系.根据前面的通道依赖结论,这种依赖关系是不存在的,故这样的环型通道依赖不存在.综上,TM网络的虚拟网络划分机制和以及采用虚拟通道使用方法能保证整个网络中无死锁存在.5TM网络路由算法路由算法负责将消息准确无误地从消息的源节点发送到目的节点.由于片上网络对面积、功耗、性能等各个方面的约束,设计出的路由算法必须简单高效(实现方便,硬件开销和时间开销小)、无死锁和无活锁、最短路由(降低延迟和功耗).路由算法在满足用户需求的同时,要尽可能地提高网络资源的利用率[25].本节中给出适用于2DTM网络的确定性路由算法和完全适应性路由算法,且两种算法都基于前面的虚拟网络划分机制,只需要两条虚拟通道.算法1.TM中确定性路由算法Deterministic_route1().输入:当前节点坐标(xc,yc)和目的节点坐标(xd,yd)输出:一条选定的输出通道1.IFxc≠xdandx+portexists,RETURNcx,1+;2.ELSEIFyc≠ydandy+portexists,RETURNcy,1+;3.ELSERETURNinternal.算法2.TM中确定性路由算法Deterministic_route2().输入:当前节点坐标(xc,yc)和目的节点坐标(xd,yd)输出:一条选定的输出通道1.IF消息走过X方向的回转链路,i=1,否则i=2;2.IFxc≠xdandx+portexists,RETURNcx,i+;3.ELSEIFyc≠ydandy-portexists,RETURNcy,i-;4.ELSERETURNinternal.5.1确定性路由机制确定性路由是指消息路由的路径由其源节点和目的节点唯一确定,而不考虑路由过程中网络的状态.在确定性路由中,消息的路由路径是唯一的,具有相同的源节点和目的节点的消息走相同的路由路径.那么,TM网络中的确定性路由算法是如何实现的呢?为了清晰起见,我们将不同的虚拟网路中的路由算法分开来写,即虚拟网络(1)x+y+中的确定性路由算法为Deterministic_route1(),依次类推.由于虚拟网络(1)和(4)中的确定性路由算法类似,(2)和(3)中的路由算法类似,我们只给出虚拟网络(1)和(2)中的确定性路由算法,如算法1和算法2所示.以在虚拟网络(1)中路由的消息为例,如算法1所示,根据前面的虚拟通道使用规则可知,只有虚拟通道c1+可用.当消息的X方向的偏移不为0且Page8x+端口存在时,消息沿着X方向路由;否则,当消息的X方向的偏移不为0,而x+方向的端口不存在时,此时消息的Y方向的偏移必定不为0.当消息不能沿着X方向路由时,若消息的Y方向的偏移不为0且y+端口存在,消息沿着Y方向路由.当消息到达目的节点时,消息由该路由器的PE接收,此时该消息路由结束.在虚拟网络(2)中,如算法2所示,若消息从未走过X方向的回转链路,则使用虚拟通道c2,否则使用虚拟通道c1.接下来的路由过程和在虚拟网络(1)中的路由过程类似,只不过在虚拟通道的使用上有一些差别.算法3.TM中适应性路由算法Fully-adaptive_route1().输入:当前节点坐标(xc,yc)和目的节点坐标(xd,yd)输出:一条选定的输出通道1.Channel=;2.IFxc≠xdandx+portexists,Channel=Channel∪3.IFyc≠ydandy+portexists,Channel=Channel∪route2().4.IFxc==xdandyc==yd,Channel={internal};5.RETURNselect(Channel).算法4.TM中适应性路由算法Fully-adaptive_输入:当前节点坐标(xc,yc)和目的节点坐标(xd,yd)输出:一条选定的输出通道1.IF消息走过X方向的回转链路,i=1,否则i=2,Channel=;2.IFxc≠xdandx+portexists,Channel=Channel∪3.IFyc≠ydandy-portexists,Channel=Channel∪4.IFxc==xdandyc==yd,Channel={internal};5.RETURNselect(Channel).5.2完全适应性路由机制根据前面的虚拟网络选择算法,可以在消息路由之前确定其路由的虚拟网络.同样地,我们将不同的虚拟网络中的完全适应性路由算法分开,只给出虚拟网络(1)和(2)中的完全适应性路由算法,如算法3和算法4所示,其中提到的select函数是指在给定的虚拟通道中随机选择一个.如算法3所示,消息在虚拟子网(1)中进行完全适应性路由时,只有虚拟通道c1可用.当消息在X方向的偏移不为0且x+端口存在时,cx,1+作为select函数中的一个选择项;同样,当Y方向的偏移不为0且y+端口存在时,cy,1+作为select函数的一个选择项;当消息在两个方向的偏移均为0时,消息由该路由器的本地PE接收,此时消息路由结束.在虚拟网络(2)中(算法4),若消息从未经过X方向的回转链路,消息使用虚拟通道c2,否则使用虚拟通道c1.接下来的完全适应性路由算法和虚拟网路(1)中类似,只是在虚拟通道的使用上有些差别.5.3最短路由证明在这一部分中,我们将证明前面给出的用于TM网络的路由算法是最短路由,从而也可以得出这些路由算法不会产生活锁.从路由算法本身可以很清楚的看出,确定性路由算法给出的路由路径是完全适应性路由算法给出的路径中的一条,只要我们证明了完全适应性路由算法是最短路由,则可以推导出确定性路由算法是最短路由算法.根据定理1,我们可以计算出任意源节点和目的节点对的最短距离.现在我们来证明完全适应性路由算法给出的路径长度和定理1给出的路径长度一致.定理3.TM网络中给出的上述路由算法是最短路由算法.证明.任意给一条消息,该消息的源节点为s(xs,ys),目的节点为d(xd,yd),我们可以计算s和d的改进坐标,记为(x1,y1)和(x2,y2).这条消息可以路由的路径可以分为两类:一类是经过X方向的回转链路的,另一类是不经过X方向的回转链路的.当消息不经过X方向的回转链路时,该消息在X方向走|x2-x1|跳步,在Y方向走|y2-y1|跳步.若该消息的RD(s,d)不大于TM网络的网络直径n,则消息不会经过任何的X方向的回转链路,即总共需要经过RD(s,d)步到达目的节点,与前述的消息不需要经过X方向的回转链路所需要经过的跳步数一致.当消息的RD(s,d)大于TM网络的网络拓扑直径n时,消息需要经过某个X方向的回转链路,以减少所需要走的步数.总共有8种不同的情况,我们只对4种情况进行讨论,后面的4种情况可以类似推出.(1)情况1.xs<xd,则ys>yd(参考引理1),NHopx=xs+1+(n-1-xd),NHopy=(n-1-ys)+1+yd,NHop=2n+(xs-xd+yd-ys)(2)情况2.xs>xd,则ys<yd(参考引理1),NHopx=(n-1-xs)+1+xd,Page9NHopy=ys+1+(n-1-yd),NHop=2n+(xd-xs+ys-yd)(3)情况3.ys<yd,则xs<xd(参考引理2),NHopx=xs+1+(n-1-xd),NHopy=yd-ys,NHop=n+(xs-xd+yd-ys)(4)情况4.ys>yd,则xs<xd(参考引理2),NHopx=xs+1+(n-1-xd),NHopy=ys-yd,NHop=n+(xs-xd+ys-yd)基于上述分析,很明显TM网络的路由算法是最短路由算法,能保证路由路径最短,同时能保证网络中不会产生活锁.6实验结果和分析为了对TM网络拓扑结构及其路由算法进行评估,我们开发了一个微片层的C++模拟器.模拟器中的路由器有5个端口,确定性路由算法中,每个端口有2条虚拟通道,适应性路由算法中,每个端口有3条虚拟通道;采用虫孔交换,以减少路由器的面积开销;与文献[26]相同,模拟中的报文长度设置为20个微片,包括1个头微片、18个数据微片和1个尾微片;选择8×8的网络规模.针对每一个报文注入率(packetinjectionrate),模拟器运行100000个时钟周期,其中前20000个时钟周期用于网络状态图7均衡通信模型下采用确定性路由算法的性能比较的稳定,后80000个时钟周期用于数据收集.为了更加清晰地评估TM网络的性能,我们还基于虚拟网络划分机制模拟了mesh和torus网络上确定性和完全适应性路由算法,torus网络上的完全适应性路由是在确定性路由的基础上,增加1条虚拟通道并应用Duato协议实现的.6.1通信模型和评价标准片上网络之间的通信是通过发送消息来实现的.为了观察TM网络,我们在3种不同的通信模型下模拟网络通信的性能,3种通信模型为均衡通信(uniform)、置换通信(permutation)和热点通信(hotspot).在均衡通信中,节点可以向该网络中任何其他的节点以同等的概率发送消息.在置换通信中,每个节点只能向某个特定的节点发送消息,这里我们考虑3种不同的置换通信,即transpose、bitreversal、和bitcomplement,这3种置换通信方式在文献[27]中有详细的描述.在热点通信中,某些节点被指派为热点,一个节点可以向该网络中任何其他的节点发送消息.但是会以概率h向热点节点发送消息,向其他节点发送消息的概率相同,本文中我们取h为10%.延迟和吞吐量是评价网络性能的两个重要指标.我们知道,网络平均距离和网络拓扑直径是影响网络性能的两个重要参数,尤其是当网络负载率低的时候.在每个通信模型下,给出网络平均延迟(单位:cycles)和吞吐量(单位:flits/(node·cycle))随消息注入率(单位:packets/(node·cycle))变化的曲线.6.2实验结果分析图7~图9显示的是3种网络在确定性路由算法下的比较结果.均衡通信在许多的模拟通信中采用,但这种通信模型在实际应用中并未出现[28].图7给出的是在均衡通信模型下的比较结果,图7(a)是Page10图8置换通信模型下采用确定性路由算法的性能比较延迟与消息注入率变换的曲线,图7(b)是吞吐量与消息注入率的变化曲线.根据前面的计算可以知道,在8×8的网络中,mesh的平均跳步数是5.33,TM的平均跳步数是4.7,torus的平均跳步数是4.从实验结果来看,当报文注入率低于0.011(packets/(node/cycle))时,TM网络的平均延迟介于mesh网络和torus网络平均延迟的中间位置,当报文注入率增大时,torus网络较mesh和TM网络的优势明显.在uniform通信模型下,网络中的负载均衡,torus网络的完全对称性可以有效地利用负载均衡的优势,因此torus网络在uniform下性能明显优于mesh和TM.然而,在实际应用中,网络通信并非像均衡通信中描述的那样平均分布,因此,我们也模拟了非均衡通信的情况.置换通信是典型的非均衡通信模型之一[28],图8给出了置换通信模型下在不同的网络中使用确定性路由的比较结果,此时TM网络的优势较mesh网络更加明显.原因在于,在mesh网络中,由于网络的中间区域产生拥塞,导致网络很快达到饱和点,而在TM网络中,消息会分为两种不同的情形:一种是在源节点和目的节点的改进距离大于n时消息需要经过X方向的回转链路;另一种是当消息的源节点和目的节点的改进距离不大于n时,消息不必经过任何X方向的回转链路,这将会大大缓解网络的中间区域的拥塞,减缓网络达到饱和点的过程.通过上述分析和实验结果可知,当报文注入率低时,TM网络的性能优于mesh网络是得益于TM网络较低的平均跳步数和较低的网络拓扑直径,当报文注入率高时,TM网络的性能优于mesh网络还得益于TM网络的上述拥塞缓解.在trans-Page11图9热点通信模型下采用确定性路由算法的性能比较pose和bitcomplement两种通信模型下,torus网络的两条虚拟通道都能得到较好的利用,从而使得torus网络的性能最好.而在bitreversal通信模型下,torus网络上通道使用的限制使得两条虚拟通道的使用不均衡,从而影响了torus网络的性能.在bitreversal通信模型下,TM网络的延迟与torus网络的延迟可比,但是TM网络的吞吐量要高于torus网络的吞吐量;在bitreversal通信模型下,大部分的消息需要通过X方向的回转链路,两条通道使用非常不均衡,从而大大影响了它的性能.在大多数通信中,节点通常频繁地与网络中的某一个或某几个节点(例如,存储器资源、I/O资源)进行通信.热点通信通常被认为是一种更为接近实际通信的一种模型,本文中的3种不同的热点模型[31].在第一种热点模型(hs-c1)中,网络中有两个节点被指派为热点,一个位于左下1/4网络的中间位置,另一个位于右上1/4网络的中间位置,在8×8的网络中,这两个热点分别是(2,2)和(5,5).在第二种热点模型(hs-c2)中,网络中有4个节点被指派为热点,这4个节点处于网络的中间位置,在8×8的网络中,这4个热点分别是(3,3)、(3,4)、(4,3)和(4,4).在第3种热点模型(hs-tr)中,网络中4个节点被指派为热点,这4个节点位于网络的右上角,在8×8的网络中,这4个热点分别是(7,7)、(7,6)、(6,7)和(6,6).图9给出了热点模型下的实验结果,同样的,在该通信模型下,TM网络在热点及其附近的拥塞情况要低于mesh网络在该区域的拥塞情形,得益于低的网络平均跳步数和低的网络拓扑直径;当报文注入率增大时,X方向回转链路的使用有助于TM网络的性能提高.在hs-c1通信模型下,Page12mesh网络的饱和点大约为0.005(packets/(node·cycle)),而TM网络和torus网络的饱和点相当,为0.00575(packets/(node·cycle)),较mesh网络向右推了15%;在hs-c2通信模型下,torus网络上虚拟通道的使用不均衡成为其性能瓶颈,在这种通信模型下,torus网络中的大部分消息不需要经过X方向的回转链路,虚拟通道c1上的拥塞严重,这成为其性能下降的重要原因之一.需要强调的是,消息在torus网络中是否经过回转链路的条件和在TM网络中是否经过回转链路的条件是不同的.TM网络中通道的均衡使用对于其性能的提高起着至关重要的作用.图10给出了3种网络在不同的通信模型下采用完全适应性路由算法时的比较结果.从实验结果可以看出,采用完全适应性路由机制时,TM网络在图10不同通信模型下采用完全适应性路由算法的性能比较网络平均延迟和吞吐量方面的性能也优于mesh网络.当虚拟通道个数增加时,由于增加的第3条虚拟通道提供的是完全适应性路由,torus网络中通道使用失衡的情况得到缓解.在完全适应性路由中,大部分情况下,torus网络的性能要优于TM网络,某些情况下,二者的性能接近.但是,在输入缓冲的路由器设计中[29],当虚拟通道个数增加时,片上网络路由器的面积开销和设计复杂性大大提高,这也是我们为什么要将虚拟通道个数降下来的原因.TM网络可以提供2条虚拟通道时的完全适应性路由,而torus网络实现适应性路由时至少需要3条虚拟通道.从路由器的设计复杂性上来说,TM网络和mesh网络的路由器设计复杂性相当,而TM网络的性能在要优于mesh网络,因此这种新的网络拓扑结构设计是非常有意义的.Page137总结本文提出了一种新的网络拓扑结构TM,它结合了torus和mesh的优点:在一个n×n的网络中,TM网络和mesh网络的链路数目相同,比torus网络的链路数目少2n;TM网络拓扑直径为n,而torus网络拓扑直径为2·(n/2),可知当n为偶数时,二者相同,当n为奇数时,TM网络拓扑直径比torus网络拓扑直径大1,而mesh网络拓扑直径为2·(n-1);TM网络的平均距离介于mesh网络的平均距离与torus网络的平均距离的中间;路由算法设计方面,torus网络上由于每一行(列)上都有一个环,使得torus网络上的完全适应性无死锁路由算法设计所需要的虚拟通道的数目至少为3,同时虚拟网络划分机制不能适用于torus网络,而如本文所示,虚拟网络划分机制适用于mesh和TM网络;路由器设计方面,TM网络的路由器设计与mesh网络接近,而比torus路由器设计简单.通过使用虚拟网络划分机制,本文中给出了一种简单的适用于TM网络上的确定性无死锁最短路由算法和完全适应性无死锁最短路由算法.TM网络中路由器需要的虚拟通道个数为2,且路由算法设计简单,与mesh网络中路由算法设计TM网络中路由器设计复杂度和mesh网络的路由器设计复杂度相当.实验结果表明,TM网络拓扑结构在平均延迟和吞吐量等两个方面均优于mesh网络拓扑结构.因此,TM网络在mesh网络路由器设计复杂性的基础上提高了网络的性能,这对于片上网络拓扑的研究是非常有意义的.致谢在此,我们向对本文的研究工作提出指导性意见和建议的Georgia州立大学的潘毅老师以及Temple大学的吴杰老师表示衷心的感谢.同时,我们还要感谢各位审稿老师,他们针对本文工作提出了宝贵意见和建议!
