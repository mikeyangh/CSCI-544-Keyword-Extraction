Page1分级环片上网络互连王炜1),2)乔林1)杨广文1)汤志忠1)1)(清华大学计算机科学与技术系北京100084)2)(解放军信息工程大学信息工程学院计算机科学与技术系郑州450002)摘要在大规模、超大规模片上互连网络中,因为二维互连方式的性能较差而使多维互连方式成为可选方案之一.文中首先基于区域划分设计了一种分级环互连结构,分析了其静态互连特性,然后基于卡诺图编码设计了一种分级环互连的路由结构以及寻径方法,在均匀通信模式测试了不同的分级环级联链路缓冲区设置方法下网络的性能,详细分析了按照等比序列设置分级环级联链路缓冲区时分级环互连方式的动态网络特性,最后根据互连性能与Mesh等二维片上互连方式比较的结果,给出了分级环互连方式的使用场合.实验结果表明,虽然在较小规模网络中性能较差,但是分级环互连方式能以较低的成本、较高的性能实现大规模、超大规模片上网络的互连,其中单环分级互连方式在较低网络负载下综合性能更好,而双环分级互连方式则具有更大的网络负载能力,在较高网络负载下性能更好.关键词片上多处理器;片上网络;分级环;性能分析1引言随着计算机技术的不断发展,片上多处理器(ChipMultiprocessor,CMP)逐渐成为主流,CMP中互连网络(即片上网络Networks-on-Chip,NoC)及其通信逐渐成为影响系统性能的重要因素.一般来说,高吞吐量、低延迟为片上网络追求的重要目标[1-2],而由于物理空间的限制,布局布线复杂度、功耗、芯片面积也是片上网络设计时需要考虑的重要因素[2],因此要求片上网络使用尽量简单的物理结构、通信协议和控制(路由)机制.基本的二维NoC主要有总线与线性阵列、Mesh网格、环与带弦环等及其变形结构.文献[1]简要分析了总线与线性阵列的网络特性,文献[3-4]基于全局均匀随机模型分别分析了如图1所示的几种片上二维网络的性能,我们另一篇文章则基于局部均匀随机模型分析了这些结构的性能.分析结果表明,在网络规模较大时单独直接使用这些结构均不能高效、快速地实现NoC的互连[1,3-4],因此,需要考虑新的互连方法,例如将基本的二维NoC向高维扩展、组合使用多种基本拓扑结构以及设计新型互连结构等.本文首先基于区域划分设计了一种分级环互连结构,分析了其静态互连特性,然后基于卡诺图编码设计了一种分级环互连的路由结构以及寻径方法,基于均匀通信模式测试了不同的级联链路路由结点缓冲区设置方法下网络的性能,详细分析了按照等比序列设置级联链路路由结点缓冲区时分级环互连方式的动态网络特性,最后根据互连性能与Mesh等二维片上互连方式比较的结果,给出了分级环互连方式的使用场合.2分级环互连结构最基本的环状互连是线性阵列互连的一种改进,它将线性阵列首尾两个端点连结起来,有效降低了网络直径[1,5].但如结点数目较多,网络直径仍然比较大.一种降低网络直径的方法是使用多环.文献[3]分析了如图1(d)和(e)所示的多环相切直连和多环相切的类Torus结构的性能.实验数据表明:这种多环相切方式的互连效率并不理想[3].另一种降低环网网络直径的方法是使用带弦环[3,5].随着弦数量的增加,带弦环网络直径显著减小,而且网络吞吐量也明显增加.但是,随着弦的增加,网络结点的度也增大,需要更多的连线资源和芯片面积,功耗也相应增加.另外,弦数量的上升也增加了布局布线的复杂度.因为在很多情况下,通信往往具有局部性:只有少数通信需要在相邻较远的结点间进行,更多的通信是在相邻较近的结点间进行[6-8]①,这就意味着可以将局部区域的结点连接到一起,然后通过逐级互连从而构成分级结构[1,9],为此将若干个结点连接到一个较小的环上(我们称这些小环构成的网络为第1级网络,以此类推),然后将若干个小环连接到一个较大的环上,以此类推,直到将所有结点连接到①NASParallelBenchmarks:ProActiveimplementations.ht-tp://proactive.inria.fr/index.php?page=nas_bench-Page3一起.这种结构中由于环上的结点数目较少,因此可以不需要弦,或者只需要较少量的弦,又由于与其它环上的结点之间通过级联的方法进行通信,所以延迟也较小,对于一个n×n(n=2r,r2)网络,平均寻径距离为2r-1,等分带宽均为2.假设每α个结点连接成一个环,每α个较小的环连接成一个较大的环,则完成网络连接需要将网络分成2logαn级,一共需要n2+∑2logαn-1中用于级联的链路共∑2logαn-1了如图2(a)所示的分级环互连结构.为便于后面的寻径操作,对结点进行卡诺图编码.一个n位码字的完整卡诺图编码序列共有2n个编码,而且任意两个相邻的编码之间有且仅有一个码字不同.对所有结点的纵横坐标均进行卡诺图编码后,如图2(a)所示的分级环互连结构可以描述为:对于任何一点S(Sx,Sy),令Sx=xk…x2x1,Sy=yk…y2y1,x0=y0=1,则当且仅当xi=yi=1,i=0,1,2,…,p-1时有点D(Dx,Dy)与S相连,其中或Dx=xk…x2x1若某一结点处在第i级网络中,那么第j(0<j<i)级网络必有且仅有一个环通过该结点.称与之相连的链路最高处于第k层网络的结点为第k层结点,则第k(0<k<2logαn)层结点共有n2(α-1)其结点度为2k;第2logαn层结点共有α个,其结点度为4logαn.在如图2(a)所示的分级环互连结构中,因为有级联环的存在,B和C之间的寻径距离近了,但是A和D之间的寻径距离仍然较远.当然,也可以使级联环经过A和D而不经过B和C,此时的网络互连关系是这样的:对于任何一点S(Sx,Sy),令Sx=xk…x2x1,Sy=yk…y2y1,x0=y0=0,则当且仅当xi=yi=0,i=0,1,2,…,p-1时有点D(Dx,Dy)与S相连,其中或Dx=xk…x2x1为了进一步减少结点间的寻径距离,可以使用两套级联环,如图2(b)所示分别将类似A和D、B和C的点级联起来,这样就构成了双环分级互连方式,其等分带宽为4.使用这种双环分级互连方式连接上述n×n(n=2r,r2)网络,平均寻径距离为r.仍然假设每α个结点连接成一个环,每α个较小的环连接成一个较大的环,则非级联链路数不变,级联链路数变为单环分级互连方式的2倍,因此共需链路n2+2∑2logαn-1各层结点的数目发生变化:第k(0<k<2logαn)层结点共有n2(α-2)3分级环互连路由与寻径方法和文献[3-4]一样,我们仍然采用虫蚀寻径以包为单位分片传输数据,在不阻塞的情况下,每个时钟周期数据片向前传送一跳,并使用超时扬弃策略解决死锁或活锁问题[3-4].3.1分级环互连路由结构多级环互连中,仅仅处于第1级环上的路由结点只需要连接其第1级环上的“左”、“右”路由结点和本地结点,因此其内部路由结构与文献[3-4]中讨论的路由结构相同即可.值得注意的是,与文献[3-4]中讨论的一样,由于路由结点除了连接其它路由结点外,还需要连接到本地结点,因此,所有路由结点(包括下面讨论的处于其它层上的路由结点)的链路数应该在前面讨论的基础上加1[3].多级环互连中级联点上的路由结点需要完成多维互连,因此级联点的路由结构与文献[3-4]中所使用的路由结构有所不同.图3所示的是多级环的路由结点及其连接,其中图3(a)的路由结点C就是图2(a)中的路由结点C,图3(b)给出的是路由结点C内部的结构.Page4图3多级环网路由结点及其连接为了降低网络功耗,减少片上网络的芯片面积并提高网络传送速度,仍然采用出端缓冲片上路由结构[3],所有结点间连接均通过一入一出两条单向链路完成,结点内部则通过交叉开关实现同时多对链路相连.与本地结点连接的链路不设置缓冲区,数据缓冲由本地结点内部完成.与其它路由结点相连的链路上采用出端缓冲的方式,下一时刻当前方不阻塞时,被传送的数据片将由下一路由结点的交叉开关直接送到某出端缓冲区.缓冲区结构如图3(c)所示,与文献[3-4]中一样,仍然是将所有出端缓冲区和本地结点统一编址.一般而言,层次互连结构中的级联链路将承担比非级联链路更多的通信传送,而且级联层次越高,链路上的通信越多.为了避免级联链路成为系统的瓶颈,需要增强级联链路的通信传送能力.最简单而且有效的方法是如图3(a)所示增加级联链路的带宽,相应地需要增加不同级联链路的出端缓冲区的个数,这就意味着较高层路由结点中需要更大规模的交叉开关和寻径逻辑.交叉开关的硬件复杂度为O(n2,w),其中,n为输入/输出数量,w为带宽[10-12].而且当n超过16以后,不仅交叉开关过于复杂,而且不能保证在一拍之内完成输入/输出之间的互连[5],因此,不能将级联链路/缓冲区数量设置过大.为此考虑4种级联链路/缓冲区设置模式:模式A:所有级别均设置1个链路/缓冲区,在4×4、8×8、16×16、32×32网络里交叉开关最大规模分别为5×5、7×7、9×9、11×11;模式B:不同级按照等差序列设置,从低到高各层分别设置1、2、3、4…个链路/缓冲区,在4×4、8×8、16×16、32×32网络里交叉开关最大规模分别为7×7、13×13、21×21和31×31,其中16×16、32×32网络里分别有4个和16个规模大于16×16的交叉开关;模式C:不同级按照等比序列设置,从低到高各层分别设置1、2、4、8…个链路/缓冲区,在4×4、8×8、16×16、32×32网络里交叉开关最大规模分别为7×7、15×15、31×31、63×63,其中16×16、32×32网络里分别有4个和16个规模大于16×16的交叉开关;模式D:不同级按照本级1/4区域结点规模设置,从低到高各层分别设置1、4、16、64…个链路/缓冲区,在4×4、8×8、16×16、32×32网络里交叉开关最大规模分别为11×11、43×43、171×171、683×683,其中规模超过16×16的交叉开关分别有0个、4个、16个和64个.模式D方式下在8×8及其以上规模网络中均有为数不少的交叉开关过于复杂,因此不予考虑;而模式B和模式C方式下只有16×16和32×32网络中有极少数比较复杂的交叉开关,其所占的比例较小,可以考虑.后面的实验数据表明,模式C方式下网络性能基本满足需要,可以不考虑更复杂的设置方法.表1分别给出了α=4时分级环互连以及其它Page5互连结构的部分静态性能.显然,在较复杂的交叉开关处的寻径与数据传送时间将有所延长,但是可以表1分级环互连(α=4时)部分静态网络特性与其它互连方式的比较规模结构等分带宽网络直径/4×4H-ring(s)26/2.932.5/4202082430424304H-ring(d)44/2.333/42427232464324648×8H-ring(s)210/4.762.56/68492810816961121920H-ring(d)46/3.733.25/610412801522816160326416×16H-ring(s)214/6.702.66/83403840448787248010624H-ring(d)48/5.443.31/84245376640134407041894432×32H-ring(s)218/8.682.66/10136415520176033568184054528H-ring(d)410/7.183.33/10170421824249657920265699840数据显示,分级环互连方式的等分带宽较小,而且等分带宽与网络规模无关,这表明分级环互连方式的性能瓶颈在级联链路上,而且网络规模越大,瓶颈作用越明显.4×4网络中,分级环互连方式的网络直径和平均寻径距离与Mesh方式相当,但是随着网络规模的增加,分级环互连方式的网络直径和平均寻径距离相比较其它几种结构越来越小,在32×32网络中甚至低于三角形网眼环网,这表明,分级环互连方式更适合较大规模网络.和Mesh网相似,随着网络规模的增加,分级环互连方式的平均结点度逐渐上升,但是与Mesh网中最大结点度保持不变不同,分级环互连方式的最大结点度也不断增加,但是即使在32×32网络中分级环互连方式的平均结点也低于Mesh方式,这表明分级环互连方式中不同结点的度差异更大.在各种规模网络中,无论联结链路结点的链路和缓冲区按照上述何种方式设置,单环分级互连方式所需的链路和缓冲区数都不多于Mesh方式、双环互连方式则不多于三角形网眼环网方式,表明分级环互连方式在链路和缓冲区上所需的成本低于对应的互连结构,这就使得分级环互连方式的布局布线复杂度较低,而且系统功耗较低、网络传送速度较快.另一方面,在网络规模较小时分级环互连方式用于交叉开关的总成本不高于对应的互连结构,但是采取某些方法使得仍然比结点间的延迟相比小得多[13],为简便计暂时不考虑.每层一个随着网络规模的增加,当使用等差或等比序列模式设置级联链路有结点链路/缓冲区时,分级环中用于交叉开关的总成本逐渐超过对应的互连结构,这主要是因为随着规模的增加,较高层联结链路所需交叉开关过于复杂的缘故,而那少数几个特别复杂的交叉开关花费了交叉开关总成本的相当部分,当然这个问题也可以通过某些技术予以解决[13].值得注意的是,双环互连方式相比单环方式虽然多了一套级联链路,但是其平均寻径距离的优势并不明显,而且该优势在所有规模网络下几乎保持不变,而其所需的链路数/缓冲区数与用于交叉开关的总硬件成本却远大于单环方式,这表明,整体相对而言双环方式并不优于单环方式.综上对网络静态特性的分析可知,通过合理分配级联链路宽度和缓冲区数量,在较大规模网络中分级环互连方式特别是单环分级互连方式将获得更小的网络延迟、更少的互连链路与更低的网络布局布线复杂度、更低的功耗,而这些是以局部更复杂的交叉开关和整体更高的交叉开关成本作为代价的.3.2基于卡诺图编码的分级环寻径方法多级环互连仍使用同文献[3-4]一样的通信协议,寻径操作由寻径逻辑根据包头中目标地址自动完成.寻径逻辑在进行寻径操作时,总是根据当前包头结点的位置和目的结点的位置来确定下一条的位置.进行卡诺图编码后,若两个结点的横坐标、纵坐Page6标的最高位分别相等,则两个结点同属于一个1/4区域,若两个结点的横坐标、纵坐标的次高位也分别相等,则两个结点同属于上述1/4区域中的一个小1/4区域,以此类推.当两个结点同属于一个1/4区域时,只需要在该1/4区域内寻径即可,相当于寻径时将那些分别相等的较高位地址舍弃,从而降低了寻径的维度.若两个结点的横坐标或纵坐标的最高位不相等,则两个结点不属于一个1/4区域,此时需要判断在当前结点所在的1/4区域内实现两个1/4区域级图4基于卡诺图编码的分级环寻径图4分别给出了单环和双环分级互连中使用上述寻径方法的一条寻径线路.需要注意的是,双环分级中实现不同1/4区域级联的点有两个,分别位于内环和外环上,因此在寻径的时候需要根据源和目的的位置关系做出选择.4分级环互连网络特性本文同文献[3-4]一样,通过对同一通信请求序列在不同结构网络中的模拟传输比较分级环互连结构与其它互连结构的网络性能.另外的实验结果表明,全局均匀随机通信模式是局部均匀随机通信模式的特例,全局均匀随机通信模式下不同结构网络图5网络冲突总数联的路由结点的位置.若此时的结点恰好是那个级联结点,只需要将当前的(也即“舍弃了”部分高位码字的)纵横坐标中最高位与目的结点最高位不同的那一个(如果两个都不相同,任取其一)取反然后拼接上前面“舍弃”的部分高位码字即得到了下一跳的坐标;若此时的结点不是那个需要的级联结点,则将那个需要的级联结点作为暂时的目的结点,重新进行网络寻径操作,直到找到下一跳的坐标.效而且控制逻辑简单,很容易在片上实现.这种基于卡诺图编码的路由寻径方法快速、有性能之间的相互关系能够完全代表局部均匀随机通信模式下的相互关系,因此,下面的实验中主要讨论全局均匀随机通信模式下的网络性能.另外,文献[3-4]的实验数据显示,相比较六边形网眼Mesh及其变形结构、多环相切及其回绕结构而言,四边形、三角形网眼Mesh网络及其变形结构具有更好的规模扩展性和网络负载能力,同时网络综合性能也较好,而Torus结构和Illiac结构的网络性能非常近似,因此,下面的实验主要将分级环互连结构与Mesh、Illiac和三角形网眼Mesh结构做比较.4.1网络冲突与通信平均延迟图5和图6分别给出了不同规模各种结构的网络冲突总数和网络通信平均延迟.实验数据显示,当Page7图6网络通信平均延迟网络规模较小(包括8×8)时,单环分级互连方式下网络的冲突总数不低于Illiac方式,而双环分级互连方式不低于三角形网眼环网方式,对应地,它们的网络通信平均延迟也分别不低于其它两种方式;但是当网络规模增大时,分级环互连方式下的网络冲突总数变得比三角形网眼环网方式还要少,相应地,其网络通信平均延迟也最小.这表明,相对而言,分级环互连方式更适合于较大规模网络的连接与通信.两种分级环互连方式中,单环比双环方式网络冲突总数多而网络通信平均延迟高,这显然是因为单环分级方式的链路数较少的原因.但是,在较低网图7网络通信传送完成率能力.如文献[3-4]一样,本文使用平均每一时刻网络中允许的新通信请求的最大值来表示网络负载,并定义网络通信传送完成率不低于95%时网络所能承受的最大负载为网络的理想负载,它同时也是平均延迟随着网络负载增加而增加率最大时的网络负载;定义使网络通信传送完成率不低于80%时网络所能承受的最大负载为网络的有效负载,它同时也是网络通信传送完成率随着网络负载增加而降低率最大时的网络负载.图8给出了各结构的理想负载络负载下二者性能相差不大.4.2网络通信传送完成率与负载能力图7所示的是不同规模各种结构网络通信传送完成率的情况.数据显示,单环分级互连方式的通信传送完成率低于双环方式,但是在较小规模下相差不大.在较小规模中,单环分级互连方式的通信传送完成率最低,但随着网络规模的增加,其通信传送完成率逐渐变得与Mesh结构的相当;而双环互连方式下的通信传送完成率则从低于三角形网眼环网方式到超过三角形网眼环网方式.这同样表明分级环互连方式更适合于较大规模网络.数据显示,当网络规模逐渐增加时,单环分级互连方式的理想负载逐渐从低于Mesh方式增加到高于Mesh方式,但总体上都与Mesh方式相当,而双环方式的则逐渐从远低于三角形网眼环网方式增加到高于三角形网眼环网方式,这表明,分级环互连方式更适合较大规模网络,而且其负载能力的规模扩展性要好于其它结构.另外,单环方式的负载能力低于双环方式,而且随着网络规模的增加,二者负载能Page8力的差别越来越大,这表明,相对而言双环方式更适合于高通信负载网络的互连.图9给出的是各种规模下所有网络均工作在Mesh网的理想负载下时网络平均延迟的情况.图中显示,在较小规模网络中,单环分级互连方式的平均延迟大于Mesh方式而双环方式则稍大于三角形网眼环网方式,但是在较大规模网络中,它们分别低于对应的互连结构,而且网络规模越大,其差距越大,这进一步表明分级环互连方式相比较而言更适于较大规模网络的互连,而且网络规模越大,其相对性能提升越多.图9工作在Mesh理想负载下的网络平均延迟5结论和下一步的工作本文设计了基于二维区域划分的分级环片上网络互连结构和基于卡诺图编码的分级环路由结构与寻径方法,面向全局均匀随机通信模式详细分析了分级环互连的网络特性.与Mesh等通过二维平面方式进行互连不同,分级环通过级联方式将网络中的结点按区域逐层连结起来,不仅节省了链路,而且降低了网络直径和平均寻径距离.在分级环互连中,级联链路成为影响网络性能的主要因素,实验数据表明,只需按照等比序列设置各层路由结点中的缓冲区数量即可以获得较好的网络性能.由于增加的链路和缓冲区较少,分级环方式互连成本仍然较低.由于网络规模较小时与Mesh等二维互连方式相比分级环互连方式节省的互连成本有限、网络直径以及平均寻径距离的减少有限,而级联方式又一定程度上增加了网络冲突产生的可能,因此在较小规模下分级环方式的互连性能较差;随着网络规模的增加,分级环互连方式下网络直径和平均寻径距离的减小越来越明显,逐渐抵消了由于级联而导致的网络冲突增加的因素,从而使得分级环方式的互连性能越来越好,这表明,分级环互连方式更适合大规模超大规模片上网络.特别指出的是,以上结果是基于全局均匀通信模式分析得到的,基于局部均匀通信模式的实验数据表明,局部通信概率越高,分级环互连方式的相对性能越好.与单环分级互连相比,双环分级互连具有更大的网络负载能力和更低的单位延迟负载能力,因此当网络负载较大时,双环方式的综合性能会更好;但是,在较低的网络负载下,双环方式各方面的性能与单环方式差别不大,而双环方式所需的缓冲区数量远多于单环方式、其布局布线复杂度也远高于单环方式,因此,在网络负载较低时,单环方式是更好的选择.以上的分析都是假设限定区域内的通信分布是均匀随机的,它能够分析某一类网络应用在特定互连结构中的平均性能.为了分析具体应用在相关互连结构下的性能,下一步将使用真实的片上网络通信分析、验证网络性能.
