Page1不依赖于量化参数的视频编码控制优化技术袁武1)牛振东1)林守勋2)林子涵1)谢辉3)罗海勇2)1)(北京理工大学计算机学院北京100081)2)(中国科学院计算技术研究所北京100190)3)(中国石油长城钻探工程有限公司北京100101)摘要目前,混合式视频编码技术普遍采用基于量化参数的Lagrange乘子优化算法(QP-L)实现预测编码的率失真优化计算.文中则提出一种新的率失真优化算法Adapt-L,可以根据视频信号的率失真统计特性,自适应地调整Lagrange乘子的计算.实验及数据分析表明,在QP-L算法的Lagrange乘子和视频信号的率失真统计信息之间存在线性关系;由此,提出一个启发式的Lagrange乘子计算模型,并对该数学模型的合理性进行理论验证.大量实验证明,Adapt-L的编码效率优于基于量化参数的优化算法(QP-L).虽然Adapt-L相对稍为复杂,但其计算不依赖于量化参数,有利于实现高效的码率控制.关键词率失真优化;视频编码控制;Lagrange优化技术1引言目前,常见的视频压缩系统基本上都采用了有损压缩的混合式(Hybrid)编码架构.在该架构下,视频编码器可以针对各种具有复杂统计特征的视频信号,使用不同的编码工具(及组合)消除各种冗余信息,从而压缩视频数据.其基本处理过程包括预测编码、预测残差DCT系数量化及熵编码等环节.在预测编码环节,通过模式选择和预测补偿,消除视频信号的时-空域相关性;在码率控制环节,通过DCT系数量化控制预测残差的码率及失真.视频编码控制技术就是研究相关参数(包括编码模式MD、运动矢量MV和量化参数QP)的计算问题,以期用尽可能少的比特获得高质量的重建图像.据信息论,视频压缩的码率和失真满足下凸非递减关系.一般地,码率越低则失真越大,反之亦然,码率极低和失真极小二者不可兼得[1].因此,只有在失真与码率之间实现恰当的折衷,才能实现编码控制的优化计算,获得较高的编码效率.考虑到信道带宽对多媒体通信的客观限制,该问题实质上是一个有约束极值求解,其数学表达形式如下:minMD∈,MV∈,QP∈s.t.R(MD,MV,QP)Rc其中,、、和分别表示编码模式、运动矢量和量化参数的取值范围,D(MD,MV,QP)表示图像失真,R(MD,MV,QP)表示码率,而Rc表示信道带宽.对凸函数有约束极值问题的求解,采用Lagrange乘子法,可以转换为对等价的无约束极值问题进行求解,如式(2)所示:minMD∈,MV∈,QP∈其中,λ表示Lagrange乘子.根据式(2)的最小值选择编码工具(及组合),在码率和失真之间实现折衷,很显然,该式能否实现高效的编码效率,关键在于λ值的选取.围绕上述问题,学术界开展了大量的研究工作.文献[2]指出,在Rc已知的条件下,可以根据码率-失真的单调性,利用二分法通过多次编码逐渐逼近λ的最佳值,缺点是计算复杂度高,编码延迟大.文献[3-4]根据率失真理论建立了λ关于量化参数的数学模型λQP=cQ2(QP-L模型),其中Q为QP对应的量化步长,c为某个常数.在计算编码模式和运动矢量时,可根据代价函数J=D+λQPR的最小值来选择.QP-L算法有效地提高了视频压缩的编码效率,在H.26L及H.264/AVC等标准中得到应用[5-6].但是,由于视频信号的率失真统计特征关联诸元在QP-L模型中的缺位,其计算结果不可能对任意视频序列都为最优[7].此外,QP-L模型对量化参数存在依赖性,不利于实现高效的视频编码控制:一般地,量化参数主要用于控制预测残差的码率及失真,其值在预测编码后才能有效计算,而QP-L在预测编码计算时就需要预先知道量化参数,二者内在相互抵触,属于“鸡与蛋”逻辑悖论[8-9].文献[10]对QP-L算法进行改进,在运动补偿环节,根据上层或相邻图像块的率失真统计信息修正代价函数.该算法对编码效率的提高较为有限,仅在低复杂度模式启用(RDOptimization=0,也即关闭率失真优化模式)的情况下较为明显,而对于高复杂度模式基本无用.文献[11]提出一种基于Laplace分布假设的率失真优化模型,数学表达形式较为复杂.该算法根据量化参数及视频信号的率失真统计特征,以图像帧为单位,计算代价函数的Lagrange乘子λ值,对不符合Laplace分布假设的情况,则修正为QP-L模型.该模型能够有效地改进图像运动平缓的视频序列的编码效率;对于图像运动剧烈的视频序列,编码效率和QP-L模型相近.本文目标在于建立一个不依赖于量化参数,能够根据视频信号的率失真统计特征自适应调整的率失真优化模型.本文作者在大量实验的基础上,发现λQP与视频信号率失真统计特征诸元的一定数学形式满足线性关系,由此建立λ关于视频信号的率失真统计特征的函数模型(Adapt-L);并进一步提出一种新的率失真优化算法,可以在图像宏块级,根据视频压缩的实际情况自适应地调整模型参数.大量的实验表明,Adapt-L算法的编码性能优于QP-L算法.虽然Adapt-L相对QP-L稍为复杂,但其计算过程不引入量化参数,避免了“鸡与蛋”悖论问题,有利于实现高效的视频编码控制.本文在第2节介绍经典的QP-L算法;在第3节,通过实验与数据分析,表明λQP与视频信号的率失真统计特征符合线性关系;在第4节,建立λ关于视频信号的率失真统计特征的函数模型,并在理论上验证该模型的合理性;在第5节,介绍QP-L算法的具体实现,在第6节介绍对比测试实验和结果分析;最后是总结.Page32QP-L算法一般地,视频信号经过预测编码以及DCT变换之后,预测残差DCT分量之间的相关性很小(可以认为它们“近似”不相关),且满足Laplace分布规律.根据文献[1],如果使用重建图像与原始图像像素值之间的平均绝对值误差(MAD)表示图像失真,也即是D(x,x-)=|x-x-|,那么在预测残差的码率与失真之间存在如下函数关系:不妨假设码率-失真是可微函数关系,把式(3)代入到式(2)中,对式(2)求关于R的导数,并置为0.经过推导,可得下式:假设图像失真符合均匀分布,可以导出失真关于量化步长Q的函数关系,如下所示:把式(5)代入到式(4)中,可得QP-L模型:其中,c为一个常数,可用实验方法确定其值(一般用0.85的经验值).在QP-L算法中,根据式(7)最小值来选择编码模式;对于运动补偿,则按照式(8)最小值来选择运动矢量.J(s,c,mode|QP,λmode)=SSD(s,c,mode|QP)+λQPmode·R(s,c,mode|QP)J(犿,λmotion)=其中,SSD(s,c,mode|QP)是原始像素和重建像素之间的误差平方和,SA(T)D(s,c(犿))是预测残差分量的绝对值和.在式(8)中,λQP我们知道,视频压缩码流包括预测残差的编码信息和宏块编码副信息两部分.对于低码率应用场景,宏块编码副信息所占码流比例可达20%~30%,对视频压缩编码性能的作用不可忽视[7].QP-L算法在副信息和预测残差之间优化比特分配,显著地提高了视频编码性能;加之计算形式也比较简单,在H.263和H.264/AVC中得到了广泛的应用.但是,也正由于模型的过于简单,QP-L算法存在以下缺陷:(2)不具备自适应性.视频信号统计特征非常复杂.在不同的视频序列之间,统计特征差异较大(在第7节可以看到,不同的视频序列具有不同的码率-失真曲线).QP-L模型缺乏表征视频信号统计特性的关联量,只要量化参数相等,即使信号特征迥异,QP-L算法对所有的视频序列都使用相同值的λ,其优化结果不可能对任何视频序列都是最优的[7,10-11],在编码效率上存在提升空间.3λQPmode与率失真统计信息之间的函数关系在QP-L模型中,λQP(1)视频编码控制过程复杂化.在QP-L模型中,QP是唯一参变量,该模型的编码性能取决于量化参数的合理取值.在Hybrid编码结构中,量化参数主要用于控制预测残差的码率及失真的大小.为了有效地控制视频压缩码流大小,需要根据预测残差的率失真统计信息计算量化参数,但是,相关统计信息无法先于预测编码得到.为此,可以通过多次编码处理逐渐逼近,或者采用预测技术估计.对于前者,计算复杂度非常高,不适用于实时应用场景;而对于后者,预测的准确性是关键因素.而视频信号属于非平稳信号,统计特征非常复杂,难于用简单方式有效地预测.关.而据文献[4],λ在物理意义上对应着码率-失真曲线的负斜率.因此,λ的最佳取值应取决于视频信号的率失真特性.如果把式(3)直接代入式(4),可以发现λ又是关于失真的函数关系.由此,有足够的理由相信,λQP种形式的函数关系.顾名思义,率失真优化是在失真和码率两个不同的量纲上进行折衷的技术.我们知道,失真和码率是无法进行直接比较的,但是如果把它们转化为相同量纲,不是就可以比较了吗?从考虑当前宏块对视频序列总体率失真性能的综合影响最小的角度出发,设计了第1个实验.实验1.假设存在预测编码的其它判断准则,根据式(9)的最小值选择当前宏块的编码模式:J(mode)=SSDn(mode)+λ(1)SSDtotaln-1Rtotaln-1Rn(mode)其中,n表示在当前帧内当前宏块序号,λ(1)表示该Page4判断准则的Lagrange乘子,SSDtotaln-1=∑n-1当前总失真,Rtotaln-1=∑n-1实验以QP-L算法优化结果{SSDQP-RDOn,RQP-RDOn}作为测试基准,如果新判断准则要取得和QP-L算法相近的编码性能,那么对任意优化结果{Dn,Rn},λ(1)应该满足以下条件:SSDQP-RDOn+λ(1)SSDtotaln-1Rtotaln-1RQP-RDOnSSDn+λ(1)SSDtotaln-1Rtotaln-1Rn等价于下式:图1λ(1)可行值分布λ(1)SSDn-SSDQP-RDOnSSDtotaln-1烄烅λ(1)SSDn-SSDQP-RDOnSSDtotaln-1烆为了确定λ(1)取值范围,对大量视频序列进行Intra模式编码处理,所用的量化参数分别为8,10,12,…,50.针对每个视频序列,分别统计取值范围的上确界(Upperbound)以及下确界(Lowerbound).实验数据表明,在Lowerbound、Upperbound之间存在较为明显的分界区域,如图1所示.注意:实验数Page5据绝大多数都满足Lowerbound<Upperbound,但是,也会出现少数Upperbound<Lowerbound的情况.后者意味着无法找到一个λ(1)能够满足式(11),也就是说其计算结果不可能与QP-L算法相同,但该情况出现的概率很低,对分析结论的影响可以忽略.不妨假设可以用一个函数f表示Lowerbound、Upperbound的分界(根据实验结果,实际上可以用线性函数甚或一个常数作为f的表达式).由此表明λQPmode与视频信号统计特性之间可能存在一定形式的简单数学关系.上述结论并不适用于Inter编码模式.Inter编码模式拥有更多、更复杂的编码选项,不同选项之间的码率-失真特性差异较大,而优化结果仅仅反映单个选项的编码情况.因此,无法简单地利用个体的率失真信息{SSDlagrange,Rlagrange}有效地表征视频信号的统计特征.实验2.在图像宏块编码时,针对编码模式及实验1和实验2都表明λQPmode与视频信号统计特性之间存在一定形式的简单数学关系.由此,我们可以得到λ关于视频信号统计特性的一个启发性函数模型:下面,我们利用率失真理论验证上述公式的合理性.4理论验证对式(3)采用泰勒级数展开,舍弃高阶项,可以得到MPEG-4Q2码率模型[14]:运动估计的所有可能选项及其组合,计算图像失真及码率均值:SSDaveragen=∑,∑,R,,动估计不同组合的基数.实验的目的在于针对不同的量化参数,分析λQPmode与f(SSDtotaln,Rtotaln)之间的函数关系,其中SSDtotaln=∑nf表示关于SSDtotaln和Rtotaln的二元函数关系.f可能存在多种不同的数学形式,经过多次实验,发现λQPmode与f=SSDtotalnRtotaln图2显示了部分实验数据,这些数据都是关于同一个宏块(位于第一个P帧第5行5列)的.可以看到在λQPmode与SSDtotalnRtotaln的函数关系其中,X2和X1是模型参数,其值可以用线性回归技术加以确定.把式(13)代入式(2),则视频编码控制的率失真优化问题可以如下表述:得到利用Lagrange乘子技术,经过数学推导,可以λ=2SSD式(15)与式(12)在数学表达形式具有一致性.在式(15)中,X2是唯一的未定量.下面,我们将通过实验和数据分析建立X2关于预测残差分量平方和(SumofSquaresError/SSE)的数学模型.Page65犡2数学建模文献[11]指出,可以使用线性回归技术计算MPEG-4Q2码率模型的参数X2和X1.我们在实验中发现,模型参数(X2和X1)与预测残差SSE之间存在一定的相关性.为了对这种关系进行量化分析,设计如下的实验:在宏块编码时,记录所有的关于图像失真、预测图3X2关于预测残差SSE的函数关系3.94E+09烄0.00313,SSE>3038X2=烅1E-07×SSE2-0.0002×SSE+0.041,其它烆SSE优化算法具体实现如下所述:首先,分配缓冲区,用于保存当前帧以及前一帧每个宏块的平均失真、预测残差平均码率及平均SSE.针对第一个I帧,采用QP-L方法进行优化计算,记录每次编码处理的失真、预测残差码率和SSE,并把相关均值保存在缓冲区中;对于P帧宏块,在当前帧及前一帧搜索与当前宏块相邻(|Δx+Δy|Radius_Threshold)的已编码宏块,计算各统计信息均值;把所得到的平均失真、平均码率以及平均SSE代入到式(17)中,计算出λ;为了避免λ变化太大,可以根据历史平均值λframeaverage对λ进行限制.获得的λ直接用于模式选择,残差码率;然后根据预测残差SSE及量化参数,对这些数据进行分类统计,计算其平均值;然后针对不同的预测残差SSE,利用线性回归技术计算X2;最后,建立X2与预测残差SSE之间的函数关系.按照上述步骤,进行了大规模的编码实验和数据分析.最终得到X2与预测残差SSE之间的函数关系,如图3所示.采用分段拟合函数,得到X2与预测残余方差的数学表达式:根据以上理论及实验分析,可以获得预测编码控制代价函数乘子的一个新计算公式,如下所示:)-0.00313×SSE对于运动补偿,采用槡λ.在优化计算时,需要记录每次编码处理的失真、预测残余码率和SSE,并把相关均值保存在缓冲区中.7实验与结果分析在H.264/AVC参考软件JM10.0[12]的基础上,按照编码预测控制优化新算法的要求,改写了部分程序.在算法的具体实现中,宏块搜索半径Radius_Threshold设为2;在每个图像帧编码结束时,更新历史平均值λframeaverage;在计算宏块λ时,按照如下策略对其进行修正:Page7if(λ>λframeaverage×1.25),λ=λframeaverage×1.25elseif(λ<λframeaverage×0.75),λ=λframeaverage×0.75为了客观而全面地评价新优化方法的编码性能,本文对Adapt-L方法和QP-L方法进行了大量的对比编码实验,涵盖了常见的QCIF及CIF格式的视频测试序列.限于文章篇幅,本文只列出部分测试序列的实验结果.QCIF格式的视频序列包括Coastguard、Foreman、Grandma、HallObjects、News和Salesman,其中Coastguard帧率为30帧/s,Fore-man和Salesman帧率为10帧/s,Grandma和HallObject帧率为15帧/s,News帧率为3.33帧/s.CIF格式的视频序列包括Kettle、Mother、Paris、News图4QP-L和Adapt-L编码效率比较和Silent,其中除Paris帧率为7.5帧/s,其它均为30帧/s.测试序列GOP结构均按照IPPP方式组织,编码总帧数为50.视频编码实验采用固定的量化参数进行,量化参数分别设置为28,32,36和40.其它的编码参数设置情况为:运动估计为1/4像素精度,参考帧数为5,Hadamard变换开关打开,熵编码模式设为CABAC,运动估计搜索范围设为±32,IntraPeriod为0,RestrictSearchRange为2.图4对Adapt-L方法和QP-L方法的编码效率进行了比较(相关实验数据列于表1~2中).可见,Adapt-L方法的编码效率优于QP-L方法,为了客观地评价改善程度,进一步采用AVSNR[13]软件计算Page8编码效率增益.对于QCIF格式的视频序列,据计算,Coastguard平均增加0.030dB,Foreman平均增加0.006dB,Grandma平均增加0.218dB,HallOb-jects平均增加0.214dB,News平均增加0.084dB,Salesman平均增加0.208dB;对于CIF格式的视频序列,据计算,Kettle平均增加0.118dB,Mother平均增加0.201dB,Paris平均增加0.053dB,News平均增加0.116dB,Silent平均增加0.157dB.测试序列优化方法CoastguardForemanGrandmaHall_ObjectNewsSalesman测试序列优化方法KettleMotherParisNewsSilent8结束语本文另辟蹊径,利用率失真理论建立λ关于视频信号的率失真统计特征的函数关系,提出了一种新颖的预测编码控制优化方法,能够根据视频信号的率失真统计特征,自适应地调整模型参数.经过大量的实验证明,Adapt-L方法的编码效率优于QP-L方法.虽然Adapt-L方法的计算相对复杂,由于它不需要引入量化参数,反而为实现高效的、精确的码率控制创造了可能性.
