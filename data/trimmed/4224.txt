Page1色调保持的自适应图像视频细节增强算法凌云1)严彩萍2)刘春晓1)李红2)王勋1)1)(浙江工商大学计算机与信息工程学院杭州310018)2)(澳门大学科技学院澳门)摘要针对已有方法难以保持输入图像的色调分布且过于经验化的问题,文中提出了一种色调保持的自适应图像与视频细节增强方法.首先,采用保持边缘的多尺度图像分解算法,快速地将输入帧分解成含有大尺度边缘信息的基图像和含有小尺度细节信息的细节层.然后,在细节增强与合成过程中,根据边缘梯度响应构造一个自适应的细节增强函数,减少对强边缘的放大倍数,提升对小细节的增强幅度.最后,在保持输入帧的颜色值和增强图像的梯度值的期望下,基于能量优化的色调校正算法避免细节增强图像与输入帧之间的显著色调差异.实验结果表明:对任意的输入图像和视频,通过统一的参数设置,均可获得色调保持的良好细节增强效果.关键词细节增强;多尺度分解;自适应策略;色调校正1引言在图像与视频的获取过程中,由于照明强度、采集设备、噪声干扰等因素的影响,导致图像与视频视觉效果的下降.为了突出图像与视频中的细节信息以便于用户分辨和后续处理,需要采用图像细节增强算法,它是图像增强领域的重要研究内容之一.图像细节增强算法的一般处理过程是首先将图像分解成一个反映低频信息的基图像和一个或多个反映多尺度高频信息的细节层,然后对每个细节层进行放大操作获得增强的细节层,最后将基图像和增强的细节层合成起来,即最后的图像细节增强结果.近年来,为数不多的人提出了一些关于细节增强方面的算法.对于多幅不同光照条件下的输入图像,Fattal等人[1]采用快速双边滤波进行多尺度分解,并且采用多尺度重组细节构造增强图像.但是,双边滤波本质上是在它的保留边缘程度和平滑程度上做一个权衡.如果增强提取细节的程度,也就意味着平滑图像中更多的边缘被滤掉.那么在细节增强过程中,残留在细节层中的大尺度边缘将会导致过于增强,并最终引起梯度逆转现象和光环现象.Zheng等人[2]则通过求解一个梯度域最优化问题来得到一张细节辅助图,并最终通过二次滤波得到细节层和基础层.但是,他们的方法都是基于多幅输入图像,无疑限制了这些方法的使用.对于单幅输入图像,Farbman等人[3]展示了基于加权最小二乘,即非线性泊松方程进行图像细节增强的效果,但是该方法需要求解一个大型稀疏线性系统,因此削弱了它的使用价值.Fattal[4]提出了基于避免边缘的提升小波分解进行图像细节增强的方法.这种多尺度分解方法虽然速度比较快,但是它的模糊核大小只能取2的指数级,从而限制了滤波尺度的选取.Subr等人[5]提出了新的细节定义,认为图像的细节是局部极小值与局部极大值之间的震动,并且基于这种新的定义方式,提出了新的图像分解技术.Xu等人[6]提出了一种基于L0梯度最小化的最优化框架,来控制全局非零梯度的数量,从而达到平滑图像的目的.Paris等人[7]则提出了利用拉普拉斯金字塔进行图像的多尺度分解.而Gastal等人[8]提出了一种基于域变换的彩色图像细节增强方法,期望达到快速多尺度分解的目的.但是,总的来说,这些方法对于细节增强都无法做到自适应.即对于不同的输入图像,需要设置不同的参数达到好的细节增强的效果,有的甚至需要采取不同的细节增强方法.而对于这些参数的设置或者细节层的增强方法都没有提出依据,只能采取测试的方式期望达到好的效果.所以,这些算法都过于经验化,对于大部分的普通人群都不适用.而且,目前还没有人提出任何适用于视频的细节增强算法.对比这些技术,本文同样采用保留边缘的滤波方法进行图像与视频帧的多尺度分解,但是本文提出了色调保持的、自适应的图像与视频细节增强方法.本文根据边缘梯度响应构造了一个自适应的细节增强函数,该函数在增强细节的同时,抑制细节层中残留的大尺度边缘.同时,本文提出了一个基于能量优化的色调校正算法,从而保证我们的细节增强结果既能保持输入帧的颜色分布,又能保持细节增强的效果.本文的主要贡献有如下几点:(1)本文对于采用哪种多尺度分解技术没有严格的要求,即任意一种保留边缘的多尺度分解技术都可以得到好的细节增强效果;(2)我们提出了一个统一的细节增强函数,该函数对所有图像与视频都可以达到一个很好的放大细节的效果,同时还有效的抑制了大尺度边缘的增强;(3)通过最小化能量函数的求解,使我们的最终结果既保持了输入帧的色调分布,又拥有了很好的细节增强效果;(4)我们的细节增强系统可统一处理所有的图像和视频,无需针对每一幅图像进行单独的参数调整,统一的参数就可以得到很好的细节增强效果.2色调保持的自适应细节增强算法彩色图像由RGB三基色组成,这3种基色存在很大的相关性,单独对其进行滤波操作一般都会影响彩色图像的色彩相关性,所导致的直接后果就是出现色彩失真,图像的视觉效果极不自然.因此,一种有效的彩色图像细节增强算法除了增强图像细节之外还必须使得处理后的图像更加生动,色彩鲜艳且不会带来失真.所以处理彩色图像必须选择合适的颜色空间,以及谨慎处理颜色分量之间的关系,在此基础之上,再考虑细节增强的特定要求.因此,本文所有的操作都选择在Lab空间的亮度通道上进行.对于任意的输入图像与视频,本文的细节增强算法主要包括以下步骤:首先,采用基于双边滤波的多尺度分解方法将图像分解成含有大尺度边缘信息的基图像和多幅含有小尺度细节信息的细节层.然后,根据我们构造的自适应细节增强函数来得到细节增强后的图像.最后,在保持输入图像的颜色值和Page3增强图像的梯度值的期望下,我们采用基于能量优化的色调校正算法得到色调保持的细节增强结果.图1算法流程图2.1基于双边滤波的多尺度图像分解所谓多尺度分解就是将图像分解成一个基础层和一个或多个细节层,其中基础层的计算就是一个图像渐进平滑的过程.而在这个渐进平滑的过程中,必须小心操作基础层与细节层的分解,以免造成图像失真.如文献[9-10]指出,当图像被分解成基础层和细节层时容易引起失真现象.因为在图像平滑过程中,无论是模糊还是锐化边缘都会在细节层中产生震荡,而这种震荡将是导致图像重组后产生光环现象和梯度逆转现象的原因.在过去的几十年里,多种保留边缘的多尺度图像分解技术在细节增强算法中得到应用.基于双边滤波[11-12]和小波分解[4,13-14]的多尺度分解技术是被频繁使用的图像分解方法.最近,基于加权最小二乘法(WLS)[3]、L0梯度平滑[6]和域变换[8]的图像平滑方法也纷纷被提出.然而在我们的算法中,无论采用哪种多尺度分解方法都没有明显的区别.即我们的算法对于任一种保留边缘的多尺度分解方法都适用.如图2所示,他们的结果都无法保持原图像的色调分布,而同样采用这些方法中所用到的多尺度分解方法,我们的算法明显抑制了这一缺点.换句话说,应用任一种图像多尺度分解方法都不会影响我们的最终结果,唯一的区别就是它们细节增强的尺度不同.为了证明本文所提出算法的适用性,在后续实验中我们采用基于双边滤波的图像平滑技术来提取细节.下面简要叙述基于双边滤波的多尺度图像分解方法.双边滤波是在高斯滤波的基础上提出的,其主本文算法的具体实现流程于图1显示.下面的章节将具体介绍每个步骤的实现.要思想是将滤波权系数优化成高斯函数和图像亮度信息的乘积,之后将权系数再与图像信息作卷积运算,目的是在滤波的同时考虑到图像的边缘信息,使图像在正常高斯滤波后很模糊的边缘信息可以保持清晰.其定义如下:BF(I)p=1其中的Ip,Iq分别表示图像I中像素点p和q处的颜色值;Wp=∑q∈S器归一化系数;Gσr,Gσd分别是图像I的颜色值域R和空域值S上以σr,σd为参数的高斯核;·代表绝对值,·代表两像素点之间的欧式距离.σd的大小决定窗口的大小,σd变大时,由于像素点变多,使得图像越来越模糊;而σr可以对σd的变化做出一定的补偿,例如,当σd变大时,考虑进来的像素变多,图像本应变模糊,但是由于σr的限制,那些亮度差值大于σr的像素间将不进行结合运算,所以极大程度上保证了图像中处于高频边缘处的亮度信息得以保留,而且不会和其相邻的非边缘亮度信息作运算.可见双边滤波在处理相邻像素值的灰度时,不仅考虑到了空间的邻近关系,同时也考虑到了灰度的相似关系,可在平滑图像的同时较好地保持图像边缘.为了得到渐进平滑的图像和多尺度细节层,需要对图像进行迭代滤波.假设想要得到N幅渐进平滑的图像,则需要迭代滤波N次,从而得到一个保Page4留边缘的多尺度分解.该分解由一幅粗糙的、分段光滑的图像,和一系列捕捉细节的差图像组成.更具体地说,假如要构造一个k+1级的多尺度分解.我们用I代表输入图像,则可以通过迭代滤波得到一系列原图像I的渐进平滑的版本J1,…,Jk(k1),其中,最平滑的版本Jk叫做基图像.同时可以得到一图2对比基于不同多尺度分解方法的结果(其中,图(b)~(e)为已有细节增强方法所得结果;图(f)~(i)为本文基于不同多尺度分解方法所得细节增强结果)2.2自适应的细节增强与合成策略通过比较以往的细节增强算法,可以发现他们的细节增强函数都无法做到自适应.也就是说对于不同的输入图像,需要设置不同的参数值,有的甚至需要选取不同的细节增强函数来放大细节.并且对于参数的设置和细节增强函数的选取都没有给出具体的依据,只能通过测试图片的方式期望达到好的细节增强效果.所以,为了能够使图像的细节增强达到自适应,本文设计了一个新的多尺度细节重组函数,如下所示:Iresult=α·Jk+∑k其中,Iresult为细节重组后的结果,S(Di)为细节增强函数,对每一个细节层进行最大尺度的细节放大.参数α用来权衡基图像与细节层的权重,参数βi用来权衡各个细节层的权重,并且满足∑k的后续实验中,统一选取α=0.8,β1=0.5,β2=0.3,β3=0.2.当然,通过设置不同的参数值可以得到不同的细节增强效果.接下来我们详细阐述细节增强函数S(Di)的构造.我们构造S(Di)函数的目的是为了在细节增强系列渐进粗糙的细节层:当然,原图像I可以很容易地被重构出来,只需要简单地将基图像与细节层相加,即过程中最大化原图像的小尺度细节,同时使强边缘的变化达到最小.虽然我们采用保留边缘滤波算法,但是细节层中仍然会残留很多强边缘的变化以及由强边缘引起的震荡现象.如果在细节增强过程中,这些强边缘也被放大相同的尺度,那么在细节重组后,整个亮度通道将会发生大幅度的越界.如果采取截断的措施,那么在细节重组以后,图像中将会存在大量的黑洞与亮点;如果采取归一化,则整个图像的亮度分布将会发生偏移.所以,无论采取哪种措施,都会改变整个图像的亮度分布,甚至引起光环现象和梯度逆转现象(如图3左).因此,在细节增强的同时,必须考虑抑制大尺度边缘的放大.本文构造了如下细节增强函数:总的来说,该函数的作用是对细节层中的小尺度细节应用S函数做了一个拉伸,其中ratio是一个常量.但是,为了有效地抑制大尺度边缘的放大,我们在S函数中加了一项惩罚项,即使用指数C来惩罚拥有大尺度边缘的像素,如下所示:Page5其中,IP代表输入图像在像素点p的梯度值,q代表以p为中心的3×3邻域,ε是一个极小值,用来保证分母不为零.可以看出,分子中的梯度项用来寻找强边缘,梯度越大Cp越大,且Cp∈(0,+).即使在图像较黑的地方也可以通过分母放大指数C.如图3所示,对比Gastal与我们的结果.Gastal只图3对比不同细节增强函数的结果(左图为Gastal的结果[8],右图为本文的结果)为了进一步放大细节层,我们可以对式(5)中的D做如下替换:其中,λ越小,细节增强的幅度越高.在具体的实现中,我们将细节层分为3个尺度,即k=3(式(2)).对不同尺度的细节层可以设置不同的λ,从而得到不同尺度的细节放大效果.如图4所示,细节层D1图4不同尺度λi下的细节放大效果2.3基于能量优化的色调校正算法一种有效的彩色图像细节增强算法除了放大图像细节之外还必须使得处理后的图像色调分布不会带来失真,因此,在增强细节的同时,必须寻找一种有效的方法来保持图像的色调分布.细节重组过程中,即使采用本文构造的抑制大尺度边缘的细节增强函数,整个图像的亮度通道取值仍然会发生剧烈是简单的用S函数放大细节,导致结果图像中存在大量的光环现象.而我们对S函数做了进一步的改进来抑制细节层中大尺度边缘的增强,对比图中细节,可以看出我们的细节增强函数明显抑制了结果图像中光环现象的产生.中的细节最丰富,当λ1取0.7时,图像(b)的细节增强程度明显高于图像(c)和图像(d).可以看出,我们的基于梯度响应的细节增强函数可以自适应地得到细节层中每一个像素点的增强幅度.即一旦参数(如α,β,λ)的值被设定,对于任意输入图像,都可以根据每一幅图像的局部信息自适应地计算出它们的增强幅度.的变化,使得细节重组后的结果图像色调分布大幅度偏离原图像.如图5(b)为本文细节增强后的结果图像,图像的亮度分布还是发生了明显的偏离,有的地方呈现过暗的效果.即使采用对比度拉伸或直方图匹配等方法,也无法有效地纠正细节增强图像的颜色分布.因此,基于马尔可夫随机场理论,本文提出了一种可以有效校正图像色调分布的能量优化算法.Page6图5细节增强图像的色调校正(其中,未经色调校正的细节增强图像(b)和Gastal的结果(d)都明显偏暗)对于输入图像d和经过上述细节增强后的图像u,我们通过能量优化的方法寻找一张新的图像f,使得该图像f一方面拥有输入图像d的色调分布,另一方面尽量逼近细节增强图像u的梯度分布(如图5(c)).形式上,该能量优化算法可以表示为如下形式:即求解该能量函数的最小化.其中,能量项Et代表输出图像f与输入图像d的色调差异,形式如下所示:其中,p,q表示一个像素的空间坐标,N(p)表示像素p的邻域.而式(8)中的能量项Eg是为了最小化输出图像f与细节增强图像u的梯度差异,即Eg(p)=∑q∈N(p)其中,fx和fy分别代表输出图像f的x方向和y方向梯度,ux和uy分别代表细节增强图像u的x方向和y方向梯度.最后,参数γ负责权衡这两个能量项,γ越大,所得结果图像的梯度分布越接近细节增强图像u的梯度分布.当γ增大到一定程度时,输出图像f将保持不变,即能量函数达到最优化状态.如图6所示,Page7如果对细节增强图像不采用我们的优化方案,所得细节增强图像(图6(b))的颜色分布明显偏离了原图像的.而经过色调优化的结果图像(图6(c)、(d)),颜色分布都得到了明显的改善.当取γ=1时,所得结果图像的颜色分布最接近原图像,而细节较图6(b)明显减弱,随着γ的增大,细节越来越接近图6(b).当γ增大到15时,我们的肉眼已无法辨别细节的变化,因此,本文后续实验都取γ=15.3实验结果与讨论对于任意的输入图像和视频,通过本文的自适应细节增强函数和基于能量优化的色调校正算法处理后,所得的结果图像与视频都达到了很好的细节增强效果.为了显示本文算法的自适应,本文所显示的所有结果都采用了统一的参数设置.对于每一幅输入图像或视频,通过本文提出的统一细节增强函数都可以得到一个细节增强的效果;并且无论发生多大的色调偏移,都可以通过本文的能量优化算法图7对比Gastal与本文的结果(其中,左边为输入图像,中间为Gastal的结果[8],右边为本文的结果)得到很好的校正.当然,可以根据个人的视觉感官调整参数α,β,λ的值,从而得到不同的细节增强效果.对比Fattal、Farbman、Xu和Gastal等人的结果(见图2),可以清楚地看到我们的色调优化算法明显校正了细节增强图像的色调分布,使所得结果图像既保持了原图像的颜色分布,又保持了细节增强图像的梯度分布.图7、图8展示了更多由本文算法得到的图像细节增强结果.在图7,我们对比了Gastal与本文的结果.可以清楚地看到,我们的方法对于颜色偏亮的图像仍然可以得到色调保持的细节增强结果.换句话说,我们的方法很好的控制了图像的亮度分布,使图像的整体色调不发生偏移.采用统一参数设置的Gastal的结果不仅整体上偏亮,而且存在很多刺眼的亮点,而这些现象在我们的结果中完全不存在.所以,Gastal的算法完全无法做到自适应.由图8可以看出,对于任意的输入图像,我们的细节增强结果都明显抑制了光环现象的产生,保持了原图像的色调分布,保证了图像的真实感.Page8图8本文的细节增强结果(其中,左图为输入图像,右图为细节增强结果)在图9中,我们展示了3个由本文算法得到的细节增强视频序列.这些结果表明对于没有显著场景切换的任意视频,我们的算法都可以通过统一的参数设置来得到很好的连续的视频细节增强效果.因此,我们可以得出结论,我们的算法对图像和视频都适用.4结论本文提出了一种色调保持的自适应图像视频细节增强算法.对于任意的输入图像和视频,算法首先采用基于双边滤波的多尺度图像分解技术来快速获取基图像和多个细节层.然后,通过自适应的多尺度细节增强与合成,得到一幅细节增强后的图像.最后,通过能量函数的最小化来优化细节增强图像的色调分布,使结果图像既保持原图像的颜色分布又拥有细节增强图像的梯度分布.实验结果证明:我们的方法能够在统一的参数设定情况下,对任意的输入图像或视频均可取得色调保持的显著细节增强效果.但是,由于本文算法的色调校正过程需要求解大型稀疏线性系统,因此我们的算法实现目前还无法达到实时的处理性能.我们将借助通用图形处理器的通用计算能力来提升算法的执行效率.Page9图9视频细节增强结果(上行为输入视频帧,下行为对应的细节增强结果)
