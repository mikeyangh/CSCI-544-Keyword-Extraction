Page1基于实例数据分析的多精度网格布料动画毛天露2)1)(华北电力大学控制与计算机工程学院北京102206)2)(中国科学院计算技术研究所北京100190)摘要在布料动画领域,细节变形褶皱的快速逼真模拟是一个具有挑战性的问题.多精度网格布料动画技术,在不同变形区域采用不同密度的网格,由此保证布料运动的丰富细节和更高的动画合成效率.已有的研究工作,主要针对多精度网格布料动画的可计算问题,即在动画过程中动态获取顶点或面片曲率,依据手工设定的阈值进行动态迭代精化,而对于有效性问题,即如何预测布料运动趋势并据此合理修改网格精度,未深入研究.针对该问题,在对布料运动过程中弯曲变形特征进行分析的基础上,提出一种基于实例数据分析的多精度网格布料动画方法.首先,选取一段持续的高精度布料动画作为实例数据,分析并提取弯曲变形模式;其次,以弯曲变形模式作为启发信息,结合有效的精化策略以及精化原则,对相应低精度布料模型进行逐层精化,从而构建多精度网格布料几何模型;最后,建立多精度网格各层质点的受力关系,并通过增加边界约束和质量约束,构建可适用于多精度网格的布料动画模型.实验结果显示,文中预构建的多精度网格模型可用于同类相似运动驱动下的布料动画计算,能够在保持较多细节变形的前提下,有效提高计算效率.关键词布料;布料动画;多精度网格;动力学;实例数据1引言布料是一种可变形柔性材质,极易发生弯曲继而生成丰富多样的褶皱,这些褶皱是其运动过程中最为明显的动态变形特征.真实地模拟这些褶皱的出现、变化与消失,是影响布料动画视觉效果的关键因素.为了获得细腻、富有动感的布料动画效果,通常需要对布料进行高精度建模,但高精度布料模型通常包含近万个图元,相应地,在动画计算过程中需要进行大量的碰撞检测,并求解大规模动力学方程组,如此高昂的计算代价限制了高精度模型的广泛应用.多精度布料模型[1-3],在变形比较平滑的区域采用低密度网格,保证动画的计算效率;在变形程度比较大、褶皱丰富的区域采用高密度网格,以模拟变形的细节信息,从而保证快速逼真地生成动画.构建多精度布料模型,需要估算布料或服装上可能出现的高变形区域,并对该区域网格进行精化,即解决多精度网格布料模型的自适应问题,以实现计算资源的合理有效利用.已有的研究工作[1-2],主要针对多精度网格布料动画的可计算问题,即在动画过程中动态获取顶点或面片曲率,依据手工设定的阈值进行动态迭代精化.其不足之处在于网格的精化程度主要取决于当前时刻的布料变形状态,较少考虑布料的变形趋势以及变形的连续性;此外,动画过程中不仅需要动态更新网格的拓扑结构,同时还需要动态修改质点之间的受力关系,操作复杂且容易增加计算开销.本文的想法是在对一段高精度布料运动进行分析的基础上,从中提取弯曲变形特征以及变形模式,进而预测布料运动趋势.据此,对相应低精度模型的高变形区域进行网格精化,并构建多精度网格受力模型,以实现多精度网格布料动画模拟.2相关工作基于物理方法的布料动画技术,是展现布料真实运动行为的最为有效的手段.已有大量经典文献对此进行了研究[4-6].这些方法大部分采用均匀网格模型,为了模拟布料细节褶皱,则需要构建高精度模型,而高精度模型所包含的大量图元将会导致求解规模增大,动画计算效率降低.为此,一些研究工作[7-8]将并行计算技术引入高精度布料动画系统,以提高计算效率.将多精度网格技术引入布料动画,可以获取动画效果和动画效率的折中.为了保证多精度网格模型的自适应性,通常采用的方法是动态计算顶点或面片的曲率,依据手工设定的阈值,调节不同区域网格当前所需的精化程度,并进行迭代精化.Hutchinson等人[1]首次提出了一种基于矩形网格的分层精化模型,即当相邻弹簧的弯曲角度超过指定阈值时进行精化,并通过增加约束保证精化过程中布料属性的稳定.Villard等人[2]提出一种基于四边形网格的精化模型.该方法通过计算局部布料面与其切平面之间的偏差估计布料面变形曲率,当曲率超过阈值时,进行连续的三步精化.在物理受力方面,采用Provot模型计算质点结构力和剪切力,基于梁的变形理论计算质点的弯曲力,并根据精化层次修正拉伸和剪切刚度系数.Volkov等人[9]采用槡3方法对三角形网格进行精化,并基于Baraff模型模拟了服装动画效果.刘宁[10]采用类似的方法,通过动态自适应细分网格模拟了柔性织物的动画效果.一种比较新颖的方法是基于逆向简化思想构建多精度网格模型[3],首先对降维的布料系统进行求解,再通过线性插值重构系统原始解.该方法用于LOOP曲面细分构造的初始高精度模型,能够较准确地保持动画过程中的细节信息,当选用边分解精化策略构造初始模型时,产生的低频误差不易消除.3本文算法思想现实中的布料弯曲变形具有如下特性:一方面,布料弯曲变形的分布、变形的趋势很大程度上取决于运动模式,同一种运动下的布料变形分布具有一致性.比如,人体在转动上半身时,后背到腰部的服装变形程度明显高于服装其他区域的变形.另一方面,布料在稳定外力的作用下(即没有瞬时大外力),其弯曲变形的产生及变化都相对稳定.比如,人体转动上身时,后背到腰部的变形会逐渐产生,持续一段时间后,再慢慢消失;而肘关节运动时,其周围区域的弯曲变形程度也将会逐渐变化.基于此分析,本文通过对一小段持续稳定的高精度布料动画数据进行分析,提取运动中弯曲变形特征并分析其变形模式,以此变形模式作为启发信息,对相应低精度布料的各区域作网格精化,构建可适应于相似运动的多精度网格几何模型,并进一步构建多精度网格布料动画系统.基于实例数据的多精度网格布料动画方法的总体框架如图1所示.Page3图1算法总体框架4弯曲变形模式提取4.1动画实例数据获取布料运动中产生的细节褶皱虽然持续变化且丰富多样,但同类运动驱动下,其变形趋势及变形分布具有很大程度的相似性.基于这一事实,首先计算一小段特定运动下的布料变形,以此变形数据作为实例进行分析,从中提取弯曲变形特征并进行分类,从而获取变形模式.在此基础上,预测布料各区域的变形程度.考虑到实例数据典型性等相关因素,本文选取一小段时间内一个标准身高女模行走生成的裤装与裙装动画作为实例数据.其中,动画计算时,采用基于四边形网格的动力学系统[11],而计算过程中所需的高精度模型,则通过初始粗网格模型的多次连续加精获得(如本文5.1节所述).4.2弯曲变形特征分析布料运动中,最典型的特征是弯曲褶皱,弯曲形变越明显,曲率值越大.本文基于四边形网格构建布料模型,其弯曲结构如图2所示.设顶点Pj是顶点Pi的一个交错邻接顶点,Pi到Pj的弯曲形变可近似为一段圆弧.假定两点之间的弧长与其初始直线距离近似相等,则可据此求出圆弧的曲率.设Pi与Pj的初始直线距离为2L,弯曲后的圆弧中心角为2θ,圆弧半径为ρ,Pi的曲率为K.由于弯曲后的弧长近似为2L,则可得又根据ρ=即可进一步得到曲率上述曲率值K表示顶点Pi在犘i犘j方向上的弯曲程度.在四边形结构中,顶点Pi通常具有8个交错相邻顶点[9],将与之相邻的8段圆弧的曲率平均值近似为顶点的曲率值,它决定布料在顶点Pi的弯曲程度.4.3数据片段分割与聚类由前述分析可知,一段稳定运动驱动下的布料动画,各区域内的曲率变化特征具有相似性,而且变形的产生或消失是较为稳定的.据此,本文将连续的动画数据流进行逐帧分割,形成帧序列;然后求各顶点在时间轴上的曲率均值及均方差.设布料模型上第i个顶点在ti时刻的曲率表示为kit()j,则该顶点在时间轴上的曲率均值为ki=Page4Nkit()j∑j=0N表示动画序列的帧数.那么,顶点i的特征即可表示为Xi=ki,d()i,所有顶点特征构成的集合表示为X=k1,d(布料包含的顶点数.{将上述得到的数据集X进行聚类,即可以获取该运动下的布料弯曲变形模式.本文选择经典的k-均值算法进行聚类[12].基本思想是首先从包含M个样本数据的数据集中选择若干个值作为初始聚类中心,然后以距离作为相似性评价指标,计算数据集中其他数据Xi与聚类中心的距离,并将其分配到最相似的类中,重复这一过程直到距离测度函数收敛为止.虽然布料运动中的弯曲变形模式在细节上可能会受到多种因素的影响(比如材质),但变形的分布与变化趋势主要受到运动模式的影响.为了获取泛化的变形特征,可以首先将变形特征数据进行归一化处理,然后再进行聚类,提取变形模式.4.4各区域顶点的变形模式基于4.3节的算法进行聚类,可以得到高精度网格模型各区域顶点的变形模式.假设聚类得到的弯曲变形模式有h类,表示为集合D={j|j=1,2,…,h}.其中j值越大,表示变形程度越高.变形程度越高的区域,其网格密度也应设置越高.根据本文算法,下一步将以该变形模式作为启发信息,对相应低精度网格模型的各区域进行不同的加精操作,构建多精度网格模型.为此,需要寻找高精度模型与对应低精度模型的顶点对应关系,然后将获取的变形模式映射到低精度模型上.设初始低精度模型的顶点集合VL={pL1,…,N-1},高精度模型的顶点集合VH={pH0,1,…,N-1,N,N+1,…,M-1},其中,N是初始低精度模型包含的顶点数,M是高精度模型的顶点数.由于高精度网格模型是基于低精度网格模型进行连续加精生成,因此,低精度模型上的顶点pL(i=0,1,…,N-1)直接对应于高精度模型上的顶i(i=0,1,…,N-1),而高精度模型顶点子集点pHVCH={pH映射到低精度模型的对应顶点上.图3给出了全部网格加精2次的情形.在通过映射获取了低精度模型各顶点的变形模式之后,即可以估计低精度模型各区域网格需要的精度级别,从而进行相应的加精操作(5.2节将对此进行详述).5多精度网格模型构建5.1网格精化策略对于四边形网格布料模型,经典“边分裂”操作可以快速地将网格从第Li层精度细化为第Li+1层精度,如图4所示.一次精化操作增加了5个新结点与4个新的活动子网格,原网格被重置为非活动网格.设四边形网格Q的4个顶点为pi(i=0,1,2,3),网格对应的精度层为L1,则精化四边形网格的具体算法如下.算法1.四边形网格精化算法.1.输入四边形网格Q以及其对应的精度层L1;2.如果Q为非活动网格,则转步7;否则转步3;3.求网格的中心点vc以及每条边的中点vk(k=0,1,2,3);4.用5个新增结点将网格分割为4个均匀的子网格SQi(i=0,1,2,3),原网格记为父网格;5.将4个子网格的精度层设为L2,L2=L1+1;6.将新增的4个子网格SQi置为“活动网格”,父网格Q置为“非活动网格”;7.结束.5.2布料模型的精化本文第4节获取了低精度模型顶点所属的变形模式,而5.1节中精化操作的基本单位是四边形网格,因此需要根据顶点的变形模式确定该顶点周围区域是否需要加精.设四边形网格Q的4个顶点为pi(i=0,1,2,3),对应的变形模式为jpi对应区域的最终精度级由构成网格的4个顶点的变形模式jpi曲变形程度较低,网格只需保持较低的初始精度;否Page5则,如果∑高,需要对网格进行一次或多次精化,使之具有较高的精度.本文将基于上述精化原则,进行逐层连续精化.设布料模型表示为MC=(V,F,Nv,Nf),其中,V是顶点集,F是网格集,Nv是顶点数,Nf是网格数;初始低精度模型各顶点变形模式构成的集合表示为LD={jpi|i=0,1,2,…,N-1},LDD,其中,N为布料顶点个数.此外,设一个辅助集合R={rpi|i=0,1,2,…,Nv},其初值与LD相同.对布料模型进行一遍精化操作之后,集合R也需进行相应的修正,以确定是否还需继续下一遍精化.算法2.布料模型精化算法.1.输入初始低精度布料模型MC,各顶点变形模式构成的集合LD;2.初始化设置R=LD;3.置refineFlag为False;4.设k=0;5.获取四边形网格fk的4个顶点pi(i=0,1,2,3)及其对应rpi6.求∑7.如果∑图5层次存储结构6多精度动力学系统构建6.1受力关系分析本文采用文献[11]的受力模型,即质点之间具有3种受力关系:直接相邻质点之间构成结构受力或剪切受力;间接相邻质点之间构成弯曲受力.refineFlag=True;8.k=k+1;9.如果k<Nf,转步5;否则,转步10;10.修正集合R;11.如果refineFlag=True,则转步3;否则,转步12;12.精化完成,输出多精度网格模型.算法3.集合R修正算法.FOR(精化前的顶点i)ENDFORFOR(精化增加的新顶点i)IF(i是中心点)ELSEENDFOR5.3层次数据结构本文选用经典四叉树结构存储面的信息,每个网格面需要记录的信息包括:面索引、精化层级、是否活动面标识、父面指针及4个孩子面指针.图5给出了3次精化产生的模型以及对应层次存储结构.其中,初始网格A0的精度层为1,每进行一次精化,网格的精度增加1.最后一层精化产生的网格为活动网格,其他网格都被置为非活动网格.在均匀网格模型中,质点分布基本均匀,因此刚度系数对于各质点受力可以近似为相同.执行一次精化操作之后,新增了一组顶点,同时也新增了一组精度更高的网格.新增顶点和网格改变了原有模型的拓扑结构,并将其划分为3类区域,如图6所示.通过分析不同区域质点之间的相邻关系,即可重构多精度网格的力学模型.Page6图6多层网格的受力关系变化(1)精化区域.以初始网格模型中的顶点p1的邻接关系为例进行说明:原来与p1直接相邻的内层质点pi(i=2,…,9)都转变为外层相邻质点,相应的结构受力转变为弯曲受力;增加了新的内层邻接质点vi(i=1,…,8).此外,由于新网格边长减小,密度增大,为了保证布料机械系统的连贯性和一致性,本文将受力模型中拉伸和剪切刚度系数进行如下调节:其中,α是可控参数,i是对应的精化层.当α取上界时,刚度系数将随着网格加精而快速增大.也可通过参数α的调节适度调整布料的刚度.(2)非精化区域.其网格结构与初始模型保持一致,没有新网格增加,质点邻接关系保持不变,因此,相应的受力关系以及模型参数保持初始状态.(3)边界区域.以p6的邻接关系为例进行分析:p6增加了3个直接相邻内层质点v5、v8与v9,原来的3个直接相邻关系变为外层相邻关系,其他邻接关系保持不变.设一次精化后的布料模型为MC=(V,F,Nv,Nf),其中V=V1∪V2,V1是精化前布料顶点集,V2是精化后新增加顶点构成的集合,F是布料网格集.则根据上述受力关系变化分析,给出重构力学系统的算法.算法4.多精度布料力学系统重构.输入布料网格模型MC;FOR(V1中的顶点)将该顶点的所有非活动邻接网格替换为活动邻接网格;修正其相应的内外层邻接关系;重构其受力模型;ENDFORFOR(V2中的顶点)将该顶点的所有非活动邻接网格替换为活动邻接网格;增加其内外层邻接关系;构建对应的受力模型;ENDFORFOR(V中的顶点)按照精化后的受力模型,计算系统受力;ENDFOR6.2约束分析在多精度布料模型中,由于各区域对应的网格精度不同,将会导致相邻区域的边界产生一些T-结点,如图7所示.为了避免“T-结点”在服装动画过程中“裂开”,本文对T结点施加约束.此外,精化操作后,不同区域的质点分布并不均匀,为了保证系统质量恒定,本文对新增质点的质量进行相应约束.(1)T-结点约束如图7所示,P为精化过程中产生的“T-结点”,F1和F2为其父结点.在动画计算中,P点的运动状态并不是通过动力学计算求得,而是通过其父结点位置的线性插值来确定,以保持P点落在F1和F2确定的线段上,避免布料的分裂现象.(2)质量约束布料一旦确定,其质量应该是恒定的.多精度布料模型的质点分布不均匀,如果每一质点赋予相同的质量,将会破坏质量守恒和动量守恒原则,进一步导致布料动画过程中变形失真.Page7本文给出一种非等质的质点质量计算方法.将布料网格面看作连续面片离散化的结果,网格面质量密度分布均匀,质心在面的中心,每一网格面对该面上每个顶点的质量贡献为1图8所示.如果布料网格划分均匀,且每一网格面质量为m,对于只有1个邻接面的质点,该质点质量为m.对于具有n个邻接面的质点,所有邻接网格面14的质量贡献和1出,该方法确定的边界点质量小于中心点质量,这非常符合实际布料动画中边界更容易发生形变的现象.对于非均匀的多层精化模型,精化网格面质量为上一层网格面质量的1为m,那么第k次精化之后的网格面质量为m前述质点质量的计算方法,对于具有n个邻接面的质图9特征数据分布及变形模式提取点,布料面上每个质点的质量为Mi=∑level(j)表示第j个邻接网格面的精度层.7实验结果与分析本文采用一个标准身高女模穿着裤装与裙装进行动画实验.首先选取一段行走运动,计算其驱动产生的高精度服装动画作为实例数据,从中提取弯曲变形模式,并构建多精度网格几何模型;其次,计算一段相似的新运动驱动下的服装变形,通过对照不同精度网格模型的动画效果及效率,对方法的性能进行定性及量化分析.其中,动画模拟中的数值计算以及碰撞检测分别采用文献[13]和文献[14]提出的方法.所有实验环境均为IntelCore2DuoE8400,3GHzCPU,4GB内存,NVIDIAGeForce9800GTSGPU.7.1基于变形模式生成多精度网格模型实验中使用裙子以及长裤两种模型,首先在3DMAX中构建低精度网格模型,然后基于本文加精算法对模型包含的全部网格进行两次加精,生成各自对应的高精度网格模型.获取高精度模型动画实例数据,提取特征并进行聚类,得到3类变形模式.表1给出了各实例动画包含的帧数以及计算时间,相应的图示效果如图9所示.其中,图9(a)表示Page8服装模型裙子长裤实例动画效果,图9(b)表示对应的特征数据分布图,图10两种顶点数不同的多精度网格裙装模型图11两种顶点数不同的多精度网格裤装模型由上可知,本文方法能够提取动画过程中的高变形区域,在结合变形模式与各区域细节变形程度的综合需求前提下,可以预构建规模不同的多精度网格模型;网格的分布与所获取的变形模式具有一致性.7.2算法分析首先,为了得到更多的变形细节信息,需要基于高精度服装模型进行动画实例数据获取,这是本方法主要的时间耗费.其次,对布料模型进行加精时,需要执行多次循环遍历操作,精化的次数越多,时间消耗越多.表2给出了本文方法与动态精化方法的精化时间对照.表中数据显示,本文方法在获取动画实例数据阶段会耗费较长的时间.但由于该计算以及精化操作都只需要在预处理时进行一次,因此对多精度动画系统的整体性能影响较小.与之相比,动态迭代精化算法需要根据每帧的变形程度进行相应的遍历精化操作,增加了每帧动画时间开销.当运动不同颜色表示变形程度不同.将数据相近的聚在同一类中,得到对应的变形模式,并进而将模型划分为多个区域.以获取的变形模式作为启发信息,并结合对各区域变形细节程度的不同需求,本文分别构建了多精度网格裙装模型与裤装模型,如图10和图11所示.持续时间很长时,本文方法的计算效率将优于动态迭代精化方法.表2本文方法与动态精化方法的精化时间对照服装模型精化方法裙装裤装7.3动画效果及效率对照(1)动画效果对照首先,本文选用一段新的行走运动进行服装动画计算.对新运动驱动下的低精度均匀网格模型、高精度均匀网格模型以及多精度网格模型的动画效果进行分析.由动画结果图12和图13可知,低精度动画丢失了大量细节信息,整个服装具有较少的褶皱,视觉上表现出很强的刚性;裙装多精度网格模型的Page9顶点数比高精度均匀网格模型减少约2/3,但两者整体动画效果比较接近;裤装动画中的高变形区域主要分布在后膝部区域,相应的该区域的网格密度也设置更高,因此可以表现出与高精度模型基本接图12不同精度的裙装动画对照图13不同精度的裤装动画对照图14近似规模的均匀网格与多精度网格动画对照近的动画效果.其次,在新运动驱动下,将顶点数接近的均匀网格模型与多精度网格模型进行动画效果对照,实验结果如图14所示.对照动画效果可以看出,多精度网格Page10动画中,服装的下摆区域呈现出相对更明显的弯曲形变,而裤装在裤脚部位的细节变形更为明显一些.由此可知,在占用大致相同计算资源的前提下,本文的多精度网格动画可以表现出更多的局部细节变形.由此可知,基于实例数据预构建的多精度网格模型用于同类相似运动驱动下的布料动画计算,能够较好地保持高变形区域的细节褶皱.(2)计算效率分析分别将高精度均匀网格模型、多精度网格模型、低精度均匀网格模型进行动画模拟,对动力学计算时间、碰撞检测时间等关键效率指标进行量化对比分析,实验结果如表3所示.服装模型裙装裤装多精度非均匀多精度非均匀从表3可知,低精度均匀网格裙装动画中,每帧计算量小,仅需187ms,效率很高,但结合图12(a)可知,低精度网格动画难以表现服装的细节变形.高精度网格裙装模型包含上万个顶点,碰撞检测非常耗时,约需要2984ms,每帧总的动画时间约需要3031ms,效率很低.与之相比,多精度网格裙装模型的顶点数量降低约2/3,每帧动画效率提高近70%.另外一组数据是裤装动画计算效率对照.高精度均匀网格裤装模型包含9355个顶点,每帧动画约为2331ms.与之相比,包含2228个顶点的多精度裤装动画效率提高非常明显,超过70%.由此可以看出,本文构建的多精度网格动画系统,能够获取模拟效率与效果的折中,在保持动画逼真性的同时,提高了计算效率.8小结本文提出一种基于实例数据的多精度网格布料动画方法.通过对一个小时间段布料动画的弯曲变形特征进行分析,提取变形模式并估算不同区域的变形程度,进而对各区域做相适应层级的网格精化,构建可适应于相似运动的多精度网格布料模型,并结合边界约束和质量约束,构建可适用于多精度网格的动画系统.其优点在于:(1)在初始化阶段构建多精度布料几何模型及动力学系统,整个动画过程中无需进行网格结构以及受力系统的更新,操作方便,效率高;(2)基于实例数据提取弯曲变形模式,隐含了布料弯曲变形程度与运动方式之间的关系,能够保证预构建的多精度网格模型的适用性;(3)结合弯曲变形模式与细节变形程度的需求,可以灵活控制不同区域的网格精度,支持实现各局部区域细节程度不同的动画模拟.本文方法在以下方面具有局限性:(1)需要一定的预处理时间以获取实例数据,当服装网格密度非常大时,预处理时间将会增大;(2)不支持动态网格简化,整个运动过程中都需要保持预构建生成的多精度网格模型的存储区;(3)目标人体动画的动作与学习用的人体动作存在较大差异时,该方法不再有效(比如基于行走运动构建的多精度网格裙装模型并不适合于下蹲运动驱动产生的服装动画计算).下一步工作将从服装弯曲变形与人体运动的相关性入手进行分析.由于现实生活中的服装褶皱主要由肢体运动所驱动,服装变形的分布和变形的趋势与人体运动之间存在较强的相关性,不同关节的运动只对其周围区域的服装变形产生较大的影响.为此,在预计算阶段,通过多样化的人体模型和人体运动样本数据,生成服装动画实例数据,从中学习服装弯曲变形与人体运动之间的泛化关系;而在服装动画计算阶段,对新输入的人体运动进行分析,以此为启发准确预测可能产生弯曲变形的服装区域,对该区域网格进行精化,模拟服装运动过程中丰富的褶皱细节.
