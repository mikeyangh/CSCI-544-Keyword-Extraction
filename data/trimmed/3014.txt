Page1高性能虚拟网络VegaNet陈文龙1),2)徐明伟2)杨扬1)李琦2)马东超3)1)(北京科技大学信息工程学院北京100083)2)(清华大学计算机科学与技术系北京100084)3)(北京邮电大学光通信与光电子学研究院北京100876)摘要现有网络研究的实验一般在模拟工具或原型系统上完成.然而,这些实验环境与真实网络环境总有较大的差别,主要包括没有真实用户流量、缺乏真实网络中的丰富网络事件、没有运行真正的协议栈软硬件平台等.另一方面,对于运营网络的研究,研究者经常希望分析网络事件发生前后的网络状况,例如更改拓扑或配置,注入网络故障等,显然这些措施难以在真实运营网络中实施.针对上述问题设计了一种为网络研究提供真实实验环境以及对核心网络进行模拟分析的高性能虚拟网络VegaNet(VirtualGigabitNetwork).文中详细介绍了VegaNet结构模型及设计实现.目前,已完成VegaNet在CERNET2清华校园网的初步部署.实验表明,VegaNet能提供一个接近于真实网络状况的网络实验环境,并能灵活支持对核心网络的模拟分析.关键词VegaNet;虚拟路由器;网络实验;虚拟链路状态协议1引言互联网高速发展,关于网络体系结构、路由协议及网络服务的新型研究层出不穷.对于研究成果的分析评价,主要通过两种方式完成:(1)在模拟工具中实现研究模型并人为设计网络拓扑进行实验;(2)在实验室中完成原型系统并搭建简单环境完成实验.然而,实验环境与现实状况有着较大的差距,主要包括没有真实用户流量,缺乏真实网络中的丰富网络事件,没有运行真正的协议栈软硬件平台等.另一方面,对于运营网络的研究,面对24h不间断的长期稳定的网络服务,无法随意地更改网络拓扑或配置,更不能人为构造网络故障,使得大量优化方案无法验证其效能.总之,网络研究者的新思想或新模型难有理想的实验环境,也难以获取有价值的评价依据.研究者希望有一种虚拟网络架构,它既能提供几尽真实的网络环境又不影响任何实际网络正常运营,继而还能透明地对运营网络进行模拟分析.Overlay虚拟网络架构是一个极佳的选择.Overlay网络是一种部署于现存网络上独立的虚拟网络,就像在原有网络上叠加了一层新的网络.典型的Overlay网络包括进行快速路由检测和恢复的RON[1]、在现有Internet上提供端到端服务质量保证的SON[2]以及在SON基础上为了要减少性能限制提出的SOI架构[3].继而,VINI(AVirtualNetworkInfrastruc-ture)[4]被提出,它为网络研究者提供了一个可控的、能够面对真实环境的底层网络架构.VINI允许研究者将新型思想在具有真实路由软件、真实流量负载及真实网络事件的环境下进行实施,并得以评估.VINI提供的网络实验支撑架构的主要目标包括运行真实路由软件,面对真实网络环境,网络事件可控,实验网络承载真实用户流量.VINI在Planet-Lab[5-6]节点上构造基本原型系统.原型系统利用XORP(eXtensibleOpenRouterPlatform)开源路由协议软件[7]实现虚拟系统路由控制层面的处理,利用CLICK[8]软件完成虚拟数据层面的报文处理.节点间的虚拟链路通道是通过UDPSOCKET通信完成的.VINI在PlanetLab测试平台上搭建完成了一个实例:PL-VINI,基于它的一系列实验证明了PL-VINI的正确性、有效性、可用性,并且能做到对真实网络状况真实反映.然而,VINI不是基于商业路由软硬件平台,没有实现虚拟网络到真实网络的拓扑映射以及链路故障的状态同步,也未实现虚拟网络与真实路由实体的信息交互.我们设计的VegaNet(VirtualGigabitNetwork)和VINI一样,也是一种Overlay结构的虚拟网络,它为网络研究提供真实实验环境.此外,它还能透明地对当前运营的核心网络进行模拟分析.VegaNet以实际运营的某个网络体系作为底层架构,在网络边缘接入若干虚拟路由器,虚拟路由器之间通过虚拟链路连接,构成一个虚拟网络平台.该虚拟网络平台既可提供网络实验环境,又可对底层核心网络进行模拟分析.VegaNet主要特性包括引入真实的用户流量,支持节点及链路故障的注入,同步底层网络故障,虚拟路由器基于真正的商业路由平台实现,支持高带宽的虚拟网络流量,虚拟网络协议族独立于底层网络,虚拟网络相对底层网络透明等.其中,在报文处理性能、虚拟网络与底层网络故障同步、虚拟链路状态管理等方面,相对VINI有了显著的提高.目前,VegaNet已完成初步实施及实验.实验结果表明,VegaNet能提供一个如同真实物理网络一样的网络实验环境,也能对底层网络实现模拟分析和性能评价.本文第2节给出了VegaNet的设计思想及结构模型;第3节给出了以CERNET2为底层支撑网络的VegaNet实例设计;第4节介绍了VegaNet核心设备虚拟路由器的软、硬件体系结构设计以及虚链路状态协议的设计;第5节描述了VegaNet在CERNET2清华校园网的初步部署情况以及基于它的实验及实验分析;第6节对全文进行了总结,并介绍了项目下一步的工作方向.2VegaNet模型VegaNet总体目标包括两个方面:(1)为新型网络协议或服务提供尽量真实的实验环境,保证实验能不断改进、反复进行;(2)通过VegaNet对特定网络体系进行模拟,反映实际网络运行状况,并对该网络体系结构进行分析.VegaNet模型设计有以下基本原则:(1)它总是基于某个底层网络进行构建,并且对底层网络透明,即底层网络不关心VegaNet上的网络行为;(2)能实现VegaNet中虚拟链路与其对应的真实物理链路的故障同步;(3)VegaNet有真实用户并可承载真实网络一样的网络行为;(4)VegaNet网络拓扑可重构并具有较高的可控Page3性,管理员根据实验需要只需简单配置便可改变虚拟网络拓扑,还可方便地获取VegaNet网络事件信息.本文关于VegaNet的描述有表1所述的符号定义,图1是VegaNet的网络体系结构模型.VegaNet是在SUN网络核心节点下面部署若干台虚拟路由器VR,VR像普通端系统一样接入SUN,VR之间通过虚链路Vlink连接.图1中VegaNet是所有VR的Full-mesh连接,实际部署时可根据不同需求构建不同拓扑.VegaNet就是由若干VR和Vlink构成的虚拟网络,每台VR通过DCI接口下连局域网.VegaNet对于底层网络来说是透明运行的,并且VegaNet的网络协议族与SUN网络的协议族是相互独立的.假设SUN网络协议族为FS,报文头格式为Header(FS);VegaNet网络协议族为FV,报文头格式为Header(FV),那么,VegaNet的网络报文在SUN网络传输时采取如图2所示直接封装的格式.VegaNet中无论数据转发报文或是协议控制报文,只要通过VR中虚链路收发就采用图2的报文封装符号SUNSubstrateNetwork,VegaNet的底层支撑网络VRVirtualRouter,虚拟路由器,作为端系统接入SUN网UCIUp-ConnectingInterface,VR上连SUN网络的接口,DCIDown-ConnectingInterface,VR下连VegaNet局域VlinkVirtualLink,虚链路,利用封装解封装技术、穿越SUNVIVirtualInterface,VR上收发封装报文的虚拟接口,总图3VR报文处理模型VegaNet的一个重要目标是对SUN核心网络进行模拟,通过VegaNet运行情况反映SUN网络的实际运行状况,并对VegaNet网络结构及网络协议进行改进实验,给SUN网络的发展提供建设性的建议.VegaNet部署时,SUN网络每台核心路由器下连一台VR,该VR用来模拟其上连的核心路由器.对照SUN网络真实链路,VegaNet配置相应格式.当然,对于边缘局域网内部的报文交互,仍然采用VegaNet协议族原始报文格式.对于VegaNet中穿越SUN网络的一次端到端通信,包含3种VR角色:源端系统所属的虚拟路由器称为VRsend,它从DCI接收协议族FV报文进行封装,并按照协议族FS的寻径方式从UCI发送报文.目的端系统所属的虚拟路由器称为VRrcv,它从UCI接收到达本地的协议族FS报文进行解封装,并按照协议族FV的寻径方式从DCI发送报文.从VRsend到VRrcv可能经过的若干个转发点称为VRfwd,它对协议族FS的封装报文进行重新封装并向VRrcv方向发送.图3是VR的报文处理模型,它集成了上述3种VR角色的报文处理功能.的虚链路,一条Vlink对应SUN核心网中的一条真实链路.我们希望VegaNet能做到虚拟网络与底层网络的链路故障同步,而其实施的关键是如何分析底层网络真实链路是否发生故障.因为对于一条虚链路两端的VR,SUN网络中可能有多条可达路径,而实验者只希望虚链路与其模拟的那条真实链路保Page4持状态一致.令集合S(R,L)表示SUN网络核心设备连接拓扑,其中,R={r1,r2,r3,…,rn}是路由器集合,L={lij|ri∈R,rj∈R,i≠j,0<i,jn}是物理链路集合,且对于R中任意两个不同的节点最多只有一条物理链路.VegaNet网络对SUN进行模拟时,SUN核心网中每一台路由器和每一条物理链路都在VegaNet中有一台VR和一条Vlink与之对应.集合V(R,L)表示VegaNet连接拓扑,它是集合S的等价类,其中R={r1,r2,r3,…,rn}是VR集合,L={lij|ri∈R,rj∈R,i≠j,0<i,jn}是Vlink集合,同样对于R中任两个不同的虚节点最多有一条虚拟链路.另外,VegaNet部署于SUN网络时,每台VR通过一条物理链路连接其对应的核心路由器,称其为VR接入链路,该类链路的数量与VR数量相等.我们将VR接入链路集合定义为K={ki|0<in},链路ki的两个端节点为ri和ri,它们分别来自集合R和R.在VR接入链路集合K无故障且SUN网络路由总是优先选择最短路径的情况下,有定理1.本文不考虑链路权值等评价参数,跳数最少即为最短路径.定理1.物理lij链路正常当且仅当虚拟路径Path(lij)的跳数为3.证明.VegaNet模拟环境中,虚链路总是针对某条真实物理链路而建立的.所以在lij链路正常时,其对应的虚链路lij(即虚拟路由器ri和rj之间的虚链路)所对应的最短实际路径为Path(lij)={ki,lij,kj},路径跳数为3,其经过的节点序列为{ri,ri,rj,rj}.当lij链路发生故障时,假设虚链路lij仍然可达,则说明核心路由器ri和rj间存在通信路径.由于ri和rj间只有一条直连链路lij且已发生故障,所以Path(lij)的路径跳数必定大于等于2;加上链路ki和kj,Path(lij)的路径跳数必定大于等于4.定理1成立.基于定理1,在VegaNet对特定SUN网络进行模拟时,只要SUN网络采取最短路径路由算法,我们可以通过分析虚链路的两端通信的实际转发跳数是否为3来判断其模拟的真实物理链路是否正常,从而决定虚链路的状态,最终实现Vlink与其模拟的真实链路的状态一致性.3VegaNet设计VegaNet设计的主要思想就是部署若干VR通过SUN网络核心节点接入,VR之间通过虚链路Vlink进行连接.VegaNet数据通过虚链路传输时,需要用SUN网络协议族的IP头部进行封装发送.本文实现了一个VegaNet实例设计,实例中Vega-Net运行IPv4协议族,CERNET2为其SUN网络.VegaNet虚链路的IPv4数据传输通过IPv6封装技术实现,该传输对CERNET2网络完全透明.Vega-Net中地址及路由配置细节如下:(1)IPv6Address.VR如同普通终端有且只有一个全局IPv6地址,配置在UCI上;(2)IPv4Address.VR除了UCI以外的其它接口都可配置VegaNet中唯一的IPv4地址;(3)Vlink.两个VR之间要建立一条虚链路时,需要双方配置Vlink;Vlink配置主要就是指定对端VR的IPv6全局地址;(4)IPv4Routing.VR通过DCI把所属的IPv4网络连入VegaNet,VR可在DCI连接的真实链路及Vlink上运行IPv4路由协议,实现整个VegaNet的路由信息交互;(5)IPv6Routing.由于VR单点接入CER-NET2,VR只需一条IPv6默认路由实现IPv6报文发送.另外,VegaNet支持人为对其网络节点及链路注入故障及故障恢复事件.在VR或Vlink运行正常的情况下,有时因为实验需要希望VR或Vlink发生故障.此时,管理员可以远程通过私有协议通告VR进行某种行为约束,达到网络故障发生的效果.当然,管理员还可通告取消人为故障使网络恢复正常.网络中各种故障都有其对应的表现形式,Vega-Net正是以此为据实现对网络故障的控制,包括以下处理:(1)VIDown.VI的接口状态为Down,其后续行为和真实接口Down所导致的行为一样,不再发送或接收任何报文;(2)VRDown.VR上所有虚接口状态都为(3)VlinkDown.虚链路两端对应VI的接口状相对于其它虚拟网络模型,本文的VegaNet设(1)实现了真实网络故障在虚拟网络中的实时体现.VegaNet希望网络研究及实验基于尽量真实的网络环境完成,真实环境的考验是对网络协议及网络体系结构各方面特性评估最有力的论据.Veg-aNet通过VLSP协议,分析虚链路跳数或传输路径,实现了虚拟网络与所模拟的真实网络的链路故障同步.Down,都不进行报文收发;态都为Down;计主要有以下特点:Page5(2)监控体系可以实现深度分析并注入故障.除了让虚拟网络同步真实网络的链路故障及恢复,VegaNet还支持人为控制虚拟网络中的故障产生和故障取消事件.监控平台通过私有协议(一种基于IPv6TCP的私有协议,本文不做详细描述)对虚拟路由器发送控制消息,从而操作故障状态.另外,监控平台还利用私有协议从虚拟路由器中采集各种网络事件,并在后台研究分析.(3)VR直接基于商业路由系统平台进行开发.VegaNet中的虚拟路由器是一台真正的路由设备,它基于清华大学自行研制的BWOS路由平台改进而成(详见本文“虚拟路由器设计”部分).该架构中,虚拟路由器可以面对和真实路由器一样的系统平台问题,如高负载任务对处理器的长期占用、路由设备中数据消息与控制消息的冲突、分布式体系结构中消息同步等问题.所以,基于VegaNet的网络实验及研究与实际状况更贴近.(4)支持Gibit用户流量.网络实验中,是否有真实的高带宽用户流量是非常关键的影响因素.商业路由设备中,报文处理主要包括高速数据转发和协议报文收发,这两者共享外部网络接口并产生竞争关系.所以,支持高速用户转发流量将使网络协议实验分析更具参考价值.(5)虚链路状态协议(VLSP)为模拟真实网络及链路控制提供灵活支持.VegaNet中,虚拟链路像物理链路一样具有一些链路属性参数,如MTU,我们希望虚链路两端链路参数协商一致.另外,虚链路通常跨越多跳物理链路,它的可达性难以检测.VLSP协议就是为解决上述问题而设计的,它是虚拟网络平台中重要的设计之一.VLSP的功能包括维护虚拟邻居状态、实现虚拟链路两端的参数协商、虚拟链路双向可达性检测、虚拟链路所用真实路径监控等.图4是VegaNet对CERNET2①的模拟的拓扑子图,我们假设所有VR接入链路总是正常,因为任一接入链路发生故障,整个网络模拟就无效.对于虚拟路由器JN到HF的虚链路Vlink(JN,HF),有两条可达路径:Path1经过节点序列{JN,JN,HF,HF},Path2经过节点序列{JN,JN,TJ,BJ,WH,NJ,HF,HF}.CERNET2核心网为一个自治域,域内运行OSPF协议选择最短路径.基于定理1,若Vlink(JN,HF)的物理跳数为3表明JN到HF的物理链路正常,否则发生链路故障.VegaNet中由VLSP协议通过监测Vlink的实际物理跳数是否为3,来判断其模拟的物理链路是否发生故障,从而决定Vlink的链路状态.3.1虚拟网络数据转发图5是由5台VR通过虚链路组成的一个虚拟网络,我们以此拓扑详细描述VegaNet中路由学习及数据转发细节.图5中每台VR有两个邻居,VR之间的Vlink全部运行OSPFv2协议,各虚链路权值全设置为1,VR将所属的IPv4局域网路由引入OSPF.这样,VegaNet只是通过常规的路由配置,就实现了虚拟网全网路由的学习.下面以主机A与主机C通信为例来分析VR下连端系统通过虚拟网络的通信过程.主机A到主机C必经VR1、VR3,而VR1到VR3有两条可达路径VR1—VR2—VR3以及VR1—VR5—VR4—VR3,VR1进行SPF计算得出路径开销分别为2和3,将选取第1条路作为去往VR3的转发路径.同样,VR3也会选取该路径的反向路径作为去往VR1的数据转发路径.从主机A通过虚拟网络发送IPv4报文给主机C,共有如表2所列步骤.上述报文变换过程如图6所示,需要重点说明的是VR2接收和转发的IPv6封装报文是更换了封装头部的,也就是说VR2进行了重新封装.由主机C发往A的转发过程与上述步骤类似.整个转发过程中的关键点是VR对报文的封装及解封装.报文从源IPv4网络进入IPv6网络时,由源端所在VR进行IPv6封装;报文离开IPv6网络进入目的IPv4①http://www.cernet2.edu.cn/,http://nms-v6.cernet2.Page6网络时,由目的端所在VR进行解封装;而中间经过的VR要对封装报文进行解封装后重新封装发往另表2图5环境下主机A发送IPv4报文至主机C所经步骤步骤角色1主机A发出原始IPv4报文Dst(30.0.0.2)、Src(10.0.0.2)、Nexthop(10.0.0.1)2VR1接收并转发IPv4报文查找IPv4转发表,出接口为连接VR2的虚接口3VR1VI发送IPv4报文IPv6封装后发出,封装头中Dst(2000∷1)、Src(1000∷1)4VR2VI接收封装报文接收封装报文进行解封装操作,得到原始IPv4报文5VR2VI发送IPv4报文查IPv4转发表出接口为VI,IPv6封装后发出,封装头中Dst(3000∷1)、Src(2000∷1)6VR3VI接收封装报文接收封装报文进行解封装操作,得到原始IPv4报文7VR3DIC发送IPv4报文查IPv4转发表出接口为DIC,发送原始IPv4报文8主机C接收原始IPv4报文接收到主机A发出的原始IPv4报文图6VegaNet报文变化过程4虚拟路由器设计4.1虚拟路由器体系结构虚拟路由器系统基于BWOS平台[9]改造完成.可扩展路由器操作系统BWOS支持IPv6和IPv4双协议栈,实现了多种网络接口下的高速分组转发功能,并通过硬件冗余和软件状态备份技术实现了路由器系统的高可用性.虚拟路由器系统相对BWOS平台,主要是在控制层面增加了虚接口管理,并屏蔽虚接口对其它模块的影响.用户配置虚接口后,系统在接口管理模块增加虚接口处理.接口管理向其它协议模块通告接口状态信息时与其它物理接口完全一致,协议模块不关心虚接口报文收发具体细节.数据层面,虚拟路由器将常规报文转发与封装/解封装结合起来,保证VegaNet报文的快速处理.虚拟路由器主要功能模块结构如图7所示.各模块描述如下:(1)网络接口控制(NICTL).网络接口管理模一个VR.虚拟网络中的IPv4通信对于承载它的IPv6网络来说是完全透明的.块中增加虚接口管理.虚接口和其它物理接口一样具有各种接口状态信息:管理状态、链路协议状态、MTU等等,NICTL模块会将虚接口状态信息通告系统中关心接口状态的模块.另外,该模块还与数据层面有消息交互,主要是将虚接口的对端IPv6地址信息下发给数据层的SRAM模块,用作封装头中的目的地址.(2)配置管理(CFM).用户通过命令行配置创建或取消虚接口,针对每个生成的虚接口用户还需配置虚链路对端的IPv6地址.由于VegaNet中VR只有一个连入CERNET2的IPv6接口:UCI,所以虚链路关心的对端地址就是UCI上的IPv6全局地址.(3)VLSP.在虚拟链路上收发VLSP协议报文,按4.2节所述实现虚接口的可达性检测、跳数测量、参数协商等功能.(4)路由协议模块(RoutingProtocol).路由协议模块不关心虚接口行为,按传统方式运行.各协议模块可以从虚接口收发报文,操作方式和物理接口完全一样.虚接口报文收发涉及的封装和解封装都由数据层完成,对上层模块是透明的.(5)路由管理(RoutingManage).路由协议可以通过虚接口收发协议报文,会生成以虚接口为出接口的路由项.路由管理模块将核心路由表项通告给数据层,前缀信息通知给TCAM模块,匹配处理信息通知给SRAM存储.(6)转发表存储及数据转发(FIB&PacketFor-warding).三元内容可寻址存储器(TCAM)是一种特定类型的完全相联存储器,允许完全并行的查找转发表或分类器数据库.静态随机存储器(SRAM)是一种广泛应用的高性能存储器,在路由器查找系Page7统中,可以配合TCAM用于存储匹配表项信息.简而言之,TCAM模块实现快速的路由前缀最长匹配,SRAM中存储了TCAM查询结果对应的处理信息.为了提高硬件处理速度,VR通过一次查表获取封装及转发相关所有信息.而且因为VR只通过UCI连入CERNET2,封装后的IPv6报文转发无需路由查询,固定IPv6下一跳发送.所以,数据层面只需要IPv4转发表.对于需要封装处理的报文,它所匹配的路由前缀在对应SRAM的存储中会增加用于封装的地址信息.概括起来,虚拟路由器中数据层面主要有3种报文处理行为:①接收IPv4报文,路由匹配结果是进行常规IPv4转发.②接收IPv4报文,路由匹配结果是IPv6封装发送,则从SRAM存储中获取封装地址,封装成IPv6报文后无需查表,固定下一跳发送.③接收IPv6封装报文,先解封装,然后进行IPv4转发处理.(7)封装/解封装(Encapsulation&Decapsula-tion).将IPv4报文加上IPv6头封装成IPv6报文,或者将IPv6封装报文解封装成IPv4报文.4.2虚链路管理基于VegaNet的网络实验可能需要获取与虚链路相关的数据,如虚链路两端往返时间等.另外,对于虚链路实际转发路径或转发跳数的测量有助于实现VegaNet与CERNET2的网络故障同步.VegaNet通过在VR上部署VLSP协议来实现以上目标,具体包括以下子功能:(1)双向通信可达性检测.对于虚链路,传统设图8VLSP协议报文格式5部署及实验虚拟路由器系统现已完成V1.0版本的研发.实现的功能包括虚接口的配置管理、VLSP协议、基于虚链路的OSPF协议及BGP协议、硬件实现VegaNet报文的快速转发、远程对VegaNet网络的故障注入及故障消除.而且,我们在CERNET2清计中通过路由可达性确定链路通信的有效性,而且多为单向检测.VegaNet中,VLSP协议通过发送请求报文并接收应答报文,达到双向通信可达性检测的目的.(2)往返时间测量.仍然利用VLSP协议的请求、响应报文完成,每一个响应报文总是和一个请求报文对应,它们的SeqNum相等.发送请求报文时VR记下发送时间,所以收到应答报文的一端通过计算请求报文发送时间与应答报文的到达时间的差值就能得到虚链路的往返时间.(3)虚链路实际转发跳数测量.强制VLSP协议请求报文的初始跳数总为一固定值(如64),虚链路两端可根据接收的协议请求报文的到达跳数,获得虚链路到达方向的实际转发跳数.(4)精确路径跟踪.在VLSP功能模块中集成IPv6Traceroute机制.(5)参数协商.同一条虚链路两端的虚接口可以协商接口MTU、Bandwidth以及进行地址冲突及同一网段的检测.另外,虚链路加密传输时还可协商密钥和加密算法.VLSP协议报文交互机制非常简单:VR定时向虚链路对端发送VLSP请求报文;若VR从某个虚接口收到VLSP请求报文,则按上述机制回送应答报文,每一个应答报文唯一对应一个请求报文.VLSP报文格式如图8所示.VLSP协议作为VegaNet中虚拟链路的链路层协议,服务的对象是Ipv4虚拟网络,但其协议数据直接紧跟Ipv6包头.VLSP协议现有设计已能完成上述前4项功能.当然,最后一项功能利用保留字段并对协议进行简单扩展后也能完成.华大学校园网部署了3台虚拟路由器进行实验.CERNET2是一个纯IPv6网络,2004年开通,现已在清华大学校园实现了全面覆盖,并且日常有大量实验或应用流量出入.图9左边部分是虚拟路由器部署的物理连接拓扑,VR1直连清华大学第2边界路由器,VR2通过3跳连接清华大学第1边界路由器,VR3通过3跳连接清华大学核心路由器,VR接入CERNET2全是通过100Mb/s以太网链路进行Page8IPv6连接.在每个VR下面通过100Mb/s以太网链路连接一台实验PC机,为IPv4连接.图9右边部分就是以左边网络连接为基础生成的虚拟网络拓扑,它是一个品字形的IPv4连接拓扑.可知,Vlink1、Vlink2和Vlink3分别对应着5跳、5跳、7跳物理链路.由于条件有限,初步实验中VR只能图9VegaNet清华校园网网络拓扑图10VegaNet实验室网络拓扑实验1.我们通过Iperf工具进行虚拟网络上的端系统之间的UDP带宽和Jitter值测试.PC1、PC2分别充当Iperf服务器端和Iperf客服端.首先,只在VR1与VR2之间运行OSPF协议,测量单跳虚链路通信相关数据,对应的Iperf实验路径为接着,只在VR1与VR3以及VR2与VR3之间运行OSPF协议,测量多跳虚链路通信的测量值,对应的Iperf实验路径为PC1<->VR1<->VR3<->VR2<->PC2.测试中Iperf配置带宽依次增加实验流量.图11是CERNET2环境下的测试结果.当流量配置超过90Mbps,发现iperf显示有效测试流量急剧下降.所以,90Mbps流量是实验中端系统所能发出的流量上限.而且,虚拟网络可以为百兆链路下连的端系统百兆接入CERNET2,3台PC的硬件配置均为Pentium1.5GHz处理器、512MB内存,安装WindowsXP系统.为了对照,我们在实验室也搭建了对应的简化VegaNet网络拓扑进行完全一样的实验,如图10所示.实验室网络环境中,PC机到虚拟路由器是百兆连接,其它都是千兆连接.提供线速UDP带宽,且无论单跳虚链路或多跳虚链路,UDP带宽测试结果基本一致.CERNET2环境下端到端UDP通信中平均Jitter值测量结果都在3.2ms以内变化.图12是实验室环境下的测试结果,UDP带宽测试结果与CERNET2环境类似,但Jitter值变化范围缩小在0~1.7ms,说明VegaNet实际网络部署时所面对的网络环境流量更为复杂.实验2.我们分析OSPF协议在虚拟网络上的运行状况以及运行状况变化对端到端流量的影响.首先,在各虚拟路由器的所有接口上都使能OS-PF协议,VR之间相互学习路由.实验中,利用iperf测试PC1到PC2之间的TCP吞吐量;同时,利用hrPING工具测试PC1到PC2的RTT值,hrPING是一个高精度的PING工具.OSPF稳定后开始测试数据,在第50s向虚拟网络注入Vlink1链路故障Page9事件,并在第100s注入Vlink1链路恢复正常事件,实验2总测试持续时间为200s.图13显示了实验结果,对于iperf端到端RTT值,可以看出前50多秒RTT都保持在0.7ms左右,Vlink1断连后RTT在1ms左右,当Vlink1恢复正常后RTT又回落到0.7ms.同样,TCP吞吐量刚开始能达到90Mbps,随着虚链路故障发生而略有降低,故障恢复正常后TCP吞吐量也回到90Mbps以上.初始情况中,OSPF协议为VR1与VR2选择的最短路径为1跳虚链路路径:Vlink1;当Vlink1故障发生,OSPF收敛后为VR1与VR2选择的最短路径为2跳虚链路图11基于CERNET2的VegaNet中带宽和Jitter值测量图12实验室环境中VegaNet带宽和Jitter值测量图13基于CERNET2的VegaNet中RTT和TCP带宽测量路径:Vlink2—Vlink3;当故障恢复正常,该通信又回到1跳虚链路路径.此过程中,虽然虚拟链路跳数只有增、减1跳的变化,但结合图9可知其对应的物理链路跳数变化为7跳.所以,无论是端到端RTT值,或是TCP吞吐量,都随着故障变化而有着较为明显的变化.另外,两个子实验数据都显示:当在50s时刻注入链路故障后,端到端通信在几秒之内就立刻受到影响,而在100s时刻恢复正常后,大约在几十秒后端到端通信才恢复到故障前的状态.这是因为,链路故障发生后OSPF可以立刻选择备用路径通知数据层面,而链路正常后OSPF要经过邻Page10图14实验室环境VegaNet中RTT和TCP带宽测量居建连并互发UPDATE报文才能学到新的路由,该过程耗时较长.这与真实网络中OSPF运行情况完全一致.同样的实验也在图10所示的实验室环境下完成,图14是测试结果,RTT测量结果明显低于CERNET2环境,而且RTT值和TCP带宽在OSPF链路故障收敛过程的变化不明显.另外,我们在图10环境中测试了虚拟路由器的极限转发能力.IXIA测试仪的两个千兆接口分别连接VR1和VR2的千兆接口,形成一个全千兆连接的测试环境.我们测试环境下VR1到VR2的IPv4数据转发能力.测试结果如表3所示,平均能达到近800Mbps的IPv4报文转发性能.由于VegaNet中报文转发过程,需要IPv6头部封装,不可避免会有相应带宽的损耗.所以,VegaNet基本达到线速转发能力.64~1478(随机)最后,我们还利用图9环境中的端系统,进行了视频播放、FTP等常规应用实验,都能正常完成.综合所有实验,我们可以得出以下结论:(1)VegaNet网络能够为用户提供真实、高速(2)VegaNet网络中路由协议运行情况及其对(3)部署于实际网络的VegaNet,能够让网络的端到端流量转发.转发流量的影响与实际网络基本相同.实验面对象实际网络一样的复杂环境.(4)VegaNet支持人为注入链路故障事件及故障恢复事件.6总结及下一步工作本文所提出VegaNet的设计目标是为新型网络协议实验提供一个架构平台以及对运营网络进行模拟仿真并展开网络性能研究和分析.本文首先提出了通用的VegaNet模型,并且分析了VageNet虚链路的属性.VageNet通过分析虚链路的实际转发跳数来决定的链路状态,VegaNet与CERNET2的故障同步就是以此为据设计的.此外,介绍了一种以CERNET2为底层物理网络的VegaNet设计实例及部署方案,包括具体的地址配置、路由交互、报文封装及数据转发过程.VegaNet的核心设备:虚拟路由器,是以BWOS平台为基础而开发的,本文给出了优化后的系统体系结构及重要模块的设计细节.本文还设计了VLSP协议,实现虚拟链路两端的参数协商、可达性检测、路径跟踪等功能.目前,虚拟路由器已完成V1.0版本的研发.实现功能包括虚接口的配置管理、VLSP协议、基于虚链路的OSPF协议及BGP协议、硬件实现VegaNet报文的快速转发、远程对VegaNet网络的故障注入及故障恢复.此外,我们已在CERNET2清华大学校园网内部部署了3台虚拟路由器进行实验.它运行在真正的商用路由平台上,承载着真实、高速的用户流量,面对着如真实网络一样的复杂情况;而且还支持人为向VegaNet注入链路故障事件及故障恢复事件.实验结果说明VegaNet网络可以为用户提供几尽真实的网络实验及模拟分析环境.VegaNet下一步工作将在以下几个方面进行:(1)大范围部署,设计激励机制引入更多真实流量;(2)新型路由协议的实施,课题组提出的自愈路由协议将以VegaNet为实验网络环境验证其改进特性;(3)对CERNET2进行深度监控及分析,设计实验方Page11案、收集实验数据,并对CERNET2网络体系结构、协议运行、运营流量进行研究分析,并提出改进建议;(4)改善虚拟网络及虚拟设备设计.改进虚拟路由器报文转发能力,从而提高整个虚拟网络的带宽;Vega-Net及VR将支持更丰富的管理员注入事件.致谢本论文工作在清华大学完成,感谢清华大学计算机网络研究所提供的研究项目支持!
