Page1基于特征点Rényi互信息的医学图像配准赵海峰陆明卜令斌孙登第罗斌(安徽大学计算机科学与技术学院计算智能与信号处理教育部重点实验室合肥230601)摘要针对医学图像配准有鲁棒性强、准确性高和速度快的要求,文中提出一种基于特征点Rényi互信息的医学图像配准算法.起初从模板图像与待配准图像中依次提取出多尺度特征点,其次使用其空间坐标计算特征点Rényi互信息目标函数,实现图像配准.该算法有效地避免了多模噪声图像间的灰度差异影响,减少了待处理的数据量,同时使用Rényi互信息来消除目标函数所受的局部极值的影响,进一步提高了配准精度.实验证明该算法适于单模和多模医学图像配准,速度较快、精度高、鲁棒性强,是一种有效的自动配准方法,并且具有较好的临床应用价值.关键词医学图像配准;尺度空间特征点;Rényi互信息1引言医学图像配准的主要任务是通过求解某种空间Page2配.因此在实际的临床应用中,图像配准具有十分重要的意义[1].当前,基于灰度的方法和基于特征的方法是医学图像配准的两类主要方法[2].基于灰度的配准方法从图像整体的像素灰度方面来考察,此类方法的原理是利用图像间像素灰度值的某种对应关系来实现配准的,一般只适用于单模图像配准;而基于图像特征的配准方法主要通过提取图像的角点、轮廓等图像的局部特征进行配准,这类方法计算速度快并可应用于多模图像配准中,因而成为当前医学图像配准的热点研究方法.在所有基于灰度的配准方法中,互信息测度配准算法在医学图像配准中得到的应用是最广泛的[3-6].当两幅图像为最佳配准时,两幅图像对应像素的灰度互信息应取得最大值.Shannon互信息一般被传统的互信息配准方法所采用,而通常含有复杂噪声的医学图像函数具有较多局部极值而难以达到最佳匹配.Rényi互信息是Shannon互信息的广义形式[7],在合适的参数水平下其函数比Shannon互信息平滑,局部极值少,更适合于图像配准寻优.在基于特征的方法中,提取图像特征点并进行医学图像配准的思路已经受到了越来越多的重视.目前,许多特征点提取方法已被提出,其中LaplacianofGaussian[8]与HarrisLaplacian[9]特征点提取算子具有良好的抗噪性和抗旋转性,可在多尺度空间下提取出稳定特征点,准确描述图像的内容信息,减少运算量,非常适合于医学图像配准.本文借鉴Shannon互信息的方法,结合图像特征点理论,提出了一种基于特征点Rényi互信息的多模态医学图像配准算法.新算法能够提取图像的多尺度稳定特征点集,并使用了可以消除局部极值的Rényi互信息,其配准精度高、速度快、鲁棒性强.尤其是在多模图像配准中,获得了最佳的配准效果.2医学图像多尺度特征点的提取在机器视觉中,稳定的特征点可以准确反映图像内容,降低真实图像中形变、噪声、位置差异等因素造成的影响,并且可以显著减少图像处理的数据量,因而已被大量应用于匹配算法中[10-12].2.1Harris算子Harris算子[13]是Harris等人在1988年提出的一种经典的特征点提取算子.计算图像中每个点在两个方向上的梯度Ix与Iy,生成自相关矩阵:局部自相关函数的一阶曲率为矩阵犕的两个特征值.当两个曲率值都很大时,窗口沿任意方向移动,都会使检测子E(Δx,Δy)≈[Δx,Δy]M[Δx,Δy]T很快增大,则该点就是我们所求的特征点.综上可得,在纹理信息丰富的区域,Harris算子可以提取出非常有用的特征点;寻求两个方向的曲率最大变化过程中,该算子的计算公式只使用到了一阶导数,因此该算子具有良好的抗噪性与抗旋转性.2.2LoG(LaplacianofGaussian)算子Harris算子对光照变化、旋转和噪声具有很强的鲁棒性,然而对图像间的尺度缩放却较为敏感.LindebergLoG(LaplacianofGaussian)算子来克服这个缺点.将图像与高斯核G(σ)卷积得到尺度函数L(x,σ)=G(σ)×I(x),通过求偏导Lx,Ly构造尺度参数σ的自相关矩阵,以获得Harris算子的尺度空间表示.在此基础上,Lindeberg提出了LoG算子:LoG(x,σn)=σ2待测特征点及其周围8个近邻的LoG值,若当前待测点为局部极小或极大值时,则这个点就是尺度空间中的一个LoG特征点.2.3HL(Harris-Laplacian)算子通过LoG算子取得的特征点,往往位于亮度只在一个方向变化的边缘上.为了解决该问题,Mikolajczyk[9]提出了HarrisLaplacian(HL)尺度不变特征检测算法.首先,此算法检测每一层尺度图像上的Harris特征点,其次用Laplace函数选择特征尺度,也就是说,如果Laplace函数值在尺度轴上与附近两个点相比较,达到极值并且大于给定阈值,就判断此点为稳定的特征点:LoG(x,σn)=σ2LoG(x,σn)>LoG(x,σp),p∈{n-1,n+1}.图1为BrainWeb中的一张模拟T1加权MR噪声图像,左图为提取的LoG特征点,右图为提取的HL特征点.明显可见LoG特征点较多,清晰完整地描述出了图像中的颅骨与颅骨内侧空隙以及脑室部分;HL特征点较少,出现于脑沟回的根部与脑室的角点处等.因此LoG适于描述图像突出的Blob特征,而HL更适合描述图像中的细致部位.结合这两种方法提取的特征点将准确反映图像的解剖结构与边缘轮廓信息,有助于后续配准处理.Page33配准目标函数3.1Rényi互信息概述互信息是信息论中的重要概念,它描述了变量间的统计相关性,常用的互信息有Shannon互信息与Rényi互信息两种.传统的医学图像配准将待配准的两幅图像看作是关于灰度的两个随机变量集A与B,a和b是两个随机变量集的取值,即像素灰度值.则A和B的Shannon互信息与Rényi互信息分别为H(A,B)=-∑a,bRα(A,B)=1/α-(其中,联合概率PAB(a,b)通过归一化的联合灰度直方图求得.对含有相同内容的两幅图像进行几何变换,当它们在空间对齐时,它们的互信息量最大.显然,这种方法忽略了像素的图像空间位置信息.且其时间复杂度为O(n2),n为像素的个数,因而配准速度非常慢.3.2特征点集的Rényi互信息本文在提取图像特征点的基础上,研究特征点集的Rényi互信息,并应用于图像配准中.假定从两幅图像中分别提取N1与N2个特征点构成集合X={Xi|i=1,2,…,N1}和Y={Yj,|j=1,2,…,N2},其中Xi与Yj表示两幅图像中特征点的二维坐标.对于点集X与Y,定义联合概率为Pij>0,即表示同时从X中选取Xi和从Y中选取Yj的概率.X与Y中单独抽样的概率为Pi=∑则点集X的Shannon熵与Rényi熵分别为H(X)=-∑显然,Rényi熵是Shannon熵的广义形式,当α→1时,Rα→H.因此Rényi熵具有更强的泛化能力.由互信息定义,点集X与Y的Shannon互信息为MI(X,Y)=∑而X与Y的Rényi互信息为MIα(X,Y)=为比较特征点集的Shannon互信息与Rényi互信息,我们取同一断层的MR图像和CT图像,将其中一幅作为浮动图像进行空间变换.对两幅图像提取特征点并用式(1)、(2)分别计算在不同变换下的点集互信息测度,结果如图1所示.在图2中我们比较了归一化的Shannon互信息和参数分别为0.5、0.9、1.1、2.1时的Rényi互信息.上下两图分别为平移(X轴方向)、旋转对互信息所产生的影响.由于实际图像含有较大噪声,且多模图像的特征点位置并不完全一致,所以用式(1)计算出的Shannon互信息函数曲线不光滑,有很多的局部极值.通过调整参数α,Renyi互信息函数线明显平滑,局部极值较少,抵消了特征点不准确的影响.当α=0.9和1.1时,Rényi互信息与Shannon互信息的形状很相似,这与理论分析一致,同时也表明Rényi互信息具有更强的泛化能力.图2不同参数归一化互信息对平移和旋转的变化曲线3.3联合概率的估计由式(2)可知,联合概率Pij对互信息的计算起Page4到至关重要的作用.在图像配准中,联合概率Pij表示A图中的特征点Xi与B图中的特征点Yj配准的概率.对浮动图像B作空间变换,当某个变换T使得两幅图像配准时,其对应联合概率Pij将使得变换后的坐标T(Y)与参考图像中的X的互信息MIα(X,T(Y))达到极值.显然,目标函数是关于变换T的函数,而估计特征点联合概率Pij则为优化目标函数的关键步骤.Pij与特征点空间分布位置具有密切联系.对特征点集X与T(Y),点集间任意两点的欧式距离为Dij(T),则两图特征点之间的期望距离为当两幅图配准时,匹配点坐标最近,E(T)最小,因此E(T)是关于变换T的一个常数.我们用E(T)作为计算联合概率Pij的似然条件,不妨设其为d.我们用最大熵方法,在期望距离最小化约束条件下,估计出符合最大可能随机性的概率Pij合概率Pij的最大Rényi熵估计为argminPij满足利用拉格朗日乘子法可以得到L=α-1∑μPij+λ∑其中η,μ与λ为拉格朗日乘子.该式对Pij求偏导(考虑约束条件显然当η>0时,0<α<1,当η<0时,α>1,这也与图2中α为0.9与1.1时的两个函数线形式一致.由于初始未配准时两幅图像变化差异明显,配准期望距离d比较大,这意味着α→1,此时Rα→H.因此为简化计算,我们采用特征点的Shannon互信息来估计Pij,其拉格朗日形式为N1L=∑i=1∑此处,logPij包含Pij>0的约束.对该式求偏导可得:这样就消除了未知常数d的影响.代入exp{-λ}得Pij=exp{-ηDij(T)}∑显然式(4)就是欧式距离高斯核的归一化形式,其中η为核参数.该式符合最优化理论中的KKT条件,算法收敛[14].因此可以通过式(3)、(4)分别计算出联合概率与相应的Rényi互信息目标函数.待配准的两幅图像基于共同的解剖信息,因此当两幅图像达到空间位置一致时,特征点最近得最多,互信息最大.如图3,上下两图分别为配准前后特征点的联合概率直方图,x,y轴为两图中的特征点编号(为方便显示,对特征点事先进行了排序).未配准之前直方图分布十分混乱,配准后对应特征点的欧式距离最小,Pij值最大,联合概率呈对角型分布.基于特征点Rényi互信息的图像配准可以通过参数调控收敛目标函数,并在求解过程中利用两种互信息间的关系实现对参数的合理控制;该方法采用多尺度算子提取抗噪、抗旋转的特征点,且不需考Page5虑特征点的排序和数目限制,只要空间位置整体相对应,其复杂度为O(N1N2)O(n2).4配准过程基于上述讨论,通过提取多尺度特征点作为图像内容描述,结合Rényi互信息作为相似性测度的标准,本文提出一种基于特征点Rényi互信息的医学图像配准方法.4.1空间变换与目标函数的建立临床应用中,图像中的解剖结构相对运动较小,可将图像内容的变化近似看作刚体变形或具有较小放缩比例的相似变换.首先取图像左下角为原点,将图像分别沿X轴和Y轴平移Δx与Δy到图像中心,再旋转Δθ角度,最后进行尺度因子s的放缩.对图像中任意点(x,y),其变换过后的对应点(x,y)为xy[]=s其中,(x0,y0)为图像的中心位置坐标.本文研究在不同的平移和旋转变量(Δx,Δy,Δθ)之下的特征点Rényi互信息值MIα,建立关于变换T(Δx,Δy,Δθ)中3个未知量的目标函数MIα(T).4.2优化策略在提取图像的特征点和确定目标函数后,下一步我们要做的就是对目标函数求极值,获取最优变换解.我们所求的问题是一个3维(Δx,Δy,Δθ)无约束最优化问题,但目标函数无法求导.Powell算法是一种直接寻查目标函数极小值的简便而又实用的算法,它是在迭代中逐次产生共轭方向组,而无需计算导数和梯度,很适用于本文配准方法的多维搜索,所以本文选取Powell算法作为优化算法.4.3优化初始值的选取在Powell算法中初值的选择很重要,如果初值选择不适当,会使求解过程陷入局部极值,影响配准的精度和时间.在本文中,我们采用主轴矩法对图像进行粗配准,然后用粗配准结果作为Powell算法的初始值,这样既缩小了优化方法的搜索范围,节省了时间,又避免了Powell算法陷入局部极值.4.4算法步骤基于以上所述,并结合图像配准的实际情况,本文提出的算法流程如图4所示.5实验对于本文提出的特征点集Rényi互信息配准算法,为了验证其有效性,我们对多幅颅脑图像进行配准实验,从特征点有效性、配准鲁棒性、准确性与配准时间等多项准则上给出相应的比较结果.5.1实验数据库本文将进行同模医学图像配准与多模医学图像配准的实验.其中,同模医学图像实验所用的数据来源于BrainWeb数据库①,BrainWeb数据库是一个仿真数据库,其特点是提供不同灰度一致性、不同模式和不同噪声比的人脑核磁共振图像,所以能够很好地对实验进行定量的分析,该数据库是业内公认的脑部图像仿真分析数据库.数据库图像示例如图5所示.图5灰度不一致为20%情况下的BrainWeb数据库图像示例多模图像配准的实验数据库来源于美国范德堡大学的回顾性配准评估项目(RetrospectiveImageRegistrationEvaluationProject)数据库②,该数据库中的PET、MR、CT等不同模式的图像都是真实病人的图像,在拍摄时对病人头部进行了外部标记,得到了称为“金标准”的配准参数,然后将外部标识去掉,提供给研究者实验使用.各种其他方法所获得的配准参数,与“金标准”进行比较,得出该方法①②Page6的评分和评价,图6给出了该数据库中一些病人的图像示例.图6范德堡大学的回顾性配准评估项目RREP5.2实验方法对于同模图像配准,我们取BrainWeb中一幅清晰的MR图像作为模板图像A,对施加了10%噪声后的A图像在[-20,20]像素、[-20,20]度范围内随机平移旋转得到浮动图像B.我们重复上述过程50次.经过这个过程,得到很多组配准图像A和B的配准变换参数(Δx,Δy,Δθ),分别测试得到的配准变换参数(Δx,Δy,Δθ).计算真实的人工变换参数(Δx,Δy,Δθ)与配准得到的变换参数之间误差的绝对值.当旋转误差小于1°,平移误差小于1个像素时,认为配准达到了亚像素级,配准成功.对于多模图像配准,我们在RREP数据库中先选用20组T1加权与T2加权MR图像,每组中的两幅图像均来自于同一病人且处于同一断层.对这20组MR图像进行配准并比较效果.进一步,我们选取20组来源不同的图像,每组中包含同一病人处于同一断层的一幅CT图像与一幅MR图像,并进行配准比较.5.3特征点有效性比较实验为了验证特征点的有效性,我们设计如下实验来比较不同特征点对本文算法的影响:我们分别使用Harris特征点、HL特征点、LoG特征点、HL和LoG互补特征点一共4种特征点集进行同模与多模图像特征点Rényi互信息配准(Harris-Rényi,HL-Rényi,LoG-Rényi,HL+LoG-Rényi),再比较配准成功率.如图7所示的实验结果,在相同情况下,对不同图像配准实验结果表明无尺度信息的Harris特征点配准效果最差,LoG特征点与单一HL特征点配准成功率差不多,但这两种单一的特征点配准效果都不如特征点组合HL+LoG,因此,本文采用的HL+LoG是一种有效稳定的特征点描述子.5.4图像配准比较实验为了验证本文配准算法的鲁棒性和准确性,我们比较了多种常用医学图像配准方法.5.4.1比较实验方法我们选取了3种常见的灰度互信息配准方法,2种特征点配准方法以及1种特征点与互信息结合的配准方法作为比较:灰度Rényi互信息方法(RényiMI)[4].该方法采用灰度Rényi互信息作为目标函数进行配准.归一化互信息方法(NMI)[15].该方法利用图像灰度的边际熵与联合熵比值构造互信息,考虑了图像重叠区域的影响.加权互信息方法(WMI)[16].该方法采用加权熵代替香农熵构造互信息,能够平滑互信息局部极值.特征点Ransac配准方法(SIFT+Ransac)[17].该方法先用SIFT算子提取尺度空间特征点,再用Ransac方法对特征点进行匹配,并计算出反向映射,得到变化参数.轮廓特征点配准方法(Contour)[18].该方法通过轮廓直线化提取轮廓特征点,并用轮廓之间的距离与特征点之间的距离的累加和作为目标函数实现配准.Rényi熵图配准方法(EntropicGraph)[19].该方法利用特征点集的最小生成树估计Rényi熵实现图像配准.5.4.2同模模拟图像配准比较实验我们用BrainWeb数据库中的模拟图像进行同模配准实验.实现方法如5.2节所述.配准的结果如表1所示,精度为50次实验平均值.对同模模拟图像配准,虽然其解剖组织结构相Page7同,但是噪声严重影响了灰度联合直方图的计算,使得基于灰度的互信息目标函数不准确.因此3种基表1同模模拟图像配准结果横轴平移配准误差Δx纵轴平移配准误差Δy旋转角度配准误差Δθ配准时间特征点Rényi互信息SIFT-RansacRényiEntropicGraphSIFT+Ransac配准方法使用的是提取出的SIFT特征点处梯度特征,噪声影响了特征点梯度的计算和主方向的选取,降低了该方法的配准精度.对于同模医学图像,其轮廓十分相似,因此轮廓特征点配准方法较好.而Rényi熵图配准方法由于最小生成树对熵估计的误差,使得其精度略低于轮廓特征点配准方法.本文提出的特征点Rényi互信息方法在提取特征点之后并不使用该点处的像素灰度或梯度信息,而是在配准过程中直接使用特征点的空间位置,避免了图像噪声带来的影响,因此具有较高的配准精度和成功率.通过实验结果可以明显看出,基于特征点的方法所用配准时间远远少于基于图像灰度的互信息方法所用配准时间.其中SIFT+Ransac方法不需要固定的目标函数形式,算法速度也比本文提出的方法更快一点.图8为一幅脑部MR图像(A)和经过变换后的噪声图像(B)及对两幅图像提取的特征点.C为本文方法配准后的融合结果,D为特征点集匹配情况.从图中结果可见本文采用的多尺度特征点具有良好的抗噪性,且在两幅图像配准的同时,对应的特征点也匹配得较为准确.于灰度特征直方图的互信息方法仅在图像变化不大时才能够达到一定精度,总体配准成功率明显偏低.5.4.3多模图像配准比较实验在实际临床应用和医学图像分析中,单一模态图像通常不能提供医生所需要的足够信息,往往需要将应用各种模式所得到的医学图像信息融合起来进行临床判断.为了检验特征点Rényi互信息在多模图像配准上的精度,我们采用美国范德堡大学的CT-MRI数据库中的数据来做测试.图9是T1MR图像与T2MR图像配准的例子,其中T2MR图像中边缘骨骼部分十分明显,在颅骨的内外侧都形成特征点(A),而T1MR图像只在颅骨内侧分布有较密集特征点(B).虽然特征点数目不同,但两图在颅骨内侧的特征点分布位置十分相近,因此在本方法最终的配准结果中(C,D),颅骨内侧的点匹配得很好,而外侧的点规则地分布在周围且不与内侧点发生误配,达到最佳的整体点集配准.图10是CT与MR图像配准的例子.对CT图像与MR图像,特征点提取的数目与位置都不同(图A,B),但颅骨部分的点分布都较完整.因此最终的匹配结果中颅骨轮廓得到了很好的配准,而两图在颅内的不同区域提取的特征点恰好错开分布,避免发生误配,整体配准最优(图C,D).Page8表2和表3分别给出了6种方法的配准实验结果.在多模图像配准中,图像成像方式不同,待配准图像内容并不一致,灰度信息差异大,呈明显的非线性关系[20]且含有大量噪声,使得基于图像灰度的两表2T1MR与T2MR图像配准结果横轴平移配准误差Δx纵轴平移配准误差Δy旋转角度配准误差Δθ配准时间特征点Rényi互信息SIFT-RansacRényiEntropicGraph特征点Rényi互信息SIFT-RansacRényiEntropicGraph表3CT与MR图像配准结果横轴平移配准误差Δx纵轴平移配准误差Δy旋转角度配准误差Δθ配准时间5.5参数对配准精度的影响本文的目标函数采用的是含有参数α的Rényi互信息.前面的证明中我们选取了最佳的参数水平来进行配准.然而,该方法依赖于图像、特征点的实际位置与配准期望距离d.不同的图像在算法中所求得的参数α并不相同.为测试本文的算法对参数的敏感度,我们选取两幅已对齐的多模图像,对其中一幅进行平移和旋转后作为浮动图像,固定参数α的值,分别用本文方法和基于灰度的Rényi互信息方法进行配准.图11描述了上述实验结果.其中横坐标为参数值,纵坐标为配准精度,分别单独进行平移或旋转构成浮动图像.图中同色的3条曲线表示在不同的参种互信息方法配准精度都较低.由于合理参数水平下的Rényi互信息比Shannon互信息函数更平滑,局部极值少(如图2),所以基于灰度的Rényi互信息配准结果略高于归一化互信息与加权熵互信息的结果.在多模情况中,两幅图中相近特征点的周围局部空间像素灰度与梯度相差极大,因此SIFT-Ransac配准方法配准成功率非常低.同样,由于多模图像的差异,使得脑部轮廓差别很大,轮廓特征点配准方法精度不高.而特征点最小生成树的差异也同时影响了对Rényi熵的估计,使得Rényi熵图配准方法精度低于灰度Rényi互信息方法的精度.本文方法结合了以上方法的优点:既利用了Rényi互信息函数的优良性质,又采用了特征点的空间位置进行配准,避免了多模图像灰度差异的影响.表2和表3也显示了在成功率和速度的评判上,本方法明显优于其他几种方法.Page9数水平下沿X,Y轴平移和旋转对配准精度的影响.图中基于灰度的Rényi互信息受参数的影响波动较大,而基于特征点的Rényi互信息受参数影响不明显,函数线平滑并有相当长的距离趋于水平,精度也高于前者.这主要是因为该方法只利用特征点空间位置计算联合概率分布.而多模情况下灰度直方图构成的目标函数计算不准确,受参数影响大.6结论本文在提取的稳定多尺度噪声点基础上,结合Rényi互信息理论提出了基于特征点Rényi互信息医学图像配准方法.该方法的目标函数是通过对特征点的空间坐标直接计算得到的,有效避免了多模噪声图像间的灰度差异,处理数据量小,速度快.同时吸收了Rényi互信息局部极值少的优点,进一步提高了配准精度.与多种配准方法相比,该方法速度较快、精度高,是一种有效的自动配准方法.
