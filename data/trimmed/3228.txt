Page1类选择排序的可逆逻辑综合算法万四爽陈汉武曹如进(东南大学计算机科学与工程学院南京210096)摘要可逆逻辑综合是指对给定的可逆函数自动构造对应的可逆逻辑电路.由于搜索空间随电路规模增长成指数增长,现有的可逆逻辑综合算法虽然能够得到近似最优的解,但是都存在计算时间过长的问题.文中提出了一种类似选择排序的可逆逻辑综合算法,其实质为基于变换规则的合成法.它采用一个无向无权图表示所有可以进行变换的路径,在综合的过程中,采用选择排序思想每次从小到大的选择需要交换的输出项,然后从路径选择图中找到最优的路径进行变换,最终使得函数的输出序列有序即完成综合.此外,文中还对得到的量子电路进行了优化.实验表明,相比其它综合算法,该算法不仅总能获得最优解或近似最优解,而且效率高、易于实现.关键词量子计算;可逆逻辑综合;Toffoli门;选择排序;量子电路1引言量子计算机可等效为一个量子图灵机,而理论Page2光计算和信息加密等领域中,因此可逆逻辑的研究已变得越来越重要.可逆逻辑综合是指对给定的可逆函数自动构造对应的可逆逻辑电路.与经典电路不同,可逆逻辑电路不能有回路,不能出现扇入、扇出操作,正是这些不同决定了经典的电路综合方法不能适用于量子可逆逻辑电路综合.目前量子可逆逻辑电路大部分采用Toffoli门根据函数的真值表进行构造,主要可以分为两大类.一类像采用布尔可满足性(BooleanSatisfiability,SAT)方法[2]、定量的布尔公式(Quan-tifiedBooleanFormula,QBF)方法[3]、动态规划(DynamicProgramming,DP)方法[4]和符号的可达性(SymbolicReachability)[5]等近似穷举的搜索方法,虽然能够产生最优解,但是由于搜索的范围过大,往往需要很长的计算时间,而且随着电路规模的增大,搜索空间会成指数增长,导致运行时间无法忍受.另一类采用启发式的搜索方法,如Rademacher-Walsh谱均数方法[6]、二进制共享决策图方法[7]、基于模板的变换法(Template-BasedTransformation)[8]和基于PPRM(Positive-PolarityRead-Muller)表达式的变换法[9].这类方法是穷举法的改进,在搜索的过程中增加了启发式规则,减少了搜索的范围,缩短了运行时间,但是这类方法合成的电路往往代价不是最小,而且还不能保证合成算法的收敛性.此外,还可以将真值表翻译成酉矩阵,通过选取特定的通用门库[10]进行分解,其一般的解析表达式最近也已给出[11].此外,最近还有新的研究方向,对偶量子计算和对偶量子计算机[12],其变换不再满足酉性,而且可以是不可逆的[12-13],不过上述经典的可逆逻辑综合算法依然可能适用.本文在真值表的基础上采用一种新的基于变换规则的综合算法,提出了路径选择图的概念,其实质是用一个无向无权图表示变换规则,通过一系列的变换,把输出系列变成输入序列.在综合的过程中,采用选择排序的思想,按照递增顺序每次选择相应的输出项,从路径选择图中找到适合的路径进行交换,直到所有输出项有序即把输出变成了输入,此时综合完成.这样得到的变化序列对应的量子线路的逆序即为综合的结果.为了减少合成线路的代价,本文还提出了一系列的优化规则化简得到的量子线路.2一些基本概念定义1.Toffoli门.一个n比特的Toffoli门表示为TOFn(x1,x2,…,xn),保持前n-1个输入不变,只有当前n-1个输入比特同时为1时才改变第n个输入比特.TOF1(x1)为非门(NOT);TOF2(x1,x2)为控制非门(CNOT);TOF3(x1,x2,x3)为标准Toffoli门,如图1所示.定义2.n个输入与n个输出变量的布尔函数f:(x1,x2,…,xn)→{y1,y2,…,yn}是可逆函数当且仅当f是双射的.n变量的可逆函数可以用真值表描述,也可以用整数集合{0,1,…,2n-1-1}的置换表示.例如函数f={0,1,2,7,4,6,3,5}表示的3变量可逆函数真值表和对应的电路如图2所示.定义3.等长字符串p和q之间的Hamming距离H(p,q)是p和q对应位置的不同字符的个数.特别地,可逆函数f的任一输出项与对应输入项的Hamming距离简称为输出项的Hamming距离.定义4.函数f的复杂度C(f)是其所有输出项的Hamming距离之和.例如图2中函数f的复杂度为C(f)=0+0+0+1+0+2+2+1=6.3初步知识在这个章节我们给出类选择排序可逆逻辑综合算法的一些定义和定理.定义5.对n比特的可逆函数f,如果存在两个只有1位不同的输出项A、B,则可将A、B交换而得到一个新的可逆函数f,这个交换操作我们定义Page3为SWAP[A,B].每个SWAP操作都可以用一个Toffoli门实现.例1.考虑图2函数f={0,1,2,7,4,6,3,5},其中输出项[000]与[001]只有一位不同,则可以做SWAP[000,001]操作,从而得到一个新的函数f={1,0,2,7,4,6,3,5},对应的Toffoli门为TOF3(x-定理1.每个SWAP操作改变输出项的Hamming距离为1.证明.SWAP操作只改变了输出项的一位,故Hamming距离改变为1.例如,将输入000的输出000改为001,其Hamming距离减少1.定义6.n比特可逆函数的路径选择图G=(V,E)是一个无向无权图,点集V={0,1,…,2n-1}表示2n个输入或者输出,边集E={eij|SWAP(i,j),i,j∈V},即每条边表示连接的2个顶点能够进行SWAP操作.G中两顶点A、B之间存在一条路径,则表明A经过一系列的SWAP操作能够到达B,路径长度为此路径经过的边数.例2.对于3比特的路径选择图如图4所示,其中点(0)2=000与(1)2=001之间有一条边,表示0,1之间可进行SWAP[000,001].如果需要把000和111交换,可以从图中找出其中一条0~7的路径000->001->101->111,则经过SWAP[000,001],SWAP[001,101],SWAP[101,111]可以实现0和7的交换.定理2.可逆函数输出项A和B的Hamming距离为k,则在路径选择图中A到B必然存在一条长度至少为k的路径,即交换A和B要进行k步SWAP操作.证明.路径选择图是连通的,故A到B必然存在一条路径.由定理1,SWAP操作每次仅改变A或者B的1位,而A和B的Hamming距离为k,故交换A、B至少需要k次SWAP操作,即A到B肯定存在一条长度至少为k的路径.根据定理2,很容易得出如下引理.引理1.对于n比特可逆函数,假设需要交换的两个输出项分别为A和B,则A与B的Ham-ming距离1H(A,B)n.(1)当H(A,B)=1,则A、B之间有一条直接路径(长度为1).A和B可以直接交换,即可以直接进行SWAP[A,B]操作.(2)当H(A,B)=2,则A、B间有长度为2的路径,即该路径上有一个中间结点C,则A、B交换可以通过C实现SWAP[A,C],SWAP[C,B],而中间结点C有两种选择,故路径条数为2.(3)当H(A,B)=3,则A、B间有长度为3的路径,即该路径上有两个中间结点A1,B1.则A,B的交换可以通过A1,B1实现,SWAP[A,A1],SWAP[A1,B1],SWAP[B1,B].因为A1有3种选择,对特定的A1而B1有2种选择,故路径条数为3×2=6.(4)当H(A,B)=k,则A到B有长度为k的路径,且路径条数最多有k!条.定理3.函数f与经过SWAP操作后得到的新函数f相比复杂度或加2或减2或不变.证明.假设f的两个输出项为A、B可以进行SWAP操作,在SWAP之前A、B的Hamming距离分别记为HA、HB.不失一般性,假设A、B最后一位不同,则A、B可表示为SWAP后,可以看到HA,HB的值或+1,或-1,而HA,HB取值互不影响,故当HA,HB同时取1时函数f的复杂度C(f)增加2;当同时取-1时C(f)减2;Page4当取不同值时时复杂度C(f)不变.引理2.假设f两个输出项A和B的Ham-ming距离为k,交换A、B得到的新函数为f,则用最少次数的SWAP操作后f的复杂度至多减少2k,即max{C(f)-C(f)}=2×k.证明.根据定理2可知,f到f最少需要经过k步SWAP操作.而由定理3每次SWAP操作,最多能减少复杂度值为2,故交换A、B后,f复杂度至多减少2k.从引理2很容易得到如下推论.推论1.对于3比特可逆函数,假设需要交换的2个输出项分别为A、B,则A和B的Hamming距离为1H(A,B)3:(1)当H(A,B)=1,交换A、B最多能使函数复杂度减少2.(2)当H(A,B)=2,交换A、B最多能使函数复(3)当H(A,B)=3,交换A、B最多能使函数复杂度减少4.杂度减少6.4算法描述算法的目的是通过一系列的SWAP操作使得输出序列有序,而每一次SWAP就对应一个Toffoli门.当输出序列有序即输出经过一系列的Toffoli门作用变成了输入时,把变换对应的Toffoli门按逆序连接组成的线路即为综合结果.其过程类似选择排序:按照输入从0~2n-1的顺序,通过路径选择图中的合适路径,每次把选择最小的输出项将其交换到正确的位置.其中路径的选择要使可逆函数f的复杂度逐渐减少直到为0,当f的复杂度为0即输出项有序时算法终止.算法由两部分组成:路径的选择和电路的生成.下面详细描述了这两步算法,然后给出了一个完整的例子来说明算法是如何进行的.4.1路径的选择假设需交换输出项A和B,其Hamming距离为k.从路径选择图可以看到:(1)A、B可能存在多条长度不同的路径,而根据定理2只需从路径选择图中找长度为k的A到B的路径;(2)A、B可能存在多条长度为k的路径,根据定理3如果找到一条能使函数复杂度减少2k的路径则算法终止,否则选择一条能使复杂度减少最多的路径.同时,因为已遍历过的输出项已经有序,故可将其对应路径选择图中的结点删除,从而减少路径选择的复杂度.由此可见,路径选择的过程是个终止条件很容易满足的深度优先搜索的过程.算法1.从路径选择图中寻找交换A,B的路径.输入:路径选择图G,可逆函数f,待交换的输出项A、B输出:交换A、B后能最大地减少f复杂度的A到BFIND-SWAP-PATH(G,A,B)1.计算f的复杂度C(f);2.h=H(A,B),H(A,B)为A,B的Hamming距离;3.ifh=0return0;4.ifh=1return路径L:A→B;5.ifh>16.采用DFS在G中寻找A到B的路径,遍历层数为7.ifC(f)-C(f)=2k,停止遍历,return8.else遍历所有路径,找到Δe=C(f)-C(f)最大的9.returnL:A→…→B;10.End.算法2.从路径选择图中删除顶点X.输入:路径选择图G,待删除顶点X输出:新的路径选择图DELETE-VERTEX(X)1.在图G中找到顶点X;2.删除所有连接到顶点X的边;3.删除顶点X;4.returnG//G为删除X后的新图;4.2线路生成类似选择排序,按照输入从0~2n-1的顺序,每次选择当前最小输出项,通过算法1得到的路径把其交换到正确的位置,直到整个输出序列有序.而每一次交换对应一系列Toffoli门,将所有Toffoli门逆序连接组成的线路即为综合结果.算法3.根据可逆函数f生成Toffoli门表示输入:可逆函数f:(0,1,2,…,2n-1)→{y1,y2,…,yn}输出:Toffoli门表示的量子线路BUILD-TOFFOLI-NETWORK(f)1.fori=0to2n-22.ifi=y[i]donothing;3.elseL=FIND-SWAP-PATH(G,y[i],i);4.按照路径L通过一系列SWAP操作把i交换至的量子线路Circuit.Page55.f=f//用f更新f;6.Endelse7.DELETE-VERTEX(i);8.Endfor9.按照SWAP操作的逆序将每个SWAP对应的10.returnCircuit:{t1,t2,…,tm}.4.3算法正确性证明接下来我们给出算法的正确性证明.定理4.路径选择图按顺序删除顶点后仍然是连通的.证明.假设当前删除的顶点为V(V≠2n-1),因为是按顺序删除,则V中必有一位为0,不失一般性假设V=(x0,x1,…,0,…,xn),则必存在V>V,其中V相比V在刚刚假设为0的位上是1,即V=(x0,x1,…,1,…,xn),故在路径选择图中存在一条直接路径连接V和V.则此命题得证.证毕.引理3.我们提出的类排序可逆逻辑综合算法肯定能得到可行解.证明.由算法3可以看到随着输入从0到2n-2,不断的通过交换使得输出序列变得有序.当前面2n-1个输出项有序的时,第2n项即输入值为2n-1时,对应的输出肯定为2n-1.而由定理4可以得到从0~2n-2的每步中路径选择图都是连通的,即存在交换的路径使得每步的输出与输入相同,当前面2n-1个输出变得有序时,第2n项必然也是有序的.故类选择排序综合算法能得到可行解.例3.以可逆函数f=[7,0,1,2,3,4,5,6]为例,其真值表如图5所示,来说明类选择排序算法的流程.1.类似选择排序,从000开始,y[000]=111≠000即000对应的输出111不在正确位置上,故需交换[111,000],此时H(000,111)=3,C(f)=14.根据算法1,通过遍历得到第1条路径(1)111-101-001-000,按这条路径交换后得到函数的真值表如图6(a)所示,复杂度减少ΔC=14-10=4,根据推论1,距离为3,复杂度可最多减少6,即还可能存在比4更好的结果,故继续寻找新的路径;接着得到第2条路径(2)111-101-100-000,按这条路径交换后得到函数的真值表如图6(b)所示,函数复杂度减少了4,故仍需继续寻找新的路径;接着得到第3条路径(3)111-011-001-000,按这条路径交换后结果如图6(c)所示,此时ΔC=14-8=6,函数复杂度减少6,根据推论1可知这是最好的结果,故不需要继续寻找新的路径,按111->011->001->000的顺序交换即SWAP[111,011],SWAP[011,001],SWAP[001,000]可交换[111,000],得到新的函数f1=[0,1,3,2,7,4,5,6].然后删除路径选择图中的000结点,得到新的路径选择图如图7(b)所示.图6不同路径交换000和111后对应真值表2.接着看001项,从图6(c)可以看到经过步1后000对应的输出项已经处于正确的位置,而001输入正好对应001输出,故这步不需要作交换操作,只需删除路径选择图上001的结点,得到新的路径选择图如图7(c)所示.此时可逆函数仍然是f1=[0,1,3,2,7,4,5,6].3.当输入为010时,从图6(c)中看到输出y[010]=011≠010,故需交换[111,010],此时H(010,111)=1,C(f)=8.根据引理1,可以直接交换[010,011]即SWAP[010,011],得到新的函数f2=[0,1,2,3,7,4,5,6],其真值表如图8(a)所示.然后删除路径选择图中的010结点,得到新的路径选择图如图7(d)所示.4.当输入为011时,从图8(a)可以看出输出y[011]=011=011,故不需进行交换操作,只需删除路径选择图上011的结点,得到新的路径选择图如图7(e)所示.此时,可逆函数依然为f2=[0,1,2,3,7,4,5,6].5.当输入为100时,从图8(a)可以看出输出y[100]=111≠100,需交换[111,100],此时H(100,111)=2,C(f)=6.根据算法1找到第1条路径(1)111-101-100,按照这条路径交换得到新函数的真值表如图8(b)所示,函数复杂度减少ΔC=14-10=4,根据推论1,这条路径是最好选择,故不需要继续进行寻找新的路径,按111->101->100的顺序交换即进行SWAP[111,101],SWAP[101,100]操作得到新函数f3=[0,1,2,3,4,5,7,6].然后删除路径选择图中的100结点,得到新的路径选择图如图7(f)所示.6.当输入为101时,从图8(b)可知输出y[101]=101=101,故不需进行交换操作,只需删除路径选择图上101的结点,得到新的路径选择图如图7(g)所示.此时,f3=[0,1,2,Page63,4,5,7,6].7.当输入为110时,从图8(b)可知输出y[110]=111≠110,故需交换[111,110].此时H(110,111)=1,C(f)=2.根据引理1,可以直接交换[010,011]即直接进行SWAP[110,图73比特可逆函数路径选择图((a)~(h)对应步1~8分别删除顶点000,001,010,011,100,101,110后的路径图)图88.根据步1~7得到的SWAP序列为SWAP[111,011],SWAP[011,001],SWAP[001,000],SWAP[010,011],SWAP[111,101],SWAP[101,100],SWAP[110,111],对应的Toffoli门分别为TOF3(x2,x1,x3),TOF3(x-TOF3(x-TOF3(x3,x-的线路如图9即实现f=[7,0,1,2,3,4,5,6].图9f=[7,0,1,2,3,4,5,6]对应的Toffoli门组成的电路图4.4算法复杂度分析根据算法2,可以看出外层循环次数为2n-2,在循环内部每次调用算法1FIND-SWAP-PATH来找到交换路径,而其中路径个数最多为n!,所以总的算法复杂度为2n×n!.但这是个非常宽泛的上111]操作,得到新的函数f4=[0,1,2,3,4,5,6,7],其真值表如图8(c)所示.然后删除路径选择图中的110结点,得到新的路径选择图如图7(h)所示.此时,原函数f=[7,0,1,2,3,4,5,6]已经变成恒等函数f4=[0,1,2,3,4,5,6,7].界,因为我们在寻找路径的时候,搜索终止条件很容易满足.此外,很明显看出随着算法的进行,可逆函数的输出趋向有序,路径图顶点数越来越少,每次选择的路径越来越短,路径条数越来越少,所以实际所需时间远小于2n×n!.这也体现在后面实验结果上.5优化此时算法得到的电路不是最优的,还可以继续优化,接下来给出我们的优化方法.定理5.当Toffoli门A=TOFk(x1,x2,…,xk-1,xk)与B=TOFl(y1,y2,…,yl-1,yl)满足(1)xk{y1,y2,…,yl-1}或者(2)i∈[1,k-1],j∈[1,l-1]满足xi=y-证明.条件1说明了B的控制端前没有A的控制端,故无论A如果变化都不会影响B.条件2说明了A和B的控制端不可能同时满足条件,即输入Page7相同时,A和B中只有一个能起作用,所以A可以对B不会有影响.由定理5很容易得到性质1.性质1.交换规则.若Toffoli门A与B互不影响,则可以交换A、B的位置.例4.如图10(a)中B受控端前没A的控制端,A的受控端前没B的控制端,则A、B可交换.图10(b)中当A成立时B肯定不成立,同样B成立时A肯定不成立,则可将A、B交换.定理6.合并规则.相邻的2个Toffoli门,如果受控端相同而控制端只有一位不同,则可以把不同的控制端去掉,留下相同的控制端和受控端合并成1个Toffoli门.证明.不失一般性假设相邻的2个Toffoli门A、B,前n-1位为控制端,其中第n-1位控制端不同,第n位为受控端,则A表示为TOFn(x1,x2,…,xn-1,xn),B为TOFn(x1,x2,…,x-和B作用后,受控端为xn=x1x2…x-而控制端不变,故得证.图11中给出了Toffoli门的一些合并例子.定理7.消除规则.如果存在连续的两个完全相同的Toffoli门,则可以将这2个Toffoli门去掉.tm}优化.证明.不失一般性,假设2个连续的Toffoli门为A和B,A和B相同,且前n-1位为控制端,其中第n位为受控端,则A和B均可表示为TOFn(x1,x2,…,xn-1,xn),由于A、B完全相同,故控制端不变,受控端经过A和B后为xn=x1x2…xn-1(x1x2…xn-1xn)故经过A、B后受控端也没变化,则可将A、B从电路图中去掉.根据定理6和定理7可得到如下优化算法.算法4.对算法3中量子线路Circuit:{t1,t2,…,输入:算法3中量子线路Circuit:{t1,t2,…,tm}输出:优化后的量子线路Optimal-CircuitOPTIMAL-CIRCUIT(Circuit)1.fori=1tom2.根据推论2尽可能将与t[i]有相同受控端的3.根据定理6尽可能与t[i]后面的Toffoli门进行4.i=不能与t[i]合并的第一个Toffoli门下标;5.得到优化后的量子线路Optimal-Circuit;6.ifCircuit=Optimal-Circuitreturn优化后的量子线路Optimal-Circuit;7.elseOPTIMAL-CIRCUIT(Optimal-Circuit).例5.考虑例4中得到的量子电路,对其运用算法4,优化过程如图12所示,其中图(a)为例子中图12f=[7,0,1,2,3,4,5,6]得到Toffoli门的合并过程Page8得到的量子电路,步1和步2表示进行交换操作,交换后得到的图如(b)所示,步3和步4表示图(b)中电路前四项和后两项可以分别进行合并,从而可以得到图(c)中所示的最优电路.6实验结果和分析为了验证本文提出的算法的正确性,我们用C++编写了算法的实现程序,对任意可逆函数均可得到对应的电路图,实验环境是IntelCoreTM2CPU2.13GHz,2GB内存,操作系统为WindowsXPSP2.考虑到16!=2.09227899×1013对计算时间和存储的要求难以实现,故采用流行的3×3量子电路的所有可逆函数的实验来进行统计分析,不进行优化总共用时0.219s,优化后总共用时0.410s,其结果如表1所示.表1中的每一行表示的是使用相同门数量对应的可逆函数的个数,每一列为所有可逆函数的和为8!=40320.最优情况是来自文献[4]中的实验结果,使用的门库含有NOT、CNOT、TOF3;POT列是文献[14]的实验结果,只使用了TOF3,是目前快速综合算法中比较好的结果;优化前是指采用本文提出的算法在优化前只使用了TOF门的结果;优化后的结果使用了NOT、CNOT、TOF3门.从表1中还可以明显看出,优化后我们的算法使用的门数量平均值为6.14,相比文献[10]中的6.83更接近最优值的5.87[4],意味着我们的算法能更最近最优解.表2和其它启发式算法的比较结果[1,0,3,2,5,7,4,6][7,0,1,2,3,4,5,6][0,1,2,3,4,6,5,7][0,1,2,4,3,5,6,7][0,1,2,3,4,5,6,8,7,9,10,11,12,13,14,15]715777[1,2,3,4,5,6,7,0][1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,0][0,7,6,9,4,11,10,13,8,15,14,1,12,3,2,5]436143TOF2(d,a)TOF2(c,b)TOF2(d,c)[3,6,2,5,7,1,0,4]门的数量14131211109857778208906498171025310630831080956170499126572397315892149962953811242780183311614471362547634814992102907828210门数量均值5.876.837.656.14接下来采用文献[9,14-16]中用到的函数综合例子(包括9个3比特函数和3个4比特函数),把我们的算法与其它目前结果较好的算法进行比较,采用的包括PPRM表达式方法[9]、Non-search方法[16]和POT方法[14].其结果如表2所示,从表中可以看出,虽然本文得到的结果和POT方法相同,接近PPRM方法,好于Non-search方法,但是从平均时间上来说,在实验环境不优于文献[10](IntelXeon3GHz,2Gn内存的工作站)的情况下,本文综合每个电路的平均时间为0.01ms,远好于POT方法的0.2ms和PPRM方法的0.5s[10].由此可见,在得到近似最优电路的前提下,我们算法的效率是其它算法的几十到几百倍.Page9[1,2,7,5,6,3,0,4][4,3,0,2,7,5,6,1][7,5,2,4,6,1,0,3]此外,相比其它算法,很明显可以看出我们的算法思路简单清晰,并且在任何实验环境条件下均可轻松模拟实现.而且,对于该算法得到的TOFn门,可以很容易根据文献[11]中的方法继续化简,因此该算法具有一定的实用性.7结论本文提出了一种新的可逆逻辑综合算法,其实质为基于变换规则的合成法.它采用一个无向无权图表示所有可以进行变换的路径,并在综合的过程中,类似选择排序算法的思想从小到大地选择需要交换的输出项,接着从路径选择图中找到最优的路径进行变换,最终综合完成后使输出项序列有序,而每条变换路径即对应一系列的电路门级联.在此基础上,本文还提出了一个优化算法化简所得到的量子电路,使最后得到的电路代价减少.实验表明,相比其它综合算法,该算法不仅总能获得最优解或近似最优解,而且效率优势明显.此外,本文提出的算法易于理解,对于有计算机专业基础的人容易实现,同时基于图论解决可逆逻辑综合问题的思想也有一定的借鉴意义.
