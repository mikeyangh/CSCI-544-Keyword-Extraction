Page1计算机辅助乱针绣制作技术研究陈圣国1),2)孙正兴1)项建华1),3)张岩1)1)(南京大学计算机软件新技术国家重点实验室南京210093)2)(金陵科技学院信息技术学院南京211169)3)(常州纺织服装职业技术学院创意学院江苏常州213164)摘要乱针绣是一种极具艺术和文化价值的工艺产品,计算机辅助乱针绣制作对这一文化遗产的传承和发展具有重要意义.文中将计算机辅助乱针绣制作技术归结为绣线颜色子集选择和交叉针迹参数计算两大关键技术问题.首先,提出了基于遗传算法的绣线颜色子集优化选择方法,通过对标准交叉算子和变异算子的改进实现了绣机绣线颜色种类与绣品视觉效果间的有效折衷.其次,设计了计算机辅助乱针绣制作铺色和精绣两阶段针迹生成策略,并分别提出了一种基于图像亮度梯度的铺色交叉针迹参数算法及一种基于试探和混色原理的精绣交叉针迹参数计算方法,降低了机绣少量颜色而造成绣品与原图像间的色差.最后,给出了一个完整的计算机辅助乱针绣制作处理流程,并以实验验证了文中提出方法的有效性,为计算机辅助乱针绣制作技术的进一步研究奠定了基础.关键词计算机辅助刺绣;乱针绣;交叉针迹计算;遗传算法1引言乱针绣创立于20世纪30年代,是中国刺绣在现代文化背景下的崭新发展,它摆脱了我国几千年传统刺绣“排比其针,密接其线”绣法的拘束,形成了独特的“长短参差,斜线交叉,分层搀色”乱针技艺,利于艺人自由表达思想情感,实现“画理”与“绣理”的有机结合;乱针绣长于绣制油画、摄影和素描等稿本,绣品具有针法活泼、线条流畅、色彩丰富、层次感强、风格独特等特点,其作品蕴含着精美的艺术价值和深厚的文化价值[1].但是,乱针绣工艺技术难度较大,制作周期较长,一幅40cm×50cm规格的人像绣品工期达3个多月,有些精品甚至需要近一年的时间才能完成,使得乱针绣的从业人数量较少,作品价格昂贵.因此,采用计算机辅助技术对乱针绣工艺的保护和进一步发展具有十分重要的意义.已有的计算机辅助刺绣系统研究解决了传统刺绣工艺的计算机化问题[2-5],通常,它们通过对输入数字图像进行边缘检测[6]或色彩聚类[7]:首先将图像分割为互不交叉的若干闭合区域,再采用平面针法如平包针、席纹、平针[8]或随机针迹[9]对每个区域分别进行填充而自动生成针迹.但是,这种方法将同一区域内的针迹首尾顺次相连,且针迹间需要尽量避免产生交叉,所生成绣品的区域间缺乏颜色过渡,色彩层次单一,难以满足乱针绣制作的需要.事实上,使用计算机辅助制作乱针绣,必须解决几个关键技术问题:(1)选择颜色子集.在手工绣制过程中可使用的绣线颜色较为丰富,例如绣线生产厂商DMC的绣线颜色表包含454种颜色,而机器绣制时由于电脑绣花机硬件条件的限制不可能在同一幅作品中使用绣线颜色表中所有颜色,常见的电脑绣花机可以同时使用的颜色数只有6、9或12种,如果使用的绣线颜色数较多,绣制时需要频繁地停机换线,影响机器绣制的速度.因此,需要根据输入图像的色彩分布特征从绣线颜色表中选择一个子集,使用少量的颜色来重建输入图像.(2)针迹生成策略.参照人工绣制过程,针迹生成可以分为铺色和精绣两个阶段.铺色阶段将绣制图像划分为大的色块然后采用交叉针迹填充.由于色块之间没有交叉,同一色块中的针迹使用相同的颜色,因此针迹生成的顺序对绣品的视觉效果几乎没有影响,针迹生成策略较为简单.精绣阶段针迹数量庞大,针迹覆盖区域相互交叉,针迹按不同的顺序绣制生成的绣品视觉效果也不相同,如果针迹生成策略选择不当将会带来巨大的计算量.(3)针迹参数的计算方法.铺色阶段需要计算的针迹参数主要是每个色块交叉针迹的方向,填充时采用不同的针迹方向会影响最终绣品的视觉效果.而精绣阶段需要确定每一针迹的起点和终点以及每一针迹的颜色.乱针绣利用色彩的空间混合现象[10],采用分层加色,由于空间距离和视觉生理的限制,眼睛辨别不出过小或过远物象的细节,把各种不同的色块感受成一个新的色彩,远看时产生十分逼真的视觉效果,因此,在生成针迹时颜色的选择必须考虑颜色的空间混合效果.采用较少数量的颜色来重建具有丰富色彩的图像是数字图像处理基本技术色彩量化[11]的主要研究内容,目前已有多种算法,比较传统的算法有统一量化法、频度序列法、中位切割法、中值分裂法、八叉树法和聚类法等.近年来,部分研究者又提出了一些新的方法或改进方法以改善重建图像的视觉效果,例如使用加权积色彩量化算法CoQuWeiP[11]、基于蚁群聚类的色彩量化算法[12]、结合色彩抖动的色彩量化[13-14]、改进八叉树[15]等,这些方法应用于乱针绣颜色子集选择时存在一个共同的问题,即它们选择出的颜色集并不是从可选的绣线颜色集中选出的,这些算法按照某种优化条件求解得到全局和局部最优解,如果从绣线颜色表寻找相似颜色来替代这些算法的全局最优或局部最优解,则得到的解可能与最优解相差很大.本文第2节中我们建立了一个简单的模型,然后采用二进制串编码表示解个体,使用遗传算法来解决这个问题.遗传算法是模拟自然界生物进化过程与机制求解极值问题的一类自组织、自适应人工智能技术[16],首先对问题空间编码,将其映射到搜索空间,用适应度评价每个个体的优良程度,然后以一定概率进行选择操作、交叉操作、变异操作,使平均适应度高的模式在每一代保留下来,经逐次迭代,找到最大适应度的个体,达到优化的目的.虽然遗传算法在许多领域中都有成功的应用,但其自身也存在不Page3足[17],如局部搜索能力差、存在早熟收敛等现象.算法一旦出现早熟收敛,将无法得到问题的最优解.遗传算法中变异算子的主要目的之一就是要维持群体的多样性,防止出现早熟现象[18].目前常用的变异算子包括基本位变异、均匀变异、边界变异、非均匀变异、高斯变异、二元变异等[17-18].基本位变异是最简单的变异算子,对个体编码串中以变异概率pm随机指定的某一位或某几位基因位上的基因值作变异运算,改变的只是个体编码串中的个别几个基因位上的基因值,且变异发生的概率较小,因此其发挥作用比较慢,效果不明显.均匀变异以某一较小的概率来替换个体编码串中各个基因位上的原有基因值,它使得搜索点可以在整个搜索空间内自由地移动,从而可以增加群体的多样性,使算法处理更多的模式,适合应用于遗传算法的初期运行阶段.边界变异是均匀变异的一个变形,随机地取基因位的二个对应边界基因值之一去替代原有基因值,如果个体采用二进制编码,每个基因位取值为0或1则与均匀变异相同.非均匀变异对原有基因值作一随机扰动,以扰动后的结果作为变异后的新基因值,适宜点搜索原个体附近的微小区域.高斯变异是改进遗传算法对重点搜索区域的局部搜索性能的另一种变异操作方法,用均值为μ、方差为σ2的正态分布的一个随机数来替换原有基因值,也是重点搜索原个体附近的某个局部区域.显然,非均匀变异和高斯变异不适合个体采用二进制串编码的情况.二元变异[19]需要两条染色体参与,通过二元变异操作后生成两条新个体中的各个基因分别取原染色体对应基因值的同或/异或.由于绣线颜色子集选择问题对个体编码有效性的特殊要求,二元变异生成的二进制串不能保证是有效的个体,因此无法用于绣线颜色子集选择问题的求解.考虑到绣线颜色子集选择问题的特点,本文提出一种根据问题的启发式信息自适应地确定变异概率的变异算子,变异前根据启发式信息确定每个基因位变异的概率,实验表明所求得解的适应度值明显提高,早熟现象得到了一定程度的抑制.本文第2节首先介绍乱针绣绣线颜色子集选择的优化模型和使用遗传算法求解该问题的个体编码方式及适应度函数定义,然后介绍了计算变异概率的方法.针迹生成策略可借鉴基于笔划绘制方法的思想,将乱针绣的每一个针迹看成是一个笔划,则绣制过程可以看成是基于笔划的绘制过程.基于笔划的绘制方法(SBR)是非真实感绘制的主要技术之一[20],通过绘制离散的元素(如绘画的笔触或圆点)来自动生成非真实感图形[21],许多学者提出了不同绘画风格的算法[22],如油画、水粉画、钢笔画等.不同风格作品的基于笔划绘制算法存在很大差异,Hertzmann[21]总结了各种算法的设计思想,将其分为优化算法和贪婪算法.优化算法包括Voronoi算法和反复试验算法,Voronoi算法不能处理颜色信息及笔划重叠问题,反复试验算法需要较多计算时间;贪婪算法采用谨慎而有启发的方法设计笔划绘制步骤,按照单一途径将笔划添加到图像结构中,并且笔划生成后就不再修改,能很快生成高质量的结果.乱针绣多层绣制的特点不允许采用Voronoi算法,而且一副完整的绣品针迹数量巨大,也不适宜采用反复试验法进行优化计算,因此,本文的工作采用贪婪法的思想,每一针迹生成后不再进行修改.乱针绣铺色阶段的主要工作是确定针迹方向参数,由于传统刺绣采用平面绣法对针迹的方向没有特定的要求,已有刺绣辅助系统在填充时一般不考虑针迹方向,乱针绣无法借鉴这些系统的针迹填充方法.为此,我们根据乱针绣的特点给出了一个根据图像亮度梯度特征计算针迹方向参数的方法(第3节).由于乱针绣针迹的特点,目前基于笔划的绘制方法无法直接用于乱针绣精绣阶段的针迹生成,主要表现在几个方面:(1)乱针绣不允许生成曲线笔划,只能是直线笔划;(2)大部分基于笔划绘制的研究工作在生成油画等时允许多层绘制的作品时均使用了多分辨率技术[23-25],生成多种宽度的笔划,而电脑绣花机使用的绣线规格不可能太多.本文的研究工作假设采用统一规格的绣线进行绣制,也就是说笔划的宽度是统一的,因此,在生成针迹时不能采用多分辨率技术改变针迹的宽度;(3)目前已有的笔画生成方法一般不考虑空间颜色混合效果.据此,本文3.2节给出了一种用反复试验法生成确定单个针迹起始点的算法,并根据颜色的空间混合原理给出了一种选择针迹颜色的算法.此外,本文给出了完整的计算机辅助乱针绣流程和部分实验结果(第4节),最后对目前算法存在的问题和进一步研究需要解决的问题进行了探讨.2基于遗传算法的绣线颜色子集选择2.1乱针绣绣线颜色子集选择的优化模型由于硬件条件的限制,使用刺绣机制作乱针绣只能使用少量种类的绣线,需要从所有可用的绣线Page4颜色中选择一个子集.假设完整的绣线颜色集T={t1,t2,…,tn}中共有n种绣线,需要从中选取一个k个元素的子集S={s1,s2,…,sk},其中si∈T,i=1,2,…,k,k为刺绣机允许使用的颜色数,可用式(1)来表示使用颜色子集中的颜色重建的图像与原图像之间的色差,我们需要求得一个颜色子集S,使得该式的值最小,用这个子集中颜色重建的图像与原图像的色彩相似度最高.式中:p、q分别为输入图像的宽度和高度;cij表示输入图像像素(i,j)的颜色值;D(cij,sl)表示颜色cij与sl的距离.如果采用三维向量表示RGB色彩空间中一个颜色值,犆=(r,g,b),两个不同颜色值犆1、犆2之间的距离通常可采用欧氏距离来表示,考虑到人眼对亮度信号更为敏感,而RGB三分量对亮度信号的贡献不同,对RGB三分量差值赋予不同的权值,对颜色的色彩距离计算公式进行调整,可以使计算出的距离差异更符合人眼的视觉特点,例如陈兆乾等[7]在刺绣打版系统中使用的距离计算方法为式(2).D(犆1,犆2)=(犆1-犆2)2.2用遗传算法求解绣线颜色子集选择问题程,基本步骤如下.使用遗传算法求解问题是一个演化迭代的过1.初始化参数,随机生成初始群体;2.个体评价.计算群体中各个个体的适应度;3.选择运算.将选择算子作用于群体,适应度高的个体以较大的概率被选择,适应度低的个体较较小的概率被选择,选择运算的目的是把优化的个体直接遗传到下一代或通过配对交叉产生新的个体再遗传到下一代;串的某些基因座上的基因值作变动;体的部分结构加以替换重组而生成新个体的操作;4.交叉运算.将交叉算子作用于群体,指把两个父代个5.变异运算.将变异算子作用于群体,对群体中的个体6.群体经过选择、交叉、变异运算之后得到下一代群体后,判断是否终止条件,若满足则终止输出群体中最优个体,算法终止,否则转步2.实现遗传算法首先需要确定基因的表示方法、个体适应度函数以及相关参数.本文工作中我们采用二进制串表示每个个体对应的基因,对可用绣线集中的每种绣线定义一个基因位,值为1表示该颜色的绣线被选中,若值为0则表示该绣线未被选中,则可用长度为n的二进制串表示一个个体,记G=(g1,g2,…,gn),其中gi取值为0或1,且满足式(3)的条件.选择操作前必须计算当前群体中每个个体的适应度,适应度值越大的个体对应的解越优.2.1节的模型表明式(1)的值越小,则说明个体的性能越好,越接近最优解,个体适应度定义为遗传算法的主要参数包括种群大小、最大遗传代数以及执行交叉算子的概率Pc和变异的概率Pm.当n较大时如果种群数太大会使得算法执行时间很长,我们的实验中选择DMC的绣线集,随机生成初始种群,选择种群大小为100,最大遗传代数1000,Pc、Pm为一般文献推荐范围内的值,采用精英选择遗传算法[26],每次遗传保留上一代的最优解,如果连续若干代遗传最优解保持不变,则终止算法,否则当遗传代数超过最大代次数时终止.2.3交叉算子遗传算法标准的交叉算子不能保证交叉生成的新个体满足条件(3),无法直接应用于本问题.图1为n=16,k=6的两个个体采用标准的单点交叉算子的例子,可以看出生成的两个新个体均不满足式(3).为了避免上述问题,我们对标准的单点交叉算子进行了改进,记p1、p2为两个父母个体,c1、c2为交叉生成的新个体,交叉过程如下:①初始化c1、c2所有基因位为0.②对所有基因位,若p1、p2该位置基因值均为1,则将p1、p2该位置值置为0,将c1、c2该位置值置为1.记满足该条件的基因位个数为s,记d=k-s.图2(a)为图1中两个父母个体取出均为1的基因Page5位后的情况,图2(b)为待生成的2个体对应的基因位置为1后的情况.③生成一个[1,d-1]之间的随机整数,记为cp.将p1中前cp个值为1的基因位复制到c1对应的基因位置,剩余的d-cp个值为1的基因位复制到c2对应的基因位置.将p2中前cp个值为1的基因位复制到c2对应的基因位置,剩余的d-cp个值为1的基因位复制到c1对应的基因位置.图3为图2中的例子取cp=2得到的两个新个体,可以看出新个体是符合式(3)的.2.4变异算子与交叉算子类似,标准的变异算子也存在同样的问题,当选中某个值为1的基因位,将其值变为0,则会使个体中值为1的基因位数量减少,反之则会使个体中值为1的基因位数量增加.对这个问题,我们采用了一种简单的方法来解决:当某个值为1的基因位被选中发生变异时,随机选择一个值为0的基因位同时发生变异;而当某个值为0的基因位发生变异时,随机选择一个值为1的基因位同时进行变异.在变异时可以只考虑对基因值为1的基因位进行处理,若采用均匀变异则仅对其中值为1的基因位以相同的概率决定该基因位是否进行变异.大量实验表明:均匀变异存在较明显的早熟现象,难以收敛到全局最优解.为此我们提出了一种自适应确定基因位的变异概率的方法.对于2.1节描述的优化问题,任意一个个体对应的解S={s1,s2,…,sk},原图像中的像素可按照其颜色分为k个集合A1、A2、…、Ak,任一集合Ai中的像素与si中的同一个元素颜色距离最近,定义:Vl=∑pij∈Al其中:pij为图像中坐标为(i,j)的像素;cij为其颜色值.则式(1)可改写为Vl表示像素集合Al中像素与颜色sl的距离和.如果sl远离图像中像素颜色分布的区域,则可能没有像素被加入像素集合Al,淘汰该绣线颜色用接近图像像素颜色分布区域的绣线颜色替换将使得到的解更优,如果我们以较大概率进行变异操作,则可能会促使个体更快地向最优解靠近;如果某绣线颜色sl对应的像素集合Al中像素很多,则该绣线颜色可能是最优解或距离最优解中某一绣线颜色距离较近,在变异中我们更倾向于保留这样的绣线颜色希望以较小的概率进行变异操作;如果S中多个元素集中分布在颜色空间的某一局部区域,此时如果淘汰位于局部区域中心的绣线颜色,则可能是解中绣线颜色的分布更均衡,也就是说,对位于局部区域中心的绣线颜色我们希望赋以更大的变异概率,而这样的绣线颜色由于其对应的像素集合元素少且与该绣线颜色的距离近,因此,对应的Vl值也相对较小.因位,采用式(7)确定其变异概率.综合以上讨论的几种情况,对所有值为1的基若Vl=0则可能该位对应的绣线颜色远离图像像素颜色分布的区域,变异概率为1;若Vl=maxiVi,则该位对应的绣线颜色可能为当前解对应的绣线颜色集中最好的,变异概率为0,不变异;否则,Vl越大变异概率越小.3乱针绣交叉针迹参数计算乱针绣作品在绣制时首先按照刺绣图稿的轮廓和色块进行铺色,采用较为规则、稀疏的交叉针绣制,然后再进行精绣,随着层次的增加,针迹越来越密,使整幅作品呈现出整体和谐的光感与色调感.参照人工绣制的过程,我们将乱针绣针迹生成过程分为铺色和精绣两个阶段,铺色阶段将输入图像分割成若干大色块区域,采用交叉针迹分别填充这些区域;精绣阶段根据输入图像的局部色彩分布寻找符合一定条件的针迹,使得针迹密度逐步增加.确定一个针迹需要确定其位置和绣线颜色,对铺色阶段针迹的颜色为所需填充的色块的颜色,根据图像分割的结果即可得到,填充时起点位置可以根据用户对填充针迹的密度要求平均分布,因此铺色阶段针迹参数计算主要的问题是确定针迹的方向和交叉的角度;而在精绣阶段,不仅需要确定针迹的位置,还需要根据已绣制的图像与原图像之间的差异选择绣线的颜色,以减小绣制图像与原图像之间的差别.3.1乱针绣铺色交叉针迹参数的计算铺色阶段采用相对规则的交叉针迹填充大色块,人工绣制时针迹方向完全由绣工按照各自的经验决定,不同的绣工处理方式不完全相同.交叉针迹Page6的参数包括方向和交叉角度,如图4所示,其中AB、CD为针迹,EF为两交叉针迹的角平分线,两条针迹的方向由参数θ和β确定,其与x轴的夹角分别为θ+β和θ-β.经过对一些乱针绣作品观察总结,我们认为参数θ可以看成是图像局部纹理的方向,而β的取决于色彩分布的状况,如果色彩在各个方向上变化均比较均匀,则针迹交叉的角度接近垂直,即β在45°左右,而如果在某一方向上变化较平缓,而其它方向变化较大,则β的值较小.参照一些研究者在指纹分析[27]和虚拟木刻研究[28]中确定局部平均方向的方法,我们采用如下的步骤来确定θ的值.首先求得输入图像的亮度图像I(x,y),然后根据亮度图像来计算某一区域的局部方向.用式(8)表示亮度图像的梯度,其中Gx、Gy分别为对亮度图像使用Sobel算子得到的x和y方向的差分值,用式(9)计算出θ的值.其中这里W为区域内像素的集合.方向亮度变化的情况采用式(12)来确定β的值.我们通过比较x方向亮度变化情况和y3.2乱针绣精绣的交叉针迹参数选择精绣阶段在铺色的基础上根据图像的局部颜色特征寻找合适的针迹,我们通过一个正方形的滑动窗口遍历输入图像,在滑动窗口中寻找交叉针迹,逐步加大针迹的密度.寻找交叉针迹时需要确定交叉针迹的位置和颜色,在滑动窗口中选定某一针迹起点后,需要寻找针迹的终点位置使得针迹经过的路径在原图像中具有相似的颜色,针迹颜色的选择方法与铺色阶段不同,需要综合考虑已绣制的针迹对绣品的覆盖情况和原图像对应像素的颜色,从绣线颜色子集中选择一种颜色使得新针迹的颜色与已绣制针迹的颜色混合,远看时产生与原图像更接近的颜色.(1)交叉针迹位置的选择交叉针迹位置的起点可分别在正方形滑动窗口中左上角和左下角随机选择两个点,在选定起点后针迹经过的路径上的所有点颜色应该相似,具有较小的色差,但如果直接使用梯度一类的特征来确定,在某些区域无法找到合适长度的路径或在相邻区域内找到十分规则的路径.在本文的工作中,我们采用试探法,使用不同的斜率进行试探寻找符合条件的直线.对某一给定斜率,首先计算该直线上的下一个像素点颜色与起点颜色的距离.如果该距离值小于指定的阈值,则认为颜色相似,继续对该直线下一点进行处理;如果该距离值大于指定的阈值则终止处理,判断已找到的线段的长度是否符合要求,如果长度太短则放弃该线段,选择另一斜率值进行试探.当找到的直线段长度超出该阈值时直接返回,以防止在某些颜色变化平缓的区域内产生过长的针迹.试探过程中一个十分重要的参数是颜色距离的阈值,如果该阈值过小则在某些区域可能一直无法找到符合条件的直线段,如果该值过大则会使大量像素点的绣线颜色与输入图像中对应的像素点颜色差异太大影响绣制的效果.根据窗口区域内图像颜色分布的特点,可将其分为3种类型,如图5所示.这3种类型分别具有如下特点:(a)窗口内所有像素的颜色近似,变化平缓;(b)窗口内相邻像素颜色差异较大,但总体色调类似,呈现相似的纹理;(c)窗口位于两个或多个物体交界处,颜色分布范围很大.对于第1种类型,窗口内的像素点可用同一种绣线或两种颜色很接近的绣线来代替,因此只需设置一个很小的阈值即可找到符合条件的直线段.对第2种类型,如果设置一个较小的阈值有可能找到符合条件的直线段,但也有可能会由于相邻像素的颜色存在较大差异而无法找到合适的直线段.为了能够尽量找出颜色变化较小的直线段,我们首先使用一个较小的阈值进行试探,如果找不到符合条件的直线段,则加大阈值重复进行试探,如果阈值超过最大阈值,则终止试探过程.最大阈值可根据该正方形区域内颜色的分布情况来Page7确定.正方形区域内颜色的分布情况可以使用颜色粗糙度的概念来描述[29],粗糙度越大说明该区域颜色变化越剧烈.边长为n的正方形区域颜色粗糙度计算方法如式(13),(14)所示,首先计算该区域内颜色的平均值Cav,这里Cij表示i行j列的颜色向量值,式(14)的S即为颜色粗糙度,其中的D(Cij,Cav)按式(2)的平方值计算.第2种类型的窗口区域内的颜色分布可以用3维单高斯模型来描述,我们可以认为围绕颜色均值点的大部分颜色都是相似的.粗糙度的平方S2为该区域内所有像素颜色到颜色均值点距离平方的均值,对于1维高斯分布类似的计算结果我们可以作为方差的估计值,因此本文借鉴1维高斯分布的3δ原则,根据实验结果将式(2)所定义的距离值平方的最大阈值选定为18S2.对于第3种类型,使用较小的阈值能否寻找到符合条件的直线段,取决于该区域内物体的颜色分布情况及物体的大小.例如图5(c)的例子中左上和右下部分颜色分布较均匀,则在这一部分用较小的距离阈值也能寻找到符合条件的直线段.如果构成该区域的物体颜色差异很大,即使使用一个较大的距离阈值,如第2种类型中计算得到的18S2也无法找到符合条件的直线段.这种类型的窗口,当我们逐步减小窗口尺寸时,将转化为第1种类型或第2种类型,可以用较短的针迹去绣制该区域.根据上面的分析,我们给出了在宽度为iWindowWidth的正方形区域内寻找交叉针迹的算法,其中的flag1、flag2分别表示是否已找到从左上到右下和从左下到右上方向的针迹,每次寻找的针迹最短长度为iWindowWidth,最长不超过iWindowWidth的1.5倍.算法描述如下:1.初始化flag1、flag2为false;2.计算Cav和S2;3.颜色距离阈值=1000;4.在正方形区域的左上角的1/4区域内随机选定一点(startx,starty);5.for(intk=iWindowWidth;k>=0;k--){5.1.判断起点为(startx,starty)斜率为k/iWindow-Width的方向上的像素颜色最相近的绣线颜色是否与起点相同或与起点的颜色距离是否小于颜色距离与值,若是将其作为线段终点,继续循环判断下一像素,当线段长度大于1.5×iWindowWidth或遇到某像素点与起点颜色距离大于颜色距离值时返回已求得的线段终点;5.2.若找到的线段长度大于等于iWindowWidth,将该线段加入针迹表,置flag1=true,在已绣制图像上绘制该线段,退出当前循环,转步7;6.for(intk=iWindowWidth;k>=1;k--){6.1.功能与步5.1相同,直线段斜率改为为iWindow-Width/k;6.2.同步5.2;7.在正方形区域的左下角的1/4区域内随机选定一点(startx,starty);8.for(intk=rand()%iWindowWidth;k>=1;k--){8.1.功能同步5.1,直线段斜率为-k/iWindowWidth;8.2.若找到的线段长度大于等于iWindowWidth,将该线段加入针迹表,置flag2=true,在已绣制图像上绘制该线段,退出当前循环,转步10;9.for(intk=rand()%iWindowWidth;k>=1;k--){9.1.功能同步8.1,直线段斜率为-iWindowWidth/k;9.2.功能同步8.2;10.如果(!flag1&&!flag2)则增加颜色距离阈值;否则,算法终止;11.如果颜色距离阈值大于18S2,算法终止;12.转步4.在窗口内找到符合条件的直线段后,在该直线段的起点或终点在目标图像中对应的区域中随机选取一个未被绣线覆盖的点作为针迹起点或终点.(2)交叉针迹颜色选择由于机器绣制只能使用少量颜色,输入图像中大部分区域的颜色与所选择的颜色子集中的颜色存在色差,如果在一个区域中反复使用同一种颜色的绣线进行绣制,则作品的视觉效果与原图会有很大差异.根据混色原理[10],不同颜色的邻近点远看时混合产生新的颜色,因此,我们通过在邻近点使用前面选择的颜色子集中少量颜色进行混合,远看时产生与原图像更接近的颜色.我们的算法中输入图像中的一个像素在绣品中对应一个正方形区域,采用该正方形区域中各像素点的RGB平均值作为混合产生的新颜色.在选定针迹的起点和终点后,根据直线段起点在目标图像中所对应正方形区域的覆盖情况来确定针迹的颜色.如果该正方形区域已覆盖的像素比例小于20%,直Page8接根据输入图像中对应像素点的颜色选择一个颜色最接近的绣线颜色;如果该正方形区域已覆盖的像素比例大于20%,则按下面的步骤来计算针迹的颜色,其中iScale表示正方形区域的边长:1.求出该正方形区域内所有点的颜色和,未被覆盖的部分求和时用输入图像中对应像素点颜色最相近的绣线颜色替代,记该值为Csum.2.计算输入图像对应点的颜色与Csum的差Cdiff,如式(15)所示,其中Corg为输入图像中对应像素点的颜色.3.根据式(16)计算得到的Crep在绣线集中寻找最相似的颜色作为针迹颜色,其中参数α∈(0,1]为颜色调节因子,用于调节针迹使用的绣线颜色与输入图像中对应像素颜色的相似程度.α取较大值时目标图像远看色彩更接近输入图像;α较小则所选颜色与输入图像中对应像素颜色更接近,但远看时视觉效果不及α取较大值的情况.我们的实验中α取0.5对大部分图像效果较好.4计算机辅助乱针绣制作流程及实验结果分析4.1计算机辅助乱针绣制作流程计算机辅助乱针绣制作的完整过程包含4个大的步骤:绣线颜色子集选择、铺色、精绣和针迹优化.绣线颜色子集选择算法已在第2节描述,这里不再赘述.针迹优化阶段根据针迹的颜色对前面阶段生成的针迹在不改变颜色不同的针迹之间覆盖关系的前提下重新排序,将相同颜色的针迹尽量集中,减少机绣时换色的次数,提高绣制效率.针迹优化目前只是比较简单的按颜色重新排列针迹,算法较为简单,本文不详细介绍.下面主要描述铺色和精绣阶段的完整流程.铺色阶段需要根据第一阶段求出的绣线颜色集进行区域分割,将输入图像划分为若干大的色块,然后进行填充.如果直接根据输入图像的颜色分布进行划分,往往会出现大量面积很小的区域,在分割前对输入图像进行平滑,去除一些细节特征,可以避免这种情况.因此,我们将铺色阶段分为3个步骤:平滑输入图像、分割平滑后的图像、分别填充分割得到的区域.图像的平滑可以采用图像去噪算法来完成,将图像中的一些细节特征看成是噪音,通过去噪算法去除这些细节,保留大色块的轮廓特征.但一些传统的算法在去噪的同时往往会使图像的边缘变得模糊,Rudin、Osher和Fatemi[30]提出了一种基于全变分(TotalVariation,TV)模型的去噪方法,该方法各向异性扩散,能在去噪的同时很好地保持图像的边缘,Chambolle等人[31]研究改进该方法用于图像的复原取得了较好的效果,我们的实验直接使用了Chambolle等人的算法.对平滑后的图像的所有像素点使用第一阶段选出的绣线颜色中最相似的颜色替换,则图像被自动分割成若干区域,最后对每个区域采用选定的颜色采用交叉针迹进行填充.填充前需要确定相关参数,包括每个区域针迹的方向和针迹密度,表示针迹方向的参数θ和β分别由式(9)和(12)确定,针迹的密度可手工设定,如果密度高,则后期加工的余地较小,如果密度过低,则作品需要人工再加工的工作量就会很大,我们采用针迹覆盖目标图像面积的比例来衡量针迹密度.精绣阶段在铺色的基础上根据图像的局部颜色特征寻找合适的针迹,逐步加大针迹的密度.设定一个小的正方形窗口,在输入图像上从左至右从上至下移动该窗口,每次在该窗口内通过试探法寻找左上至右下和左下至右上的直线段使得该直线段上所有像素的颜色差满足指定的条件,然后以找到的直线段结合已有针迹的覆盖情况生成针迹位置,根据3.2节描述的针迹颜色选择算法计算出针迹颜色,试探过程已在第3.2节详细描述.我们将窗口的尺寸及移动的步幅从大到小进行变化,多次遍历输入图像以生成不同长度的针迹,这个过程可以描述如下.的最小阈值;1.设定初始移动窗口尺寸和移动的步幅以及窗口尺寸2.设定当前窗口尺寸允许的最短针迹长度和最长针迹3.对原图像从左至右从上到下,移动窗口,对每一个窗口:3.1.计算已绣制的图像中对应当前窗口的部分已被覆3.2.如果被覆盖的比例大于90%,跳过步3.3和3.4,长度;盖的比例;处理下一窗口;3.3.在窗口左上部选择一点作为起点,采用试探法向右下方向寻找长度在最短针迹长度和最长针迹长度之间且像素颜色相近的直线.如果找到,则根据该直线的起点和终点位置生成一个针迹;3.4.在窗口左下部选择一点作为起点,采用试探法向右上方向寻找长度在最短针迹长度和最长针迹长度之间且像素颜色相近的直线.如果找到,则根据该直线的起点和终点位置生成一个针迹;4.减小窗口尺寸和窗口移动的步幅;Page95.如果窗口尺寸大于预先设定的阈值,转步2;否则算法终止.4.2实验结果及分析根据上面的算法,我们用多幅图像进行了实验,通过针迹模拟显示观察其效果,并选择了部分图像实际进行绣制.实验选用DMC的绣线颜色集,共有454种颜色,种群大小设定为100,交叉概率为0.8,采用精英选保留策略,每次保留上一代的最优解,如果连续100次迭代最优解适应度保持不变,则终止算法,否则当迭代次数超过1000时终止.图6(a)是实验使用的一幅输入图像.首先我们分别使用均匀变异与本文提出的自适应确定变异概率的方法进行绣线颜色子集选择的对比实验.表1为图6(a)采用均匀变异取pm=0.15的10次实验结果的数据,表2为采用改进后的变异方法得到的10次实验结果.比较表1、表2的数据可以发现使用改进的变异算子后:(1)终止迭代的次数增加;(2)最终群体最优个体的适应度值大幅提高.以上两点表明早熟收敛现象得到了一定程度的抑制.图6(a)进行平滑得到图6(b).绣线选择完成后采用Chambolle等人的算法对初始群体最优个体适应度0.0001392860.0001835171680.0001856200.0001253080.0001647833000.0001868440.0001468530.0001787102070.00018723900.0001596350.0001681871830.0001727090.0001303410.0001926671190.0001926670.0001141450.0001711272170.0001797520.0001315020.0001758601080.00017586000.0001366150.0001753311140.0001753310.0001317990.0001781441660.0001925190.0001460790.0001686582180.000198348初始群体最优个体适应度0.0001436360.0001935224790.0002824730.0001772470.0001845214710.0002882680.0001421450.000209374270.0002761450.0001299440.0001838294150.0002824870.0001663070.0001719583270.0002665770.0001386160.0002048794120.0002823510.0001337140.0002264374920.0002830310.0001373050.0001878823830.0002700160.0001331360.0002027023540.0002797340.0001320860.0001758954280.000267907图7是图6(a)中的荷花图iScale为5、覆盖比例为20%的12色铺色结果.iScale取较小值时,算法生成的针迹较短,密度较大,不利于人工进一步加工;iScale较大则生成针迹较长,密度较稀,机器直接生成的绣品视觉效果较差,留给人工更大的空间对作品进行完善.图8为图6(a)作为输入图像,使用12色绣线,Page10滑动窗口大小分别取8、4、2三次遍历输入图像得到的结果.图9为针迹模拟显示的局部,从中可以看出每条针迹的方向和颜色,完整的图像幅面太大,这里不再给出.图10为图6(a)采用6色绣线的绣制现场和绣品照片,我们使用了日本Brother公司生产的PR600II单头6针绣花机,由于实验条件的不足,实际使用的绣线与算法选择的绣线颜色存在一定差异,对绣品的最终效果有一定影响.该绣品的实际尺寸为193.6mm×149.6mm,绣制时间3h20min.由于在针迹生成过程中引入了某些随机因素,因此对同一幅输入图像每次运行结果并不相同图11(a),(b),(c)是对图6(a)三次处理得到的针迹模拟显示图缩放到原图尺寸的图像,总体视觉效果相似,但可以看出实际选用的绣线集不完全相同,存在一定色差.从上面的实验结果可以看出,本文给出的方法可以显著提高乱针绣的制作效率,降低生产成本,但算法还有待进一步改进.5结束语乱针绣是中华民族刺绣艺术的瑰宝,乱针绣计算机辅助技术的研究对这一宝贵的非物质文化遗产的保护具有重要的意义.本文将计算机辅助乱针绣制作技术归结为绣线颜色子集选择和交叉针迹参数计算两大关键技术问题,主要研究成果表现在以下几个方面:(1)由于刺绣机硬件条件的限制,只能使用少量颜色的绣线进行绣制,因此必须根据图像特征从所有可用的绣线颜色中根据刺绣机可以使用的颜色数量选择出一个颜色子集,使得绣品最终的视觉效果与原图像的差别最小.本文通过对标准交叉算子和变异算子的改进实现了基于遗传算法的绣线颜色子集选择.提出了一种根据启发信息自适应确定遗传算法变异概率的方法,将其应用于乱针绣辅助制作过程中关键步骤绣线颜色子集选择,实验证明该方法与传统的均匀变异相比,能够较好地抑制遗传算法的早熟现象,使算法收敛到更优的解.该方法可用于其它采用类似个体编码方式的问题求解,例如k-medoid聚类问题.(2)根据乱针绣工艺的特点,我们将乱针绣针迹生成分为铺色和精绣两个阶段,并根据各自的特点,我们分别提出了一种基于图像亮度梯度的铺色交叉针迹角度及交叉角度算法和一种基于试探法的Page11精绣交叉针迹参数计算方法,并对试探过程中判断颜色相似性的颜色距离阈值的选择进行了讨论,并进而提出了基于混色原理的精绣针迹颜色选择方法,实现了在同一区域只使用少量颜色混合而产生出更接近原图像的颜色,避免了由于机器绣制只能采用少量颜色而造成绣品与原图像产生较大的色差.(3)给出了一个完整的计算机辅助乱针绣流程,并通过实验证明了其可行性:铺色阶段大部分区域交叉针迹方向和夹角方法计算的结果接近人工绣制的习惯,精绣阶段对图像局部颜色分布的3种情况生成的路径基本符合乱针绣工艺要求.由于乱针绣人工工艺十分复杂,计算机辅助乱针绣工作国内外尚未见报道,本文仅完成了开创性探索工作.要进一步改善绣品的效果,需要继续开展以下几个方面的工作:①寻找适合绣线色差计算的色彩空间表示和算法,目前我们采用的RGB色彩空间,虽然计算比较简单,但RGB色彩空间中色彩距离相等的不同颜色在人眼视觉感觉中的差别可能较大.②改进绣线颜色子集选择算法.目前采用的遗传算法,稳定性不够好,随机选择的初始群体对最终结果影响较大.③选择更好的图像特征参数和图像分割方法决定铺色阶段的针迹方向.目前方法决定的针迹方向在某些大区域的局部不能很好地表现原图的纹理方向特征.④寻找合适的图像分解方法,目前细加工阶段采用反复试探法运行效率较低,且在某些区域仍然存在针迹分布不均的情形,影响了绣品的总体视觉效果.致谢本工作得到常州狄静乱针绣工作室狄静老师和常州孙燕云乱针绣艺术创作中心孙燕云老师的悉心指点和热情帮助,在此表示衷心感谢!
