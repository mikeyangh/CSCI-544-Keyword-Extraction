Page1一种新型的虫孔气泡流控实现策略肖灿文张民选(国防科学技术大学计算机学院长沙410073)摘要气泡流控是一种实现环内无死锁路由的高效方法.该方法在超级计算机Bluegene/L中得到了成功应用.然而气泡流控只适用于虚跨步(VCT)切换网络.目前,研究人员提出了一些方法把气泡流控策略应用到虫孔切换的片上网络中.然而这些虫孔气泡流控策略需要复杂的控制信息.文中提出了一种新型的设计方法实现高效、简洁的虫孔气泡流控.首先采用支持非原子缓冲分配的多请求缓冲结构(MRIBO)代替传统的FIFO缓冲结构存储报文.MRIBO支持Flit在不同报文间乱序存储,缓冲区中的每一个Flit能够独立路由.在MRIBO存储方式下,作者设计了一种类似VCT网络的气泡流控,适用于虫孔网络的新型气泡流控策略.证明了在MRIBO方式下,新型流控策略可以保证单向环内的Flit总是可以流动,不会出现死锁,在单向环内实现了无死锁路由.基于斯坦福大学开发的BookSim模拟平台,作者测试了新型虫孔气泡流控策略的性能.通过修改源代码,在BookSim中实现了基于新型虫孔气泡的维序路由算法(WBFC)和完全适应性路由算法(Adapt-BF).作者分别比较了这两种算法和传统的基于子午线(Dateline)的维序路由算法(DOR)以及完全适应性路由算法(Adapt-DL)在不同维度的Torus网络中的报文平均延迟.模拟结果显示:这种新型虫孔气泡流控策略的性能大大优于传统的虫孔切换.其中,8-ary2-cubeTorus网络性能测试中,在uniform通信模式下,Adapt-BF算法的报文延迟相对Adapt-DL算法有近18%的减少.文章通过新型的缓冲组织结构打破了虫孔交换中报文传输的原子性,保证了Flit独立路由,所以就可以在虫孔网络中像VCT网络中处理报文一样处理Flit.在这种情况下,VCT网络中基于局部信息的Bubble流控技术可以几乎不加修改地应用到虫孔网络中.因此,这种方法简化了虫孔气泡流控的实现.关键词虫孔气泡流控;多请求缓冲结构;非原子缓冲分配;虫孔切换;死锁避免1引言互连网络是当代并行计算机系统的关键组成部分.从高端的超级计算机系统和大规模的数据中心到片上多处理器系统,互连网络连接各个处理器和存储部件,决定了远程存储访问的带宽和延迟,极大地影响整个系统的性能和费用.随着处理器和存储器的性能不断提高,为了实现高能效和高性价比的计算机系统,互连网络的重要性越来越凸显.Torus网络对于片间互连和片上互连都是一种常用的互连网络拓扑结构.Torus网络的环线(Wraparoundlink)提高了网络带宽,减少了网络的平均跳步数.同时,Torus网络规整的结构有助于均衡网络的利用率.另一方面,Torus网络的环线也增加了路由死锁的可能性.如何解决路由死锁是互连网络设计的一个关键问题.处理不好将会给互连网络乃至整个计算机系统性能带来灾难性后果.处理死锁的典型技术包括死锁阻止、死锁恢复和死锁避免.死锁阻止策略要求在报文注入前,先预留需要的资源,这将导致资源使用很低效.死锁恢复策略允许临时出现死锁,一旦检测到死锁就通过重新分配资源来解除死锁.这种策略需要在网络中建立超时机制并依赖于精确的死锁检测机制检测网络是否存在死锁,然而由于过于复杂在实际系统中并不实用.在死锁避免策略中,网络中的报文按照一定策略动态地请求资源,避免死锁.死锁避免策略既解决了死锁阻止策略资源利用率低的问题,也避免了死锁恢复策略的复杂,因此更实用.当前实现适应性路由算法的互连网络系统解决死锁方法主要采用Duato在20世纪90年代建立的死锁理论[1-3].Duato方法采用严谨的形式化方法针对不同切换策略,证明了路由无死锁的充分和必要条件,为Duato方法提供了强大的理论基础,这是Duato方法流行的一个重要原因.采用Duato方法实现完全适应性路由策略的互连网络中,通常需要在一个虚通道上采用无环的路由算法确保实现无死锁的路由,网络中这个虚通道作为在其他虚通道上采用完全自适应路由的报文的逃逸通道.Duato方法提供网络设计者通过路由函数实现网络路由死锁避免,许多研究人员探索采用其他方法来解决网络路由死锁问题.一个有意义的思想就是从流控的角度出发.网络流控策略确定由路由函数决定的候选通道是否可用.其中,气泡流控(Bubbleflowcontrol)[4-6]就是一个杰出的工作成果.气泡流控的思想可以简单描述为:在网络一个维度的环中,只要存在一个可用的缓冲空间(气泡),那么这个环内的报文就是可以移动的,路由不会死锁.IBM公司著名的BlueGene[7]系列巨型机采用Duato方法实现了完全适应性路由策略.该机器在路由算法的Page3逃逸通道中采用气泡流控策略,使得适应性路由算法对虚信道的需要由传统基于Dateline方法[8]需要最少3个减少为2个.气泡流控策略是一种解决互连网络中,环内死锁的高效方法.气泡流控策略在BlueGene系列巨型机中的成功应用,激发了人们对该流控策略的扩展研究.其中,文献[9-10]提出了虫孔气泡流控策略,发展了传统的气泡流控理论,把适用于报文切换的气泡流控扩展到了虫孔切换网络,促进了NOC的研究.文献[10]提出实现虫孔气泡流控策略的充分条件:当一个报文注入单向环后,单向环内至少还有一个空闲的虫孔气泡(WB,最少为1个微片(Flit)).这个充分条件可以理解为:报文注入单向环后,只要有一个空闲空间(虫孔气泡),环内报文就可以流动.然而,当报文注入到环内需要很复杂的控制过程.如图1所示:为了保证资源的原子分配[11](当一个报文的头进入一个缓冲队列后,必须等这个报文的尾Flit离开缓冲队列后,其他报文才能进入该缓冲队列),报文P1和P2不能同时注入单向环,并图1报文等待注入单向环本文第2节介绍新型虫孔气泡流控策略;第3节理论分析新型流控策略在环内的无死锁特性;第4节评估新型流控策略的性能;最后,在第5节对全文进行总结.2新型虫孔气泡流控策略本节中,我们基于多请求输入缓冲结构,设计实现新型的虫孔气泡流控策略.2.1多请求输入缓冲结构在文献[12]中,提出了一种称为多请求输入缓冲区组织(MRIBO)的新型缓冲结构.该缓冲区组织如图2所示.如图2中,当一个报文进入缓冲区时,单独采用且要获取整个单向环内空闲缓冲大小的全局信息,当环内空闲的Flit数大于报文的Flit数时,报文才能注入.即使在报文的尾Flit进入缓冲区后,允许其他报文进入缓冲区的情况下(文献[10]中的非原子缓冲区分配方法),也要遵循相同的规则.这个复杂的控制过程大大限制了虫孔气泡流控的应用.这里产生一个问题:如果我们对缓冲资源采用新的组织策略,实现更宽松的非原子分配方法,是否可以简化虫孔气泡流控的实现?本文沿着这个思路,基于文献[12]提出的允许交叉存储的多请求缓冲结构,研究一种新型虫孔气泡流控的实现策略.文章的主要贡献如下:(1)基于多请求缓冲结构,设计新型的虫孔气泡流控.(2)理论证明新型虫孔气泡流控策略能保证环内无死锁.(3)基于BookSim模拟工具,分析比较了新型虫孔气泡流控的性能.实验表明:新的流控策略结合适应性路由算法相对于传统方法的性能较好.Page4寄存器保存报文路由信息,这样每个报文都可以提出仲裁申请.具体每次允许输入端口最多的仲裁请求数,可以根据实际设计的需求来确定.但只要保证每个报文都可能提交仲裁请求,即使每次只允许端口提出一个仲裁请求(报文之间采用轮转如:round-robbin来保证每个报文机会均等),在输入端口也不存在头阻塞(HeadOfLine,HOL)现象.缓冲区采用类似链表方式存储报文.即存储报文Flit的存储单元也保存报文下一个Flit的存储地址(当下一个Flit进入,并分配了存储地址),直到报文尾Flit.另外,为了支持不同报文的微片穿插进入缓冲区,每个微片带一个标示,以确定该微片所属的报文.这种新型的缓冲结构支持报文的微片交叉存储,并保证缓冲区中的每个报文都有仲裁申请的机这种气泡流控策略需要获得环内空闲空间的全局信息,实际系统中,采用图4所示的气泡流控策略.图3基于报文切换的气泡流控如图4所示,当前报文只要获得邻居结点的缓冲信息,就可以决定是否可以流入下一级.而邻居结点间的缓冲区空闲报文空间信息,可以通过常用的信用流控(Credit-basedFlowControl)获得.基于局部信息的Bubble流控策略,相对需要全局信息的气泡流控,控制简单易于工程实现.BlueGene系统就采用了这种策略.图4中的基于局部信息的Bubble流控策略适用于报文切换网络.我们把这种思路应用于虫孔切换网络可以设计如图5所示的基于局部信息的流控策略.图5描述的流控策略类似图4,该策略应用在虫孔切换网络中,是一个基于局部信息的流控策略.会,消除了HOL阻塞现象.多请求输入缓冲组织结构下,在一个报文的尾还没有进入缓冲区之前,其他报文可以进入缓冲区.并且,在一个报文的尾流出之前,允许其他报文流出.因此,这种缓冲组织结构支持非原子分配.下面,我们基于多请求输入缓冲结构,针对虫孔切换方式,设计气泡流控策略.2.2虫孔流控策略传统的气泡流控(BubbleFlowControl,BFC)策略适用于报文切换网络.图3描述了报文注入单向环的状态.按照BFC,当单向环内至少有2个空闲报文空间时,报文可以注入.在图3中有2个空闲报文空间,因此报文P可以注入.并且注入后,环内还有1个空闲报文空间(气泡)保证了环内报文的流动.而其他准备注入单向环的报文需要等待环内至少有2个空闲报文空间,才能注入.首先,当Flit当前路由维度与下一步路由维度相同时,若下一级缓冲区至少有1个Flit空闲空间,那么在这个维度环内肯定至少有1个Flit空闲空间,因此,环内的Flit可以流动.所以当前Flit可以流入下一步缓冲区.对于当前维度与下一步维度不同或当前处于注入缓冲区的Flit,如果下一步缓冲区只有1个Flit空闲空间,Flit不能流入下一步的缓冲区.这是因为倘若下一步缓冲区所在的维度刚好只有1个Flit空闲空间,一旦当前Flit流入,整个维度环内不再有空闲空间(气泡),环内的Flit无法流动,这样可能导致死锁.因此对于这种情况,下一步缓冲区至少要2个Flit空闲空间.我们知道,对于原子分配,2个Flit空闲空间也不能保证报文Flit能够流入.这是因为基于邻居缓冲区空闲空间信息,只能获得下一步缓冲区信息,不能得到整个环的空闲空间信息.若下一Page5步缓冲区的空闲空间小于准备流入报文的Flit数目,该报文不能流入.否则无法保证存储分配的原子性.由于多请求输入缓冲区组织结构实现了交叉存储和非原子分配,我们可以重新考虑基于局部信息的虫孔气泡流控策略.在多请求输入缓冲区组织结构中,除了用于缓冲Flit的缓冲空间外,还有用于保存路由信息的寄存器资源.当Flit流入时,需要同时考虑这两种资源的分配.我们设存储路由信息的寄存器数目与缓冲区可容纳的Flit数目相等.同时,把缓冲区中1个Flit空间和1个保存路由信息的寄存器捆绑在一起,称为1个缓冲资源.另外,每个Flit携带报文标示和目标结点号,网络采用分布路由方式.这样,缓冲区组织不再需要链表.多请求输入缓冲组织结构下的气泡流控策略如图6所示.图6所示的虫孔气泡流控策略类似图5描述的流控策略,不需要全局的缓冲空闲空间信息.相对于文献[10]的虫孔气泡流控策略,新型的流控策略具图7基于多请求输入缓冲区的单向环由于单向环内不会生成新的Flit,单向环内的Flit都是由外部注入.那么单向环内最多有多少Flit?从新型虫孔气泡流控策略可知:1个Flit注入环内,必须满足缓冲区至少有2个空闲存储资源.可以设想,当最后1个Flit注入环内后,对应缓冲区至少还有一个空闲资源.在其他缓冲区都充满的情况下,环内最大的Flit数目为m×n-1,而环内缓冲资源为m×n,因此环内至少有1个空闲的缓冲资源.存在1个空闲的缓冲资源的情况下,新的Flit不可能注入环内.按照新型虫孔气泡流控策略,这个空闲的缓冲资源可以保证环内的Flit流动,不会出现死锁.并且,准备注入该环的Flit必须等待在下一级缓冲区中至少出现2个空闲资源才能注入.因此,新型有以下特点:(1)只需获得邻居结点的缓冲空闲空间信息就可以决定报文的Flit是否可以流入下一级,不需要全局信息,因此流控策略的控制逻辑相对文献[10]的方法更简单.(2)缓冲空间支持交叉存储,采用非原子分配,支持多个Flit同时注入单向环内因此提高了网络通信性能.(3)需要额外为流入的每个Flit增加记录路由和识别信息的寄存器,增加了缓冲区的硬件开销.另外,为了支持报文乱序到达,因此在目标点需要重新排序.另外,在片上网络中,由于单个Flit的报文比例较大,例如在PARSEC[13]测试集中,单个Flit的报文所占的比例达到78.7%[14].因此,我们这种基于Flit组织缓冲资源的方法是有意义的.3环内无死锁性证明本节我们证明基于多请求输入缓冲区组织结构的新型虫孔气泡流控策略保证数据在单向环内流动无死锁.设单向环内有n个结点,如图7所示.每个结点在环上的端口缓冲区大小为m个存储资源,每个存储资源包括1个Flit存储空间和1个存储路由信息的寄存器.虫孔气泡流控策略可以保证单向环的信息流动,不会出现死锁.4实验数据及分析在这部分,我们基于Stanford大学开发的网络模拟工具BookSim[15-16]研究新型虫孔气泡流控的性能.通过修改源代码,我们在BookSim中实现了基于新型虫孔气泡的维序路由算法(WBFC)和完全适应性路由算法(Adapt-BF).我们分别比较了这两种算法和传统的基于子午线(Dateline)的维序路由算法(DOR)以及完全适应性路由算法(Adapt-DL)在不同维度的Torus网络中的报文平均延迟.Page64.1实验建立模拟测试中,我们采用不同维度的Torus互连拓扑结构测试路由算法的平均报文延迟.实验中,为了保证相对的公平性,我们对每个路由算法所设置的虚信道数目以及缓冲Flit数目都保持一致.模拟设置如表1所示.报文大小设置为4、6或12个Flit.拓扑结构(Torus)表1BookSim参数设置结点Flit注入率0.1~0.654.22D-Torus网络的平均延迟图8~图12描述了4-ary2-cubeTorus网络采用4种路由策略,在不同通信模式下,网络中报文的我们设置在路由器中,信用处理的延迟为2个周期;通道延迟、开关分配以及虚信道分配和开关处理的延迟都是1个周期.另外,BookSim模拟器的warmedup时间是10000个周期,性能测试在warmedup后的100000个周期中进行.当报文延迟大于1000个周期时,认为网络不稳定,不再继续测试.平均延迟.图中横轴表示网络结点1个周期注入1个Flit的概率,单位是%.纵轴表示网络中报文的平均延迟,单位是周期数(cycle).在图8~图12中,由于WBFC算法在注入率为23%内就达到了饱和带宽,再提高注入率,对比较算法性能已没有意义,因此,只模拟测试了注入率为23%内的算法性能.图8~图12显示:在所有的通信模式下,适应性路由算法Adapt-BF和Adapt-DL的平均报文延迟都比确定性路由算法WBFC和DOR小.不同通信模式下,算法达到饱和带宽的情况各异.例如:在bitcomp通信模式下,WBFC在注入率达到23%时,Page7网络达到饱和带宽;而在bitrev模式下,WBFC在注入率达到20%时,网络达到饱和带宽.另外,也发现WBFC算法在这4种路由算法中性能最差.而对于4-ary2-cubeTorus网络,在注入率不超过23%的情况下,算法Adapt-BF和Adapt-DL的报文平均延迟在各种通信模式下差别不大.图13~图17描述了8-ary2-cubeTorus网络采用4种路由策略,在不同通信模式下的报文平均延迟.图13~图17也显示出:适应性路由算法Adapt-BF和Adapt-DL的平均报文延迟在各种通信模式下都比确定性路由算法WBFC和DOR的小,并且对于WBFC和DOR算法,在注入率很小时,网络就达到了饱和带宽.例如:在bitrev和shuffle模式下,当注入率为10%时,算法WBFC和DOR就达到了饱和带宽.这表明随着网络结点数目的增加,算法WBFC和DOR的性能迅速恶化,算法的可扩展性不好.另外,实验数据也表明WBFC算法在实验采用的5种通信模式下,在这4种路由算法中性能最差.相对4-ary2-cubeTorus网络不同的是,对于一些通信模式,在8-ary2-cubeTorus网络中,两种适应性路由算法的性能有了明显区别.其中,Adapt-BF算法的性能更好.例如在shuffle通信模式下,当注入率为22%时,Adapt-DL算法的报文平均延迟已达到400周期,而Adapt-BF算法的报文平均延迟为23.6周期.4.33D-Torus网络中的平均延迟由于两种确定性路由算法的性能较差,对于3D-Torus和4D-Torus网络,我们只比较适应性路由算法Adapt-BF和Adapt-DL的性能.图18描述了4-ary3-cubeTorus网络采用两种路由策略,在不同通信模式下,报文的平均延迟.图18中,bc代表bitcomp;br代表bitrev;sf代表shuffle;tp代表transpose;uf代表uniform.例如Page8Adapt-DL-bc表示在bitcomp通信模式下,Adapt-DL算法的性能.其他情况类似.图18显示:两种路由算法的性能差别不大.其中,对于bitrev通信模式,Adapt-DL算法的报文平均延迟比Adapt-BF小.而在其他4种通信模式下,Adapt-BF的性能好于Adapt-DL算法.图19描述了8-ary3-cubeTorus网络采用两种路由策略,在不同通信模式下(由于transpose通信模式不适用8-ary3-cube网络,因此不包括transpose通信模式),报文的平均延迟.图19显示:对于bitrev通信模式,Adapt-DL算法的性能稍微优于Adapt-BF.而对于其他4种通信模式,Adapt-BF的性能明显好于Adapt-DL算法.4.44D-Torus网络中的平均延迟图20描述4-ary4-cubeTorus网络采用两种路由策略,在不同通信模式下,报文的平均延迟.图20显示:在注入率不超过50%的情况下,两种路由算法的性能差别不大.其中,对于bitrev通信模式,Adapt-DL算法的性能优于Adapt-BF.而在其他4种通信模式下,Adapt-BF的性能好于Adapt-DL算法.例如在bitcomp通信模式下,注入率不超过50%,Adapt-BF的报文平均延迟曲线保持平滑缓慢增长,远远优于Adapt-DL算法.4.5缓冲区大小的影响输入缓冲区的大小直接影响路由算法的性能.图21描述对于4-ary4-cubeTorus网络采用两种路由策略,在网络性能相对较差的通信模式bitrev下,不同缓冲大小下,报文的平均延迟.图21中,Adapt-BF-4vc表示在缓冲区为4VC情况下,Adapt-BF算法的报文平均延迟;同样地,Adapt-BF-6vc表示在缓冲区为6VC情况下,Adapt-BF算法的报文平均延迟;Adapt-BF-8vc表示在缓冲区为8VC情况下,Adapt-BF算法的报文平均延迟.对于Adapt-DL算法采用相同的表示方法.从图21中,可以观察到:当注入率小于50%时,两个算法在不同缓冲区下的平均报文延迟差别不大.同时注意到,对于Adapt-DL算法,缓冲区为4VC和6VC时,当注入率达到50%时,网络达到了饱和带宽;而缓冲区为8VC时,当注入率达到60%时,网络达到饱和带宽.对于Adapt-BF算法,缓冲区为4VC时,当注入率达到58%时,网络达到了饱和带宽;缓冲区为6VC时,当注入率达到62%时,网络达到了饱和带宽;缓冲区为8VC时,当注入率达到65%时,网络达到了饱和带宽.测试数据表明:随着输入缓冲区的Page9增大,算法Adapt-BF和Adapt-DL的网络带宽都有所提高,而算法Adapt-BF的网络带宽提高更突出.4.6实验分析实验测试中,网络都采用虫孔切换策略,我们采用3种报文长度:4Flit,6Flit和12Flit报文分别进行了测试.获得的模拟测试结果类似.在二维Torus网络中,针对不同的网络规模,在uniform等五种合成通信模式下,分别测试了基于新型虫孔气泡的维序路由算法(WBFC)和完全适应性路由算法(Adapt-BF)以及传统的基于子午线(Dateline)的维序路由算法(DOR)和完全适应性路由算法(Adapt-DL)的性能.实验数据表明:基于新型虫孔气泡流控策略的确定性路由算法,性能比基于传统子午线的维序路由算法的性能差.这是由于气泡流控策略对准备注入环的报文相对环内流动报文要求更多的缓冲空间,因此潜在地会造成网络报文的饿死现象[5],导致网络中一些报文长时间等待,无法到达目标结点.这是算法性能差的主要原因.另一方面,在测试中,我们观察到两个适应性路由算法都比两个确定性路由算法的性能好.这是由于适应性路由算法相对确定性路由算法为报文提供了更多的路由选择,均衡了网络流量.同时,无论是在二维Torus网络,还是更高维的三维Torus网络以及四维Torus网络性能测试中,基于新型虫孔气泡的完全适应性路由算法(Adapt-BF)相对算法Adapt-DL的性能更好.这是因为当新型虫孔气泡流控策略结合完全适应性路由算法,报文的下一步路由具有多条路径可选择的特性,从而消除了气泡流控策略可能导致的饿死现象,提升了路由算法性能.另外,对于基于子午线的完全适应性路由算法,由于在网络的逃逸通道中,在任一方向上只能使用一半的缓冲资源.而基于新型虫孔气泡流控策略的完全适应性路由算法可以使用所有的资源.因此,我们从实验中可以看出:对于不同维度的Torus网络,当网络的k值较大(结点数较多),网络中单向环内报文较多时,Adapt-BF算法的性能突出.同样地,当增加输入缓冲空间时,Adapt-BF算法的性能相对Adapt-DL的性能改善更明显.5总结本文基于多请求输入缓冲区组织结构,我们设计实现了新型虫孔气泡流控策略;证明了这种策略保证了环内数据流动的无死锁特性.基于BookSim网络模拟平台,我们测试分析了新型虫孔气泡流控策略的性能.实验数据表明:基于新型虫孔气泡流控策略的完全适应性路由算法在k值较大的Torus网络中性能比传统基于Dateline的适应性路由算法性能优异.后续工作中,我们将研究基于新型虫孔气泡流控的路由器微体系结构.
