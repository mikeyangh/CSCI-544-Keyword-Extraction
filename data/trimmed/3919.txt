Page1工作模式可配置的路由器共享转发引擎陈文龙1)蒋佰亨2)吴敏华1)1)(首都师范大学信息工程学院北京100048)2)(吉林大学计算机科学与技术学院长春130021)摘要互联网高速发展中的多种应用诉求,希望路由系统能提供一种工作模式可配置的转发引擎.然而,现有高性能分布式路由系统中线卡独享固定转发引擎的结构,限制了转发体系的灵活扩展.提出了转发引擎与线卡分离的新型路由器体系结构,形成共享的、可扩展的转发单元群.继而,设计了工作模式可配置的共享转发引擎FERM(ForwardingEnginewithReconfigurableMode),并基于FERM提出了负载均衡、带宽约束和绿色节能等3种不同的转发工作模式.最后,给出了面向新型转发引擎的路由系统实现方法,并通过模拟实验分析验证了其优越性.关键词可配置;转发单元;负载均衡;带宽约束;绿色节能;路由器1引言互联网规模的迅速扩张,已导致全球路由信息增长至433k①,这就需要互联网中核心路由器耗费大量的存储资源和处理资源.现有高端路由系统转发引擎主要采用TCAM专用芯片进行转发表的存储及前缀匹配,而TCAM芯片成本较高、价格昂贵,并且消耗大量电力资源[1-2].另一方面,全球范围的节能减排行动要求各种电器设备减少电能消耗,绿Page2色节能型路由系统成为设备厂商及学术界共同关注的技术问题.此外,互联网新型应用及运营模式都期望路由系统能提供对数据流量的区分服务.互联网的多种功能诉求,需要路由系统提供一种工作模式可灵活配置的转发结构.然而,典型的高性能核心路由器基于分布式结构实施,每一块线卡都配有单独的转发引擎,转发表需要在每块线卡中进行冗余存储.路由系统这种线卡独享转发引擎的结构,不仅加剧了设备的能耗及硬件成本问题,还禁锢了路由系统转发体系的灵活扩展.基于能根据运营需求进行转发模式灵活配置的诉求,本文提出了新型SFU(SharedForwardingUnit)转发单元共享结构,将转发引擎从线卡中分离出来,形成若干共享的、可扩展的转发单元群.SFU结构中的转发单元具有功能简单、工作独立的特点.基于此结构,设计了工作模式可灵活配置的转发引擎FERM(ForwardingEnginewithReconfigurableMode).路由系统可根据运营需求对转发引擎进行模式配置,各种转发模式都以5元组形式完成具体转发处理,并确保不同模式具有一致的API接口.FERM转发引擎的核心思想包括3个方面:(1)路由系统可根据需求进行线卡及转发单元配置,提供重构的转发模式;(2)系统可根据负载流量对转发单元实时热开启/热关闭;(3)转发引擎面向不同工作模式的具体转发事务可重构复用.本文的FERM转发引擎提供了基本的共享式转发模式,并以其为基础实现了带宽约束和绿色节能两种扩展模式.本文的主要贡献包括:(1)将核心转发模块从线卡中分离,形成独立工作的转发单元,构建共享式转发单元群,为转发模式可配置提供了结构基础;(2)提出了工作模式可灵活配置的转发引擎FERM,能针对不同目标提供重构的转发模式;(3)基于FERM体系,设计了面向负载均衡、带宽约束、绿色节能等3种转发模式的实现方法.本文第2节介绍相关研究工作;第3节介绍工作模式可灵活配置的共享转发引擎FERM以及基本的负载均衡工作模式;第4节介绍两种扩展工作模式:带宽约束模式和绿色节能模式;第5节介绍FERM转发引擎如何在路由系统的实施方法;第6节进行实验及结果分析;第7节总结全文.2相关研究针对分布式路由系统,业界普遍采用线卡独立转发引擎结构[3].一般由主控卡集中计算出整个可重构路由器的核心路由表,进而通过主动广播更新方式同步所有线卡的路由表,每块线卡都存储转发表的完全镜像.路由系统接收的外部流量,必定在入线卡完成前缀匹配、确定下一跳路由器等核心转发流程.该结构中,每块线卡都配备相同的转发模块,与线卡的处理流量大小无关,这就容易造成线卡间转发负载的极度失衡以及转发资源的严重浪费.近年来,学者对路由器转发引擎进行了多方位的研究,包括降低功耗、降低转发表存储开销、提供流量区分服务等.文献[2]指出路由器60%的功耗来自于转发引擎,因此有效降低路由器功耗的关键是降低转发引擎的功耗.同时文献[4]提出高能耗带来的两个问题:(1)高能耗会消耗较多电能,增加使用成本;(2)热量集中,散热成为难题,需要采用较多的散热设备,影响内部结构和布局,增加制造成本.此外,文献[5]提出了在TCAM中分块处理的思想来减少能耗,通过激活少量的TCAM模块,可以大幅降低不必要的能耗开销.在路由存储方面,文献[2]预测,到2050年核心路由器中路由表项可增长至10M.因此,转发引擎的路由存储能力将面临极大的考验.文献[6]提出了一个新型路由器转发模型,并通过实验分析得出:一个支持5M路由前缀存储的转发引擎,在160Gbps的转发速度时,所需的能耗花销为256美元.此外,新型芯片的设计代价每2年提升1.5倍.因此,小空间转发项存储算法可节约路由交换设备资源,降低设计成本.文献[1]给出的DSF模型,可以根据IP前缀的若干bit位实现线卡对转发表的分解存储,并只带来极少的冗余存储,从而降低路由存储开销.针对转发流量的区分服务,目前业界主要采用资源预留协议[7]为网络上的数据传输预定传输资源和保证服务质量.文献[8]针对报文转发的区分服务,给出了一种基于专用高性能分组转发引擎的QoS实现方法.另外,可重构技术使同一器件支持多类型服务成为可能.Lee等人在文献[9]中提出了路由系统功能重构的概念,指出路由器功能的动态可重构能够提高运营网络的性能,具有更好的适应性.3模式可配置的共享转发引擎现有分布式路由系统中,每块线卡都配置有独享的转发引擎,这种结构限制了系统对转发引擎的Page3灵活控制.FERM转发引擎的结构基础就是将转发引擎从线卡分离,构成若干具有独立转发功能的转发单元.分布式路由系统中,转发单元群为所有线卡服务,实现转发资源的共享.定义1(转发单元FU).可按照最长前缀匹配等规则,独立完成转发表查询,并根据查询结果将报文发送至指定出线卡的功能模块,称之为转发单元,记为FU(ForwardingUnit).转发单元与现有线卡上的转发引擎设计相似,通过TCAM专用芯片存储IP前缀进行多条目并行最长前缀匹配.静态随机存储器(SRAM)配合TCAM查找,存储匹配结果信息,如出线卡、出接口、下一跳等.另外,利用FPGA实现IP报头检查等其它处理逻辑.转发单元工作过程简单,包括3个步骤:从线卡接收报文、查找转发表、根据匹配结果将报文送至目的线卡.可配置共享转发引擎基于图1所示的功能结构实施,称为SFU,具有如下功能特点:(1)转发表查询功能完全从线卡中分离出来,由转发单元完成;(2)路由器形成瘦线卡模式,线卡功能极为简单,功能集中于外部接口的报文收发,从而使得线卡极易进行功能扩展及不同类型的外部接口更换;(3)转发单元功能高度聚合,独立完成转发表查找功能,并根据查找结果将报文转交给目的线卡.基于图1的路由器结构提出了工作模式可灵活配置的转发引擎FERM.该转发引擎中,系统可根据不同运营需求,由主控、线卡和转发单元协同工作,构建面向不同目标的转发模式.FERM转发结构定义为FERM=〈MO,IN,ST,FP,FM〉,各符号描述如下.(1)MO(Mode,运行模式),是转发引擎某种运行模式的抽象描述,如负载均衡、绿色节能等模式,可用脚本语言描述,路由系统解释脚本描述并确定转发引擎运行模式.(2)IN(Initialization,初始设置),针对转发引擎特定运行模式的初始配置管理,包括:管理员在特定工作模式下的参数配置,无需管理员干涉的系统设置,如定时器启动或参数值指定等.(3)ST(State,状态管理及调度),指定转发模式需关心的系统资源状态,扩展的转发模式需要根据系统实时运行状态进行资源调配,如转发单元转发报文负荷、FIB表容量等.另外,FERM需要实时调控共享转发引擎状态,如转发单元负载策略调整、转发单元开启及关闭等.(4)FP(ForwardingProcess,转发实施),指线卡的报文转发处理,FERM模型中主要工作是为当前报文选择转发单元,同时调整相关状态信息.(5)FM(FibMaintenance,表项维护),负责分布式系统多个转发单元转发表项存储的一致性.不同的重构实例不影响表项维护API接口形式上的一致性.如图2所示,FERM根据不同的运行模式MO,实施不同的IN、ST、FP、FM等相关事务,并且确保不同运行模式总是提供一致的API接口.FERM转发引擎中,路由系统可根据运营需求提供不同的转发模式,并且使转发事务最大粒度的重构复用.现有分布式路由系统中,线卡与转发引擎强制绑定,线卡转发引擎的负载完全与线卡外部接口的接收流量对应.可见,分布式路由系统实际工作时,经常发生转发引擎负载严重不均衡的现象,限制了整个系统的报文转发处理能力.FERM转发引擎的基本运行模式是负载均衡(LoadBalanceMode,LBM),系统共享转发单元群,保证多个转发单元均摊所有线卡的报文转发负载,从而提升系统的整体转发能力.负载均衡模式中,转发单元调配高效简单,对于任一线卡第i个待转发报文,交由第j个转发单元处理,满足j=imodn.令系统有n个转发单元,每个转发单元的最大转发能力均等,都为Bm,则系统最大转发能力为n×Bm.传统转发模型中,同样有n个线卡且每线卡的转发能力也为Bm,但只有Page4Nu个线卡连有外部链路,Nu<n.此时,系统最大转发能力只有Nu×Bm.显然,负载均衡模式将大大提升系统的转发能力.工作在LBM模式下的路由系统,基于对报文大小带来的极小负载差异的忽略,则所有转发单元的报文转发负载量,在任何时候都基本等同.同时,任一线卡的转发负载,都大致均摊在所有转发单元上.当然,可以基于LBM实施以源、目的IP地址的分流策略,确保报文按序转发,此部分本文不作深入分析.LBM负载均衡模式中各事务描述如下:(1)IN1.主控及线卡中相关参数初始化,包括2个事务.IN1.1,主控读取转发单元数n,当前工作转发单元数k=n,并通告各线卡;IN1.2,各线卡当前转发单元序号初始为Ncur=1.(2)FP1.线卡总是选择Ncur号转发单元为当前报文实施转发处理,并调整Ncur的值,包括1个事务.FP1.1,线卡将当前报文传递给第Ncur号转发单元处理,并有Ncur=(Ncur+1)modk.(3)FM1.由于采用全冗余备份的转发表存储机制,转发项增加和删除需针对每一个转发单元完成,具体算法不是本文的研究重点,可参见文献[10],包括1个事务.FM1.1,主控增加/删除一条转发项,并通告系统所有转发单元增加/删除对应表项.4扩展转发模式FERM中,分布式路由器中所有待转发流量可共享系统的转发资源.除了基本的转发单元分摊负载模式,本文还设计了两种扩展转发模式:带宽约束模式和绿色节能模式.4.1带宽约束模式定义2(报文图PM).对于符合某种规则的报文集合称之为报文图(PacketsbasedMap,PM),报文图的匹配规则可以是IP地址、报文大小、协议类型等等.定义3(默认报文图PM0).对于没有明确进行带宽约束指定的普通报文集合,被称为默认报文图.带宽约束模式(BandwidthRestrictionMode,BRM)确保转发引擎对于符合某些规则的重要数据分组,提供高级别的转发服务.同时,也可对某些低质量的数据或垃圾数据,进行带宽限制.本文以报文图描述报文集合.工作在BRM模式下的转发引擎配i=1置多个约束服务规则,为不同报文图提供转发带宽约束.带宽约束规则表示为〈PM,Ω〉,其中Ω为约束带宽值,不同的报文图可指定不同的约束带宽值.假设路由系统配置有m个带宽约束规则〈PMi,Ωi〉,1im.对于整个路由系统特定的转发能力,默认报文图的带宽约束可根据上述规则计算而得.BRM模式的实施思想继承负载均衡策略的均摊原则.令系统有n个转发单元,对于某一约束规则〈PMi,Ωi〉,系统将报文图PMi的约束带宽Ωi平均分配到n个转发单元上,每个转发单元针对报文图PMi提供约束转发带宽Ωi/n.所以,对于所有指定的转发带宽约束,每个转发单元约束带宽总和BI满足BI=∑mΩ()in.接着,可计算每个转发单元默认报文图∑mPM0享有带宽为Ω0=Bm-BI=Bm-∑m带宽约束模式根据精确程度要求,以时间段Δt1为单位进行带宽约束控制.对于某一约束规则〈PMi,Ωi〉,Δt1时间内所有匹配PMi规则的转发报文带宽不超过(Δt1×Ωi),超过约束带宽的报文将被丢弃.FERM中,带宽约束直接在线卡中实施.所以,系统应在比Δt1更小的时间粒度下统计:针对不同报文图的实际耗用带宽,并实时通知各线卡.令Φi为Δt1时间内系统针对报文图PMi的实际耗用带宽,满足Φi(Δt1×Ωi).基于FERM转发引擎,带宽约束模式中各转发事务描述如下.(1)IN2.包括3个事务.IN2.1,主控读取转发单元数n,当前工作转发单元数k=n,并通告各线卡;IN2.2,各线卡为每个报文图(包括默认报文图)设置“当前转发单元序号Ncur(i)”,并初始为Ncur(i)=1;IN2.3,各线卡启动循环超时定时器TM1,超时时间为Δt1.(2)ST2.线卡定时器TM1超时触发1个事务.ST2.1,对上一时间段统计的实际耗用带宽Φi清零,对当前转发单元序号重新赋值:Ncur(i)=1,0im,对于默认报文图的处理也包含其中.(3)FP2.线卡根据报文图将待转发报文交付给不同转发单元,主要是分析实际耗用带宽和指定带宽,以此为据实施转发处理,包括1个事务.FP2.1,线卡对转发报文进行报文图匹配,匹配结果为PMi,获取对应的Φi和Ωi.若满足Φi<(Δt1×Ωi),将报文传递给第Ncur(i)号转发单元,并Ncur(i)=(Ncur(i)+1)modk;否则,丢弃报文.Page5(4)FM2.一个事务FM2.1,它与FM1.1相同.4.2节能模式节能模式(PowerSavingMode,PSM)的主要思想是:用尽量少的转发单元完成数据报文的正常转发,并关闭多余的转发单元以节省电能消耗.FERM对路由系统的转发带宽进行实时监控,预判后续转发负载,并通过开启或关闭转发单元保证以最经济的代价完成报文转发.节能模式以负载均衡模式为基础进行实施.令当前设备状态共有k个转发单元正在工作,0<kn,则k个转发单元的负载能力为(k×Bm),k个转发单元的实际负载为∑k定义两个百分比阈值:关闭阈值λoff和开启阈值λon.规则1.若路由系统当前实际负载小于(k-1)个转发单元转发能力的关闭阈值带宽,则应关闭1个转发单元.即当系统转发状态满足式(1)时,则可关闭1个转发单元.显然,规则1实施时系统应有多于1个工作转发单元.规则2.若系统当前实际负载大于k个转发单元转发能力的开启阈值带宽,则应开启1个未工作的转发单元.即当系统状态满足式(2)时,则可开启1个转发单元.显然,规则2实施时系统的工作转发单元数应少于n.节能模式根据精确度要求,以时间段Δt2为单位进行调控.系统分析上一个Δt2时间段内的转发引擎负载,并根据规则1和规则2进行转发单元开启/关闭调控.为了避免丢包现象,规则2可循环实施,即一次调控可开启多个转发单元.因为路由器下一时刻流量与前一时刻流量有着密切的关系,因此以此为据设定关闭阈值和开启阈值的取值范围.只有实际处理流量远小于系统当前转发引擎的最高处理流量时,关闭一个转发单元才不致于导致下一时刻丢包,本文初步设定关闭阈值的范围为0~50%.同理,实际处理流量若高于转发引擎最大处理能力的50%时,需要开启新的转发单元,可将开启阈值范围限定于50%~100%.论文后续内容会对不同阈值进行实验,对比节能效果.基于FERM转发引擎,节能模式中各事务描述如下.(1)IN3.包括3个事务.IN3.1,主控读取转发单元数n,当前工作转发单元数k=n,并通告各线卡;IN3.2,各线卡当前转发单元序号初始为Ncur=1;IN3.3,启动循环超时定时器TM2,超时时间为Δt2.(2)ST3.状态调控以Δt2时间为单位执行,TM2超时执行3个事务.ST3.1,主控收集Δt2时间段各转发单元的实际负载带宽B(i),并计算得到系统总转发带宽为∑k或关闭转发单元,并对k重新赋值;ST3.3,各线卡当前转发单元序号初始为Ncur=1.(3)FP3.线卡总是选择Ncur号转发单元为当前报文实施转发处理,并调整Ncur的值,包括1个事务.FP3.1,线卡将当前报文传递给第Ncur号转发单元处理,并有Ncur=(Ncur+1)modk.(4)FM3.一个事务FM3.1,与FM1.1相同.5FERM实施FERM基于SFU路由器体系结构,由主控、线卡、转发单元协同实现,其功能结构如图3所示.主控是FERM的控制中心,主要涉及3个功能模块.(1)表项维护.由路由协议学习路由信息汇聚到路由管理模块,并计算出核心路由表,这一过程与传统路由系统完全一样.不同的是,核心路由表同步[10]的对象不再是线卡,而是所有转发单元.表项维护模块针对系统任何的路由变化:增加、删除、修改,负责与所有转发单元同步;(2)初始配置.主要完成相关参数配置(如报文图、开启/关闭阈值)及全局状态信息(如转发单元数)的获取.同时,将上述参数向所有线卡通告;(3)状态管理及调度.主要在FERM运行过程中对系统状态进行监测、分析,并对后续系统状态进行调整(如开启/关闭转发单元).FERM中线卡功能与传统实现的最大区别在于:不再存储转发表,不进行转发表查找.线卡的核心工作是通过网络接口接收外部报文,并根据主控Page6的状态通告,在转发实施时选择转发单元对报文进行处理.同时,线卡接收来自转发单元的报文,并通过网络接口发出.另外,线卡的“初始配置”和“状态管理及调度”模块与主控协同完成状态参数调整及定时器服务.转发单元是FERM最核心的部件,它根据主控的路由通告进行转发表维护.转发单元从线卡接收报文,对报文目的地址进行最长前缀匹配,并根据匹配结果将报文转交到出线卡.每一个转发单元都独立工作,并与FERM转发引擎的不同工作模式无表1不同转发模式中事务的重构关系状态管理及调度6实验及性能分析使用Matlab对本文工作进行模拟分析.对于负载均衡模式,假设拥有4个转发单元,每块转发引擎最大处理带宽为10Gbps,采用生成随机数的方法模拟实际流量,对负载均衡模式LBM模式和传统转发模式(TraditionalForwardingMode,TFM)进行比较.假设每块线卡需要处理的流量在0~15Gbps之间随机分布,随机生成1000个点,代表需要处理的1000组真实流量.图4显示了这1000个随机流量与实际处理的流量的关系.图4中横坐标为转发单元收到的流量总和,纵坐标为转发单元实际处理的流量总和.三角代表LBM模式的实际处理流量,五角星代表TFM模式的实际处理流量.可见,LBM模式在实际流量不高于4×10Gbps带宽时,能确保不出现任何丢包.而TFM模式中,因为每块线卡的关.转发单元简单、模式无关的特点,有效地保证了FERM的高效性和灵活性.FERM转发引擎不仅支持多种转发模式,还实现了具体实施事务的重构复用.本文给出的负载均衡、带宽约束和绿色节能3种转发模式,对应着不同的事务流程.表1汇总了3种转发模式的相关事务,并分析了它们之间的重构关系.显然,FERM转发引擎中的3种工作模式,存在大量的事务重构关系,说明系统可基于大量重构模块完成实现.转发引擎只能处理10Gbps的流量,当一块线卡接收的流量高于10Gbps时,就会出现丢包.当且仅当每块线卡都接收10Gbps流量时,系统才可达到最大处理流量40Gbps.然而,多数情况下每个线卡接收到的实际流量并不平均.因此,由于TFM模式中各线卡流量不均衡,系统转发能力得不到最大化利用.PSM模式是用尽量少的转发单元完成系统的转发工作,并关闭空闲转发单元节省电能.转发单元中一块TCAM的能耗在12W~15W之间,非激活状态为2.5W,激活状态为14.3W[4].可见,关闭空闲转发引擎可以大幅度降低系统能耗.令Pact为激活状态所需能耗,Pinact为非激活状态所需能耗,M为关闭转发引擎个数,T为关闭时间.节省电能Psave满足公式:Psave=(Pact-Pinact)×M×T.图5为关闭转发引擎个数、关闭时间与可节省电能的理论关系图.可见,当关闭转发单元的个数和关闭时间逐渐增加时,能耗节省非常明显.Page7此外,针对网络实际流量进行PSM模式的节能分析.假设可重构虚拟转发引擎系统每隔10min检测一次系统流量,并以此判断是否可以关闭或者需要开启若干转发单元.假定系统中包含25个转发单元,每个转发单元使用一块TCAM,并且最高处理带宽为10Gbps.我们采用真实路由器“PAE-TEC”在2011年11月4日零点到10点检测的数据①进行分析.为了更清晰地表现数据,我们将其流量放大1000倍.实验结果如图6所示,星形直线表示传统模式需要开启的转发单元个数,10个小时始终开启25个转发单元.折线表示使用PSM模式所需开启的转发单元个数.传统模式中,10个小时转发单元消耗总电能为25×14.3×0.001×10=3.575°.PSM模式中,消耗的电能为2.5007°,可节省电能1.0743°,约节省30.05%.可见,PSM模式相比TFM模式在节能方面有了显著的提升.并且由图6可知,PSM模式中开启转发单元的个数基本符合实际流量的变化.此外,根据设定的开启阈值和关闭阈值不同,PSM模式的转发单元启用数量会略有不同.因此,我们也对不同阈值设置分析转发单元开启关闭次数和节能比.我们将关闭阈值分别设为20%、30%、40%,开启阈值分别设为60%、70%、80%,通过两两组合,进行9次模拟实验.实验环境与前述实验一致,选用真实路由器“PAETEC”流量检测的数据进行分析.实验结果如图7所示.其中黑色柱代表关闭次数,白色柱代表开启次数,灰色柱代表节能百分比.从图7中可以看出,将开启阈值和关闭阈值设为最大值时,省电最多,但同样开启和关闭次数也相对增加.此外,随着阈值的增大,出现丢包的概率也随之增大.PSM实施时,应根据具体需求设置转发单元开关阈值,获得节能和系统传输性能间的最优结合点,本文不做深入分析.7总结本文提出了工作模式可配置的共享转发引擎,旨在为不同运营需求的网络提供可动态变换工作模式的转发引擎.基于转发引擎与线卡分离的SFU路由系统结构,构建独立的转发单元模块.转发单元功能简单、工作独立,为转发引擎的工作模式可配置提供了底层基础.多个转发单元可形成的共享转发引擎,为路由系统所有线卡提供报文转发服务.本文设计的工作模式可配置的转发引擎FERM,通过五元组形式描述了转发模式与实施事务的关系.FERM根据不同的运行模式实施不同的转发事务,并且确保不同运行模式总是提供一致的API接口.基于FERM,路由系统可根据运营需求提供不同的转发模式.除了基本的负载均衡模式,还设计了带宽约束和绿色节能两种扩展转发模式,并给出它们的具体实施方法.最后,本文通过模拟分析论证了FERM转发引擎中各种工作模式的优越性能.当然,FERM在路由系统中真正实施需要改变现有的典型路由器体系结构,涉及大量的板卡结构设计及设备管理工作.而且,线卡与转发单元之间的高速可靠数据交换是结构实现的基础,它相对于传统的线卡间交换更为复杂,论文后续工作将重点关注此方面的研究.
