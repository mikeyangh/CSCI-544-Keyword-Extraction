Page1基于多图谱活动轮廓模型的脑部图像分割张明慧卢振泰张娟阳维陈武凡张煜(南方医科大学医学图像处理重点实验室广州510515)(南方医科大学生物医学工程学院广州510515)摘要丘脑、海马体、伏隔核、尾状核等关键脑结构的位置、体积、形态等的变化与多种脑部疾病息息相关,对其精准分割是进行相关定量分析的前提.然而在磁共振图像中这些结构对比度不高、边界模糊,传统方法只是利用了标号图像,没有考虑到待分割图像、先验信息等,因无法实现准确分割.文中将多图谱配准与活动轮廓模型相结合,提出了一种新的多图谱活动轮廓模型框架,有效地利用了图谱的先验信息和待分割图像的灰度信息,将多图谱的形状先验项引入到活动轮廓模型中,并在融合标号图像的过程中利用活动轮廓模型校正配准引起的误差,可以得到光滑、准确的分割结果.该框架包含3个部分:第1部分为图谱先验项,利用配准的局部相似性作为权重融合多个图谱的信息;第2部分为数据项,利用待分割图像的局部信息,可以校正配准中的误差;第3部分为平滑项,用于保证曲线在演化过程中的平滑.大量的实验表明了该方法的有效性和准确性.关键词磁共振图像;多图谱配准;活动轮廓模型;多图谱活动轮廓模型;图谱先验1引言目前脑部疾病对人类健康的危害,已相当于心血管疾病、癌症和糖尿病三大疾病的总和.脑部疾病发病率高、死亡率高、致残率高、复发率高且有较为复杂的并发症.海马体、伏隔核、尾状核、丘脑等脑结构的位置、体积与形态的变化与多种疾病息息相关,而要确定和分析这些变化首先需要准确地分割出这些脑结构,通过对其位置、体积与形态的研究可为多种疾病的临床研究提供支持[1].随着影像设备的快速发展,临床诊断中对医学图像日趋倚重.磁共振成像具有较高的分辨率,避免了探查诊断的手术,大大提高了医生的诊断效率.但在临床诊断中,仅仅分割出大脑中的灰质、白质、脑脊液是远远不够的,因为灰质、白质中还包含着更为复杂和精细的结构,如海马体、伏隔核、尾状核、丘脑等.这些脑结构属于灰质,与之相连的不仅有白质和脑脊液,而且还有同属于脑灰质的其他结构.它们体积都比较小,而且形状和拓扑结构复杂,边界不明显,即使有经验的影像专家手动分割都非常困难[2].图1第1行和第2行分别为丘脑和海马体的例子,曲线为丘脑和海马体的边界.丘脑属于大脑的灰质结构,与白质相邻,但边界非常模糊;海马体属于大脑的灰质结构,毗邻于杏仁核等灰质结构,被白质和脑脊液环绕着.海马体与杏仁核只隔一条灰质线,使得与周围组织很难区分.如何快速、准确、自动地分割脑结构MR图像成为一件非常困难的事情.活动轮廓模型,即ACM(ActiveContourModel)表达式简单、计算效率高,特别适用于建模或者提取任意形状的形变轮廓.近几十年来,活动轮廓模型在图像边缘检测、图像分割和运动跟踪中已经有了较为成功的应用[3-4].如果按照轮廓曲线表达形式来划分,活动轮廓模型可以分为几何活动轮廓和模型参数活动轮廓模型两类.几何活动轮廓模型用曲线进化的思想和水平集的形式来描述曲线的进化[5-7].参数活动轮廓模型曲线由一些规则排列的不连续的点组成或通过一些基函数来被描述成一种连续的参数形式[8].参数活动轮廓模型对噪声敏感,不能很好地处理曲线拓扑结构的变化,Caselles等人[9]和Malladi等人[10]利用曲线本身的几何量与基于偏微分方程的水平集理论相结合,提出了几何活动轮廓模型.这一方法的曲线演化只通过水平集函数进行驱动,故而稳定性不高.测地几何活动轮廓模型将曲线演化转化为能量优化问题,无需对嵌入函数进行重复初始化,还可以在能量函数中方便地融入约束信息,从而使模型具有更好的鲁棒性[11].为了克服边界泄露和对初始轮廓敏感这一问题,Chan和Vese[12]提出了一种基于区域的几何活动轮廓模型即C-V模型.该模型提高了在出现遮挡及边缘噪声较严重情况下轮廓曲线演化的准确度,其缺点是不能较好地处理灰度不均匀图像,且演化速度较慢.Li等人[13]在C-V模型的基础上考虑图像局部信息,提出了LBF模型,对灰度不均匀图像可以实现较好的分割,由于没有全局的形状先验知识,对于结构复杂、边界模糊的脑结构仍然难以实现准确分割.基于多图谱配准的分割方法引入了形状先验信息,无需手动设置初始边界、对噪声和偏移场不敏感,因而获得了广泛的应用与认可.Isgum等人[14]使用前向搜索法来减少图谱数以提高分割速度.Jia等人[15]提出把基于迭代多图谱方法和基于树形结构的方法相结合以充分考虑图谱间及待分割图像间的相互关系,从而提高了图像分割精确度.但基于多图谱配准的方法得到的结果表面不光滑,在边界处会出现阶梯状.我们将多图谱配准方法与活动轮廓模型相结合,提出了一种新的多图谱活动轮廓模型框架(Multi-AtlasActiveContourModel,MA-ACM),该框架包含3个部分:第1部分为图谱先验项,利用配准的局部相似性作为权重融合多个图谱的信息;第2部分为数据项,利用待分割图像的局部信息,可以校正配准中的误差;第3部分为平滑项,用于保证Page3曲线在演化过程中的平滑.对MICCAI公开脑部数据进行了大量实验①,新方法避免了轮廓初始化问题,可以得到光滑、连续和准确的边界,且分割精度有了显著的提高.2基于多图谱配准的分割方法图谱由两部分组成:灰度图像Ii和影像专家手动分割好的标号图像Li,Li是一个二值图像,我们以分割丘脑为例,标号值1的地方表示丘脑,标号值0的地方表示非丘脑.多图谱分割方法包括两个核心部分:图谱配准和标号图像融合.如图2所示,左框表示图谱配准过程,右框表示标号图像融合过程.首先将Ii配准到待分割图像I得到变形场,然后将变形场应用到标号图像Li上,得到变形后的标号图像,最后融合变形后的标号图像得到最终的分割结果S.近几年,多图谱方法的研究重点主要集中在标号图像的融合上.目前的常用融合方法有多数表决方法(MajorityVoting)[16]、加权表决方法(WeightVoting)[17]、STAPLE[18]算法、SIMPLE方法[19].多数表决法是指:对于待分割图像中的每一个像素点,统计变换后标号图像上对应像素点的灰度值,假如灰度值为1的个数大于灰度值为0的个数,则认为该像素点属于目标区域,反之,该像素点为背景,这种方法的不足之处是非常依赖配准的准确程度.加权表决法利用图谱灰度图像与待分割图像的相似性作为权重,来加权变换后标记图像上的像素值,并进行求和归一化,假如大于阈值,认为该像素点属于目标区域,反之,属于背景.Warfield等人[18]设计的STAPLE算法将每一个图谱看作一个弱分类器,提出利用EM算法对每一个分类器设置权重,从而完成融合得到最后的分割结果.SIMPLE方法考虑到不同的图谱数量会对融合的结果有影响,通过迭代的方式逐渐减少图谱的个数[19].Wang等人[20]的联合图谱融合(JointLabelFusion,JLF)方法在进行加权标号时考虑不同图谱的独立性,根据与待分割图像的局部相似性,计算两个图谱的联合概率来确定当前像素点分割是否错误.以上方法只利用标号图像,没有考虑到待分割图像自身,必然会造成信息的丢失.本文提出的基于多图谱活动轮廓模型的分割方法综合了多图谱分割方法与传统活动轮廓模型的优点,考虑了图谱的先验信息和待分割图像的灰度信息,将多图谱的形状先验项引入到活动轮廓模型中,并在融合标号图像的过程中矫正配准引起的误差,实现了脑结构的自动精确分割.3基于多图谱活动轮廓模型的分割3.1活动轮廓模型传统的活动轮廓模型目标函数为其中,I为待分割图像,为水平集函数,D为数据项,用于驱动水平集函数的演化;R为正则化项,用以保证演化过程中曲线的平滑.活动轮廓模型只是利用了图像的灰度信息进行分割,缺少形状先验的引导与约束,对于对比度高,边界明显的图像,此方法可以得到光滑、连续和准确的边界.但对于低对比度、无明显边界的脑结构图像,此方法无法分割出准确的边界.3.2多图谱形状先验为了将图谱的形状先验信息引入到活动轮廓模型中,首先需要将图谱中的标号图像进行水平集表示,对于任意一个标号图像Li,我们定义水平集函数i:本文取m=4,图3给出了图1(b)中的丘脑对应的手动分割结果和水平集函数.在丘脑内部点对应值小于零,外部点对应值大于零.若有n个图谱数,则①MICCAI2013ChallengeWorkshoponSegmentation:Page4图3水平集表示图谱中标号图像的水平集函数集合为{1,2,…,n}.对于给定的待分割图像I,我们的目标就是在I中寻找最优的水平集函数作为分割结果.传统方法在融合时一般需要重新计算变形后的图谱与待分割图像的相似性,如互信息量、互相关系数、归一化的互相关或者其他的一些相似性测度[21],这种方法额外增加了计算量,比较耗时,而且这种整体的相似性测度并不能很好地度量每个像素点在配准、分割时的作用.ANTS(AdvancedNeuro-imagingTools)配准方法利用局部相似性作为配准的相似性测度,并且对变形场施加了有效的约束及平滑可以达到比较好的配准效果[22].我们以ANTS配准的局部相似性作为融合时的权重,相似性测度高的像素点,说明配准更加准确,对最后的分割结果影响就越大.为了有效地将变形后的标号图像融合在一起,我们定义融合项F为F(;1,…,n)=∫Ω∑其中,ωi(x)为第i个变形后标号图像在x点处的权重,即配准后的局部相似性.融合项表示得到的分割结果与专家勾画的所有图谱差异,值越小说明分割结果与图谱越接近.3.3多图谱活动轮廓模型为了有效地利用图谱的先验信息和待分割图像的灰度信息,并在融合标号图像的过程中较正配准引起的误差,得到光滑、准确的分割结果,我们采用以下能量函数构造多图谱活动轮廓模型:E()=F(;1,…,n)+αD(;I)+βR()(4)其中,α,β分别为数据项和正则化项的权重.C-V模型需要计算演化曲线内部和外部的整体均值[6],LBF模型考虑到图像的局部统计信息[13],对于边界模糊、对比度不明显的磁共振图像有较好的分割效果,本文采用LBF模型作为数据项,其表达示如下:其中,Ey(C,f1(y),f2(y);I)=λ1∫O式中C表示我们将得到的零水平集曲线,如图4所示.设Nx是以x为中心的邻域,y是邻域中一点,f1是经方差为ρ的高斯函数Kρ滤波后得到曲线内部的邻域Nx的均值,f2是经方差为ρ的高斯函数Kρ滤波后得到曲线外部的邻域Nx的均值.其中,M1()=H()>0;M2()=1-H()>0,H为Heaviside函数.Li等人[13]提出的距离保持约束可以很好地保证曲线在演化过程中的平滑,故我们采用该约束项R:R()=∫H((x))dx+∫p(x)dx(8)Page5其中,p(s)=水平集函数的优化可以采用梯度下降法.梯度下降法是以负梯度方向作为极小化方法的下降方向,具有很好的整体收敛性.t=-2∑ωi-i-α·δ()λ1e1-λ2eβ·δ()div其中,ei(x)=∫Kρ(y-x)I(x)-fi(y)2dy,δ为Dirac函数.图5基于多图谱活动轮廓模型的分割方法流程4实验4.1实验数据为了便于和目前国际上主流的分割方法进行比较,我们采用MICCAI2013竞赛中的公开脑部数据进行了左、右丘脑的分割实验,该数据的训练集中共有35组脑部T1加权磁共振三维数据,包含灰度图像及对应的专家手动勾画的标号图像.我们随机的选择20组作为图谱,其余15组作为测试.计算重叠率Dice和Hausdorff(HD)距离用于验证分割方法的精度,其定义分别为本方法流程如图5所示,主要包括两部分:配准和融合.上面的框图显示了本框架的配准部分,下面框图显示了本框架的融合部分,本方法的具体步骤描述如下:(1)将图谱灰度图像分别与待分割的图像进行配准,可以得到一系列的变形场和配准后的图谱灰度图像.(2)将步(1)得到的一系列变形场分别作用于对应的标号图像,可以得到变形后的表号图像.(3)考虑待分割图像的信息,利用多图谱活动轮廓模型对变形后标号图像进行融合及较正,由此可以得到分割结果.其中,V(A),V(B)分别表示自动分割结果和专家手动勾画结果的体积,V(A∩B)表示自动分割结果和专家手动勾画结果重叠部分的体积;其中,d(a,b)表示a,b两个点的欧氏距离.4.2实验设置在前期工作基础中我们发现:脑壳、偏移场、灰度归一化都会对配准和分割有一定的影响,我Page6们利用BET算法去除脑壳[24];N4算法去除MR图像中的偏移场[16];进行灰度归一化完成图像的预处理.多图谱活动轮廓模型能量函数中的参数α,β,ρ,λ1,λ2可以利用交叉验证(CrossValidation)法[18]得到.本文中取α=β=0.01,ρ=1,λ1=λ2=0.001,为验证本方法的有效性,我们与目前国际上主流的几种方法进行了比较,分别为STAPLE[25]、SpatialSTAPLE[16]、MajorVotingSIMPLE[19]、Wang的联合图谱融合方法[20](JointLabelFusion,本文简记为JLF).操作平台为Windows7ServicePack1,Intel(R)Core(TM)i5-3330CPU,8.0GB内存.4.3脑图分割结果STAPLE,SpatialSTAPLE,MajorVoting,WeightVoting,SIMPLE和JLF方法对左、右丘脑分割的重叠率均值均为0.91左右,而MA-ACM方法可以达到0.92,提高了1%.由于海马体属于灰质,与之相连的不仅有白质和脑脊液,而且还有同属于脑灰质的其他结构,另外海马体为细长的管状结构,使得海马体的分割更加困难.传统方法对左、右侧海马体的分割重叠率均值分别为0.83和0.84,JLF方法分别为0.84和0.85,而我们的方法分别为0.85和0.86,分割精度显然得到了提高.图6不同方法对丘脑分割的重叠率(第1行)和Hausdorff距离(第2行)(左边为左丘脑,右边为右丘脑)图6和图7分别给出了不同方法对丘脑和海马体分割重叠率盒状图(第1行)和Hausdorff距离盒状图(第2行),盒状图内的横线为中位数.从盒状图中可以看出MA-ACM方法重叠率和距离值都比较集中,而其他方法的结果则比较分散,说明MA-ACM方法具有较好的一致性.重叠率越高说明分割精度越高,MA-ACM方法的重叠率中位数在盒状图的偏上方,说明对于大部分测试图像都可以达到较好的分割.Hausdorff距离值越小说明分割精度越高,MA-ACM方法的Hausdorff距离中位数在盒状图的偏下方,同样可以说明对于大部分测试图像MA-ACM可以达到较好的分割.图8(a)、(b)分别为待分割图像和专家手动分割的金标准;(c)~(i)分别为MA-ACM、STAPLE、SpatialSTAPLE、MajorVoting、WeightVoting、SIMPLE和JLF这7种方法对编号为1006的数据左、右丘脑的分割结果.绿色为专家手动分割结果,红色为不同方法的分割结果.从图8(c)中可以看出我们的方法与专家手动分割结果更加接近,特别在脑室附近(箭头所示),其他方法都出现了错误的分割,而我们方法在活动轮廓模型的数据项的矫正下,成功地将演化曲线吸引到了真实的丘脑边界.Page7图7不同方法对海马体分割的重叠率(第1行)和Hausdorff距离(第2行),左边为左海马体,右边为右海马体图8不同方法对编号为1006的数据丘脑的分割结果Page8图9(a)、(b)分别为待分割图像和专家手动分割的金标准;图9(c)~(i)分别为MA-ACM、STAPLE、SpatialSTAPLE、MajorVoting、WeightVoting、SIMPLE和JLF这7种方法对编号为1002的数据左、右海马体的分割结果.海马体的两端图9不同方法对编号为1002的数据海马体的分割结果传统的融合方法仅仅利用了配准后的图谱信息,融合时没有考虑待分割图像的灰度及空间位置信息,而我们提出的基于多图谱活动轮廓模型的分割方法在融合图谱的同时,根据待分割图像的灰度图10丘脑分割后三维重建结果灰度值较低,其他方法在海马体两端均出现了错误分割,而MA-ACM方法所采用的活动轮廓模型的数据项为LBF模型,针对灰度不均匀的图像可以演化到真实的边界,故而可以准确地分割到海马体.与空间位置信息,利用活动轮廓模型对配准中出现误配的点进行矫正,将曲线演化到真实的边界,从而大大提高了分割的精度,同时又有很好的平滑性.图10、图11分别给出了丘脑和海马体分割后Page9图11海马体分割后三维重建结果三维重建结果.其中(a)为专家手工勾画金标准三维重建结果,(b)~(h)分别为MA-ACM、STAPLE、SpatialSTAPLE、MajorVoting、WeightVoting、SIMPLE和JLF分割后的三维重建结果.从图中不难发现其他方法所得到的结果存在明显的阶梯状效果,在边界出会出现一些毛刺或凹陷现象,而MA-ACM方法利用了水平集函数进行曲线的演化可以得到光滑、连续的边界,与脑部结构的真实情况更加接近,便于医生观察体积与形态的变化.4.4噪声图像分割结果为了验证MA-ACM方法对噪声的鲁棒性,我们对编号为1004的图像海马体进行了分割.MR图像一般受到磁场和线圈的影响,呈现出高斯噪声.我们分别对1004图像加入均值为0,方差分别0.005和0.01的高斯噪声进行模拟.分割结果如图12所示.(a)~(c)分别为原始图像、方差为0.005的高斯噪声分割和方差为0.01的高斯噪声.绿色为专家手工勾画金标准,红色为MA-ACM方法分割结果.从图中可以看出在不同噪声水平下,MA-ACM方法都可以得到准确的分割结果.这是由于MA-ACM方法有多图谱先验进行约束,保证曲线在每个图谱形状的周围进行演化,即使有噪声影响的情况下也不会发生泄露和发散.另外由于MA-ACM方法所采用的活动轮廓模型的数据项为LBF模型,该模型计算局部区域的均值,且利用高斯核函数进行平滑,从而有效地抑制了噪声的影响.图12不同噪声水平下,MA-ACM方法分割结果5结论大脑内部结构的位置、体积与形态变化与多种疾病息息相关,而要确定和分析这些变化首先需要对这些脑结构进行精确的分割.我们对目前脑内结构分割方法进行了详细分析,并针对这些方法存在的缺点和不足,提出了一种新的多图谱活动轮廓模型.基于多图谱配准的分割方法利用了图谱的先验信息,对边界模糊的结构可以实现准确分割,但在进行图谱融合时只考虑了图谱中标记图像的信息,忽略了待分割图像的信息.传统活动轮廓模型可以得到封闭、光滑的连续边界,但需要轮廓初始化,并且对初始化非常敏感,对边界模糊的结构无法实现准确分割.我们综合多图谱分割方法与传统活动轮廓模型的优点,将多图谱的形状先验项引入到活动轮廓模型中,实现了脑结构的自动精确分割与三维重建.新模型中包含两个重要部分:图谱配准和融合.Page10图谱配准的准确性将直接影响到分割的精度.不同配准方法和配准参数将得到不同的分割结果,在下一步的研究中我们拟将在不同配准方法和配准参数下得到变形后图谱组成高维空间,显然该空间具有较高的冗余性,可对该空间进行稀疏表达,寻找最优的组合系数对图谱进行融合,从而提高分割的精度.
