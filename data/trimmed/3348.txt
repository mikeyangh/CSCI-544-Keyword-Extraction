Page1基于独立时空特征空间的人体运动合成刘更代1)徐明亮2)张明敏2)1)(西安电子科技大学计算机学院西安710071)2)(浙江大学CAD&CG国家重点实验室杭州310058)摘要如何通过指定约束条件的方式交互式地合成风格化人体运动是计算机动画研究领域的热点和难点,传统的数据驱动办法通常没有全面考虑运动的静态和动态特性.针对这一问题,文中提出人体运动的独立时空特征空间模型,利用一个可变形运动模型和独立特征子空间分析算法提取运动在时空两个域上的特征,并将其封装起来,通过低维子空间进行描述.运动风格的编辑可利用低维运动混合和空时约束优化等方法来实现.该方法充分考虑了运动在时域上的特征,并为用户提供了可编辑接口.文中以各种风格的行走运动为例讨论了该方法的有效性,结果证明效果良好,可用于交互式运动风格编辑.关键词独立时空特征子空间;可变形运动模型;独立特征子空间分析;人体运动;风格;主成分分析1引言机器人领域应用广泛,但是合成风格化的人体运动仍然是一个难题.这是因为:首先,人体运动的风格是一个抽象的概念,很难对其进行量化;另外,对风目前,运动捕获在计算机动画、游戏、电影以及格建模时需要全面考虑运动的空间特征与时间特Page2征;最后,必须提供直观的风格编辑接口.针对这些难点,本文提出了一个新的低维风格化运动模型.首先,人体运动的风格被认为是在基本运动之上的某种“细微变化”,它具有以下3个特征:(1)运动风格是风格化运动与基本运动之间的差别;(2)这种差别表现在两个方面:空间和时间上.(3)运动的风格和内容是相互独立的,改变风格参数并不影响运动的内容.本文借鉴了一种可变形运动模型,该模型包含了运动的动态特性,而动态特性正是运动风格的重要组成部分.然后使用了一种机器学习算法获得能够分离运动风格和内容的低维空间,称为“独立时空特征空间”,并将风格定义为它的一个子空间,称为“时空风格子空间”.最后,通过运动混合和基于约束的优化算法求解问题.实验结果表明该方法计算效率高,具有良好的交互性与非常逼真的视觉效果,能够用于人体动画的交互式编辑和实时合成.2相关工作直观地看,风格应该与运动数据底层的某些静态或动态参数有关.Kawasaki等人[1]认为运动风格表现在运动的底层特性:扭矩和角速度上,通过提取这两个参数来实现运动风格在不同角色之间的传递.Liu等人[2]将风格定义为底层的若干物理参数,通过反向非线性优化实现物理真实的风格变换.Brand等人[3]和Hsu等人[4]分别使用隐马尔可夫模型和线性时不变模型对运动风格建模,实现风格的变换.这类方法通常会考虑运动的动态参数,但无法合成满足空间约束的运动.近些年来,基于线性子空间的插值技术被广泛用于风格化运动合成.Urtasun等人[5]以及李淳秡等人[6]使用主成分分析(PrincipalComponentsAnal-ysis,PCA)对一定量的运动数据进行建模,用于合成各种风格的行走运动.Shapiro等人[7]使用独立成分分析(IndependentComponentsAnalysis,ICA)来寻找风格成分.这类方法比较适合处理行走运动的风格,但不能保证从子空间中恢复出运动的动态特性.合成满足约束的运动是一个运动编辑系统的理想目标,数据驱动的方法能够求解这类约束问题.Kovar等人[8]对大规模运动数据进行组织,通过线性插值实现满足约束的运动序列,该方法实时性好,但是需要大量的运动帧和预处理过程.逆运动学(InverseKinematics,IK)是合成满足约束的运动的典型方法.一些研究者提出使用数据驱动的方法来求解IK问题[9-11],通过非线性降维来缩小优化搜索空间,然后通过在降维后的数据间进行插值来求解IK问题.刘更代等人[12]则在一个封装了风格元素的低维子空间内求解IK,生成满足末端约束的风格化运动.这类方法能够生成自然的姿态,但是合成整段运动需要添加较多的约束,且无法处理运动的动态特性.运动在时序上的特征也是运动风格的重要组成部分,因此处理人体运动风格时应该考虑运动的动态特性.Lau等人[13]使用动态贝叶斯网络扩展运动数据在时间和空间上的变化.Chai等人[14]使用线性时不变系统建立运动的动态模型,并采用最大后验来进行优化计算,求解满足约束的运动.Min等人[15]提出了一种可变形运动模型,将运动注册曲线和运动数据整合在一起,也结合最大后验框架来交互式合成满足用户指定约束的运动.Min等人[16]还在此模型的基础上使用多线性模型来处理运动风格,利用张量分析的方法将运动数据分解为不同的因子,以此模型来实现风格编辑.而本文则扩展了文献[15]的可变形模型,用于处理运动风格.3算法思路本文算法可分为两个主要步骤:第1步,模型训练和风格提取.首先,人体运动数据经过预处理并降维,整合时空两方面的特性,然后,使用机器学习算法建立独立时空特征空间.第2步,风格编辑.本文将风格编辑看作运动混合和优化问题,通过在独立时空特征空间模型上建立优化方程来完成编辑操作.图1给出了本文方法的数据变换流程.首先,在低维的独立时空特征空间进行优化计算,得到新的低维表示;然后,变换至可变形运动空间,该空间的数据包括运动向量和时间对齐向量;接着,用时间对齐曲线把标准时间轴上的运动向量变换回原始时间轴,即得到在PCA空间的低维运动序列,最后重建图1用独立时空特征空间合成新运动的流程Page3到视觉空间即可.从该流程可以看出,运动的空间特性(运动向量)和时间特性(时间对齐向量)被封装并参数化在独立时空特征空间中.4数据分析与预处理在建立运动模型之前,先要分析并处理运动数据,主要包括3个步骤:创建运动数据集、时间对齐和数据降维.4.1数据表示本文所有运动数据都被表示成一个高维向量{狓n|n=1,2,…,N},其中N是运动样本数.而每一帧{狓n(t)|t=1,2,…,Tn}由全局坐标位置狆和所有关节的旋转角狇表示为(狆,狇1,…,狇r)t,其中r是旋转角个数,Tn是第n段运动的帧数.也就是说,所有的运动样本都是将每一帧串接起来得到的,且维数D=3(r+1)×Tn.4.2时间对齐时间对齐的目的是使所有运动都具有相同的结构.对齐时,首先选取一段中性运动作为参考运动,然后为参考运动和所有数据集中的样本手动选择一些关键帧,包括起始帧、结束帧和脚接触地面及离开地面时的帧,这样所有的运动数据都被手动分割为若干小的片段.最后对齐每个子片段.时间对齐可使用对齐曲线狑(t)来表示.{狑n(t)|n=1,2,…,N,t=1,2,…,T}是一个定义在标准时间轴上的T维向量,其中T是所有运动片段对齐后的帧数,它表示参考运动的第t帧和待对齐运动的第狑(t)帧之间的关联.所有原始数据狓n通过狑n(t)变换为对齐后的运动序列{狕n(t)|n=1,2,…,N,t=1,2,…,T}.我们设函数d(狑(t))表示参考运动的第t帧和待对齐运动的第狑(t)帧之间的非相似度,求解时间对齐问题就是寻找一条曲线狑,使得该曲线对应的两段运动的帧间非相似度之和最大,可用下式表示为其中T⌒是子片段的帧数,本文中两帧之间的非相似度使用了文献[17]定义的度量.求解时间对齐曲线需要满足三个约束条件:连续、单调和坡度要求.其中坡度要求限制了曲线沿水平或垂直方向最多可以连续前进的步数.上述约束条件可描述为if狑(t)=T^,then狑(t+1)=T^∨T^+1(2)if狑(t)=…=狑(t+i-1)=T^,then狑(t+i)=T^+1其中i∈[1,T]是最多可以连续前进的步数,本文设i=2.式(2)和式(3)分别定义了单调和坡度要求,利用动态规划算法在式(2)和式(3)的约束条件下求解式(1)即可得到时间对齐曲线.图2绘出了本文使用的半自动时间对齐曲线对齐中性运动和跨步运动的例子,并给出了手动选择的若干关键帧,分别对应左、右脚离开地面时的情况.4.3数据降维本文对运动数据和时间对齐曲线都进行降维处理.对于空间特征,将PCA作用于对齐后的运动向量狕n,得到其中狕0是所有对齐后样本的均值,狌=(u1,…,uK)是主系数向量,为运动数据在各个正交的特征运动向量犪i上的投影,而KN<T.降维后任一标准时刻t的姿态可以表示为同样地,PCA也需要作用于时间对齐曲线.但直接使用PCA会带来问题,因为时间对齐曲线必须满足非负和单调递增的约束,而PCA操作会破坏这些约束.本文采用了文献[15]中的变换将时间对齐曲线狑(t)映射到新的空间犺(t):犺(t)=ln(狑(t)-狑(t-1)),t=1,2,…,T(6)并令狑(0)=0,其反变换为狑(t)=∑t意,狑(t)始终是非负的,且单调递增,在犺(t)空间执Page4行PCA不会破坏时间对齐曲线在狑(t)空间的约束条件,最后狑(t)被表示为狑(t)=W(狏)=∑t其中,犺0是所有对齐曲线在犺(t)空间的均值,而犫j张成一个低维空间,狏=(vi,…,vL)是犺(t)在该空间的低维表示,且LN<T.需要说明的是,执行PCA时要计算协方差矩阵犆x=狓狓T(狓为去均值的向量,且犆x是T×T方阵)及其特征向量,本文数据维数大于样本数时(N<T),存储和计算开销太大.因此,本文取代计算狓狓T,改为计算犆^x=狓T狓及其特征向量λ^i,犆^x是N×N的方阵,尺寸大大减小,且可以将数据维数降到N维以下.这样犆x的特征向量λi=狓·λ^i.对运动数据和时间对齐曲线进行降维的结果是获得了两个向量狌和狏,以及由向量犪i和犫j张成的两个子空间,分别刻画了运动在空间和时间上的特征.5独立时空特征空间结合运动数据的空间和时间模型,能够得到一个可变形运动模型.在该模型的基础上利用统计分析提取风格参数,可将风格元素嵌入一个新的低维空间,从而建立能够编辑静态与动态风格的风格化运动模型.5.1可变形运动模型本文采用文献[15]的方法构建可变形运动模型.根据4.3小节的结论,向量狌和狏共同表示运动数据的低维特征,如果将狌和狏连接起来,可以组成一个新的向量狊∈其中犕是一个L×L的对角阵,用于指定向量狏中每个元素的权值.这么做的原因是犪i和犫j构成的是不同的子空间,而狌和狏也具有不同的单位,不能直接连接.这类似于文献[18]中将脸型和纹理向量串联起来组成一个新的向量.5.2独立时空特征空间模型为了得到运动的风格参数,本文使用独立特征子空间分析(IndependentFeatureSubspacesAnal-ysis,IFSA)对可变形运动模型做进一步的处理与分析.IFSA是多维ICA和不变特征子空间两种技术的结合[19].多维ICA是传统ICA技术的扩展,该模型不要求各成分之间完全独立,而是将这些成分再划分为一些k元组,每个子成分相互依赖,但k元组之间的依赖性是不允许的.不变特征子空间技术认为一个不变特征可以被看作特征空间中的一个线性子空间,而不变的高阶特征的值是观测数据在该子空间上投影的范数,相应的子空间由低阶特征张成,如图3所示.因此,第j个子空间的高阶特征值Fj可由下式求得对于观测数据狊n,n=1,2,…,N,估计独立特征空间模型即求解下面的最优化问题:犲i=argmax犲i=argmax犲{i∑N其中L(·)是似然函数,而犲i是子空间的基向量,J是独立子空间的数目,j(j=1,2,…,J)表示属于第j个子空间中所有成分γi的集合.式中p(·)给出了Sj落在第j个k元组中的概率,根据非高斯性越强,独立性就越强的原则,假设概率分布为明显的超高斯分布,如logp(u)=-λ1u1/2+λ2.概率密度函数的自变量是子空间范数的平方,具有球面对称性.它并不区别对待数据在同一子空间的不同基向量上的投影,而是考虑在该子空间的所有基向量上投影的综合效果.换言之,子空间的各维之间具有依赖性.因此IFSA能够处理ICA无法处理的某些剩余的依赖性,并表达高阶的不变特性.最终求解使式(10)即可估计出犲i.本文使用Page5式(11)给出的随机梯度法[19]迭代计算犲i,其中Δ犲li表示犲i的第l个元素每次迭代的步长.其中g(u)=p/p=-λ1u-1/2是一个非线性函数,包含了保证投影范数尽可能稀疏分布的信息.为了在J个子空间中找到一个最能代表运动风格的子空间,本文定义一个度量.同时将该子空间命名为“时空风格子空间”,因为它包含了运动在时空两维上的特性,记其索引为jS,则jS=argmaxj∈[1,J]其中i是运动的索引值,而i=1对应的是参考运动,Fi,j是第i段运动在第j个子空间的特征,由式(9)计算.可见,该度量旨在寻找能够使所有运动与参考运动在其上的投影范数的差最大的子空间.换句话说,该子空间与其它子空间统计独立,能够有效区分参考运动与风格化运动,并封装了运动时空特性.独立时空特征空间是可变形运动模型进一步变换的结果,能够描述运动的风格.可变形运动向量狊n被重新投影到各个子空间,得到一系列向量γn∈D,且DK+L.另记γin,i∈js表示向量γ中与运动风格有关的元素,即狊在时空风格子空间的投影.这样,任何一段运动狓都可以从该空间重建出来,如下式所示:其中T(γ):γ狊表示从独立时空特征空间到可变形运动空间的映射.实际上T=犘犃^S是一个线性变换,犘是一个白化矩阵,犃^S是IFSA的混合矩阵,是所有子空间的基向量犲i组成的矩阵的逆,表示从独立特征子空间到白化数据空间的映射[17].Q(狌,狏)=Z(狌)W(狏)表示将式(4)所示的运动Z(狌)通过式(8)表示的时间对齐信息W(狏)重新扭曲到原始时间轴.6风格化运动合成本节主要介绍如何使用独立时空特征空间模型狓=M(γ)来进行风格化运动合成.一种最直接的方式是风格混合,即将两种不同的风格叠加在一起,得到具备两种风格特征的运动片段.设两种运动的风格参数分别为γ1和γ2,那么新的风格参数γ应由这两种风格在时空风格子空间上的加权求和来确定,数学表达式为γ=珚犚S·γ1+犚S·[αγ1+(1-α)γ2](14)其中犚S是一个对角阵,用于取得向量γ中对应时空风格子空间的元素γin,i∈js,也就是说对应时空风格子空间基向量的元素(犚S)i,i=1,i∈js,其它均为0.珚犚S=犐-犚S作用正好与其相反.α是权值,用于控制第一段运动的风格在最终结果中所占的比例.该方法简单快速,但并不直观,也不能方便地用于多种风格的混合.通过求解优化问题来合成运动风格能够直观地得到风格相对比较复杂的运动,而且可以实现运动混合不能实现的交互式编辑.对运动数据的任何一帧进行编辑并作为约束条件,求解式(15)所示的优化方程能够得到具备新风格的整段运动,这是由于向量γ建立在运动空间.因此,该优化问题也可以看作空时约束问题:其中犮即为约束帧,而函数G:犚S·γ狓(τ)是从风格子空间到视觉空间的人体姿态的映射.注意犚S·γ表示的是时空风格子空间的投影,因此求解该优化问题时只在时空风格子空间中进行解的搜索,其它子空间的参数全部用原始运动的投影表示,即每次迭代只改变时空风格子空间的投影以此来满足式(15).由于本文的运动模型封装了动态特性,因此还可以增加别的优化项来实现风格转换,如下式所示:γ=argmin第1项表示优化后的运动风格总体上要与原始运动风格尽量相似,即搜索要在原来的解附近进行.参数狓^的选择十分重要,可以先选择需要转换的两段不同风格的运动,然后采用简单的线性过渡,在脚接触地面或离开地面的关键帧前后混合成一段运动狓^,最后投影到独立特征子空间得到^γ.一般狓^的结果都不能令人满意,可以利用式(16)再进行优化计算,得到更加连贯真实的运动.另外,还必须恰当地指定关键姿态作为约束条件,即第2个优化项.其中犮为某个或某几个约束帧,函数H:γ狓(τ)是一个从独立时空特征空间到视觉空间的人体姿态的映射.权值λ控制指定的关键帧对结果的影响,该值越大,结果就越接近指定的关键帧.该优化问题能够实现风格之间的自然转换.由于本文使用的是半自动的时间对齐算法,将脚步与地面的接触信息包含在了可变形运动模型Page6中,因此合成结果基本上不存在滑步现象.但是当给定的约束偏离数据集过大时可能会出现这种不自然的现象,因此需要在得到的结果上再使用IK算法去除滑步.7实验结果与讨论7.1算法执行及实验结果本文从CMU运动捕获数据库①中选择了40段(即N=40)风格各异的行走运动序列作为数据集,包括自然、跨步、得意、男子汉般、行军、僵尸、僵直、蹑手蹑脚、正步和跛足等,并向下采样到每秒30帧.另外,选择了一段160帧(即T=160)的自然行走作为参考运动,构成标准时间轴,作为时间对齐操作的基准.独立时空特征空间模型狊由向量狌和狏组成,根据第4.3节的描述,可以将数据降到N维以下.为了保证能够恢复出自然的运动,我们分别将运动数据狌和时间对齐曲线狏降到30维和20维,即K=30,L=20.IFSA则将50维的狊向量重新投影到5个10维独立特征子空间,得到50维的向量γ,即k=10,J=5,而D=kJ=K+L=50.本文的所有矩阵运算与优化计算都采用了科学计算库GSL②,特别地,式(15)和(16)使用了最新版本的GSL提供的Levenberg-Marquardt非线性最小二乘算法.图4给出了基于式(14)的风格混合的实验结果,该例中将男子汉般行走运动和跛足行走(图4上)两种风格进行混合,可以得到男子汉的跛足运动(图4下).该方法可以有效控制跨步的步幅而不会带来滑步问题.同时,能够保留两种运动的部分动态特性.图5是使用式(15)进行风格编辑的例子,上图中夸张跨步的一个关键帧(显示为半透明)被重新编辑,减小了步幅和手臂的摆幅(显示为①),通过优化可以得到小跨步运动(见图5下),并且能够满足脚接触地面的约束条件.该编辑只在时空风格子空间内进行,优化搜索空间小,收敛速度快.证明了跨步步幅作为风格的重要成分已经被恰当封装在了时空风格子空间内.图6给出了一个从僵直行走转换到行军风格的例子.首先,将僵直运动狓1和行军运动狓2做线性过渡,过渡窗口选择以脚步接触地面的关键帧为中心,①②Page7从1到0变化的权值.然后将狓^与参考运动对齐,得到狊^,再投影到风格子空间.接着需要手动调整关键帧使它看上去更加真实,图中标注为①的虚拟角色表示手工编辑的关键帧,该关键帧可以控制风格转换的速度.最后建立如式(16)的优化方程并求解,这样可以得到看上去连贯自然的风格转换效果.演示本文最终实验结果的视频可以从该地址下载:http://www.cad.zju.edu.cn/home/liugengdai/video/style_liu.mp4.7.2结果分析时域特征是运动风格的重要组成部分,本文使用的独立时空特征空间封装了运动的动态特性,能够更精确地提取运动的风格.图7分别将IFSA作用于可变形向量狊和运动向量狕的结果,横坐标表示独立时空子空间的索引,纵坐标是40段运动与参考运动的Fj之差的平均值.从图中可以得出两个重要结论:首先,使用IFSA作用于可变形向量狊可以有效地分离出一个表征风格元素的子空间(第3个子空间);其次,仅使用运动向量狕提取风格的效果没有使用可变形向量狊的好.这是因为,IFSA具有提取高阶特征的能力,而狊向量本身封装了更多的信息.独立时空特征空间模型兼顾了运动的静态与动态特性,并能够有效封装风格元素,在低维运动混合与空时约束框架下能够求解出所需的运动.该方法主要有以下几个的优点:首先,允许用户在制定约束的情况下编辑运动风格,也可以通过指定关键帧来实现风格转换.其次,允许用户在任一关键帧下指定任意的运动学约束条件;第三,由于在时间对齐阶段手动标注了运动的关键姿态,因此合成的结果可基本满足环境接触约束,不会产生滑步等人为痕迹;最后,本文方法基于对大量运动样本的训练,因此编辑后的运动非常自然.IFSA的训练是一个比较耗时的过程,这是因为数据维数较高(50维)且每次迭代之后都要将向量重新正交化(保证得到的是正交的子空间).实验使用了Intel双核CPU和3GB内存的笔记本电脑,在该平台上,可以在3min内完成训练.另外,式(14)的运动混合可以实时完成,而式(15)和(16)的优化计算可以交互式的速度完成,如果选择较好地初始假设,一般在20~30次迭代即可收敛.表1列出了风格编辑与风格转换两种情况的迭代情况,包括迭代次数和每次迭代所需要的时间.从表中可以看出,风格编辑比风格转换需要更多的迭代次数但每次迭代需要的时间较短,这是因为,风格编辑的搜索空间较小但是初始运动与最终结果差别较大.另外,我们还分别使用狊向量与狕向量来进行风格编辑的操作,可以看到,使用狕向量的迭代次数要更多一些.同时我们对使用两种向量生成的结果进行了对比,两种方法都能够得到满足约束的跨步运动,且没有明显滑步现象,但是使用狕向量的结果没有得到较好的动态特性,如图8所示.图中可以看到使用狊向量的结果在时间上有更为丰富的变化.需要注意的是,算法合成的狕向量里面并不包含对齐信息,图8(b)中的对齐曲线是我们人为将它与参考运动进行时间对齐的结果.表1风格编辑与风格转换优化计算的性能对比合成模式风格编辑(狊)风格编辑(狕)风格转换图8分别使用狊和狕向量进行运动编辑的动态效果对比然而,本文方法仍存在以下几个局限.首先,最终生成的运动依赖于初始的数据集,因此对于那些与数据集偏差较大的约束条件,本文方法无法得到满意的结果.第二,本文使用的运动模型目前只能处理行走类的运动,如走、跑等.这类数据具有比较相似的空间与时间结构,容易提取特征,而且循环运动Page8更加遵循统计规律,因此,基于统计学习的方法比较适用于这类运动.第三,独立时空特征空间模型将运动的动态特性作为风格的一部分全部封装了起来,因此与Min的方法[15]相比,不能直接对运动的动态特性进行编辑.8结论与未来工作本文提出了一种满足用户指定约束的风格化运动编辑方法.该方法使用独立时空特征空间模型封装了运动数据在时空两个维度的特征,能够更好地处理运动的动态特性.独立时空特征空间模型集成了运动数据与时间对齐信息,并且包含利用独立特征子空间分析所提取的风格元素,允许用户在指定约束的同时编辑风格.编辑操作被数学化地抽象为低维运动混合和空时约束问题,通过求解该问题合成最终的动画序列.实验结果表明该方法计算效率高,具有良好的交互性与非常逼真的视觉效果,能够用于人体动画的交互式编辑和实时合成.虽然本文对于行走运动取得了较好的效果,但是下一步希望能够将该方法扩展到其它类型的运动中,这就需要对时间对齐和低维运动模型进行改进.另外,还希望提取更为具体的运动动态参数,比如跨步的步幅、跳跃的高度等,为了实现这个目标,可以尝试多因子分解的方法,如多线性分析,这样就能够分离出更加具体的多种风格元素,从而极大地丰富运动风格编辑的手段.这些都将作为今后的工作内容.
