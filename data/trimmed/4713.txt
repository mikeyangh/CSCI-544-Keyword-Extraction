Page1支持通信资源全局共享的射频片上网络研究肖春华刘韦辰(信息物理社会可信服务计算教育部重点实验室重庆400044)(重庆大学计算机学院重庆400044)摘要随着半导体集成电路的飞速发展,未来的片上芯片中将集成数百上千个处理核,以实现越来越复杂的功能.基于电气互连的片上网络在大规模片上系统中将很难满足未来高性能计算及多核处理器系统的通信需求.基于射频互连的片上网络能够以接近光的速度实现片内的低功耗远距离数据通信,是未来片上网络发展的重要趋势之一.现有的射频片上网络研究中,片上射频资源都为固定的射频通信节点独占,存在资源利用率不高,无法满足实时通信需求等问题.针对这些问题,该文首次提出基于共享射频互连的片上网络SRFNoC,并对其进行了清晰的刻画.在此基础上,提出基于集群共享的射频片上网络Club_SRFNoC,从网络拓扑结构设计、映射算法,共享信道的仲裁机制以及路由等方面进行了深入地研究.通过周期精准的实验仿真,Club_SRFNoC片上网络能够以43%(平均值)的片上射频资源,实现Club_ERFNoC片上网络相同的网络性能.关键词片上射频互连;片上网络;应用映射;仲裁;路由1引言随着CMOS工艺的进步和片上网络系统规模的增加,基于金属铜的片上互连面临着严重的性能及功耗瓶颈,将不再满足未来应用对高效能通信互连(高带宽、低时延、低功耗)的巨大需求①,光互连、射频互连等新兴片上互连逐渐成为取代传统电气互连的可能趋势.射频互连通过传输信道TL(TransmissionLine)中持续发送的电磁载波EM(ElectronicMagneticWave)进行数据通信(如图1所示),能够以接近光图1一个包含10条载波的射频互连传输链路表1光互连和射频互连与传统电气互连的比较设计需求CMOS兼容性性能优势(与传统基于铜的电气互连相比)可靠性设计挑战但是,如何在片上资源有限的条件下,高效率利用和分配有效的片上射频通信资源,是射频片上网络设计中一项非常具有挑战性的工作.虽然片上射频互连资源能够随着设计工艺的进步而增加,但在目前的技术条件下,支持更多的片上射频互连信道,意味着更高的设计复杂度以及难以接受的设计成的速度在芯片内实现低能耗的远距离数据1-hop传输,更为重要的是,射频互连还具有非常好的CMOS兼容性和灵活的可重构性,与光互连技术相比,更容易实现高效的片上互连(光互连和射频互连的比较如表1所示).基于射频互连的片上网络RFNoC(Radio-FrequencyinterconnectbasedNetwork-on-Chip),既能够充分发挥电气互连成本低廉、连接简单、适合短距离通信等优点,又能够充分利用新兴片上射频互连的高效率、低能耗、连接灵活、适合中长距离通信等优势,已经成为构建高能效片上网络的重要趋势之一.本.信道间的干扰,信号传输的可靠性等都是限制片上射频信道规模的瓶颈问题.因此如何高效地分配有限的片上射频资源,以最少射频资源开销获得最优的性能提升,是射频片上网络设计中的关键问题.通过对基于射频互连的片上网络的深入研究,本文发现,现有的射频片上网络都是基于独占射频互连的片上网络ERFNoC(Network-on-ChipwithExclusiveallocatedRadioFrequencyinterconnect),射频信道为特定的射频通信节点独享,存在资源利用率低,无法满足实时通信需求等问题.针对这些问题,本文首次提出基于共享射频互连的片上网络SRFNoC(NetworkonChipwithSharedRadioFrequencyinterconnect),并对其网络体系结构进行了清晰的刻画,在此基础上,提出基于集群共享的射①InternationalTechnologyRoadmapforSemiconductorsPage3频片上网络Club_SRFNoC,从网络拓扑结构设计、映射算法,共享信道的仲裁机制以及路由等方面展开了深入地研究.2基于射频互连的片上网络相关研究2.1国内外研究现状基于射频互连的片上网络是NoC研究领域中新兴的前沿性研究课题.第1篇射频片上网络研究文献发表于2008年,由加州大学洛杉矶分校(UCLA)的Chang、Cong和Reinman等教授领导[1]的研究小组提出,该文献获得了HPCA2008会议的最佳学术论文奖.UCLA研究小组在这篇文献中对片上射频互连的可行性,片上射频互连的传输特性,与电气互连及片上光互连的性能比较和分析等进行了详细的阐述,并提出了第一个基于射频的片上网络结构MORFI.在同年的MICRO会议上,UCLA研究小组从片上网络低功耗设计的角度对基于射频互连的片上网络进行了深入的分析和探讨[2].2009年,华盛顿州立大学及罗彻斯特理工学院的Ganguly等人[3]在NoC结构会议上(NetworkonChipArchitectures,2009)对基于wireless的混合片上网络结构设计进行了详细的介绍.2010年,研究者将基于射频互连的片上网络与基于光互连的片上网络进行性能评估、分析和比较,并对片上无线互连集成到3D片上网络的可能性等进行了探索[4].从2011年起,基于射频互连的片上网络研究已经成为片上网络研究的一个重要研究领域之一,并有多篇文献发表于IEEE及ACM的相关国际期刊及杂志[5-9].近几年来,国内在基于射频互连的片上网络领域也展开了相关的学术研究,包括清华大学[10]、国防科学技术大学[11]、南京大学[12]、哈尔滨工业大学[13]、电子科技大学[14]以及北京工业大学[9]等,并取得了一定的研究成果.2.2基于独占射频互连的片上网络ERFNoC根据射频通信资源分配策略的不同,目前已公开发表的射频片上网络可以分为两类:收发独占的射频片上网络(T_exclusive,R_exclusive)以及发送/接收独占的射频片上网络(T_exclusive/R_exclusive).收发独占的射频片上网络中(T_exclusive,R_exclusive),片上射频资源为固定的射频通信对之间的独占式资源[2].在整个应用执行周期内,特定的射频信道只允许1个固定的射频通信节点进行数据传送.每个射频通信信道也只有1个固定的射频数据接收节点.这类片上网络以片上通信轨迹可预估为设计前提,设计时需要根据准确完善的片上网络通信轨迹、通信数据以及通信开销,选择使得网络性能最优的射频通信对分配独占式射频信道,因此无法满足存在实时通信的应用需求.发送/接收独占的射频片上网络中(T_exclusive/R_exclusive),射频信道为特定射频通信节点的独有发送/接收信道[6,15].射频通信节点的片上接收器/发送器的接收频率/接收频率在整个应用执行周期内不变,对应的片上发送器/接收器的发送频率/接收频率,则根据当前的数据传送需求及信道的分配策略进行实时调频.这类片上网络要求至少为每一个射频通信节点分配1条独立的射频信道,当片上射频资源有限时,每条射频信道能够分配的信道带宽将很小,降低了各条射频信道的通信数据率.并且,当片上网络的通信模型非均匀时,将有大量的射频信道处于空闲状态,造成严重的片上资源浪费.本文将已有的两类射频片上网络:收发独占的射频片上网络(T_exclusive,R_exclusive)以及发送/接收独占的射频片上网络(T_exclusive/R_exclusive)统称为独占射频片上网络ERFNoC(NetworkonChipwithExclusiveallocatedRadioFrequencyinterconnect),其特征为射频信道为特定的射频通信节点独享,通过静态策略分配给固定的通信节点对或令牌策略分配给特定的发送/接收节点.针对这种独占式射频片上网络存在资源利用率不高,应用性不强,设计开销大等问题,本文提出基于共享射频互连的片上网络.3基于共享射频互连的片上网络针对独占射频片上网络的不足,我们提出基于共享射频互连的片上网络SRFNoC(NetworkonChipwithSharedRadioFrequencyinterconnect),实现射频通信资源的全局共享.在应用执行周期内,射频互连资源实时按需分配,射频通信节点可以根据通信需求,在特定通信周期内享有对某个频带资源的独占权.射频通信节点的片上发送器/接收器的发送频率/接收频率根据网络通信需求进行调频.一个典型的基于共享射频的片上网络体系结构如图2所示,网络系统由网络接口NI(NetworkInterface)、路由交换单元RS(RoutingSwitch)、射频节点RFNode,电气通信链路RClink以及共享射频传输链路RFlink组成.Page4图2基于共享射频互连的片上网络体系结构网络接口NI.实现处理单元(处理单元可以是处理器、存储器、硬件加速单元,输入输出设备等嵌入式IP核,承担系统的计算和存储任务)与片上网络之间的连接;路由交换单元RS.完成通信数据的路由及转发.根据输入输出端口的不同,路由交换单元分为基本路由交换单元(BaseRouter)和射频使能路由交换单元(RF-EnabledRouter);片上射频节点(RFNode).包含射频接收器、射频发送器、数据缓存单元、数据调制解调器、低通滤波器等,实现基于射频互连的数据接收、发送和处理;电气通信链路(RClink).包含1个或多个逻辑、物理信道,连接网络中的路由交换单元,实现通信数据的电气传输;射频传输链路(RF-ITransmissionLine,简称RF-TL或RFlink).片上射频传输的物理传输信道,信道中持续着不间断的电磁载波EM(ElectronicMagneticWave),通信数据通过幅度和/或相位的变化调制到载波进行数据的传输,实现基于射频的片上互连.基于共享射频的片上网络包括两级通信网络,底层通信子网和共享射频通信子网:底层通信子网(BaselineNetwork,BN).由路由交换单元及电气通信链路等构成的通信子网,实现基于电子电气的通信互联.底层子网中远距离节点对之间的通信,需要经过多次中间路由(Multi-Hops)实现.共享射频通信子网(networkwithsharedRF-I,SRFN).由射频使能路由器、射频节点以及射频传输链路等构成的通信子网,实现基于射频的通信互联.射频传输链路中有多条共享射频信道,网络的任意两个射频通信节点通过争用共享射频信道,实现直接通信(Single-HopCommunication).与独占射频片上网络相比(如表2所示),共享射频片上网络可以争用网络中的任一条共享信道发送数据信息,共享射频信道的实时按需分配,高效率利用片上射频通信资源,同时满足实时性通信需求和不同应用的通信需求.4基于共享射频互连的片上网络设计网络拓扑结构的设计、共享射频信道的实时动态分配以及网络通信路由是共享射频片上网络设计中的3个重要关键问题.Page5射频信道的使用方式射频信道的归属权是否满足实时通信需求射频信道的资源利用率是否满足均衡通信及非均衡通信应用的需求对片上射频资源的需求(N为射频通信节点个数)表2独占射频片上网络和共享射频片上网络的分析比较不支持全局共享的独占射频片上网络(ERFNoC)Texclusive,Rshared特定射频通信节点是低否至少有1条射频通信信道至少有N条射频通信信道至少有N条射频通信信4.1基于集群的共享射频片上网络拓扑结构共享射频片上网络为层级拓扑结构,包含底层通信子网和共享射频通信子网两个层级,底层通信子网由路由器(包括基本路由交换单元和射频使能路由交换单元)及电气有线互连组成,可以根据需要选择不同的拓扑结构,如二维MESH、星形或是环形等;共享射频通信子网由射频使能路由器、射频节点及共享射频互联组成,网络拓扑类似于“总线”结构,射频使能路由器通过射频节点连接到射频传输链路,实现与共享射频信道的连接.根据通信节点在芯片上的布局布线的不同,射频传输链路的物理实现拓扑结构不同,本文假定其在物理上为规则的曲形结构.本文所采用的基于集群的共享射频片上网络(Club_SRFNoC)拓扑结构如图3所示,底层通信子网在逻辑上划分为多个子MESH网格(Sub_mesh),图3基于集群的共享射频片上网络拓扑结构每一个子网格为一个逻辑子集群(cluster),每个集群共享一个射频通信节点(称为集群射频通信节点),通过该射频通信节点实现与其他集群内节点的射频通信.各集群射频使能路由器通过射频节点连接到射频传输链路,共享多条射频传输信道.基于集群的共享射频片上网络结构设计参数包括:子集群大小S、子集群个数Nc、共享数据信道带宽Bs以及共享数据信道的数量Ns.对于任意给定的设计输入,我们采用穷尽搜索算法(中规模片上网络)或启发式搜索算法(大规模片上网络),选择使得目标函数值SOF(SystemObjectiveFunction)最小的组合为最优的设计参数.本文的SOF由成本(Cost)和性能(Performance)两个部分组成,其计算公式可以描述为SOF=β×Performance+(1-β)×Cost(其中0β1),因此,最优设计参数组合可以描述为其中,Ti=∑(Pi,Qi),Pi={Si,Nci},满足Si×Nci=N,1<Si<N(Si,Nci都为正整数,N为网络中总的通信节点个数);Qi={Bsi,Nsi},满足Bsi×Nsi=Brf,且BrcBsiBrf(Bsi及Nsi都为正整数,Brc为电气输信道的带宽,Brf为射频通信资源总带宽).针对Club_SRFNoC结构特征,本文提出一种基于多路划分的层级应用映射算法MKHM(HierarchicalMappingbasedonMultilevelK-waypartitioning),该算法将映射进程分为集群的划分、集群的映射和集群内映射3个层级.集群划分是指,将通信轨迹图(CommunicationTraceGraph,CTG)划分为k个子集群(k路通信轨迹图KCTG,每个子集群称为1个超级节点),使得集群之间的通信度最小,即网络的切割边数最少,同样也将结构特征图(ArchitectureCharacterizationGraph,ACG)划分为相同大小的k个子网格结构(k路结构特征图KACG);集群的映射是指将划分好的K路通信轨迹图中的各超级节点映射到k路结构特征图KACG中的各逻辑子网格Sub_Mesh.通过将通信密切的子集群映射到相Page6邻的逻辑子网格,进一步减少了集群间的通信开销.集群内部映射是指,对完成了集群映射的各子节点群,实现集群内部各节点到子网格Sub-Mesh各资源节点的映射,最小化集群内部各节点之间的通信路由跳数.将1个包含16个节点的CTG图映射到1个分为4个集群的共享射频网络的流程如图4所示.首先采用多级K路划分方法(MutlilevelK-wayparti-tioning)[16],将16个节点划分到4个集群,每个集群称为1个超级节点SuperNode.另一方面,将通信特征图分为4个子集群,每个子集群称为1个超级资源节点SuperRouter.然后将KCTG中的各超级节点(如图4(b)所示)映射到KACG中的各超级资源节点.该步骤需要计算各超级节点的外连接度图4MKHM应用映射算法流程示意图最后一步是集群内部映射,将超级节点还原成处理节点,将超级资源节点还原成资源节点,并实现处理节点向资源节点的映射.集群内部映射分为3个部分:(1)射频通信节点映射.Club_SRFNoC结构中射频通信节点在拓扑架构中的位置固定,且位于各子网格的相同位置.映射时选择各子集群外连接度ED最大的节点映射到各子网格的射频资源节点位置.若有多个节点外连接度相等且都为最大外连接度时,则选择这些节点中内连接度最小的节点映射到射频资源节点.(2)边界点映射.将各子集群的边界点按照外连接度ED的高低依次映射到子网格的边缘资源节EDi(图4中EDc=6,EDa=4,EDb=3,EDd=4)以及各超级资源节点的资源度RDi(图4中RD1=RD2=RD3=RD4=2).然后根据以下两个原则进行映射:(1)各超级节点的外连接度高低依次选择映射的超级资源节点,外连接度高的超级节点首先选择超级资源节点,并且选择资源节点度较高的超级资源节点.(2)映射超级节点时,首先判断该节点是否与已映射的超级节点存在切割边,若存在,则将其映射到离该已映射超级节点距离最近的超级资源节点;若与已映射的超级节点之间不存在切割边,则将其映射到离已映射超级节点不相邻,且资源度较高的超级资源节点.点,或是距离射频通信节点较近的资源节点.(3)内点映射.最后按照内连接度高低将剩余通信节点依次映射到子网格的剩余资源节点,映射时判定当前映射节点是否与已映射节点存在通信边,若存在,则将其映射到距离已映射节点最近的资源节点;否则将其映射到与已映射节点不相邻的资源节点.4.2共享射频信道的实时动态分配机制共享射频片上网络的核心是射频通信节点对片上射频信道的全局共享,实现片上射频资源的实时合理分配和高效利用.如图5所示,为了描述共享射频信道的媒体访问控制问题,我们用集合F表示网络中的共享射频信道对应的频段;集合I表示网络Page7中射频通信节点对共享射频信道的资源请求信息,包括射频通信节点是否请求共享射频信道的信息以及该节点发送缓存中待传输数据微片的目的节点ID;集合S描述各射频通信节点当前的射频接收缓存状态;集合O描述片上共享射频信道访问控制的仲裁结果,包括射频通信节点在当前仲裁执行周期的射频接收频段及射频发送频段.对于1个包含k个射频通信节点的片上网络,共享射频信道的媒体访问控制问题可以描述为:给定包含k个元组的资源请求数据集I,在当前网络状态S以及约束参数c的条件下,通过某种仲裁策略Arbitration,得到1个共享射频信道的分配集合O,即O=Arbitration(I,S,c).其中:Input:I为包含k个元组的二维数据集.集合中的任意元组r∈I,有r={r.request,r.desti},其中r.request∈{0,1}描述网络中的通信节点p在当前周期是否有共享射频信道的资源请求;r.desti∈K∪描述网络中的通信节点p的发送缓存中待传输数据微片的目的节点ID.State:S为包含k个元组的一维数据集.集合中的任意元组s∈S,有s∈{0,1},描述射频通信节点p的射频接收缓存状态;c为约束参数,描述当前网络中的共享射频信道的资源总数.Output:O为包含k个元组的二维数据集.集合中的任意元组w∈O,有w={w.rx,w.tx},其中w.rx表示射频通信节点p在仲裁执行周期的射频接收频段,w.tx的表示射频通信节点p在仲裁执行周期的射频发送频段其中w.rx,w.tx∈F,w.rx≠w.tx;且i,j∈O,当i≠j时,i.tx≠j.tx;本文采用基于流仲裁的共享射频信道动态分配机制[9],将片上射频资源划分为多个共享的通讯信道,包括多个共享数据信道(datachannels)和1个仲裁信道(arbitrationchannel).其中,数据信道用于射频通信节点对之间的数据通信,仲裁信道用于仲裁信息流的传送.流仲裁策略为分布式仲裁机制,无中央仲裁器,各射频通信节点将当前周期的资源请求信息及缓存状态信息,通过射频发送器调制到仲裁信息流,然后根据所有射频通信节点的仲裁信息判断是否能够获得共享射频信道以及是否需要接收来自某个频段的数据信息.在仲裁周期内,仲裁信息流两次流经所有的射频通信节点,trip1实现子仲裁信息流的调制,trip2将完整的仲裁信息流传送给各射频通信节点.射频通信节点通过仲裁信息流竞争共享数据信道的使用权.随着片上规模的扩大,单芯片上集成的处理核心数量将急剧增加,射频使能节点之间的仲裁距离也将增加,导致仲裁信息流无法在单周期内经由所有的射频通信节点.另外,由于每个射频使能节点都有可能调制子仲裁信息流,因此单次仲裁所调制的仲裁信息量也将随着节点个数的增加而急剧增加.以及流仲裁策略在大规模片上通信中的不足,在大规模片上网络中,本文采用层级流仲裁机制(HierarchicalStream_Arbitration).为了便于区分,将前文描述的流仲裁策略称为“平级流仲裁(FlatStream_Arbitra-tion)”.层级流仲裁机制采用两级射频传输链路:本地射频传输链路(LocalTransmissionLine,L-TL)和全局射频传输链路(GlobalTransmissionLine,G-TL).每个集群共享1个射频使能节点,相邻的多个集群称为群组(Sets),每个群组共享1条本地射频传输链路(LocalTransmissionLine,L-TL),用于群组内部的集群间射频通信;全局射频传输链路(GlobalTransmissionLine,G-TL)用于群组间的射频通信.各个群组实行独立的平级流仲裁策略,群组间实行层级流仲裁策略.图6显示了1个包含4个群组的层级流仲裁结构.该结构中每个群组包含16个射频使能路由器.每个群组都有独立的卷曲形仲裁信道及规则数据信道.4个群组共享全局射频传输链路的卷曲形仲裁信道和数据信道.因此,该片上网络将有5条并行仲裁信息流.该示例中每16个射频使能节点共享1条本地射频传输链路,4个承接节点共享1条全局射频传输链路,所以每条射频传输链路中的仲裁信息流调制、接收以及数据信息传送,都能够在单个时钟周期内完成.假设图中的节点A想要发送数据信息给在同一个群组的节点B,节点A只需要参与本地的平级流仲裁,而每次的仲裁需要3个时钟周期,其中1个时钟周期用于子仲裁信息流调制,1个时钟周期用于仲裁信息流接收,1个时钟周期用于仲裁Page8信息解析.若节点A在仲裁中获胜,将通过所获得的本地数据信道传输数据给节点B.若节点A想要发送数据信息给不在同一个群组的节点B,需要首先参与节点A所在群组的本地流仲裁(LocalTL1),然后利用获胜的本地数据信道将数据信息传送给节点A所在的群组的承接节点RelayNode1.数据信息到达RelayNode1后,将参加全局流仲裁争用全图6层级流仲裁机制示意图4.3共享射频片上网络中的网络通信路由策略基于共享射频的片上网络中,通信数据从源节点到目的节点的路由传送路径routing_path可能有3种情况:一是只经由路由交换单元和电气通信链路实现通信数据的传送,即routing_path{NI,RS,RClink};另一种是只经由路由交换单元、射频节点及共享射频通信链路实现通信数据的传送,即routing_path{NI,RS,RFNode,RFlink};还有一种是既包含路由交换单元和电气通信链路,又包含射频节点及共享射频通信链路的数据传输路径,即routing_path{NI,RS,RClink,RFNode,RFlink}.集群共享射频片上网络中的通信分为集群内部通信和集群间通信.根据网络拓扑结构特征,本文在集群内部通信采用XY路由策略,集群间通信采用最短路径路由策略.在集群共享射频片上网络中传输的数据,除了携带源节点地址信息和目的节点地址信息之外,还预留射频传送标志位以及目的集群ID信息位.射频传送标志位用于标识该数据包在路由路径中是局数据信道.若在全局流仲裁中获胜,数据信息将通过全局数据信道从RelayNode1发送到目的节点B所在群组的承接节点RelayNode3,数据信息到达RelayNode3后将参与目的节点B所在群组的流仲裁,并通过获得的本地数据信道传送给目的节点B.因此,群组间的射频通信需要经过3次流仲裁,完成数据传送至少需要9个时钟周期.否选择集群间共享高速射频信道,目的集群ID用于描述该数据包目的节点所在的集群ID号.另外,网络中的每一个路由器都预置集群分布表CDT(ClusterDistributionTable),CDT记录了网络中每一个路由器对应的集群ID以及每一个集群中射频使能路由器的地址信息(每一个集群共享一个射频使能路由器).当通信数据进入片上网络时,由源路由器节点的预路由单元判定其是否选择集群间的共享高速射频信道,并将判定信息(射频传送标志位以及目的集群ID)写入头微片.共享射频片上网络中的预路由算法伪代码如图7所示,预路由单元首先根据预置的CDT表判定数据包的目的节点是否与源节点在同一个集群,如果是,则将头微片中的射频传送标志位写为“0”,标记该数据为集群内部通信数据,采用XY路由策略进行传输;如果数据包的目的节点和源节点在同一个集群,则计算从源节点到目的节点的路由跳数H_rc和H_rf,如果H_rc<H_rf,判定该数据包不选择集群间射频传输信道,将射频传送标志位置“0”;如果H_rcH_rf,判定该数据包Page9选择集群间射频传输信道,将射频传送标志位置“1”,并将该数据目的地址所在的集群ID号写入头微片中相应的比特位.这里H_rc是指采用XY路由策略及电气互联链路,数据包从源节点s到目的节点d的路由跳数;H_rf是指当传输数据采用集群间共享射频信道进行传送时,从源节点s到目的节点d的路由跳数,包括从源节点s到源节点所在的集群射频使能节点RFs的路由跳数(XY路由策略)以及从目的节点所在的集群射频使能节点RF到目的节点的路由跳数(XY路由策略)以及射频互连的路由跳数,即H_rf=H_(s→RFs)+1+H_(RFd→d).Club_SRFNoC_Prerouting(Flit(S(s_x,s_y),D(d_x,d_y)),CDT)Input:(1)Flit(S(s_x,s_y),D(d_x,d_y));//TheheadflitenteredNoC(2)CDT;//ClusterDistributionTableOutput:(1)RFC;//ThesignfortheRFcommunication(2)Cluster_ID;//TheClusterIDforRFcommunicationFunction:(1)FortheheadflitenteredNoC,deceidewhethergothroughRF-Ibetweenclusters.(2)IftheflitwillgothroughRF,gettheclusterIDforRFtransmission.Procedurebody:{var:Cluster_IDs,Cluster_Idd,Hrc,Hrf,RFC,Cluster_ID;//CheckwhetherthesourceanddestinationoftheFlitareinthesameclusterCluster_IDs=(IDT,S);Cluster_IDd=(IDT,D);//ifthesourceanddestinationoftheFlitareinthesamecluster,chooseRCchannelsif(Cluster_IDs=Cluster_IDd)RFC=0;else{//ComputetheroutinghopswhentheflitonlychooseRCchannelsHrc=|s_x-d_x|+|s_y-d_y|//computetheroutinghopswhentheflitchoosesharedRF-IbetweenclustersHrf=Hop_Counts(Cluster_IDs,S)+1+Hop_Counts(Cluster_IDd,D)//TodecidewhethergothroughRFaccordingthehopcountsif(Hrc<Hrf)RFC=0;else{RFC=1;Cluster_ID=Cluster_IDd;}returnRFC,Cluster_ID;}图7集群共享射频片上网络中的预路由算法伪代码集群共享射频片上网络的路由算法伪代码如图8所示,路由计算模块首先检测头微片中的射频传送标志位,若为“0”,表明该数据的路由路径不包含共享射频信道,根据微片中携带的目的地址,按照XY路由计算算法,指定有效地虚通道.若射频传送标志位为“1”,表明该数据的路由路径包含射频传输信道,继续判定头微片中目的集群ID.若目的集群ID与当前路由器所在的集群ID相同,根据微片中携带的目的地址,按照XY路由计算算法,指定有效地虚通道;若目的集群ID与当前路由器所在的集群ID不同,且当前路由节点为集群的射频使能路由器节点,则指定有效虚通道,将微片从路由器射频输出端口发送.若目的集群ID与当前路由器所在的集群ID不同,且当前路由节点为规则路由器节点,则以当前路由器所在集群的射频使能路由器为目的节点,按照XY路由计算算法,指定有效的虚通道.Club_SRFNoC_Routing(Flit(S,D,RFC,Cluster_ID),Router_address,IDT);Input:(1)Flit(S,D,RFC,Cluster_ID);//Theinformationofroutingflit,includingsourceaddressS,destinationaddressD,RF//communicationsignRFC,andCluster_IDforRFcommunication(2)Router_address;//Theaddressofthecurrentrouter(3)CDT;//ClusterDistributionTableOutput:Port(Flit)//TheoutputportfortheroutingFlitFunction:FindtheoutputportfortheroutingFlitwhentheflitProcedurebody:{var:Port(Flit),Cluster_RF;//ChecktheRFcommunicationsignRFCif(RFC=0)//TheroutingFlitonlychooseRCchannelsPort(Flit)=(XY_routing,D);//Findtheoutputportaccordingelse{if(Cluster_ID=current_cluster_ID)Port(Flit)=(XY_routing,D);else{if(Router_address=addressoftheRFenabledrouterofcurrentcluster)Port(Flit)=(RF_output);//sendfromRFportelse//ifcurrentrouterisnotRFnode,sendthisflittotheRFnodeofcurrentcluster{Cluster_RF=(IDT,Router_address);Port(Flit)=(XY_routing,Cluster_RF);}}}returnPort(Flit);}图8集群共享射频片上网络的路由算法伪代码5共享射频片上网络的仿真及评估本文通过拓展的SIMICS[17]及GEMS[18]仿真平台来构建基于射频的片上网络仿真环境.SIMICS是系统级的硬件平台仿真软件,能够仿真整体硬件平台,包括各计算和控制子节点以及节点之间的网络链接等;GEMS是WINSCONSIN大学提供的一种多核模拟器,能够在全系统的环境下负责解释程序的执行.通过拓展的SIMIC+GMES仿真框架,能够实现基于射频的片上网络的周期精准的全系统模拟.基于射频的片上网络主要针对高性能计算及未来的大规模片上网络系统.在这样的系统中,单一的以成千上百个相同处理器作为系统处理核心的设计方法不能够满足高效能计算的需求.为了以更低的功耗开销获得更高的网络吞吐量等性能,主流设计通过增加各种专用加速器模块来达到设计目标.因此,本文所仿真的片上网络结构采用UCLA大学专用领域Page10计算中心研究小组所提出的CHARM(ComposableHeterogeneousAccelerator-RichMultiprocessor)结构[19],在满足未来高性能计算的片上网络结构特征的同时,能够有助于加速仿真.5.1实验测试基准及评估参数一方面,随着片上系统规模的增加,片上多处理器系统的仿真难度增加,需要耗费大量的仿真时间.另一方面,未来的高性能计算应用呈现出新的通信特征,无法以现有的通信应用作为代表.因此,出于仿真速度及实验评估代表性等方面的考虑,本文在小规模片上网络的评估时,主要采用实际的应用通信轨迹,在中大规模片上网络评估时,采用基于概率模拟的合成通信轨迹.(1)实际的应用通信轨迹本文实际的应用通信轨迹包括4个来自医疗领域的应用:Deblur,Denoise,EKF_SLAM,Regis-tration以及1个来自PARSEC基准套件的应用:BlackScholes.应用通信轨迹由UCLACDSC实验室的CHARM研究小组提供,通过在Simics中执行实际的应用,提取出应用的通信轨迹信息,包括通讯消息到达的时间(进入通信网络的时间)、通讯消息的源地址、目的地址以及通讯消息的数据大小等.每个通信轨迹作为仿真输入,在GEMS仿真平台中执行5000000个时钟周期(或是应用执行结束),得到相应的仿真结果.(2)基于概率模拟的合成通信轨迹基于概率模拟的合成通信轨迹,包括均匀通信模型uiniform,单向数据流模型(unidirectionalDataFlow,uniDF),双向数据流模型(bidirectionalDataFlow,biDF),带热点的双向数据流模型(hotdirectionalDataFlow,hotbiDF)以及热点模型(1Hotspot,2Hotspot,4Hotspot).基于概率模拟的合成通信轨迹由通信轨迹生成器(probabilistictracegenerator)产生.合成通信轨迹中的处理节点包括处理器、二级缓存及外部存储控制器,轨迹生成器根据各类型处理节点的个数,各处理节点的信息注入概率,时钟周期计数,各类型处理节点之间的通信概率以及不同处理节点之间的通信分布概率,生成符合特定通信模型特征的通信轨迹.每个测试通信轨迹在仿真平台中执行百万个时钟周期,从而保证测试数据的可靠性.本文评估射频片上网络系统的主要参数包括:网络延时、网络通信能耗以及射频信道利用率.网络传输延迟(AverageNetworkLatency/flit)是指通信数据从源节点到目的节点的平均时间开销.网络通信能耗(AverageEnergyConsumption/flit)是指通信数据从源节点到目的节点的平均能耗.射频信道利用率是指特定信道传送的数据微片占所有射频信道传送微片的百分比.5.2实验评估5.2.1MKHM应用映射算法评估本小节评估了3种面向Club_SRFNoC结构的应用映射算法:MK+RA映射算法、ILP+RA映射算法以及本文采用的MK+HM算法.MK+RA映射算法是指,采用层级多路划分算法将通信轨迹图划分为k个子集群,并将每个子集群随机映射到各子网格;ILP+RA映射算法是指,采用文献[20]提出的基于整数线性规划的映射算法,将通信轨迹图中的各处理节点映射到基于Mesh的片上网络各子区域,然后再随机选取各子区域中任意一个节点映射为射频通信节点;MK+HM映射算法即本文所采用的方法,采用层级多路划分算法将通信轨迹图划分为k个子集群,并采用层级映射的算法实现各子集群内节点的映射及射频通信节点的映射.集群共享射频片上网络的应用映射算法的实验评估结果如图9(a)及图9(b)所示,图中以MK+RA映射算法的仿真结果为归一化基准.图9(a)给出了3种应用映射算法的归一化平均网络延时,图9(b)给出了3种应用映射算法的归一化网络能耗,图中第1个柱形条表示MK+RA映射算法,第2个柱形条表示ILP+RA映射算法,第3个柱形条表示本文提出的MK+HM算法.从图9(a)及图9(b)可以看出,本文所提出的MK+HM算法,与MK+RA映射算法及ILP+RA映射算法相比,分别能够减少8.92%和15%的平均网络延时以及10%和19.2%的网络能耗.MK+HM映射算法表现优秀的原因很明显,该算法与其他两个算法相比,在最小化集群间通信量的基础上,通过层级映射算法进一步减少集群间及集群内部节点之间的通信路由跳数.并且MK+HM映射算法充分考虑和结合了集群共享射频片上网络的拓扑结构特点,将各子集群中外连接度最大的节点映射到各子网格的射频资源节点位置,将各子集群的边界点按照外连接度高低依次映射到子网格的边缘资源节点,或是距离射频通信节点较近的资源节点,这些因素都有助于提高集群间的通信效率.Page11图9Club_SRFNoC采用不同应用映射算法时的5.2.2Club_ERFNoC和Club_SRFNoC的评估为了分析和对比独占射频片上网络和共享射频片上网络,本小节评估了集群独占射频片上网络Club_ERFNoC和集群共享射频片上网络Club_SRFNoC,都采用本文所提出的基于集群的设计方法,MKHM应用映射算法和基本路由策略.两种网络中都包含128个处理节点,底层电气通信子网为二维MESH结构,在逻辑上划分为16个子集群,每个子集群共享1个射频通信节点.所不同的是集群独占射频片上网络为现有的射频片上网络中射频资源利用率最高的接收独占射频片上网络,即每个子集群独占1条射频通信信道,当其他子集群想要通过射频通信的方式给特定子集群发送数据信息时,通过令牌仲裁获得该接收信道特定执行周期的使用权.集群共享射频片上网络中,所有的射频信道为网络中的射频通信节点共享,通过流仲裁机制获得某条信道在特定执行周期的使用权.为了能够分析不同射频资源条件下,两种射频通信网络的性能和能耗,实验分别仿真了当片上射频带宽从64Bytes/cycle逐渐增加到256Bytes/cycle时的网络性能.由于集群独占射频片上网络中每一个子集群都需要分配1条独占的射频通信信道,因此其射频信道带宽为Brf=B/N,其中B为总的射频资源带宽,N为子集群个数.集群共享射频片上网络中,由于信道都属于全局共享,因此射频信道的通信带宽分配不受信道数量的约束,实验中将共享射频信道数量固定为6条(其中1条为仲裁信道,5条为共享数据信道),每条信道带宽随着片上射频带宽资源的增加而增加.图10Club_ERFNoC与Club_SRFNoC的归一化平均由于篇幅的限制,我们在图6中只给出了射频带宽分别为64Bytes/cycle、128Bytes/cycle和256Bytes/cycle时的仿真结果.图6显示了Club_ERFNoC与Club_SRFNoC结构对5个通信轨迹的性能和能耗的归一化数值,以二维MESH结构(即传统的基于电气互连的MESH网络)为归一化基准,其中柱形条表示平均网络延时,菱形标识表示网络的平均能耗.从仿真结果可知,Club_SRFNoC网络能够以很少的片上射频资源开销获得较好的片上网络性能.如图10所示,当片上射频资源为256Bytes/cycle时,Club_SRFNoC和Club_ERFNoC都能够减少70%左右的平均网络延时(以Mesh为比较基准),但是,Club_SRFNoC片上网络能够以很少的片上射频资源开销获得更好的网络通信性能,Club_SRFNoC只需要98~176Bytes/cycle的片上资源便可达到Club_ERFNoC片上网络在资源为224~256Bytes/cycle的网络性能.在本文仿真的5个应用中,随着片上射频资源的增加,共享射频信道数量的增加所带来的性能增益不断减少,表明在任何给定时刻,片上网络中的部分射频通信节点负责网络中绝大多数的数据通信.对于所仿真的5个应用,Club_SRFNoC片上网络,只需要约112Bytes/cycle的片上射频资源就能够满足片上网络的通信需求,而基于Club_SRFNoC的片上网络需要2倍的片上资源(240Bytes/cycle)才能达到相同的通信性能.在特定的设计节点(相同的片上射频资源时),射频片上网络的能耗差异与性能差异具有一定的关联性.当片上射频资源有限时,由于Club_SRFNoC片Page12上网络中共享射频信道的高带宽,与Club_ERFNoC网络相比享有更高的仲裁成功率,因此只需要占用射频信道很少的仲裁执行周期就能够实现完整数据的传送,所以消耗更少的平均网络通信能耗.当片上射频资源充裕时,基于Club_SRFNoC及Club_ERFNoC有着基本相等的仲裁成功率,能耗相差不大.图11显示了当片上射频资源为128Bytes/cycle时,集群独占射频片上网络及集群共享射频片上网络的射频信道利用率(图中横坐标为射频信道的编号,纵坐标为各应用通信轨迹中特定信道传送的数据微片占所有射频信道传送微片的百分比).从图中图11Club_ERFNoC及Club_SRFNoC的射频信道利用率可以看出,独占射频片上网络中独占射频信道的利用率最高为14%,最低的利用率为3%,也就是说在应用执行周期,有的独占射频信道完全处于空闲状态.共享射频片上网络中射频信道的利用率最高为41%,最低的利用率为9%,共享射频信道1到射频信道5的平均利用率分别为35%,24%,18%,14%以及8%,这表明随着共享射频信道数量的增加,信道的利用率逐渐降低,当射频信道数量大于一定的数值后,增加的射频信道利用率非常低,从而造成片上射频资源的浪费.虽然共享射频片上网络SRFNoC能够通过提高信道利用率大幅提升网络通信效率,但是面临着扩展性的问题.在性能方面,随着片上网络中射频使能节点个数的增加,射频传输链路的距离也将加长,仲裁信息流无法在单周期内经由所有的射频通信节点,仲裁流从网络中第1个射频使能节点到最后1个射频使能节点的传输延时增加到P个时钟周期(P>1).随着P的增加,网络数据成功争用1条射频数据信道的时间开销将大幅增加,影响到系统的平均网络延时.在功耗方面,随着片上网络中射频使能节点个数的增加,单次仲裁所调制的仲裁信息量增加,调制/解调仲裁流所需的功耗开销也将随之增加.若N值(其中N为射频使能节点的个数)相对较小时,仲裁信道的功耗开销与数据信道传输射频信息的功耗开销相比,基本可以忽略不计.但是随着N值的大幅增加,仲裁的功耗开销在系统功耗中的比值增加,能够在一定程度上影响到系统的总开销,成为影响系统低功耗设计的因素之一.因此,如果在大规模片上网络中(片上集成的处理核心为数百上千个),若SRFNoC仍然采用前文所述的流仲裁策略,将面临着严重的仲裁开销问题.针对该问题,本文提出了基于层级流仲裁策略的Club_SRFNoC的可扩展性设计.5.2.3Club_SRFNoC的可扩展性设计本文针对中大规模片上网络,采用基于层级流仲裁策略的共享射频片上网络结构.为了评估集群共享射频片上网络的可扩展性,本小节仿真了3个中大规模的片上网络,网络中的路由器节点及处理节点规模分别为16×16,24×24及32×32.本小节仿真两种共享射频片上网络结构,一种是基于层级流仲裁策略的共享射频片上网络结构(HierarchicalStream_Arbitration简称“HStream”),另一种是基于平级流仲裁策略的共享射频片上网络结构(FlatStream_Arbitration简称“FStream”).Page13当仿真的片上网络规模增加到成百上千时,需要数周甚至数月的时间,才能完成针对实际应用的全系统仿真,这使得仿真的分析及评估变得极为困难.因此本节利用基于概率模拟的合成通信轨迹作为实验测试基准.为了模拟大规模片上网络系统通信的“局部性”特征,本文基于概率模拟的合成通信轨迹中有约60%的通信为群组内通信,剩余40%的通信根据通信轨迹特征的不同基于概率合成,各通信轨迹的通信特征详见本文5.1节.层级共享射频片上网络中,我们为每个群组及全局射频通信各自分配2条带宽为16Bytes的共享射频数据信道.为了评估的公平性,为平级共享射频片上网络中分配的射频信道数量及总带宽等于层级结构中所有射频信道数量及带宽的总和(带宽仍然为16Bytes/cycle).层级共享射频片上网络(图以“HStream”描述层级共享射频片上网络,以“FStream”描述平级共享射频片上网络)结构的归一化平均网络延时如图12所示,图中显示结果以32×32的平级共享射频片上网络的仿真结果为归一化基准线.从图中可以看出,在中大规模片上网络中,层级共享射频片上网络与平级共享射频片上网络相比,能够减少约40%(40%为平均值,范围为28%~55%)的平均网络延时.实际上,所仿真的5个通信轨道,其片上射频资源仲裁及数据传输所带来的延时开销几乎相同(因为5个应用的本地通信概率相同),层级共享射频片上网络和平级共享射频片上网络的平均网络延时的差异主要来源于层级共享射频片上网络及平级共享射频片上网络的仲裁成功率.随着片上网络规模的增加,层级共享射频片上网络的群组间通信量保持不变,增加的片上网络通信分散在各个群组,且集中在本地群组内部,不会导致全局通信量的剧增.图12采用层级流仲裁的共享射频片上网络的平均网络延时另外,虽然层级共享射频网络中增加了承接节点的缓存延时,但是实验表明,大多数群组间的通信信息都能够在到达承接节点的第2个时钟周期,获得全局共享数据信道.而平级共享射频片上网络中,射频信道数量的增加并没有缓解通信节点之间的资源竞争,即便是近距离集群之间的通信,也需要与网络中所有的射频通信节点竞争共享射频信道,仲裁信道中的仲裁信息流数据量庞大,仲裁信道及所有的共享数据信道都需要贯穿整个芯片且连接所有射频节点,这些都增加了平级共享射频片上网络的通信延时.因此,在中大规模片上网络中,层级共享射频片上网络的平均网络延时要低于平级共享射频片上网络.层级共享射频片上网络(以“HStream”描述层级共享射频片上网络,以“FStream”描述平级共享射频片上网络)结构的归一化网络功耗如图13所示,图中显示结果以32×32的平级共享射频片上网络的仿真结果为归一化基准线.图中每个柱形条的两种颜色分别显示了片上网络的仲裁功耗及数据传输功耗.其中数据传输的功耗中包括了网络接口及射频节点的功耗.层级射频片上网络中由于层级的划分,仲裁所需传输的信息流大幅减少,从而减少了仲裁信息流的数据传输能耗.如图13所示,层级射频片上网络的仲裁功耗与平级射频片上网络相比,减少了40%~60%,并且片上网络规模越大,仲裁开销对总的网络功耗的影响就越突出.由于在层级射频片上网络中,不同群组之间的全局通信信息需要进行两次调制/解调及暂存,在一定程度上增加了数据传输功耗.但是与群组内的通信量相比,大规模片上网络中的全局通信量不高,因此层级射频片上网络的仲裁功耗与平级射频片上网络相比,只增加了3%~16%的数据传输功耗.层级射频片上网络Page14图13采用层级流仲裁的共享射频片上网络的功耗中增加的传输功耗对片上网络的整体功耗的影响并不十分明显,从仿真结果可以看出,层级共享射频片上网络与平级共享射频片上网络相比,总的网络功耗平均增加6%(平均值).6小结本文针对现有的射频片上网络中存在的资源利用率较低、无法满足实时通信需求等问题,首次提出了基于共享射频互连的片上网络SRFNoC,并对其网络体系结构进行了清晰的刻画.在此基础上提出了集群共享射频片上网络Club_SRFNoC结构,采用MKHM算法实现最优化的应用映射,利用流仲裁机制实现共享射频信道的轻量级分布式高效仲裁,集合XY路由策略和最短路径路由策略实现通信资源的实时优化分配.通过周期精准的仿真及验证,Club_SRFNoC片上网络能够以43%(平均值)的片上射频资源,实现Club_ERFNoC片上网络相同(100%)的网络性能.Club_SRFNoC能够通过实时动态分配射频通信资源,满足不同应用实时通信需求的同时,大幅提升信道带宽利用率,从而提升网络整体性能.本文假定片上射频通信节点只配置1个可调频片上收发器,这在一定程度上限制了共享射频片上网络对通信特征非均衡应用的性能提升.若改进片上发送器/接收器,支持多频段的数据收发,将有可能进一步提升共享射频资源的利用率.另外,当片上射频资源一定时,共享射频信道的数量和共享射频信道的带宽之间存在最优的折中策略.不同的应用对共享射频信道的“多、窄”,“少、宽”特性表现出不同的片上网络性能.对于特定的应用,如何优化设计片上收发单元,如何分配共享射频信道带宽等问题,将是本文下一步研究工作重点.
