Page1MFT2-BGP:基于多转发树的无中断域间路由协议胡乔林1)彭伟2)陈新1)苏金树2)1)(空军预警学院五系武汉430019)2)(国防科技大学计算机学院长沙410073)摘要BGP通过触发全局、反应式收敛应对链路或节点失效引起的拓扑变化,然而BGP协议收敛时间长、收敛过程中的瞬时失效严重降低了数据平面转发性能,难以支持关键业务流量.该文提出了容忍失效的MFT2-BGP,通过利用路径标识符以较低的消息开销构造符合BGP策略的多转发树,使得每个AS获得多样性路径,当出现瞬时失效时,在不改变协议动态性的情况下,允许节点动态切换报文转发路径以实现无中断报文转发,通过嵌入“失效根源信息”以降低收敛时间,抑制瞬时失效以降低路由系统的扰动.通过在Internet-like拓扑上的大量实验表明,在链路失效场景中与其它协议相比,MFT2-BGP能有效改善收敛时间,降低转发中断时间,改善路由系统稳定性.关键词域间路由;瞬时失效;多转发树;多路径;快速恢复1引言Internet已经发展成为重要的通信基础设施,承载了许多如VoIP、在线游戏、远程医疗等对延迟及中断敏感的关键业务,然而Internet却容易遭到破坏,例如软硬件故障、误配置、攻击等因素都会造成网络失效.通过对Sprint骨干网链路故障进行分析[1],人们发现失效几乎每天都会发生,且90%属于瞬时性故障.理想的路由协议应保证只要底层拓扑连接就能提供持续通信.然而BGP协议[2]缺乏生存性保证,在失效时仅触发全局、反应式收敛应对拓扑变化,相对于IGP秒级的收敛,BGP由于大量“路径探索”[3]以及MRAI和WRATE定时器的限制,导致收敛时间甚至达到30分钟[4],这进一步恶化了转发中断.Katz-Bassett等人[5]发现即使多宿主AS并不总能实现容错,BGP导致大量多宿主AS经历不可达事件,持续时间甚至长达数小时或天,其数量与持续时间都远超预期,严重降低数据平面的转发性能.Wang[6]通过对顶级ISP进行测量,发现BGP收敛期间的动态性造成大量路由器经历瞬时路由失效、环路,即使在失效切换和链路恢复时路由黑洞也会造成数十秒的报文丢失.可达性是路由协议的顶级目标,研究者通过加速收敛以降低失效对转发中断的影响,包括GhostFlushing[7]、EPIC[8]等通过抑制或嵌入“失效根源”信息以快速作废非法路径,但GhostFlushing、EPIC在Internet-like拓扑下,其加速收敛效果并不明显.而且由于多数是瞬时失效,过快收敛反而给路由器增加负担,带来路由的不稳定性.加速收敛并不能满足关键应用需求,也不能消除收敛过程对转发中断的影响.一些研究工作集中于扩展BGP,比如MIRO[9]、R-BGP[10]、Splicing[11]、Consensus[12]、YAMR[13]等采用预计算备份路径的方法,不同程度上暴露底层拓扑冗余路径,但这些协议AS之间的备份路径缺乏协调可能形成环路,也并不能保证每个AS获得多样性路径,且部分协议难以实现完全无中断转发.针对抑制瞬时失效、无中断报文转发、低开销的需求,本文提出了通过构造多转发树容忍失效的域间路由协议(MultipleForwardingTreeandFailureTolerantBGP,MFT2-BGP)以实现快速路由恢复,其主要面临如下挑战:(1)在标准BGP中,AS节点无全局拓扑,使得每个AS难以获得、区分多样性路径;(2)在构造多转发树时要求降低收敛时间,并保证处理开销在合理范围内;(3)保证报文在多转发树之间切换时不会形成环路.为此,MFT2-BGP设计主要包括3个关键部分,即控制平面的多转发树构造、加速收敛与瞬时失效抑制、数据平面无中断报文转发算法.该协议的特点在于:(1)充分利用底层冗余拓扑,提供可保证的结构化多样性路径,避免了备份路径之间可能的环路;(2)抑制瞬时失效,避免失效全局可视化,增强了BGP系统的稳定性;(3)从数据平面保护流量,采取本地先验式的方法处理瞬时失效引起的报文丢失,支持关键业务的应用;(4)具有可扩展性、兼容性,便于增量部署.本文第2节介绍相关工作;第3节描述问题模型;第4节设计MFT2-BGP协议框架以及控制平面的多转发树构造、加速收敛、失效抑制以及报文转发算法;第5节对协议的正确性进行分析;第6节通过模拟验证MFT2-BGP的收敛性以及无中断转发性能;最后对本文工作进行总结.2相关工作当前大部分研究工作主要利用冗余路径以应对出现的失效,IETFRTGWG工作组致力于IGP协议的IPFRR(IP快速重路由),比如Deflections[14]等,其主要思想是为可能出现的链路、节点失效预计算备份路径.Medard等人[15]最早提出了冗余树的方法以容忍单链路失效,Kini等人[16]通过构造多冗余树以容忍两条链路失效,然而在图论中计算冗余路径的经典算法都需要获得全局一致性拓扑信息,而域间路由系统中每个AS仅能获得局部拓扑信息,无法进行有效集中式计算;其次由于Internet的AS数量大,集中式计算复杂度非常高,即使是分布式方法也由于协议复杂度过高而难以实现;最后由于BGP协议需要保证策略实现,进一步限制了可达性,因此许多IGP中的方法难以直接应用于BGP中.现有BGP协议缺乏对多路径的考虑,缺乏发现、使用多路径的能力,大量研究表明多路径可增强网络容量、可靠性.MIRO[9]通过复杂的协商机制获得多路径,依赖于配置通告备份路径的策略,是一种无结构路径的方法,MIRO采用隧道机制区分那些需要在备用路径上传输的报文,并且没有考虑快速路由恢复.R-BGP[10]为AS通告一条与最佳路径不相交的AS级备份路径以提高可靠性,这依赖于大量手工配置通告备份路径的策略,是一种无结构路径的方法,信令机制较复杂,且并不能完全保证获得多样性路径,且需要特殊报文封装机制进行转发.Page3Consensus[12]路由协议借鉴了分布式系统中快照实现一致性的算法,将路由计算集中于顶级AS,这却违反了AS自治性,当链路失效造成报文不能正常转发时进入瞬时模式,采用偏转(Deflection)、回退(Backtracking)、备份(Backup)机制发起本地重路由.Splicing[11]利用BGP路由器中已有的多条路径构造多路径转发.YAMR[13]为每个AS最佳路径的每一跳都获得冗余标签路径,其平均RIB/FIB存储平均至少增加4.6倍,且部分冗余路径对于快速恢复难以发挥作用.ACF[17]在路由不一致的情况下采用检测并恢复的方法,通过在报文头中添加路径踪迹域、黑名单域等辅助路由决策和转发,较大程度增加了报文头开销,可能形成违反AS策略的转发路径.Add-Path[18]通告多路径,需要全网路由器更新,且增加了路由震荡的风险.上述针对BGP的多路径协议主要通过修改策略使其在控制平面通告多路径,这需要复杂的信令、决策机制等,是一种无结构的方法,并没有对BGP协议进行系统化的设计,对于多链路失效的转发缺乏考虑;且这些协议对于路径多样性暴露程度并没有确定性的保证,且基本上没有考虑抑制瞬时失效的方法,对于多路径协议的收敛期间的动态行为缺乏考虑.对于降低协议开销、保证无中断转发、抑制瞬时失效这3个相互影响的问题,已有工作并不能完全解决.MFT2-BGP通过为目标前缀构造冗余树,每个AS自动获得结构化的多样性路径,而无需大量人工配置复杂策略,可以实现负载均衡、降低BGP扰动,面临失效时动态切换路径以实现快速路由恢复,在不影响报文转发的情况下抑制瞬时失效,增强BGP路由系统的稳定性.3网络模型和问题分析3.1网络模型MFT2-BGP做出如下设定(其中设定(1)是为了简化表述,这是当前研究普遍采用的设置,不影响协议的正确性,而(2)、(3)是研究BGP[2]的基本设置):(1)每个ASv仅由单边界网关路由器节点组成(不考虑iBGP),v对每个u∈Peers(v)(Peers(v)为v的邻居节点)的导入、导出路径分别保存在rib_in(v←u)、rib_out(v→u)中,loc_rib(v)保存本地最佳路径;(2)AS的导入导出策略服从“Gao-Rexford”原则[19],即仅出现“valley-free”的路径;(3)AS间建立eBGP会话,路由更新消息服从SPVP[20]模型.3.2问题的提出与分析在给定拓扑下网络容忍失效的性能主要取决于拓扑暴露程度、协议响应性两个因素.BGP协议在这两个方面却存在不足.虽然BGP将快速响应性置于一致性之上,但是却带来了大量环路以及路由黑洞,直接影响转发性能;同时,尽管Internet底层路径具有充分冗余[21],AS无可替代路径的不到5%[9],BGP协议对于底层路径暴露程度不足,缺乏发现、区分和使用多路径的能力,多宿主AS也仅能控制报文出口,而仍然缺乏容错性[5],这主要是由于BGP缺乏故障隔离能力、仅通告并使用单路径、协议的动态性造成的瞬时性不可达、环路(将其统称为瞬时路由失效)[22],从而造成了网络可用性相对较低,而一些多路径BGP协议却增加了环路发生的可能性[18],比如R-BGP为当前下一跳通告备份路径时,如图1中AS2为下一跳AS1通告备份路径(2-0),当AS1-AS0和AS2-AS0多链路同时失效时,由于AS1和AS2独立决策,将会在造成备份路径之间形成环路,甚至某些单链路特殊场景下也可能造成环路.Splicing[11]仅利用已有路径,却没有考虑如何获得多样性路径,比如AS0-AS3断开时Splicing仍将产生失效.合理发现、利用多样性路径是解决这些问题的关键.基于以上观察,在设计MFT2-BGP时对SPVP[20]定义进行扩展以发现、区分多路径;在多路径开销和性能之间折衷,确保协议的收敛性和正确性.定义1.合法路径.BGP中合法路径必须服从策略、能够到达d(即不含失效链路/节点);其次路径P=π(u,d)是合法的必须满足:i,ni1,π(u,d)=π(u,vi)+πu(u∈vi,d)=π(u,vi)+π(vi,d),即πu(u∈vi,d)=π(vi,d),即合法路径不会造成报文偏转.其中路径P=π(u,d)=(u,v1,v2,…,vn,d),表示u分配的到达d的节点序列,πu(u∈vi,d)表示在u的路由记录中所看到的vi到达d的路Page4径,而π(vi,d)表示vi实际采用转发路径,P·Q表示为路径P、Q拼接.设非空合法路径P、Q完全不相交;或者在某点交叉,即i,j,使得vi=wj≠d,或者P与Q仅在d汇合,如果πu(u∈vi,d)=πz(z∈wj,d),那么P、Q之间是一致的,一致性路径不会造成转发环路.定义2.隐藏路径与备份路径.指底层拓扑存在到达d的合法路径,但AS却没有获取该路径,其具有相对性,比如图1中,AS3可以通过(3-5-6-2-0)或(3-4-6-2-0)合法路径封装报文到达目标,却被AS4、AS5隐藏.备份路径是指可到达d且没有被选作最佳路径的合法路径,备份路径也可能被隐藏.定义3.路径不相交度.对于给定路径P、Q,如果P和Q具有不同下一跳,Disjoint(P,Q)=1-|P∩Q|/|P|(计算|P∩Q|时不包含源、目的节点);否则Disjoint(P,Q)=0,这是由于具有相同下一跳的路径无法用于快速恢复.对于节点u的合法路径P、Q,如果满足Disjoint(P,Q)>0,则称u具有多样性路径.定义4.转发树.对于给定目标前缀d,存在稳定的路径分配使BGP收敛后,所有节点最佳路径最终形成以d为根节点的转发树[20],转发树中所有节点转发路径具有一致性,即如果π(u,d)=(u,v,P),那么π(v,d)=(v,P).由于BGP的策略限制,其转发树并不一定是最短路径树.定义5.路径标识(PathIdentifier,PID).当存在多条到达目标前缀的路径时,为了区分、处理每条合法路径,节点需要同时根据前缀prefix和特定标识符ψ区分路径,即利用(prefix,ψ)路径标识符唯一标识一条路径P.定义6.秩函数λv:Pv→N,对于P∈Pv,Pv={P|P=v·π(v,d),v∈Peers(u)},Pv表示从v到达d的合法路径集合,如果P1、P2∈Pv,λv(P1)>λv(P2),那么P1具有更高优先级.定义7.瞬时失效节点.指出现失效后,节点v的rib_in(v)中无可到达d的合法路径,此时节点可行路径集为空或包含非法路径,此时会造成报文丢失或者环路[22].如图1所示,目标前缀d位于AS0,AS旁矩形框为根据Valley-Free得到的路由表,比如AS5具有3条到达AS0的路径,AS5根据“PreferCustomer”优选(5-3-0)作为最佳路径.假设链路AS0-AS3断开,AS3发送撤销消息到AS4和AS5,AS5将根据其偏好策略优先选择(5-4-3-0),而AS4将选择(4-5-3-0)路径作为最佳路由,WRATE(撤销速率限制定时器)使得AS2和AS3延迟通告新的可用路径,此时AS5、AS4之间形成环路,AS3无到达AS0的路径.即AS3、AS4、AS5经历瞬时失效.定义8.转发中断.转发路径是指在时刻t,报文从u发送到d所实际经过的节点序列,表示为forward(u,d),如果v∈forward(u,d),v的转发平面中的下一跳为空或陷入环路,则称之为转发中断(本文忽略失效检测时间,BFD机制可将失效检测时间降至15ms以内,Cisco路由器已经普遍实现BFD).需要注意的是,节点瞬时失效仅是转发中断的必要条件,比如在图1中,如果AS2-AS0链路失效,虽然AS6采用(6-2-0)不是合法路径,但是由于AS2具有冗余路径,在检测到失效以后能够迅速切换(2-1-0),此时并无节点经历转发中断.而在一些加速收敛协议中,如GhostFlushing将使AS2快速撤销路径(2-0),如果AS6无备份路径,将导致AS6也经历转发中断,数据平面的转发中断相对于BGP收敛时间更准确度量协议性能[23],文献[5]也指出控制平面的可达与数据平面的可达并不完全相关,本文也将用瞬时失效率、转发中断作为衡量协议性能的重要指标.4MFT2-BGP协议设计4.1MFT2-BGP基本框架BGP路由系统表示为S=〈G,Policy(G),s〉,其中AS图表示为G=(V,E),V={0,1,…,n},Policy为所有节点的策略集合.BGP系统状态表示为元组〈r0,r1,…,rn〉,其中ri表示ASi的路由表中所包含的到达d的路径集合,p∈ri,s0表示d发起通告时的初始状态,s0=〈r00,r01,…,r0n〉.当处于收敛状态sfinal时,所有节点的转发路径将形成以d为根的最佳转发树Best_Tree(d,〈rfinaln〉)=G(V,E),且有V={nj∈V|p∈rj},rfinalE=∪nj∈V{(u,v)∈Ep∈rj∧p=v1,v2,…,v(当链路失效后BGP重新收敛形成新的以d为根的转发树.如图1中,AS0-AS3断开后收敛最终得到失效后转发树.基于以上观察,如果各个节点在失效前能够发现、预计算出备份转发树,就可以保证每个AS在面临链路/节点失效的时候,仍然存在合法备份路径,从而将流量切换到备份转发树中,且备Page5份转发树路径上具有完全一致性,其结构化性质阻止了环路形成.然而,由于BGP并不能获得全局拓扑进行有效集中式计算链路或者节点不相交树[15-16],而注入失效链路并强制其收敛获得失效后转发树,其收敛时间过长且会中断报文转发.为此,MFT2-BGP对协议通告过程进行修改,添加路径标识符以区分、获得结构化的多样性路径.节点为了能够利用多条路径进行无环转发,也需要为多路径分配路径标识符,任意节点v必须实现如下映射:路径标识函数PathIDv,即节点v需要为每条合法路径从路径标识集合PID中选择合适标识符ψiv,其中ψiv表示节点v的第i条路径标识符,而转发函数Forwardv则根据ψ(ψ∈PID)进行报文转发,将ψ映射到对应的路径P=(v1,v2,…,vn),节点vk和vk-1需正确解释ψ,且vk能够将报文转发到vk-1,即Forwardvk(ψ,d)=vk-1,1in.其中路径标识符可以是全局一致标识或本地分配的标识符,而本地分配标识符更加灵活,但vk、vk-1之间需对本地标识符ψjvk以及ψivk-1按照式(2)的条件协商后进行映射转换,即对于标识符ψ路径P上相邻节点,如图2(a)所示,map(ψjvk)=map(ψivk-1)=ψ以保证转发一致性,标识符映射可采用与Deflection[14]类似的方法,为表述方便本文采用全局一致性标识.在不影响理解的情况下,本文中将网络节点等同于AS节点.对于标识符ψ和其对应转发树ψ也不进行区分,对于转发树ψ(非最佳转发树)中节点对应ψ的路径,也称为该节点的备份路径.图3MFT2-BGP更新消息处理过程示例当节点检测到最佳路径的下一跳失效后,如果该节点具有不相交度大于0的备份路径,通过修改报文头以动态切换到具有不同标识符上的转发树,实现无中断转发.4.2.1前缀通告在MFT2-BGP协议中,ASv发起前缀通告时,4.2控制平面多转发树构造与更新MFT2-BGP对路由通告、路由决策进行了相应的修改,如图1中,AS0根据本地策略向3个邻居节点AS1、AS2、AS3通告前缀时分别分配标识符ψ10、ψ30(简记为ψ1、ψ2、ψ3).各节点(不含AS7、AS8)ψ2最终获得多路径如图3所示,其中对更新消息处理顺序可能导致中间状态不同,但最终收敛结果一致,形成3个不同转发树,简记为ψ1_Tree、ψ2_Tree、ψ3_Tree.其中对于AS7仅能通过上行路径(uphill)[19]到达目标前缀,AS6和AS2会导出所有本地合法路径到AS7,AS7可根据本地策略决定各个路径标识上的最佳路径.图3表现了协议运行过程,暂时并没有考虑将具有相同下一跳的路径合并以降低开销以及加速收敛等优化操作.其中,图3中“”表示发送更新消息,下划线“—”表示该节点rib_in发生变化,路由表中斜体部分表示可以合并的路径,设置最佳路径标识符“Best”是为了与当前协议兼容,并且避免由于标识符数量过少而导致部分节点使用次优路径(如果不考虑“Best”,更容易实现,但是却违反了标准BGP语义).针对不同的节点对〈v,u〉为每条路径分配标识符,v的loc_rib发生改变并在通过导出策略后,需将对应标识符(ann_pid)的路径信息发送到邻居节点u.当v的邻居节点数大于可用路径标识符数量,将其余的邻居AS路径标识符设置为隐藏标识符(Hide_PID),表示该路径仅可能被部分AS选作最佳路Page6径,但是并不会传播到全网,从而在暴露的路径数量以及开销之间进行折衷.如果发起前缀通过的AS仅有单条路径,如图2(b)所示,此时AS0可以将路径标识符池[ψ1,ψ2,ψ3]通告给AS1,然后AS1从标识符池中取出标识符并通告给不同邻居,或者AS1自主对不同邻居分配路径标识符.通过分配路径标识符使得路由器能够区分、利用多路径,v存储的rib_in(v←u)、rib_out(v→u)、loc_rib(v)以及更新报文update数据结构修改为映射类型,比如某个完整的更新报文将包括(pefix,PID,AS_Path)三个域,分别表示前缀、标识符以及AS路径.其通告过程如过程1所示,其中省略了MRAI设置等语句.过程1中第1~3步表示构造原始的通告路径.第4~10步表示依据路由策略从路径标识符池中选取路径标识符,并构造对应标识符的更新消息.第11~13步则表示将包含标识符的更新消息发送到邻居节点中./v表示发起通告的路由器,prefix为目标前缀,Peers(v)表示其邻居列表,PID_Set表示可用路径标识符集合,update为路由更新消息/1.Porigin··=path_init(prefix)//构造通告路径2.v.origin_rib(prefix)··=Porigin3.IFv.Path_Selection(prefix)==True//检测loc_rib是4.FOREACHw∈peers(v)DO5.IFv.export_policy(w,prefix,origin_path)==True过程1.路由器v目标前缀通告过程.6.IFPID_Set==7.ann_pid··=Hide_PID8.ELSE9.ann_pid··=PID_Set.pop()//获得路径标识符10.ENDIF11.update=v.loc_rib[ann_pid]//根据标识符构造更新消息12.v.export_action(ann_peer,prefix,update)13.v.send_update(w,ann_pid,update)//发送更新报文到w14.ENDIF15.ENDFOR16.ENDIF4.2.2路由更新节点接收到路由更新消息后,将启动路由更新发送的过程,其服从SPVP模型[20].如过程2所示,其中第1~4步表示v接收到u更新报文以后,v根据导入策略对更新报文进行过滤.第5~9步中,v从更新报文中提取所有路径标识符对应的路径信息,v更新所保存的rib_in(v←u).第10~13步中v调用本地路径选择过程,使用秩函数λvbest从所有可行路径中选择最佳路径,然后为每个路径标识符计算新的最佳路径,并最终下载到FIB中.其中在过程2中,v中具有标识符ψi的路径集合表示为Pvβψi表示对应标识符的最佳路径,令λv标识符的秩函数,要求选择最大不相交多样性路径.过程2.路由器v路径选择过程.//根据导入策略对update报文进行过滤并修改路径属性1.IFloop_detection(update)==True//环路检测2.RETURN3.v.import_policy(u,update)4.v.import_action(u,update)5.FOREACH(PID,Path)∈update[prefix]DO//遍历update中所有标识符对应的路径信息6.IFPath==7.Delv.peers[u].rib_in[prefix][PID]8.ELSE9.v.peers[u].rib_in[prefix][PID]··=Path//v更新对应的rib_in(v←u)10.old_rib=Copy(v.loc_rib[prefix])//复制原有loc_rib11.βbest··=max(λvbest(∪Pv12.v.loc_rib[prefix][best]··=βbest13.install_FIB(βbest)14.FOREACHψi∈PID_SetDO15.βψi=··=max(λv16.v.loc_rib[prefix][ψi]··=βψi17.install_FIB(βψi)18.IFold_rib≠v.loc_rib[prefix]//如果loc_rib改变,则19.RETURNTrue,THENsend_update(peers(v))20.ELSE21.RETURNFalse4.3多转发树下的加速收敛与标准BGP协议构造单个以d为根的转发树相比,MFT2-BGP在构造多转发树时,为了传播隐藏路径也相应增加了一定的开销.MFT2-BGP则将EPIC[8]的思想扩展到多路径场景以加速协议收敛(简称MFT2-EPIC).MFT2-EPIC主要针对各标识符上的路径之间存在的依赖性,在每条标识符路径上添加不同的序列号(fesn)进行区别,即fesn=(〈x,y〉:N)表示链路两边节点有序对与序列号的组合.即完整的更新消息包含[pefix,PID]+[AS_Path]+{fesnList},fesnList包含对应AS_Path中的fesn列表.当出现链路失效(或更改策略)撤销[pefix,ψ]相关路径时,u发送的撤销消息中包含fesnList1信息,令fesnList1=[(〈a1,b1〉,n1),(〈a2,b2〉,n2),…,(〈ak,bk〉,nk)],v接收撤销消息后,v可Page7利用撤销消息中的fesnList信息作废其它邻居节点通告的所有标识符上的非法路径,设v存储的某条路径P对应的fesnList2=[〈a1,b1〉,n1),〈a2,b2〉,n2),…,〈al,bl〉,nl)],且kl.如果存在(ai==ai)∧(bi==bi)∧(ni==ni)),i=1,2,…,k,即fesnList2与撤销路径fesnList1相关,此时可以快速作废非法路径P,从而加速收敛并消除收敛过程中可能的环路.4.4瞬时失效抑制在不影响转发连续的情况下,可以利用多路径压制瞬时失效以实现故障隔离能力,避免频繁收敛带来的路由震荡,从而降低控制平面的扰动.基本思想是当最佳路径失效后,如果备份路径具有不同的下一跳,则并不发送更新消息,并且设置合理定时器(绝大多数BGP故障将会在10min内恢复[24],可据此设置默认定时器).如果定时器超时则需要发送路由更新消息,触发路由重新收敛.比如u检测到路径标识符ψ对应的路径失效,如果u仍然具有其它可行转发树对应的路径,在不影响持续转发的情况下,u可对与ψ相关的失效消息进行抑制,将该策略称为SUP(SuppressallUPdatemessage).SUP策略将会使得部分节点在压制失效后可能使用非最佳路径,比如图1中链路AS0-AS3失效后,将导致AS3、AS4、AS5的最佳路径发生变化,如果AS3压制失效信息,在消息压制期间,将会使得受到失效影响的节点AS3、AS4、AS5到达目标的跳数增加.为此,设置新的路由策略SNUM(SuppressNon-BestUpdateMessage),即u在检测到失效后,如果其u的最佳路径改变,u在利用备份路径转发的同时也发送更新消息,如图1中AS0-AS3失效后,AS3将发送与ψ3相关的路由更新消息,但是由于ψ3并不改变图1中AS1、AS2、AS6的最佳路径,因此,AS5可以安全压制更新路由消息,不再进一步向AS6发送消息,并避免持续使用次优路径.4.5报文转发过程为了保证转发一致性,需要修改报文头格式并增加路径标识符ψ,通常可以在IP报文头中添加额外的shim报文头[14],或者利用现有IP报文头中TOS或DSCP域,通过报文头中标识符ψ指示报文当前所采用的转发树.在链路失效时,失效检测节点具有特殊的角色,失效节点在查找备份可用转发树的同时,还需要将报文头中的路径标识符修改为所切换的转发树标识符.在单链路失效时,由于转发树中对应的所有节点转发视图具有一致性,在节点间无需协调的情况下,检测失效的节点仅需要发起本地重路由即可保证无环转发.当出现节点失效、多链路失效时,以及采用瞬时失效抑制,将会造成各个AS节点之间转发视图不一致,单失效下的转发机制并不能充分利用已经获得的冗余路径,而且还可能出现转发环路,因此还需要信令机制以避免环路.如图1中,如果AS2-AS0和AS1-AS0同时断开,如果AS2检测到失效后采用图3中标识符为ψ1的路径,修改报文头标识符为ψ1,并将报文转发到AS2;同时,由于AS2发现AS2-AS0断开,由于AS1与AS2之间无协调,如果AS1选择ψ2路径,将导致AS1和AS2之间形成环路,在这种多失效场景下必须利用辅助信息才能无环转发.为了充分利用已获得的多转发树,MFT2-BGP在报文中添加“报文经历信息”Used_PID,表示报文已经使用过的转发树.如图2(b)中所示,节点在接收到报文后,提取报文头中Used_PID信息以避免重复选择同一转发树,该信息存储实际不超过2bits.具体报文转发如过程3所示,其中Best_Tree表示最佳转发树对应的路径,其下一跳表示为best_nhop(d,Best_Tree),而根据路径标识符ψ形成的转发树为ψ_Tree,其下一跳表示为best_nhop(d,ψ_Tree),forward_packet(nhop,tree)表示根据对应转发树转发报文,Change_header(tree,transient)表示修改报文头中的路径标识符为特定的转发树,并且设置报文进入失效转发模式.过程3.报文转发过程.1.nhop··=Best_nhop(d,packet.current_PID)//按指定标2.IFd≠nhop3.IFv.get_link(nhop)==UP4.forward_packet(nhop,packet.current_PID)5.ELSE6.FOREACH(PID,AS_Path)∈v.loc_rib[prefix]DO7.IFPIDnotinpacket.Used_PIDandPID≠Best_Tree8.IFAS_Path.valid==False//如果PID对应的AS_Path9.packet.Add_Used_PID(PID)10.CONTINUE11.ENDIF12.(newhop,new_tree)··=find_Best_PID_nhop(d,PID)13.ENDIF14.IFnewhop≠andv.get_link(newhop)≠Down15.Change_header(new_tree,transient)Page816.packet.Add_Used_PID(new_tree)17.forward_packet(newhop,new_tree)18.ELSE19.IFv.loc_rib[prefix][Best_Tree].valid==True//在无对应路径标识符时,如果Best_Tree20.nhop··=Best_nhop(d,packet.current_PID)21.forward_packet(nhop,packet.current_PID)22.ELSE23.Droppacket24.ENDIF25.ELSE26.forward_success()27.ENDIF过程3中的第1~4步,报文依据对应标识符转发.第6~12步在未使用过的转发树中选择备份路径(瞬时失效中优先选择非Best_Tree以降低协议动态性的影响),需要说明的是,当节点具有多个备份转发树时,节点可以根据策略选择最短路径树STF(或者固定优先选择某个特定标识的转发树SPT[16],并且将已失效转发树标识加入报文中的Used_PID域中).第14~17步中,节点将根据修改后的转发树标识进行转发.第19~21步中,当节点在无可用转发树时,则尝试使用Best_Tree转发.该转发过程可以有效解决多链路失效下的转发环路,比如在图1中,当节点失效引起AS2-AS0以及AS1-AS0断开后,报文到达AS2后,其Best、ψ2皆失效,如果AS2选择了ψ1将报文转发到AS1,AS1将通过报文中Used_PID以及当前链路状况,仅能选择标识符ψ3,最后通过ψ3成功转发报文.当路径标识符数量为k时,为了表示报文头的状态,其报文头开销的最大长度约为1+2lg(k)bits.5协议属性分析5.1协议收敛属性定理1.对于给定的SPVP实例Z,如果它不含DisputeWhee[20],那么MFT2-BGP最终收敛;且在路由收敛期间不会出现瞬时环路.证明.DisputeWheel[20]的定义略,本文将SPVP扩展到多路径路由.与标准BGP不同,v具有多条到达目标AS0的路径,v采用路径标识符ψ进行区分,路由更新消息中包含ψ以及AS_Path路径信息.v的最佳路径标识符βbest将从v的可行路径集合Pv,即从rib_in(v←peers(v))中选择,因此在同样的拓扑、策略下,如果SPVP在无DisputeWheel的情况下收敛,那么MFT2-BGP中最佳路径βbest上也一定收敛.其次,对于路径标识符ψi,v在路由决策过程中计算ψi(除最佳路径βbest)路径时与ψj(i≠j)的路径隔离,即在ψi上其可行路径集合即仅在GψiG中选择路径,显然,如果SPVP在拓扑G中无DisputeWheel,Gψi对G删除了部分边,Gψi也不会含有DisputeWheel,那么MFT2-BGP中标识符为ψi的路径βψi在Gψi上也一定收敛.5.2报文转发属性引理1.对于任意节点u,如果在链路e失效前,其最佳路径上包含e,在BGP协议中最终收敛能够得到不含e的路径,那么MFT2-BGP保证u存在某条标识符ψ的路径不通过e.证明.首先,显然当MFT2-BGP使用充分数量的路径标识符时,总能获得底层拓扑中服从策略多样性路径,并形成多转发树.设最佳转发树(Best_Tree)中失效链路e的失效根节点为q,设e失效之前,πBest(u,d)=Pbest=(u,v1,v2,…,vn)·π(q,d),且π(q,d)=(q,w1,w2,…,wm,d);在e失效之后如果BGP协议收敛能够使u获得到达d的路径为Pbackup=(u,z1,z2,…,zt,d),即u在失效前、后的最后一跳分别为wm和zt.下面证明MFT2-BGP能够获得多样性路径.(1)如果wm≠zt,根据前缀通告过程,AS0发起前缀通告时将会针对每个邻居节点wm、zt分配不同的路径标识符ψi、ψj(i≠j)进行区分;节点zt到达d的路径必不包含失效链路e.因此,zt需要将ψj的路径通告给zt-1,依次类推,可知u将会存在ψi、ψj上的多样性路径.同样,通过归纳法证明,u将ψj路径通告给v1,任意vi(n>i1)中存在某条标识符ψj的路径不通过e,且最终w也将会获得不包含e的路径.(2)如果wm=zt,说明Pbest与Pbackup路径重叠,AS0仅有一个邻居节点.如果wm为每个邻居节点分配标识符,设失效前Pbest路径的标识符为ψi,zt-1到达d的路径不包含e,其标识符为ψj.依次类推,可得u将会存在不经过e的标识符为ψj的路径.对于vi(n>i1),其证明与上面相同.证毕.引理2.在无失效场景下,报文总在最佳路径上转发;当出现单或多链路失效后引起路由收敛期间,如果协议获得的多样性路径中存在可行的转发路径,那么报文不会被丢弃,且不会陷入环路.证明.分3种情况证明,即无失效、单链路失效、多链路失效场景.显然,在无失效场景下MFT2-BGP处于收敛状态,v的最佳路径是对所有可行路Page9径集合Pv计算得到一致性路径,报文在最佳路径上安全转发.其次,当出现单链路e=(u,v1)失效以后,设失效检测节点u的最佳路径为πBest(u,d)=(u,v1,v2,…,vn,d),当e失效后,u切换到路径πψi(u,d)=(u,w1,w2,…,wk,d),如果Disjoint(πBest(u,d),πψi(u,d))=1,报文将在转发树ψi_Tree中无环转发.如果0<Disjoint(πBest(u,d),πψi(u,d))<1,即πBest(u,d)与πψi(u,d)部分重叠,由MFT2-BGP报文转发算法可知必有v1≠w1,设πBest(u,d)与πψi(u,d)在某点vi=wj相交,其中vi∈πBest(u,d),wj∈πψi(u,d),1<in,1<jk.如果πBest(vi,d)=πψi(wj,d),即vi中标识符为Best和ψi具有同样的路径,由于其任意转发树ψ上转发路径具有一致性,即报文不会回退或环路;而当πBest(vi,d)≠πψi(wj,d),即vi中标识符为Best和ψi具有不同的路径,报文p在ψi可无环转发.出现多链路失效时,根据报文转发过程,具有如下属性:(1)报文p不会2次遇到同一个失效链路,该属性主要是由于检测失效的节点会将其失效转发树的标识符ψi加入到报文头中,下行节点选择转发树时将避免ψi,这使得p不会两次遇到同一个失效链路;(2)当出现第k(k2)个链路失效后,当前节点u将根据ψk(ψk≠ψi)转发报文p,如果在ψk不能成功转发,说明出现了新的失效链路,u将避免使用p.Used_PID,并选择新路径,此时p要么被成功转发,或由于无可行路径而丢弃.MFT2-BGP获得多转发树的同时也一定程度上增加了计算、存储开销,在不采用路径合并的时候,其最大存储开销线性增加.根据文献[25]的结论,硬件的发展仍然满足Moore’s定律,其多路径计算、存储带来的开销是在可承受范围之内,且如果将同一前缀的多标识符路径进行合并到单个转发表,其存储开销将会进一步减低.由于互联网AS拓扑具有幂率特性,其平均AS跳数为4,可证MFT2-BGP增加转发路径的长度非常小,在本文后实验中也证明了这一点.6性能评价为验证MFT2-BGP性能,本文对轻量级Sim-BGP①进行扩展,实现了所有BGP相关的重要特征.根据CAIDA②的数据分析可知当前AS数量为31212,链路数量为60052,多宿主AS占总数的53.4%,由于其规模过大,采用Dimitropoulos[26]根据CAIDA数据标注推断的AS级Internet-like拓扑图,该拓扑具有AS之间的商业关系以及Internet的复杂结构特征,Splicing[11]也使用了该拓扑.本文采用的800节点的拓扑如图4所示,链路数量为1582,协议模拟参数如表1所示.实验对MFT2-BGP在各种场景下的收敛时间、消息数进行比较;为验证MFT2-BGP的无中断转发的性能,还从平均AS瞬时失效率、平均转发中断时间、路径伸展度等方面进行比较.图4800AS节点拓扑6.1多转发树构造开销该场景中主要针对多宿主StubAS发起前缀通告,测试其收敛时间以及消息数量.在BGP实现中MRAI通常设置为Peer-Based.由于源节点在发起通告时,所有节点并没有对其邻居设置MRAI,为保证模拟的真实性,降低Peer-Based的影响,因此设置发送消息等待时间为[0,MRAI]随机分布,以此作为背景MRAI.(1)当使用路径标识符数量为2时,随机选择150个多宿主(Provider2)的AS共测试648次.收敛时间、消息数量累积分布概率如图5(a)、图5(b)所示,与BGP相比,收敛时间增加仅约4%,总体消息数量增加约20%,以合理的开销获得了多样性路径.MFT2-BGP在前缀通告时消息数量有所增加,这是由于为了将隐藏合法路径暴露给其它AS,而收敛时间与BGP相比几乎无增加,这是由于不同标识符上的收敛具有相对隔离性质,而BGP收敛时间主要与网络直径、MRAI设置等因素相关[27],理论上收敛时间为max{ψ1_ann,ψ2_ann,Best},其中ψi_ann为对应标识符上的收敛时间.此外MFT2-BGP中MRAI采用Peer-Based设置,由于ψ1、ψ2会相互影响,也一定程度上会限制更新消息传播速度,稍微增加收敛时间.①②Page10(2)当使用路径标识符数量为3时,随机选择71个多宿主(Provider3)测试214次.收敛时间、消息数量累积分布概率如图6(a)、图6(b)所示,其收敛时间仅增加10%,总体消息数量增加40%,但考虑到每个节点获得的路径数量将会达到3,此开销仍然在合理范围内.MFT2-BGP在初始化时,带来了一定的消息开销,但这种开销也仅出现在多转发树的初始构造中.6.2单失效下协议性能针对单链路失效,测试了边缘链路、核心链路失效两种场景.(1)在边缘链路失效中,随机选择300个多宿主AS(Provider2),断开多宿主AS与其中的一个Provider的链路(这是最极端情况),共进行了650次实验,分别测试了BGP、GhostFlushing[7]、EPIC[8]、MFT2-BGP以及加速收敛的MFT2-EPIC.从图7(a)中CDF图中可以看出,GhostFlush-ing、EPIC协议在Internet-like拓扑中Fail-over收敛时间与BGP相比改善效果并不明显[27].MFT2-BGP协议收敛时间与EPIC、BGP相比有所降低,总体上MFT2-BGP比BGP收敛时间降低了8%以上.尤其值得注意的是,MFT2-EPIC收敛时间均优于其它所有协议的收敛时间,与BGP相比降低了30%以上,且在绝大多数实验中,收敛时间都降低50%以上.发生这种现象的原因主要是BGP、GhostFlushing、EPIC等协议在Fail-over场景中,要传播撤销消息以及通告新的路径,从而增加了收敛时间,收敛时间主要受到失效位置与失效后的路径到达目标的距离两个因素的影响[27];而MFT2-BGP在前Page11缀通告的时候已经比较充分地获得了隐藏路径,当出现链路失效时,MFT2-BGP、MFT2-EPIC主要传播撤销消息,且MFT2-EPIC降低了路径探索,因此收敛时间大为改善.此外在实验中也发现,在设置WRATE时,MFT2-BGP、MFT2-EPIC收敛时间与BGP相比将会进一步降低,其改善效果更加明显.从图7(b)中CDF图中可以看出,GhostFlush-ing以增加消息数量为代价降低了收敛时间.MFT2-BGP和MFT2-EPIC由于需要将特定路径标识符上的撤销消息传播到全网,略微增加了消息数量.但是MFT2-EPIC与BGP相比,其消息数量的最大值与BGP相比反而降低了.由于MFT2-BGP具有多条合法路径,仅当失效检测节点存在备份路径时可以抑制瞬时失效.如图8(a)、图8(b)所示,当采用SUP策略时,其收敛时间和消息数量均降低了一个数量级;而采用SNUM策略时也有较大程度的改善.在不影响持续转发的同时,SUP和SNUM策略均极大地降低了网络的抖动.当链路断开时,测试各个协议经历路由瞬时失效的节点数目(其中对永久失效节点不计入内)如图9(a)所示.在协议动态收敛过程中,MFT2-BGP、MFT2-EPIC降低平均瞬时失效率至0.11%和0.12%,经过分析发现,MFT2-BGP中瞬时失效主要是由于部分核心节点采用“Gao-Rexford”导入导出原则,使其仅能获得单条路径,当该路径被撤销以后,从而引起其它节点转发中断.而GhostFlushing、EPIC发送过多撤销消息使得大量节点缺乏可用路径,从而增加了瞬时失效节点的数目.在收敛过程中通过对每个节点模拟转发报文,计算平均中断转发时间如图9(b)所示(其中对永久失效节点不计入内).MFT2-BGP、MFT2-EPIC中节点可以动态切换转发路径,从而降低平均转发中断Page12时间至0.09s和0.13s,而EPIC和GhostFlushing由于快速传播路由撤销消息,部分AS节点又缺乏可用的备份路径,从而造成转发中断时间大量增加.如图9(c)所示,MFT2-BGP、MFT2-EPIC实际的平均转发路径长度几乎没有增加,与失效后的最佳路径长度相比增加了不到1%.这主要是因为当AS节点检测到失效时,节点动态切换的路径在绝大多数情况下实际就是最终收敛后的最佳路径.(2)在核心链路失效中,模拟中选择43条核心链路断开进行测试(不计由于核心链路密集而无失效的场景).从图10中可以发现,所有协议的平均瞬时失效节点都有所降低,这是因为在BGP协议中,核心节点中通常具有多条可行路径,降低了路径探索时间.6.3多失效下协议性能在域间路由发生多并发失效的情况是非常少见的,绝大多数出现在灾难场景中.本文主要模拟了双链路失效情景.(1)双链路失效场景1.当使用路径标识符数为2时,模拟中采用双链路失效的最极端场景,即断开多宿主AS与其Provider的一条链路,并随机选择备份路径标识符上的一条链路失效(第2条失效链路不能为多宿主AS与其Provider的链路,否则可能彻底断开),共随机测试248次.从图11中可以看出,与单链路失效场景相比,虽然MFT2-BGP、MFT2-EPIC经历瞬时失效的比例有所增加,但是仍然比BGP等协议瞬时失效比例大幅降低.(2)双链路失效场景2.为了验证MFT2-BGP和MFT2-EPIC的可扩展性,使用3个路径标识符时,随机选取了70个多宿主AS(Provider3)共测试156次,测试场景仍然为最极端的情况,即将目标AS与Provider连接其中两条链路同时断开.从图12(a)中CDF图中得知,MFT2-BGP、MFT2-EPIC的收敛时间与BGP相比均有所降低,且MFT2-EPIC总体收敛时间降低了19%.图11双链路失效下平均瞬时失效率(#PID=2)Page13从图12(b)、图12(c)中可知,在这种最为极端的失效情场景下,增加路径标识符数量可以获得更充分的多样性路径,容忍多失效的能力得到了进一步的提高和验证,从图中可知MFT2-BGP、MFT2-EPIC平均失效率仅为0.15%,中断时间仅分别为0.11s和0.62s,出现失效的原因也是由于“Gao-Rexford”策略过滤导致部分节点并没有获得多样性路径.以上实验表明,MFT2-BGP以相对合理的消息开销构造了结构化的多转发树,且在构造过程中对收敛时间几乎无影响.当出现链路失效时,MFT2-BGP、MFT2-EPIC不仅有效降低了收敛时间,而且通过报文在多转发树之间的切换,降低了失效引起的转发中断;且由于构造的多转发树的结构化特性,更易于实现对多失效的处理.7结论与未来工作提高域间路由协议的生存性、实现无中断的转发是网络体系结构研究的重点之一,也是网络作为基础设施、新兴应用发展的需求.与BGP协议以及一些加速收敛的协议相比,MFT2-BGP、MFT2-EPIC以相对较低的消息开销获得了多样性路径,给了用户更大的路径选择权利[14]以满足QoS需求,可以针对特定标识符的路径实现细粒度的策略控制,避免了由于修改路由策略而造成的环路以及报文丢失.MFT2-BGP也具有兼容性,遗留路由器忽略路径标识符即可进行正常的协议收敛和转发.当出现链路失效后,MFT2-BGP、MFT2-EPIC利用获得的多路径保证无中断转发,在不限制协议的动态性时进一步降低了收敛时间,当对瞬时失效进行抑制时,网络的稳定性得到增强.下一步的工作需要将该模型进行扩展,将多路径的快速恢复协议扩展到iBGP协议中,并进一步考虑路由恢复所带来的流量转移可能造成的拥塞,以优化流量负载均衡分布.
