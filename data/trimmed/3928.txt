Page1一种流体运动矢量计算的有效方法全红艳王长波(华东师范大学软件学院上海200062)摘要提出了一种有效的流体运动矢量计算方法.该方法利用视频流的两帧图像进行流体运动矢量的计算,目的是获得流体连续性运动的二维矢量.采用图像分析和连续性方程约束的策略进行研究,所求得的运动矢量能够反映流体运动的特点.该方法包括运动矢量的初始化、去噪、平滑和优化这4个步骤:首先,统计每个像素所在区域的直方图,利用区域直方图主要成分匹配方法完成对运动矢量的初始化;然后,对初始化结果利用多分辨率采样方法进行去噪处理;再用统计分析方法对局部模块的运动矢量进行平滑处理;最后,用流体运动的连续性方程进行约束,对运动矢量进一步优化,得到具有保持外观一致性和运动连续性的流体运动矢量.实验结果证明了该方法的有效性,对于具有多种运动的流体场景运动矢量的计算也是实用的.关键词流体;运动矢量;直方图;运动连续性1引言流体自然景观在自然界中随处可见,它的建模与绘制被广泛应用于火灾、泥石流、洪峰等自然灾害目前,在流体的物理仿真中还没有完全将动态Page2纹理区域的识别与基于物理属性的仿真结合起来,虽然出现了一些与视频媒体真实感一致的流体建模和仿真技术[1-4],但是自然景观流体与其它物体交互的技术还没得到广泛应用.因此,如何从动态纹理计算出流体的运动矢量是研究重建与交互的关键所在,它的研究具有重要的现实意义和实用价值.流体运动是一种典型的非刚体运动,流体运动图像的计算与分析是一项重要的图像处理技术.在运动分析中,纹理分为弱纹理和强纹理[5].弱纹理具有自相似性,其图像变化具有亮度不变性;而图像中的流体部分属于强纹理,其特点是亮度保持性,即其内部的运动产生了形变和遮挡,但是图像中强度的成分是不变的.由于流体具有透明性,因此可以通过计算粒子的运动矢量来间接获得流体本身的运动特征.对于流体的运动矢量的计算通常采用粒子图像测速PIV(ParticleImageVelocimetry)方法实现[6-9],即通过跟踪每一个可见粒子来实现运动矢量的获取.虽然利用PIV计算可以克服传统方法中的不足.但研究中存在的主要问题是由于流体粒子的运动引起的遮挡及再现,它会影响运动矢量计算结果的准确性.在传统的变分的研究方法及PIV方法中[9-10],假设运动矢量在局部空间上是光滑的,这样会带来运动边界及遮蔽问题.人们在研究中提出了一种基于时空多分辨率的流体速度及加速度场的计算方法[11],该方法利用时空多分辨率直方图对流体速度及加速度的方向进行统计分析,最后得到流体的速度及加速度场,但是如果将该方法应用于具有运动刚体的场景或者多种运动的流体场景中,特别是在视频的两帧间摄像机的旋转及平移矢量非常小的情况下,势必会影响计算结果的准确性.对于具有多种运动的流体场景的直方图统计分析中,很难将分析得到的速度及加速度与流体的多种运动对应起来,如图1所示视频的图像,利用该方法进行统计分析时,就存在这个问题.SunDeqing等人[12]在研究中,分析了现有流体运动矢量计算的模型和方法,在目标函数中加入非局部项,给出了一种启发式的方法,推导出新的目标函数,并采用邻域的中值滤波策略对运动矢量进行计算,得到了稀疏粒子运动矢量较为准确的结果;对于流体中大量粒子的情形,利用该方法进行研究,所得结果的精度会受到影响;Nilanjan[13]在最近的研究中,利用光度和几何属性进行块匹配,对流体的运动矢量进行估计,采用改进的H-S方法进行研究,并利用AM(AlternatingMinimization)方法优化,求得局部极小值;研究中使用优化技术及多分辨率技术对流体运动矢量进行计算,该方法对于较为稀疏的流体粒子,能够取得满意的实验结果,但是对于大量的具有复杂运动的粒子,计算的精度会受到影响.光流法是运动图像分析的主要方法,由于Horn-Schunck光流法是基于灰度一致性的假设对稠密光流场进行研究的机制[14],由于流体运动时形成图像的强纹理区域,采用这种传统的计算方法势必会导致光流场计算结果不准确.为了克服这些研究中存在的问题,本文提出了一种流体运动矢量计算方法.该方法分为初始化、去噪、平滑以及运动矢量的优化4个步骤如下所示.算法1.流体运动矢量计算方法.1.运动矢量的初始化.分别计算两帧图像中每个像素所在区域的灰度直方图,利用直方图的主要成分匹配方法得到初始的运动矢量.2.去噪处理.采用多分辨率法对初始的结果进行去噪处理,该步骤为可选.3.平滑处理.采用统计分析方法在局部进行平滑处理.4.优化处理.用流体运动的连续性方程进行约束,对运动矢量进一步优化,得到具有保持外观一致性和运动连续性的流体运动矢量.2流体运动矢量的初始化由于流体粒子在运动过程中具有遮挡以及再现的特点,因此,每个流体粒子在运动过程中难以保持亮度的一致性,但是粒子所在的邻域在运动前后具有保持强度成分不变的特性.根据这一特性,对于流体的运动矢量进行初步计算,主要分为两个步骤:(1)对两幅图像分别进行区域直方图的统计;(2)利用对应区域主要成分匹配的方法,完成对运动矢量的初始化.2.1区域直方图统计统计直方图被广泛应用于图像处理及分析[15-16]、目标识别及视频检索等领域中.研究中,为了求得运动矢量,首先对于两幅图像分别统计其直方图.由于在视频的前后两帧中,摄像机的旋转及平移的矢量较小,因此采用局部区域统计方法进行研究,如图2所示.Page3利用式(1)将图像的像素分为不同的级别:其中,表示取整,density为图像中像素的灰度值,其表示0~255之间的一个整数值.为了阐述方便起见,称直方图中像素较大数目的级别为统计直方图的主要成分.2.2运动矢量的初始化由于流体区域表现为强纹理,其运动特征是:并不是每个像素都存在着一个对应像素,但是每个像素邻域具有强度保持的特性,即对应邻域在运动前后强度的成分保持不变,在研究中充分利用了这一特性.为了求取邻域强度的主要成分,对直方图的统计结果进行排序,同时将对应直方图统计的成分进行排序,利用区域的直方图主要成分进行匹配.在运动矢量初始化时,假定在一个小区域范围内所有粒子具有相近的运动趋势,并寻找一个运动矢量,使某区域内所有粒子运动前后所对应的区域具有相似的成分.假设运动前后的两幅图像为Ik(k=1,2),中心像素P(i,j)邻域的直方图排序结果为Hkij,对应成分排序为Hxkij.考虑到视频中相继两帧的摄像机位置变化较小,流体的运动矢量很小,因此在5×5区域范围内找到一个矢量狏ij,使得在运动前后,对应邻域内所有像素的直方图主要成分的欧氏距离最小.当然,如果流体的运动速度较快,可以根据需要适当扩大运动矢量的搜索范围.运动矢量初始化算法描述如下.算法2.流体运动矢量初始化算法.输入:流体运动视频的相邻两帧输出:流体运动矢量初始化结果1.分别统计两幅图像Ik(k=1,2)中每个像素P(i,j)的5×5邻域直方图.2.将P(i,j)的直方图统计结果从大到小排序Hkij,对其成分也排序,结果为Hxkij.3.在邻域5×5内搜索一个矢量狏ij,使得对应邻域内所有像素的直方图主成分的欧氏距离dij最小,其中dij=∑2其中Hxkijh表示第k幅图像中像素P(i,j)邻域直方图中第h个分量.结束.4.得到当前像素P(i,j)的运动矢量初始化结果,算法流体运动矢量初始化时,用邻域直方图排序后的5个主要成分进行实验研究,即算法中w取5,可以得到较满意的初始化结果.3利用多分辨率法去除噪声在运动矢量初始化时,由于是在光照及基于区域强度的主成分不变的前提下进行的,这样势必会产生误差.当场景中存在大片静止的背景区时,研究中需要进行去噪处理.如图3所示,利用视频“6ame200”的第0帧进行研究时①,第一个结果是未进行去噪处理时,每隔5个像素的运动矢量初始化结果.由于摄像机及背景是不运动的,从图中结果可以看出,初始化结果中存在一定噪声.由此可见,对于流体区域中粒子运动矢量的初步计算结果,存在着不准确的现象,初步的计算结果是基于区域强度的保持特性的,并没有体现出流体运动的连续性,需要对其进行优化.研究中提出了一种简单的多分辨率采样的去除噪声的算法,对初始化的结果利用多分辨率采样方法,在不同的分辨率的空间中,利用阈值法对统计结果进行处理.其算法可以描述如下.算法3.多分辨率去噪算法.输入:初始化的流体运动矢量输出:运动矢量的去噪结果1.算法初始化.置m=1,设定采样窗口为s×s.2.对于运动矢量进行第m次采样.3.统计sc×sc区域中运动矢量的数目,并记为n,采用阈值方法进行判断,如果满足则认为该像素的运动矢量初始化结果计算是无效的,作为噪声去除结果,并得到该区域去噪结果,ts表示运动矢量数目的阈值.①PeteriR,HuskiesM,FazekasS.DynTex:Acomprehen-Page44.判断是否得到了满意的结果?如果是,则转步6,否则,进行下一步.5.m=m+1,重新设置采样窗口s×s的大小,并转步2.6.算法结束,得到去噪的运动矢量的结果.在图3的实验研究中,利用了两次多分辨率采样的处理,采样的间隔s×s分别为5×5及2×2,统计的窗口sc×sc为10×10及15×15,两次采用的阈值分别为100及550,从图3的结果可以看出,去噪效果比较理想.在运动矢量的求取中,利用多分辨率法去除噪声是可选的步骤,只有在场景中存在大片静止的背景区,研究中需要进行去噪处理时,才执行该步骤.实际上,在视点不变情况下,对于背景区的噪声,也可以用帧间差分法进行处理,即通过对视频图像序列中相邻两帧作差分运算来去除大片静止的背景区运动矢量的噪声,虽然帧间差分法在研究中可以取得较满意的结果,但对于可变光照的场景来说,多分辨率法去除噪声就更有效了.4运动矢量的平滑对于初始化的流体运动矢量,由于误差等原因,很难保证结果是准确的.为了提高其准确性,采用平滑处理.平滑的概念是人们在数字图像处理中提出的,我们将这种思想应用于运动矢量的处理之中.虽然流体的运动具有特殊性,在运动过程中会出现流体粒子的遮挡和再现,但是对于运动场景的局部小区域来说,可以认为其中的粒子在相邻两帧的运动中,运动矢量的方向是相同的、运动矢量的大小是接近的.根据这一思想,在研究中对运动矢量采用局部平滑的策略.研究中,将邻域5×5区域中的运动矢量按照象限进行统计,并利用统计数目最大的象限中运动矢量的平均值,作为该区域的中心像素的运动矢量.运动矢量平滑算法可以描述如下.算法4.运动矢量平滑算法.输入:流体运动矢量的初始化结果输出:运动矢量的平滑结果1.算法初始化.对于每个象限的累加器Ak(k=1,…,4)分别置0.2.对每个像素邻域内的运动矢量,按照方向进行累加,记为狏k(k=1,…,4),并使累加器Ak增值.3.选择计数最大的累加器Am(1k4),并判断Am的大小,如果满足式(4),当前的像素粒子的运动矢量置为零矢量;否则,其运动矢量狏1用式(5)计算.其中tsmooth为累加个数的阈值.4.判断是否所有像素都处理完毕了,如果是,转步5;如果否,转步1.5.算法结束,得到运动矢量平滑的结果.在利用动态纹理库DynTex(见上页脚注①)中视频“6482910”的第198帧进行研究时,在实验中tsmooth的值取5,得到了较满意的运动矢量平滑结果,如图4所示,左图是运动矢量初始化结果,右图是平滑后的结果,从图中可以明显看出,平滑算法是很有效的.图4“6482910”的第198帧的初始化及平滑结果5运动矢量连续性的优化流体运动矢量计算结果的准确与否,可以从两个方面进行衡量.第一,是从外观的一致性进行衡量;第二,是流体运动的估计要符合运动的连续性.为了满足这两个要求,并保证流体运动矢量计算的准确性,利用流体运动的连续性方程进行优化,这样可以体现出流体的运动特征.流体运动的连续性方程为[5]其中,tI是图像强度对时间的导数;Ω表示Ω的边界;狀是Ω的外部矢量.根据散度理论及数学推导,式(6)可以写成下面的形式[5]:式中It表示图像强度对时间的导数;Ix和Iy分别表示图像强度在空间域上的导数;流体的运动矢量为(狌vec,狏vec),狌x和狏y分别表示运动矢量的偏导数,利用一阶向前差分进行计算求得.研究中采用连续性方程(7)对运动矢量进行优化.优化算法的主要思想是:首先利用连续性方程进行测试,并标记满足运动连续性的像素,进一步利用被标记像素的运动矢量,重新计算其邻像素的运动矢量.Page5如图5所示,在块3×3的区域中,如果像素X的邻像素A、B、C和D满足连续性方程,即已经被标记,那么设A和X的运动矢量分别为犲A(uA,vA)和犲X(uX,vX),那么由连续性方程,可得由式(8)可以得到uX;同理也可以由C像素粒子满足连续性方程的条件,得到vX.运动矢量连续性优化算法描述如下.算法5.运动矢量连续性优化算法.输入:流体运动矢量平滑后的结果输出:运动矢量连续性优化的结果1.初始化.对于图像中每个像素P(i,j)及其3×3邻域,如果满足式(7),对邻域内的像素P(m,n)的标记fmn置为1:fmn=1,m∈[-1+i,i+1],n∈[-1+j,j+1](9)2.对于没进行标记的像素X,利用式(8)重新计算出X运动矢量犲X(uX,vX)中的狌X分量.3.对于没进行标记的像素X,重新计算出X运动矢量4.更新标记.如果像素X的uX以及vX都已经进行了5.判断是否满足了终止条件.如果是,则进行下一步;犲X(uX,vX)中的狏X分量.优化,则对X进行标记.否则,转步2.6.得到运动矢量连续性优化的结果,算法结束.在研究中采用了下面的方法作为迭代终止条件.判断被标记的像素数目是否达到了总数目的90%,如果是,终止优化过程.6实验与分析我们运用本文的方法,在PC机上Windows7操作系统下进行了以下实验,其硬件配置是2.66GHzIntelCore(M)DuoCPU、4GBRAM.6.1新方法的有效性验证6.1.1流体运动矢量计算方法的有效性验证为了验证本文中所提出算法的有效性,采用了动态纹理库DynTex中的视频进行研究.图6中是动态纹理库中视频“6482910”的第897帧以及“54ab110”的第3帧运动矢量计算的结果.为了能清晰地表明流体运动矢量的结果,图中是每隔8个像素的运动矢量结果.左图是流体运动矢量的初始化及平滑结果,右图是利用了本文提出的运动连续性的优化算法进行优化的结果.图7是利用动态纹理库DynTex中视频帧进行实验,得到的运动矢量的最终结果,是每隔10个像素的结果.从这些结果可以看出,所得到的运动矢量具有保持流体运动连续性的特征,流体运动矢量计算结果的大小及方向与实际流体运动的情况基本一致,这表明了本文所提出的算法是有效的.Page66.1.2新方法与同类算法的比较(1)与文献[11]的方法比较本文在研究中,为了说明算法的有效性,将本文提出的新算法与文献[11]的方法进行比较.利用文献[11]的方法进行研究时,在场景存在多种流体运动或者存在运动背景情况下,由于直方图存在着多峰值的现象,很难确定流体区域的多种运动速度.在研究中,利用动态纹理库DynTex中视频“647bc10”的第203帧,采用本文提出的运动矢量进行研究取得了较满意的结果,如图8所示;采用文献[11]的方法对该视频中流体运动矢量进行计算,得到的运动矢量的统计结果如图9所示,从图中明显可以看出,利用文献[11]的方法,在处理多相流的情况下,由于直方图存在多峰值,不能将多相运动与多峰值相对应,因此很难求取流体运动矢量,这说明本文算法对处理多相流的运动也是有效的.图8“647bc10”的第203帧的运动矢量计算结果图9利用文献[11]求得的速度方向的统计结果(2)与其它现有方法的比较为了进一步验证本文所提出算法的有效性,分别与文献[12]和[13]进行比较,验证的内容包括运动矢量计算的结果、算法的准确性和算法的有效性比较.①运动矢量计算结果的比较分别选择经典的“Yosemite”图像序列中的第7帧①、另一篇文献提供的粒子图像②、利用OpenGL生成的流体运动场景以及动态纹理库的视频序列中的图像进行比较研究.在实验中,区域直方图的统计均采用5×5的邻域进行.图10是运动矢量计算的结果(每隔8个像素的显示结果),每组的左上结果为原图像,右上结果为文献[12]的结果,左下结果为文献[13]的结果,右下结果为本文的实验结果.进行实验得到的结果有所不同,主要表现在:从图10的实验结果可以看出利用不同的方法a)利用现有算法对于流体运动矢量进行计算,存在着结果不准确的现象,在无云背景区运动矢量出现了不为零的现象,如图10(a)所示.b)利用现有的方法进行研究时,得到的运动矢量结果缺少细节特征.例如,采用文献[12-13]的方法计算时,如图10(d)所示,得到的运动矢量缺少细节特征,导致了部分粒子运动矢量的方向完全相同,而用新算法求得的运动矢量的结果具有流体粒子运动的细节特征,这也体现了新方法对流体运动连续性优化的有效性.c)在流体运动区域中,利用现有方法研究时,流体运动矢量的计算结果出现了零矢量,如图10(e)和(f)所示.总之,从图10的实验对比结果可以看出,利用本文的新方法计算得到的运动矢量的结果更符合流体运动的实际情况,这说明了新方法是很有效的.②流体运动矢量计算结果的准确性比较为了验证新方法的准确性,在研究中将新方法的误差与文献[12-13]的实验误差进行比较.实验中运用3种误差进行研究:方向误差Ed、运动矢量大小误差E和比例误差Er.其中Ed,采用式(10)进行计算.式中vij是粒子P(i,j)运动矢量的计算结果;vstdij是该粒子运动矢量的准确值;W和H分别为图像的宽和高;n表示像素的总数目,即n=H×W.E=1误差E采用式(11)进行计算.n∑Wi=1∑H其中,狏i和狏j分别表示运动矢量的两个分量;vstdi和vstdj分别表示运动矢量标准值的两个分量.比较的实验中分别利用Yosemite和合成的流体进行研究.Yosemite运动矢量的准确值从文献①中得到;在合①②inf.ed.ac.uk/rbf/HIPR2/hipr_top.htm,2000,10Page7图10流体运动矢量的可视化结果成流体时,利用OpenGL生成流体运动场景,在相邻两帧中控制每个像素点的运动矢量都是(2,0),图10(c)中是运动场景的第10帧.表1和表2是Ed和E的结果.误差文献[12]方法0.189047文献[13]方法0.162855本文方法表2对OpenGL生成的流体实验结果的误差比较文献[12]方法0.057814文献[13]方法0.069499误差本文方法从误差的计算结果中可以明显地看出,对于较复杂流体运动矢量的计算,用本文方法求得的Ed和E较小.为了进一步验证新方法的准确性,我们分别将新方法和文献[12-13]的方法进行比较,用计算结果与标准运动矢量大小的比值来计算Er,并用式(12)进行计算,表3给出了比值的结果.其中,vstdi和vstdj是运动矢量标准值的两个分量.方法文献[12]方法0.590901文献[13]方法0.601347本文方法从表3可以明显地看出,利用本文方法所求的Er更接近于1,因此更准确一些.③与同类算法的有效性比较为了进一步验证新方法及同类算法的准确性及有效性,用新方法及文献[12-13]对流体运动矢量分别计算,并将计算的结果用于流体场景的重建之中.Page8在研究中,我们用本文算法计算流体运动矢量,并结合LBM(LatticeBoltzmannMethods),进一步恢复流体的高度场,从而实现流体的重建功能.用新方法及现有方法分别计算流体运动矢量,然后将得到的运动矢量结果用于重建之中,通过重建场景的真实感研究几种算法对流体运动矢量计算结果的准确性.图11是流体场景重建的结果.从图11的重建结果可以看出,用不同的方法计算得到的运动矢量进行流体重建的结果有差别.利用本文新方法计算得到的运动矢量进行重建的结果更具有真实感,而利用文献[12-13]进行实验时,从重建的流体图像边界处可以看出,重建结果失去了真实感,得到的三维重建流体与实际视频中的情形不同,这些可以进一步说明新方法对运动矢量计算的准确性和有效性,并能够满足流体重建的实际应用需求.图11利用不同算法得到的运动矢量分别进行重建的结果6.2新方法的性能分析本文所提出的新方法具有简单、时间复杂度较低以及计算结果准确等特点.在初始化阶段中,按照5×5的邻域进行统计,如果图像的分辨率设为W×H,那么初始化阶段的算法复杂度为25×O(W×H),在去除噪声部分的算法中,实验中采用被5整除和被2整除的分辨率采样,统计的窗口大小分别为10×10及15×15,所以去除噪声部分的算法复杂度为325×O(W×H),在平滑部分中,统计区域为5×5,算法复杂度为25×O(W×H);在运动连续性的优化中,选择3×3邻域进行研究,这部分算法的复杂度为10×O(W×H).运动矢量计算算法的总体复杂度为385×O(W×H),算法的复杂度较低.为了进一步说明本文算法的时间性能,研究中对于计算时间进行了测试,表4给出了流体运动矢量的计算时间.从表4中能够看出,本文算法需要的时间较少,速度较快.表4流体运动矢量计算的时间(单位:秒/帧)视频54ab1103.31364adg102.766648db102.922649ib103.46864828103.23464829103.062sBtFence2.7667结束语本文提出了一种流体运动矢量求取的新方法.利用该方法计算的运动矢量,既具有保持运动前后外观的一致性,也具有保持流体运动连续性的特点.它克服了传统的变分方法研究中局部空间光滑的假设所带来的运动边界及遮蔽问题.对比实验进一步验证了本文所研究的计算方法是一种有效的措施,它可以应用于流体的三维重建、虚拟现实、增强现实等应用领域中.进一步的研究工作是对流体运动矢量计算考虑边界的处理问题,可以进一步采用流体动力学的规律进行约束和控制,以便进一步提高运动矢量计算的精确度,并将运动矢量计算的结果与流体的重建与交互的技术相结合,将该研究方法扩展到基于真实感的虚拟现实及增强现实等应用领域中.
