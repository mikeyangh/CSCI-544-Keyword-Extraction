Page1艺术化立体图像的渲染李大锦(山东师范大学传媒学院数字媒体系济南250014)摘要目前的艺术化渲染算法会使结果图像具有较强的随机性,因此无法直接应用于立体图像的渲染.文章针对虚拟三维场景,给出了一个通用的艺术风格立体图像的渲染框架.首先对单个物体渲染包括双眼视域范围的艺术风格图像,在投影过程中同时记录模型顶点对应的纹理坐标;然后将艺术风格图像映射到物体表面生成艺术化效果的三维模型;最后将艺术化三维模型直接投影到左右眼相机生成立体图像.为创建用于纹理映射的艺术化纹理图像,提出了在透视投影中颠倒像素遮挡关系的方法来获取模型的双眼视域范围图像.该文提出的艺术化立体图像生成方法不仅可保证双眼图像的一致性,而且具有良好的通用性,可适用于各类已有的艺术化渲染算法.关键词艺术化渲染;立体图像;纹理映射;双眼一致性1引言相对于真实感画面来说,传统美术风格的画面具有较强的艺术感染力,能更有效地传递作者的思Page2具有良好应用前景的研究领域.立体显示需要两幅具有水平视差的图像,分别代表左右眼两个视点的观察内容.两幅图像所显示的物体在对应位置上应保持一致[1],否则会导致图像不能融合或产生视觉疲劳.如果采用传统手绘方式分别绘制双眼图像,将是一个异常繁琐、费时的工作.计算机图形学在艺术化渲染方面的研究为艺术化立体图像的自动生成提供了可能.但是目前的艺术化渲染算法在模拟各种笔触和颜料效果时具有很大的随机性和不确定性,如果直接采用已有的渲染算法生成双眼图像或将已有的双眼图像进行风格转换,将会导致双眼图像的不一致.针对上述问题,本文给出了一种三维场景的艺术化立体图像渲染方法.我们的目的不是研究艺术化笔触的渲染算法,而是给出一个可运用各种艺术化渲染算法的较通用的立体图像渲染框架,它能自动地将三维场景转换为各种艺术风格的立体图像并能保证双眼图像的一致性.本文的主要创新之处在于:(1)给出了一个独立于具体艺术化渲染算法的立体图像生成框架.利用纹理映射方法直接在模型表面生成艺术化笔触,然后采用双相机直接获取双眼图像.该渲染框架不仅能保证双眼图像的高度一致,而且具有良好的通用性.(2)用于纹理映射的图像应包含双眼图像的所有信息,我们给出了一种双眼视域范围图像的获取方法.2相关工作艺术化自动渲染算法.艺术化自动渲染是利用计算机将三维场景或数字图像自动转换为艺术风格的图像.总的来说,艺术化自动渲染算法可分为两类:一是基于模型的方法,该方法通过三维模型的几何信息和光照信息控制颜色或笔触的绘制[2];二是图像的艺术风格转换[3],该方法基于已有的图像,通过添加艺术化笔触实现风格的转换.人们已开发出很多算法来模拟各种美术风格,如钢笔画[2]、油画[3]、水彩画[4]、水墨画[5]和卡通画[6-7].其中较成熟的自动渲染算法是基于笔画的绘制[8],该算法根据图像的颜色信息或模型的几何信息控制笔触的颜色、位置、尺度和方向等.但笔触都带有较强的随机性,很难直接应用于立体图像的渲染.在本文给出的立体图像渲染框架中,艺术效果的渲染过程被用来生成纹理映射的图像,笔触的随机性不会影响双眼图像的一致性.立体图像的制作.生成立体图像的一种主要方法是通过两个水平放置的相机直接拍摄左右眼图像[9].相机的轴距、焦距等参数影响着图像视差的大小.如果两个相机的性能高度一致,该方法得到的双眼图像能够保持很好的一致性.立体图像的另一种生成方法是基于深度图的制作方法,该方法基于单相机图像,通过附加的深度信息,利用图像变形的方法生成双眼图像[10-11].但这种方法生成的双眼图像只包含了一个视点图像的信息,并且因像素平移在背景区会形成空洞区域,而空洞区域填充仍然是一个富有挑战性的课题.视差映射是立体图像制作中一个重要的研究课题.视差映射是通过改变视差来控制感知深度(也称为深度映射),其目的是为了适应不同尺寸的显示设备或减少因视差较大而造成的视觉疲劳.文献[9,12]分别给出通过实时改变相机参数来控制视差的方法;Yan等人[13]和Lang等人[14]基于图像的变形分别给出了视差的线性和非线性映射;文献[15]则给出了一个根据屏幕大小调节水平视差的模型.目前,通过视差映射来改善立体图像质量仍然是一个有待进一步研究的内容.艺术化立体图像.基于深度图的立体图像生成方法为艺术化立体图像制作提供了很好的工具.Skora等人[16]通过指定深度点的大小关系,给出了一种卡通图像深度图的快速生成算法.该方法需要通过手工指定深度点,主要应用于图像2D到3D的转换.Stavrakis和Gelautz[17-18]利用已有的双眼图像来计算深度图,在单一视点图像上进行艺术化处理,然后通过笔触变形获得另一幅图像.该方法虽然可以保证艺术化处理后双眼图像在变形区域的一致性,但是在充填时由于局部图像平移而形成空洞区域,笔画有可能延伸到本来就可见的区域,会再次造成左右眼图像局部的不一致.Northam等人[19-20]则提出了另一种思路.其基本思想是将已有的双眼图像合并成一幅图像,该图像包含左右眼图像的所有信息(除了包含双眼能看到的部分,还包含在一个眼睛能够看到,而在另一个眼睛上被遮挡的部分),在合并的图像上绘制艺术化笔触,然后再将图像分离为左右眼图像.由于最终的双眼图像来自于同一张艺术化的图像,所以能保持双眼图像的一致性.但正如作者所说深度图的准确性严重影响着渲染结果,而通过双视点图像计算深度图仍然是计算机视觉中具有挑战性的课题.同时,从作者给出的结果来看,双眼图像的合并也很难达到无缝的拼接.Page3上述的艺术化立体图像渲染都是基于图像的生成方法.本文给出的渲染框架完全不同于上述方法,我们在三维空间通过纹理映射将艺术化笔触映射到模型表面,并直接利用双相机得到双眼图像.3方法概述对于三维虚拟场景,生成立体图像最直接的方法是采用水平放置的两个相机分别拍摄左右眼图像.如果在模型投影之前应用艺术化处理,使模型表面带有艺术化笔触,那么可以直接得到艺术化的立体图像.基于这种思想,我们利用纹理映射的方法将艺术化风格的图像映射到三维模型.艺术化风格的纹理图像我们称之为“笔触纹理”.笔触纹理可以直图1本文方法的渲染流程(1)首先渲染模型的参考图像,参考图像包含双视点观察都能看到的内容.在执行投影变换时,同时计算顶点的纹理坐标.(2)将参考图像运用艺术化风格转换算法,生成具有某种美术风格的笔触纹理(如果采用基于模型的渲染算法,省略本步,可以在步1直接生成纹理笔触,即图1中所示的粗虚线表示的步骤).(3)将笔触纹理映射到模型表面,得到艺术化风格的三维模型.(4)关闭所有灯光,分别在两个相机上投影成像,获得双眼图像.如果需要绘制物体轮廓,根据三维模型渲染出物体轮廓(图1中所示的最后一步的两个圆形虚线框表示的操作).4笔触纹理渲染4.1渲染参考图像如图2(a)所示:Cl和Cr为水平放置的两个相接采用基于模型的艺术化渲染方法得到,也可以在模型的真实感图像上采用图像的艺术风格转换算法得到.模型的真实感图像我们称之为“参考图像”.参考图像包含了物体的颜色、阴影、深度和光照等信息,这些信息是添加艺术化笔触的基础.由于模型需要从两个不同的视点进行投影成像,所以参考图像和笔触纹理必须包含两个视点都能看到的范围.此外,在生成笔触纹理的过程中,必须同时生成模型的纹理坐标,便于执行后来的纹理映射.关于笔触纹理和纹理坐标的生成方法我们将在第4节和第5节做详细介绍.图1给出了本文方法的渲染流程.图中圆形框表示执行的操作.给定一个三维场景,系统将逐个处理场景中的模型.对于单个模型,执行以下几步:机,它们的轴距为c;假设有一圆柱体,其直径为2R,分别从两个相机发出的与柱面两侧相切的射线形成两个切平面,则切平面与圆柱面两侧的交线是双相机可见范围和不可见范围的分界线.图2中的(b)和(c)是图(a)的顶视图,图中实线和虚线分别表示了可见和不可见的部分.图2(b)和图2(c)分别表示当圆柱直径大于和小于相机轴距的两种情况.由图2(b)和图2(c)可以看出相机轴距和柱体直径的比例不同,双相机能拍摄的范围也不同.对于第1种情况,当圆柱直径小于相机轴距时,如图2(a)所示,设两个切平面相交于直线q,通过两个相机和圆柱中心点的平面为π,直线q和平面π相交于点O.从图2(b)可以看出:如果我们从点O处观察圆柱体,那么虚线表示的部分正好代表了可见的范围,而实线表示的部分是被遮挡的.在多数图形渲染系统中(如OpenGL,DirectX等),遮挡计算是通过投影变换后的深度值(Z缓冲区的像素深度值)来判断像素的遮挡关系.如果我们通过投影变换Page4改变顶点深度值,使被遮挡部分可见,那么以点O处为观察点,可以绘制出相机Cl和Cr都能观察到的范围.所以在这种情况下,我们可以在O点设置辅助相机Co(如图2(b)所示),用辅助相机Co来拍摄参考图像,Co轴向指向圆柱中心.Co的位置除了可放置在点O处之外,还可以沿相机轴向前移至更靠近圆柱体的某个位置,这样可以拍摄到更广的范围.对于第2种情况,当圆柱直径大于相机轴距时,两个相机所能拍摄的全部范围小于1/2圆柱,平行投影可以得到圆柱面的1/2范围.所以在这种情况下,可以在两个相机的中间位置设置辅助相机Co(如图2(c)所示),通过平行投影方式得到参考图像.4.1.1投影变换和光照计算在三维图形渲染中,模型坐标首先被变换到相机坐标系,然后进行投影变换将坐标变换到裁剪空间.投影变换通过一个投影矩阵来实现.对于上述的第1种情况,因为辅助相机被放置在物体的后面,如果要将被遮挡的部分(图2(b)和图2(c)中的实线部分)变为可见,只需通过投影矩阵将z值的大小顺序颠倒来实现.例如在OpenGL中,透视投影变换后,视截体被变换为一个边长为2的正方体,深度值z∈[-1,1].要将z值的大小关系颠倒,只需将z值符号取反.如果n,f分别为视截体的近、远裁剪面距视点的距离;r,l分别为视截体在近裁剪面上的左右边界的坐标;t,b分别为视截体近裁剪面的上、下边界的坐标,则颠倒深度顺序的投影矩阵为对于第2种情况,只需将辅助相机的投影矩阵设置为平行投影即可.在计算镜面反射时,需要利用观察向量.观察向量是从模型顶点指向视点的向量(如图3所示,图中犞为观察向量,犔和犖分别是光照向量和顶点法线向量).对于要绘制的多边形,辅助相机看到的正好是这些多边形的反面,无法计算镜面反射.所以,在计算时,我们将观察向量定义为从视点指向顶点的向量,即图3中的犞,犞=-犞.犞实际上表示了相机Cl和Cr之间某个位置的观察向量.4.1.2辅助相机设置在以上论述中,我们是以标准圆柱体为例说明如何获取参考图像.但实际的模型并不是标准的几何形体,这时我们通过模型的圆柱形包围盒来设置辅助相机(如图4所示).如果双相机的轴距设定为人眼的正常距离(一般为6cm~7cm),在实际的场景中,大部分模型的柱体包围盒的直径都会大于轴距.根据前面的论述,可以采用平行投影的方式拍摄参考图像.但是在实际场景中的模型往往比较复杂.例如图4中的玩具狐狸,虽然整个模型的包围盒直径远大于相机轴距,但是狐狸上的鼻子和耳朵等部分的尺寸小于轴距.如果直接采用平行投影方式得到参考图像,那么小尺寸部分在双眼视域范围内的部分内容可能会丢失(详细讨论参见第6节).为了尽可能减少信息的丢失,对于所有模型,我们统一采用第一种方式建立辅助相机并采用透视投影.如图4所示,设相机Cl和Cr的连线的中点为P,我们将辅助相机Co放置在P点与圆柱包围盒中心确定的直线上;Co的拍摄方向指向包围盒中心;相机的水平和垂直视域设置为正好能将包围盒全部包Page5图4利用模型的圆柱体包围盒建立辅助相机,采用透视投影获取参考图像括在观察范围之内.设水平视域角度为θ,相机距包围盒中心距离为d.可计算出d=R/sin(θ/2).为尽可能地增加拍摄范围,应使d尽可能减小.但是d越小,θ则越大,而较大的θ值会引起图像的变形.如图4所示的参考图像,由于我们颠倒了像素的遮挡关系,致使图像中由透视变换引起的大小关系也相反.物体的近距离部分看起来很小而远距离部分看起来很大.当将笔触纹理映射到模型表面,再经过透视投影形成双眼图像时,近距离部分的笔触的尺度会被放大.θ越大,这种图像变形也会越强.这里,我们给出了一个折衷的方案,将θ设定为90°,可以计算出d≈1.4R.4.2艺术化渲染利用艺术化渲染算法来生成笔触纹理,可采用基于图像转换的算法或基于模型的算法渲染笔触纹理.如果采用图像转换的方法,则以渲染的参考图像为基础,运用基于图像的艺术化风格转换算法绘制出笔触纹理;如果采用基于模型的方法,则在渲染参考图像的过程中运用已有的艺术化渲染算法直接得到笔触纹理.现有的大多数艺术化自动渲染算法都可应用于本文给出的框架中.有些美术风格需要绘制模型轮廓(如卡通画),所以在本文的渲染框架中,最后一步给出了一个可选的操作模块用于生成模型轮廓(图1所示的最后一步的两个圆形虚线框表示的操作).该操作模块在两个相机空间内分别进行投影成像时,利用模型的顶点法线信息生成两个视点下的模型轮廓.5纹理映射与双眼图像的生成纹理映射要解决的一个根本问题是纹理坐标的确定.在将笔触纹理映射到模型时,模型的某个顶点对应的纹理坐标和该顶点在投影生成参考图像(或笔触纹理)时对应的像素位置应该保持一致.投影矩阵将模型变换到裁剪空间后,每个模型顶点的投影点对应着成像面上的一个坐标,即裁剪空间的(xc,yc)坐标(如图5所示).坐标(xc,yc)又对应着该顶点在图像上的像素点.而该点像素正是要映射到投影此处的模型顶点的采样点.因此可以将模型顶点的裁剪坐标(xc,yc)作为该顶点的纹理坐标.由于纹理坐标一般定义在[0,1],如果(xc,yc)不在[0,1]之内,需要将之变换到[0,1].例如在4.1.1节给出的变换矩阵中,得到的(xc,yc)∈[-1,1],则纹理坐标为s=(xc+1)/2,t=(yc+1)/2.事实上,纹理映射是投影生成参考图像的逆过程.而纹理映射方式是一种平面投影映射.参考图像经过艺术化处理后再被映射到模型表面,在双相机的视域范围内,模型便具有了美术风格的效果(如图5所示).最后将模型在左右相机投影成像后便可得到左右眼图像.因为笔触纹理是在参考图像的基础上经过风格转换得到的或直接由三维模型渲染生成的,所以笔触纹理已经包含光照、阴影等信息.因此在生成双眼图像时,不需要再进行光照计算,直接将模型Page6投影即可.6结果与讨论图6是本文方法生成的油画和彩色铅笔画效果的左右眼图像和立体图像的结果(通过红青眼镜可以看到立体效果).其中的笔触纹理分别采用了艺术化图像处理工具SnapArt和AkvisSketch对参考图像进行风格化转换而得到.图7则分别给出了卡通风格、蜡笔画、水彩画和素描风格的渲染结果.卡通风格采用了基于模型的卡通风格渲染算法[7]直接渲染出笔触纹理,在最后投影生成双眼图像时,绘制了模型轮廓.其他的艺术风格分别使用了Photo-shop滤镜中的粗糙蜡笔(RoughPastels)工具和AkvisSketch工具将参考图像转换成笔触纹理.图6本文方法的渲染结果,纹理笔触采用图像转换方法生成(左列为油画风格,右列为彩色铅笔画风格)因为双眼图像直接由三维模型分别在两个相机空间投影得到,两次投影成像的模型使用的笔触纹理是同一幅纹理,所以无论艺术化渲染算法生成的笔触随机性有多强,都不会影响双眼图像的一致性.艺术化渲染过程主要是用来生成笔触纹理,相对整个渲染流程来说,是一个相对独立的处理过程.因此,现有的艺术化渲染算法都可应用于本文给出的框架中,最终图像的艺术效果的好坏也主要取决于具体的渲染算法.由图6和图7可以看出,利用本文的方法生成的立体图像除了能够保证双眼图像的一致性之外,对于不同的艺术风格,在保持原有渲染方法所生成的艺术效果方面也都能得到满意的结果.如何获取包括双眼观察范围的参考图像(或笔触纹理)是本文方法的一个关键问题.我们是通过一个辅助相机并改变透视投影中的深度关系来拍摄参Page7图7其他不同艺术风格的渲染结果考图像.根据4.1节的讨论可知,如果物体尺寸小于双相机轴距,辅助相机的位置应满足以下条件:辅助相机应在两个相机和物体中心所在的平面内,并处于两个相机发出的物体切线的交点处或处于该交点之前更靠近物体的某个位置.但因为实际的模型都比较复杂,常常包括尺寸不同的很多部分,所以我们利用整个物体的包围盒来确定辅助相机位置.但这样对于模型的局部来说,辅助相机位置不符合上述条件.所以会导致在双相机视域内的小部分内容在辅助相机中可能会被遮挡.例如图8中虚线表示的部分从右眼相机Cr可以看到,但在辅助相机Co中却被前方的黑色线表示的部分遮挡.尽管如此,当笔触纹理被映射到模型表面后,黑色粗线处的图像内容会被映射到虚线处.由于这些笔触纹理中丢失的区域一般比较狭小,而且笔触的大小、方向都具有较强的不确定性,这恰恰掩盖了上述的细小缺陷,所以最终的结果看不到明显的瑕疵.如图9是玩具狐狸右眼相机的投影图,笔触纹理中不包含狐狸胸部右侧的一小块区域,纹理映射后,狐狸右手前部的图像被映射到该区域,可以看出这些细小的错误并不影响最终的视觉外观.在某些较抽象的美术风格中,画家通常不会仔细刻画物体的边界,所以笔触往往会越过一个物体的边界覆盖在后方的物体上.此外,有些绘画颜料(如水彩画、水墨画)有较强的扩散效果,颜料会扩散到物体边界之外.但是当三维模型投影生成左右眼图像时,这些越界的笔触和颜料扩散的区域会被剪掉,形成平滑清晰的物体边界(如图6的山体边界和图8辅助相机拍摄参考图像时的信息丢失(虚线部分在右眼相机能看到,在辅助相机中被前黑色粗线部分遮挡)图9笔触纹理存在部分信息丢失情况下的纹理映射结果(被遮挡区域被映射了遮挡该区域的那部分内容的图像)图7水彩画风格图像中的桌凳的边缘).在某些绘画风格中(如卡通、素描、写实性强的油画等),画家通常会比较精确地刻画物体边界,明显的边界不会对Page8艺术效果产生影响.但是对于某些美术风格(如较抽象的油画、水彩画和中国水墨画等),会使结果变得生硬,明显降低艺术效果.这是本文的渲染方法亟待解决的主要问题.7结论与未来工作本文针对虚拟三维场景,提出了一个完整的艺术化立体图像渲染框架.我们不直接采用艺术化渲染算法来单独地生成双眼图像,而是利用纹理映射的方法在模型表面生成艺术化的笔触效果,然后直接由模型投影生成双眼图像.艺术化渲染算法只有在生成笔触纹理时被执行一次,所以能够确保双眼图像的高度一致.通用性是本文方法的另一个主要的优点.无论是采用基于模型的方法,还是基于图像转换的方法,笔触纹理的渲染都可以是一个独立的处理过程.所以各种艺术化渲染算法都可以应用于本文的渲染框架.在整个渲染框架中,包含双眼观察范围的参考图像(或笔触纹理)的获取是关键的一步.我们利用透视投影的特点,给出了通过改变像素深度关系得到参考图像的方法,该方法简单、高效,可最大限度地获取双眼观察的范围.正如第6节所讨论的那样,直接利用艺术化风格的三维模型来得到立体图像,虽然对于大多数美术风格都能得到良好的效果,但是对于有些艺术风格,生硬的边界会降低艺术效果.因此,在本文研究的基础上,如何保持越界笔触和水墨扩散效果的完整性将是我们下一步的研究内容.
