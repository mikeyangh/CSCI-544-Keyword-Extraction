Page1一种有效显示隐藏特征的光线投射算法周志光陶煜波林海(浙江大学CAD&CG国家重点实验室杭州310058)摘要提出了一种有效显示隐藏特征的光线投射算法,无需调节复杂的传输函数,便可以有效地显示光线方向上被遮挡的感兴趣的特征.在沿光线方向遍历的过程中,采用低通滤波对光线上采样点的标量值进行平滑,以获得不受噪声干扰的、准确的特征点;根据特征点的深度信息调整当前最大的标量值,以获得能够满足隐藏特征显示的当前最大标量值;计算最大标量差,调整不透明度和颜色的累加值,以提高隐藏特征的可见性.实验结果表明,文中算法相对于传统算法,绘制结果的结构信息丰富,有效地显示了隐藏信息,具有一定的实用性.关键词体绘制;光线投射;隐藏特征;最大标量差1引言科学计算可视化作为计算机应用学科的一个重要分支,已广泛应用于医疗卫生、地质勘探、气象分析等与人类生活息息相关的重要领域,其主要目标就是把实际采样或模拟仿真得到的三维体数据通过Page2近年来,随着图形硬件可编程技术的蓬勃发展,基于图形硬件的体绘制技术得到了深入研究.基于图形处理器(GPU)的光线投射体绘制算法在GPU中完成体数据在光线方向上的采样、遍历、累加等复杂计算,大幅度提高了绘制效率,因此得到了广泛的关注和深入的研究[9-11].公认比较经典的体绘制算法有直接体绘制算法DVR(DirectVolumeRendering)[12]和最大标量值投影算法MIP(MaximumIntensityProjection)[13]等等.DVR算法利用传输函数查找光线方向上采样点的颜色值和不透明度,进而累加获得二维图像对应像素的颜色值,既可以给出感兴趣特征的信息,也提供了特征的背景信息.但是,DVR算法的绘制结果过于依赖数据分类,特别是传输函数,交互分类过程比较复杂和费时,限制了其应用范围.MIP算法则是选择光线方向上最大标量值,作为二维图像对应像素的颜色值.虽然该算法简单实用,彻底摒弃了传输函数,但是绘制的结果缺乏背景信息,忽略了重要的结构信息,不利于领域专家获取特征之间的相互信息.为了结合DVR和MIP各自的优势,Stefan和Eduard提出了MIDA算法[14].MIDA算法是在上述两种算法的基础之上,将当前采样点的标量值与之前最大标量值的差作为参数,修改颜色和不透明度的累加值,进而获得相对准确的二维图像显示.然而,由于最大标量差的引入,参与显示的标量值是递增的,即小于当前最大标量值的信息,即便是领域专家感兴趣的结构信息也将被隐藏,从而使得绘制结果提供的信息不够完整.因此,在分析和对比传统方法不足的基础之上,本文提出了一种有效显示隐藏特征的光线投射算法.在沿光线方向遍历采样点的过程中,比较采样点的标量值与最大标量值的大小,实时更新当前最大标量值,按照MIDA算法对较大标量值的采样点进行累加;然后,寻找当前最大标量值之后的特征信息,为了避免噪声的干扰,我们采用低通滤波对采样点的标量值进行平滑处理,进而获得准确的特征点位置,即当前最大标量值所在采样点之后标量值曲线低谷位置;进而,为了显示最大标量值之后的隐藏特征,我们利用特征点的深度信息调整当前最大标量值,降低特征显示的标准,使得隐藏特征信息也能够显示出来;最后,对光线方向上的所有采样点均按上述步骤判断并且累加,将满足更新后的最大标量值的隐藏特征显示到二维图像对应像素上.通过上述方法,对由视点出发的所有经过体数据的光线进行隐藏特征显示,便可以获得结构相对完整、信息量丰富的体绘制结果.本文第2节对传统的光线投射算法进行概述;第3节详细地介绍所提出的有效显示隐藏特征的光线投射算法,并给出了算法的相关伪码;第4节分析本文算法与经典算法的对比实验结果;第5节对本文工作进行总结.2传统的光线投射算法概述光线投射算法是沿视线方向对体数据进行采样,然后对采样点的标量值通过传输函数赋予一定的颜色值和不透明度,进而累加获得二维绘制结果.该方法有效地结合了体数据、传输函数和视点三者信息,创新性地提出了一种绘制思想,得到了学者们的广泛认可和关注.Max等人首次提出了DVR算法[12],借助于简单的绘制模型,只考虑沿光线方向上采样点吸收和辐射的能量,把采样点的标量值通过传输函数映射为颜色值和不透明度,合成获得光线在二维图像中对应位置像素的颜色值,如式(1)所示:ci=ci-1+(1-αi-1)×c(fpi)×α(fpi),αi=αi-1+(1-αi-1)×α(fpi)其中,c(fpi)和α(fpi)分别表示当前采样点的颜色值和不透明度值,由传输函数指定;ci和αi表示颜色值和不透明度在遍历至第i个采样点时的累加值,当i值遍历到光线终止点的时候,ci即为投射至图像对应位置的颜色值.可以看出,DVR算法的质量与传输函数如何设置关系密切,假若传输函数设置不够理想,那么不透明度的累加值很有可能过早地接近于1,此时处于光线后面部分的很有可能反映重要信息或结构的采样点将会被忽略或者对于最终的结果图像发挥很小的作用,造成了绘制结果信息的缺失和不准确.传输函数对于绘制结果的影响决定了其重要的研究价值[15-16].因此,近年来关于传输函数的研究不断扩展和深入,基于体数据中隐含的纹理、形状和几何信息的高维传输函数相继产生[17-21].例如,Kniss等人将梯度模引入一维传输函数,有效地反映了体数据的边界信息[17];为了更好地分析体数据的边界信息,Sereda等人提出了LH直方图传输函数[20];针对形状结构复杂的体数据,Stefan等人提出了基于体数据形状信息特征的传输函数[21]等.随着传输函数的不断更新进步,如何操纵复杂的传输函数绘制出满意的结果仍然是一个烦琐而低效的过程,需要有经验的专家进行调节操作,有很大的局限性.Page3为了避免复杂的传输函数调整过程,如何采用简单的传输函数获得信息量丰富、结构表示准确的二维图像显示已然成为了当下研究的热点问题.MIP算法则是将光线上的最大标量值投影至二维图像的对应位置.该方法能够快速准确地寻找并绘制出光线方向上最可能的重要信息,但其主要问题在于以下两点:(1)由于噪声的影响,寻找到的最大标量值信息未必是感兴趣信息,进而导致绘制的结果存在误差,算法的鲁棒性不强;(2)最终投影至二维图像的像素值只是最大标量值对应的颜色值,缺乏有效的背景信息以及相对重要的相邻结构信息,不能满足领域专家更高的要求.为了克服上述算法的种种不足之处,Stefan和Eduard于2009年提出一种介于DVR算法和MIP算法之间的MIDA算法.在沿着光线采样过程中,倘若遇到标量值较大的信息,该算法实时更新当前最大标量值,进而有效改进了DVR算法,如式(2)、(3).mi=fpi-fmaxi,fpi>fmaxici=(1-mi)×ci-1+(1-(1-mi)×αi-1)×αi=(1-mi)×αi-1+(1-(1-mi)×αi-1)×α(fpi)c(fpi)×α(fpi),其中,mi表示最大标量量差.由于fpi与fmaxi的取值范围均为[0,1],所以最大标量差mi的取值范围也为[0,1].可以看出,相比于DVR算法,MIDA算法不必调节复杂的传输函数,而是通过最大标量差修图1本文算法的流程改不透明度和颜色值的累加值,使得当前采样点在绘制的结果中能够有效地显示出来;而且在绘制的过程中,感兴趣信息周围的背景信息也被有效地保留了下来,克服了MIP算法的缺点,在医学等领域有一定的应用价值.然而,MIDA算法也仍然存在重要的缺陷,即当前最大标量值达到某一范畴以后,即某一特征得到显示以后,其后面所有标量值小于该特征的信息将被隐藏,这很有可能导致丢失重要的背景和结构信息,造成绘制结果的不准确.3有效显示隐藏特征的光线投射算法通过第2节的式(1)可以看出,DVR算法通过传输函数查找采样点的颜色值和不透明度,进而进行累加计算.但是,如果不透明度的累加值接近于1,那么后续采样点的信息将被隐藏;而式(2)、(3)所示的MIDA算法虽然通过最大标量差,有效地改进了DVR算法,但是当前最大标量值会隐藏其后标量值相对较小的特征信息,而这些特征信息很有可能是领域专家感兴趣的信息,所以存在一定的缺陷.为了能够有效地将隐藏特征绘制出来,更加准确显示光线在二维图像投影的颜色值,本文提出了一种新的有效显示隐藏特征的光线投射算法.本节将重点介绍该算法的总体过程和具体实现步骤.3.1本文算法的总体过程图1出示了该算法的流程图.为了能够更清晰地表述本文算法的总体过程,Page4按照图1中所示的结构,可以看出,本文算法在动态更新最大标量值之后,并没有单纯地依赖当前最大标量值去累加其后所有采样点,而是通过寻找特征点的位置并且根据特征点的深度信息自适应地调整当前最大标量值,使得被隐藏的信息能够完整地显示.3.2本文算法的具体过程算法,我们将其分为以下4个步骤:为了详细地解释有效显示隐藏特征的光线投射1.计算最大标量差.遍历光线方向上所有采样点,比较当前采样点的标量值与最大标量值,根据式(2)计算获得最大标量差mi,并且更新最大标量值fmaxi.在遇到标量值较大的采样点时,通过mi修改颜色和不透明度的累加值ci-1和αi-1,降低之前所有采样点在最终颜色值所占的比重,进而增强了该采样点的比重,使得其特征能在最终的结果图像中得以显示,这一过程有效地改进了DVR算法在不透明度接近于1而无法显示后续信息的不足.2.获取特征点位置.在沿光线方向的采样过程中,标量值的变化能够反映特征信息,即两个波谷之间的信息能够反映一定的特征信息.因此,可以将光线上的标量曲线分解成不同的特征区域,如图2所示.从图2中可以看出,不同的波谷信息将光线上的采样点分割为若干特征区域,而这些特征区域极有可能便是领域专家感兴趣的特征.然而由于真实的采样数据受噪声等客观因素影响,准确地判断波谷的位置比较困难,因此我们选取低通滤波先对光线方向上的采样点进行平滑处理,进而相对准确地获得特征点的位置信息.特征点信息获取的相关伪码表示如下://光线上采样点索引intj=0;//确定特征点函数booleanLocateTransitionPoint(j){floattemp[5];for(inti=0;i<5;++i){//采样周围5个点temp[i]=sample_intensity(j+i-2);//低通滤波,去除噪声干扰temp[i]=lowPassFilter(temp[i]);}//判断该采样点是否为波谷位置if(isValley(temp[])returntrue;elsereturnfalse;}3.动态更新最大标量值.由于步1获得的最大标量值很有可能遮挡其后面的有效信息,使得最终显示的信息不完整.例如,图2中的特征3和特征4将会因为特征2的标量值较大而被隐藏,不能有效显示.因此,为了能够有效显示最大标量值之后的特征信息,我们在步2获得的特征点位置,根据特征点的深度信息,动态修改最大标量值,如式(4)所示.其中,u表示当前特征点的深度信息,即特征点到视点平面归一化后的值.归一化的过程中,最大值为终止点距离视点平面的距离,最小值为起始点距离视点平面的距离.具体的归一化过程如图3所示.当特征点距离视点较近时,更新后的最大标量值变化幅度相对较大,因此距离视点较近的特征得以较完整地显示;而距离视点较远的特征显示的贡献将会逐渐变小,这样更符合人眼视觉观察的要求.然而,u未必会真实或准确地约束当前最大标量值的最优变化,显示过多的特征将会影响绘制结果的质量,无法识别体数据中的主要特征.为了解决这一问题,我们将u归约到0.8~1.0之间,即u的最小值为0.8,使得fmaxi不会取得较小的标量值.这样既能够保证相对明显的特征有效地显示出来,又降低了特征不明显的信息对最终绘制结果的干扰.通过式(4),我们获得了更新后的最大标量值fmaxi,进而继续采样时可以随之更新最大标量差mi,如式(5).我们通过寻找特征点的深度信息,相对合理地改变当前最大标量值,对于特征点位置之后的特征信息,将以更新Page5当前采样点的颜色值和不透明度.ci=(1-mi)×ci-1+(1-(1-mi)×αi-1)×c(fpi)×α(fpi),后的最大标量值判断其是否属于有效特征,故可以有效地改进MIDA算法的不足,将最大标量值之后的隐藏信息显示出来,获得信息更加丰富、特征更加明显的绘制结果.4.二维图像颜色值获取.根据步3中改进的最大标量差mi,进而通过式(6)累加αi=(1-mi)×αi-1+(1-(1-mi)×αi-1)×α(fpi)(6)按照上述公式,对光线方向的每个采样点的颜色值和不透明度值进行累加,最终获得该光线在二维图像中对应像素的颜色值,由于改进后的最大标量差mi是基于隐藏特征与当前最大标量值fmaxi的差,因此能够显示出当前最大标量值fmaxi之后标量值大于fmaxi的特征信息.3.3本文算法的实现按照上述步骤,本文在GPU上实现了有效显示隐藏特征的光线投射算法,下面给出了本文算法的实现过程://体绘制函数volumeRendering(){//遍历光线,从起始点至终止点for(inti=startPos;i<endPos;i++){//初始化最大标量差m=0;if(sample_intensity(i)>max_intensity){//计算最大标量差m=(sample_intensity(i)-max_intensity);//更新最大标量值max_intensity=sample_intensity(i);}//判断特征点过程elseif(LocateTransitionPoint(rayPos)){//更新最大值//u是将(d-d1)/(d2-d1)归约至[0.8,1]中的值}//累加颜色和不透明度,获得二维图像显示color=(1-m)×color+(1-(1-m)×color.a)×color.a=(1-m)×color.a+(1-(1-m)×color.a)×}相对于已有的MIP、DVR和MIDA算法,本文算法尽可能地考虑了光线方向上的所有特征,根据特征点的深度信息,动态地修正最大标量值,进而改进最大标量差.而且,在改进最大标量值的过程中,为了防止大量特征信息重叠混合,造成绘制结果的混乱和不清晰,我们将特征点的深度信息归约至[0.8,1],因此便可以忽略相对不重要的信息,将满足深度阈值的隐藏特征信息有效地绘制出来.根据本文算法与传统算法在最终绘制颜色值信息的不同,图4给出了4种算法的颜色值在不透明度和标量值变化过程中的对比关系.图4颜色值随着标量值和不透明度变化示意图图4中,较粗的实线代表不透明度的变化曲线,较细的实线代表标量值的变化曲线,虚线代表颜色值的变化曲线.可以看出,经典的MIP算法只是选择最大的标量值,最终的颜色显示信息量单一,而DVR算法在不透明度接近于1的过程中,其后面采样点的标量值对最终的颜色几乎没有贡献.MIDA算法一定程度上克服了上述两种算法的缺点,不透明度的值会因为遇到新的感兴趣特征信息而发生变化,改进了最终生成的颜色值,然而光线上的最大标量值很容易遮挡了后面的特征信息,从而隐藏了其后的感兴趣特征信息,降低了绘制效果.而本文提出的基于隐藏信息显示的光线投射算法,可以识别最Page6大标量值之后的特征信息,进而有效地显示出更多的隐藏信息,实现完整的三维体数据显示和丰富的信息表达.4实验结果在验证本文算法有效性的过程中,我们对真实采样的医学数据、模拟仿真数据、工业CT等数据做了相关对比实验,即在相同的一维传输函数作用下,分别采用MIP算法、DVR算法、MIDA算法以及本文算法对原始体数据进行绘制,并且对各种算法的图5Head数据的体绘制结果图6Ncat_phantom数据的体绘制结果对比例如,通过图5(a)可以看出,通过简单的传输函数,DVR算法获得的绘制结果有效地显示出了脑皮肤信息,但是由于不透明度的累加值过早接近于1,使得Head数据内部的信息,譬如牙齿、颅骨、下颚等有效信息均被隐藏,以致有效信息和感兴趣结构信息的丢失;图5(b)的结果则充分显现出了MIP算法的不足,单纯描述了最大标量值信息,缺乏背景信息和相邻信息,不利于后续处理;MIDA算法获得的图5(c)相对于前两种算法有了一些改进,由于采样到重要的信息时,不透明度会相应作出调整,因此累加获得的图片信息量相对丰富,颅骨、牙齿等信息均有显示,但是标量值较大信息背后的结构却有缺损,譬如颈椎信息、Head数据另外一侧的牙齿信息和眼眶信息均被隐藏,不利于医生进一步的观察和诊断.图5(d)是本文算法的绘制结果,相复杂度做了简单的分析和讨论.4.1医学数据体绘制结果为了说明本文算法运用于医学数据可视化的有效性,我们采用两组医学数据做了相关的对比实验,实验数据分别是大小为128×256×256的Head真实采样数据和大小为256×256×256的Ncat_phantom模拟仿真数据.图5和图6是两组数据在相同的一维传输函数作用下,分别采用DVR算法、MIP算法、MIDA算法以及本文算法的绘制结果.通过图中绘制结果的对比,我们可以清楚地判断绘制算法的有效性.对于MIDA算法,本文算法对当前最大标量值的后续特征进行了有效的绘制,可以看出,Head数据下颚和颈椎信息很明显地表现出来,另外一侧的牙齿信息和眼眶信息表现得也很明显,绘制的结果也更加清晰,结构更加丰富,一定程度满足了医学领域专家的需求,而且并不需要其具备可视化的专业知识,调整复杂的传输函数.图6给出了Ncat_phantom数据的绘制结果.由图6(d)可以看出,采用本文算法可以有效观察标量值较大的骨骼信息后面隐藏的有效信息,模型中肋骨的信息完整地表现出来,更加有助于医生校准患者身体的内部结构,全面地诊断患者的病因,有效地满足了医学领域的某些特定应用.相比于DVR算法、MIP算法和MIDA算法,本文算法绘制的信息更加丰富,最大标量值之后的信息能够有效地显示,对医生的正Page7确诊断有一定的指导作用和较强的辅助作用.4.2工业数据体绘制结果对比工业检测是当代计算机集成制造系统中非常重要的组成环节,是保证和提高产品质量的重要手段,已经广泛应用于航天、汽车制造等重要领域.三维数图7Engine数据的体绘制结果对比为了更好地验证本文算法的有效性,我们有意将Engine数据标量值较大的金属面放置于距离视点较近的一侧.由绘制的结果可以看出,DVR算法的绘制结果颜色比较暗淡,只能看到工业品的表面信息;MIP算法的绘制结果缺乏背景信息,只能大概判断有效信息的位置;MIDA算法绘制的结果相对真实,但是由于光线过早采样到较大的标量值,所以后面的结构信息被遮挡,不能实现信息的完整显示;而本文算法恰恰能够寻找到最大标量值后面的特征信息,并通过特征位置的深度信息调整当前最大标量值,对隐藏特征进行有效显示.从图7(d)可以看出,本文算法既保证了工业数据绘制结果的真图8当u取不同值时,绘制结果与DVR、MIP和MIDA算法的比较据可视化技术有效地提高了工业测量的精度,避免了物理测量烦琐的过程,因此在工业数据测量领域中得到了广泛的应用.我们采用了标准的256×256×256的工业数据Engine进行了对比实验,实验结果如图7所示.实,又能有效地观察其内部的结构信息,对工业数据的配准与误差检查均有很大的帮助,因此本文算法在工业检测领域有较强的实用价值.4.3用户指定阈值的绘制结果对比此外,为了能够更好地满足领域专家的需求,我们可以不考虑特征点的深度信息,而是直接人为指定u的值.领域专家通过简单地调节u,便可以控制当前最大标量值的变化,有选择性地绘制感兴趣信息,增强了算法的灵活性.为了更好地说明阈值选取的重要性,我们对大小为246×246×211的Present数据按照不同的u值进行绘制,结果与传统的绘制算法对比如图8所示.Page8可以看出,阈值u对绘制的结果发挥重要作用.u的值如果比较小,那么会导致相对不重要的特征信息也要显示,使得之前的有用信息模糊或者忽略.图8(c)可以看出,盒子内部的礼物信息虽然能够显示出来,但是外面层次的信息几乎被忽略,不符合我们显示隐藏信息的最终目标.随着u值的不断变化,在DVR算法中被盒子隐藏的内部信息逐渐地显示出来.当u=1.0,绘制的结果即MIDA算法的绘制结果,如图8(h)所示.虽然盒子信息保留相对完整,但是内部的圆形包装和内部的礼物信息已经隐藏.通过对比可以看出,当u的取值介于[0.8,1]区间时,绘制结果的信息是最清晰的,既可以看到盒子的轮廓信息,也能有效描述礼物信息,如图8(e)、(f)所示.因此,通过人为动态设定u值,增强了算法的灵活性,不仅可以使领域专家能够直观地调整参数生成感兴趣的结果,而且能够增强算法的鲁棒性,具有较强的应用意义.4.4算法复杂度分析上述绘制算法中,MIP算法的绘制效率是最高的,但是绘制的结果缺乏背景信息,具有很大的局限性;DVR算法对光线方向上每个采样点均计算光照,因此时间复杂度较高,而且要获得信息丰富的绘制结果,必须需要有经验的专家调节复杂的传输函数;MIDA算法虽然需要实时更新最大标量值,但是不需要调节复杂的传输函数,因此相对于DVR算法,复杂性较低,且绘制的结果能够显示体数据内部标量值较大的信息和结构.而本文算法则是在MIDA算法的基础之上,增加了一个简单的低通滤波器,用于判断特征点的位置.相比于MIDA算法,本文算法时间复杂度略有提升,但是能够有效显示最大标量值之后隐藏的特征信息,而且同样不需要调整复杂的传输函数,能够帮助领域专家更快、更准确的分析初始数据,具有较强的应用性.5结束语直接体绘制技术提供的是一种针对不同领域三维数据的可视化方法.如何结合领域知识,切实地满足领域专家的需求是体绘制技术的首要目标.因此,避免使用复杂的传输函数,而又能获得相对满意的可视化结果的绘制算法是当前研究的热点与难点.本文在分析了传统光线投射算法的优势和缺点的基础之上,提出了一种新的基于隐藏特征显示的GPU光线投射算法.该算法在已有的MIDA算法的基础之上,通过寻找最大标量值之后的特征点,根据特征点的深度信息动态改变当前最大标量值,进而根据改进的最大标量差有效地控制颜色和不透明度的累加值,使得MIDA算法最大标量值之后的隐藏信息能够有效地显示到二维图像表示中.本文算法分别应用于医学数据和工业数据可视化,均获得了较好的绘制结果,具有一定的应用价值.隐藏信息的绘制是体绘制技术领域一个有意义的环节,本文算法致力于隐藏信息的显示,取得了一定的成效.然而,如何将特征点的深度信息与强度信息有效结合,以及如何更准确地判断特征点的位置、摆脱噪声的干扰依然是难点问题,也是我们接下来工作的重点.
