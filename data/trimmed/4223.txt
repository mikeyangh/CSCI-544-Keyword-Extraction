Page1基于样本的大规模人群快速创作申晶晶王欣捷倩文金小刚(浙江大学CAD&CG国家重点实验室杭州310058)摘要人群作为虚拟环境中必不可少的一部分,能够极大地提高场景的真实感.文中提出一种基于样本的大规模人群快速创作方法,将人视为具有分布和角色信息的粒子,通过从真实图片中获取包含小规模人群粒子信息的样本,由样本建立WangTile集合,使用WangTile非周期性拼接覆盖场景区域,从而快速生成任意规模人群.文中的创作方法简单快速,用户只需输入若干样本和场景区域.同时,用户可以通过调整Tile的边颜色快速地进行局部人群修改,也可以使用密度图得到用户需要的效果.实验给出了3个场景的人群创作效果,表明文中的方法可以十分迅速地生成大规模具有真实分布信息的多样人群.关键词人群创作;WangTile;虚拟场景1引言在虚拟环境中创作和模拟人群,能够极大地提高场景的真实感和沉浸感,已被广泛应用于许多领域,如娱乐、广告、建筑、教育、游戏及公共安全辅助设计等.近年来,随着计算机硬件的不断发展,所能交互模拟虚拟环境的规模也越来越大,相应的人群规模也随之增加.现有群组研究主要关注人群的运动行为控制和实时绘制,而对于如何在虚拟环境中Page2进行初始人群的创作,则很少有涉及.对于大规模场景及人群模拟来说,如何快速高效地完成人群的初始分布及状态设置,并使其具有多样性和真实性,是一个急需解决的问题.对于成千上万的人群,如果需要对每个人物角色进行位置、朝向等模拟相关属性进行设置和修改,对用户来说,依次修改将是一个巨大并且繁琐的任务.如果只是随机设置这些属性,则会导致结果不符合真实人群的特点,很难控制达到用户所需效果.如果采用简单规则对人群进行排列,又会导致结果过于规整或重复,同时,复杂的人群分布规则难以用数学方程描述.基于上述问题,本文提出一种基于样本的大规模人群快速创作方法,将人视为具有分布和角色信息的粒子,通过从真实图片中获取包含小规模人群粒子信息的样本(或由用户创作所需样本),建立样本库,基于WangTile方法,使用样本制作WangTile集合,使用WangTile非周期性拼接覆盖场景区域,从而迅速生成任意规模场景内的多样人群.本文的创作方法简单快速,用户只需输入若干样本和需要人群覆盖的场景区域.另外,用户可以通过调整Tile的边颜色快速地修改局部人群,或使用密度图控制全局效果.2相关工作人群创作的目标在于如何在虚拟场景中逼真地再现多样的人群[1-2].人群中每个角色的属性包括初始分布信息(位置和朝向)、角色属性信息(性别、姿态等)和模拟属性信息(目标点或方向、半径等).本文工作关注的是初始分布信息和角色属性信息,模拟相关属性由三维角色模型确定.基于规则的方法,如Reynolds的flocking模型[3]、Helbing的社会力模型[4],可以模拟具有一定复杂性的人群分布,但很难通过调整局部规则来控制最终效果,也难以模拟到用户指定的效果.基于全局速度场的宏观方法,包括基于地图信息[5-6]、用户交互控制导航[7-9]、基于连续介质理论[10-11]、基于流体模型[12]等,只能用于全局运动控制效果,无法控制局部人群的分布效果.王兆其等人[13]的Guarder系统提供了人群疏导预案编辑功能,采用手工交互的方法设定人群的初始属性.Ulicny等人[12]的Crowdbrush模型提供了一种实时创作和绘制人群的方法,用户可以使用笔刷来编辑和控制人物角色信息,由于操作更多针对的是单个或若干个角色,因此需要大量的用户交互.Yersin等人[14]提出基于CrowdPatch的大规模场景人群创作及动画方法,通过预先将人物角色的运动轨迹存储在Patch中,再进行拼接,从而得到最终效果,然而,该方法中Patch设计过于复杂,需要满足空间及时间连续,因此,所能模拟的人群分布及动画种类十分有限,此外,用户也无法修改拼接后的人群场景.Ju等人[15]提出的基于数据驱动的人群模拟方法,从真实视频中分类学习获得小规模人群分布样本,模拟中,根据每组人群的分布是否在样本集中来进行添加个体及控制运动,由于需要检测每个个体的邻近区域与整个样本集的相似度,因此,人群的合成速度十分缓慢,合成结果也十分规律,不适用于大规模多样人群的快速合成.Guy等人[16]提出了基于心理学模型参数化描述人物角色行为特性的方法,关注的是角色运动相关参数的设置.WangTile,由数学逻辑家王浩[17]在1961年提出,是一组大小相同的正方形Tile,对Tile的每条边都设定一种颜色,如果一个Tile的某条边与另一个Tile的某条边的颜色相同,则可以将这两个Tile拼接摆放,使用一组WangTiles拼接铺满整个平面,生成的图案是非周期性的,如图1所示.Cohen等人[18]提出了基于WangTile进行实时纹理合成的方法,由样本纹理拼接预先生成WangTile,使用WangTile快速拼接合成纹理[19].Kopf等人[20]提出基于WangTile生成采样点集的方法.3人群快速创作系统本文将人群中的每个角色视为粒子,每个粒子包含其初始分布信息、角色属性信息和附加信息.初始分布信息包括位置犘(Px,Py)和朝向犗(Ox,Oy),角色属性信息主要是人物三维模型的属性信息,包括性别Gender、年龄Age、姿态Pose(即对应动作序列),附加信息包括半径Radius和等级Rank.算法部分主要处理位置信息和朝向信息,角色属性信息用于从三维人物模型库中选择符合条件的角色模型进行显示,附加信息主要用于最后的人群密度调整,等级Rank值越小的粒子在该样本中的重要性越高.系统的主要流程包括:Page3本中包含具有局部人群信息的粒子集;(1)局部区域人群样本库建立.每个正方形样(2)WangTile集的合成.根据样本库合成WangTile,处理Tile内部相邻样本重合区域内的粒子的分布;(3)场景区域拼接覆盖.根据用户输入区域,使用WangTile快速拼接覆盖,得到场景内人群粒子集合;(4)用户编辑修改.通过观察颜色所代表的样本,直观地调整局部人群,也可以通过调节密度场来控制全局效果;图1WangTile拼接示意图(5)三维人物角色模型匹配.根据粒子的三维人物模型属性信息从模型库中索引获得相应的三维角色模型.3.1建立人群样本库本文目标在于在虚拟场景中快速生成人群初始信息,使其具有一定的真实性或满足用户指定类型.因此,可以从真实人群图片中提取包含人群信息的样本,或由用户设计指定样本,建立样本库来达到真实的目标.每个样本为一个正方形区域,将边长置为1.0,包含的人群位置信息对应缩放至0~1.0.如图2所示,从真实图片中选取若干个关注的正方形区域(图2(a)),从框定区域中确定想要提取的人群信息(图2(b)),选定若干个体,判断并设置其分布信息和角色属性信息.确定样本库后,为每个样本设置一Page4个不同的颜色编码,即一个颜色代表一个样本.图3为样本库示例,包含了12个从不同人群图片中提取的样本,不同样本中个体数也不同,这样能够合成密度各异的人群.3.2生成WangTile集合在建立了样本库并以颜色编码后,使用样本库制图4WangTile合成与纹理合成中的生成方法不同,本文处理的是粒子,而非像素,因此对于重叠区域的处理方法不同.在重叠区域内,粒子之间要保持一定间距,同时尽量保持原分布,使用Voronoi划分,选择一条分割线,使得所隔开的粒子距离最远.本文建立的是完全WangTile集,即每条边可选的颜色为整个样本集.另外,由于N边只与S边拼接,W边只于E边拼接,可以为N/S边设置一个可选样本集1,而为W/E边设置另外一个样本集2,使得人群横向和纵向分布的特点各不不同.图5为N/S边和W/E边各设2个可选样本组成的WangTile集合(24).为了达到快速地覆盖场景区域的目的,本文规定了WangTile集内的Tile的排列方式,通过4条作WangTile集合.每一个WangTile的合成步骤如下:(1)从样本库中随机选择4个样本(可重复),拼接组成一个较大的样本块,中间包含的菱形区域(图4(a)中虚线框)即为WangTile,重合部分Overlap_size∈(0.1,0.35);(2)在菱形区域内,对相邻样本重叠区域内的粒子集进行Voronoi划分,选择一条由Voronoi边组成的分割线(黑色实线),使得所隔开的粒子距离最远,分别保留位于分割线左侧的左侧样本粒子和位于分割线右侧的右侧样本粒子,保证重叠区域内粒子分布的自然性;(3)旋转裁剪后的菱形区域及位于其内的粒子,得到正方形Tile(图4(b)),根据样本颜色设置对应WangTile边的颜色编码.图516个WangTile,每条边2种可选颜色(Kv=2)边(N/S/W/E)的颜色计算其在索引列表中位置[19].假设我们的WangTile的竖直边(即W/E边)具有Kv个可选的颜色,而横向边只具有一种颜色,使用下述排列方式将这些Tile排列成一行,使得相邻边具有相同颜色:给定一个W/E边颜色编Page5码为(e1,e2)的Tile,通过式(1)计算得到的索引值,确定其在此行中的位置.这种索引排列方式保证每个Tile只使用一次,每个Tile具有一个范围在[0~Kv]的整数index.TileIndex1D(e1,e2)=对于二维索引,我们分别获取一维横向索引Ih和一维纵向索引Iv,对应分别为第Ih列和第Iv行.3.3使用WangTile非周期性拼接覆盖场景在虚拟场景中,用户指定需要人群覆盖的多边形区域,系统选择最长边作为Tile拼接需要对齐的边界,计算边界矩形区域及所需Tile行数H_NUM和列数C_NUM.在矩形覆盖区域内,从WangTile集合中随机挑选(或部分指定)H_NUM×C_NUM个Tile进行图6场景拼接实例3.4交互编辑用户具有两种编辑人群场景的方式:(1)用户可以通过观察每个颜色所代表的样本,在最后覆盖区域内指定或修改若干位置处Tile边颜色,调整局部人群效果;(2)通过输入密度场,调整人群密度.用户可以从图片中提取或设计密度场,作为一张密度图片输入,如图7所示,处理图(a)所示图片获得密度分布,见图片(b),使用这个密度分布,调整Tile拼接覆盖后得到人群粒子CrowdParticles,即图(c),获得最终人群分布(d).调整过程如下:首先基于粒子Rank信息对CrowdParticles进行由小到大排序,然后根据顺序依次判断该粒子是否应该被保留,例如第i个粒子位置为犘i(Px,Py),使用其周围像素的灰度线性插值或周围Border×Border个像素的平均密度值作为此点密度值sampleDensMap(Px,Py),若符合匹配规则的铺排拼接.随机非周期性拼接过程如下:(1)指定矩形区域的边界约束,假设选择N/W边,则指定其上对应一排(一列)Tile的N(W)边颜色,即BN[H_NUM+1]和BW[C_NUM+1]的颜色值;(2)从约束边界开始选择满足匹配条件的Tile铺排区域,铺排方向从N到S,从W到E,得到矩形区域内的人群粒子CrowdParticles;(3)根据原输入场景区域,删除位于其外的粒子,如果场景内具有障碍物,删除位于障碍物多边形之内的粒子,得到最终覆盖场景的人群粒子CrowdParticles.本文在两个场景中使用Kv=6的WangTile集合进行区域覆盖,其结果如图6所示.其中,图6(a)场景具有156个Tile,1492个人,图6(b)具有1396个Tile,9654个人.sampleDensMap(Px,Py)<i×FACTOR,舍弃该粒子.其中,FACTOR与需要生成的人群规模相关,FACTOR越大,生成的人群规模越大.3.5三维人物角色模型匹配最终场景中人群的多样性主要由两个因素决定,一个是合成WangTile集合所使用的样本数量,另一个是所使用的三维人物模型各异性.具有相同角色属性的粒子可以使用不同的三维人物模型,可选择模型越多,最后的人群场景更加丰富.本文建立一个统一的三维人物模型库,使用部分角色属性信息(性别Gender、姿态Pose)对模型进行分类存储.根据最后的CrowdParticles集,使用粒子信息在模型库中索引到对应的三维人物模型,在多个满足条件的模型中随机选取.图8是一个存储示意图.Page6图7交互编辑处理图8模型库分类索引举例Page74结果与分析4.1性能测试本文的测试在处理器为Intel(R)Core(TM)2Q9550@2.83GHz,内存为8GB,显卡为NVIDIAGeForceGTX280的台式机上完成.本文的算法主要分为两部分:WangTile集合的合成和使用Tile拼接覆盖场景区域,因此分别对这两个部分的运行时间进行测试.首先,通过变化WangTile中每条边可选的颜色数K(即样本数),测试生成规模为K4的WangTile集合所需计算时间,测试中使用的每个样本中人数从8~16不等,由于重合区域的设置值对计算时间也具有一定影响,因此实验分别测试了Overlap_size为0.2和0.3时的计算时间.测试数据如表1中所示.表1合成不同规模WangTile集合的所需时间边可选颜色数K3810.01542560.04756250.109612960.250840960.63910100001.63812207363.18314384166.303166553610.498进一步测试使用规模为64的WangTile集,拼接H_NUM×C_NUM个Tile生成覆盖场景人群的时间,测试数据如表2中所示.从结果中可以看出,使用WangTile拼接覆盖场景十分快速,使用9万个Tile拼接生成百万规模的人群粒子的计算时间不到1s.H_NUM×C_NUM计算时间/s生成人群规模10×1020×2040×4060×60100×100200×200300×300最后,测试使用本方法与用户手工交互生成虚拟人群方法的时间效率差异性.采用6个样本(即K=6)共72个个体形成的样本库,产生从103~105个体规模不等的虚拟人群.在测试中,我们假设手工交互的软件操作界面非常友好且能够保证实时性,分别针对能够熟练操作软件的专业人员和只简单接触过计算机的一般性非专业人员进行调查,得出表3中的数据.表3用户调整一个虚拟人的位置和朝向需要的平均时间创作样本时调整虚拟人群时根据表3的数据,估算出这两种方法生成大规模虚拟人群所需要的时间.本方法需要的时间为:用户创作样本时间+程序的计算时间;用户手工交互生成虚拟人群方法需要的时间为:随机方法的计算时间+用户调整虚拟人群的时间.由于本方法的程序计算时间和随机方法的计算时间都是毫秒级,故可忽略不计.最终估算结果如表4所示.人群规模手工交互1035×1031.5×10472021605×1032.5×1047.5×10472021601045×1041.5×10572021602×1041053×10572021601055×1051.5×10672021604.2结果测试如图6和图7所示,本文建立了3个场景,使用的WangTile集中每对边具有6种可选颜色,使用的人物模型库具有42个模型,分类如图8所示.最终的场景结果截图如图9、图10和图11所示.合成的大规模人群场景符合实际局部人群分布特点,且具有一定各异性.与随机生成大规模人群方法相比,本文的方法在用户设置好若干个初始分布样本之后,即可迅速生成任意规模人群,且生成的人群具有方向信息,局部分布符合实际场景,全局并不会出现明显地周期性重复现象;而对于随机方法,在生成人群之后,用户往往需要进一步调整修改人物角色方向和局部分布等,对于成千上万的人群创造来说,这将是一个巨大并且繁琐的任务.图12和图13表明,本方法所生成的虚拟人群更具自然性和真实性.随机生成方法产生的虚拟人群(图12(a),图13(a))与本方法(图12(b),图13(b))相比,个体之间缺乏互动性,显得单调、不足以体现自然人群的真实分布.Page8图9场景1:广场截图图10场景2:小镇截图Page9图11场景3:城市截图图12随机生成方法与基于样本的WangTile快速拼接方法对比(近距离)图13随机生成方法与基于样本的WangTile快速拼接方法对比(远距离)Page105结论本文着眼于大规模场景中人群的快速创作,提出基于样本合成WangTile集,快速拼接生成非周期性任意规模人群的创作系统.该系统通过真实数据提取或用户自主设计来建立样本,使得合成人群的分布满足一定真实性及用户的需求;通过合成WangTile集,使用WangTile快速拼接生成任意规模人群,简单快速,且结果具有一定的多样性;另外,系统为用户提供了直观地编辑控制结果的方法,用户可以通过指定场景中部分区域Tile边颜色直观地调整局部人群,也可以通过密度场便利地调整全局人群效果.本文所提供的人群创作算法可适用于各种虚拟现实环境,尤其是需要产生自然人群分布的虚拟街景、公路景观等.在未来的工作中,我们尝试将本文的算法应用在大规模虚拟交通模拟中[21-23],从而产生符合现实的行人人群.而且,本文基于样本的思想也可用于汽车群的创作.
