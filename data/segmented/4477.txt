Page1/ 一种/ 面向/ 内核/ 接口/ 的/ 顺序/ 依赖/ 规则/ 挖掘/ 与/ 违例/ 检测/ 方法/ 刘虎球/ 白家/ 驹/ 王/ 蠫/ 屏/ (/ 清华大学/ 计算机科学/ 与/ 技术/ 系/ 北京/ 100084/ )/ 摘要/ 内核/ 扩展/ 函数/ 以/ 接口/ 的/ 形式/ 提供/ 给/ 驱动/ ,/ 用于/ 管理/ 设备/ 和/ 申请/ 相关/ 的/ 资源/ ./ 这些/ 接口/ 中/ 存在/ 大量/ 的/ 顺序/ 依赖/ 规则/ ,/ 如/ 自旋/ 锁/ 必须/ 经过/ 初始化/ 才能/ 加锁/ ,/ 然后/ 才能/ 解锁/ ;/ 驱动/ 在/ 加载/ 时/ 申请/ 的/ 内存/ ,/ 卸载/ 时/ 必须/ 予以/ 释放/ 等/ ./ 然而/ ,/ 驱动/ 开发者/ 常常/ 不/ 熟悉/ 或/ 疏忽/ 内核/ 接口/ 的/ 使用/ 规则/ ,/ 导致/ 驱动/ 中/ 存在/ 大量/ 的/ 接口/ 使用/ 违例/ ,/ 影响/ 驱动/ 及/ 系统/ 的/ 可靠/ 运行/ ./ 文中/ 提出/ 了/ 一种/ 面向/ 内核/ 接口/ 的/ 顺序/ 依赖/ 规则/ 挖掘/ 与/ 违例/ 检测/ 方法/ (/ SD/ -/ Miner/ )/ ./ 该/ 方法/ 结合/ 驱动/ 源码/ 的/ 结构特征/ ,/ 对/ 驱动/ 代码/ 使用/ 的/ 内核/ 接口/ 进行/ 统计分析/ ,/ 挖掘/ 并/ 提取/ 内核/ 接口/ 的/ 顺序/ 依赖/ 规则/ ,/ 并/ 利用/ 提取/ 的/ 规则/ 检测/ 现有/ 的/ 驱动/ 源码/ 中/ 的/ 使用/ 违例/ ./ SD/ -/ Miner/ 对/ Linux3/ ./ 10.10/ 和/ 2.6/ ./ 38/ 的/ 驱动/ 源码/ 分别/ 进行/ 了/ 规则/ 挖掘/ 和/ 违例/ 检测/ ./ 对比/ 检测/ 结果/ 发现/ ,/ 在/ 2.6/ ./ 38/ 中/ 检测/ 出/ 的/ 错误/ 中/ ,/ 有/ 64/ 处在/ 3.10/ ./ 10/ 中/ 得到/ 了/ 修正/ ./ SD/ -/ Miner/ 检测/ 和/ 分析/ Linux3/ ./ 10.10/ 的/ 3781/ 款/ 驱动/ 的/ 过程/ 仅/ 耗费/ 5min/ ,/ 共计/ 提取/ 出/ 了/ 220/ 个/ 顺序/ 依赖/ 相关/ 的/ 接口/ 使用/ 规则/ ,/ 并/ 检测/ 到/ 了/ 756/ 个/ 使用/ 违例/ ,/ 作者/ 将/ 其中/ 50/ 个/ 提交/ 给/ 了/ 开发者/ ,/ 累计/ 有/ 25/ 个/ 回复/ 者/ 对/ 20/ 个/ 使用/ 违例/ 进行/ 了/ 确认/ ./ 实验/ 结果表明/ ,/ SD/ -/ Miner/ 能够/ 有效/ 地/ 挖掘出/ 内核/ 接口/ 的/ 顺序/ 依赖/ 规则/ ,/ 并/ 检测/ 出/ 使用/ 违例/ ,/ 进而/ 辅助/ 开发人员/ 对/ 驱动/ 进行/ 修正/ 来/ 提高/ 驱动/ 可靠性/ ./ 此外/ ,/ 规则/ 的/ 挖掘/ 是/ 基于/ 驱动/ 的/ 结构/ 信息/ 和/ 统计/ 信息/ ,/ 不/ 需要/ 开发者/ 在/ 源码/ 中/ 提供/ 额外/ 的/ 注释/ 及/ 标注/ ./ 关键词/ 内核/ 扩展/ 函数/ ;/ 规则/ 挖掘/ ;/ 违例/ 检测/ ;/ 顺序/ 依赖/ 规则/ 1/ 引言/ 驱动/ 的/ 可靠性/ 对/ 操作系统/ 的/ 稳定/ 运行/ 具有/ 重要/ 意义/ ./ 统计/ 结果表明/ ,/ 驱动/ 所/ 引发/ 的/ 错误/ 是/ 内核/ 的/ 3/ ~/ 7/ 倍/ [/ 1/ ]/ ,/ 即使/ 在/ 成熟/ 的/ 商业/ 操作系统/ XP/ 中/ ,/ 也/ 有/ 85/ %/ 的/ 崩溃/ 与/ 驱动/ 相关/ [/ 2/ ]/ ./ 由于/ 驱动/ 是/ 由/ 不同/ 的/ 组织/ 和/ 机构/ 编写/ ,/ 这些/ 错误/ 在/ 大多数/ 情况/ 是/ 由于/ 接口/ 规则/ 过于/ 复杂/ ,/ 开发者/ 对/ 内核/ 提供/ 的/ 接口/ 缺乏/ 足够/ 的/ 了解/ ,/ 常常/ 忘记/ 或者/ 疏忽/ 接口/ 的/ 使用/ 规范/ 和/ 调用/ 规则/ ,/ 从而/ 造成/ 大量/ 的/ 使用/ 违例/ ,/ 使得/ 大量/ 错误/ 隐藏/ 在/ 驱动/ 源码/ 中/ ./ 如图/ 1/ 所示/ ,/ Linux/ 驱动/ 8250/ (/ 版本/ 3.10/ ./ 10/ ,/ driver/ // tty/ // serial/ // 8250/ // 8250/ _/ dw/ ./ c/ )/ 在/ 加载/ 时/ 将/ 调用函数/ dw8250/ _/ probe/ ./ 该/ 加载/ 函数调用/ devm/ _/ ioremap/ 、/ devm/ _/ kzalloc/ 、/ clk/ _/ prepare/ _/ enable/ 等/ 接口函数/ ,/ 并且/ 上述/ 部分/ 函数/ 在/ 调用/ 时/ 存在/ 直接/ 的/ 调用/ 顺序/ 依赖/ 关系/ ./ 如/ devm/ _/ kzalloc/ 必须/ 在/ clk/ _/ prepare/ _/ enable/ 之前/ 被/ 调用/ ,/ 否则/ 将/ 出现/ 使用/ 违例/ ./ 同样/ ,/ 在/ 驱动/ 卸载/ 时/ ,/ 需要/ 调用/ 配对/ 的/ 接口函数/ 将/ 加载/ 时/ 申请/ 的/ 资源/ 进行/ 释放/ ./ 如/ 调用/ pm/ _/ runtime/ _/ disable/ 来/ 关闭/ 231253258263264287293294297299305307308310311314/ }/ staticintdw8250/ _/ remove/ (/ structplatform/ _/ device/ / pdev/ )/ {/ serial8250/ _/ unregister/ _/ port/ (/ data/ -/ >/ line/ )/ ;/ if/ (/ !/ IS/ _/ ERR/ (/ data/ -/ >/ clk/ )/ )/ staticintdw8250/ _/ probe/ (/ structplatform/ _/ device/ / pdev/ )/ {/ xxx/ =/ devm/ _/ ioremap/ (/ &/ pdev/ -/ >/ dev/ ,/ regs/ -/ >/ start/ …/ )/ ;/ if/ (/ !/ IS/ _/ ERR/ (/ data/ -/ >/ clk/ )/ )/ }/ 在/ 加载/ 时/ 通过/ pm/ _/ runtime/ _/ enable/ 激活/ 的/ 设备/ ,/ 本文/ 中将/ 此类/ 函数/ 称为/ 配对/ 函数/ ./ 另外/ ,/ 在/ 卸载/ 时/ 执行/ 的/ 接口/ 函数调用/ 顺序/ 与/ 加载/ 时/ 调用/ 的/ 函数/ 顺序/ 同样/ 存在/ 关联/ ,/ 如/ 加载/ 时先/ 执行/ pm/ _/ runtime/ _/ set/ _/ active/ ,/ 则/ 在/ 卸载/ 时后/ 执行/ 其/ 配对/ 函数/ pm/ _/ runtime/ _/ put/ _/ noidle/ ./ 值得一提的是/ ,/ 在/ 图/ 中/ ,/ 卸载/ 时/ 没有/ 调用/ devm/ _/ kfree/ 来/ 释放/ 在/ 加载/ 时/ 通过/ devm/ _/ kzalloc/ 申请/ 的/ 内存/ ,/ 因此/ 存在/ 使用/ 违例/ ,/ 执行/ 到/ 此处/ 时会/ 引发/ 内存/ 泄漏/ ./ 另一方面/ ,/ 驱动/ 中/ 存在/ 大量/ 的/ 互斥/ 或/ 互补性/ 操作/ [/ 2/ ]/ ,/ 操作/ 时/ 需要/ 遵守/ 许多/ 与/ 使用/ 顺序/ 相关/ 的/ 接口/ 使用/ 规则/ ,/ 我们/ 称之为/ 顺序/ 依赖/ 规则/ ./ 为/ 便于/ 描述/ ,/ 将/ 互斥/ 或/ 互补/ 操作/ 使用/ 符号/ P/ (/ Probe/ ,/ 加载/ )/ 、/ R/ (/ Remove/ ,/ 卸载/ )/ 表示/ ,/ 并称/ P/ // R/ 为/ 对偶/ 操作/ ./ 与/ 之/ 关联/ 的/ 顺序/ 依赖/ 规则/ 主要/ 涵盖/ 以下/ 3/ 个/ 方面/ :/ (/ 1/ )/ P/ 操作/ 调用/ 的/ 接口函数/ 需要/ 遵守/ 顺序/ 依赖/ 规则/ ,/ 如图/ 1/ 中/ 的/ devm/ _/ kzalloc/ 必须/ 在/ clk/ _/ prepare/ _/ enable/ 之前/ 被/ 调用/ ;/ (/ 2/ )/ R/ 操作/ 需要/ 调用/ 配对/ 的/ 接口函数/ 来/ 释放/ P/ 操作/ 中/ 申请/ 的/ 资源/ 等/ ;/ (/ 3/ )/ R/ 操作/ 中/ 调用/ 的/ 配对/ 的/ 接口函数/ 需要/ 遵守/ P/ 操作/ 中/ 逆向/ 的/ 顺序/ 依赖/ 规则/ ./ 上述/ 3/ 类/ 顺序/ 依赖/ 规则/ 普遍存在/ 于/ 驱动/ 中/ ,/ 如/ 在/ P/ 操作/ 中/ ,/ 使用/ 自旋/ 锁/ 需要/ 遵守/ 初始化/ spin/ _/ lock/ _/ init/ →/ spin/ _/ lock/ →/ spin/ _/ unlock/ 的/ 使用/ 顺序/ ,/ 对/ 设备/ 的/ 初始化/ 一般/ 遵循/ 申请/ 内存/ kmalloc/ →/ 地址映射/ ioremap/ →/ 设备/ 激活/ pci/ _/ enable/ _/ device/ 等/ 顺序/ ./ 而/ 在/ P/ 中/ 调用/ 一些/ 接口函数/ 后/ ,/ 在/ R/ 操作/ 中则/ 需要/ 调用/ 这些/ 接口/ 的/ 配对/ 函数/ 完成/ 资源/ 的/ 回收/ 操作/ ,/ 如/ kmalloc/ 与/ kfree/ 、/ ioremap/ 与/ iounmap/ 、/ pci/ _/ enable/ _/ device/ 与/ pci/ _/ disable/ _/ device/ 等/ ./ 在/ R/ 操作/ 中/ 使用/ 的/ 这些/ 配对/ 函数/ 的/ 序列/ 同样/ 存在/ 顺序/ 依赖/ ,/ 依然/ 针对/ 上述/ 调用/ 序列/ 来说/ ,/ 在/ 卸载/ 时/ 需要/ 遵守/ 的/ 顺序/ 依赖/ 规则/ 为/ :/ 失效/ 设备/ pci/ _/ disable/ _/ device/ →/ 取消/ 地址/ 映/ Page3/ 射/ iounmap/ →/ 释放/ 申请/ 的/ 内存/ kfree/ ./ 然而/ ,/ 由于/ 操作系统/ 中/ 缺乏/ 上述/ 顺序/ 依赖/ 规则/ 相关/ 的/ 规范/ 文档/ ,/ 加上/ 开发者/ 对/ 文档/ 的/ 查阅/ 热情/ 较/ 低/ ,/ 导致/ 驱动/ 开发者/ 容易/ 出现/ 使用/ 违例/ ./ 因此/ 对/ 驱动/ 源码/ 进行/ 检测/ 并/ 自动/ 提取/ 其中/ 的/ 使用/ 规则/ ,/ 将/ 有利于/ 规范/ 接口函数/ 的/ 使用/ ./ 目前/ ,/ 直接/ 针对/ 驱动/ 源码/ 进行/ 错误/ 查找/ 和/ 分析/ 的/ 研究/ 方法/ 主要/ 集中/ 在/ 检测/ 代码/ 中/ 的/ 类型/ 、/ 指针/ 等/ 错误/ [/ 3/ ]/ ,/ 或者/ 针对/ 具体/ 的/ 单一/ 的/ 资源/ 的/ 使用/ 规则/ 进行/ 违例/ 检测/ [/ 4/ ]/ ;/ 也/ 有/ 一些/ 研究者/ 使用/ 数据挖掘/ 的/ 手段/ 尝试/ 提取/ 大规模/ 软件/ 中/ 的/ 一些/ 使用/ 规范/ [/ 5/ ]/ ./ 但是/ 目前/ 的/ 这些/ 研究/ 方法/ 都/ 局限/ 在/ 一种/ 操作/ 内部/ 或者/ 单个/ 函数/ 内/ 的/ 调用/ 序列/ 上/ ,/ 不能/ 针对/ 上述/ 跨/ 函数/ 之间/ 的/ 顺序/ 依赖/ 规则/ 进行/ 解析/ ./ 本文/ 提出/ 一种/ 面向/ 内核/ 接口/ 的/ 顺序/ 依赖/ 规则/ 挖掘/ 与/ 违例/ 检测/ 方法/ (/ SD/ -/ Miner/ )/ ./ 该/ 方法/ 结合/ 驱动/ 源码/ 的/ 结构特征/ 对/ 驱动/ 代码/ 使用/ 的/ 内核/ 接口/ 进行/ 统计分析/ ,/ 利用/ 统计/ 信息/ 挖掘/ 并/ 提取/ 内核/ 接口/ 的/ 顺序/ 依赖/ 规则/ ,/ 并/ 利用/ 提取/ 的/ 规则/ 检测/ 现有/ 驱动/ 源码/ 中/ 的/ 使用/ 违例/ ,/ 辅助/ 提高/ 驱动/ 可靠性/ ,/ 并且/ 不/ 需要/ 开发者/ 提供/ 额外/ 的/ 注释/ 及/ 标注/ ./ 相比/ 传统/ 方法/ 具备/ 以下/ 优势/ :/ (/ 1/ )/ 不/ 需要/ 用户/ 定义/ 具体/ 的/ 接口/ 使用/ 规则/ ,/ 根据/ 统计/ 信息/ 进行/ 挖掘/ 并/ 检测/ 序列化/ 规则/ ;/ (/ 2/ )/ 跨/ 函数/ 直接/ 进行/ 接口/ 的/ 使用/ 规范/ 提取/ ;/ (/ 3/ )/ 结合/ 驱动/ 的/ 结构/ 信息/ 和/ 统计/ 信息/ ,/ 无需/ 程序/ 提供/ 额外/ 的/ 标注/ ./ 本文/ 第/ 2/ 节/ 主要/ 介绍/ 国内外/ 关于/ 驱动/ 相关/ 的/ 规则/ 检测/ 和/ 分析/ 的/ 研究/ 现状/ ;/ 第/ 3/ 节/ 阐述/ 了/ SD/ -/ Miner/ 的/ 具体/ 设计/ 与/ 实现/ 过程/ ;/ 第/ 4/ 节对/ SD/ -/ Miner/ 进行/ 了/ 评测/ ;/ 第/ 5/ 节对/ 全文/ 进行/ 了/ 简要/ 总结/ ./ 2/ 相关/ 工作/ 尽管/ 有/ 许多/ 提高/ 驱动/ 可靠性/ 的/ 方法/ ,/ 如/ FGFT/ [/ 6/ ]/ 、/ SymDrive/ [/ 7/ ]/ 等/ ,/ 但/ 对/ 驱动/ 代码/ 的/ 使用/ 规范/ 检查/ ,/ 仍旧/ 集中/ 在/ 传统/ 的/ 错误/ 检测/ 、/ 驱动/ 开发/ 规范/ 和/ 自动合成/ 等/ 方面/ ,/ 如/ 指针/ 错误/ 检测/ [/ 8/ ]/ 、/ 整型/ 数据/ 检测/ KINT/ [/ 3/ ]/ 等/ ./ 而/ 在/ 规则/ 检测/ 与/ 挖掘/ 方面/ ,/ 主要/ 包括/ 配对/ 规则/ 的/ 挖掘/ [/ 9/ ]/ 和/ API/ 规则/ 挖掘/ [/ 10/ ]/ 等/ ./ 下面/ 将/ 结合/ 具体/ 的/ 研究/ 方法/ 进行/ 简单/ 阐述/ ./ LXFI/ [/ 11/ ]/ 根据/ 程序员/ 的/ 标注/ ,/ 将/ 接口/ 的/ 使用/ 规则/ 内嵌/ 在/ 修改/ 后/ 的/ 接口/ 中/ ,/ 使得/ 驱动/ 模块/ 在/ 发生/ 错误/ 时/ 不会/ 扩散/ 成/ 安全漏洞/ ,/ 用以/ 抵御/ 特权/ 攻击/ ./ KFUR/ [/ 4/ ]/ 同样/ 是/ 通过/ 修改/ 原有/ 的/ 内核/ 扩展/ 函数/ ,/ 将/ 需要/ 遵守/ 的/ 规则/ 内嵌/ 到/ 接口函数/ 中/ ,/ 在/ 执行/ 接口函数/ 之前/ 自动/ 执行/ 规则/ 检查/ ./ Dingo/ [/ 12/ ]/ 针对/ 文档/ 的/ 不/ 规范/ 和/ 语义/ 混淆/ 问题/ ,/ 提出/ 了/ 一种/ 基于/ 协议/ 状态/ 自动机/ 的/ 设备描述/ 协议/ Tingu/ ,/ 可以/ 直接/ 辅助/ 开发人员/ 开发/ 设备/ 驱动/ ,/ 但是/ 该/ 方法/ 需要/ 重写/ 所有/ 驱动/ ./ Termite/ [/ 13/ ]/ 可以/ 在/ 上述/ 基础/ 上/ 自动合成/ 设备/ 驱动/ ,/ 但/ 生成/ 的/ 驱动/ 代码/ 量/ 较大/ ,/ 效率/ 较/ 低/ ./ 以上/ 方法/ 所/ 使用/ 的/ 接口/ 使用/ 规范/ 都/ 需要/ 开发人员/ 定义/ 并/ 书写/ ,/ 并且/ 仍/ 基于/ 锁/ 等/ 单一/ 资源/ ,/ 规则/ 也/ 相对/ 较为/ 单一/ ./ 所以/ 部分/ 研究者/ 提出/ 了/ 使用/ 挖掘/ 的/ 方法/ 提取/ 源码/ 中/ 的/ 规则/ ./ Engler/ 等/ 人/ [/ 9/ ]/ 通过/ 分析/ 提取/ 调用/ 的/ API/ ,/ 并/ 根据/ 调用/ 的/ 上下文/ 反推/ 与/ 之/ 关联/ 的/ 变量/ 和/ 函数/ 等/ ,/ 如/ spin/ _/ unlock/ 函数/ 的/ 调用/ 前提/ 是/ 已经/ 成功/ 执行/ 了/ spin/ _/ lock/ 函数/ 、/ 指针/ 在/ 使用/ 前/ 需要/ 初始化/ 等/ ./ MAPO/ [/ 14/ ]/ 则/ 利用/ 已有/ 的/ 代码/ 根据/ 当前/ 输入/ 的/ 代码/ 对/ 所/ 使用/ 的/ API/ 给出/ 相应/ 的/ 提示/ ,/ 其中/ 包括/ 关联/ 函数/ ,/ 如/ fopen/ 与/ fclose/ 等/ ./ 以上/ 规则/ 虽然/ 都/ 与/ 配对/ 函数/ 的/ 挖掘/ 相关/ ,/ 但是/ 不能/ 直接/ 提取/ 跨/ 函数/ 之间/ 的/ 接口函数/ 使用/ 时/ 需要/ 遵循/ 的/ 顺序/ 依赖/ 规则/ ./ PR/ -/ Miner/ [/ 5/ ]/ 利用/ 数据挖掘/ 的/ 方法/ ,/ 对/ 一个/ 函数/ 内部/ 可能/ 调用/ 的/ 函数/ 进行/ 统计分析/ ,/ 提取/ 潜在/ 的/ 最长/ 的/ 顺序调用/ 序列/ ,/ 然后/ 将/ 提取/ 的/ 调用/ 序列/ 进行/ 进一步/ 分析/ 并/ 提取/ 出/ 使用/ 规则/ ,/ 最后/ 结合/ 提取/ 的/ 规则/ 对/ 驱动/ 源码/ 进行/ 违例/ 检测/ ./ 但/ 该/ 方法/ 要求/ 代码/ 的/ 统计/ 与/ 重复/ 度/ 较大/ ,/ 无法/ 提取/ 一些/ 低频/ 的/ 顺序/ 依赖/ 相关/ 的/ 接口/ 使用/ 规则/ ./ CAR/ -/ Miner/ [/ 15/ ]/ 利用/ Java/ 和/ C++/ 的/ 异常/ 机制/ ,/ 在/ 异常/ 处理/ 时/ 对/ 已经/ 申请/ 的/ 资源/ 和/ 与/ 之/ 关联/ 的/ 序列/ 规则/ 进行/ 检测/ ,/ 进而/ 发现/ 其中/ 的/ 资源/ 未/ 被/ 释放/ 等/ 问题/ ./ WN/ -/ Miner/ [/ 16/ ]/ 提出/ 了/ 一种/ 使用/ 规则/ 的/ 挖掘/ 方法/ ,/ 基于/ 程序/ 的/ 控制流/ 对/ 异常/ 路径/ 中/ 的/ 一些/ 使用/ 规则/ 进行/ 检查/ ,/ 定位/ 其中/ 的/ 使用/ 异常/ ./ iComment/ [/ 17/ ]/ 利用/ 程序/ 中/ 的/ 注释/ ,/ 利于/ 自然语言/ 学习/ 的/ 方法/ ,/ 结合/ 机器/ 学习/ 和/ 统计/ 方法/ ,/ 从/ 注释/ 中/ 提取/ 规则/ ,/ 进而/ 结合/ 源码/ 的/ 上下文/ 进行/ 分析/ ,/ 发现/ 程序/ 中/ 注释/ 与/ 源码/ 的/ 上下文/ 不/ 一致/ 之/ 处/ ,/ 并/ 分析/ 和/ 报告/ 给/ 开发人员/ ./ aComment/ [/ 18/ ]/ 在/ 注释/ 的/ 基础/ 上/ ,/ 结合/ 了/ 代码/ 中/ 的/ 中断/ 敏感/ 函数/ ,/ 通过/ 推导/ 得到/ 进入/ 和/ 离开/ 函数/ 时/ 的/ 中断/ 开闭/ 状态/ ,/ 进而/ 发现/ 源码/ 与/ 注释/ 中/ 关于/ 中断/ 开闭/ 的/ 约定/ 与/ 实际/ 不/ 一致/ 的/ 问题/ ./ 还有/ 部分/ 方法/ [/ 19/ -/ 20/ ]/ 针对/ 大规模/ 软件/ ,/ 通过/ 数据分析/ 和/ 挖掘/ 的/ 方法/ ,/ 提取/ 其中/ 的/ API/ 使用/ 规则/ 或/ 使用/ 规范/ 等/ ,/ 部分/ 方法/ 也/ 利用/ 提取/ 的/ 规范/ 进行/ 违例/ 检测/ [/ 21/ ]/ 和/ 辅助/ 进行/ 程序开发/ [/ 22/ ]/ ./ 上述/ 方法/ 在/ 提取/ 使用/ 规范/ 的/ 过程/ 中/ ,/ 常常/ 局限/ Page4/ 于/ 特定/ 的/ 一种/ 规则/ 或/ 针对/ 单一/ 的/ 资源/ ,/ 而/ 基于/ 统计/ 的/ 挖掘/ 方法/ 则/ 要求/ 重复/ 的/ 频度/ 较/ 高/ ./ 实际上/ ,/ 驱动/ 具有/ 较/ 好/ 的/ 结构/ 信息/ [/ 23/ ]/ ./ 根据/ 结构/ 信息/ 推导/ ,/ 在/ 降低/ 统计/ 阈值/ 的/ 同时/ ,/ 还/ 可以/ 大大提高/ 提取/ 的/ 规则/ 的/ 准确性/ ./ SD/ -/ Miner/ 结合/ 驱动/ 的/ 结构特征/ ,/ 利用/ 统计/ 方法/ 对/ 文中/ 提及/ 的/ 三类/ 接口/ 调用/ 顺序/ 依赖/ 规则/ 进行/ 提取/ 和/ 分析/ ,/ 在/ 提升/ 驱动/ 可靠性/ 的/ 同时/ ,/ 无需/ 程序员/ 在/ 源码/ 中/ 添加/ 特殊/ 的/ 标注/ 信息/ ,/ 也/ 不再/ 局限于/ 特定/ 的/ 单一/ 资源/ ./ 3/ 规则/ 提取/ 与/ 违例/ 检测/ SD/ -/ Miner/ 结合/ 驱动/ 源码/ ,/ 利用/ 统计/ 方法/ 对/ 驱动/ 中/ 的/ 顺序/ 依赖/ 规则/ 进行/ 提取/ ./ 在/ 本节/ 中/ ,/ 3.1/ 节/ 简要/ 介绍/ 了/ SD/ -/ Miner/ 的/ 总体/ 框架/ ,/ 3.2/ 节/ 简要/ 介绍/ 了/ SD/ -/ Miner/ 所/ 需/ 的/ 理论/ 模型/ ,/ 并/ 在/ 3.3/ 节中/ 给出/ 了/ SD/ -/ Miner/ 的/ 规则/ 挖掘/ 的/ 实现/ 原理/ ,/ 第/ 3.4/ 节/ 给出/ 了/ 基于/ 挖掘出/ 的/ 规则/ 实施/ 的/ 违例/ 检测/ ,/ 第/ 3.5/ 节/ 对系统/ 的/ 误报/ 与/ 漏报/ 的/ 优化/ 技术/ 进行/ 了/ 分析/ ./ 3.1/ 总体/ 框架/ 为了/ 完成/ 顺序/ 依赖/ 规则/ 的/ 提取/ ,/ SD/ -/ Miner/ 首先/ 需要/ 定位/ 驱动/ 中/ 的/ P/ 、/ R/ 操作/ ,/ 然后/ 分别/ 提取/ P/ 、/ R/ 操作/ 中/ 接口函数/ 的/ 调用/ 序列/ ,/ 再/ 结合/ 函数/ 的/ 返回值/ 和/ 参数信息/ ,/ 分析/ 调用/ 序列/ 的/ 内部/ 依赖/ 关系/ 和/ P/ 、/ R/ 操作/ 中/ 的/ 配对/ 函数/ ./ 根据/ 依赖/ 关系/ 来/ 统计/ 并/ 提取/ 出/ P/ 操作/ 中/ 的/ 顺序/ 依赖/ 规则/ ,/ 然后/ 根据/ 该/ 顺序/ 依赖/ 规则/ 对/ R/ 操作/ 中/ 的/ 逆向/ 操作/ 进行/ 检查和/ 分析/ ,/ 定位/ R/ 操作/ 中/ 的/ 使用/ 违例/ ,/ 将/ 违例/ 进行/ 误报/ 和/ 漏报/ 过滤/ 后以/ 潜在/ 的/ 软件/ 错误/ 形式/ 提交/ ./ 为/ 完成/ 上述/ 目标/ ,/ SD/ -/ Miner/ 需要/ 执行/ 图/ 2/ 中/ 的/ 主体/ 执行/ 流程/ ,/ 具体/ 的/ 细分/ 步骤/ 在下文/ 中/ 进行/ 阐述/ ./ 定位/ P/ 、/ R/ 操作/ 集/ ./ SD/ -/ Miner/ 面向/ 驱动/ 源码/ 对/ 顺序/ 依赖/ 规则/ 进行/ 挖掘/ 和/ 检测/ ,/ 检测/ 驱动/ 对象/ 是否/ 存在/ 关联/ 依赖/ 的/ P/ 、/ R/ 操作/ ./ 根据/ 之前/ 的/ 定义/ ,/ P/ 、/ R/ 操作/ 针对/ 驱动/ 设备/ 执行/ 相反/ 的/ 功能/ ,/ 如/ 加载/ 与/ 卸载/ 、/ 休眠/ 与/ 唤醒/ 等/ ./ 通过/ 定位/ 成对/ 的/ P/ 、/ R/ 操作/ 对应/ 的/ 函数/ ,/ 从而/ 形成/ P/ 、/ R/ 操作/ 集/ ./ 提取/ 调用/ 序列/ ./ 驱动/ 执行/ P/ 、/ R/ 操作/ 时/ 需要/ 大量/ 调用/ 内核/ 提供/ 给/ 驱动/ 模块/ 使用/ 的/ 接口函数/ ,/ 本文/ 提取/ 的/ 顺序/ 依赖/ 规则/ 主要/ 面向/ 内核/ 的/ 接口函数/ ./ 因此/ 在/ 该/ 步骤/ 中/ ,/ 主要/ 根据/ P/ 、/ R/ 操作/ 集/ 提取/ 其中/ 的/ 潜在/ 调用/ 序列/ ./ 关联/ 依赖/ 关系/ 挖掘/ ./ 针对/ 提取/ 的/ 调用/ 序列/ ,/ 通过/ 分析/ 各个/ 接口函数/ 的/ 参数/ 和/ 返回值/ 提取/ 序列/ 内/ 接口函数/ 之间/ 的/ 参数/ 、/ 返回值/ 依赖/ ,/ 为/ 后续/ 的/ 结构/ 推导/ 和/ 统计/ 提供/ 支持/ ./ 根据/ 提取/ 的/ 依赖/ 关系/ 对/ 调用/ 序列/ 的/ 顺序/ 依赖/ 进行/ 初步/ 标定/ ./ 配对/ 函数/ 提取/ ./ 对/ P/ 、/ R/ 操作/ 使用/ 的/ 接口函数/ 进行/ 统计/ 分离/ ,/ 结合/ 驱动/ 中/ 的/ 路径/ 和/ 结构/ 推导/ 的/ 信息/ ,/ 将/ P/ 、/ R/ 操作间/ 成/ 对/ 使用/ 的/ 接口函数/ 进行/ 统计/ ,/ 进而/ 提取/ 出/ 配对/ 函数/ ./ 顺序/ 依赖/ 提取/ ./ 对/ P/ 操作/ 中/ 使用/ 的/ 函数调用/ 序列/ 进行/ 分析/ ,/ 根据/ 关联/ 依赖/ 关系/ 提取/ 调用/ 序列/ 之间/ 接口函数/ 的/ 顺序/ 依赖/ 关系/ ,/ 并/ 结合/ 统计/ 信息提取/ 顺序/ 依赖/ 规则/ ,/ 便于/ 后续/ 的/ 违例/ 检测/ ./ 违例/ 检测/ ./ 根据/ 提取/ 的/ 顺序/ 依赖/ 规则/ ,/ 对/ 驱动/ 的/ 源码/ 再次/ 进行/ 检查/ ,/ 从而/ 定位/ 驱动/ 在/ 调用/ 接口/ 时/ 违反/ 顺序/ 依赖/ 的/ 位置/ ,/ 通过/ 一系列/ 误报/ 与/ 漏报/ 优化/ 分析/ 技术/ ,/ 分离/ 出/ 违例/ 中/ 真正/ 的/ 代码/ 错误/ ./ 3.2/ 理论/ 模型/ 为了/ 完成/ 配对/ 依赖/ 规则/ 的/ 挖掘/ ,/ 并/ 根据/ 提取/ 的/ 规则/ 进行/ 违例/ 检测/ ,/ 我们/ 首先/ 提出/ 了/ 一个/ 理论/ 模型/ 对/ 挖掘/ 的/ 过程/ 进行/ 分析/ ./ SD/ -/ Miner/ 基于/ 以下/ 理论/ 模型/ 进行/ 实现/ ,/ 为了/ 清晰/ 地/ 对模型/ 进行/ 说明/ ,/ 首先/ 对模型/ 需要/ 使用/ 的/ 符号/ 集/ 进行/ 定义/ 并/ 介绍/ ./ P/ 、/ R/ 操作/ 集/ ./ 该/ 集合/ 存储/ 了/ 一系列/ 成对/ 的/ P/ 、/ R/ 操作/ ./ 我们/ 使用/ 符号/ O/ 来/ 表示/ 该/ 操作/ 的/ 集合/ ,/ 其中/ Op/ 和/ Or/ 分别/ 表示/ P/ 操作/ 集/ 和/ R/ 操作/ 集/ ./ 由于/ P/ 、/ R/ 是/ 成/ 对/ 存在/ 的/ ,/ 因此/ O/ 的/ 每/ 一个/ 元素/ 即为/ Op/ 和/ Or/ 的/ 元素/ 对/ :/ 假定/ 共有/ N/ 对/ P/ 、/ R/ 操作/ ,/ 则/ 调用/ 序列/ ./ 在/ 每个/ 操作/ 中均/ 调用/ 了/ 一系列/ 的/ 接口函数/ ,/ 使用/ 符号/ Cp/ 和/ Cr/ 分别/ 表示/ P/ 操作/ 和/ R/ 操作/ 中/ 使用/ 的/ 接口/ 调用/ 序列/ ./ 对于/ 第/ i/ 对/ (/ Oi/ 用/ 序列/ 表示/ 为/ CiPage5/ 由于/ 每个/ 序列/ 中/ 包含/ 多个/ 函数/ ,/ 因此/ 使用/ Cir/ [/ j/ ]/ 分别/ 表示/ 调用/ 序列/ 中/ 的/ 第/ j/ 个/ 元素/ ,/ 被/ 和/ Ci/ 调用/ 的/ 函数/ 的/ 相关/ 属性/ 均/ 被/ 存储/ 在/ Ci/ 函数/ 名称/ (/ FuncName/ )/ 、/ 返回值/ 类型/ (/ RetType/ )/ 、/ 返回值/ 名称/ (/ RetName/ )/ 、/ 参数/ 类型/ (/ ParType/ )/ 、/ 参数/ 名称/ (/ ParName/ )/ 等/ ,/ 并/ 引入/ 操作/ GetValue/ 对/ 上述/ 属性/ 进行/ 获取/ ,/ 如/ 通过/ GetValue/ (/ Ci/ 获得/ 函数/ 名称/ ./ 如果/ 函数/ 的/ 返回值/ 类型/ 为空/ ,/ 则/ GetValue/ (/ Ci/ 决策函数/ ./ 决策函数/ 用于/ 结合/ 结构/ 推导/ 信息/ ,/ 辅助/ 判定/ 两个/ 潜在/ 的/ 配对/ 函数/ 之间/ 存在/ 的/ 配对/ 可能性/ ./ 该/ 函数/ 输入/ 分别/ 为/ Ci/ 两者/ 存在/ 的/ 配对/ 可能性/ ,/ 使用/ 符号/ Fd/ 来/ 表示/ ./ 经过/ 决策函数/ 后/ ,/ 可以/ 定位/ 出/ 一些/ 潜在/ 的/ 配对/ 函数/ ,/ 使用/ 符号/ Pp/ 表示/ ./ 选择函数/ ./ 选择函数/ 是/ 指/ 根据/ 决策函数/ 的/ 结果/ ,/ 结合/ 统计/ 信息/ ,/ 从/ 潜在/ 的/ 配对/ 函数/ 中/ 选择/ 出/ 可能性/ 比较/ 大/ 的/ 配对/ 函数/ ,/ 使用/ 符号/ Fs/ 来/ 表示/ ./ 选择函数/ 和/ 决策函数/ 参考/ 了/ 文献/ [/ 24/ ]/ 已有/ 的/ 研究/ 工作/ ./ 配对/ 函数/ ./ 在/ P/ 、/ R/ 操作/ 中/ 调用/ 的/ 接口函数/ 中/ 存在/ 大量/ 的/ 需要/ 成/ 对/ 使用/ 的/ 函数/ ,/ 完成/ 互补/ 或/ 相反/ 的/ 功能/ ./ 使用/ 符号/ Pf/ 来/ 表示/ 配对/ 函数/ 的/ 集合/ ./ 同样/ Pf/ 中/ 的/ 每/ 一个/ 元素/ 包含/ 一对/ 具体/ 的/ 配对/ 函数/ ,/ 分别/ 表示/ 为/ Pi/ 要/ 满足/ 如下/ 约束条件/ ,/ 即/ 为/ 描述/ 方便/ ,/ 引入/ 函数/ fp/ (/ Pi/ 的/ 配对/ 函数/ ,/ 一般/ 情况/ 下/ :/ Pi/ 个/ 函数/ 存在/ 的/ 配对/ 函数/ 多于/ 一个/ 时/ ,/ fp/ (/ Pi/ 回/ 配对/ 集合/ ,/ 并/ 默认/ 使用/ 配对/ 频数/ 最高/ 的/ 配对/ 函数/ ./ 顺序/ 依赖/ 规则/ 集/ ./ 对/ P/ 操作/ 中/ 的/ 调用/ 序列/ Ci/ 进行/ 统计分析/ ,/ 获得/ 调用/ 序列/ ,/ 结合/ 关联/ 依赖/ 关系/ 对/ 调用/ 序列/ 进行/ 挖掘/ 分析/ ,/ 提取/ 顺序/ 相关/ 的/ 调用/ 序列/ ,/ 使用/ 符号/ Sr/ 来/ 表示/ ,/ 规则/ 集中/ 的/ 第/ i/ 个/ 元素/ 以/ Si/ 表示/ ./ 并且/ 每个/ 元素/ 包含/ 了/ 一条/ P/ 操作/ 中/ 的/ 顺序/ 依赖/ 规则/ ,/ 每/ 一条/ 规则/ 所/ 包含/ 的/ 接口函数/ 数目/ 是/ 不/ 确定/ 的/ ,/ 我们/ 引入/ len/ 函数/ 用于/ 描述/ 一个/ 序列/ 的/ 长度/ ,/ 如/ len/ (/ Si/ 口/ 函数/ 的/ 个数/ ./ 到/ 的/ 违例/ 在/ 统计/ 信息/ 中/ 的/ 可信度/ ,/ 使用/ p/ (/ Pi/ 可信度/ 估计/ 函数/ ./ 可信度/ 估计/ 函数/ 用于/ 评估/ 检测/ f/ [/ 2/ ]/ )/ 来/ 表示/ ./ 当/ 函数/ PiPif/ [/ 2/ ]/ 没有/ 被/ R/ 操作/ 调用/ ,/ 可以/ 用/ 可信度/ 估计/ 函数/ Pi/ 数/ 估算/ 到/ 该/ 违例/ 可以/ 被/ 信任/ 的/ 可信度/ ./ 为了/ 便于/ 后续/ 描述/ ,/ 用/ 符号/ Ft/ 来/ 表示/ 统计/ 的/ 频数/ ,/ 其/ 输入/ 为/ 两个/ 函数/ ,/ 输出/ 为/ 两者/ 共同/ 出现/ 频数/ ./ 如/ Ft/ (/ Pi/ 现/ 的/ 频数/ ./ 而/ Pi/ 方式/ 进行/ 统计/ ,/ 即/ 由于/ 一个/ 函数/ 可能/ 存在/ 多个/ 配对/ 函数/ ,/ 因此/ f/ [/ 1/ ]/ 累计/ 出现/ 的/ 配对/ 频数/ 可以/ 表示/ 为/ PiFt/ (/ Pip/ (/ Pi/ 结合/ Ft/ ,/ 根据/ 统计/ 原理/ ,/ 将/ 违例/ 的/ 可信度/ f/ [/ 1/ ]/ →/ Pip/ (/ Pi/ 通过/ 上述/ 公式/ 可以/ 得出/ ,/ 当/ 配对/ 的/ 频数/ 越高/ ,/ 则/ 发生/ 违例/ 时/ ,/ 该/ 违例/ 的/ 可信度/ 越大/ ,/ 但是/ 存在/ 局部/ 统计/ 信息/ 与/ 全局/ 不/ 对称/ 的/ 问题/ ./ 即/ 假定/ 当/ 一对/ 配对/ 函数/ 本身/ 出现/ 的/ 频数/ 较/ 小时/ ,/ 根据/ 式/ (/ 9/ )/ 将/ 同样/ 可以/ 得出/ 可信度/ 较大/ 的/ 结论/ ./ 事实上/ 这/ 不是/ 绝对/ 的/ ,/ 因此/ 将式/ (/ 9/ )/ 进行/ 变换/ ,/ 综合/ 考虑/ 全局/ 的/ 配对/ 可能性/ ,/ 假定/ 配对/ 频数/ 最大值/ 为/ Fmaxp/ (/ Pif/ [/ 1/ ]/ →/ PiFt/ (/ PiFt/ (/ Pi/ 其中/ ,/ λ/ 1/ 和/ λ/ 2/ 的/ 值/ 默认/ 为/ 0.5/ ,/ 通过/ 式/ (/ 10/ )/ 综合/ 权衡/ 了/ 配对/ 函数/ 自身/ 发生/ 违例/ 的/ 局部/ 可信性/ ,/ 以及/ 在/ 配对/ 函数/ 自身/ 在/ 全局/ 中/ 出现/ 的/ 可能性/ ./ 结合/ P/ 操作/ 中/ 的/ 顺序/ 依赖/ 规则/ 与/ R/ 操作/ 中/ 的/ 配对/ 依赖/ 规则/ ,/ 得出/ R/ 操作/ 中/ 的/ 使用/ 违例/ 主要/ 包括/ 以下/ 3/ 种/ 情况/ :/ 使用/ 规则/ ;/ (/ 1/ )/ P/ 操作/ 调用/ Pi/ (/ 2/ )/ P/ 操作/ 中/ 调用/ 了/ Pi/ 作中/ 没有/ 调用/ Pi/ (/ 3/ )/ 在/ R/ 操作/ 中/ 调用/ 了/ Pi/ 操作/ 顺序/ 依赖/ 的/ 逆向/ 使用/ 规则/ ./ 实践证明/ ,/ 以上/ 3/ 种/ 情况/ 在/ 实际/ 中/ 都/ 存在/ ,/ 分别/ 对应/ SD/ -/ Miner/ 的/ 3/ 类/ 顺序/ 依赖/ 规则/ ./ 其中/ ,/ 第/ 1/ 种/ 仅仅/ 与/ P/ 操作/ 相关/ ,/ 通过/ 转换/ ,/ 和/ 配对/ 函数/ 的/ 统计/ Page6/ 与/ 检测/ 存在/ 较大/ 相似性/ ,/ 将/ 在/ 后面/ 章节/ 进行/ 详细/ 介绍/ ;/ 第/ 2/ 种/ 情况/ 可以/ 等同于/ 配对/ 函数/ 规则/ 的/ 使用/ 违例/ ;/ 而/ 第/ 3/ 种/ 情况/ 中/ ,/ 违例/ 可信/ 的/ 可信度/ 应当/ 综合/ 考虑/ 以下/ 几个/ 方面/ 的/ 因素/ :/ (/ 1/ )/ P/ 操作/ 中/ 被/ 调用函数/ 之间/ 的/ 顺序/ 依赖/ 可/ (/ 2/ )/ P/ 、/ R/ 之间/ 操作/ 的/ 配对/ 可信度/ ;/ (/ 3/ )/ R/ 操作/ 中/ 被/ 调用函数/ 自身/ 需要/ 配对/ 使用/ 的/ 综合/ 考虑/ 以上/ 因素/ ,/ 顺序/ 依赖/ 规则/ Sr/ 的/ 违例/ 可/ 可信度/ ./ 以/ 通过/ 式/ (/ 11/ )/ ~/ (/ 13/ )/ 进行/ 描述/ :/ (/ Pi1f/ [/ 1/ ]/ ,/ Pi1R/ 操作/ 将/ 调用/ 与/ P/ 操作/ 中/ 对应/ 的/ 配对/ 函数/ ,/ 并/ 满足/ 顺序/ 依赖/ 规则/ ,/ 该/ 顺序/ 依赖/ 规则/ 的/ 应用/ 场景/ 表现/ 为/ 如下/ 形式/ :/ / j1/ </ j2/ ,/ Pi1/ / Si/ 如果/ 在/ R/ 中/ ,/ Pi1/ 信度/ ;/ 用/ ,/ 则/ 在/ Ci/ / k1/ </ k2/ ,/ Pi1/ 如果/ 式/ (/ 13/ )/ 成立/ ,/ 则/ 定位/ 到/ 了/ 一处/ 关于/ 顺序/ 依赖/ 规则/ Si/ 合/ ./ 结合/ 以上/ 理论/ 模型/ ,/ 下面/ 将/ 按照/ 总体/ 框架图/ 2/ 的/ 主体/ 流程/ 对/ SD/ -/ Miner/ 进行/ 实现/ ./ 3.3/ 规则/ 挖掘/ 的/ 实现/ 原理/ 本节/ 将/ 详细/ 介绍/ 上述/ 一些/ 关键/ 模块/ 的/ 实现/ 流程/ ./ 3.3/ ./ 1/ 节将/ 对接口/ 参数/ 和/ 接口函数/ 的/ 模糊/ 定位/ 方法/ 进行/ 介绍/ ,/ 3.3/ ./ 2/ 节将/ 介绍/ P/ 操作/ 内部/ 的/ 顺序/ 关联/ 规则/ 的/ 统计/ 方法/ ,/ 而/ 在/ 3.3/ ./ 3/ 节中/ ,/ 将/ 给出/ 在/ 对偶/ 操作/ 中/ 使用/ 到/ 的/ 配对/ 依赖/ 规则/ ./ 3.3/ ./ 1/ 接口/ 参数/ 和/ 接口函数/ 的/ 模糊/ 定位/ 本文/ 针对/ 的/ 检测/ 和/ 处理/ 对象/ 主体/ 是/ 执行/ 相反/ 或/ 互补/ 功能/ 的/ P/ 、/ R/ 操作/ ,/ 因此/ SD/ -/ Miner/ 首先/ 要求/ 正确/ 地/ 定位/ 到/ 驱动/ 中/ 的/ P/ 、/ R/ 操作/ 集/ Op/ 和/ Or/ ./ 驱动/ 自身/ 具有/ 较/ 好/ 的/ 结构性/ 特征/ ,/ 根据/ 总线/ 要求/ ,/ 提供/ 正确/ 的/ 交互/ 接口/ ./ 该/ 交互/ 接口/ 中/ ,/ 包含/ 有/ 大量/ 的/ 满足/ SD/ -/ Miner/ 要求/ 的/ P/ 、/ R/ 操作/ ./ Kadav/ 等/ 人/ [/ 25/ ]/ 指出/ ,/ PCI/ 驱动/ 占据/ 了/ Linux/ 驱动/ 的/ 36/ %/ ,/ USB/ 驱动/ 占据/ 了/ 35/ %/ ,/ 并且/ 与/ 驱动/ 加载/ 和/ 初始化/ 等/ 配置/ 相关/ 的/ 代码/ 占据/ 了/ 每款/ 驱动/ 51/ %/ 的/ 代码/ ,/ 该/ 部分/ 代码/ 正是/ SD/ -/ Miner/ 的/ 重点/ 检测/ 对象/ ./ PCI/ 驱动/ 和/ USB/ 驱动/ 都/ 需要/ 依赖/ 总线/ 挂载/ 到/ 系统/ 中/ ,/ 总线/ 对/ 每款/ 设备/ 驱动/ 都/ 要求/ 实现/ 一个/ 统一/ 的/ 接口/ ,/ 并/ 在/ 接口/ 中/ 规定/ 了/ 一些/ P/ 操作/ 和/ R/ 操作/ ./ 如图/ 3/ 所示/ ,/ 每款/ PCI/ 设备/ 驱动/ 都/ 需要/ 实现/ 一个/ pci/ _/ driver/ 驱动/ 结构/ ,/ 内部/ 包含/ 加载/ (/ probe/ )/ P/ 函数指针/ 、/ 卸载/ (/ remove/ )/ R/ 函数指针/ ./ 12345678SD/ -/ Miner/ 根据/ 总线结构/ 对/ 驱动/ 的/ 结构/ 进行/ 分析/ 和/ 推导/ ,/ 定位/ 到/ 驱动/ 中/ 对应/ 的/ P/ 操作/ 和/ R/ 操作/ 函数/ ./ SD/ -/ Miner/ 根据/ pci/ _/ driver/ 的/ 结构特征/ ,/ 提取/ 其中/ 的/ probe/ 和/ remove/ 函数/ ,/ 将/ 函数/ 所在/ 的/ 文件/ 和/ 函数/ 名称/ 记录/ 到/ Op/ 和/ Or/ 操作/ 集中/ ./ USB/ 驱动/ 同样/ 存在/ 较/ 好/ 的/ 结构特征/ ,/ 如图/ 4/ 所示/ ,/ 每个/ USB/ 设备/ 需要/ 支持/ 热插拔/ ,/ 因而/ 需要/ 实现/ 动态/ 的/ 加载/ 和/ 卸载/ 功能/ ,/ 对应/ usb/ _/ driver/ 的/ probe/ 和/ disconnect/ 函数指针/ ./ 当/ 驱动/ 对/ 上述/ 函数指针/ 完成/ 赋值/ 时/ ,/ 所/ 赋值/ 的/ 函数/ 即/ 作为/ SD/ -/ Miner/ 检测/ 的/ 对象/ ./ 12345678/ 除了/ USB/ 、/ PCI/ 驱动/ ,/ 还有/ 许多/ 驱动/ 存在/ 共同/ 的/ 结构/ 体/ ,/ 如/ platform/ _/ driver/ 类/ 驱动/ ./ 通过/ 分析/ 驱动/ 的/ 源码/ ,/ 结合/ 驱动/ 的/ 结构特征/ ,/ 以/ 函数指针/ 名中/ 赋值/ 关键字/ 匹配/ 并/ 定位/ 操作/ 集/ ./ 在/ SD/ -/ Miner/ 中/ ,/ 通过/ 指定/ 执行/ 相反/ 或/ 互斥/ 功能/ 的/ 函数指针/ ,/ 如/ 识别/ “/ probe/ ”/ 、/ “/ remove/ ”/ 和/ “/ disconnect/ ”/ 等/ 关键字/ ,/ 并/ 辅以/ 函数指针/ 的/ 赋值/ 特征/ 和/ 驱动/ 的/ 总线/ 接口类型/ 来/ 定位/ 驱动/ 加载/ 和/ 卸载/ 函数/ ,/ 并/ 将/ 成/ 对/ 的/ 操作/ 函数/ 记录/ 到/ P/ 、/ R/ 操作/ 集/ ./ 一对/ P/ 、/ R/ 操作/ 会/ 调用/ 一系列/ 的/ 接口函数/ 来/ 完成/ 指定/ 的/ 功能/ ,/ 如/ 在/ P/ 操作/ 中/ ,/ 常见/ 操作/ 包括/ 申请/ 内存/ 、/ 创建/ 设备/ 文件/ 、/ 绑定/ 端口/ 、/ 激活/ 设备/ 等/ ./ 而/ 在/ R/ 操作/ 中/ ,/ 常见/ 操作/ 包括/ :/ 关闭/ 设备/ 、/ 解除/ 端口/ 、/ 移除/ 设备/ 文件/ 、/ 释放/ 内存/ 等/ ./ 两者/ 调用/ 的/ 接口函数/ 互为/ 对/ 偶函数/ ,/ 由于/ 接口函数/ 较/ 多/ ,/ 功能/ 各异/ ,/ 加之/ 文档/ 缺失/ ,/ Page7/ 因此/ 使用/ 规则/ 无法/ 直接/ 获得/ ,/ SD/ -/ Miner/ 尝试/ 结合/ 结构特征/ 和/ 统计/ 信息提取/ 接口函数/ 中/ 的/ 使用/ 规则/ ./ P/ 操作/ 和/ R/ 操作/ 的/ 功能/ 相反/ ,/ 因此/ 在/ 调用/ 接口函数/ 时/ ,/ 如果/ 存在/ 关联/ 依赖/ ,/ 则/ 在/ 使用/ 次序/ 上要/ 满足/ 以下/ 约束/ ./ 约束/ 1/ ./ 在/ P/ 操作/ 中先/ 执行/ 的/ 顺序/ 依赖/ 相关/ 的/ 接口函数/ ,/ 其/ 对/ 偶函数/ 在/ R/ 操作/ 中/ 反而/ 后/ 执行/ ./ 由于/ P/ 操作/ 调用/ 的/ 接口/ 序列/ 并非/ 全部/ 存在/ 顺序/ 依赖/ ,/ 因此/ 在/ R/ 操作/ 中/ ,/ 对/ 偶函数/ 的/ 整个/ 调用/ 序列/ 并/ 不/ 唯一/ ,/ 只有/ 存在/ 顺序/ 依赖/ 的/ 接口函数/ 在/ 直接/ 使用/ 时/ 需要/ 满足/ 约束/ 1.3/ ./ 3.2/ 节/ 将/ 对/ P/ 、/ R/ 操作/ 之间/ 的/ 配对/ 函数/ 挖掘/ 进行/ 介绍/ ,/ 而/ 在/ 第/ 3.3/ ./ 3/ 节/ 中将/ 对/ 函数/ 内部/ 的/ 顺序/ 规则/ 的/ 统计/ 和/ 提取/ 方法/ 予以/ 介绍/ ./ 3.3/ ./ 2/ 统计/ P/ // R/ 操作/ 之间/ 的/ 配对/ 依赖/ 规则/ 大部分/ 接口函数/ 都/ 是/ 由/ 内核/ 开发者/ 编写/ ,/ 因此/ 接口函数/ 的/ 命名/ 较为/ 规范/ ,/ 结合/ 函数/ 的/ 名字/ 和/ 参数/ 可以/ 对/ 函数/ 的/ 功能/ 进行/ 识别/ ./ SD/ -/ Miner/ 通过/ 提取/ 函数/ 名字/ 中/ 的/ 关键字/ 段/ 特征/ ,/ 对/ 决策函数/ Fd/ 和/ 选择函数/ Fs/ 予以/ 具体/ 实现/ ./ 对/ 配对/ 的/ 接口函数/ 的/ 识别/ 关键在于/ 定位/ 出/ 执行/ 相反/ 功能/ 的/ 潜在/ 配对/ 函数/ ,/ 参考/ 一些/ 已有/ 的/ 研究/ 工作/ [/ 24/ ]/ ,/ 结合/ 本文/ 的/ 具体情况/ ,/ 将/ 配对/ 挖掘/ 的/ 方法/ 可以/ 直接/ 予以/ 使用/ ./ P/ 操作/ 和/ R/ 操作/ 中/ 如果/ 出现/ 一对/ 互斥/ 关键字/ ,/ 且/ 作用/ 在/ 同类/ 对象/ 上/ ,/ 该/ 对/ 函数/ 将/ 被/ 加入/ 到/ Pp/ 中/ ,/ 并且/ ,/ 如果/ 该/ 对/ 函数/ 已经/ 存在/ ,/ 则/ 将/ 其/ 频数/ 累加/ 1/ 次/ ./ 同时/ ,/ 在/ 不同/ 的/ P/ 、/ R/ 操作/ 之间/ ,/ 还/ 可以/ 通过/ 结构/ 推导/ 选择/ 出/ 潜在/ 的/ 配对/ 函数/ ./ 如果/ P/ 操作/ 、/ R/ 操作/ 中/ 分别/ 仅/ 调用/ 了/ 一个/ 接口函数/ ,/ 则/ 两个/ 函数/ 自成/ 配对/ 函数/ ,/ 即/ 同样/ ,/ 当/ 存在/ 两个/ 同类/ 操作/ 集/ 之间/ 的/ 差值/ 为/ 一个/ 函数/ ,/ 以/ CiC1tp/ =/ Ci/ 结合/ 式/ (/ 14/ )/ 和/ (/ 15/ )/ ,/ 对/ 操作/ 集/ 之间/ 任意/ 个/ 集合/ 之间/ 进行/ 差值/ 运算/ ,/ 运算/ 结果/ 满足/ 式/ (/ 15/ )/ 函数/ 的/ 同样/ 会/ 被/ 加入/ 潜在/ 的/ 配对/ 函数/ 集中/ ./ 通过/ 上述/ 步骤/ ,/ 潜在/ 的/ 配对/ 函数/ 被/ 记录/ 在/ Pp/ 集中/ ./ 然后/ 遍历/ Cp/ 和/ Cr/ ,/ 统计/ Pp/ 中/ 的/ 潜在/ 配对/ 函数/ 成/ 对/ 出现/ 的/ 频数/ ,/ 再/ 利用/ Fs/ 对/ Pp/ 进行/ 选择/ ./ 3.3/ ./ 3/ 统计/ 函数/ 内部/ 的/ 函数/ 使用/ 顺序/ 关联/ 调用/ 序列/ 的/ 顺序/ 依赖/ 关系/ 主要/ 体现/ 在/ 接口函数/ 执行/ 的/ 逻辑/ 次序/ ./ 如/ 设备/ 激活/ 之前/ ,/ 常常/ 需要/ 申请/ 内存/ 保存/ 设备/ 的/ 状态/ 等/ 信息/ ,/ 因此/ 存在/ 顺序/ 依赖/ ./ 在/ P/ 、/ R/ 操作/ 内部/ ,/ 都/ 存在/ 顺序/ 依赖/ 规则/ 关联/ ,/ 由于/ R/ 操作/ 的/ 顺序/ 依赖/ 规则/ 与/ P/ 操作/ 中/ 的/ 顺序/ 依赖/ 关系/ 存在/ 关联性/ ,/ 因此/ SD/ -/ Miner/ 将/ 问题/ 转换成/ 了/ P/ 操作/ 内部/ 的/ 顺序/ 依赖/ 规则/ 提取/ 和/ P/ 、/ R/ 操作/ 之间/ 的/ 配对/ 函数/ 提取/ ./ 接口函数/ 之间/ 的/ 逻辑/ 次序/ 关系/ 存在/ 多种/ 情况/ ,/ 如图/ 5/ 所示/ ,/ 图中/ 描述/ 了/ 常见/ 的/ 接口函数/ 之间/ 的/ 依赖/ 关系/ ,/ 图中/ a/ ~/ g/ 表示/ 接口函数/ ./ 图/ 5/ (/ a/ )/ 中/ 描述/ 了/ 在/ P/ 操作/ 中/ ,/ 所有/ 调用/ 的/ 接口函数/ 存在/ 线性/ 依赖/ 关系/ ,/ 即/ 驱动/ 必须/ 使用/ 完/ a/ 才能/ 使用/ b/ ,/ 以此类推/ ./ 对于/ 该类/ 规则/ ,/ 根据/ 约束/ 1/ 的/ 要求/ ,/ 如果/ a/ ~/ g/ 存在/ 与/ 之/ 配对/ 的/ 函数/ ,/ 并/ 假定/ 函数/ 名称/ 为/ Pa/ ~/ Pg/ ,/ 即/ a/ 与/ Pa/ 是/ 一对/ 配对/ 函数/ ,/ 以此类推/ ,/ 则/ 在/ R/ 操作/ 中/ 的/ 调用/ 顺序/ 唯一/ ,/ 如图/ 6/ (/ a/ )/ ./ 图/ 5/ (/ b/ )/ 中/ 的/ P/ 操作/ 同样/ 调用/ 了/ 函数/ a/ ~/ g/ ,/ 但是/ 函数/ 之间/ 的/ 依赖/ 关系/ 分离/ 在/ 3/ 条/ 独立/ 的/ 规则/ 之中/ ,/ 即/ P/ 操作/ 在/ 执行/ 时/ ,/ 只/ 需/ 分别/ 保证/ 每条/ 独立/ 规则/ 的/ 有序性/ ,/ 而/ 规则/ 之间/ 没有/ 先后/ 关系/ ,/ 如/ 函数/ a/ 只/ 需/ 在/ 函数/ b/ 和/ 函数/ c/ 之前/ 被/ 调用/ ,/ 而/ 与/ 函数/ d/ 、/ e/ 、/ f/ 、/ g/ 的/ 位置/ 无关/ ./ 同样/ ,/ 根据/ 约束/ 1/ 的/ 要求/ ,/ 在/ R/ 操作/ 中该/ 顺序/ 依赖/ 体现/ 在/ ,/ R/ 操作/ 调用/ a/ ~/ g/ 的/ 配对/ 的/ 接口函数/ Pa/ ~/ Pg/ 时/ 只/ 需/ 遵守/ 3/ 条/ 反向/ 的/ 依赖/ 规则/ ,/ 如图/ 6/ (/ b/ )/ 所示/ ./ Page8/ 在/ 图/ 5/ (/ c/ )/ 中/ ,/ P/ 操作/ 调用/ 的/ 函数/ 序列/ 之间/ 的/ 依赖/ 关系/ 较为/ 复杂/ ,/ 称为/ 依赖/ 关系/ 图/ ./ 事实上/ ,/ 图/ 5/ (/ a/ )/ 和/ 图/ 5/ (/ b/ )/ 是/ 图/ 5/ (/ c/ )/ 中图/ 状/ 依赖/ 的/ 特例/ ,/ 因此/ SD/ -/ Miner/ 在/ 实现/ 顺序/ 依赖/ 挖掘/ 时/ ,/ 使用/ 了/ 图来/ 存储/ 序列/ 内部/ 的/ 依赖/ 关系/ ./ 同样/ 根据/ 约束/ 1/ 的/ 要求/ ,/ R/ 操作/ 中/ 调用/ 的/ 序列/ 需要/ 遵守/ 图/ 6/ (/ c/ )/ 中/ 的/ 约束/ ./ 通过/ 对比/ 图/ 5/ (/ a/ )/ ~/ (/ c/ )/ 和/ 图/ 6/ (/ a/ )/ ~/ (/ c/ )/ 可以/ 发现/ ,/ 图/ 6/ 中/ 的/ 子/ 图/ 分别/ 是/ 图/ 5/ 子图/ 的/ 反向/ 图/ ,/ 并且/ R/ 操作/ 调用/ 的/ 序列/ 只要/ 满足/ 图/ 6/ 中/ 的/ 拓扑/ 排序/ ,/ 即/ 为/ 一个/ 正确/ 的/ 调用/ 序列/ ./ 换言之/ ,/ 通过/ 挖掘/ P/ 操作/ 中/ 的/ 顺序/ 依赖/ 规则/ ,/ 针对/ R/ 操作/ ,/ 存在/ 以下/ 约束/ ./ 约束/ 2/ ./ 若/ R/ 操作/ 中/ 调用/ 的/ 接口函数/ 序列/ 是/ P/ 操作/ 的/ 依赖/ 关系/ 图/ 的/ 反向/ 图/ 的/ 一个/ 拓扑/ 排序/ 序列/ ,/ 则/ 该/ 调用/ 序列/ 是/ 合法/ 的/ ./ 至此/ ,/ 关键问题/ 在于/ 如何/ 统计/ 和/ 提取/ 出/ P/ 操作/ 中/ 的/ 顺序/ 依赖/ 规则/ ./ 假定/ 调用/ 序列/ 中/ 两个/ 函数/ a/ 、/ b/ ,/ 并且/ a/ 先于/ b/ 被/ P/ 操作/ 调用/ ,/ 则/ a/ 、/ b/ 如果/ 存在/ 关联/ 约束/ ,/ 主要/ 存在/ 以下/ 4/ 种/ 关联/ :/ (/ 1/ )/ 函数/ a/ 的/ 返回值/ 被/ b/ 使用/ ;/ (/ 2/ )/ 函数/ a/ 、/ b/ 的/ 参数/ 存在/ 关联性/ ;/ (/ 3/ )/ 函数/ a/ 、/ b/ 的/ 返回值/ 存在/ 关联/ ;/ (/ 4/ )/ 函数/ a/ 、/ b/ 的/ 使用/ 逻辑/ 上/ 存在/ 先后/ ./ 其中/ ,/ 第/ 1/ ~/ 3/ 种/ 可以/ 通过/ 提取/ P/ 操作/ 中/ 接口函数/ 的/ 返回值/ 和/ 参数/ ,/ 进而/ 分析/ 返回值/ 和/ 参数/ 的/ 关联/ 关系/ ,/ 辅助/ 以/ 统计/ 信息/ 来/ 实现/ ./ 仍/ 以图/ 1/ 为例/ ,/ 第/ 258/ 行/ 调用/ devm/ _/ kzalloc/ 申请/ 内存空间/ 并/ 清零/ ,/ 将/ 返回/ 的/ 内存空间/ 起始/ 地址/ 存储/ 在/ data/ 指针/ 变量/ 中/ ;/ 第/ 264/ 行/ clk/ _/ prepare/ _/ enable/ 函数/ 使用/ 到/ 了/ data/ 的/ 成员/ 变量/ ,/ 属于/ 第/ 1/ 种/ 关联/ ,/ 即/ devm/ _/ kzalloc/ 函数/ 必须/ 先于/ clk/ _/ prepare/ _/ enable/ 函数/ 被/ 调用/ ./ 第/ 287/ 行/ 调用/ 了/ 函数/ serial8250/ _/ register/ _/ 8250/ _/ port/ ,/ 该/ 函数/ 的/ 返回值/ 使用/ 到/ 了/ data/ 的/ 成员/ 变量/ ,/ 因此/ 该/ 函数/ 与/ devm/ _/ kzalloc/ 存在/ 上述/ 第/ 3/ 种/ 关联/ ,/ 并且/ 同样/ 必须/ 先/ 调用/ devm/ _/ kzalloc/ 函数/ ./ 但是/ ,/ 尽管/ clk/ _/ prepare/ _/ enable/ 函数/ 与/ 关联性/ serial8250/ _/ register/ _/ 8250/ _/ port/ 存在/ 第/ 2/ 种/ 关联/ ,/ 但是/ 实际/ 使用/ 中/ 并/ 不/ 要求/ 严格/ 的/ 先后/ 执行/ 次序/ ./ 1607/ …/ 163216791724/ …/ 1754/ 而/ 第/ 4/ 种/ 关联/ 并/ 不能/ 直接/ 通过/ 函数/ 内部/ 的/ 调用/ 关系/ 予以/ 直观/ 推导/ ,/ 因此/ SD/ -/ Miner/ 通过/ 统计/ 函数/ a/ 、/ b/ 之间/ 的/ 顺序/ 依赖/ 频数/ 来/ 提取/ 顺序/ 依赖/ 规则/ ./ 如图/ 7/ 所示/ ,/ 函数/ twl/ _/ probe/ 调用/ 了/ scsi/ _/ host/ _/ alloc/ 、/ scsi/ _/ add/ _/ host/ 、/ scsi/ _/ scan/ _/ host/ 等/ 函数/ ,/ 其中/ scsi/ _/ host/ _/ alloc/ 和/ 后/ 两者/ 存在/ 返回值/ 与/ 参数/ 之间/ 的/ 直接/ 依赖/ 关系/ ./ 而/ scsi/ _/ add/ _/ host/ 和/ scsi/ _/ scan/ _/ host/ 之间/ 属于/ 第/ 4/ 种/ 依赖/ ,/ 同时/ 存在/ 参数/ 关联/ ,/ SD/ -/ Miner/ 统计/ 两者/ 的/ 先后/ 出现/ 次序/ 累计/ 出现/ 了/ 39/ 次/ ,/ 并且/ 两者/ 拥有/ 相同/ 的/ 参数/ 约束/ ,/ scsi/ _/ host/ _/ alloc/ 、/ scsi/ _/ add/ _/ host/ 、/ scsi/ _/ scan/ _/ host/ 三者/ 构成/ 了/ 一条/ 顺序/ 依赖/ 约束/ ./ SD/ -/ Miner/ 首先/ 定位/ 一个/ P/ 操作/ 函数/ 内部/ 调用/ 的/ 所有/ 接口函数/ ,/ 根据上述/ 4/ 类/ 依赖/ ,/ 建立/ 单个/ 函数/ 的/ 关系/ 依赖图/ ,/ 再/ 结合/ 统计/ 信息/ ,/ 从/ 所有/ 的/ 关系/ 依赖图/ 中/ 提取/ 频度/ 较/ 高/ 的/ 顺序/ 依赖/ 规则/ ./ 然后/ 根据/ P/ 操作/ 中/ 的/ 顺序/ 依赖/ 关系/ 图来/ 判定/ R/ 操作/ 的/ 序列/ 是否/ 满足/ 是/ P/ 操作/ 中/ 顺序/ 依赖/ 关系/ 图/ 的/ 反向/ 图/ 的/ 一个/ 拓扑/ 排序/ 序列/ ./ 3.4/ 违例/ 检测/ 与/ 实现/ SD/ -/ Miner/ 的/ 主要/ 任务/ 之一/ 是/ 定位/ 驱动/ 中/ 的/ 使用/ 违例/ ,/ 即/ 寻找/ 驱动/ 中/ 违反/ 顺序/ 依赖/ 规则/ 的/ 用例/ ./ 其中/ 包括/ P/ 操作/ 中/ 的/ 顺序/ 依赖/ 规则/ 的/ 使用/ 违例/ 、/ P/ 操作/ 和/ R/ 操作/ 中/ 配对/ 依赖/ 规则/ 的/ 使用/ 违例/ 、/ R/ 操作/ 中/ 顺序/ 依赖/ 规则/ 的/ 使用/ 违例/ ./ 3.4/ ./ 1P/ 操作/ 中/ 顺序/ 依赖/ 规则/ 使用/ 违例/ 通过/ 统计分析/ ,/ 提取/ 出/ 了/ P/ 操作/ 内部/ 的/ 顺序/ 依赖/ 规则/ ,/ 即/ P/ 操作/ 内部/ 需要/ 遵守/ 的/ 接口/ 函数调用/ 顺序/ ./ 如/ 之前/ 提到/ 的/ scsi/ _/ host/ _/ alloc/ 、/ scsi/ _/ add/ _/ host/ 、/ scsi/ _/ scan/ _/ host/ 三者/ 构成/ 了/ 一条/ 顺序/ 依赖/ 约束/ ./ 当/ P/ 操作/ 调用/ scsi/ _/ host/ _/ alloc/ 时/ ,/ 在/ 后续/ 流程/ 中/ ,/ 一般/ 需要/ 调用/ scsi/ _/ add/ _/ host/ ,/ 进而/ 调用/ scsi/ _/ scan/ _/ host/ ,/ 否则/ SD/ -/ Miner/ 认定/ 出现/ 使用/ 违例/ ./ 如图/ 8/ 所示/ ,/ sbp2/ _/ probe/ (/ 3.10/ ./ 10/ ,/ driver/ // firewire/ // sbp2/ ./ c/ )/ 函数调用/ 了/ 前/ 两者/ 完成/ host/ 的/ 申请/ 和/ 加载/ 工作/ ,/ 却/ 并/ 没有/ 执行/ scsi/ _/ scan/ _/ host/ 函数/ ,/ 因此/ 判定/ 这是/ 一个/ 使用/ 违例/ ./ 值得一提的是/ ,/ 由于/ 在/ 命名/ 上/ 部分/ 函数/ 进行/ 了/ 私有/ 实现/ ,/ 对/ 原有/ 的/ 接口函数/ 增加/ 了/ 前缀/ 或/ 后缀/ ,/ 对于/ 该种/ 情况/ SD/ -/ Miner/ 参考/ 参数/ 等/ 信息/ 进行/ 了/ 模糊/ 处理/ ,/ 进而/ 减少/ 误报/ ./ 1133115011651205Page93/ ./ 4.2/ P/ 操作/ 与/ R/ 操作/ 中/ 配对/ 依赖/ 规则/ 使用/ 违例/ R/ 操作/ 依赖/ 将/ P/ 操作/ 的/ 配对/ 函数/ 对/ 申请/ 的/ 资源/ 进行/ 释放/ ,/ SD/ -/ Miner/ 根据/ 3.3/ ./ 2/ 中/ 的/ 挖掘/ 的/ 配对/ 依赖/ 规则/ 并/ 结合/ P/ 操作/ 调用/ 的/ 函数/ 列表/ 对/ R/ 操作/ 进行/ 检查/ ./ 对于/ 一对/ 配对/ 函数/ 如果/ 在/ P/ 中/ 调用/ 了/ 其中/ 的/ 一个/ ,/ 而/ R/ 操作/ 中/ 没有/ 与其/ 对应/ 的/ 的/ 配对/ 函数/ ,/ 则/ 被/ 视为/ 使用/ 违例/ ./ 举例来说/ ,/ P/ 操作/ 函数/ smtcfb/ _/ pci/ _/ probe/ (/ Linux3/ ./ 10.10/ ,/ drivers/ // staging/ // sm7xxfb/ // sm7xxfb/ ./ c/ )/ 调用/ 了/ pci/ _/ enable/ _/ device/ 函数/ ./ 但是/ 在/ 对应/ 的/ R/ 操作/ 函数/ smtcfb/ _/ pci/ _/ remove/ 中/ ,/ 并/ 没有/ 调用/ pci/ _/ disable/ _/ device/ 函数/ ,/ 所以/ 存在/ 使用/ 违例/ ./ 对于/ 这种/ 配对/ 函数/ 相关/ 的/ 顺序/ 依赖/ 规则/ ,/ SD/ -/ Miner/ 通过/ 对/ P/ 操作/ 中/ 的/ 接口函数/ 来/ 定位/ ,/ 进而/ 检查/ 在/ R/ 操作/ 中/ 是否/ 出现/ 了/ 相应/ 的/ 配对/ 函数/ ./ 为/ 减少/ 误报/ ,/ 当/ 检查/ 到/ 相应/ 的/ 使用/ 违例/ 时/ ,/ SD/ -/ Miner/ 使用/ 了/ 一系列/ 方法/ 进行/ 误报/ 和/ 漏报/ 优化/ ,/ 具体/ 在/ 3.5/ 节中/ 进行/ 介绍/ ./ 3.4/ ./ 3R/ 操作/ 中/ 顺序/ 依赖/ 规则/ 使用/ 违例/ 结合/ P/ 操作/ 的/ 顺序/ 依赖/ 规则/ 和/ P/ // R/ 操作/ 之间/ 的/ 配对/ 依赖/ 关系/ 及/ 约束/ 2/ 的/ 要求/ ,/ 根据/ P/ 操作/ 的/ 顺序/ 依赖/ 关系/ 图/ 构造/ 反向/ 图/ ,/ 然后/ 参考/ 配对/ 依赖/ 关系/ ,/ 对/ R/ 操作/ 中/ 的/ 顺序/ 依赖/ 规则/ 进行/ 检测/ ,/ 定位/ 其中/ 的/ 使用/ 违例/ ./ 再/ 结合/ 拓扑/ 排序/ 算法/ 理论/ 对/ 该/ 检测/ 算法/ 按照/ 算法/ 1/ 进行/ 实现/ ./ 算法/ 1/ ./ R/ 操作/ 中/ 违例/ 检测/ 算法/ SrCheck/ ./ 输入/ :/ Gi/ 表示/ 关于/ Oi/ 输出/ :/ V/ 表示/ 规则/ 使用/ 违例/ 集/ 1/ ./ Vertex/ =/ Gi/ -/ >/ Vertex/ ;/ 2/ ./ Edge/ =/ Gi/ -/ >/ Edge/ ;/ 3/ ./ FLAG/ =/ new/ (/ len/ (/ Vertex/ )/ )/ ;/ 4/ ./ FORvINVertex5/ ./ FLAG/ [/ v/ ]/ =/ / ;/ 6/ ./ FORcINCi7/ ./ IF/ (/ pair/ =/ Pf/ (/ c/ )/ )/ ≠/ / 8/ ./ FLAG/ [/ pair/ ]/ =/ c/ ;/ 9/ ./ DFS/ -/ visit/ (/ pair/ ,/ FLAG/ ,/ Pf/ ,/ Ci10/ ./ RETURNV/ ;/ 算法/ 1/ 按照/ R/ 操作/ 的/ 调用/ 顺序/ 对/ 每个/ 接口函数/ 进行/ 检查/ ,/ 需要/ 使用/ 到/ 改进/ 的/ DFS/ -/ visit/ 实现/ 拓扑/ 序列/ 的/ 验证/ ,/ 将/ 验证/ pair/ 在/ 其子/ 节点/ 中/ 是否/ 存在/ 配对/ 依赖/ 规则/ 的/ 使用/ 违例/ 和/ 顺序/ 依赖/ 规则/ 的/ 使用/ 违例/ ,/ 具体/ 实现/ 如/ 过程/ 1/ 所示/ ./ 过程/ 1/ ./ 子/ 节点/ 遍历/ 检查/ ./ DFS/ -/ visit/ (/ pair/ ,/ FLAG/ [/ ]/ ,/ Pf/ ,/ Ci/ // / 输入输出/ 的/ 参数/ 含义/ 与/ SrCheck/ 中/ 介绍/ 的/ 一致/ / // 1/ ./ FORvINpair/ ./ Vertex/ // // 访问/ pair/ 的/ 邻接/ 点/ 2/ ./ IFfp/ (/ v/ )/ ∩/ Ci3/ ./ // / 顺序/ 依赖/ 规则/ 的/ 使用/ 违例/ ,/ 追加/ 到/ V/ / // 4/ ./ ELSEIFfp/ (/ v/ )/ ∩/ Ci5/ ./ // / 配对/ 依赖/ 规则/ 的/ 使用/ 违例/ ,/ 追加/ 到/ V/ / // 6/ ./ DFS/ -/ visit/ (/ v/ ,/ FLAG/ ,/ Pf/ ,/ Ci/ 过程/ 1/ 对/ P/ 、/ R/ 操作/ 之间/ 的/ 配对/ 依赖/ 规则/ 和/ R/ 操作/ 需要/ 遵守/ 的/ 顺序/ 依赖/ 规则/ 进行/ 使用/ 违例/ 的/ 检测/ ,/ 并/ 将/ 检测/ 结果/ 记录/ 在/ V/ 中/ ,/ 特别/ 指出/ 的/ 是/ ,/ 由于/ 可能/ 存在/ 重复/ 的/ 违例/ ,/ 在/ 追加/ 时/ ,/ 出现/ 完全/ 重复/ 的/ 违例/ 将/ 被/ 忽略/ ./ 由于/ fp/ (/ v/ )/ 返回/ 的/ 是/ v/ 的/ 配对/ 集合/ ,/ 因此/ 判定/ FLAG/ [/ fp/ (/ v/ )/ ]/ 是否/ 为/ 空时/ ,/ 实际上/ 只/ 需/ 集合/ 中/ 的/ 任意/ 一个/ 元素/ 不为/ 空/ 即可/ ./ 3.5/ 误报/ 与/ 漏报/ 优化/ 任何/ 静态方法/ 都/ 存在/ 一定/ 的/ 误报/ 和/ 漏报/ ,/ SD/ -/ Miner/ 结合/ 驱动/ 自身/ 的/ 结构特征/ ,/ 采取/ 了/ 一系列/ 方法/ ,/ 对/ 检测/ 到/ 的/ 违例/ 进行/ 优化/ ,/ 主要/ 包括/ 进入/ 被/ 调用/ 私有/ 接口函数/ 进行/ 确认/ 、/ 建立/ 白/ 黑名单/ 机制/ 、/ 实现/ 对/ 接口函数/ 的/ 模糊/ 匹配/ ./ 部分/ 驱动/ 在/ 实现/ P/ 、/ R/ 操作/ 时/ 并/ 没有/ 直接/ 调用/ 内核/ 提供/ 的/ 接口函数/ ,/ 而是/ 采用/ 了/ 私有/ 接口/ 或/ 同类/ 驱动/ 的/ 共同/ 的/ 私有/ 接口/ ./ 而/ 这些/ 私有/ 接口/ 的/ 实现/ 并/ 没有/ 内核/ 接口/ 规范/ ,/ 因此/ 出现/ 了/ 较/ 多/ P/ 操作/ 调用/ 内核/ 接口/ ,/ 而/ R/ 操作/ 使用/ 私有/ 接口/ 的/ 情况/ ./ 针对/ 该/ 问题/ ,/ SD/ -/ Miner/ 在/ 发现/ 使用/ 违例/ 时/ 将/ 进入/ R/ 操作/ 中/ 的/ 私有/ 接口函数/ 内部/ 进行/ 搜索/ 和/ 确认/ ./ 但/ 为了/ 减少/ 搜索/ 和/ 确认/ 的/ 复杂性/ ,/ 仅/ 搜索/ 直接/ 被/ R/ 操作/ 调用/ 的/ 私有/ 接口函数/ ./ 在/ 内核/ 提供/ 的/ 接口/ 中/ 也/ 存在/ 一些/ 函数/ 用于/ 驱动/ 获取/ 内核/ 的/ 数据结构/ 或/ 获取/ 设备/ 状态/ 等/ ,/ 如/ pr/ _/ info/ 等/ ./ 对/ 这些/ 接口函数/ 的/ 使用/ 在/ 理论/ 上/ 没有/ 约束/ ,/ 为/ 减少/ 对/ 规则/ 提取/ 的/ 干扰/ ,/ SD/ -/ Miner/ 同样/ 支持/ 白/ 黑名单/ 机制/ ,/ 对/ 一些/ 无需/ 配对/ 的/ 函数/ 直接/ 去除/ ,/ 不/ 加入/ 统计/ 范畴/ ,/ 同时/ 也/ 不/ 进行/ 违例/ 检测/ ./ 针对/ 一些/ 统计/ 频数/ 较/ 低/ ,/ 但/ 又/ 较为/ 重要/ 的/ 配对/ 函数/ ,/ 支持/ 将/ 其/ 加入/ 白名单/ 进行/ 强制/ 检查/ ./ 同时/ ,/ SD/ -/ Miner/ 对/ 接口函数/ 采用/ 模糊/ 匹配/ 的/ 方式/ ,/ 减少/ 误报/ ,/ 如图/ 8/ 中/ 提到/ 的/ scsi/ _/ add/ _/ host/ 函数/ ./ 另外/ ,/ 在/ 配对/ 依赖/ 规则/ 的/ 挖掘/ 上/ 同样/ 支持/ 对接口/ Page10/ 函数/ 进行/ 模糊/ 匹配/ ,/ 如/ alloc/ _/ etherdev/ 与/ free/ _/ netdev/ 函数/ ,/ SD/ -/ Miner/ 的/ 决策函数/ 会/ 将/ etherdev/ 等价/ 于/ netdev/ 进行/ 处理/ ./ 4/ 实验/ 分析/ 本节/ 将/ 对/ SD/ -/ Miner/ 的/ 实验/ 进行/ 分析/ 和/ 介绍/ ,/ 对/ SD/ -/ Miner/ 的/ 规则/ 挖掘/ 能力/ 和/ 违例/ 检测/ 能力/ 进行/ 评测/ ./ 本文/ 采用/ 的/ 编程/ 分析/ 环境/ 如表/ 1/ ./ 其中/ ,/ 第/ 4.1/ 小节/ 将/ 对/ 工具/ 的/ 运算/ 耗时/ 和/ 复杂性/ 进行/ 分析/ ;/ 第/ 4.2/ 小节/ 中/ 对/ 从/ Linux/ 中/ 提取/ 的/ 顺序/ 依赖/ 相关/ 的/ 规则/ 进行/ 介绍/ ;/ 在/ 第/ 4.3/ 小节/ 中/ ,/ SD/ -/ Miner/ 对/ Linux/ 的/ 高低/ 版本/ 分别/ 进行/ 评测/ ,/ 通过/ 评测/ 结果/ 来/ 验证/ 其/ 真实/ 违例/ 的/ 检测/ 能力/ ;/ 本节/ 的/ 最后/ 对/ 当前/ 较/ 新/ 的/ Linux/ 版本/ 进行/ 检测/ 和/ 分析/ ./ 指标/ 参数/ Inteli3/ -/ 3220/ ,/ 3.30/ GHz4GDDR31T/ ,/ 7200rps4/ ./ 1/ 计算/ 复杂性/ 与/ 耗时/ 分析/ SD/ -/ Miner/ 需要/ 对/ P/ 、/ R/ 操作/ 集两/ 两/ 函数/ 之间/ 进行/ 关联性/ 挖掘/ 和/ 分析/ ,/ 针对/ P/ 操作/ 内部/ 的/ 每/ 一个/ 函数/ 需要/ 分析/ 与/ 其他/ 函数/ 之间/ 的/ 顺序/ 依赖/ 关系/ ,/ 以及/ 分析/ 与/ 对应/ 的/ R/ 操作/ 内部/ 的/ 每/ 一个/ 函数/ 之间/ 的/ 配对/ 依赖/ 关系/ ./ 假定/ 共有/ N/ 对/ P/ 、/ R/ 操作/ ,/ 每个/ 操作/ 平均/ 调用/ 了/ M/ 个/ 函数/ ,/ 据此/ 对/ 运算/ 的/ 复杂性/ 进行/ 估计/ ,/ 则/ 规则/ 分析/ 需要/ 的/ 操作/ 估计/ 达到/ N/ ×/ M/ ×/ M/ 次/ 函数/ 匹配/ ./ 在/ 违例/ 检测/ 时/ 也/ 需要/ 再次/ 扫描/ P/ 、/ R/ 操作/ 中/ 的/ 每个/ 函数/ ,/ 时间/ 与/ 挖掘/ 分析/ 时间/ 基本/ 相当/ ,/ 但是/ 对于/ M/ 个/ 函数/ 而言/ ,/ 假定/ 序列/ 规则/ 的/ 平均/ 长度/ 为/ L/ ,/ 则/ DFS/ -/ visit/ 本身/ 时间/ 复杂度/ 约/ 为/ θ/ (/ ML/ )/ ,/ 由于/ L/ 为/ 常数/ ,/ 因此/ 分析/ 的/ 总/ 操作/ 次数/ 规模/ 在/ θ/ (/ N/ ×/ M3/ )/ ./ SD/ -/ Miner/ 共计/ 耗时/ 2min/ 对/ Linux3/ ./ 10.10/ 的/ 驱动/ 进行/ 规则/ 挖掘/ ,/ 并/ 花费/ 1min/ 对/ 规则/ 进行/ 优化/ 和/ 分析/ ,/ 结合/ 优化/ 后/ 的/ 结果/ ,/ 花费/ 2min/ 对/ 驱动/ 进行/ 了/ 违例/ 检查/ ,/ 以上/ 累计/ 耗时/ 5min/ ./ 4.2/ Linux/ 源码/ 中/ 规则/ 挖掘/ 分析/ SD/ -/ Miner/ 利用/ 本文/ 中/ 提到/ 的/ 挖掘/ 方法/ ,/ 针对/ Linux3/ ./ 10.10/ 驱动程序/ 中/ 的/ 3/ 类/ 顺序/ 依赖/ 相关/ 的/ 规则/ 进行/ 了/ 提取/ ./ 利用/ probe/ // remove/ 、/ probe/ // disconnect/ 等/ ,/ 累计/ 对/ 3781/ 对/ P/ 、/ R/ 操作/ 进行/ 了/ 分析/ ,/ 从/ 驱动/ 源码/ 中共/ 计提/ 取出/ 了/ 171/ 对/ 配对/ 依赖/ 相关/ 的/ 规则/ ,/ 从/ P/ 操作/ 中/ 提取/ 了/ 49/ 条/ 顺序/ 依赖/ 规则/ ./ 部分/ 重要/ 的/ P/ 操作/ 中/ 的/ 顺序/ 依赖/ 规则/ 如表/ 2/ 所示/ ,/ 以/ scsi/ _/ host/ _/ alloc/ 、/ scsi/ _/ add/ _/ host/ 、/ scsi/ _/ scan/ _/ host/ 为例/ ,/ 三者/ 之间/ 分别/ 构成/ 顺序/ 依赖/ 关系/ ./ 表中/ 每个/ 单元/ 内/ 的/ 括号/ 内/ 表示/ 统计/ 的/ 频数/ ,/ 而表中/ 每/ 行列/ 出/ 的/ 是/ 规则/ 中/ 的/ 前/ 3/ 个/ 函数/ ,/ 并且/ 顺序/ 依赖/ 关系/ 是/ “/ 函数/ 1/ →/ 函数/ 2/ →/ 函数/ 3/ ”/ ./ 规则/ 函数/ 1hostscsi/ _/ host/ _/ allocscsi/ _/ add/ _/ hostscsi/ _/ scan/ _/ hostusbusb/ _/ create/ _/ hcdhcd/ _/ to/ _/ ehciusb/ _/ add/ _/ hcdsoundsnd/ _/ card/ _/ createsnd/ _/ card/ _/ set/ _/ devsnd/ _/ card/ _/ register/ 根据/ 该/ 顺序/ 依赖/ 规则/ ,/ 如果/ P/ 操作/ 中/ 调用/ 不/ 完整/ 或/ R/ 操作/ 中/ 的/ 配对/ 函数/ 的/ 调用/ 次序/ 不/ 满足/ 此/ 顺序/ 依赖/ 关系/ 图/ 的/ 反向/ 图/ 的/ 拓扑/ 排序/ ,/ 则/ 视为/ 违例/ ./ 在/ 配对/ 依赖/ 规则/ 方面/ ,/ 共计/ 提取/ 了/ 49/ 对/ 顺序/ 依赖/ 规则/ ,/ 其中/ 频数/ 与/ 配对/ 函数/ 的/ 数目/ 之间/ 的/ 关系/ 如图/ 9/ 所示/ ,/ 其中/ 频数/ 高于/ 50/ 的/ 顺序/ 依赖/ 规则/ 共计/ 3/ 条/ ./ 图/ 9/ 频数/ (/ 横/ )/ 与/ 配对/ 依赖/ 规则/ 的/ 数目/ (/ 纵/ )/ 关系/ 4.3/ 不同/ 版本/ 潜在/ 的/ 修正/ 的/ bug/ 对比/ 过/ 以下/ 方式/ 对/ 其/ 进行/ 测试/ 和/ 验证/ :/ 为了/ 验证/ SD/ -/ Miner/ 的/ 违例/ 异常/ 检测/ 能力/ ,/ 通/ (/ 1/ )/ 以/ Linux2/ ./ 6.38/ 的/ 源码/ 作为/ 分析/ 对象/ ,/ 通过/ 挖掘/ 和/ 分析/ 提取/ 相应/ 的/ 规则/ ,/ 进而/ 定位/ 其中/ 的/ 顺序/ 依赖/ 相关/ 的/ 使用/ 违例/ ;/ 过/ 同样/ 的/ 方式/ 对系统/ 的/ 违例/ 进行/ 分析/ 和/ 检测/ ;/ (/ 2/ )/ 以/ Linux3/ ./ 10.10/ 的/ 源码/ 作为/ 分析/ 对象/ ,/ 通/ (/ 3/ )/ 对比/ 两者之间/ 的/ 检测/ 结果/ ,/ 找出/ 在/ 2.6/ ./ 38/ 中/ 出现/ 而/ 在/ 3.10/ ./ 10/ 中/ 被/ 修正/ 的/ 使用/ 违例/ ./ 通过/ 分析/ ,/ 共/ 定位/ 了/ 64/ 个/ 在/ 2.6/ ./ 38/ 中/ 出现/ 的/ 违例/ ,/ 它们/ 在/ 3.10/ ./ 10/ 中/ 已经/ 被/ 修正/ ./ 其中/ 部分/ 重要/ 的/ 违/ 例如/ 表/ 3/ 所示/ ,/ 以/ P/ 操作/ ax/ _/ probe/ 函数/ (/ Linux2/ ./ 6.38/ ,/ drivers/ // net/ // ax88796/ ./ c/ )/ 为例/ ,/ 在/ P/ 操作/ 中/ 调用/ 了/ request/ _/ mem/ _/ region/ 函数/ ,/ 该/ 函数/ 存在/ 配对/ 使用/ 的/ 函数/ release/ _/ mem/ _/ region/ ,/ 但是/ 在/ R/ 操作/ 中/ 并未/ 调用/ 该/ 函数/ 对/ request/ _/ mem/ _/ region/ 申请/ 的/ 内存/ 资源/ 进行/ 释放/ ,/ 该种/ 情况/ 下/ 可能/ 造成/ 内存/ 泄露/ ./ 该/ Page11/ 问题/ 在/ Linux3/ ./ 10.10/ 中/ 已经/ 被/ 修复/ ,/ 并且/ 在/ cgit/ 的/ 提交/ 日志/ 中/ ,/ 提到/ 修复/ 的/ 原因/ 为/ “/ ax88796/ :/ clean/ 表/ 3/ 部分/ 犘/ // 犚/ 操作/ 中/ 的/ 配对/ 相关/ 的/ 顺序/ 依赖/ 规则/ P/ 操作/ 函数/ 关键/ 函数/ R/ 操作/ 中/ 配对/ 函数/ drivers/ // net/ // ax88796/ ./ cdrivers/ // hid/ // hid/ -/ wacom/ ./ cdrivers/ // watchdog/ // omap/ _/ wdt/ ./ comap/ _/ wdt/ _/ probepm/ _/ runtime/ _/ enablepm/ _/ runtime/ _/ disableFixthemismatchofunmapIOmemorydrivers/ // staging/ // xgifb/ // XGI/ _/ main/ _/ 26/ ./ cxgifb/ _/ probeioremap/ 表/ 3/ 中/ 给出/ 了/ 部分/ 已经/ 被/ 修正/ 的/ BUG/ ,/ 其中/ 修正/ 的/ 日志/ 中/ 大都/ 明确/ 给出/ 了/ 错误/ 的/ 原因/ ,/ 和/ SD/ -/ Miner/ 定位/ 该类/ 违例/ 的/ 初衷/ 一致/ ,/ 该/ 实验/ 表明/ ,/ SD/ -/ Miner/ 能够/ 准确/ 定位/ 到/ 一些/ 比较/ 重要/ 的/ BUG/ ,/ 下面/ 将/ 对/ 新/ 版本/ 的/ 驱动/ 源码/ 进行/ 违例/ 检测/ ./ 4.4/ 较/ 新/ 版本/ 中/ 存在/ 的/ bugSD/ -/ Miner/ 选取/ 了/ 当前/ 较/ 新/ 的/ Linux/ 内核/ 3.10/ ./ 10/ 作为/ 评测/ 版本/ ,/ 通过/ 静态/ 分析/ ,/ 基于/ 提取/ 的/ 49/ 条/ P/ 操作/ 内部/ 的/ 顺序/ 依赖/ 规则/ ,/ 以及/ 171/ 个/ P/ 、/ R/ 操作/ 之间/ 配对/ 依赖/ 相关/ 的/ 顺序/ 依赖/ 规则/ ,/ 定位/ 到/ 了/ 756/ 个/ 使用/ 违例/ ./ 按照/ 驱动/ 的/ 类别/ 进行/ 分类/ ,/ 违例/ 在/ 各类/ 驱动/ 的/ 分布/ 如图/ 10/ 所示/ ,/ 从图/ 中/ 可以/ 看出/ ,/ 4/ 类/ 驱动/ 所/ 含/ 违例/ 总数/ 占/ 总/ 的/ 23.3/ %/ ,/ 人工/ 分析/ 以太网/ (/ ethernet/ )/ 相关/ 的/ 40/ 处/ 违例/ ,/ 内含/ 不/ 规范/ 使用/ 10/ 处/ 警告/ ,/ 发现/ 漏报/ 1/ 处/ ,/ 误报/ 1/ 处/ ./ 事实上/ ,/ 一些/ 关键设备/ 驱动/ 中/ 仍旧/ 存在/ 一些/ 使用/ 违例/ ,/ 如/ USB/ 网络设备/ 驱动/ 中/ P/ 操作/ usbnet/ _/ probe/ 函数调用/ 了/ pm/ _/ runtime/ _/ enable/ 函数/ ,/ 但是/ 在/ R/ 操作/ 中/ 没有/ 调用/ pm/ _/ runtime/ _/ disable/ 函数/ 执行/ 相反/ 的/ 操作/ ./ 在/ 提取/ 的/ 违例/ 检测/ 结果/ 中/ ,/ 将/ 定位/ 到/ 的/ 其中/ 50/ 个/ 错误/ 以/ 潜在/ 的/ BUG/ 形式/ 提交/ 给/ 了/ 相关/ 的/ 开发人员/ ,/ 至今/ 累计/ 25/ 个/ 开发人员/ 回复/ 了/ 我们/ 的/ 报告/ ,/ 其中/ 20/ 个/ 错误/ 被/ 确认/ ,/ 部分/ 被/ 确认/ 的/ BUG/ 如表/ 4/ 所示/ ./ 表/ 4/ 中/ 给出/ 了/ 违例/ 发生/ 的/ 关联/ 函数/ 和/ 宿主/ 函数/ ./ 需要/ 特别/ 指出/ 的/ 是/ ,/ SD/ -/ Miner/ 与/ PF/ -/ Miner/ [/ 24/ ]/ upprobeandremovefunction/ ”/ ./ 表中/ 的/ 其他/ 用例/ 修复/ 原因/ 在/ 修复/ 日志/ 中/ 给与/ 了/ 介绍/ ./ iounmap/ 等/ 作者/ 已有/ 工作/ 中/ 重合/ 的/ 已/ 确认/ BUG/ 已/ 被/ 直接/ 包含/ 在/ 确认/ 的/ 统计/ 之中/ ./ 路径/ I82975x/ _/ edac/ ./ ci82975x/ _/ init/ _/ onepci/ _/ enable/ _/ deviceR/ 违例/ gpio/ -/ lynxpoint/ ./ clp/ _/ gpio/ _/ probepm/ _/ runtime/ _/ enableR/ 违例/ ipmi/ _/ si/ _/ intf/ ./ cipmi/ _/ pci/ _/ probepci/ _/ enable/ _/ deviceR/ 违例/ 一般/ 的/ 静态/ 工具/ 都/ 会/ 存在/ 漏报/ 和/ 误报/ 等/ 问题/ ,/ 主要/ 原因/ 包括/ :/ (/ 1/ )/ 部分/ 接口函数/ 的/ 调用/ 出现/ 在/ 判定/ 分支/ 中/ ;/ (/ 2/ )/ 部分/ 驱动/ 结构性/ 较差/ ,/ 通过/ 私有/ 的/ 深层/ 调用/ 方式/ 释放/ 资源/ ,/ 而/ SD/ -/ Miner/ 的/ 分析/ 深度/ 不够/ 时/ ,/ 会/ 引起/ 误报/ ,/ 但是/ 该/ 问题/ 已经/ 通过/ 宽松/ 的/ 统计/ 策略/ 和/ 严格/ 的/ 搜查/ 策略/ 来/ 解决/ ,/ 即/ 一旦/ 发现/ 违例/ ,/ 则/ 进入/ 深层次/ 搜索/ ,/ 防止出现/ 误报/ ;/ (/ 3/ )/ 驱动/ 部分/ 接口/ 本身/ 设计/ 不/ 规范/ ,/ 接口/ 之间/ 存在/ 包容/ 关系/ ,/ 如/ 设备/ 加载/ 时/ ,/ 会先/ 调用/ input/ _/ allocate/ _/ device/ 申请/ 资源/ ,/ 然后/ 调用/ input/ _/ register/ _/ device/ 注册/ ,/ 然后/ 卸载/ 时/ 直接/ 调用/ input/ _/ unregister/ _/ device/ 即可/ ,/ 因为/ 其/ 内部/ 已经/ 调用/ 了/ input/ _/ free/ _/ device/ ./ SD/ -/ Miner/ 通过/ 关键字/ 等/ 优化/ 方法/ ,/ 对/ 检测/ 到/ 的/ 违例/ 进行/ 了/ 过滤/ ,/ 对/ 观察/ 到/ 的/ 一些/ 违例/ 进行/ 了/ 筛查/ ,/ 并/ 增加/ 一些/ 规则/ 到/ 该/ 工具/ 中/ ,/ 结合/ 3.5/ 节中/ 提到/ 的/ 误报/ 和/ 漏报/ 优化/ 技术/ ,/ 从而/ 减少/ 误报/ 和/ 漏报/ ./ 目前/ 通过/ 人工/ 分析/ 现有/ 的/ 检测/ 结果/ ,/ 其/ 误报/ 基本/ 控制/ 在/ 15/ %/ 左右/ ./ 5/ 结论/ 与/ 展望/ 本文/ 提出/ 了/ 一种/ 面向/ 内核/ 接口/ 的/ 顺序/ 依赖/ 规则/ 挖掘/ 与/ 违例/ 检测/ 方法/ (/ SD/ -/ Miner/ )/ ,/ 结合/ 驱动/ 源码/ 的/ 结构特征/ ,/ 对/ 驱动/ 代码/ 使用/ 的/ 内核/ 接口/ 进行/ 统计分析/ ,/ 挖掘/ 并/ 提取/ 内核/ 接口/ 的/ 顺序/ 依赖/ 规则/ ,/ 并/ 利用/ 提取/ 的/ 规则/ 检测/ 现有/ 驱动/ 源码/ 中/ 的/ 使用/ 违例/ ./ SD/ -/ Miner/ 对/ Linux3/ ./ 10.10/ 和/ 2.6/ ./ 38/ 的/ 驱动/ 源码/ 进行/ 了/ 规则/ 挖掘/ 与/ 违例/ 检测/ ,/ 对比/ 实验/ 结果/ 发现/ ,/ 在/ 2.6/ ./ 38/ 中/ 存在/ 64/ 个/ 被/ 检测/ 出/ 的/ 错误/ 在/ 3.10/ ./ 10/ 中/ Page12/ 得到/ 了/ 修正/ ./ SD/ -/ Miner/ 对/ Linux3/ ./ 10.10/ 的/ 3781/ 款/ 驱动/ 进行/ 的/ 检测/ 和/ 分析/ 仅/ 耗费/ 5min/ ,/ 共计/ 提取/ 出/ 了/ 220/ 个/ 顺序/ 依赖/ 相关/ 的/ 接口/ 使用/ 规则/ ,/ 并/ 检测/ 到/ 756/ 个/ 使用/ 违例/ ./ 实验/ 结果表明/ ,/ SD/ -/ Miner/ 能够/ 有效/ 地/ 挖掘出/ 内核/ 接口/ 的/ 顺序/ 依赖/ 规则/ ,/ 并/ 检测/ 出/ 使用/ 违例/ ,/ 进而/ 辅助/ 提高/ 驱动/ 可靠性/ ./ 同时/ 规则/ 的/ 挖掘/ 是/ 基于/ 驱动/ 的/ 结构/ 信息/ 和/ 统计/ 信息/ ,/ 不/ 需要/ 开发者/ 在/ 源码/ 中/ 提供/ 额外/ 的/ 注释/ 及/ 标注/ ./ 论文/ 的/ 后续/ 研究/ 工作/ 将/ 结合/ 动态分析/ 技术/ ,/ 把/ 静态/ 定位/ 到/ 的/ 违例/ ,/ 通过/ 动态/ 运行/ 和/ 错误/ 注入/ 技术/ 进行/ 确认/ ,/ 后续/ 将/ 考虑/ 结合/ 动态/ 插装/ 和/ 检测/ 技术/ ,/ 在/ 提高/ 驱动/ 可靠性/ 的/ 同时/ ,/ 将/ 检测/ 的/ 违例/ 动态/ 修复/ ,/ 如/ 及时/ 并/ 自动/ 释放/ 申请/ 的/ 资源/ ./ 这些/ 功能/ 将/ 在/ SD/ -/ Miner/ 的/ 后续/ 版本/ 中/ 进行/ 补充/ 和/ 完善/ ./ 致谢/ 本文/ 作者/ 得到/ 了/ 实验室/ 的/ 老师/ 和/ 同学/ 们/ 的/ 许多/ 帮助/ 和/ 建议/ ,/ 在/ 此/ 表示感谢/ ;/ 同时/ 也/ 感谢/ 审稿人/ 对/ 本文/ 提出/ 宝贵意见/ 和/ 建议/ ;/ 并/ 对/ 帮助/ 我们/ 确认/ 和/ 修正/ bug/ 的/ 开发者/ 表示/ 诚挚/ 感谢/ !/ 

