Page1/ 多核/ 共享/ 缓存/ bank/ 冲突/ 分析/ 及其/ 延迟/ 最小化/ 1/ )/ (/ 北京理工大学/ 计算机/ 科学技术/ 学院/ 北京/ 100081/ )/ 2/ )/ (/ 鲁东/ 大学/ 数学/ 与/ 信息/ 学院/ 山东/ 烟台/ 264025/ )/ 摘要/ 在/ 硬/ 实时/ 多核/ 系统/ 中/ ,/ 共享资源/ 冲突/ 的/ 问题/ 为/ 硬/ 实时/ 任务/ 的/ 最差/ 情况/ 下/ 执行/ 时间/ (/ WCET/ )/ 分析/ 带来/ 了/ 新/ 挑战/ ./ 虽然/ 现有/ 的/ 共享/ 缓存/ 冲突/ 分析/ 技术/ 在/ storage/ 冲突/ 方面/ 已/ 取得/ 研究进展/ ,/ 但/ 对于/ bank/ 冲突/ 而言/ ,/ 现有/ 研究/ 仍/ 局限于/ 通过/ 界定/ bank/ 冲突/ 延迟/ 上限/ 来/ 分析/ 和/ 处理/ bank/ 冲突/ ./ 该文/ 通过/ 优化/ 核/ -/ bank/ 映射/ 关系/ 来/ 使/ 硬/ 实时/ 多核/ 系统/ 中/ 的/ bank/ 冲突/ 延迟/ 最小化/ ,/ 即/ 在/ 对/ bank/ 冲突/ 延迟/ 进行/ 分析/ 的/ 基础/ 上/ ,/ 首先/ 通过/ 优化/ 核/ -/ bank/ 之间/ 的/ 映射/ 关系/ 来/ 消除/ bank/ 冲突/ ;/ 若/ 无法/ 消除/ ,/ 则/ 需要/ 寻找/ 能/ 使/ bank/ 冲突/ 延迟/ 最小化/ 的/ 核/ -/ bank/ 映射/ 关系/ 解/ ,/ 并/ 为此/ 设计/ 了/ 一种/ 基于/ 多核/ 总线/ 请求/ 时间/ 序列/ 的/ bank/ 冲突/ 延迟/ 求解/ 算法/ ./ 最后/ ,/ 文中/ 设计/ 了/ 能够/ 对/ 总线/ 访问/ 延迟/ 进行/ 消重/ 的/ 多/ 核硬/ 实时/ 任务/ WCET/ 估算/ 方法/ ./ 实验/ 结果表明/ :/ 文中/ 所提/ 的/ 优化/ 方法/ 可/ 消除/ 这类/ bank/ 冲突/ 或/ 使/ 其/ 延迟/ 最小化/ ,/ 文中/ 所提/ 的/ WCET/ 估算/ 方法/ 与/ 现有/ 估算/ 方法/ 相比/ 可/ 获得/ 更/ 精确/ 的/ 最差/ 情况/ 下/ 执行/ 时间/ (/ WCET/ )/ ./ 关键词/ 多核/ 系统/ ;/ 硬/ 实时/ 任务/ ;/ 优化/ ;/ 核到/ bank/ 映射/ ;/ bank/ 冲突/ 延迟/ ;/ 最差/ 情况/ 下/ 执行/ 时间/ 1/ 引言/ 硬/ 实时/ 系统对/ 硬/ 实时/ 任务/ 的/ 执行/ 时间/ 有着/ 严格要求/ ,/ 每个/ 硬/ 实时/ 任务/ 必须/ 在/ 确定/ 的/ 截止期/ 之前/ 完成/ ./ 硬/ 实时/ 任务/ 的/ 最差/ 情况/ 下/ 的/ 执行/ 时间/ (/ WCET/ )/ 是/ 判断/ 硬/ 实时/ 任务/ 是否/ 能够/ 安全/ 运行/ 的/ 重要依据/ [/ 1/ ]/ ,/ 迄今为止/ ,/ 针对/ 硬/ 实时/ 单核/ 系统/ 的/ WCET/ 估算/ 技术/ 已/ 取得/ 重大/ 的/ 研究进展/ [/ 2/ ]/ ,/ 然而/ ,/ 随着/ 嵌入式/ 多/ 核技术/ (/ 如/ ARM11MPCore/ ①/ ,/ QorIQP4080/ ②/ 等/ )/ 在/ 硬/ 实时/ 系统/ 领域/ 的/ 广泛应用/ ,/ 这类/ 硬/ 实时/ 多核/ 系统/ 中/ 往往/ 存在/ 着/ 任务/ 之间/ 可以/ 共享/ 的/ 资源/ ,/ 如/ 共享/ 的/ 片/ 上/ 高速缓存/ 和/ 片/ 上/ 总线/ 等/ ,/ 同时/ 运行/ 的/ 硬/ 实时/ 任务/ 在/ 使用/ 这些/ 共享资源/ 时/ 可能/ 会/ 发生/ bank/ 冲突/ 、/ 总线/ 访问/ 冲突/ 等/ ./ 这些/ 冲突/ 会/ 给/ 硬/ 实时/ 任务/ 的/ 执行/ 带来/ 不可/ 预测/ 的/ 额外/ 执行/ 时间/ ,/ 这为/ WCET/ 估算/ 带来/ 了/ 新/ 的/ 技术/ 挑战/ [/ 3/ ]/ ./ 由于/ 基于/ 单核/ 的/ 传统/ WCET/ 估算/ 技术/ 无法/ 支持/ 对/ 这类/ 冲突/ 的/ 时间/ 分析/ [/ 4/ -/ 5/ ]/ ,/ 为了/ 获取/ 安全/ 的/ WCET/ ,/ 我们/ 在/ 对/ 多/ 核/ 系统/ 上/ 的/ 硬/ 实时/ 任务/ 进行/ WCET/ 估算/ 时/ ,/ 必须/ 重新/ 估算/ 这些/ 冲突/ 对/ 执行/ 时间/ 带来/ 的/ 影响/ ./ 目前/ ,/ 多/ bank/ 结构/ 已/ 成为/ 共享/ 缓存/ 设计/ 的/ 主要/ 方向/ [/ 6/ -/ 8/ ]/ ,/ 例如/ 一个多/ bank/ 结构/ 的/ L2/ 缓存/ 由/ 多个/ bank/ 组成/ ,/ 当/ 多个/ 请求/ 同时/ 到达/ L2/ 缓存/ 的/ 一个/ bank/ 时/ ,/ 只能/ 有/ 一个/ 请求/ 使用/ 这个/ bank/ ,/ 其他/ 请求/ 必须/ 等待/ ,/ 此时/ 就/ 发生/ 了/ bank/ 访问/ 冲突/ ./ 在/ 对/ bank/ 访问/ 冲突/ 的/ 处理/ 上/ ,/ 现有/ 技术/ (/ 如/ Paolieri/ [/ 9/ ]/ 和/ Yoon/ [/ 10/ ]/ 等/ )/ 主要/ 采用/ 界定/ 每个/ 请求/ 遭受/ 的/ bank/ 冲突/ 延迟/ 上限/ 的/ 方法/ ./ 这种/ 方法/ 虽然/ 可以/ 简化/ WCET/ 的/ 估算/ ,/ 但/ 需要/ 借助于/ 特殊/ 的/ 总线结构/ 或/ 总线/ 仲裁/ 策略/ 将/ bank/ 冲突/ 延迟/ 限制/ 在/ 一定/ 范围/ 内/ ,/ 如/ 两层/ 总线/ 仲裁/ 策略/ (/ twohierarchicalbusarbitration/ )/ [/ 9/ ]/ 、/ 和谐/ 的/ 轮询/ 总线/ 仲裁/ 策略/ (/ harmonicround/ -/ robinbusarbitration/ )/ [/ 10/ ]/ 等/ ;/ 然而/ ,/ 其他/ 一些/ 常见/ 的/ 总线结构/ 或/ 总线/ 仲裁/ 策略/ ,/ 如/ 简单/ 轮询/ 策略/ (/ pureround/ -/ robinarbitration/ )/ ,/ 与/ 这类/ 特殊/ 的/ 总线/ 仲裁/ 策略/ 完全/ 不同/ ,/ 采用/ 上述/ bank/ 冲突/ 延迟/ 上限/ 界定/ 法/ 就/ 无法/ 有效/ 界定/ 每个/ 请求/ 遭受/ 的/ bank/ 冲突/ 延迟/ 上限/ ./ 另外/ ,/ 这种/ 界定/ bank/ 冲突/ 延迟/ 上限/ 的/ 方法/ 对/ 硬/ 实时/ 任务/ 的/ WCET/ 估算/ 过高/ ./ 无论/ 请求/ 遭受/ 到/ bank/ 访问/ 冲突/ 与否/ ,/ 该/ 方法/ 为/ 每个/ 访存/ 请求/ 增加/ 一个/ 额外/ 的/ bank/ 冲突/ 延迟/ 上限/ ./ 实际上/ ,/ 并/ 不是/ 所有/ 请求/ 都/ 会/ 遭受/ 到/ bank/ 访问/ 冲突/ ,/ 并且/ 即使/ 在/ 一组/ 请求/ 中/ 发生/ 了/ bank/ 访问/ 冲突/ ,/ 每个/ 请求/ 遭受/ 的/ bank/ 冲突/ 延迟/ 也/ 不尽相同/ ,/ 如/ 第/ 1/ 个/ 访存/ 请求/ 就/ 不会/ 遭受/ 到/ bank/ 访问/ 冲突/ ./ 在/ 硬/ 实时/ 多核/ 系统/ 中/ ,/ 运行/ 在/ 同核/ 上/ 的/ 硬/ 实时/ 任务/ 之间/ 不/ 存在/ bank/ 访问/ 冲突/ ,/ 而/ 在/ 不同/ 核上/ 同时/ 运行/ 的/ 硬/ 实时/ 任务/ 若/ 因为/ 共享/ 某个/ bank/ ,/ 则/ 它们/ 之间/ 可能/ 存在/ bank/ 访问/ 冲突/ ./ 因此/ ,/ 不同/ 的/ 核到/ bank/ 映射/ 方式/ 对应/ 的/ bank/ 访问/ 冲突/ 不同/ ,/ 通过/ 改变/ 核到/ bank/ 映射/ 关系/ 就/ 可/ 改变/ 多核/ 系统/ 中/ bank/ 访问/ 冲突/ 的/ 情况/ ./ 本文/ 的/ 主要/ 目的/ 是/ 通过/ 优化/ 核到/ bank/ 的/ 映射/ 关系/ 来/ 优化/ 硬/ 实时/ 多核/ 系统/ 中/ 的/ bank/ 冲突/ 延迟/ ,/ 进而/ 对/ 硬/ 实时/ 多核/ 系统/ 进行/ WCET/ 估算/ ./ 其中/ ,/ 硬/ 实时/ 多核/ 系统/ 中/ 的/ L2/ 缓存/ 采用/ 了/ 多/ bank/ 结构/ 并/ 进行/ column/ 划分/ ③/ ,/ 共享/ 总线/ 为/ 采用/ 简单/ 轮询/ 总线/ 仲裁/ 策略/ 的/ 时分/ 多路复用/ (/ TDMA/ )/ 实时/ 总线/ ./ 本文/ 主要/ 贡献/ 如下/ :/ (/ 1/ )/ 对/ 采用/ 简单/ 轮询/ 总线/ 仲裁/ 策略/ 的/ 硬/ 实时/ 多核/ 系统/ 进行/ 了/ bank/ 冲突/ 延迟/ 分析/ ,/ 给出/ 了/ bank/ 访问/ 冲突/ 发生/ 的/ 条件/ 和/ bank/ 冲突/ 延迟/ 的/ 计算方法/ ;/ (/ 2/ )/ 根据/ bank/ 访问/ 冲突/ 发生/ 的/ 条件/ ,/ 首先/ 优化/ 核到/ bank/ 的/ 映射/ 关系/ 以/ 消除/ bank/ 访问/ 冲突/ ./ 若/ 不能/ 消除/ bank/ 访问/ 冲突/ ,/ 则/ 进一步/ 优化/ 核到/ bank/ 的/ 映射/ 关系/ 使/ bank/ 冲突/ 延迟/ 最小化/ ,/ 并/ 为/ 该/ 优化/ 问题/ 提出/ 了/ 一种/ 基于/ 多核/ 总线/ 请求/ 时间/ 序列/ 的/ bank/ 冲突/ 延迟/ 求解/ 算法/ ;/ (/ 3/ )/ 提出/ 了/ 多/ 核硬/ 实时/ 任务/ 的/ WCET/ 估算/ 方法/ ,/ 该/ 方法/ 综合/ 考虑/ 了/ 任务/ 在/ 流水线/ 上/ 的/ 执行/ 时间/ 、/ 访问/ 存储系统/ 的/ 时间/ 和/ 总线/ 访问/ 延迟/ 之间/ 的/ 相互影响/ 关系/ ./ 本文/ 第/ 2/ 节/ 介绍/ 相关/ 工作/ ;/ 第/ 3/ 节/ 给出/ 硬/ 实时/ 多核/ 系统/ 模型/ ,/ 包括/ 多核/ 结构/ 和/ 应用/ 模型/ ;/ 第/ 4/ 节分/ ①/ ②/ ③/ Page3/ 析/ bank/ 冲突/ 延迟/ ;/ 第/ 5/ 节/ 提出/ 优化/ 问题/ ,/ 并/ 设计/ 求解/ 算法/ ;/ 第/ 6/ 节/ 设计/ 多核/ 硬/ 实时/ 任务/ 的/ WCET/ 估算/ 方法/ ;/ 第/ 7/ 节/ 给出/ 实验/ 环境/ 及/ 实验/ 验证/ 结果/ ;/ 第/ 8/ 节/ 得出结论/ ./ 2/ 相关/ 工作/ 在/ 硬/ 实时/ 多核/ 系统/ 中/ ,/ 与/ L2/ 缓存/ 相关/ 的/ 任务/ 间/ 冲突/ 主要/ 包括/ storage/ 干扰/ 和/ bank/ 访问/ 冲突/ ./ 由于/ 总线/ 访问/ 冲突/ 与/ storage/ 干扰/ 或/ bank/ 访问/ 冲突/ 之间/ 存在/ 着/ 相互影响/ ,/ 因此/ 在/ 分析/ storage/ 干扰/ 或/ bank/ 访问/ 冲突/ 时/ ,/ 一般/ 需要/ 结合/ 总线/ 访问/ 冲突/ 进行/ 分析/ ./ 一些/ 现有/ 的/ 研究成果/ 将/ 共享/ 总线/ 设计/ 和/ 共享/ 缓存/ 划分/ 技术/ 结合/ 起来/ ,/ 对/ 请求/ 遭受/ 的/ 总线/ 访问/ 延迟/ 和/ bank/ 冲突/ 延迟/ 进行/ 分析/ ,/ 但/ 采用/ 了/ 界定/ 每个/ 请求/ 遭受/ 的/ 延迟/ 上限/ 的/ 方法/ ./ 如/ Paolieri/ 等/ 人/ [/ 9/ ]/ 在/ 其/ 工作/ 中/ ,/ 提出/ 了/ 一种/ 二层/ 总线/ 仲裁/ 的/ 多/ 核/ 结构/ ,/ 用以/ 界定/ 每个/ 总线/ 请求/ 遭受/ 的/ 总线/ 访问/ 延迟/ 和/ bank/ 冲突/ 延迟/ ,/ 共享/ L2/ 缓存/ 采用/ 缓存/ 划分/ 或/ bankization/ 划分/ ,/ 以/ 消除/ storage/ 干扰/ 或/ bank/ 访问/ 冲突/ ;/ 在/ 采用/ bankization/ 划分/ 时/ ,/ 要求/ 任务/ 独占/ 分配/ 的/ bank/ 以/ 消除/ bank/ 访问/ 冲突/ ,/ 受/ bank/ 数目/ 的/ 影响/ ,/ 这种/ 方法/ 受限制/ 于/ 硬/ 实时/ 多核/ 系统/ 的/ 工作/ 负荷/ ./ 然而/ 该/ 方法/ 仅/ 适用/ 于/ 这类/ 特殊/ 的/ 多/ 核/ 结构/ ,/ 且/ WCET/ 估算/ 方法/ 采用/ 了/ 界定/ 延迟/ 上限/ 的/ 方法/ ./ 再/ 如/ 在/ Yoon/ 等/ 人/ [/ 10/ ]/ 的/ 可调/ WCET/ (/ tunableWCET/ )/ 、/ 和谐/ 的/ 轮询/ 总线/ 仲裁/ 策略/ 等/ 工作/ 中/ ,/ 共享/ L2/ 缓存/ 采用/ 二级/ 划分/ 结构/ ,/ 整个/ 缓存/ 被/ 划分/ 成/ 多个/ bank/ ,/ 每个/ bank/ 又/ 进一步/ 被/ 划分/ 成/ 多个/ column/ ./ 其中/ ,/ 核向/ bank/ 做/ 映射/ ,/ 硬/ 实时/ 任务/ 向/ column/ 做/ 映射/ 且/ 独占/ 分配/ 的/ column/ 以/ 消除/ storage/ 干扰/ ./ 在/ 优化/ 时/ 采用/ 了/ 界定/ bank/ 冲突/ 延迟/ 和/ 总线/ 访问/ 延迟/ 上限/ 的/ 方法/ ./ 然而/ 该/ 方法/ 仅/ 适用/ 于/ 和谐/ 的/ 轮询/ 总线/ 仲裁/ 策略/ ,/ 同时/ 采用/ 界定/ 延迟/ 上限/ 的/ 方法/ 造成/ WCET/ 估算/ 过高/ ./ 另有/ 一些/ 研究成果/ 是/ 将/ storage/ 干扰/ 分析/ 和/ 总线/ 访问/ 冲突/ 分析/ 结合/ 起来/ 进行/ WCET/ 估算/ ,/ 但/ 在/ 分析/ 时/ 却/ 没有/ 考虑/ bank/ 访问/ 冲突/ 问题/ ./ 如/ Andrei/ 等/ 人/ [/ 11/ ]/ 和/ Ros/ é/ n/ 等/ 人/ [/ 12/ ]/ 提出/ 的/ TDMA/ 总线/ 延迟/ 分析/ 和/ storageinterference/ 延迟/ ,/ 优化/ 了/ 总线/ 调度/ 策略/ ,/ 其/ 特点/ 是/ ,/ 在/ 这种/ TDMA/ 总线/ 中/ 使用/ 静态/ 调度/ 分析/ ,/ 总线/ 时槽/ 被/ 静态/ 地/ 分配/ 给/ 不同/ 的/ 核/ ./ Chattopadhyay/ 等/ 人/ [/ 13/ ]/ 提出/ 了/ 融合/ 共享/ 缓存/ 和/ 总线/ 的/ WCET/ 分析/ 框架/ ,/ 在/ 分析/ 总线/ 访问/ 延迟/ 时/ 让/ 循环/ 的/ 开始/ 与/ 总线/ 调度/ 周期/ 的/ 第一个/ 时槽/ 对齐/ ,/ 同时/ 考虑/ 到/ L2/ 缓存/ 的/ storage/ 干扰/ ,/ 因此/ 进行/ 反复/ 迭代/ 与/ 调整/ ,/ 直到/ 结果/ 稳定/ ./ 虽然/ 这种/ 方法/ 比/ Andrei/ 等/ 人/ [/ 11/ ]/ 提出/ 的/ 方法/ 效率高/ ,/ 但是/ 该/ 方法/ 对/ WCET/ 值/ 估算/ 仍过/ 高/ ./ Kelter/ 等/ 人/ [/ 14/ ]/ 通过/ 界定/ TDMA/ 偏移量/ (/ TDMAoffset/ )/ 上界/ 的/ 方法/ 来/ 进一步提高/ 分析/ 效率/ ,/ 具体/ 采用/ 了/ Chattopadhyay/ 等/ 人/ [/ 13/ ]/ 提出/ 的/ 分析/ 框架/ 来/ 估算/ WCET/ ,/ 并用/ 全局/ 收敛性/ 分析/ (/ globalconvergenceanalysis/ )/ 来/ 界定/ TDMA/ 总线/ 偏移量/ 的/ 上限/ ./ Kelter/ 等/ 人/ [/ 15/ ]/ 静态/ 分析/ (/ staticanalysis/ )/ 了/ TDMA/ 总线/ 给/ 请求/ 带来/ 的/ 总线/ 访问/ 延迟/ ,/ 并/ 给出/ 了/ 形式化/ 证明/ ./ 同时/ 结合/ storage/ 干扰/ 分析/ 估算/ 了/ 多/ 核/ 系统/ 的/ WCET/ ./ Chattopadhyay/ 等/ 人/ [/ 16/ ]/ 提出/ 了/ 一种/ 多核/ 系统/ 的/ WCET/ 分析/ 框架/ ,/ 改进/ 了/ 文献/ [/ 13/ ]/ 对/ 循环/ 结构/ 的/ 处理/ ./ 在/ 分析/ 总线/ 访问/ 延迟/ 时/ 不再/ 让/ 循环/ 的/ 开始/ 与/ 总线/ 调度/ 周期/ 的/ 第一个/ 时槽/ 对齐/ ,/ 而是/ 根据/ 执行/ 上下文/ (/ executioncontext/ )/ ,/ 令/ 请求/ 的/ 总线/ 访问/ 延迟/ 为/ 可能/ 遭受/ 的/ 最大/ 总线/ 访问/ 延迟/ ./ Li/ 等/ 人/ [/ 17/ ]/ 分析/ 了/ 并行任务/ 的/ WCET/ ,/ 首先/ 使用/ 信息/ 序列图/ (/ MessageSequenceChart/ ,/ MSC/ )/ 将/ 并行任务/ 的/ 生命期/ 分成/ 重叠/ (/ overlapping/ )/ 和/ 非/ 重叠/ (/ nonoverlapping/ )/ 两/ 部分/ ,/ 对于/ 重叠/ 部分/ 的/ 分析/ ,/ 采用/ Chattopadhyay/ 等/ 人/ [/ 13/ ]/ 提出/ 的/ 分析/ 框架/ 和/ Kelter/ 等/ 人/ [/ 14/ ]/ 提出/ 的/ 界定/ 总线/ 偏移量/ 的/ 方法/ ./ 还有/ 一些/ 研究成果/ 将/ 分析/ 重点/ 仅/ 放在/ storage/ 干扰/ 上/ ,/ 均/ 没有/ 考虑/ bank/ 冲突/ 延迟/ 和/ 总线/ 访问/ 延迟/ 对/ 硬/ 实时/ 任务/ WCET/ 的/ 影响/ ./ 如/ Yan/ 等/ 人/ [/ 18/ ]/ 根据/ 线程/ 的/ 程序控制/ 流/ 信息/ ,/ 计算/ 线程/ 在/ 共享/ L2/ 指令/ 缓存/ 上/ 的/ storage/ 干扰/ ./ Chen/ 等/ 人/ [/ 19/ ]/ 通过/ 指令/ 的/ 取指/ 时间/ 关系/ ,/ 分析/ 了/ 进程/ 在/ 共享/ 缓存/ 上/ 的/ storage/ 干扰/ ./ Ding/ 等/ 人/ [/ 20/ ]/ 提出/ 了/ 动态/ 锁/ 指令/ 缓存/ 以/ 消除/ storage/ 干扰/ ,/ 该/ 方法/ 可/ 灵活/ 锁定/ 循环/ 结构/ 对应/ 的/ 缓存/ 空间/ ./ Liu/ 等/ 人/ [/ 21/ ]/ 应用/ 锁/ 缓存/ 技术/ 来/ 消除/ storage/ 干扰/ ./ 3/ 硬/ 实时/ 多核/ 系统/ 模型/ 3.1/ 嵌入式/ 多核/ 模型/ 如图/ 1/ 所示/ 的/ 一个/ 嵌入式/ 多核/ 处理器/ 含有/ Ncore/ 个/ 同构/ 的/ 有序/ (/ in/ -/ order/ )/ 核/ ,/ 表示/ 为/ C/ =/ {/ c1/ ,/ c2/ ,/ …/ ,/ }/ ./ 每个/ 核有/ 自己/ 私有/ 的/ 第一级/ 数据/ 缓存/ 和/ 指令/ cNcore/ 缓存/ ./ 由/ 所有/ 核/ 共享/ 使用/ 的/ 第二级/ 缓存/ (/ unifiedL2cache/ )/ 采用/ 多/ bank/ 结构/ ,/ 由/ Nbank/ 个/ 大小/ 相等/ 的/ bank/ 组成/ ,/ 表示/ 为/ B/ =/ {/ b1/ ,/ b2/ ,/ …/ ,/ bNbankPage4/ 需要/ 的/ 时间/ 为/ LM/ 个/ 时钟/ 周期/ (/ cycles/ )/ ./ 使用/ Yoon/ 等/ 人/ [/ 10/ ]/ 提出/ 的/ 缓存/ 两级/ 划分/ 方法/ 将/ 每个/ bank/ 进一步/ 划分/ 成/ 相等/ 的/ Ncolumn/ 个/ columns/ ./ 连接/ L2/ 缓存/ 和/ 核/ 的/ 实时/ 总线/ 是/ 全双工/ TDMA/ 总线/ ,/ 该/ 实时/ 总线/ 采用/ 简单/ 轮询/ 调度/ 策略/ ,/ 每个/ 总线/ 调度/ 周期/ 有/ Lround/ 个/ 等/ 长/ 的/ 总线/ 时槽/ ,/ 表示/ 为/ R/ =/ {/ s1/ ,/ s2/ ,/ …/ ,/ sLround/ 每个/ 总线/ 时槽/ 的/ 长度/ 等于/ 总线/ 完成/ 一次/ 请求/ 所/ 需要/ 的/ 时间/ ,/ 表示/ 为/ LB/ 个/ 时钟/ 周期/ ./ 假设/ LM/ // LB/ 是/ 整数/ ,/ 那么/ 一个/ 请求/ 完成/ 一次/ L2/ 缓存/ 访问/ 至少/ 需要/ (/ LB/ +/ LM/ )/ 个/ 时钟/ 周期/ ,/ 设为/ Llat/ ./ 核到/ 总线/ 时槽/ 的/ 映射/ 是/ 一一/ 映射/ ,/ 且/ 把/ 核/ ci/ (/ ∈/ C/ )/ 映射/ 到/ 总线/ 时槽/ si/ (/ ∈/ R/ )/ 上/ ./ 请求/ 访问/ L2/ 缓存/ ,/ 发生/ 缺失/ 时/ 需要/ 访问/ 主存/ ,/ 假设/ 请求/ 访问/ 主存/ 需要/ 的/ 时间/ 为/ LL2penal/ 个/ 时钟/ 周期/ ./ 3.2/ 多任务/ 应用/ 模型/ 假设/ 一组/ 硬/ 实时/ 任务/ 已经/ 被/ 分配/ 到/ Ncore/ 个/ 核上/ ,/ 这些/ 任务/ 在/ 执行/ 过程/ 中/ 不能/ 在/ 核间/ 迁移/ ,/ 同核/ 上/ 的/ 任务/ 将/ 按/ 顺序/ 执行/ ,/ 那么/ 某/ 时间段/ 内/ 最/ 多/ 有/ Ncore/ 个/ 任务/ 均匀分布/ 在/ Ncore/ 核上/ 且/ 并发/ 执行/ ./ 在/ 确定/ 任务/ 到/ 核/ 的/ 分配/ 后/ ,/ 需要/ 确定/ 核/ 需要/ 的/ L2/ 缓存/ 大小/ ,/ 设/ HTi/ 是/ 分配/ 到/ 核/ ci/ 的/ 任务/ 集合/ ,/ 任务/ τ/ j/ (/ ∈/ HTi/ )/ 需要/ 的/ L2/ 缓存/ 大小/ 为/ Sizej/ 个/ columns/ ,/ 则/ 核/ ci/ 需要/ 的/ L2/ 缓存/ 大小/ 为/ Sizeci/ =/ max/ (/ Sizej/ |/ 1/ / j/ / ni/ )/ 个/ columns/ ,/ 其中/ ni/ 为/ 集合/ HTi/ 中/ 的/ 任务/ 数/ ./ 采用/ 类似/ 于/ Yoon/ 等/ 人/ [/ 10/ ]/ 所提/ 方法/ 来作/ 核到/ bank/ 的/ 映射/ 和/ 硬/ 实时/ 任务/ 到/ column/ 的/ 映射/ ,/ 按照/ 核/ 需要/ 的/ 最大/ L2/ 缓存/ 大小/ 向/ bank/ 作/ 映射/ ,/ 当/ 多个/ 核/ 共享/ 使用/ 某个/ bank/ 时/ ,/ 在/ 这些/ 核上/ 同时/ 运行/ 的/ 任务/ 之间/ 有/ 可能/ 存在/ bank/ 访问/ 冲突/ ./ 在/ 作/ 任务/ 到/ column/ 的/ 映射/ 时/ ,/ 任务/ 独占/ 分配/ 给/ 它/ 的/ column/ ./ 故/ 不/ 存在/ storage/ 干扰/ ./ 另外/ ,/ 采用/ Li/ 等/ 人/ [/ 17/ ]/ 所提/ 方法/ 来/ 处理/ 任务/ 间/ 的/ 共享/ 代码/ 和/ 任务/ 间/ 的/ 通信/ ./ 如果/ 多个/ 任务/ 共享/ 使用/ 某个/ 函数/ 或/ 程序段/ ,/ 则/ 为/ 每个/ 任务/ 复制/ 一份/ 以/ 取消/ 任务/ 间/ 的/ 代码/ 共享/ ./ 若/ 任务/ 间/ 需要/ 通信/ 则/ 采用/ 邮箱/ 机制/ 来/ 取消/ 由/ 同步/ 带来/ 的/ 影响/ ./ 4Bank/ 冲突/ 延迟/ 分析/ 设有/ Nk/ 示为/ Cbk/ =/ {/ c1/ ,/ c2/ ,/ …/ ,/ cN/ {/ s1/ ,/ s2/ ,/ …/ ,/ sN/ 运行/ 在/ ci/ (/ ∈/ Cbk/ 期中/ 遭受/ 的/ bank/ 冲突/ 延迟/ ./ 如图/ 2/ 所示/ ,/ 当/ i/ ≠/ 1/ 时/ bcdij/ 可以/ 用式/ (/ 1/ )/ 表示/ :/ bcdij/ =/ 图/ 2/ 运行/ 在/ 核/ ci/ (/ ∈/ Cb/ 在/ 第/ 1/ 个/ 总线/ 周期/ 中/ ,/ 核/ c1/ (/ ∈/ Cbkbank/ 冲突/ 延迟/ 为/ 0/ ,/ 即/ bcd11/ =/ 0/ ./ 一般/ 地/ ,/ bcd1j/ 如图/ 3/ 所示/ ,/ 当/ cp/ (/ ∈/ Cbk/ 期上/ 有/ 访问/ bk/ 的/ 请求/ ,/ 且/ 该/ 请求/ 是/ 运行/ 在/ 核/ c1/ 上/ 的/ 硬/ 实时/ 任务/ 在/ 第/ j/ 个/ 总线/ 周期/ 上/ 访问/ bk/ 的/ 前/ 一个/ 请求/ ,/ bcdpq/ 是/ 运行/ 在/ 核/ cp/ 上/ 的/ 硬/ 实时/ 任务/ 在/ 第/ q/ 个/ 总线/ 周期/ 上/ 遭受/ 的/ bank/ 冲突/ 延迟/ ,/ sp/ 是/ 其/ 对应/ 的/ 总线/ 时槽/ ,/ 则/ 运行/ 在/ 核/ c1/ 上/ 的/ 硬/ 实时/ 任务/ 在/ 第/ j/ 个/ 总线/ 周期/ 上/ 遭受/ 的/ bank/ 冲突/ 延迟/ 可以/ 表示/ 为/ bcd1j/ =/ bcdpq/ +/ LM/ -/ (/ j/ -/ q/ -/ 1/ )/ ·/ Lround/ ·/ 进一步/ 简化/ 为式/ (/ 2/ )/ ./ bcd1j/ =/ bcdpq/ +/ LM/ -/ (/ (/ j/ -/ q/ )/ ·/ Lround/ +/ s1/ -/ sp/ )/ ·/ LB/ ,/ >/ 00/ ,/ {/ 定义/ 两核/ ci/ (/ ∈/ C/ )/ 和/ cj/ (/ ∈/ C/ )/ 之间/ 的/ 模/ 距离/ 为/ 它们/ 对应/ 总线/ 时槽/ 的/ 最小/ 距离/ ,/ 即/ dij/ =/ min/ (/ |/ sj/ -/ si/ |/ ,/ Page5/ 图/ 3/ 运行/ 在/ c1/ (/ ∈/ CbLround/ -/ |/ sj/ -/ si/ |/ )/ ./ 为了/ 判断/ 一个/ bank/ 上/ 是否/ 存在/ bank/ 访问/ 冲突/ ,/ 给出/ 定理/ 1/ 如下/ ./ 定理/ 1/ ./ / ci/ ,/ cj/ ∈/ Cbk/ 上/ 不/ 存在/ bank/ 访问/ 冲突/ ./ 证明/ ./ 由于/ dij/ / LM/ // LB/ ,/ 在/ 式/ (/ 1/ )/ 中/ ,/ LM/ -/ (/ si/ -/ s/ (/ i/ -/ 1/ )/ )/ ·/ LB/ / 0/ ,/ 在/ 式/ (/ 2/ )/ 中/ ,/ LM/ -/ (/ (/ j/ -/ q/ )/ ·/ Lround/ +/ s1/ -/ sp/ )/ ·/ LB/ / 0/ ./ 由此可知/ ,/ 在/ 访问/ bk/ 的/ 所有/ 请求/ 中/ ,/ 后/ 一个/ 请求/ 所/ 遭受/ 的/ bank/ 冲突/ 延迟/ 一定/ 小于/ 或/ 等于/ 前/ 一个/ 请求/ 所/ 遭受/ 的/ bank/ 冲突/ 延迟/ ./ 由于/ 在/ 访问/ bk/ 的/ 请求/ 序列/ 中/ ,/ 第一个/ 请求/ 的/ bank/ 冲突/ 延迟/ 为/ 0/ ,/ 又/ 因为/ bank/ 冲突/ 延迟/ 具有/ 非/ 负性/ ,/ 因此/ 所有/ 请求/ 的/ bank/ 冲突/ 延迟/ 都/ 为/ 0/ ,/ 即/ 在/ bk/ 上/ 不/ 存在/ bank/ 访问/ 冲突/ ./ 5/ 优化/ 核到/ bank/ 的/ 映射/ 5.1/ 优化/ 问题/ 的/ 形式化/ 描述/ 由/ 定理/ 1/ 可知/ ,/ 在/ 一个/ 核到/ bank/ 的/ 映射/ 中/ ,/ 若/ 映射/ 到任/ 一个/ bank/ 上/ 的/ 任意/ 两个/ 核/ 之间/ 的/ 模/ 距离/ 大于/ 等于/ LM/ // LB/ ,/ 则/ 在/ 整个/ 系统/ 上/ 不/ 存在/ bank/ 访问/ 冲突/ ./ 用/ xik/ 表示/ bk/ (/ ∈/ B/ )/ 是否/ 有/ column/ 分配/ 给/ ci/ (/ ∈/ C/ )/ ,/ 若有/ (/ 即/ ci/ ∈/ Cbk/ 用/ ncolik/ 表示/ bk/ 分配/ 给/ ci/ (/ ∈/ C/ )/ 的/ column/ 数目/ ,/ 如果/ xik/ =/ 1/ ,/ 则/ ncolik/ >/ 0/ ,/ 否则/ ncolik/ =/ 0/ ,/ 由于/ 硬/ 实时/ 任务/ 独占/ 分配/ 给/ 它/ 的/ column/ ,/ 因此/ ncolik/ 是/ 整数/ ./ 以/ xik/ 和/ ncolik/ 为/ 决策/ 变量/ ,/ 优化/ 核到/ bank/ 的/ 映射/ 使/ 系统/ 不/ 存在/ bank/ 访问/ 冲突/ 的/ 形式化/ 描述/ 如下/ ./ 目标/ 函数/ :/ 约束/ :/ Sizeci/ / 0/ ,/ ncolik/ / 0/ ,/ / ci/ ∈/ C/ ,/ / bk/ ∈/ B/ (/ 7/ )/ 其中/ ,/ 约束/ (/ 4/ )/ 是/ 指/ 在/ 硬/ 实时/ 多核/ 系统/ 中/ L2/ 缓存/ 满足/ 硬/ 实时/ 任务/ 的/ 需求/ ;/ 约束/ (/ 5/ )/ 是/ 指/ 映射/ 分配/ 给/ 每个/ 核/ 的/ column/ 数/ 需要/ 满足/ 每个/ 核/ 的/ 需求/ ;/ 约束/ (/ 6/ )/ 是/ 指/ 在/ 每个/ bank/ 上/ 分配/ 的/ column/ 数/ 不/ 超过/ bank/ 的/ 大小/ ;/ 约束/ (/ 7/ )/ 是非/ 负/ 约束/ ./ 下面/ 利用/ Ncore/ 、/ LM/ // LB/ 和/ Ncolumn/ 参数/ 来/ 探讨/ 通过/ 优化/ 核到/ bank/ 的/ 映射/ 来/ 消除/ bank/ 冲突/ 的/ 判据/ ./ 定理/ 2/ ./ 已知/ Ncore/ 、/ LM/ // LB/ 和/ Ncolumn/ ,/ 且/ L2/ 缓存/ 的/ 容量/ 大小/ 满足/ 需求/ ,/ 若/ Ncore/ // (/ LM/ // LB/ )/ >/ Ncolumn/ ,/ 则/ bank/ 访问/ 冲突/ 可以/ 通过/ 优化/ 核到/ bank/ 的/ 映射/ 去/ 消除/ (/ 证明/ 过程/ 见/ 附录/ )/ ./ 用/ Size/ (/ Ci/ )/ 表示/ 集合/ Ci/ (/ / C/ )/ 中/ ,/ 核/ 需要/ 的/ 总/ column/ 数/ ./ 结合/ 核/ 需要/ 的/ 总/ column/ 数/ ,/ 可以/ 给出/ 当/ LM/ // LB/ =/ 2/ 时/ 能够/ 通过/ 优化/ 核到/ bank/ 的/ 映射/ 消除/ bank/ 冲突/ 的/ 判据/ ,/ 如/ 定理/ 3/ ./ 定理/ 3/ ./ 已知/ C/ 、/ Ncoremod2/ =/ 0/ 、/ LM/ // LB/ =/ 2/ 、/ Ncolumn/ 和/ Sizeci/ >/ 0/ ,/ 1/ / i/ / Ncore/ ./ 将/ C/ 分割/ 成/ 两个/ 互不/ 相交/ 的/ 子集/ C0/ 和/ C1/ 且/ 满足/ :/ 在/ 任一/ 子/ 集中/ 的/ 任意/ 两个/ 核/ 之间/ 的/ 模/ 距离/ 大于/ 等于/ LM/ // LB/ ./ 若/ 在/ 每个/ 子/ 集中/ 能够/ 找到/ 一个/ 核/ 集合/ Csi/ (/ / Ci/ )/ ,/ 0/ / i/ / 1/ ,/ 且/ 满足/ Size/ (/ Csi/ )/ / Size/ (/ Ci/ )/ modNcolumn/ ,/ 则/ bank/ 访问/ 冲突/ 可以/ 通过/ 优化/ 核到/ bank/ 的/ 映射/ 去/ 消除/ (/ 证明/ 过程/ 见/ 附录/ )/ ./ 定理/ 2/ 和/ 3/ 中/ 的/ 条件/ 是/ 判断/ bank/ 冲突/ 是否/ 可以/ 消除/ 的/ 充分条件/ ,/ 在/ 许多/ 应用/ 场景/ 中/ 并/ 不是/ 所有/ 硬/ 实时/ 系统/ 的/ bank/ 访问/ 冲突/ 都/ 能够/ 通过/ 优化/ 核到/ bank/ 的/ 映射/ 消除/ ,/ 例如/ ,/ 在/ 一个/ 6/ 核/ 的/ 硬/ 实时/ 多核/ 系统/ 中/ ,/ L2/ 缓存/ 被/ 划分/ 4/ 个/ 大小/ 相等/ 的/ bank/ ,/ 每个/ bank/ 又/ 被/ 划分/ 成/ 8/ 个/ 大小/ 相等/ 的/ column/ ,/ 核到/ 总线/ 时槽/ 的/ 映射/ 及/ 每个/ 核/ 需要/ 的/ L2/ 缓存/ 的/ 大小/ 如表/ 1/ 所示/ ./ 在/ 这个/ 例子/ 中/ ,/ 使用/ 上述/ 优化/ 方法/ 对/ 核到/ bank/ 的/ 映射/ 进行/ 优化/ ,/ 就/ 不能/ 使/ 共享/ 每个/ bank/ 的/ 任意/ 两核/ 之间/ 的/ 模/ 距离/ 都/ 大于/ 等于/ LM/ // LB/ ./ 在/ 这种/ 情况/ 中/ 就/ 无法/ 通过/ 上述/ 优化/ 方法/ 来/ 消除/ bank/ 访问/ c1c2c3c4c5c6Page6/ 冲突/ ,/ 但/ 可/ 通过/ 优化/ 核到/ bank/ 的/ 映射/ 使多核/ 系统/ 遭受/ 的/ bank/ 冲突/ 延迟/ 最小化/ ./ 设/ Nroci/ 是/ 运行/ 在/ 核/ ci/ (/ ∈/ C/ )/ 上/ 的/ 硬/ 实时/ 任务/ 需要/ 的/ 总线/ 周期/ 数/ ,/ Nrobk/ =/ max/ (/ Nroci/ |/ / ci/ ∈/ Cbk/ 是/ 共享/ bk/ 的/ 硬/ 实时/ 任务/ 需要/ 的/ 最大/ 总线/ 周期/ 数/ ./ 根据/ 式/ (/ 1/ )/ 和/ (/ 2/ )/ ,/ 发生/ 在/ bk/ 上/ 的/ 所有/ bank/ 冲突/ 延迟/ 可以/ 表示/ 为/ ∑/ (/ min/ ∑/ Nrocij/ =/ 1/ 计算/ 任务/ 遭受/ 的/ bank/ 冲突/ 延迟/ 需要/ 关注/ 硬/ 实时/ 任务/ 的/ 执行/ 特性/ ,/ 如/ 访问/ L2/ 缓存/ 的/ 时间/ 、/ L2/ 缓存/ 的/ 地址/ 等/ ,/ 即/ 需要/ 关注/ 硬/ 实时/ 任务/ 的/ 主存/ 块/ 到/ L2/ 缓存/ 的/ 映射/ 以及/ 硬/ 实时/ 任务/ 映射/ 到/ L2/ 缓存/ 的/ 哪些/ column/ 上/ 等/ ./ 为了/ 对/ WCET/ 进行/ 安全/ 估算/ ,/ 当多核/ 共享/ 一个/ bank/ 时/ ,/ 假设/ 这些/ 核上/ 的/ 硬/ 实时/ 任务/ 发出/ 的/ 访问/ L2/ 缓存/ 的/ 请求/ 总是/ 访问/ 这个/ 共享/ bank/ ./ 在/ 此基础/ 上/ ,/ 通过/ 优化/ 核到/ bank/ 的/ 映射/ 来/ 最小化/ 每个/ 硬/ 实时/ 任务/ 遭受/ 的/ bank/ 冲突/ 延迟/ ,/ 根据/ 式/ (/ 8/ )/ ,/ 该/ 优化/ 问题/ 的/ 形式化/ 描述/ 如下/ ./ 目标/ 函数/ :/ 约束/ :/ Sizeci/ / 0/ ,/ ncolik/ / 0/ ,/ / ci/ ∈/ C/ ,/ / bk/ ∈/ B/ (/ 13/ )/ 5.2/ 优化/ 问题/ 求解/ 目标/ 函数/ (/ 9/ )/ 与/ 目标/ 函数/ (/ 3/ )/ 的/ 区别/ 在于/ 在/ 目标/ 函数/ (/ 3/ )/ 中/ 不/ 需要/ 计算/ bank/ 冲突/ 延迟/ ,/ 而/ 目标/ 函数/ (/ 9/ )/ 中则/ 需要/ 计算/ bank/ 冲突/ 延迟/ ./ 5.2/ ./ 1/ 计算/ bank/ 冲突/ 延迟/ 根据/ 前面/ 对/ bank/ 冲突/ 延迟/ 的/ 分析/ ,/ 计算/ bank/ 冲突/ 延迟/ ,/ 需要/ 事先/ 确定/ 多核/ 硬/ 实时/ 任务/ 的/ 总线/ 请求/ 时间/ 序列/ ./ 本文/ 组合/ 使用/ Chronos/ [/ 22/ ]/ 和/ lp/ _/ solve/ ①/ 来/ 获取/ 同核/ 上/ 的/ 硬/ 实时/ 任务/ 的/ 总线/ 请求/ 时间/ 序列/ ,/ 用/ RQci/ 时间/ 序列/ ,/ bank/ 冲突/ 延迟/ 的/ 计算/ 过程/ 主要/ 由/ 以下/ 3/ 部分/ 组成/ ./ (/ 1/ )/ 计算/ 总线/ 访问/ 延迟/ ,/ 确定/ 请求/ 访问/ 总线/ 的/ 时间/ ./ 设/ tj/ -/ 1/ ,/ tj/ (/ ∈/ RQci/ 相邻/ 总线/ 请求/ (/ 分别/ 表示/ 为/ rqj/ -/ 1/ ,/ rqj/ )/ 所/ 对应/ 的/ 总线/ 请求/ 时间/ ,/ badj/ -/ 1/ 为/ 请求/ rqj/ -/ 1/ 遭受/ 的/ 总线/ 访问/ 延迟/ ./ 若/ tj/ >/ (/ tj/ -/ 1/ +/ badj/ -/ 1/ )/ ,/ rqj/ 遭受/ 的/ 总线/ 延迟/ 表示/ 为/ badj/ =/ (/ Lround/ ·/ LB/ +/ (/ si/ -/ 1/ )/ LB/ -/ tjmod/ (/ Lround/ ·/ LB/ )/ )/ mod/ (/ Lround/ ·/ LB/ )/ ;/ 否则/ ,/ badj/ =/ Lround/ ·/ LB/ ./ (/ 2/ )/ 确定/ 当前/ bank/ 冲突/ 延迟/ 所在/ 的/ 总线/ 周期/ ./ 设/ RTkn/ 为/ Nk/ 请求/ 时间/ 的/ 集合/ ,/ 令/ tmin/ =/ min/ (/ tj/ |/ / tj/ ∈/ RTkn/ )/ 是/ RTkn/ 中/ 的/ 最小值/ ,/ 则/ 当前/ 总线/ 周期/ 的/ 开始/ 时间/ 为/ tmin/ -/ tminmod/ (/ Lround/ ·/ LB/ )/ ./ (/ 3/ )/ 计算/ bank/ 冲突/ 延迟/ ./ 如果/ 当前/ 总线/ 周期/ 为/ 第/ 1/ 个/ 总线/ 周期/ ,/ 则/ RTkn/ 中/ 第/ 1/ 个/ 在/ 该/ 总线/ 周期/ 内/ 访问/ 总线/ 请求/ 遭受/ 的/ bank/ 冲突/ 延迟/ 为/ 0/ ,/ 否则/ 根据/ 式/ (/ 2/ )/ 计算/ ;/ 而/ RTkn/ 中/ 在/ 该/ 总线/ 周期/ 内/ 其他/ 的/ 访问/ 总线/ 请求/ 所/ 遭受/ 的/ bank/ 冲突/ 延迟/ 根据/ 式/ (/ 1/ )/ 计算/ ./ 算法/ 1/ 给出/ 了/ 发生/ 在/ bk/ 上/ 的/ bank/ 冲突/ 延迟/ 的/ 计算方法/ ./ si/ 为/ 对应/ 的/ 总线/ 时槽/ ./ 在/ 算法/ 1/ 的/ 输出/ 结果/ 中/ ,/ T/ _/ b/ _/ delay/ [/ i/ ]/ 是/ 运行/ 在/ 核/ ci/ (/ ∈/ Cbk/ 任务/ 所/ 遭受/ 的/ 总/ bank/ 冲突/ 延迟/ ,/ 以便/ 为/ 估算/ 硬/ 实时/ 任务/ 的/ WCET/ 做/ 准备/ ./ 第/ 1/ 、/ 2/ 行/ 初始化/ ,/ current/ _/ q/ [/ i/ ]/ 表示/ 当前/ 处理/ 的/ 总线/ 请求/ 时间/ ,/ used/ [/ i/ ]/ 标记/ 是否/ 可以/ 从/ 请求/ 序列/ 里取/ 第/ 1/ 个/ 请求/ ,/ 若/ used/ [/ i/ ]/ =/ True/ ,/ 则/ 表示/ 可以/ 从/ 请求/ 序列/ 里取/ 第/ 1/ 个/ 请求/ ./ 第/ 5/ 行/ 判断/ 是否/ 可以/ 从/ 请求/ 序列/ 中/ 取出/ 第/ 1/ 个/ 请求/ 到/ rq/ ,/ 第/ 8/ ~/ 14/ 行/ 计算/ 总线/ 访问/ 延迟/ ;/ 第/ 15/ 行/ 更新/ current/ _/ q/ [/ i/ ]/ 为/ 当前/ 请求/ 访问/ 总线/ 的/ 时间/ ,/ 为/ 计算/ bank/ 冲突/ 延迟/ 做/ 准备/ ,/ 并/ 将/ 请求/ 标记/ 为/ 处理/ ./ 第/ 19/ 、/ 20/ 行/ 确定/ 总线/ 调度/ 周期/ ,/ round1/ 是/ 该/ 总线/ 调度/ 周期/ 的/ 开始/ 时间/ ./ 第/ 22/ 行/ 判断/ 请求/ 是否/ 落/ 在/ 当前/ 总线/ 调度/ 周期/ 内/ ./ 第/ 24/ 、/ 25/ 行/ 计算/ 当前/ 总线/ 周期/ 内/ 第/ 1/ 个/ 请求/ 的/ bank/ 冲突/ 延迟/ ,/ 第/ 27/ 、/ 28/ 行/ 计算/ 当前/ 总线/ 周期/ 内/ 其他/ 请求/ 的/ bank/ 冲突/ 延迟/ ./ 第/ 30/ 行/ 更新/ T/ _/ b/ _/ delay/ [/ i/ ]/ ,/ 此时/ ,/ T/ _/ b/ _/ delay/ [/ i/ ]/ 是/ 运行/ 在/ 核/ ci/ 上/ 的/ 硬/ 实时/ 任务/ 截止/ 目前/ 遭受/ 的/ 所有/ bank/ 冲突/ 延迟/ ./ 第/ 35/ 行为/ 计算/ 在/ 下/ 一个/ 总线/ 周期/ 中/ 第/ 1/ 个/ 请求/ 所/ 遭受/ 的/ bank/ 冲突/ 延迟/ 做/ 准备/ ./ 第/ 37/ 行/ 计算/ 在/ bankbk/ 上/ 发生/ 的/ 所/ ①/ Lpsolveversion5/ ./ 5/ ./ http/ :/ // // www/ ./ comp/ ./ nus/ ./ edu/ ./ sg/ // ~/ Page7/ 有/ bank/ 冲突/ 总/ 延迟/ ./ 算法/ 1/ ./ 计算/ 发生/ 在/ bk/ 上/ 的/ bank/ 冲突/ 延迟/ ./ 输入/ :/ Cb/ 输出/ :/ 发生/ 在/ bk/ 上/ 的/ 各核/ bank/ 冲突/ 总/ 延迟/ Total/ _/ delay/ [/ k/ ]/ ,/ 1/ ./ Total/ _/ delay/ [/ k/ ]/ =/ 0/ ;/ 2/ ./ T/ _/ b/ _/ delay/ [/ i/ ]/ =/ 0/ ,/ current/ _/ q/ [/ i/ ]/ =/ 0/ ,/ used/ [/ i/ ]/ =/ True/ ,/ 3/ ./ WHILE/ (/ 存在/ 一个/ RQc4/ ./ FOR/ (/ i/ =/ 1/ ;/ i/ </ =/ Nk5/ ./ IF/ (/ used/ [/ i/ ]/ =/ =/ True/ )/ THEN6/ ./ 7.8/ ./ IF/ (/ rq/ </ =/ current/ _/ q/ [/ i/ ]/ )/ THEN9/ ./ busdelay/ =/ Lround/ / LB/ ;/ 10/ ./ ELSE11/ ./ busdelay/ =/ (/ si/ -/ 1/ )/ / LB/ -/ rqmod/ (/ Lround/ / LB/ )/ ;/ 12/ ./ busdelay/ =/ Lround/ / LB/ +/ busdelay/ ;/ 13/ ./ busdelay/ =/ busdelaymod/ (/ Lround/ / LB/ )/ ;/ 14/ ./ ENDIF15/ ./ current/ _/ q/ [/ i/ ]/ =/ rq/ +/ busdelay/ ;/ 16/ ./ used/ [/ i/ ]/ =/ False/ ;/ 17/ ./ ENDIF18/ ./ ENDFOR19/ ./ 在/ current/ _/ q/ [/ Nk20/ ./ round1/ =/ M/ _/ q/ -/ M/ _/ qmod/ (/ Lround/ / LB/ )/ ;/ 21/ ./ FOR/ (/ i/ =/ 1/ ;/ i/ </ =/ Nk22/ ./ IF/ (/ current/ _/ q/ [/ i/ ]/ </ =/ (/ round1/ +/ (/ si/ -/ 1/ )/ / LB/ )/ )/ THEN23/ ./ IF/ (/ current/ _/ q/ [/ i/ ]/ 是/ 第/ 1/ 个/ 请求/ )/ THEN24/ ./ B/ _/ delay/ =/ Init/ _/ delay/ -/ (/ round1/ +/ si/ / LB/ )/ ;/ 25/ ./ IF/ (/ B/ _/ delay/ </ 0/ )/ THENB/ _/ delay/ =/ 0/ ;/ 26/ ./ ELSE27/ ./ B/ _/ delay/ =/ B/ _/ delay/ +/ LM/ -/ (/ si/ -/ pre/ )/ / LB/ ;/ 28/ ./ IF/ (/ B/ _/ delay/ </ 0/ )/ THENB/ _/ delay/ =/ 0/ ;/ 29/ ./ ENDIF30/ ./ T/ _/ b/ _/ delay/ [/ i/ ]/ =/ T/ _/ b/ _/ delay/ [/ i/ ]/ +/ B/ _/ delay/ ;/ 31/ ./ pre/ =/ si/ ;/ 32/ ./ used/ [/ i/ ]/ =/ True/ ;/ 33/ ./ ENDIF34/ ./ ENDFOR35/ ./ Init/ _/ delay/ =/ round1/ +/ B/ _/ delay/ +/ LM/ +/ pre/ / LB/ ;/ 36/ ./ ENDWHILE37/ ./ Total/ _/ delay/ [/ k/ ]/ =/ ∑/ / c38/ ./ RETURNTotal/ _/ delay/ [/ k/ ]/ ,/ T/ _/ b/ _/ delay/ [/ i/ ]/ ;/ 5.2/ ./ 2/ 优化/ 问题/ 的/ 求解/ 算法/ 设/ Zk/ 是/ 共享/ bk/ (/ ∈/ B/ )/ 的/ 所有/ 硬/ 实时/ 任务/ 之间/ 模/ 距离/ 小于/ LM/ // LB/ 的/ 模/ 距离/ 的/ 数/ ./ 若/ Zk/ =/ 0/ ,/ 则/ 共享/ bk/ 所有/ 硬/ 实时/ 任务/ 之间/ 的/ 模/ 距离/ 都/ 大于/ 等于/ LM/ // LB/ ,/ 根据/ 定理/ 1/ ,/ 在/ 该/ bank/ 上/ 不/ 存在/ bank/ 访问/ 冲突/ ,/ 否则/ ,/ 在/ 该/ bank/ 上/ 可能/ 存在/ bank/ 冲突/ ./ 算法/ 2/ 给出/ 了/ 该/ 优化/ 问题/ 的/ 求解/ 算法/ ./ 第/ 4/ ~/ 25/ 行/ 按照/ c/ _/ seq/ [/ ]/ 依次/ 做/ 核到/ bank/ 的/ 映射/ ./ 根据/ 式/ (/ 1/ )/ 和/ (/ 2/ )/ 可知/ ,/ bank/ 冲突/ 延迟/ 具有/ 积累性/ ,/ 在/ 做/ 核到/ bank/ 映射/ 时/ ,/ 映射/ 到/ 一个/ bank/ 上/ 的/ 核应/ 尽可能/ 的/ 少/ ;/ 另外/ ,/ 算法/ 1/ 在/ 计算/ bank/ 冲突/ 延迟/ 时/ 不/ 考虑/ 一个/ bank/ 中/ 的/ column/ 在/ 地址/ 上/ 的/ 区别/ ,/ 因此/ 核到/ bank/ 的/ 映射/ 过程/ 可以/ 简化/ 如下/ :/ c/ _/ seq/ [/ ]/ 中/ 的/ 核/ 依次/ 向/ bankb1/ 映射/ ,/ b1/ 分配/ 完后/ ,/ 再/ 向/ b2/ 映射/ ,/ b2/ 分配/ 完后/ ,/ 向/ b3/ 映射/ ,/ 依次/ 类推/ ,/ c/ _/ b/ _/ mapping/ [/ Ncore/ ]/ [/ Nbank/ ]/ 存放/ 当前/ 核到/ bank/ 的/ 映射/ 关系/ ./ 第/ 26/ 行/ 计算/ 所有/ 的/ Zk/ ,/ 第/ 27/ 行/ 判断/ 该/ 映射/ 是否/ 存在/ bank/ 访问/ 冲突/ ./ 若/ 存在/ bank/ 访问/ 冲突/ ,/ 第/ 32/ 行/ 调用/ 算法/ 1/ 计算/ 发生/ 在/ 每个/ bank/ 上/ 的/ bank/ 冲突/ 延迟/ ./ 第/ 36/ 行/ 计算/ 总/ 的/ bank/ 冲突/ 延迟/ ./ 第/ 38/ 、/ 39/ 行/ 更新/ 最优/ 结果/ ./ 第/ 43/ ~/ 48/ 行/ 回溯/ 搜索/ 解/ 空间/ ./ 第/ 50/ ~/ 54/ 行是/ 主/ 过程/ ,/ 在/ 第/ 50/ 行/ 根据/ 定理/ 2/ 、/ 3/ 进行/ 判定/ ,/ 若/ bank/ 冲突/ 不能/ 消除/ ,/ 则/ 在/ 第/ 52/ 行/ 调用/ F/ _/ M/ _/ Mapping/ (/ n/ )/ 求解/ ./ 算法/ 2/ ./ 优化/ 核到/ bank/ 的/ 映射/ 关系/ ,/ 使/ bank/ 冲突/ 延迟/ 最小/ ./ 输入/ :/ C/ ,/ Ncore/ ,/ LM/ ,/ LB/ ,/ B/ ,/ Nbank/ ,/ Ncolumn/ ,/ RQc/ 输出/ :/ 最小/ 的/ bank/ 冲突/ 延迟/ (/ M/ _/ delay/ )/ 、/ 相应/ 的/ 核到/ 1/ ./ 设置/ Zk/ 、/ M/ _/ delay/ 初值/ 、/ used/ [/ ]/ 为/ False/ ;/ 2/ ./ FUNCTIONF/ _/ M/ _/ Mapping/ (/ n/ )/ 3/ ./ IF/ (/ n/ >/ Ncore/ )/ THEN4/ ./ n/ _/ bank/ =/ 1/ ,/ n/ _/ col/ =/ Ncolumn/ ;/ 5/ ./ WHILE/ (/ i/ </ =/ Ncore/ )/ DO6/ ./ 7/ ./ IF/ (/ n/ _/ core/ >/ =/ n/ _/ col/ )/ THEN8/ ./ 9.10/ ./ 11.12/ ./ 13/ ./ ENDWHILE14/ ./ IF/ (/ n/ _/ core/ =/ =/ 0/ )/ THENi/ ++/ ;/ 15/ ./ ELSE16/ ./ 17.18/ ./ Page819/ ./ 20/ ./ ELSE21/ ./ c/ _/ b/ _/ mapping/ [/ j/ ]/ [/ n/ _/ bank/ ]/ =/ n/ _/ core/ ;/ 22/ ./ n/ _/ col/ =/ n/ _/ col/ -/ n/ _/ core/ ;/ 23/ ./ i/ ++/ ;/ 24/ ./ ENDIF25/ ./ ENDWHILE26/ ./ 计算/ Zk/ ,/ 1/ / k/ / Nbank/ ;/ 27/ ./ IF/ (/ 所有/ 的/ Zk/ 都/ 为/ 0/ )/ THEN28/ ./ M/ _/ delay/ =/ 0/ ;/ 29/ ./ ELSE30/ ./ FOR/ (/ k/ =/ 1/ ;/ k/ </ =/ Nbank/ ;/ k/ ++/ )/ DO31/ ./ IF/ (/ Zk/ >/ 0/ )/ THEN32/ ./ 33/ ./ ENDIF34/ ./ ENDFOR35/ ./ ENDIF36/ ./ b/ _/ delay/ =/ ∑/ 37/ ./ IF/ (/ b/ _/ delay/ </ M/ _/ delay/ )/ THEN38/ ./ M/ _/ delay/ =/ b/ _/ delay/ ;/ 39/ ./ M/ _/ mapping/ [/ ]/ [/ ]/ =/ c/ _/ b/ _/ mapping/ [/ ]/ [/ ]/ ;/ 40/ ./ ENDIF41/ ./ RETURN42/ ./ ENDIF43/ ./ FOR/ (/ i/ =/ 1/ ;/ i/ </ =/ Ncore/ ;/ i/ ++/ )/ DO44/ ./ IF/ (/ !/ used/ [/ i/ ]/ )/ THEN45/ ./ c/ _/ seq/ [/ n/ ]/ =/ ci/ ;/ used/ [/ i/ ]/ =/ True/ ;/ 46/ ./ F/ _/ M/ _/ Mapping/ (/ n/ +/ 1/ )/ ;/ used/ [/ i/ ]/ =/ False/ ;/ 47/ ./ ENDIF48/ ./ ENDFOR49/ ./ ENDFUNCTION50/ ./ 利用/ 定理/ 2/ 、/ 3/ 判断/ bank/ 冲突/ 是否/ 可以/ 消除/ ;/ 51/ ./ IF/ (/ bank/ 冲突/ 不能/ 消除/ )/ THEN52/ ./ F/ _/ M/ _/ Mapping/ (/ 1/ )/ ;/ 53/ ./ ENDIF54/ ./ RETURNM/ _/ delay/ ,/ M/ _/ mapping/ ;/ 6WCET/ 估算/ 6.1/ WCET/ 估算/ 的/ 预备/ 知识/ Theiling/ 等/ 人/ [/ 23/ ]/ 提出/ 的/ 共享/ 缓存/ 的/ 抽象/ 解释/ (/ abstractinterpretation/ )/ 分析法/ ,/ 是/ 将/ 指令/ 根据/ 访问共享/ 缓存/ 是否/ 命中/ 分成/ :/ Always/ -/ Hit/ (/ AH/ )/ 、/ Always/ -/ Miss/ (/ AM/ )/ 、/ PerSistence/ (/ PS/ )/ 和/ Not/ -/ Classified/ (/ NC/ )/ 四类/ ./ AH/ 是/ 指/ 访问共享/ 缓存/ 总是/ 命中/ 的/ ,/ AM/ 是/ 指/ 访问共享/ 缓存/ 总是/ 缺失/ 的/ ,/ PS/ 是/ 指/ 第/ 1/ 次/ 访问共享/ 缓存/ 是/ 缺失/ 而/ 以后/ 的/ 访问/ 都/ 是/ 命中/ 的/ ,/ 而/ 其他/ 情形/ 则/ 属于/ NC/ 类/ ./ 一个/ 五级/ 流水线/ 模型/ [/ 24/ ]/ 由取/ 指/ (/ IF/ )/ 、/ 译码/ (/ ID/ )/ 、/ 执行/ (/ EX/ )/ 、/ 写回/ (/ WB/ )/ 和/ 提交/ (/ CM/ )/ 组成/ ./ 在/ 取指/ 阶段/ 中/ ,/ 按/ 指令/ 在/ 程序/ 中/ 的/ 顺序/ 将/ 指令/ 从/ 存储系统/ 中/ 依次/ 取出/ ,/ 存放/ 到/ 取指/ 缓存/ (/ I/ -/ buffer/ )/ ;/ 在/ 译码/ 阶段/ 中/ ,/ 将/ 取指/ 缓存/ 中/ 的/ 指令/ 进行/ 译码/ 操作/ 并/ 按/ 在/ 程序/ 中/ 的/ 顺序/ 发送到/ ROB/ (/ Re/ -/ OrderBuffer/ )/ ./ 在/ 执行/ 阶段/ ,/ ROB/ 中/ 的/ 指令/ 发送到/ 相应/ 的/ 执行/ 单元/ 进行/ 执行/ ./ 对于/ Load/ 指令/ ,/ 执行/ 阶段/ 只/ 计算/ 有效/ 存储/ 地址/ ,/ 在/ 写/ 回/ 阶段/ 取/ 操作数/ ./ 在/ 写/ 回/ 阶段/ ,/ 一方面/ Load/ 指令/ 从/ 存储系统/ 中取/ 操作数/ ,/ 另一方面/ 将/ 执行/ 阶段/ 的/ 执行/ 结果/ 写回/ ROB/ ./ 在/ 提交/ 阶段/ ,/ 指令/ 按照/ 在/ 程序/ 中/ 的/ 顺序/ 提交/ ./ Li/ 等/ 人/ [/ 25/ ]/ 提出/ 了/ 执行/ 图/ (/ ExecutionGraph/ )/ 的/ 概念/ ,/ 该/ 执行/ 图/ 描述/ 了/ 控制流/ 图/ (/ CFG/ )/ 的/ 一个/ 基本块/ (/ basicblock/ )/ 在/ 五级/ 流水线/ 模型/ 上/ 执行/ 状态/ ./ 本文/ 设计/ 的/ 多/ 核/ 多任务/ WCET/ 估算/ 方法/ 是/ 在/ Chronos/ 的/ 基础/ 上/ ,/ 增加/ 了/ 对/ 多/ 核/ 共享资源/ 冲突/ 延迟/ 语义/ 的/ 分析/ 支持/ ./ Chronos/ 是/ 单核/ 硬/ 实时/ 任务/ 的/ 开源/ WCET/ 估算/ 工具/ ,/ 该/ 工具/ 可/ 对/ 二进制/ 执行/ 文件/ 进行/ 反汇编/ ,/ 以/ 形成/ 控制流/ 图及/ 执行/ 图/ ,/ 并/ 利用/ 该图/ 对/ 指令/ 在/ 流水线/ 阶段/ 间/ 的/ 依赖/ 关系/ 进行/ 分析/ 处理/ ,/ 以及/ 估算/ 基本块/ 的/ 最差/ 情况/ 下/ 执行/ 时间/ ./ 一般/ 地/ ,/ 利用/ Chronos/ 可/ 获得/ 如下/ 内容/ :/ (/ 1/ )/ 基本块/ 的/ 最差/ 情况/ 下/ 执行/ 时间/ ;/ (/ 2/ )/ 任务/ 的/ 控制流/ 图/ ;/ (/ 3/ )/ 基本块/ 中/ 每个/ 请求/ 的/ 总线/ 请求/ 时间/ ;/ (/ 4/ )/ 指令/ 的/ AH/ 、/ AM/ 、/ PS/ 和/ NC/ 分类/ 等/ ./ 6.2/ WCET/ 估算/ 方法/ 设/ ci/ (/ ∈/ C/ )/ 的/ 执行/ 时间/ 是/ 指/ 运行/ 在/ ci/ 上/ 某/ 硬实/ 是/ ci/ 遭受/ 的/ 所有/ 总线/ 访问/ 延迟/ ,/ Dbank/ 时/ 任务/ 的/ 执行/ 时间/ ./ 设/ Tp/ 间/ ,/ Tmci/ 缓存/ 所/ 需要/ 的/ 时间/ ,/ nqciDbusci/ 所有/ bank/ 冲突/ 延迟/ ,/ ci/ 在/ 最差/ 情况/ 下/ 的/ 执行/ 时间/ 可以/ 表示/ 为/ WCETci/ =/ TpDbusci/ +/ Dbank/ 以/ 直接/ 用/ 单核/ WCET/ 估算/ 工具/ 估算/ ,/ Dbank/ 法/ 1/ 计算/ 得到/ ./ 令/ WCETci/ =/ TpLlat/ +/ Dbus/ 由于/ 多核/ 多任务/ 在/ 流水线/ 、/ 请求/ 访问/ 总线/ 和/ 请/ Page9/ 求/ 访问/ 存储系统/ 中/ 可以/ 并发/ 执行/ ,/ 那么/ 某个/ 任务/ 在/ 流水线/ 上/ 的/ 执行/ 时间/ 、/ 总线/ 访问/ 延迟/ 和/ 存储系统/ 访问/ 时间/ 之间/ 可能/ 存在/ 着/ 时间重叠/ 问题/ ./ 另外/ ,/ 由于/ 核/ 与/ TDMA/ 总线/ 时槽/ 之间/ 已/ 确立/ 对应/ 关系/ ,/ 在/ 计算/ 多核/ 总线/ 访问/ 延迟/ 时/ ,/ 总线/ 访问/ 冲突/ 延迟/ 可/ 转换/ 为/ 请求/ 等待/ 自己/ 对应/ 的/ 总线/ 时槽/ ./ 为此/ ,/ 我们/ 在/ Chronos/ 基本块/ 最差/ 执行/ 时间/ 分析/ 模块/ 的/ 基础/ 上/ ,/ 增加/ 了/ 对/ 多/ 核/ 总线/ 访问/ 延迟/ 、/ 时间/ 消重/ 等/ 语义/ 的/ 支持/ ,/ 实现/ 了/ 下面/ 的/ 算法/ 3/ ./ 算法/ 3/ 给出/ 了/ 估算/ 一个/ 基本块/ (/ 记为/ blk/ )/ 最差/ 情况/ 下/ 执行/ 时间/ 的/ 方法/ ,/ 该/ 算法/ 是/ 在/ Chronos/ 分析/ 工具/ 中/ 实现/ 的/ ./ 由于/ PS/ 指令/ 在/ 第/ 1/ 次/ 执行/ 中是/ 缺失/ 的/ 且/ 在/ 后续/ 执行/ 中/ 总是/ 命中/ 的/ ,/ 若/ 一个/ 基本块/ 在/ 循环/ 结构/ 中/ ,/ 它/ 的/ 第/ 1/ 次/ 执行/ 和/ 后续/ 执行/ 的/ 最差/ 情况/ 下/ 执行/ 时间/ 是/ 不同/ 的/ ./ 在/ 算法/ 3/ 中/ ,/ 用/ first/ 标识/ 基本块/ 是否/ 为/ 第/ 1/ 次/ 执行/ ,/ first/ =/ 0/ 表示/ 该/ 基本块/ 的/ 第/ 1/ 次/ 执行/ ,/ first/ =/ 1/ 表示/ 该/ 基本块/ 的/ 非/ 第/ 1/ 次/ 执行/ ./ 令/ offset/ 为/ 基本块/ 开始/ 执行/ 时/ 对应/ 的/ 总线/ 偏移量/ ,/ 若/ 基本块/ 的/ 开始/ 时间/ 为/ tb/ ,/ 对应/ 的/ 总线/ 偏移量/ 可以/ 表示/ 为/ offset/ =/ tbmod/ (/ Lround/ ·/ LB/ )/ ,/ 且/ 0/ / offset/ </ Lround/ ·/ LB/ ,/ 对于/ 不同/ 的/ offset/ 值/ ,/ 基本块/ 有/ 一个/ 最差/ 情况/ 下/ 执行/ 时间/ 与/ 之/ 对应/ ,/ 存放/ 在/ MET/ [/ first/ ]/ [/ blk/ ]/ [/ offset/ ]/ 中/ ./ Tstage/ (/ i/ )/ (/ sta/ )/ 和/ Tstage/ (/ i/ )/ (/ fin/ )/ 分别/ 是/ 指令/ i/ 在/ stage/ 阶段/ 的/ 开始/ 时间/ 和/ 完成/ 时间/ ,/ 若/ 指令/ i/ 在/ stage/ 阶段/ 需要/ 访存/ ,/ 则/ Tstage/ (/ i/ )/ (/ sta/ )/ 为/ 请求/ 申请/ 总线/ 的/ 时间/ ./ Tn/ (/ fin/ )/ 是/ 基本块/ 最后/ 一条/ 指令/ 的/ 完成/ 时间/ ,/ T1/ (/ ready/ )/ 是/ 基本块/ 的/ 第一条/ 指令/ 的/ 准备/ 时间/ ./ 第/ 1/ ~/ 10/ 行/ 定义/ 计算/ 总线/ 访问/ 延迟/ 的/ 函数/ Com/ _/ bdelay/ (/ )/ ,/ pre/ 是/ 前/ 一个/ 请求/ 访问/ 总线/ 的/ 时间/ ,/ 其值/ 为/ 对应/ 流水/ 阶段/ 的/ 开始/ 时间/ 与/ 总线/ 访问/ 延迟/ 的/ 和/ ./ 在/ 第/ 2/ ~/ 8/ 行/ 计算/ 总线/ 访问/ 延迟/ ,/ 若/ 当前/ 请求/ 申请/ 总线/ 的/ 时间/ 小于/ 或/ 等于/ 前/ 一个/ 请求/ 访问/ 总线/ 的/ 时间/ ,/ 则/ 消重/ ,/ 总线/ 访问/ 延迟/ 为/ (/ Lround/ ·/ LB/ )/ 个/ 时钟/ 周期/ (/ 第/ 3/ 行/ )/ ./ 否则/ ,/ 在/ 第/ 6/ 、/ 7/ 行/ 计算/ 总线/ 访问/ 延迟/ ./ 第/ 13/ 行先/ 利用/ Chronos/ 流水线/ 分析/ 对/ 基本块/ blk/ 进行/ 分析/ (/ 包括/ L1/ 缓存/ 分析/ )/ ,/ 可/ 得到/ 指令/ 在/ 各个/ 流水线/ 阶段/ 上/ 的/ 执行/ 时间/ 及/ 依赖/ 关系/ ,/ 但/ 此时/ 并未/ 涉及/ 总线/ 访问/ 延迟/ 的/ 影响/ ./ 对于/ 基本块/ 中/ 的/ 每条/ 指令/ 及/ 每个/ 流水线/ 阶段/ ,/ 第/ 19/ ~/ 25/ 行/ 和/ 第/ 27/ ~/ 33/ 行/ 分别/ 处理/ first/ 取/ 不同/ 值/ 的/ 情况/ ,/ 第/ 20/ 和/ 28/ 行/ 分别/ 调用函数/ Com/ _/ bdelay/ (/ )/ 计算/ 总线/ 访问/ 延迟/ ./ 在/ 第/ 22/ 、/ 24/ 、/ 30/ 和/ 32/ 行/ 分别/ 更新/ 相应/ 流水线/ 阶段/ 的/ 完成/ 时间/ ./ 使用/ Chronos/ 的/ 原有/ 处理/ 依赖/ 关系/ 的/ 方法/ ,/ 第/ 36/ 行/ 更新/ 指令/ i/ 在/ 后续/ 流水线/ 阶段/ 上/ 的/ 依赖/ 关系/ ,/ 第/ 38/ 行/ 更新/ 指令/ i/ 的/ 后续/ 指令/ 的/ 依赖/ 关系/ ./ 第/ 40/ 行/ 计算/ 该/ 基本块/ 的/ 最差/ 情况/ 下/ 执行/ 时间/ ./ 算法/ 3/ ./ 多核/ 环境/ 下/ 某/ 任务/ 基本块/ 最差/ 情况/ 下/ 的/ 执行/ 时间/ 分析/ ./ 输入/ :/ 基本块/ blk/ 的/ 执行/ 图/ ,/ Lround/ ,/ 对应/ 的/ 总线/ 时槽/ sj/ 输出/ :/ 基本块/ blk/ 最差/ 情况/ 下/ 执行/ 时间/ MET/ [/ first/ ]/ 1/ ./ FUNCTIONCom/ _/ bdelay/ (/ start/ ,/ offset/ ,/ pre/ )/ ;/ 2/ ./ IF/ (/ start/ </ =/ pre/ )/ THEN3/ ./ busdelay/ =/ Lround/ / LB/ ;/ 4/ ./ ELSE5/ ./ cur/ =/ start/ +/ offset/ ;/ 6/ ./ busdelay/ =/ (/ sj/ -/ 1/ )/ / LB/ -/ curmod/ (/ Lround/ / LB/ )/ ;/ 7/ ./ busdelay/ =/ (/ Lround/ / LB/ +/ busdelay/ )/ mod/ (/ Lround/ / LB/ )/ ;/ 8/ ./ ENDIF9/ ./ RETURNbusdelay/ ;/ 10/ ./ ENDFUNCTION/ // // 以下/ 为主/ 过程/ 11/ ./ FOR/ (/ first/ =/ 0/ ;/ first/ </ =/ 1/ ;/ first/ ++/ )/ DO12/ ./ FOR/ (/ offset/ =/ 0/ ;/ offset/ </ (/ Lround/ / LB/ )/ ;/ offset/ ++/ )/ 13/ ./ pipeline/ _/ analysis/ (/ )/ ;/ 14/ ./ pre/ =/ 0/ ;/ 15/ ./ FOR/ (/ 依次/ 取/ blk/ 中/ 的/ 每条/ 指令/ i/ )/ DO16/ ./ FOR/ (/ stage/ =/ 0/ ;/ stage/ </ pipe/ _/ stages/ ;/ stage/ ++/ )/ 17/ ./ IF/ (/ i/ 在/ stage/ 阶段/ 访问/ 存储系统/ )/ THEN18/ ./ 19.20/ ./ 21.22/ ./ 23.24/ ./ 25.26/ ./ 27.28/ ./ 29.30/ ./ 31.32/ ./ 33.34/ ./ 35/ ./ ENDIF36/ ./ 37/ ./ ENDFORPage1038/ ./ 更新/ 后续/ 指令/ 的/ 依赖/ 关系/ ;/ 39/ ./ ENDFOR40/ ./ MET/ [/ first/ ]/ [/ blk/ ]/ [/ offset/ ]/ =/ Tn/ (/ fin/ )/ -/ T1/ (/ ready/ )/ ;/ 41/ ./ ENDFOR42/ ./ ENDFOR43/ ./ RETURNMET/ [/ first/ ]/ [/ blk/ ]/ [/ ]/ ;/ 利用/ 算法/ 3/ 可以/ 估算/ 出/ 每个/ 基本块/ 在/ 不同/ 开始/ 时间/ 下/ 的/ 最差/ 情况/ 下/ 执行/ 时间/ (/ 同时/ 考虑/ 到/ 基本块/ 是否/ 在/ 循环/ 中且/ 是否/ 有/ PS/ 指令/ )/ ,/ 共有/ (/ 2/ ·/ Lround/ ·/ LB/ )/ 个值/ ./ 根据/ 基本块/ 在/ 控制流/ 图中/ 的/ 执行/ 次序/ 和/ 开始/ 时间/ (/ 设/ 第一个/ 执行/ 的/ 基本块/ 的/ 开始/ 时间/ 为/ 0/ )/ ,/ 从/ 每个/ 基本块/ 的/ (/ 2/ ·/ Lround/ ·/ LB/ )/ 个值/ 中/ 选择/ 一个/ 用来/ 估算/ 硬/ 实时/ 任务/ 的/ WCETci/ ./ 对于/ 一个/ 基本块/ blk/ ,/ 设/ Tblk/ (/ sta/ )/ 、/ offsetblk/ 和/ Tblk/ (/ fin/ )/ 分别/ 为/ 该/ 基本块/ 的/ 开始/ 时间/ 、/ 总线/ 偏移量/ 和/ 完成/ 时间/ ./ 开始/ 时间/ Tblk/ (/ sta/ )/ 是/ 其/ 直接/ 前驱/ 的/ 最迟/ 完成/ 时间/ ,/ 总线/ 偏移量/ offsetblk/ 可以/ 表示/ 为/ offsetblk/ =/ Tblk/ (/ sta/ )/ mod/ (/ Lround/ ·/ LB/ )/ ,/ 设/ pre/ 为/ 基本块/ blk/ 的/ 直接/ 前驱/ ,/ offsetpre/ 为/ 基本块/ pre/ 的/ 总线/ 偏移量/ ./ offsetblk/ 可以/ 表示/ 为式/ (/ 15/ )/ ,/ 完成/ 时间/ Tblk/ (/ fin/ )/ 可以/ 表示/ 为式/ (/ 16/ )/ ./ offsetblk/ =/ (/ offsetpre/ +/ MET/ [/ first/ ]/ [/ pre/ ]/ [/ offsetpre/ ]/ )/ ·/ Tblk/ (/ fin/ )/ =/ Tblk/ (/ sta/ )/ +/ MET/ [/ first/ ]/ [/ blk/ ]/ [/ offsetblk/ ]/ 若/ 控制流/ 图/ 存在/ 循环/ 结构/ ,/ 则/ 全部/ 展开/ ,/ 对于/ 事先/ 不能/ 确定/ 循环/ 次数/ 的/ 循环/ 结构/ ,/ 按照/ Chronos/ 处理/ 方法/ 将/ 循环/ 次数/ 的/ 最大/ 上限/ 作为/ 循环/ 次数/ 展开/ ./ 此时/ ,/ 整个/ 控制流/ 图仅/ 存在/ 分支/ 和/ 顺序/ 结构/ ,/ 且/ 一个/ 基本块/ 的/ 开始/ 时间/ 等于/ 其/ 直接/ 前驱/ 的/ 最大/ 完成/ 时间/ ./ 反复/ 使用/ 式/ (/ 15/ )/ 和/ (/ 16/ )/ 可以/ 计算/ 最后/ 一个/ 基本块/ 的/ 完成/ 时间/ ./ 以/ MlardalenWCETbenchmark/ [/ 26/ ]/ 测试程序/ 集中/ 的/ fibcall/ 测试程序/ 为例/ ,/ 说明/ 利用/ 算法/ 3/ 的/ 结果/ 估算/ WCET/ 的/ 方法/ ./ 图/ 4/ (/ a/ )/ 是/ fibcall/ 的/ 控制流/ 图/ ,/ 其中/ ,/ 圆形/ 代表/ 基本块/ ,/ 圆形/ 内/ 的/ 数字/ 为/ 基本块/ 的/ 编号/ ,/ 旁边/ 的/ 数字/ 为/ 该/ 基本块/ 的/ 执行/ 次数/ ,/ 有/ 向/ 边/ 代表/ 基本块/ 的/ 先后/ 次序/ ./ 将/ 循环展开/ 后/ 的/ 控制流/ 图如图/ 4/ (/ b/ )/ 所示/ ,/ 若/ 基本块/ 在/ 循环/ 中/ ,/ 标识/ 出该/ 基本块/ 是/ 第几次/ 执行/ ./ 设/ fibcall/ 在/ 该/ 例中/ 对应/ 的/ 总线/ 时槽/ 为/ si/ ,/ 开始/ 执行/ 时间/ 为/ Tst/ ./ 则/ 基本块/ 0/ 的/ 开始/ 时间/ T0/ (/ sta/ )/ =/ Tst/ ,/ 对应/ 的/ 总线/ 偏移量/ offset0/ =/ (/ (/ si/ -/ 1/ )/ ·/ LB/ +/ T0/ (/ sta/ )/ )/ ·/ mod/ (/ Lround/ ·/ LB/ )/ ,/ 利用/ 式/ (/ 16/ )/ 可以/ 得到/ 基本块/ 0/ 的/ 完成/ 时间/ T0/ (/ fin/ )/ =/ T0/ (/ sta/ )/ +/ MET/ [/ 0/ ]/ [/ 0/ ]/ [/ offset0/ ]/ ./ 基本块/ 2/ 的/ 开始/ 时间/ T2/ (/ sta/ )/ =/ T0/ (/ fin/ )/ ,/ 根据/ 式/ (/ 15/ )/ 和/ (/ 16/ )/ ,/ 可/ 得/ 基本块/ 2/ 的/ 总线/ 偏移量/ 和/ 完成/ 时间/ ,/ 即/ offset2/ =/ (/ offset0/ +/ MET/ [/ 0/ ]/ [/ 0/ ]/ [/ offset0/ ]/ )/ ·/ mod/ (/ Lround/ ·/ LB/ )/ ,/ T2/ (/ fin/ )/ =/ T2/ (/ sta/ )/ +/ MET/ [/ 0/ ]/ [/ 2/ ]/ [/ offset2/ ]/ ./ 接下来/ ,/ 可以/ 获得/ 基本块/ 3/ 第/ 1/ 次/ 执行/ 的/ 开始/ 时间/ (/ 记为/ T3/ (/ 1/ )/ (/ sta/ )/ )/ 、/ 总线/ 偏移量/ (/ 记为/ offset3/ (/ 1/ )/ )/ 和/ 完成/ 时间/ (/ 记为/ T3/ (/ 1/ )/ (/ fin/ )/ )/ ./ 处理/ 完/ 基本块/ 3/ 的/ 第/ 1/ 次/ 执行/ ,/ 进入/ 分支/ 结构/ 的/ 处理/ ,/ 反复/ 利用/ 式/ (/ 15/ )/ 和/ (/ 16/ )/ 可以/ 得到/ 基本块/ 4/ 第/ 29/ 次/ 执行/ 对应/ 的/ 总线/ 偏移量/ offset4/ (/ 29/ )/ 和/ 完成/ 时间/ T4/ (/ 29/ )/ (/ fin/ )/ ,/ T4/ (/ 29/ )/ (/ fin/ )/ =/ T4/ (/ 29/ )/ (/ sta/ )/ +/ MET/ [/ 1/ ]/ [/ 4/ ]/ [/ offset4/ (/ 29/ )/ ]/ ./ 基本块/ 5/ 的/ 开始/ 时间/ T5/ (/ sta/ )/ =/ max/ (/ T3/ (/ 1/ )/ (/ fin/ )/ ,/ T4/ (/ 29/ )/ (/ fin/ )/ )/ ,/ 总线/ 偏移量/ offset5/ =/ (/ offset3/ (/ 1/ )/ +/ T5/ (/ sta/ )/ -/ T3/ (/ 1/ )/ (/ sta/ )/ )/ ·/ mod/ (/ Lround/ ·/ LB/ )/ ,/ 最终/ 可以/ 得到/ 基本块/ 1/ 的/ 完成/ 时间/ T1/ (/ fin/ )/ =/ T1/ (/ sta/ )/ +/ MET/ [/ 0/ ]/ [/ 1/ ]/ [/ offset1/ ]/ ,/ 即/ 该例/ 的/ WCETci/ =/ T1/ (/ fin/ )/ ./ 算法/ 4/ 是/ 基于/ 算法/ 3/ 的/ 多/ 核/ 环境/ 下/ 硬/ 实时/ 任务/ 最差/ 情况/ 下/ 执行/ 时间/ 的/ 分析/ 算法/ ./ 第/ 1/ ~/ 21/ 行/ 定义/ 了/ 处理/ 分支/ 结构/ 的/ 函数/ Com/ _/ branch/ (/ )/ ,/ 输入/ 参数/ Pn/ 指向/ 分支/ 结构/ 的/ 开始/ 基本块/ ,/ Nbr/ _/ Pn/ 是/ 分支/ 结构/ 的/ 分支/ 数/ ,/ offset/ 是/ 分支/ 结构/ 开始/ 时/ 对应/ 的/ 总线/ 偏移量/ ,/ first/ 标识/ 该/ 基本块/ 是否是/ 第一次/ 执行/ ,/ blk/ 是/ 基本块/ 编号/ ,/ br/ _/ exe/ [/ i/ ]/ 是/ 分支/ i/ 的/ 总/ 执行/ 时间/ (/ 相对/ 于/ 分支/ 结构/ 的/ 开始/ 时间/ )/ ,/ 第/ 7/ 行/ 根据/ 式/ (/ 16/ )/ 计算/ 当前/ 基本块/ 的/ 完成/ 时间/ ,/ 第/ 8/ 、/ 9/ 行/ 根据/ 式/ (/ 15/ )/ 计算/ 总线/ 偏移量/ ,/ 第/ 10/ ~/ 15/ 行/ 处理/ 嵌套/ 分支/ 结构/ ,/ 第/ 10/ 行/ 判断/ 是否/ 有/ 分支/ 结构/ ,/ 若有/ ,/ 则/ 在/ 第/ 11/ 行/ 读取/ 分支/ 的/ 数目/ Nbr/ _/ Pb/ ,/ 在/ 第/ 12/ 行/ 调用/ Com/ _/ branch/ (/ )/ 处理/ 分支/ 结构/ ./ 第/ 19/ 行/ 获得/ 分支/ 结构/ 的/ 最大/ 完成/ 时间/ Page11/ (/ 相对/ 于/ 分支/ 结构/ 的/ 开始/ 时间/ )/ ./ 第/ 23/ 行/ 建立/ 链表/ TSLinkList/ ,/ 若/ 存在/ 分支/ 结构/ ,/ 则/ 在/ 链表/ 中/ 用/ 分支/ 结构/ 的/ 开始/ 基本块/ 对应/ 的/ 链表/ 结点/ 指向/ 分支/ 结构/ 的/ 结束/ 基本块/ 对应/ 的/ 链表/ 结点/ ,/ 分支/ 结构/ 的/ 分支/ 存放/ 在/ 分支/ 结构/ 的/ 开始/ 基本块/ 对应/ 的/ 链表/ 结点/ 中/ ./ 第/ 28/ 、/ 33/ 行/ 分别/ 计算/ 当前/ 基本块/ 的/ 完成/ 时间/ (/ 相对/ 于/ 任务/ 开始/ 时间/ )/ ./ 第/ 38/ 行/ 根据/ 式/ (/ 14/ )/ 计算/ 任务/ 的/ 最差/ 情况/ 下/ 执行/ 时间/ ./ 算法/ 4/ ./ 多核/ 环境/ 下/ 硬/ 实时/ 任务/ 最差/ 情况/ 下/ 执行/ 时间/ 的/ 分析/ ./ 输入/ :/ 循环/ 已/ 展开/ 的/ 控制流/ 图/ ,/ 每个/ 基本块/ 的/ 执行/ 图/ ,/ 输出/ :/ 硬/ 实时/ 任务/ 的/ 最差/ 情况/ 下/ 执行/ 时间/ MT/ _/ exe1/ ./ FUNCTIONCom/ _/ branch/ (/ Pn/ ,/ Nbr/ _/ Pn/ ,/ offset/ )/ DO2/ ./ FOR/ (/ i/ =/ 1/ ;/ i/ </ =/ Nbr/ _/ Pn/ ;/ i/ ++/ )/ DO3/ ./ boffset/ =/ offset/ ,/ br/ _/ exe/ [/ i/ ]/ =/ 0/ ;/ 4/ ./ Pb/ 指向/ Pn/ 的/ 第/ i/ 个/ 分支/ 的/ 第一个/ 基本块/ ;/ 5/ ./ WHILE/ (/ Pb/ 不为/ 空/ )/ DO6/ ./ 7/ ./ br/ _/ exe/ [/ i/ ]/ =/ br/ _/ exe/ [/ i/ ]/ +/ MET/ [/ first/ ]/ [/ blk/ ]/ 8/ ./ boffset/ =/ boffset/ +/ MET/ [/ first/ ]/ [/ blk/ ]/ [/ boffset/ ]/ ;/ 9/ ./ boffset/ =/ boffsetmod/ (/ Lround/ / LB/ )/ ;/ 10.11/ ./ 12.13/ ./ 14.15/ ./ 16.17/ ./ ENDWHILE18/ ./ ENDFOR19/ ./ Mb/ _/ exe/ =/ max/ (/ br/ _/ exe/ [/ i/ ]/ |/ 1/ / i/ / Nbr/ _/ Pn/ )/ ;/ 20/ ./ RETURNMb/ _/ exe/ ;/ 21/ ./ ENDFUNCTION/ // // 以下/ 为主/ 过程/ 22/ ./ 调用/ 算法/ 3/ 估算/ 每个/ 基本块/ 的/ 最差/ 情况/ 下/ 执行/ 时/ 23/ ./ 读取/ 控制流/ 图/ ,/ 建立/ 链表/ TSLinkList/ (/ 有头/ 结点/ )/ ;/ 24/ ./ offset/ =/ (/ sj/ -/ 1/ )/ / LB/ ,/ MT/ _/ exe/ =/ 0/ ;/ 25/ ./ Pn/ =/ TSLinkList/ -/ >/ next/ ;/ 26/ ./ WHILE/ (/ Pn/ 不为/ 空/ )/ DO27/ ./ 获得/ 由/ Pn/ 指向/ 的/ 基本块/ 标识/ blk/ 和/ 执行/ 信息/ first/ ;/ 28/ ./ MT/ _/ exe/ =/ MT/ _/ exe/ +/ MET/ [/ first/ ]/ [/ blk/ ]/ [/ offset/ ]/ ;/ 29/ ./ offset/ =/ (/ offset/ +/ MET/ [/ first/ ]/ [/ blk/ ]/ [/ offset/ ]/ )/ ·/ 30/ ./ IF/ (/ Pn/ 有/ 分支/ )/ THEN31/ ./ 获得/ Pn/ 指向/ 基本块/ 的/ 分支/ 数/ Nbr/ _/ Pn/ ;/ 32/ ./ tmp/ _/ exe/ =/ Com/ _/ branch/ (/ Pn/ ,/ Nbr/ _/ Pn/ ,/ offset/ )/ ;/ 33/ ./ MT/ _/ exe/ =/ MT/ _/ exe/ +/ tmp/ _/ exe/ ;/ 34/ ./ offset/ =/ (/ offset/ +/ tmp/ _/ exe/ )/ mod/ (/ Lround/ / LB/ )/ ;/ 35/ ./ ENDIF36/ ./ Pn/ =/ Pn/ -/ >/ next/ ;/ 37/ ./ ENDWHILE38/ ./ MT/ _/ exe/ =/ MT/ _/ exe/ +/ Dbank/ ;/ 39/ ./ RETURNMT/ _/ exe/ ;/ 7/ 实验/ 验证/ 使用/ MlardalenWCETbenchmark/ [/ 26/ ]/ 测试程序/ 集/ 分别/ 设计/ 无/ bank/ 访问/ 冲突/ 、/ 存在/ bank/ 访问/ 冲突/ 的/ 两个/ 实验/ 场景/ ,/ 来/ 验证/ 前面/ 提出/ 的/ 算法/ 的/ 正确性/ ./ 7.1/ 无/ bank/ 访问/ 冲突/ 的/ 应用/ 场景/ 7.1/ ./ 1/ 实验/ 环境/ 和/ 测试程序/ 由/ 6/ 个/ 同构/ 核/ {/ c1/ ,/ c2/ ,/ …/ ,/ c6/ }/ 组成/ 的/ 多/ 核/ 系统/ 中/ ,/ 每个/ 核有/ 一个/ 有序/ (/ in/ -/ order/ )/ 5/ 级/ 流水线/ ,/ 无/ 分支/ 预测/ 功能/ ,/ 取指/ 队列/ 大小/ 为/ 4/ ,/ 取指/ 宽度/ 为/ 2/ ,/ 指令/ 窗/ 大小/ 为/ 8/ ./ 每个/ 核有/ 私自/ L1/ 数据/ 和/ L1/ 指令/ 缓存/ ,/ 大小/ 均/ 为/ 64/ 字节/ ,/ 1/ 个/ bank/ ,/ 2/ 路/ 关联/ ,/ 每/ line/ 有/ 8/ 字节/ ,/ 1/ 个/ 时钟/ 周期/ 的/ 访问/ 时间/ ,/ 采用/ LRU/ 替换/ 策略/ ./ L2/ 缓存/ 为/ 所有/ 核/ 共享/ ,/ 大小/ 为/ 4KB/ ,/ 被/ 均匀/ 划分/ 成/ 4/ 个/ bank/ ,/ 每个/ bank/ 的/ 大小/ 为/ 1KB/ ,/ 4/ 路/ 关联/ ,/ 每/ line/ 有/ 32Bytes/ ,/ 4/ 个/ 时钟/ 周期/ 访问/ 时间/ (/ 即/ LM/ =/ 4/ )/ ,/ 采用/ LRU/ 替换/ 策略/ ./ 每个/ bank/ 又/ 被/ 均匀/ 划分/ 成/ 8/ 个/ column/ ./ 每个/ column/ 的/ 大小/ 为/ 128Bytes/ (/ 即/ 1/ 组/ 4/ 路/ 关联/ 的/ line/ )/ ./ 连接/ L2/ 缓存/ 和/ 核/ 的/ 总线/ 为/ TDMA/ 实时/ 总线/ ,/ 采用/ 简单/ 轮询/ 总线/ 调度/ 策略/ ,/ 总线/ 完成/ 一次/ 请求/ 所/ 需要/ 的/ 时间/ 为/ 2/ 个/ 时钟/ 周期/ ,/ 即/ LB/ =/ 2/ ./ 请求/ 访问/ 主存/ 需要/ 的/ 时间/ 为/ LL2penal/ =/ 30/ 个/ 时钟/ 周期/ ./ 使用/ 的/ 测试程序/ 是/ MlardalenWCETbench/ -/ mark/ 测试程序/ 集中/ 的/ 一部分/ ,/ 测试程序/ 的/ 特性/ 如表/ 2/ 所示/ ./ 为了/ 给/ 测试程序/ 分配/ 合适/ 的/ L2/ 缓存/ 大小/ ,/ 我们/ 使用/ Chronos/ 测量/ 这些/ 测试程序/ 在/ 分配/ 给/ 测试程序/ bsort100fibcallexpintinsertsortprimePage12/ 不同/ L2/ 缓存/ 大/ 小时/ 的/ WCET/ ,/ 测量/ 结果/ 和/ 采用/ 的/ L2/ 缓存/ 大小/ 如表/ 3/ 所示/ ./ 表/ 3/ 不同/ L2/ 缓存/ 大/ 小时/ 测量/ 的/ WCET/ (/ 时钟/ 周期/ )/ 和/ 缓存/ 大小/ bsort100cntexpintfibcallinsertsortprime128B688805035752169219701363575000256B688833050633168739701149975000512B10027500390401719197011451750001024B9263600291521719197011451750002048B2965080291521719197011451750004096B296508029152171919701145175000/ 采用/ 值/ 2048/ // 161024/ // 8256/ // 2128/ // 1512/ // 4128/ // 17.1/ ./ 2/ 实验/ 结果/ 实验/ 中/ 采用/ 的/ 任务/ 到/ 核/ 映射/ 和/ 核到/ 总线/ 时槽/ 映射/ 如表/ 4/ 所示/ ./ 用/ Chronos/ 得到/ 各/ 任务/ 访问/ L2/ 缓存/ 的/ 总线/ 请求/ 时间/ 序列/ 如图/ 5/ 所示/ ./ 使用/ 算法/ 2/ 做/ 核到/ bank/ 映射/ ,/ 若/ 可能/ 存在/ bank/ 访问/ 冲突/ ,/ 则/ 用/ 算法/ 1/ 计算/ bank/ 冲突/ 延迟/ ,/ 结果/ 如图/ 6/ 所示/ ,/ 解/ 空间/ 为/ 720/ ,/ 总/ 的/ bank/ 冲突/ 延迟/ 的/ 范围/ 为/ [/ 0/ ,/ 149560/ ]/ ,/ 其中/ 一个/ 不/ 存在/ bank/ 访问/ 冲突/ 的/ 映射/ 关系/ 如表/ 5/ 所示/ ./ 在/ 表/ 5/ 所示/ 的/ 核到/ bank/ 映射/ 关系/ 中/ ,/ 映射/ 到/ 任意/ 一个/ bank/ 上/ 的/ 任务/ 之间/ 的/ 模/ 距离/ 都/ 大于/ 等于/ 2/ ./ 由于/ LM/ // LB/ =/ 2/ ,/ 因此/ ,/ 在/ 该/ 映射/ 中/ 不/ 存在/ bank/ 访问/ 冲突/ ./ 测试程序/ insertsortbsort100fibcall/ 表/ 5/ 一个/ 没有/ bank/ 冲突/ 延迟/ 时核/ 到/ bank/ 映射/ 关系/ 测试程序/ insertsortixpintbsort100fibcallprime/ 为了/ 考察/ 优化/ 核到/ bank/ 映射/ 后/ 对/ WCET/ 的/ 影响/ ,/ 取表/ 6/ 所示/ 的/ 核到/ bank/ 映射/ 作为/ 未/ 优化/ 时/ 的/ 映射/ ,/ 在/ 该/ 映射/ 下/ 各/ 任务/ 遭受/ 的/ bank/ 冲突/ 延迟/ 如表/ 7/ 所示/ ./ 使用/ 算法/ 4/ (/ 调用/ 算法/ 3/ )/ 估算/ 了/ 在/ 两个/ 映射/ 下/ 各/ 任务/ 的/ WCET/ ,/ 结果/ 如图/ 7/ 所示/ ,/ 所有/ 测量/ 结果/ 都/ 是/ 相对/ 于/ 任务/ 在/ 单核/ 系统/ 中/ 测量/ 的/ 结果/ (/ 下同/ )/ ./ 在/ 图/ 7/ 中/ ,/ Opt/ 表示/ 优化/ 核到/ bank/ 映射/ 后/ 估算/ 的/ 结果/ ,/ no/ _/ Opt/ 表示/ 未/ 优化/ 核到/ bank/ 映射/ 时/ 估算/ 的/ 结果/ ./ 从图/ 7/ 中/ 可以/ 看出/ ,/ 相对/ 于/ 未/ 优化/ 时/ 的/ 估算/ 结果/ ,/ 优化/ 映射/ 后/ 对/ 所有/ 任务/ 的/ WCET/ 有/ 不同/ 程度/ 的/ 改善/ ,/ 平均/ 提高/ 了/ 约/ 15/ %/ ./ 对/ expint/ 的/ WCET/ 改善/ 程度/ 最大/ ,/ 提高/ 了/ 大约/ 50/ %/ ./ 虽然/ bsort100/ 遭受/ 的/ bank/ 冲突/ 延迟/ 为/ 43736/ 个/ 时钟/ 周期/ (/ 如表/ 7/ 所示/ )/ ,/ 但/ 由于/ 其/ 规模/ 较大/ ,/ 改善/ 效果/ 相对/ 不/ 明显/ (/ 提高/ 了/ 约/ 1/ %/ )/ ./ 另外/ ,/ 在/ 这/ 两个/ 映射/ 中/ ,/ insertsort/ 和/ fibcall/ 都/ 没/ 遭受/ 到/ bank/ 访问/ 延迟/ ,/ 估算/ 的/ WCET/ 未/ 发生变化/ ./ 测试程序/ insertsortexpintbsort100fibcallprime/ 表/ 7/ 在/ 表/ 6/ 所示/ 的/ 映射/ 中/ 各/ 任务/ 遭受/ 的/ bank/ 冲突/ 延迟/ insertsortAI/ +/ ILP/ (/ 抽象/ 解释/ 加/ 整数/ 线性规划/ )/ 方法/ 是/ 现有/ 文献/ 估算/ WCET/ 的/ 常用/ 方法/ ,/ 如/ Chattopadhyay/ 等/ 人/ [/ 13/ ]/ 、/ Kelter/ 等/ 人/ [/ 14/ -/ 15/ ]/ 等/ ./ AI/ +/ ILP/ 方法/ 的/ 共同/ Page13/ 图/ 7/ 优化/ 核到/ bank/ 映射/ 后/ 和/ 未/ 优化/ 时/ 的/ 估算/ 结果/ 对比/ 点/ 是/ 分别/ 估算/ 每个/ 基本块/ 在/ 流水线/ 上/ 的/ 执行/ 时间/ 、/ 访问共享/ L2/ 缓存/ 的/ 时间/ 、/ 访问/ 主存/ 的/ 时间/ 和/ 总线/ 访问/ 延迟/ ,/ 然后/ 用/ 线性规划/ 求解/ 工具/ 将/ 这些/ 时间/ 组合/ 起来/ 得到/ 任务/ 的/ WCET/ ,/ 这里/ ,/ 我们/ 将/ 这类/ 方法/ 统称/ 为/ “/ AI/ +/ ILP/ ”/ 方法/ ./ 分别/ 使用/ 算法/ 4/ 和/ AI/ +/ ILP/ 方法/ 估算/ 了/ 在/ 表/ 5/ 所示/ 的/ 映射/ 中/ 各/ 任务/ 的/ WCET/ 值/ (/ 没有/ bank/ 冲突/ )/ ,/ 结果/ 如图/ 8/ 所示/ ./ 其中/ ,/ Alg4/ 代表/ 使用/ 算法/ 4/ 对/ 总线/ 访问/ 延迟/ 进行/ 了/ 消重/ 的/ 估算/ 结果/ ,/ AI/ +/ ILP/ 代表/ 使用/ AI/ +/ ILP/ 未/ 对/ 总线/ 访问/ 延迟/ 进行/ 消重/ 的/ 估算/ 结果/ ./ 相对/ 于/ AI/ +/ ILP/ 方法/ 而言/ ,/ 算法/ 4/ 对/ 任务/ 的/ WCET/ 有/ 不同/ 程度/ 的/ 改善/ ,/ 平均/ 提高/ 了/ 约/ 30/ %/ ./ 影响/ 估算/ 结果/ 的/ 主要/ 因素/ 有/ 访问/ L2/ 缓存/ 的/ 次数/ 、/ 访问/ 密集度/ 和/ 指令/ 在/ 流水线/ 上/ 的/ 依赖/ 关系/ 等/ ./ insertsort/ 的/ 多数/ 访存/ 指令/ 都/ 集中/ 在/ 基本块/ 3/ 中/ (/ 使用/ Chronos/ 获得/ )/ ,/ 需要/ 进行/ 消重/ 的/ 计算/ 较/ 多/ ,/ 改善/ 程度/ 最大/ ,/ 提高/ 了/ 大约/ 50/ %/ ./ bsort100/ 访问/ L2/ 缓存/ 的/ 次数/ 为/ 394210/ 次/ (/ 如图/ 5/ 所示/ )/ ,/ 消重/ 效果/ 也/ 比较/ 明显/ (/ 约/ 45/ %/ )/ ./ 由于/ fibcall/ 的/ 访问/ 次数/ 很少/ ,/ 因此/ 改善/ 效果/ 不/ 明显/ ./ 虽然/ prime/ 的/ 访问/ 次数/ 也/ 较大/ (/ 9335/ 次/ )/ ,/ 但/ 受到/ 其/ 指令/ 间/ 依赖/ 关系/ 的/ 影响/ ,/ 抵消/ 了/ 对/ 总线/ 延迟/ 消重/ 后/ 的/ 效果/ ./ 图/ 8/ 算法/ 4/ 和/ AI/ +/ ILP/ 方法/ 估算/ 的/ 结果/ 对比/ 分别/ 使用/ 两种/ 方法/ 对/ 每个/ 任务/ 进行/ 20/ 次/ 估算/ ,/ 20/ 次/ 运行/ 时间/ 的/ 平均值/ 如表/ 8/ 所示/ ./ 由此/ 可以/ 看出/ ,/ 由于/ 算法/ 4/ 需要/ 调用/ 算法/ 3/ 并/ 参与/ 时间/ 消重/ 计算/ ,/ 因此/ 其/ 运行/ 时间/ 比/ AI/ +/ ILP/ 方法/ 有所提高/ ./ 测试程序/ insertsortexpintbsort100fibcallprime7/ ./ 2/ 存在/ bank/ 访问/ 冲突/ 的/ 应用/ 场景/ 为了/ 验证/ bank/ 访问/ 冲突/ 不能/ 消除/ 时/ 的/ 优化/ 效果/ ,/ 我们/ 设计/ 了/ 相应/ 的/ 应用/ 场景/ ./ 在/ 实验/ 环境/ 中/ ,/ L2/ 缓存/ 的/ 容量/ 大小/ 为/ 3KB/ ,/ 被/ 均匀/ 划分/ 成/ 3/ 个/ bank/ ,/ 每个/ bank/ 的/ 大小/ 为/ 1KB/ ./ 每个/ bank/ 又/ 被/ 均匀/ 划分/ 成/ 8/ 个/ column/ ,/ 每/ column/ 的/ 大小/ 为/ 128Bytes/ ./ 其他/ 参数/ 的/ 设置/ 值/ 采用/ 7.1/ ./ 1/ 节中/ 实验/ 环境/ 的/ 相应/ 参数值/ ./ 使用/ 了/ 表/ 2/ 中/ 的/ 5/ 个/ 测试程序/ ,/ 如表/ 9/ 所示/ ./ 7.2/ ./ 1/ 实验/ 结果/ 在/ 实验/ 中/ 采用/ 的/ 任务/ 到/ 核/ 映射/ 和/ 核到/ 总线/ 时槽/ 映射/ 如表/ 10/ 所示/ ./ 在/ 该/ 应用/ 场景/ 中/ ,/ 核/ c6/ 空闲/ ,/ 不/ 占用/ 总线/ 时间/ ,/ 即/ 每个/ 总线/ 调度/ 周期/ 的/ 长度/ 为/ 5/ ·/ LB/ =/ 10/ 个/ 时钟/ 周期/ ./ 各/ 任务/ 访问/ L2/ 缓存/ 的/ 总线/ 请求/ 时间/ 序列/ 如图/ 5/ 所示/ ./ 执行/ 算法/ 2/ 做/ 核到/ bank/ 映射/ ,/ 结果/ 如图/ 9/ 所示/ ,/ 解/ 空间/ 为/ 120/ ,/ 总/ 的/ bank/ 冲突/ 延迟/ 范围/ 为/ [/ 33704/ ,/ 110660/ ]/ ./ 具有/ 最小/ bank/ 冲突/ 延迟/ 的/ 核到/ bank/ 的/ 映射/ 如表/ 11/ 所示/ ,/ 在/ 该/ 映射/ 中/ ,/ 只/ 在/ bankb1/ 上/ 存在/ bank/ 访问/ 冲突/ ,/ 各个/ 任务/ 遭受/ 的/ bank/ 冲突/ 延迟/ 如表/ 12/ 所示/ ./ 表/ 10/ 使用/ 的/ 任务/ 到/ 核/ 的/ 映射/ 和/ 核到/ 总线/ 时槽/ 的/ 映射/ 测试程序/ insertsortbsort100Page14/ 表/ 11/ 一个/ bank/ 冲突/ 延迟/ 最小/ 的/ 核到/ bank/ 映射/ 测试程序/ insertsortbsort100fibcall/ 表/ 12/ 在/ 表/ 11/ 所示/ 的/ 映射/ 中/ 各/ 任务/ 遭受/ 的/ bank/ 冲突/ 延迟/ 取表/ 13/ 所示/ 的/ 核到/ bank/ 映射/ 作为/ 未/ 优化/ 时/ 的/ 映射/ ,/ 在/ 该/ 映射/ 下/ 各/ 任务/ 遭受/ 的/ bank/ 冲突/ 延迟/ 如表/ 14/ 所示/ ./ 使用/ 算法/ 4/ 估算/ 在/ 两个/ 映射/ 下/ 各/ 任务/ 的/ WCET/ ,/ 结果/ 如图/ 10/ 所示/ ./ 从图/ 10/ 中/ 可/ 看出/ ,/ 相对/ 于/ 未/ 优化/ 时/ 的/ 估算/ 结果/ ,/ 优化/ 映射/ 后/ 对/ 所有/ 任务/ 的/ WCET/ 有/ 不同/ 程度/ 的/ 改善/ ,/ 平均/ 提高/ 了/ 约/ 10/ %/ ./ 对/ insertsort/ 的/ WCET/ 改善/ 程度/ 最大/ ,/ 提高/ 了/ 大约/ 20/ %/ ./ 虽然/ bsort100/ 遭受/ 的/ bank/ 冲突/ 延迟/ 为/ 37840/ 个/ 时钟/ 周期/ (/ 如表/ 14/ 所示/ )/ ,/ 但/ 相对/ 效果/ 不/ 明显/ (/ 约/ 1/ %/ )/ ./ 测试程序/ insertsortbsort100fibcall/ 表/ 14/ 在/ 表/ 13/ 所示/ 的/ 映射/ 中/ 各/ 任务/ 遭受/ 的/ bank/ 冲突/ 延迟/ 图/ 10/ 优化/ 核到/ bank/ 映射/ 后/ 和/ 未/ 优化/ 时/ 的/ 估算/ 结果/ 对比/ 分别/ 使用/ 算法/ 4/ 和/ AI/ +/ ILP/ 方法/ 估算/ 在/ 表/ 11/ 所示/ 的/ 映射/ 中/ 各/ 任务/ 的/ WCET/ (/ 各/ 任务/ 遭受/ 的/ bank/ 冲突/ 延迟/ 如表/ 12/ 所示/ )/ ,/ 结果/ 如图/ 11/ 所示/ ./ 相对/ 于/ AI/ +/ ILP/ 方法/ 而言/ ,/ 算法/ 4/ 对/ 任务/ 的/ WCET/ 估算/ 结果/ 有/ 不同/ 程度/ 的/ 改善/ ,/ 平均/ 提高/ 了/ 约/ 25/ %/ ,/ 例如/ 对/ bsort100WCET/ 的/ 改善/ 程度/ 约/ 为/ 45/ %/ ,/ 对/ fibcallWCET/ 的/ 改善/ 程度/ 约/ 为/ 5/ %/ ,/ 对/ primeWCET/ 的/ 改善/ 程度/ 约/ 为/ 8/ %/ ./ 另外/ ,/ 在/ 该/ 场景/ 下/ ,/ 分别/ 使用/ 两种/ 方法/ 对/ 每个/ 任务/ 进行/ 20/ 次/ 估算/ ,/ 20/ 次/ 运行/ 时间/ 的/ 平均值/ 如表/ 15/ 所示/ ,/ 由此/ 可以/ 看出/ ,/ 由于/ 算法/ 4/ 需要/ 调用/ 算法/ 3/ 并/ 参与/ 时间/ 消重/ 计算/ ,/ 因此/ 其/ 运行/ 时间/ 比/ AI/ +/ ILP/ 方法/ 有所提高/ ./ 图/ 11/ 算法/ 4/ 和/ AI/ +/ ILP/ 方法/ 估算/ 的/ 结果/ 对比/ 测试程序/ insertsortexpintbsort100fibcall8/ 结论/ 本文/ 提出/ 了/ 通过/ 优化/ 核到/ bank/ 映射/ 来/ 最小化/ Page15/ 硬/ 实时/ 多核/ 系统/ 的/ bank/ 冲突/ 延迟/ 方法/ ,/ 旨在/ 通过/ 消除/ bank/ 访问/ 冲突/ 或/ 最小化/ bank/ 冲突/ 延迟/ 来/ 改善/ 多核/ 系统/ 中硬/ 实时/ 任务/ 的/ WCET/ ./ 通过/ 对/ 硬/ 实时/ 多核/ 系统/ 中/ bank/ 冲突/ 延迟/ 的/ 分析/ ,/ 我们/ 得出/ 了/ 硬/ 实时/ 任务/ 间/ 不/ 存在/ bank/ 访问/ 冲突/ 的/ 判断/ 条件/ ,/ 并用/ 优化/ 核到/ bank/ 映射/ 的/ 方法/ 来/ 消除/ bank/ 访问/ 冲突/ ./ 然而/ ,/ 并/ 不是/ 所有/ 的/ bank/ 访问/ 冲突/ 都/ 可以/ 消除/ ,/ 此时/ 需要/ 优化/ 核到/ bank/ 映射/ 来/ 最小化/ bank/ 冲突/ 延迟/ ./ 为此/ ,/ 我们/ 设计/ 了/ 求解/ 该/ 优化/ 问题/ 的/ 相应/ 算法/ ./ 另外/ ,/ 还/ 设计/ 了/ 能够/ 对/ 总线/ 访问/ 延迟/ 进行/ 消重/ 的/ WCET/ 估算/ 方法/ ./ 实验/ 结果表明/ ,/ 本文/ 提出/ 的/ 优化/ 方法/ 可以/ 消除/ 硬/ 实时/ 多核/ 系统/ 中/ 的/ bank/ 访问/ 冲突/ 或/ 使/ bank/ 冲突/ 延迟/ 最小化/ ./ 与/ 现有/ WCET/ 估算/ 方法/ 比较/ ,/ 本文/ 提出/ 的/ WCET/ 估算/ 方法/ 可以/ 获得/ 更/ 精确/ 的/ WCET/ 值/ ./ 

