Page1/ 修改/ 客户/ 操作系统/ 优化/ KVM/ 虚拟机/ 的/ I/ // O/ 性能/ 张/ 彬彬/ 1/ )/ 汪/ 小林/ 1/ )/ 杨亮/ 1/ )/ 赖荣凤/ 1/ )/ 王振林/ 2/ )/ 罗英伟/ 1/ )/ 李晓明/ 1/ )/ 1/ )/ (/ 北京大学/ 计算机/ 科学技术/ 系/ 北京/ 100871/ )/ 2/ )/ (/ 密西根/ 理工大学/ 计算机科学/ 系/ 霍顿/ 美国/ )/ 摘要/ 目前/ ,/ 运行/ 在/ 虚拟机/ 上/ 的/ 客户/ 操作系统/ (/ GuestOS/ )/ 是/ 面向/ 物理/ 机器/ 开发/ 的/ 普通/ 操作系统/ ,/ 其中/ 存在/ 不/ 适应/ 虚拟化/ 环境/ 的/ 因素/ ,/ 影响/ 虚拟机/ 的/ I/ // O/ 性能/ ./ 作者/ 通过/ 测试/ 发现/ 了/ 影响/ 虚拟机/ I/ // O/ 性能/ 的/ 一些/ 问题/ ,/ 针对/ 这些/ 问题/ 提出/ 了/ 优化/ 方法/ :/ 一方面/ ,/ 通过/ 合并/ 客户/ 操作系统/ 中/ 连续/ 的/ I/ // O/ 指令/ ,/ 降低/ 虚拟机/ 的/ 时钟/ 中断/ 频率/ ,/ 从而/ 降低/ 环境/ 切换/ 的/ 开销/ ;/ 另一方面/ ,/ 消除/ 客户/ 操作系统/ 中/ 的/ 冗余/ 操作/ ,/ 包括/ 在/ 虚拟化/ 环境/ 下/ 无效/ 的/ 函数/ 、/ 冗余/ 的/ I/ // O/ 调度/ 以及/ 虚拟/ 网卡/ 驱动/ 对/ NAPI/ 的/ 支持/ ,/ 使/ 虚拟机/ 只/ 执行/ 必要/ 的/ 操作/ ,/ 从而/ 提高/ 系统/ 的/ 性能/ ./ 关键词/ I/ // O/ 虚拟化/ ;/ KVM/ ;/ 性能/ 测试/ ;/ 优化/ 1/ 引言/ 虚拟机/ 的/ I/ // O/ 性能/ 至今/ 没有/ 得到/ 较/ 好/ 的/ 解决/ ./ KVM/ 虚拟机/ (/ Kernel/ -/ basedVirtualMachine/ )/ 使用/ Page2/ 问/ 物理/ 硬件/ ,/ 实现/ 对/ I/ // O/ 设备/ 的/ 虚拟化/ ./ 该/ 方法/ 依赖/ QEMU/ 对/ 设备/ 的/ 模拟/ ,/ 因此/ 实现/ 简洁/ ,/ 但是/ 由于/ I/ // O/ 处理/ 流程/ 中/ 涉及/ 多个/ 环境/ ,/ 切换/ 较/ 多/ ,/ 其/ I/ // O/ 性能/ 很/ 不/ 理想/ ./ 虽然/ KVM/ 较/ 新/ 的/ 版本/ 中/ 已经/ 将/ 一些/ 关键设备/ 的/ 虚拟化/ 进行/ 了/ 优化/ ,/ 但是/ 主要/ 的/ 设备/ ,/ 例如/ 磁盘/ 和/ 网卡/ 虚拟化/ 的/ 性能/ 开销/ 仍旧/ 较大/ ./ 我们/ 主要/ 从/ 客户/ 操作系统/ 的/ 角度/ 来/ 发现/ 问题/ ./ 我们/ 测试/ 了/ KVM/ 虚拟机/ 磁盘/ 和/ 网卡/ 的/ 虚拟化/ 性能/ ,/ 测试/ 结果表明/ :/ 由于/ 目前/ 运行/ 在/ 虚拟机/ 上/ 的/ 客户/ 操作系统/ 是/ 面向/ 物理/ 机器/ 开发/ 的/ 普通/ 操作系统/ ,/ 其中/ 存在/ 不/ 适应/ 虚拟化/ 环境/ 的/ 因素/ ,/ 影响/ 虚拟机/ 的/ I/ // O/ 性能/ ./ 根据/ 测试/ 结果/ ,/ 我们/ 设计/ 了/ 一组/ 优化/ 方案/ ,/ 通过/ 修改/ 客户/ 操作系统/ 源码/ 及其/ 配置/ ,/ 达到/ 优化/ KVM/ 虚拟机/ 的/ 磁盘/ 和/ 网络/ I/ // O/ 性能/ 的/ 目标/ ./ 2KVM/ 虚拟化/ 性能/ 测试/ 比较/ KVM/ 虚拟机/ 系统/ 和/ 非/ 虚拟化/ 系统/ (/ Native/ )/ 的/ I/ // O/ 性能/ ,/ 了解/ KVM/ 虚拟机/ I/ // O/ 设备/ 虚拟化/ 开销/ ,/ 并/ 分析/ 其/ 性能/ 特征/ ,/ 其/ 主要/ 方法/ 是/ 分别/ 在/ 客户/ 操作系统/ 和/ 宿主/ 操作系统/ 上/ 运行/ 磁盘/ 和/ 网络/ I/ // O/ 的/ 基准/ 测试程序/ (/ benchmark/ )/ ./ 为了/ 进一步/ 了解/ 性能/ 开销/ 可能/ 的/ 分布/ ,/ 我们/ 修改/ KVM/ ,/ 在/ 基准/ 测试/ 程序运行/ 时/ ,/ 获得/ 指令/ 级/ 的/ 客户/ 操作系统/ 的/ 行为/ 细节/ ./ 2.1/ 磁盘/ 测试/ 测试环境/ :/ IntelCore2QuadQ9550/ (/ 2.83/ GHz/ )/ ,/ 4GB/ 内存/ ,/ SATA/ 硬盘/ (/ 转速/ 7200/ )/ ,/ 系统/ 版本/ :/ KVM/ -/ 76/ (/ 默认/ 配置/ )/ ,/ Linux2/ ./ 6.27/ ./ 7/ ./ 测试/ 内容/ :/ 在/ 虚拟机/ 上/ 运行/ bonnie/ ++/ ①/ ,/ bonnie/ ++/ 使用/ 文件系统/ 调用/ ,/ 分别/ 测试/ 按块/ 读/ // 写/ 的/ 吞吐/ 率/ 和/ CPU/ 利用率/ ,/ 并/ 与/ Native/ 环境/ 下/ 的/ 测试/ 结果/ 进行/ 对比/ ./ 按块/ 写/ 磁盘/ 的/ 性能/ 测试/ 结果/ 如图/ 1/ 所示/ ./ 从图/ 1/ 中/ 可/ 看出/ ,/ 虚拟机/ 按块/ 顺序/ 写/ 磁盘/ 的/ 吞吐/ 率/ 和/ CPU/ 利用率/ 都/ 只有/ Native/ 的/ 一半左右/ ,/ 存在/ 较大/ 的/ 优化/ 空间/ ./ 按块/ 读/ 磁盘/ 的/ 测试/ 结果/ 如图/ 2/ 所示/ ./ 读/ 磁盘/ 时/ ,/ 如果/ 缓存/ 命中/ ,/ 就/ 不用/ 发生/ 实际/ 的/ 读盘/ 操作/ ,/ 则/ 虚拟机/ 可以/ 不必/ 陷入/ VMM/ 进行/ 处理/ ,/ 可以/ 接近/ Native/ 的/ 性能/ ,/ 而/ 其/ 虚拟化/ 开销/ 主要/ 表现/ 于/ CPU/ 的/ 开销/ ./ 因此/ ,/ 图/ 2/ 中/ ,/ 虚拟机/ 按块/ 顺序/ 读/ 磁盘/ 的/ 吞吐/ 率/ 与/ Native/ 相当/ ,/ 而/ CPU/ 占用率/ 则/ 比/ Native/ 高/ 很多/ ./ 因此/ ,/ 在/ 磁盘/ I/ // O/ 方面/ ,/ 一是/ 需要/ 提高/ 写/ 磁盘/ 的/ 性能/ ,/ 二是/ 需要/ 降低/ 读/ 磁盘/ 时/ CPU/ 的/ 利用率/ ./ 而/ 性能/ 降低/ 的/ 具体/ 原因/ ,/ 包括/ 较/ 高/ 的/ 虚拟机/ 陷入/ 频率/ 、/ QEMU/ 模拟/ 性能/ 较/ 低等/ ./ 2.2/ 网络/ 测试/ 测试环境/ :/ 物理/ 机器/ HostA/ 和/ HostB/ ,/ 分别/ 使用/ Intel/ 的/ 千兆/ 网卡/ 82566DC/ 和/ 82567LM/ -/ 2/ ,/ 以/ 千兆/ 网/ 互联/ ./ 在/ HostB/ 上用/ KVM/ 运行/ 一个/ 虚拟机/ GuestB/ ./ 实验/ 1/ ./ 用/ ping/ 测试/ 虚拟化/ 带来/ 的/ 网络/ 数据包/ 传输/ 延迟/ ./ 测试/ 内容/ :/ (/ 1/ )/ 物理/ 主机/ HostAping/ 物理/ 主机/ HostB/ ;/ (/ 2/ )/ 物理/ 机/ HostBping/ 虚拟机/ GuestB/ ;/ (/ 3/ )/ 物理/ 机/ HostAping/ 虚拟机/ GuestB/ ,/ 分别/ 测试/ 之间/ 的/ 往返/ 时延/ (/ RTT/ )/ ,/ 测试/ 结果/ 如图/ 3/ 所示/ ./ ①/ bonnie/ ++./ [/ Online/ ]/ http/ :/ // // www/ ./ coker/ ./ com/ ./ au/ // bonnie/ ++/ // Page3/ 从/ 测试/ 结果/ 可以/ 大致/ 估计/ 虚拟化/ 带来/ 的/ 额外/ 开销/ :/ 数据包/ 从/ GuestB/ 传输/ 到/ HostA/ 的/ 时间/ 开销/ ,/ 相当于/ 数据包/ 从/ GuestB/ 传输/ 到/ HostB/ 的/ 时间/ 加上/ 数据包/ 从/ HostB/ 到/ HostA/ 的/ 传输/ 时间/ ./ 也就是说/ ,/ 虚拟化/ 的/ 开销/ 大致/ 是/ GuestB/ 到/ HostB/ 的/ 传输/ 时间/ ,/ 从/ 测试数据/ 上/ 看/ ,/ 这部分/ 的/ 时间/ 开销/ 约/ 为/ 33/ %/ ./ 实验/ 2/ ./ Netperf/ 测试/ ./ Netperf/ ①/ 是/ 用来/ 测试/ 网络/ 吞吐/ 率/ 的/ 开源/ 基准/ 测试程序/ ./ 主要/ 是/ 通过/ 客户端/ 和/ 服务器端/ 两个/ 应用程序/ 来/ 进行/ 网络/ 数据/ 的/ 发送/ 和/ 接收/ ,/ 并/ 计算/ 出/ 相关/ 网络/ 性能指标/ ./ 我们/ 主要/ 关心/ 带宽/ (/ throughput/ )/ 和/ 延迟/ (/ latency/ )/ ./ 测试/ 过程/ :/ (/ 1/ )/ 远端/ 主机/ HostA/ 上/ 运行/ netperf/ 的/ 网络/ 服务器端/ ;/ (/ 2/ )/ 本地/ 主机/ HostB/ 上/ 运行/ netperf/ 客户端/ 进行/ 性能/ 测试/ ;/ (/ 3/ )/ 设置/ 虚拟机/ GuestB/ 使用/ 不同/ 的/ 虚拟/ 网卡/ (/ 虚拟/ rtl8139/ 网卡/ 或/ 虚拟/ e1000/ 网卡/ )/ ,/ 分别/ 运行/ netperf/ 客户端/ 进行/ 测试/ ./ 测试/ 结果/ 如图/ 4/ 所示/ ./ 图/ 4/ 中/ ,/ KVM/ 虚拟机/ 的/ 性能/ 远/ 低于/ Native/ ,/ 但表/ 1KVM/ 虚拟机/ 运行/ SPECjbb/ 时/ 的/ 热点/ 函数/ 陷入/ 次数/ 陷入/ 处理/ 时间/ // s/ // 占/ 总/ 时间/ 的/ 百分比/ // %/ 10xc041be3f20xc042ffa630xc0407cf940xc041add250xc0407cf7/ 表/ 2KVM/ 虚拟机/ 运行/ netperf/ 时/ 的/ 热点/ 函数/ 陷入/ 次数/ 陷入/ 处理/ 时间/ // s/ // 占/ 总/ 时间/ 的/ 百分比/ // %/ 10xc04ee0fc20xc04ee0d130xc04ee15340xc04edfe450xc0623d05/ 结果显示/ ,/ I/ // O/ 操作/ 存在/ 一定/ 的/ 热点/ 效应/ ,/ 也就是说/ ,/ 少数/ 指令/ 导致/ 了/ 较/ 多/ 的/ 虚拟机/ 陷入/ ./ 我们/ 可以/ 针对/ 热点/ 代码/ 进行/ 优化/ ./ 此外/ 需要/ 注意/ 的/ 是/ SPECjbb/ 的/ 测试/ 中/ ,/ 时钟/ 中断/ (/ timer/ _/ interrupt/ )/ 引起/ 的/ 虚拟机/ 陷入/ 排到/ 了/ 前/ 五位/ ,/ 可以/ 通过/ 优化/ 时钟/ 中断/ 优化/ SPECjbb/ 的/ 性能/ ./ 我们/ 抓取/ 了/ bonnie/ ++/ 运行/ 时/ 的/ 热点/ 函数/ ,/ 前/ 4/ 个/ 热点/ 函数/ 如表/ 3/ 所示/ ./ 由于/ 这些/ 热点/ 函数/ 在/ 操作系统/ 中会/ 被/ 多处/ 频繁/ 调用/ ,/ 因此/ 我们/ 还/ 抓取/ 了/ 调用/ 这些/ 热点/ 函数/ 的/ 上/ 一级/ 函数/ ,/ 表中/ 的/ 上层/ 调用函数/ 列出/ 了/ 调用/ 热点/ 函数/ 最/ 频繁/ 的/ 函数/ ./ 表/ 3/ 中/ ,/ 上层/ 调用函数/ verify/ _/ pmtmr/ _/ rate/ 用图/ 4netperf/ 测试/ ,/ 虚拟机/ 使用/ 不同/ 网卡/ 配置/ 是/ ,/ 当/ 虚拟机/ 使用/ 不同/ 的/ 网卡/ 设置/ 时/ ,/ 性能/ 有/ 一定/ 的/ 差异/ ./ 因此/ ,/ 模拟/ 设备/ 的/ 处理/ 能力/ 对/ 虚拟化/ 环境/ 下/ 网络/ 性能/ 存在/ 很大/ 的/ 影响/ ./ 如果/ 为/ 客户/ 操作系统/ 选择/ 合适/ 的/ 模拟/ 设备/ 及/ 适当/ 的/ 配置/ ,/ 可以/ 得到/ 相对/ 较/ 高/ 的/ 虚拟机/ 网络/ I/ // O/ 性能/ ./ 2.3/ 指令/ 级/ 测试/ 为了/ 进一步/ 分析/ 性能/ 下降/ 的/ 原因/ ,/ 我们/ 抓取/ 了/ 虚拟机/ 运行/ SPECjbb/ ②/ 和/ netperf/ 时/ 发生/ 虚拟机/ 陷入/ (/ VMExit/ )/ 的/ 代码/ ,/ 其中/ 最/ 频繁/ 导致/ 虚拟机/ 陷入/ 的/ 函数/ 我们/ 称之为/ “/ 热点/ 函数/ ”/ ,/ 前/ 5/ 个/ 热点/ 函数/ 显示/ 在/ 表/ 1/ 和表/ 2/ 中/ ./ 4.29/ // 17.660/ ./ 10/ // 0.410/ ./ 38/ // 1.558/ ./ 57/ // 35.283/ ./ 08/ // 12.68101/ ./ 64/ // 26.0385/ ./ 33/ // 21.8562/ ./ 26/ // 15.9444/ ./ 53/ // 11.400/ ./ 73/ // 0.19/ 陷入/ 地址/ 发生/ 陷入/ 的/ 函数/ 上层/ 调用函数/ 地址/ 上层/ 调用函数/ 0xc06442ddacpi/ _/ pm/ _/ read0xc06442e7verify/ _/ pmtmr/ _/ rate0xc0547047iowrite80xc05e8fe3ata/ _/ sff/ _/ dev/ _/ select0xc0546f3cioread80xc05eaa44ata/ _/ bmdma/ _/ status0xc05470ffiowrite320xc05ea9c2ata/ _/ bmdma/ _/ setup/ 于/ 调整/ 主板/ 时钟/ ,/ 该/ 功能/ 在/ 虚拟机/ 环境/ 下/ 冗余/ ,/ 可以/ 消除/ 该/ 函数/ 减少/ 一部分/ 虚拟机/ 陷入/ ./ 热点/ 函数/ 的/ 测试/ 结果表明/ ,/ 目前/ 的/ 客户/ 操作系统/ 中/ 存在/ 一些/ 操作/ 影响/ 了/ 虚拟机/ 的/ I/ // O/ 性能/ ,/ 我们/ 的/ 优化/ 工作/ 主要/ 针对/ 这/ 类/ 问题/ 进行/ ./ ①/ ②/ Page43/ 优化/ 方法/ 及其/ 效果/ 基于/ 上/ 一节/ 的/ 测试/ 结果/ ,/ 我们/ 发现/ ,/ 现有/ 的/ 客户/ 操作系统/ 是/ 直接/ 采用/ 针对/ 物理/ 主机/ 设计/ 的/ 操作系统/ ,/ 其中/ 存在/ 一些/ 不/ 适应/ 虚拟化/ 环境/ 的/ 因素/ ,/ 影响/ 虚拟机/ 的/ 性能/ ./ 根据/ 现有/ 的/ 分析/ ,/ 这些/ 不/ 适应/ 的/ 因素/ 可以/ 分为/ 3/ 类/ :/ (/ 1/ )/ 在/ 虚拟化/ 环境/ 下/ 一些/ 引起/ 短时间/ 内/ 频繁/ 发生/ 虚拟机/ 陷入/ 的/ 操作/ ./ 优化/ 时/ ,/ 应该/ 尽量/ 降低/ 这/ 类/ 操作/ 发生/ 的/ 频率/ ,/ 或者/ 可以/ 通过/ 批量/ 处理/ 进行/ 优化/ ./ (/ 2/ )/ 冗余/ 的/ 操作/ ./ 这些/ 操作/ 在/ 虚拟化/ 环境/ 下/ 不/ 发生/ 实际/ 的/ 作用/ ;/ 或者/ 有些/ 操作/ 在/ 客户/ 操作系统/ 和/ VMM/ 中/ 重复/ 实现/ ./ 冗余/ 的/ 操作/ 通常/ 可以/ 直接/ 去除/ ./ (/ 3/ )/ 可以/ 由/ 客户/ 操作系统/ 实现/ ,/ 也/ 可以/ 由/ VMM/ 或者/ 硬件/ 实现/ 的/ 功能/ ./ 通常/ 情况/ 下/ ,/ 越/ 底层/ 执行/ 效率/ 越高/ ./ 因此/ ,/ 可以/ 由/ VMM/ 或硬件/ 完成/ 的/ 功能/ 通常/ 都/ 可以/ 交由/ 它们/ 完成/ ,/ 尽量减少/ 客户/ 操作系统/ 的/ 工作/ ,/ 提高/ 整体/ 性能/ ./ 因此/ ,/ 我们/ 试图/ 针对/ KVM/ 虚拟化/ 环境/ 的/ 特征/ ,/ 修改/ 客户/ 操作系统/ 的/ 源码/ 或/ 其/ 配置/ ,/ 达到/ 降低/ 环境/ 切换/ 代价/ 、/ 精简/ 客户/ 操作系统/ 的/ 目的/ ,/ 从而/ 提高/ KVM/ 虚拟机/ 的/ I/ // O/ 性能/ ./ 针对/ 第/ 3/ 类/ 问题/ 的/ 优化/ 已经/ 有/ 了/ 较/ 多/ 的/ 研究成果/ (/ 详见/ 4.2/ 节/ )/ ,/ 我们/ 主要/ 针对/ 前/ 两类/ 客户/ 操作系统/ 的/ 问题/ 进行/ 优化/ ,/ 本/ 节/ 讨论/ 几种/ 优化/ 方法/ ,/ 并/ 比较/ 优化/ 前后/ 的/ 性能/ ./ 3.1/ 降低/ 环境/ 切换/ 代价/ 软件/ 模拟/ 的/ I/ // O/ 虚拟化/ 方法/ 的/ 每/ 一次/ I/ // O/ 处理过程/ 存在/ 多次/ 环境/ 切换/ ,/ 包括/ 客户/ 操作系统/ 和/ KVM/ 的/ 切换/ 、/ 内核/ 态/ 的/ KVM/ 和/ 用户/ 态/ 的/ QEMU/ 的/ 切换/ 以及/ QEMU/ 进行/ 系统/ 调用/ 以后/ 用户/ 态/ 和/ 宿主/ 操作系统/ 内核/ 态/ 的/ 切换/ ./ 其中/ 除了/ 客户/ 操作系统/ 和/ KVM/ 的/ 切换/ 之外/ ,/ 其它/ 切换/ 都/ 是/ KVM/ 的/ 设计/ 构架/ 所/ 决定/ 的/ ,/ 而/ 客户/ 操作系统/ 和/ KVM/ 的/ 切换/ 取决于/ 客户/ 操作系统/ 的/ 行为/ ,/ 且/ 客户/ 操作系统/ 和/ KVM/ 的/ 切换/ 通常/ 会/ 引起/ 其它/ 几种/ 切换/ ./ 因此/ ,/ 客户/ 操作系统/ 和/ KVM/ 的/ 切换/ 频率/ 是/ 降低/ 环境/ 切换/ 次数/ 的/ 关键/ ,/ 如果/ 可以/ 调整/ 客户/ 操作系统/ 的/ 行为/ ,/ 减少/ 其/ 切换/ 到/ KVM/ 的/ 频率/ ,/ 则/ 可以/ 降低/ 环境/ 切换/ 频率/ ./ 通过/ 上/ 一节/ 的/ 指令/ 级/ 测试/ 可以/ 看出/ ,/ KVM/ 的/ I/ // O/ 操作/ 存在/ 一定/ 程度/ 的/ 热点/ 效应/ ,/ 有/ 少量/ 客户/ 操作系统/ 的/ 代码/ 引起/ 了/ 较/ 多/ 虚拟机/ 陷入/ ,/ 可以/ 针对/ 这些/ 代码/ 进行/ 优化/ ./ 目前/ 我们/ 的/ 工作/ 主要/ 包括/ 以下/ 两/ 方面/ ./ 3.1/ ./ 1/ 合并/ 连续/ 的/ I/ // O/ 指令/ 客户/ 操作系统/ 的/ 磁盘/ 驱动/ 中/ ,/ 存在/ 一些/ 代码段/ ,/ 包含/ 了/ 连续/ 的/ I/ // O/ 指令/ ./ 每当/ 执行/ 到/ 一条/ I/ // O/ 指令/ ,/ 都/ 会/ 引起/ 虚拟机/ 陷入/ ,/ 使得/ 这/ 一段/ 代码/ 连续/ 陷入/ ./ 因此/ 可以/ 将/ 这些/ 指令/ 合并/ 成/ 一个/ 操作/ ,/ 一次/ 陷入/ KVM/ 进行/ 处理/ ./ 我们/ 采用/ 了/ 静态/ 合并/ 的/ 方法/ ,/ 将/ 一组/ I/ // O/ 指令/ 替换成/ 一个/ vmcall/ 调用/ (/ vmcall/ 类似/ 于/ 操作系统/ 中/ 的/ 系统/ 调用/ ,/ 客户/ 操作系统/ 中/ 调用/ vmcall/ 之后/ ,/ 将/ 切换/ 到/ VMM/ 进行/ 处理/ )/ ,/ 一次/ 主动/ 陷入/ KVM/ ,/ 替换/ 方法/ 是/ 将/ 每条/ I/ // O/ 指令/ 的/ 信息/ ,/ 包括/ in/ // out/ 、/ 端口/ 、/ 值/ ,/ 依次/ 放入/ 一个/ 数组/ ,/ 该/ 数组/ 的/ 地址/ 和/ 长度/ 作为/ 参数/ 由/ vmcall/ 传递/ 给/ KVM/ 处理/ ./ KVM/ 反过来/ 从/ 数组/ 中将/ I/ // O/ 操作/ 的/ 参数/ 依次/ 取出/ ,/ 逐条/ 进行/ 模拟/ ./ 例如/ ,/ // driver/ // ide/ // ide/ -/ disk/ ./ c/ 中/ 的/ __/ ide/ _/ do/ _/ rw/ _/ disk/ 函数/ ,/ 存在/ 如下/ 一段/ 代码/ (/ 代码段/ 1/ )/ :/ // driver/ // ide/ // ide/ -/ disk/ ./ chwif/ -/ >/ OUTB/ (/ tasklets/ [/ 1/ ]/ ,/ IDE/ _/ FEATURE/ _/ REG/ )/ ;/ hwif/ -/ >/ OUTB/ (/ tasklets/ [/ 3/ ]/ ,/ IDE/ _/ NSECTOR/ _/ REG/ )/ ;/ hwif/ -/ >/ OUTB/ (/ tasklets/ [/ 7/ ]/ ,/ IDE/ _/ SECTOR/ _/ REG/ )/ ;/ hwif/ -/ >/ OUTB/ (/ tasklets/ [/ 8/ ]/ ,/ IDE/ _/ LCYL/ _/ REG/ )/ ;/ hwif/ -/ >/ OUTB/ (/ tasklets/ [/ 9/ ]/ ,/ IDE/ _/ HCYL/ _/ REG/ )/ ;/ hwif/ -/ >/ OUTB/ (/ tasklets/ [/ 0/ ]/ ,/ IDE/ _/ FEATURE/ _/ REG/ )/ ;/ hwif/ -/ >/ OUTB/ (/ tasklets/ [/ 2/ ]/ ,/ IDE/ _/ NSECTOR/ _/ REG/ )/ ;/ hwif/ -/ >/ OUTB/ (/ tasklets/ [/ 4/ ]/ ,/ IDE/ _/ SECTOR/ _/ REG/ )/ ;/ hwif/ -/ >/ OUTB/ (/ tasklets/ [/ 5/ ]/ ,/ IDE/ _/ LCYL/ _/ REG/ )/ ;/ hwif/ -/ >/ OUTB/ (/ tasklets/ [/ 6/ ]/ ,/ IDE/ _/ HCYL/ _/ REG/ )/ ;/ hwif/ -/ >/ OUTB/ (/ 0x00/ |/ drive/ -/ >/ select/ ./ all/ ,/ IDE/ _/ SELECT/ _/ REG/ )/ ;/ 该段/ 代码/ 包括/ 了/ 11/ 次连续/ 的/ outb/ ,/ 将会/ 引起/ 11/ 次连续/ 的/ 虚拟机/ 陷入/ ./ 我们/ 将/ 这/ 11/ 条/ outb/ 合并/ 为/ 一个/ vmcall/ 调用/ ,/ 得到/ 如/ 代码段/ 2/ 所示/ 的/ 代码/ :/ // driver/ // ide/ // ide/ -/ disk/ ./ cstructio/ _/ insnio/ _/ out/ [/ 11/ ]/ ;/ // // 保存/ I/ // O/ 指令/ 信息/ 的/ 数组/ usignedlongio/ _/ gpa/ ,/ io/ _/ len/ ;/ #/ defineIO/ _/ OUT/ (/ x/ ,/ _/ type/ ,/ _/ val/ ,/ _/ port/ )/ \/ io/ _/ out/ [/ x/ ]/ ./ type/ =/ _/ type/ ,/ io/ _/ out/ [/ x/ ]/ ./ port/ =/ _/ port/ ,/ io/ _/ out/ [/ x/ ]/ ./ val/ =/ _/ val/ // // 把/ I/ // O/ 指令/ 的/ 信息/ 依次/ 放入/ io/ _/ insn/ 数组/ :/ IO/ _/ OUT/ (/ 0/ ,/ OUTB/ ,/ tasklets/ [/ 1/ ]/ ,/ IDE/ _/ FEATURE/ _/ REG/ )/ ;/ IO/ _/ OUT/ (/ 1/ ,/ OUTB/ ,/ tasklets/ [/ 3/ ]/ ,/ IDE/ _/ NSECTOR/ _/ REG/ )/ ;/ IO/ _/ OUT/ (/ 2/ ,/ OUTB/ ,/ tasklets/ [/ 7/ ]/ ,/ IDE/ _/ SECTOR/ _/ REG/ )/ ;/ IO/ _/ OUT/ (/ 3/ ,/ OUTB/ ,/ tasklets/ [/ 8/ ]/ ,/ IDE/ _/ LCYL/ _/ REG/ )/ ;/ IO/ _/ OUT/ (/ 4/ ,/ OUTB/ ,/ tasklets/ [/ 9/ ]/ ,/ IDE/ _/ HCYL/ _/ REG/ )/ ;/ IO/ _/ OUT/ (/ 5/ ,/ OUTB/ ,/ tasklets/ [/ 0/ ]/ ,/ IDE/ _/ FEATURE/ _/ REG/ )/ ;/ IO/ _/ OUT/ (/ 6/ ,/ OUTB/ ,/ tasklets/ [/ 2/ ]/ ,/ IDE/ _/ NSECTOR/ _/ REG/ )/ ;/ IO/ _/ OUT/ (/ 7/ ,/ OUTB/ ,/ tasklets/ [/ 4/ ]/ ,/ IDE/ _/ SECTOR/ _/ REG/ )/ ;/ IO/ _/ OUT/ (/ 8/ ,/ OUTB/ ,/ tasklets/ [/ 5/ ]/ ,/ IDE/ _/ LCYL/ _/ REG/ )/ ;/ IO/ _/ OUT/ (/ 9/ ,/ OUTB/ ,/ tasklets/ [/ 6/ ]/ ,/ IDE/ _/ HCYL/ _/ REG/ )/ ;/ IO/ _/ OUT/ (/ 10/ ,/ OUTB/ ,/ 0x00/ |/ drive/ -/ >/ select/ ./ all/ ,/ IDE/ _/ SELECT/ _/ REG/ )/ ;/ // // 由于/ KVM/ 和/ 客户/ 操作系统/ 所/ 见/ 地址/ 空间/ 不同/ ,/ 需要/ 把/ io/ _/ insn/ // // 数组/ 地址/ 转换/ 为/ 物理地址/ ,/ 以便/ KVM/ 访问/ :/ io/ _/ gpa/ =/ virt/ _/ to/ _/ phys/ (/ (/ unsignedlong/ )/ io/ _/ out/ )/ ;/ io/ _/ len/ =/ 11/ ;/ // // I/ // O/ 指令/ 数/ vmcall/ (/ XKVM/ _/ IO/ _/ COALESCE/ ,/ io/ _/ gpa/ ,/ io/ _/ len/ ,/ 0/ )/ ;/ // // 调用/ vmcall/ 陷入/ KVM/ ,/ 其/ 参数/ 包括/ io/ _/ insn/ 的/ 地址/ 和/ 长度/ Page5/ 原来/ 的/ 11/ 次/ 陷入/ 变成/ 1/ 次/ 陷入/ ,/ 可以/ 极大/ 地/ 降低/ 陷入/ KVM/ 的/ 频率/ ./ 我们/ 修改/ 了/ 两个/ 存在/ 连续/ I/ // O/ 操作/ 的/ 代码段/ ,/ 对/ 修改/ 前/ 和/ 修改/ 后/ inb/ 、/ outb/ 调用/ 点/ 引起/ 的/ 虚拟机/ 陷入/ 数量/ 进行/ 了/ 统计/ ,/ 结果/ 如表/ 4/ 所示/ ,/ 修改/ 后/ ,/ 陷入/ 数量/ 得到/ 了/ 极大/ 的/ 降低/ ./ 指令/ 地址/ 0xc054fcc00xc054ecf0/ 该/ 方式/ 实际上/ 是/ 借鉴/ 了/ 半/ 虚拟化/ [/ 1/ ]/ 的/ 思路/ ,/ 通过/ 修改/ 客户/ 操作系统/ 的/ 代码/ ,/ 减少/ 客户/ 操作系统/ 和/ VMM/ 之间/ 的/ 切换/ ./ 目前/ 我们/ 只/ 实现/ 了/ 静态/ 的/ 修改/ ,/ 包括/ 静态/ 分析/ 连续/ 陷入/ 的/ 代码/ 、/ 静态/ 合并/ 指令/ ./ 进一步/ 的/ ,/ 我们/ 可以/ 实现/ 动态/ 的/ 半/ 虚拟化/ ,/ 也/ 就是/ 进行/ 动态/ 的/ 代码段/ 替换/ ,/ 包括/ 在/ 运行/ 时/ 进行/ 动态/ 监控/ ,/ 找到/ 热点/ 的/ 代码段/ ,/ 动态/ 合并/ 指令/ ,/ 生成/ 新/ 的/ 代码/ 片段/ ./ 然后/ 通过/ 加入/ 跳转/ 指令/ ,/ 或者/ 通过/ 替换/ 包含/ 热点/ 代码/ 的/ 整个/ 函数/ ,/ 实现/ 代码段/ 替换/ ./ 或者/ ,/ 运行/ 时/ ,/ 当/ 一个/ I/ // O/ 操作/ 发生/ 陷入/ ,/ 在/ KVM/ 中/ 预取/ 客户/ 操作系统/ 的/ 后续/ 操作/ ,/ 当/ 发现/ 多个/ 可以/ 合并/ 的/ I/ // O/ 时/ ,/ 则/ 一次/ 模拟/ 执行/ 完毕/ ,/ 再/ 返回/ 客户/ 操作系统/ ./ 我们/ 比较/ 了/ 该/ 优化/ 前后/ 的/ I/ // O/ 性能/ ,/ 结果/ 并/ 不/ 理想/ ,/ 除了/ CPU/ 利用率/ 有/ 一定/ 的/ 降低/ ,/ I/ // O/ 的/ 吞吐/ 率/ 几乎/ 没有/ 变化/ ./ 我们/ 合并/ I/ // O/ 操作/ 的/ 优化/ 方式/ 只/ 减少/ 了/ 环境/ 切换/ 的/ 开销/ ,/ 也/ 就是/ 减少/ 了/ 虚拟机/ 陷入/ 和/ 返回/ 所/ 消耗/ 的/ 时间/ ,/ 并/ 不/ 对/ 陷入/ 之后/ 在/ KVM/ 和/ 宿主/ 操作系统/ 中/ 的/ 操作/ 进行/ 优化/ ,/ 因此/ ,/ 优化/ 结果/ 说明/ 这部分/ 环境/ 切换/ 的/ 开销/ 还/ 不是/ I/ // O/ 性能/ 开销/ 的/ 决定/ 因素/ ./ 3.1/ ./ 2/ 控制/ 时钟/ 频率/ 时钟/ 中断/ 是/ 另/ 一个/ 频繁/ 引起/ 虚拟机/ 陷入/ 的/ 原因/ ,/ 每个/ 时钟/ 中断/ 到来/ 时/ ,/ 都/ 会/ 引起/ 虚拟机/ 陷入/ VMM/ ./ 对于/ 非/ 实时/ 应用/ ,/ 我们/ 可以/ 通过/ 降低/ 时钟/ 频率/ ,/ 减少/ 虚拟机/ 陷入/ 的/ 频率/ ./ 最/ 简单/ 的/ 方法/ 是/ 直接/ 修改/ 客户/ 操作系统/ 的/ 配置/ ./ 我们/ 进一步/ 实现/ 了/ 对/ 客户/ 操作系统/ 透明/ 的/ 降低/ 时钟/ 频率/ 的/ 方法/ ./ KVM/ 虚拟机/ 的/ 时钟/ 是/ 由/ KVM/ 模拟/ PIT/ 实现/ 的/ ,/ PIT/ 可以/ 产生/ clock/ 信号/ ,/ 其/ 频率/ 近似/ 是/ 1193181Hz/ ,/ 每当/ clock/ 信号/ 到来/ 时/ ,/ PIT/ 通道/ 0/ 的/ 计数器/ 自动/ 减/ 1/ ,/ 当/ 计数器/ 减到/ 0/ 时/ ,/ 就/ 通过/ IRQ0/ 向/ 系统/ 产生/ 一次/ 时钟/ 中断/ ./ KVM/ 虚拟/ 的/ PIT/ 也/ 是/ 这样/ 的/ 工作/ 原理/ ./ 因此/ ,/ 通过/ 修改/ 虚拟/ PIT/ 通道/ 0/ 计数器/ 的/ 初始值/ ,/ 就/ 可以/ 设定/ 时钟/ 中断/ 的/ 频率/ ,/ 例如/ ,/ 1000Hz/ 的/ 时钟/ 频率/ ,/ PIT/ 通道/ 0/ 计数器/ 初始值/ 为/ 1193181/ // 1000/ =/ 1193/ ,/ 100Hz/ 时/ ,/ 则/ 为/ 1193181/ // 100/ =/ 11932/ ./ 也就是说/ ,/ 如果/ 修改/ 系统/ 初始化/ 时/ 写入/ vPIT/ 通道/ 0/ 的/ 计数器/ 值/ ,/ 就/ 可以/ 对/ 客户/ 操作系统/ 透明/ 地/ 修改/ 其/ 时钟/ 频率/ ./ 具体方法/ 是/ 修改/ pit/ _/ load/ _/ count/ 函数/ 中/ 写入/ vPIT/ 通道/ 0/ 的/ 初始值/ ./ 我们/ 实验/ 了/ 在/ 客户/ 操作系统/ 时钟/ 频率/ 为/ 1000Hz/ (/ vHZ100/ )/ 的/ 情况/ 下/ ,/ 由/ KVM/ 将/ 时钟/ 频率/ 实际/ 设定/ 为/ 100Hz/ (/ vHZ100/ )/ ,/ 比较/ 了/ 修改/ 前后/ 的/ 虚拟机/ I/ // O/ 性能/ ,/ 如图/ 5/ 所示/ ./ 结果表明/ ,/ 降低/ 时钟/ 频率/ 能够/ 一定/ 程度/ 地/ 提高/ 虚拟机/ 地/ 性能/ ./ 3.2/ 精简/ 客户/ 操作系统/ 冗余/ 的/ 操作/ 是/ 指/ 在/ 虚拟化/ 环境/ 下/ 不/ 发生/ 实际/ 的/ 作用/ 或者/ 在/ 客户/ 操作系统/ 和/ VMM/ 或/ 宿主/ 操作系统/ 中/ 重复/ 实现/ 的/ 操作/ ./ 我们/ 需要/ 找到/ 这些/ 可能/ 冗余/ 的/ 操作/ ,/ 将/ 其/ 从/ 客户/ 操作系统/ 中/ 去除/ ,/ 从而/ 优化/ KVM/ 虚拟机/ 的/ I/ // O/ 性能/ ./ 3.2/ ./ 1/ 消除/ 冗余/ 函数/ 一个/ 例子/ 是/ 在/ 磁盘/ I/ // O/ 的/ 热点/ 代码/ 分布/ 测试/ 中/ ,/ 表/ 3/ 中/ 的/ 函数/ verify/ _/ pmtmr/ _/ rate/ ,/ 该/ 函数/ 的/ 主要/ 工作/ 是/ 调整/ 主板/ 时钟/ ,/ 该/ 操作/ 在/ 虚拟机/ 环境/ 下/ 是/ 多余/ 的/ ./ 对于/ 这种/ 操作/ ,/ 只/ 需要/ 修改/ 客户/ 操作系统/ ,/ 简单/ 将/ 其/ 去除/ ,/ 就/ 可以/ 适当/ 地/ 提高/ 客户/ 操作系统/ 的/ 运行/ 效率/ ./ 实验/ 结果/ 如图/ 6/ 所示/ ./ 比较/ 去除/ verify/ _/ pmtmr/ _/ rate/ 函数/ 前后/ 虚拟机/ Page6/ 图/ 6/ 去除/ verify/ _/ pmtmr/ _/ rate/ 函数/ 前后/ 虚拟机/ 写/ 磁盘/ 性能/ 磁盘/ I/ // O/ 的/ 性能/ ,/ 可以/ 看到/ ,/ 去掉/ 该/ 函数/ 以后/ ,/ 虚拟机/ 的/ 写/ 性能/ 有/ 了/ 一定/ 的/ 提升/ ./ 3.2/ ./ 2/ 消除/ 冗余/ 调度/ 在/ I/ // O/ 请求/ 提交/ 驱动/ 之前/ ,/ 操作系统/ 通常/ 要/ 对/ I/ // O/ 请求/ 进行/ 调度/ :/ 通过/ 对/ 磁盘/ I/ // O/ 请求/ 的/ 合并/ 和/ 排序/ ,/ 降低/ 磁盘/ 的/ 寻道/ 时间/ ,/ 提高/ 磁盘/ 旋转/ 时/ 读取数据/ 的/ 效率/ ,/ 从而/ 降低/ I/ // O/ 操作/ 的/ 总/ 时间/ ,/ 增加/ 单位/ 时间/ 内/ 的/ I/ // O/ 操作/ 次数/ ,/ 提高/ 系统/ 整体/ 的/ I/ // O/ 效率/ ./ KVM/ 基于/ 宿主/ 操作系统/ 的/ 结构/ ,/ 使得/ 客户/ 操作系统/ 的/ I/ // O/ 操作/ 总是/ 通过/ QEMU/ 进行/ 系统/ 调用/ ,/ 在/ 宿主/ 操作系统/ 内核/ 中/ 再/ 逐层/ 向下/ 传递/ 到/ 物理/ 硬件/ ./ 该/ 流程/ 使得/ 客户/ 操作系统/ 的/ I/ // O/ 请求/ 要/ 经过/ 客户/ 操作系统/ 和/ 宿主/ 操作系统/ 的/ 两次/ I/ // O/ 调度/ ,/ 客户/ 操作系统/ 中/ 的/ 调度/ 结果/ 必然/ 要/ 由/ 宿主/ 操作系统/ 再次/ 调度/ ,/ 显然/ 冗余/ ./ 一方面/ ,/ 客户/ 操作系统/ 并不知道/ 物理/ 磁盘/ 信息/ ,/ 这次/ 调度/ 不/ 一定/ 有效/ ;/ 另一方面/ ,/ 当/ 多个/ 客户/ 操作系统/ 同时/ 运行/ 时/ ,/ 通常/ 情况/ 下/ ,/ 所有/ I/ // O/ 操作/ 需要/ 由/ 宿主/ 操作系统/ 统一/ 调度/ 以/ 获得/ 整体/ 性能/ 的/ 最大化/ ./ 基于/ 这/ 两/ 方面/ 原因/ ,/ 我们/ 去掉/ 了/ 客户/ 操作系统/ 中/ 的/ 磁盘/ I/ // O/ 调度/ ,/ 使得/ 所有/ I/ // O/ 请求/ 都/ 直接/ 提交/ 给/ 驱动/ ,/ 这样/ ,/ 既/ 减少/ 了/ 冗余/ 的/ 操作过程/ ,/ 也/ 使/ 客户/ 操作系统/ 的/ I/ // O/ 请求/ 获得/ 立即/ 处理/ ./ 当/ 宿主/ 操作系统/ 采用/ 默认/ 的/ CFQI/ // O/ 调度/ 器/ ①/ 时/ ,/ 经过/ 该/ 优化/ ,/ 虚拟机/ 按块/ 写/ 的/ 性能/ 提高/ 了/ 6.01/ %/ ;/ 而/ 虚拟机/ 按块/ 读/ 的/ 性能/ 提高/ 了/ 5.64/ %/ ./ 但是/ ,/ 由于/ 优化/ 以后/ ,/ 客户/ 操作系统/ 中/ 的/ 所有/ I/ // O/ 请求/ 都/ 按照/ 先进先出/ 的/ 顺序/ 进行/ 处理/ ,/ 因此/ ,/ 难以/ 对/ 各/ 进程/ 的/ I/ // O/ 带宽/ 进行/ 分配/ 和/ 控制/ ./ 3.2/ ./ 3/ 简化/ 客户/ 操作系统/ 网卡/ 驱动/ 网卡/ 的/ NAPI/ 技术/ 是/ 指以/ 主动/ 查询/ 结合/ 中断/ 的/ 方式/ 降低/ 中断/ 发生/ 的/ 频率/ ./ 在/ 虚拟化/ 环境/ 中/ ,/ 客户/ 操作系统/ 所/ 看到/ 的/ 是/ 虚拟/ 网卡/ ,/ 虚拟/ 网卡/ 并/ 不能/ 直接/ 产生/ 中断/ ,/ 并/ 可能/ 采用/ 其它/ 特定/ 的/ 事件/ 通知/ 机制/ 代替/ 中断/ 机制/ ./ 因此/ ,/ 客户/ 操作系统/ 网卡/ 驱动/ 中/ 的/ NAPI/ 功能/ 多余/ ,/ 反而/ 会/ 浪费/ CPU/ 时间/ ./ 因此/ ,/ 我们/ 去掉/ 了/ 客户/ 操作系统/ 网卡/ 驱动/ 中/ 的/ NAPI/ 功能/ ,/ 并/ 测试/ 比较/ 了/ 优化/ 前后/ 的/ 系统/ 性能/ ,/ 结果/ 如图/ 7/ 所示/ ./ 图/ 7/ 中/ 可以/ 看到/ 该/ 优化/ 较大/ 程度/ 地/ 改善/ 了/ 网络/ 吞吐/ 率/ ,/ 性能/ 的/ 提升/ 超过/ 了/ 60/ %/ ./ 4/ 相关/ 工作/ 比较/ KVM/ 虚拟机/ 的/ I/ // O/ 性能/ 优化/ 包括/ 两/ 方面/ :/ 降低/ 环境/ 开销/ 和/ 优化/ 客户/ 操作系统/ ./ 降低/ 环境/ 切换/ 开销/ 主要/ 可以/ 通过/ 两个/ 方面/ 实行/ :/ (/ 1/ )/ 降低/ 环境/ 切换/ 的/ 频率/ ;/ (/ 2/ )/ 降低/ 每次/ 切换/ 的/ 开销/ ./ 降低/ 环境/ 切换/ 频率/ 主要/ 是/ 通过/ 批量/ 化/ 的/ 提交/ I/ // O/ 操作/ ,/ 或者/ 在/ 可能/ 的/ 情况/ 下/ 减少/ 设备/ 中断/ ./ Sugerman/ 等/ [/ 2/ ]/ 在/ VMwareWorkstation/ 上/ 实现/ 了/ 批量/ 发送/ :/ 当/ 切换/ 的/ 频率/ 超过/ 一定/ 阈值/ 时/ ,/ 可以/ 将/ 客户/ 操作系统/ 每/ 一次/ 发送数据/ 的/ 请求/ 缓存/ 到/ 一个/ 队列/ 中/ ,/ 当下/ 一次/ 中断/ 发生/ 时/ ,/ 一次/ 切换/ 到/ Host/ 进行/ 中断/ 处理/ 和/ 数据/ 发送/ ./ 该/ 优化/ 同时/ 能/ 降低/ 虚拟/ IRQ/ 传送/ 的/ 开销/ ,/ 因为/ 每/ 一批/ 数据/ 传送/ 完成/ 后/ ,/ 只/ 需要/ 传递/ 一个/ IRQ/ ./ 同时/ ,/ Sugerman/ 等/ [/ 2/ ]/ 考虑/ 优化/ 客户/ 操作系统/ 的/ 驱动/ 协议/ ,/ 设计/ 一个/ 利于/ 虚拟化/ 的/ 调用/ 接口/ ,/ 例如/ 可以/ 节省/ 大量/ 访问/ 设备/ 状态/ 的/ I/ // O/ 指令/ ,/ 能/ 避免/ 虚拟机/ 陷入/ VMM/ ;/ 也/ 可以/ 降低/ 虚拟/ IRQ/ 的/ 发生率/ ,/ 从而/ 降低/ VMM/ 和/ VM/ 的/ 切换/ 频率/ ./ 借鉴/ 半/ 虚拟化/ 的/ 思路/ ,/ Russell/ [/ 3/ ]/ 等/ 提出/ 了/ virtio/ ,/ virtio/ 是/ 一种/ 通用/ 的/ 设备/ 驱动/ ,/ 为块/ 设备/ 和/ 网卡/ 提供/ 了/ 相同/ 的/ 处理/ 流程/ ,/ 可以/ 用于/ 多种不同/ 的/ VMM/ ./ 其/ 实现/ 主要/ 是/ 在/ 客户/ 操作系统/ 和/ VMM/ 之间/ 提供/ 一个/ 基于/ 共享内存/ 的/ 环状/ 缓冲区/ ,/ 客户/ 操作系统/ 和/ VMM/ 分别/ 作为/ 消费者/ 和/ 生产者/ ,/ 通过/ 环状/ 缓冲区/ 进行/ 数据交换/ ,/ 此外/ ,/ 实现/ 了/ 一套/ 事件/ 通知/ 机制/ ,/ 当/ ①/ AxboeJ/ ./ TimeSlicedCFQI/ // OScheduler/ ./ [/ Online/ ]/ http/ :/ // // Page7/ 降低/ 每/ 一次/ 切换/ 的/ 开销/ 是/ 要/ 减少/ 切换/ 时/ 所/ 做/ 的/ 工作/ ,/ Sugerman/ 等/ [/ 2/ ]/ 修改/ 了/ VMwareWorkstation/ 上/ 运行/ 的/ 客户/ 操作系统/ 的/ 进程/ 切换/ :/ 当/ 切换/ 到/ 空闲/ 进程/ (/ idleprocess/ )/ 时/ ,/ 不/ 需要/ 切换/ 进程/ 的/ 页表/ 结构/ ,/ 因为/ idle/ 是/ 一个/ 内核/ 线程/ ,/ 可以/ 使用/ 任何/ 一个/ 进程/ 的/ 内核/ 页表/ ./ 该/ 优化/ 把/ MMU/ 引起/ 的/ 虚拟化/ 开销/ 降低/ 了/ 近一半/ ./ Sugerman/ 等/ [/ 2/ ]/ 还/ 对/ VMwareWork/ -/ station/ 提出/ 了/ 旁路/ 宿主/ 操作系统/ 的/ 优化/ :/ 因为/ VMwareWorkstation/ 的/ 每/ 一次/ 虚拟机/ 的/ I/ // O/ 操作/ 都/ 要/ 经过/ 客户/ 操作系统/ -/ VMM/ -/ 宿主/ 操作系统/ 之间/ 的/ 切换/ 过程/ ,/ 若/ 由/ VMM/ 直接/ 访问/ 硬件/ 设备/ ,/ 则/ 能/ 降低/ 至少/ 一半/ 切换/ 开销/ ./ 切换/ 时/ 的/ 开销/ 还有/ 一方面/ 表现/ 为/ 切换/ 后/ TLB/ 、/ Cache/ 等/ 会/ 发生/ 失效/ ./ Menon/ 等/ [/ 4/ ]/ 优化/ 了/ Xen/ 使/ 客户/ 操作系统/ 支持/ 超大/ 页/ (/ superpage/ )/ 和/ 全局/ 页面/ 映射/ (/ globalpagemapping/ )/ 等/ 高级/ 虚拟内存/ 功能/ ,/ 极大/ 降低/ 了/ TLB/ 的/ 失效率/ ./ 此外/ ,/ 如果/ 虚拟机/ 能够/ 直接/ 访问/ 硬件/ 设备/ ,/ 则/ 可/ 极大/ 降低/ 环境/ 切换/ 的/ 开销/ ./ 近年来/ ,/ 出现/ 了/ 一些/ 新/ 技术/ 和/ 规范/ ,/ 如/ IntelVT/ -/ d/ ①/ 、/ AMDIOMMU/ ②/ 能够/ 保证/ 虚拟机/ I/ // O/ 地址/ 空间/ 的/ 隔离/ 性/ ,/ 并/ 在/ PCI/ 总线/ 桥/ 上/ 安装/ 一个/ 类似/ 传统/ MMU/ 的/ 地址/ 转换/ 设备/ ,/ 提供/ 硬件/ 中断/ 转发/ 机制/ ;/ PCI/ -/ SIG/ 提出/ 了/ SR/ -/ IOV/ 和/ MR/ -/ IOV/ 规范/ ③/ ,/ 旨在/ 定义/ 一个/ 可/ 分割/ 共享/ 的/ I/ // O/ 设备/ 的/ 规范/ ,/ 按照/ 该/ 规范/ 设计/ 的/ PCIe/ 设备/ ,/ 将/ 具有/ 统一/ 的/ 、/ 可/ 由/ 多个/ 虚拟机/ 分割/ 共享/ 的/ 界面/ ./ 目前/ 已经/ 有/ SR/ -/ IOV/ 设备/ 面世/ ,/ Dong/ [/ 5/ -/ 6/ ]/ 等/ 已经/ 实现/ 了/ 虚拟机/ 对/ SR/ -/ IOV/ 网卡/ 的/ 直接/ 访问/ ,/ 并/ 达到/ 了/ 接近/ Native/ 的/ 性能/ ./ 这些/ 硬件/ 支持/ 的/ 出现/ ,/ 使得/ 虚拟机/ 能够/ 直接/ 访问/ 物理/ 硬件/ ,/ 从而/ 提高/ 了/ 性能/ ,/ 也/ 简化/ 了/ I/ // O/ 设备/ 虚拟化/ 的/ 实现/ ./ 因此/ ,/ 针对/ 软件/ 的/ 优化/ 应该/ 着重于/ 如何/ 优化/ 客户/ 操作系统/ ,/ 使得/ 它/ 更/ 适应/ 虚拟化/ 环境/ ,/ 或者/ 使/ 客户/ 操作系统/ 、/ VMM/ 和/ 宿主/ 操作系统/ 配合/ 得/ 更/ 有效/ ./ 有/ 数据/ 被/ 放到/ 缓冲区/ 以后/ ,/ 作为/ 消费者/ 的/ 一方/ 会/ 接到/ 通知/ ,/ 这套/ 事件/ 通知/ 机制/ 支持/ 屏蔽/ ,/ 因此/ 可以/ 实现/ 批量/ 操作/ ,/ 避免/ 频繁/ 发生/ 环境/ 切换/ ./ Ram/ 等/ [/ 7/ ]/ 对/ 客户/ 操作系统/ 的/ 优化/ 包括/ 3/ 个/ 方面/ :/ (/ 1/ )/ 实现/ LRO/ (/ LargeReceiveOffload/ )/ ,/ 该/ 技术/ 通过/ 将/ 多个/ 数据包/ 中/ 的/ 数据/ 合并/ 成/ 一个/ TCP/ // IP/ 数据/ 报/ ,/ 使/ 一次/ 协议/ 栈/ 的/ 处理/ 能/ 处理/ 大量/ 数据/ ./ (/ 2/ )/ 软件/ 预取/ ,/ 每次/ 处理/ 虚拟/ 中断/ 时/ ,/ 通常/ 是/ 循环/ 处理/ 一组/ 数据包/ ,/ 可以/ 在/ 每轮/ 循环/ 中/ ,/ 访问/ 下/ 一轮/ 要/ 处理/ 的/ 数据/ 报/ 的/ 报头/ ,/ 进一步/ 地/ 访问/ 下/ 两轮/ 要/ 处理/ 的/ 数据/ 报/ 的/ 缓存/ 结构/ ,/ 从而/ 降低/ 访存/ 的/ 延迟/ ./ (/ 3/ )/ 降低/ 缓冲区/ 大小/ ,/ 将/ 缓冲区/ 改成/ 半个/ 页面/ 的/ 大小/ ,/ 能够/ 减小/ 缓冲区/ 的/ 工作/ 集/ ,/ 从而/ 降低/ TLB/ 的/ 失效率/ ./ Menon/ 等/ [/ 4/ ]/ 改进/ 了/ Xen/ 的/ 虚拟/ 网卡/ 接口/ ,/ 提供/ 了/ 现有/ 的/ 大部分/ 网卡/ 支持/ 的/ 分载/ (/ offload/ )/ 功能/ (/ 若/ 底层/ 的/ 硬件/ 并/ 不/ 支持/ 分载/ ,/ 则/ 由/ DriverDomain/ 模拟/ ,/ 也/ 能/ 提高/ 性能/ )/ ,/ 包括/ 散/ // 聚/ (/ Scatter/ // Gather/ )/ I/ // O/ ,/ TCP/ // IP/ 校验/ 和/ 分载/ (/ TCP/ // IPChecksumOff/ -/ load/ )/ 、/ TCP/ 分段/ 分载/ (/ TCPSegmentationOffload/ ,/ TSO/ )/ ./ Scatter/ // GatherI/ // O/ 支持/ 不/ 连续/ 的/ 内存地址/ 做/ 连续/ 的/ DMA/ 操作/ ;/ TSO/ 减少/ 了/ 整个/ 系统/ 需要/ 处理/ 的/ 数据包/ 数量/ ,/ 提高/ 了/ 系统/ 的/ 整体/ 性能/ ;/ TCP/ // IPChecksumOffload/ 降低/ 了/ 客户/ 操作系统/ 的/ 负载/ ./ 我们/ 主要/ 从/ 两个/ 方面/ 进行/ 优化/ :/ 一是/ 降低/ 环境/ 切换/ 开销/ ,/ 二是/ 消除/ 客户/ 操作系统/ 中/ 的/ 冗余/ 操作/ ./ 通过/ 修改/ 客户/ 操作系统/ ,/ 使/ 邻近/ 的/ I/ // O/ 操作/ 批量/ 陷入/ VMM/ ,/ 并且/ 降低/ 时钟/ 频率/ ,/ 从而/ 降低/ 虚拟机/ 陷入/ (/ VMExit/ ,/ 指/ 虚拟机/ 在/ 执行/ 到/ 敏感/ 指令/ 时/ 从/ 虚拟机/ 运行/ 状态/ 陷入/ 到/ 虚拟机/ 管理器/ (/ VirtualMachineMonitor/ ,/ VMM/ )/ 的/ 运行/ 状态/ )/ 频率/ ./ 通过/ 修改/ 客户/ 操作系统/ ,/ 可以/ 去掉/ 那些/ 只有/ 在/ 非/ 虚拟环境/ 下/ 发挥作用/ 的/ 操作/ ,/ 减少/ 了/ 虚拟机/ 的/ 运算量/ ./ 我们/ 的/ 优化/ 工作/ ,/ 一方面/ 可以/ 用于/ 要求/ 高/ I/ // O/ 性能/ 的/ 环境/ ;/ 更/ 重要/ 的/ ,/ 虚拟机/ 的/ 早期/ 目标/ 仅/ 在于/ 提高/ 物理/ 机器/ 的/ 利用率/ ,/ 考虑/ 的/ 是/ 如何/ 将/ 大量/ 遗产/ 服务器/ 整合/ 到/ 部署/ 了/ 虚拟机/ 的/ 少量/ 主机/ 上/ ,/ 因此/ ,/ 虚拟机/ 上/ 运行/ 的/ 操作系统/ 必须/ 是/ 遗产/ 操作系统/ ,/ 这些/ 操作系统/ 是/ 面向/ 物理/ 机器/ 开发/ 的/ ,/ 包含/ 了/ 一些/ 不/ 适应/ 虚拟化/ 环境/ 从而/ 影响/ 虚拟机/ 性能/ 的/ 因素/ ./ 但是/ 当/ 虚拟机/ 的/ 应用/ 越来越/ 广泛/ ,/ 虚拟机/ 的/ 用途/ 早已/ 不/ 限于/ 整合/ 遗产/ 服务器/ ,/ 对/ 虚拟机/ 的/ 性能/ 和/ 可用性/ 提出/ 了/ 更/ 高/ 的/ 要求/ ./ 面向/ 虚拟化/ 环境/ ,/ 需要/ 进一步/ 研究/ 如何/ 裁剪/ 并/ 补充/ 原有/ 的/ 操作系统/ ,/ 使/ 其/ 更/ 适应/ 虚拟化/ 环境/ ./ 我们/ 已经/ 看到/ ,/ Linux/ 内核/ 已经/ 在/ 逐渐/ 纳入/ 对/ 虚拟化/ 的/ 支持/ ./ 但是/ ,/ 什么样/ 的/ 操作系统/ 更/ 适合/ 虚拟化/ ①/ ②/ ③/ Page8/ 的/ 运行/ 环境/ ?/ 如何/ 构造/ 一个/ 简洁/ 高效/ 的/ 虚拟机/ 操作系统/ ?/ 还/ 没有/ 较为/ 系统/ 的/ 结论/ ./ 我们/ 的/ 工作/ 表明/ 操作系统/ 中/ 的/ 影响/ 性能/ 的/ 因素/ 分布/ 较散/ ,/ 类型/ 多样/ ,/ 目前/ 还/ 难以/ 提出/ 一种/ 通用/ 的/ 解决方案/ ,/ 本文/ 的/ 工作/ 可以/ 为/ 今后/ 系统性/ 研究/ 提供/ 借鉴/ ./ 5/ 结束语/ 对/ KVM/ 虚拟机/ I/ // O/ 性能/ 的/ 测试表明/ ,/ 现有/ 的/ 客户/ 操作系统/ 中/ 存在/ 一些/ 不/ 适应/ 虚拟化/ 环境/ 的/ 因素/ ,/ 影响/ 了/ 虚拟机/ 的/ I/ // O/ 性能/ ./ 因此/ 针对/ KVM/ 虚拟机/ 环境/ ,/ 我们/ 修改/ 了/ 客户/ 操作系统/ ,/ 降低/ 了/ 虚拟机/ 运行/ 时/ 发生/ 环境/ 切换/ 的/ 频率/ ,/ 简化/ 了/ 客户/ 操作系统/ 的/ 操作/ ,/ 优化/ 了/ KVM/ 虚拟机/ 的/ I/ // O/ 性能/ ./ 现有/ 的/ 硬件/ 虚拟化/ 支持/ 已经/ 极大地提高/ 了/ 虚拟机/ 的/ 性能/ 并/ 降低/ 了/ 虚拟化/ 的/ 实现/ 复杂度/ ,/ 因此/ ,/ 未来/ 的/ 方向/ 应该/ 着重/ 改进/ 操作系统/ ,/ 使得/ 操作系统/ 更加/ 适应/ 虚拟化/ 环境/ ./ 下/ 一步/ 工作/ 中/ ,/ 我们/ 继续/ 从/ 客户/ 操作系统/ 入手/ ,/ 找到/ 其/ 不/ 适应/ 虚拟化/ I/ // O/ 环境/ 的/ 其它/ 因素/ 进行/ 优化/ ./ 此外/ 还要/ 进一步/ 实现/ 动态/ 优化/ ,/ 从而/ 无需/ 修改/ 客户/ 操作系统/ 的/ 源码/ ,/ 而/ 在/ 其/ 运行/ 时/ ,/ 根据/ 其/ 运行/ 特征/ ,/ 对/ 影响/ 虚拟机/ 性能/ 的/ 操作/ 进行/ 动态/ 的/ 优化/ 和/ 二进制/ 代码/ 替换/ ./ WANGXiao/ -/ Lin/ ,/ bornin1972/ ,/ Ph/ ./ D/ ./ ,/ associatepro/ -/ fessor/ ./ Hisresearchinterestsincludesystemvirtualizationandgeographicinformationsystem/ ./ YANGLiang/ ,/ bornin1986/ ,/ M/ ./ S/ ./ candidate/ ./ Hisre/ -/ searchinterestsfocusonsystemvirtualization/ ./ BackgroundRecently/ ,/ virtualizationtechnologyisdevelopingquick/ -/ ly/ ./ Someexcellentvirtualmachinemonitorsaremoreandmorewidelyused/ ./ Viaoptimizationsinsoftwareandexten/ -/ sioninhardware/ ,/ virtualizationofCPUandmemoryisnowmuchimproved/ ./ Theperformanceisnearlythesametothe/ 

