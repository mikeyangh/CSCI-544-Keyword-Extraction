Page1/ 基于/ 共享/ 与/ 分布/ 随机数/ 的/ 并行/ 粒子/ 发射/ 算法/ 陈军/ (/ 北京/ 应用/ 物理/ 与/ 计算/ 数学/ 研究所/ 高性能/ 计算中心/ 北京/ 100094/ )/ 摘要/ 对/ 高功率/ 微波/ 三维/ 电磁/ PIC/ 数值/ 模拟/ 中/ 采用/ 束流/ 发射/ 方式/ 的/ 粒子/ 随机/ 生成/ 规律/ 进行/ 了/ 研究/ ./ 提出/ 了/ 一种/ 基于/ 共享/ 与/ 分布/ 随机数/ 的/ 并行/ 粒子/ 发射/ 算法/ ,/ 以/ 满足/ 多个/ 处理机对/ 单个/ 随机数/ 产生器/ 产生/ 的/ 随机数/ 序列/ 的/ 共享/ 和/ 分布/ 需求/ ,/ 即/ 共享/ 部分/ 随机数/ ,/ 而/ 分别/ 使用/ 其他/ 随机数/ ./ 这些/ 共享/ 和/ 分布/ 需求/ 在/ 程序运行/ 前/ 是非/ 确定性/ 的/ ./ 将/ 该/ 并行算法/ 用于/ 一/ 典型/ 高功率/ 微波/ 源/ 器件/ 中/ 模拟/ ,/ 数值/ 实验/ 表明/ 并行程序/ 可以/ 较/ 好/ 地/ 吻合/ 串行/ 程序/ 得到/ 的/ 粒子/ 相空间/ 物理/ 图像/ ./ 关键词/ 并行算法/ ;/ 随机数/ 生成/ ;/ 粒子/ 发射/ 1/ 引言/ PIC/ (/ Particle/ -/ In/ -/ Cell/ )/ 模拟/ [/ 1/ ]/ 是/ 等离子体/ 数值/ 模拟/ 中/ 一种/ 常见/ 的/ 计算方法/ ./ 在/ 高功率/ 微波/ 源/ 器件/ 模拟/ 中/ ,/ 通过/ 模拟/ 等离子体/ 与/ 电磁场/ 的/ 相互作用/ ,/ 从/ Page2/ 些/ 领域/ ,/ 例如/ 电子/ 加速器/ 并行/ 模拟/ [/ 3/ ]/ ,/ 其/ 初始/ 电子束/ 发射/ 等/ 均/ 强烈/ 依赖于/ 并行/ 随机数/ 的/ 实现/ ./ 在/ 高功率/ 微波/ 源/ 器件/ 模拟/ 采用/ 的/ 束流/ 发射/ 方式/ 中/ ,/ 它/ 限制/ 发射/ 面/ 电流/ 大小/ ,/ 并/ 根据/ 本/ 网格/ 与/ 周围/ 网格/ 的/ 电场/ 信息/ ,/ 决定/ 在/ 本/ 网格/ 是否/ 发射/ 粒子/ ./ 如果/ 发射/ 粒子/ ,/ 那么/ 随机/ 确定/ 粒子/ 的/ 初始/ 空间/ 位置/ 和/ 动量/ ./ 在/ 这里/ ,/ 需要/ 多次/ 使用/ 随机数/ ,/ 且/ 次数/ 依赖于/ 运行/ 时/ 信息/ ./ 本文/ 分析/ 了/ 束流/ 发射/ 方式/ 下/ 的/ 粒子/ 随机/ 生成/ 规律/ ./ 为/ 实现/ 并行/ 模拟/ ,/ 对/ 同一个/ 随机数/ 序列/ ,/ 多个/ 处理机/ 需要/ 共享/ 其中/ 的/ 多个/ 随机数/ ,/ 并/ 分开/ 使用/ 其他/ 随机数/ ./ 这种/ 共享/ 和/ 分布/ 需求/ 在/ 程序运行/ 前/ 是非/ 确定性/ 的/ ,/ 即/ 在/ 程序运行/ 前/ 无法/ 确定/ 要/ 共享/ 哪些/ 随机数/ ./ 因此/ ,/ 在/ 并行/ 粒子/ 发射/ 算法/ 的/ 研究/ 中/ ,/ 要求/ 研究/ 满足/ 上述/ 共享/ 和/ 分布/ 特性/ 的/ 并行/ 随机数/ 生成/ 方法/ ./ 在/ 并行/ 随机数/ 生成/ 方面/ ,/ 大量/ 的/ 研究/ 集中/ 在/ 并行/ 蒙特卡罗/ 应用/ 方面/ [/ 4/ -/ 6/ ]/ ./ 在/ 这类/ 应用/ 中/ ,/ 随机数/ 产生器/ 的/ 质量/ 非常/ 重要/ ./ 它/ 必须/ 满足/ 如下/ 特性/ :/ 每个/ 处理机/ 上/ 产生/ 的/ 随机数/ 之间/ 要求/ 是/ 统计/ 无关/ 的/ ./ 传统/ 上/ ,/ 并行/ 化/ 蒙特卡罗/ 应用/ 有/ 两种/ 方法/ :/ (/ 1/ )/ 参数/ 化/ ./ 通过/ 一个/ 带/ 可变/ 参数/ 的/ 递归函数/ 来/ 定义/ 一组/ 随机数/ 产生器/ ./ 每个/ 参数值/ 导致/ 一次/ 递归/ ,/ 从而/ 产生/ 一个/ 独一无二/ 的/ 随机数/ 序列/ ,/ 这个/ 序列/ 可/ 在/ 特定/ 的/ 处理机/ 上/ 使用/ ./ 对于/ NP/ 个/ 处理机/ ,/ 每个/ 处理机/ 可/ 使用/ 不同/ 的/ 参数值/ ,/ 从而/ 可以/ 并行/ 生成/ 不同/ 的/ 随机数/ 序列/ ./ (/ 2/ )/ 分组/ ./ 由/ 单个/ 随机数/ 产生器/ 产生/ 的/ 随机数/ 序列/ 被/ 分成/ 多个/ 子/ 序列/ ,/ 每个/ 子/ 序列/ 被/ 用于/ 不同/ 处理机/ 上/ ./ 文献/ [/ 7/ ]/ 探讨/ 了/ 并行/ 随机数/ 生成/ 的/ 一般/ 方法/ ,/ 文献/ [/ 8/ ]/ 给出/ 了/ 一种/ 在/ 机群/ 上/ 生成/ 并行/ 随机数/ 的/ 方法/ ./ 目前/ 有/ 一些/ 高质量/ 的/ 并行/ 随机数/ 生成/ 软件/ ,/ 例如/ SPRNG/ [/ 9/ ]/ 并行/ 随机数/ 生成/ 库/ ,/ 已/ 得到/ 广泛应用/ ./ 上述/ 方法/ 的/ 目标/ 是/ 使/ 各个/ 处理机/ 使用/ 不同/ 的/ 随机数/ 子/ 序列/ ,/ 且/ 各个/ 随机数/ 之间/ 是/ 统计/ 无关/ 的/ ./ 然而/ 对于/ 本文/ 的/ 高功率/ 微波/ 源/ 器件/ 模拟/ 应用/ 存在/ 的/ 共享/ 和/ 分布/ 需求/ ,/ 这些/ 方法/ 无法/ 满足/ ./ 为此/ ,/ 本文/ 首先/ 分析/ 了/ 束流/ 发射/ 方式/ 下/ 的/ 粒子/ 随机/ 生成/ 规律/ ,/ 并/ 提出/ 了/ 一种/ 基于/ 共享/ 与/ 分布/ 随机数/ 的/ 并行/ 粒子/ 发射/ 算法/ ,/ 以/ 满足/ 多个/ 处理机对/ 同一/ 随机数/ 产生器/ 产生/ 的/ 多个/ 随机数/ 的/ 共享/ 和/ 分布/ 需求/ ./ 这些/ 共享/ 和/ 分布/ 需求/ 在/ 程序运行/ 前/ 是非/ 确定性/ 的/ ./ 上述/ 并行/ 粒子/ 发射/ 算法/ 被/ 应用/ 到/ 高功率/ 微波/ 源/ 器件/ 模拟/ 并行程序/ NEPTUNE3D/ [/ 10/ -/ 11/ ]/ 中/ ,/ 模拟/ 了/ 多种/ 源/ 器件/ ,/ 计算结果/ 与/ 国际/ 同类/ 软件/ 进行/ 了/ 比/ 对/ [/ 12/ -/ 13/ ]/ ,/ 获得/ 了/ 较/ 好/ 的/ 效果/ ./ 本文/ 的/ 贡献/ 在于/ :/ 根据/ 应用/ 对/ 随机数/ 的/ 共享/ 与/ 分布/ 需求/ ,/ 将/ 非/ 确定性/ 的/ 并行/ 随机数/ 生成/ 问题/ 分解/ 为/ 两/ 部分/ ,/ 即/ 共享/ 区/ 随机数/ 生成/ 和/ 分布区/ 随机数/ 生成/ 问题/ ,/ 并/ 分别/ 生成/ 相应/ 的/ 随机数/ ./ 本文/ 第/ 2/ 节/ 分析/ 束流/ 发射/ 方式/ 下/ 的/ 粒子/ 随机/ 生成/ 规律/ ,/ 并/ 阐述/ 本文/ 要求/ 解/ 的/ 问题/ ;/ 第/ 3/ 节/ 给出/ 我们/ 的/ 并行/ 粒子/ 发射/ 算法/ ;/ 第/ 4/ 节/ 给出/ 在/ 具有/ 上百/ 台/ 处理机/ 的/ 并行机/ 上/ 的/ 实验/ 结果/ ;/ 最后/ 总结/ 全文/ ./ 2/ 问题/ 描述/ 通常/ ,/ 可/ 发射/ 粒子/ 的/ 区域/ 是/ 整个/ 计算/ 模拟/ 区域/ 的/ 一部分/ ./ 假设/ 发射/ 区域/ 已/ 被/ 离散/ 为/ N/ 个/ 网格/ ,/ 且/ 已/ 排序/ ,/ 索引/ 为/ 1/ 到/ N/ ,/ 束流/ 发射/ 方式/ 下/ 的/ 粒子/ 发射/ 算法/ 如下/ ./ 算法/ 1/ ./ 束流/ 发射/ 方式/ 下/ 的/ 粒子/ 发射/ 算法/ ./ 输入/ :/ 发射区/ 网格/ 、/ 电场/ E/ 、/ 已/ 发射/ 电子/ 电荷/ 量/ 输出/ :/ 更新/ 的/ 已/ 发射/ 电子/ 电荷/ 量/ ,/ 新/ 发射/ 的/ 0/ 或/ 多个/ 粒子/ FORiterationlDO/ 两次/ 随机抽样/ 获得/ 网格/ 序号/ G1/ 和/ G2/ ;/ 由/ G1/ 和/ G2/ 确定/ 实际/ 发射区/ 序号/ 起点/ M1/ 与/ 终点/ M2/ ;/ DOi/ =/ M1/ ,/ M2/ // // 对/ 第/ i/ 个/ 发射/ 网格/ qiIF/ (/ qiENDDOENDFOR/ 同余/ 序列/ 产生器/ :/ 在/ 上述/ 算法/ 中/ ,/ 对于/ 每次/ 迭代/ ,/ 有/ 两处/ 要/ 用到/ 随机数/ 生成/ :/ (/ 1/ )/ 随机抽样/ 获得/ 网格/ 序号/ G1/ 和/ G2/ ./ (/ 2/ )/ 在/ 第/ i/ 个/ 发射/ 网格/ 上/ ,/ 随机/ 发射/ 粒子/ ./ 这里/ ,/ 随机数/ 产生器/ random/ 采用/ 常用/ 的/ 线性/ 其中/ ,/ 0/ </ a/ </ M/ 和/ 0/ / c/ </ M/ ,/ M/ =/ 230p/ ,/ p/ 为/ 一小/ 的/ 整数/ ,/ Un/ 为/ [/ 0/ ,/ 1/ ]/ 空间/ 上/ 所/ 需/ 的/ 随机数/ ./ 以/ Un/ =/ random/ (/ Vn/ -/ 1/ )/ 来/ 表示/ ./ 图/ 1/ 中/ 显示/ 了/ 在/ 串行/ 随机数/ 生成/ 序列/ 中/ 第/ l/ 和/ 第/ (/ l/ +/ 1/ )/ 次/ 迭代/ 对应/ 的/ 随机数/ 片段/ ./ 相邻/ 两个/ 黑点/ 表示/ 随机抽样/ 获得/ 发射/ 网格/ 序号/ G1/ 和/ G2/ 所/ 需/ 的/ 随机数/ ,/ 白点/ 则/ 是/ 在/ 不同/ 发射/ 网格/ 上/ 随机/ 发射/ 粒子/ 对应/ 的/ Page3/ 随机数/ ./ 例如/ ,/ 在/ 第/ l/ 次/ 迭代/ 的/ 随机数/ 子/ 序列/ 上/ ,/ 首先/ 是/ 两个/ 黑点/ ,/ 根据/ 这/ 两个/ 随机数/ 分别/ 获得/ 发射/ 网格/ 序号/ G1/ 和/ G2/ ;/ 然后/ 为/ 发射/ 阶段/ :/ 首先/ 是/ 对应/ 第/ M1/ 个/ 发射/ 网格/ 的/ 所/ 需/ 的/ IM1/ 个/ 随机数/ ,/ 接着/ 是/ 对应/ 第/ M1/ +/ 1/ 个/ ,/ …/ ,/ 第/ M2/ 个/ 发射/ 网格/ 所/ 需/ 的/ IM2/ 个/ 随机数/ ./ 图/ 1/ 粒子/ 发射/ 中/ 用到/ 的/ 串行/ 随机数/ 序列/ 示例/ 对于/ 一个/ 被/ 选中/ 发射/ 粒子/ 的/ 网格/ 单元/ ,/ 它/ 发射/ 粒子/ 的/ 个数/ 是/ 根据/ 当前/ 时刻/ 电场/ 的/ 情况/ 来/ 确定/ ,/ 可能/ 是/ 零/ 或/ 多个/ ,/ 所以/ 在/ 程序运行/ 前/ ,/ 每个/ 发射/ 网格/ 在/ 随机数/ 序列/ 中/ 对应/ 的/ 长度/ IM1/ ,/ IM1/ +/ 1/ ,/ …/ ,/ IM2/ 是/ 不/ 确定/ 的/ ,/ 因此/ ,/ 黑点/ 在/ 随机数/ 序列/ 上/ 的/ 位置/ 也/ 是/ 未知/ 的/ ./ 在/ 并行算法/ 设计/ 中/ ,/ 需要/ 对/ 以下/ 两种/ 需求/ 做/ 不同/ 的/ 处理/ :/ (/ 1/ )/ 所有/ 进程/ 并行/ 获取/ 用于/ 确定/ 发射/ 区间/ 的/ 网格/ 序号/ G1/ 和/ G2/ ./ 在/ 同一/ 迭代/ 时刻/ ,/ 所有/ 进程/ 应/ 获得/ 相同/ 的/ 序号/ G1/ 和/ G2/ ./ 即/ 在/ 同一/ 迭代/ 时刻/ ,/ 它们/ 对应/ 于/ 随机数/ 序列/ 中/ 的/ 相同/ 的/ 两个/ 位置/ ,/ 即/ 黑点/ ,/ 以下/ 称之为/ 共享/ 点/ ./ (/ 2/ )/ 第/ i/ 个/ 发射/ 网格/ 上/ 随机/ 发射/ 事先/ 未知/ 个数/ 的/ 粒子/ ./ 这里/ ,/ 同一个/ 发射/ 网格/ 对应/ 随机数/ 序列/ 中/ 的/ 多个/ 不同/ 随机数/ ./ 当/ 多个/ 发射/ 网格/ 被/ 分配/ 到/ 不同/ 处理机/ 上时/ ,/ 它们/ 对应/ 的/ 随机数/ 子/ 序列/ 是/ 不同/ 的/ ./ 在/ 以/ 网格/ 划分/ 进行/ 的/ 并行计算/ 中/ ,/ 计算/ 区域/ 通常/ 被/ 分解/ 为/ 多块/ ,/ 每个/ 块/ 由/ 不同/ 处理机/ 处理/ ,/ 因此/ ,/ 每个/ 处理机/ 必须/ 处理/ 它/ 所/ 包含/ 的/ 发射/ 网格/ 的/ 粒子/ 发射/ 问题/ ./ 在/ 同一/ 迭代/ 时刻/ ,/ 上述/ 需求/ 反映/ 了/ 在/ 对待/ 随机数/ 生成/ 上/ 的/ 两/ 方面/ 特性/ :/ (/ 1/ )/ 共享/ 特性/ ./ 即/ 在/ 第/ l/ 次/ 迭代/ 中/ ,/ 多个/ 处理机/ 共享/ 随机数/ 序列/ 中/ 的/ 相邻/ 两个/ 值/ (/ 即/ 黑点/ 对应/ 的/ 值/ )/ 来/ 获得/ 确定/ 发射/ 区间/ 的/ 网格/ 序号/ G1/ 和/ G2/ ./ (/ 2/ )/ 分布/ 特性/ ./ 即/ 在/ 第/ l/ 次/ 迭代/ 中/ ,/ 多个/ 发射/ 网格/ 分布/ 在/ 不同/ 处理机/ 上/ ,/ 每个/ 处理机/ 对应/ 了/ 随机数/ 序列/ 中/ 多个/ 长度/ 变化/ 的/ 片段/ ,/ 每个/ 片段/ 的/ 长度/ 在/ 程序运行/ 前/ 未知/ ./ 图/ 2/ 显示/ 了/ 在/ 第/ l/ 次/ 迭代/ 中/ 处理机/ Pk/ (/ k/ =/ 1/ ,/ …/ ,/ NP/ )/ 的/ 随机数/ 子/ 序列/ ./ 其中/ ,/ 各个/ 子/ 序列/ 中/ 黑点/ 对应/ 的/ 随机数/ 相同/ ./ Ii/ ,/ Ij/ ,/ Io/ 和/ Iq/ 分别/ 对应/ 不同/ 的/ 网格/ 单元/ ,/ 每个/ 长度/ 在/ 程序/ 未/ 执行/ 前/ 未知/ ./ 同时/ ,/ 在/ 多次/ 迭代/ 中/ ,/ 共享/ 点/ 之间/ 的/ 距离/ 在/ 程序/ 未/ 执行/ 前/ 也/ 是/ 未知/ 的/ ./ 图/ 2/ 在/ 第/ l/ 次/ 迭代/ 中/ 各个/ 处理机/ 的/ 随机数/ 子/ 序列/ 3/ 基于/ 共享/ 与/ 分布/ 随机数/ 的/ 并行/ 粒子/ 发射/ 算法/ 在/ 我们/ 的/ 算法/ 中/ ,/ 每个/ 处理机/ 共享/ 与/ 串行/ 程序/ 有/ 相同/ 的/ 随机数/ 生成器/ ./ 针对/ 不同/ 处理机/ 之间/ 对/ 随机数/ 的/ 共享/ 和/ 分布/ 特性/ ,/ 将/ 该/ 随机数/ 生成器/ 产生/ 的/ 随机数/ 序列/ 分成/ 两/ 部分/ :/ (/ 1/ )/ 该/ 序列/ 的/ 前/ 2N/ 个/ 随机数/ 组成/ 共享/ 区/ ./ 第/ 2l/ -/ 1/ 和/ 2l/ 个/ 随机数/ 对应/ 第/ l/ 次/ 迭代/ (/ l/ =/ 1/ ,/ …/ ,/ N/ )/ ./ 其中/ N/ 为/ 程序/ 终止/ 时/ 所/ 需/ 的/ 迭代/ 次数/ ./ (/ 2/ )/ 从/ 该/ 序列/ 的/ 第/ 2N/ +/ 1/ 个/ 随机数/ 起/ ,/ 组成/ 分布区/ ./ 3.1/ 共享/ 区/ 随机数/ 生成/ 在/ 初始化/ 部分/ ,/ 每个/ 处理机/ 将/ 上述/ 的/ 随机数/ 产生器/ 产生/ 的/ 前/ 2N/ 个/ 随机数/ 保存起来/ ,/ 记为/ Ai/ ./ 这/ 2N/ 个/ 随机数/ 组成/ 了/ 共享/ 区/ ./ 3.2/ 分布区/ 随机数/ 生成/ 对于/ 上述/ 随机数/ 产生器/ 产生/ 的/ 随机数/ 序列/ ,/ 从/ 2N/ +/ 1/ 个/ 开始/ 的/ 多个/ 随机数/ 组成/ 了/ 分布区/ ./ 对/ 第/ p/ 个/ 处理机/ ,/ 每次/ 从/ 分布区/ 间隔/ NP/ 个/ 获得/ 下/ 一个/ 随机数/ ./ 记为/ xjNP/ ,/ j/ =/ 1/ ,/ …/ ,/ Jl/ 代中/ 第/ p/ 个/ 处理机/ 从/ 分布区/ 获取/ 的/ 随机数/ 个数/ ./ 不同/ 处理机/ 的/ Jl/ 的/ 值/ ./ 图/ 3/ 给出/ 了/ 第/ l/ 次/ 迭代/ 中/ 不同/ 处理机/ 的/ 随机/ Page4/ 数/ 分组/ 示意图/ ./ 图/ 3/ 中/ xj3/ ./ 3/ 并行/ 粒子/ 发射/ 算法/ 假设/ 在/ 第/ l/ 次/ 迭代/ 中/ ,/ 每个/ 处理机/ 均/ 已/ 拥有/ 其所/ 分配/ 的/ 子/ 网格/ 及/ 影像/ 单元/ 的/ 电场/ 数据/ ,/ 根据上述/ 对/ 共享/ 区/ 和/ 分布区/ 随机数/ 的/ 产生/ 方法/ ,/ 形成/ 如下/ 的/ 并行/ 粒子/ 发射/ 算法/ ./ 算法/ 2/ ./ 并行/ 粒子/ 发射/ 算法/ ./ 输入/ :/ 发射区/ 网格/ 、/ 电场/ E/ 、/ 已/ 发射/ 电子/ 电荷/ 量/ 输出/ :/ 更新/ 的/ 已/ 发射/ 电子/ 电荷/ 量/ ,/ 新/ 发射/ 的/ 0/ 或/ 多个/ 粒子/ FORallpiniterationldo/ 从/ 共享/ 区/ 获得/ 随机数/ A2l/ -/ 1/ 和/ A2l/ ,/ 分别/ 用于/ 计算/ 网格/ 序号/ G1/ 和/ G2/ ;/ 根据/ G1/ 和/ G2/ 确定/ 实际/ 发射/ 区间/ 网格/ 序号/ 的/ 起点/ M1/ 和/ 终点/ M2/ ;/ DOi/ =/ M1/ ,/ M2IF/ (/ 网格/ i/ 在/ 处理机/ p/ 中/ )/ ENDFOR3/ ./ 4/ 分析/ 注意/ 到/ 上述/ 并行算法/ 中/ ,/ Ai/ 和/ xj/ 数/ 序列/ 中/ 出现/ 的/ 位置/ 与/ 串行/ 算法/ 已/ 完全/ 不同/ ./ 但是/ ,/ 如果/ 多个/ 处理机/ 所/ 共享/ 的/ 随机数/ 序列/ 可以/ 保证/ 每个/ 随机数/ 之间/ 是/ 统计/ 无关/ 的/ ,/ 那么/ 在/ 上述/ 并行算法/ 中/ ,/ 仍然/ 可以/ 保证/ 如下/ 3/ 个/ 特性/ :/ (/ 1/ )/ 共享/ 区/ 多个/ 随机数/ Ai/ 之间/ 是/ 统计/ 无关/ 的/ ./ (/ 2/ )/ 分布区/ 多个/ 随机数/ xj/ (/ 3/ )/ 共享/ 区/ 和/ 分布区/ 之间/ 的/ 随机数/ 是/ 统计/ 无关/ 的/ ./ 在/ 上述/ 并行/ 粒子/ 发射/ 算法/ 中/ ,/ 由于/ 每个/ 处理机/ 独立/ 地/ 完成/ 粒子/ 随机/ 发射/ ,/ 不/ 需要/ 通信/ ,/ 因此/ ,/ 如果/ 粒子/ 发射/ 网格/ 均匀分布/ 在/ 处理机/ 上时/ ,/ 上述/ 算法/ 的/ 加速/ 比/ 将/ 正比/ 于/ 处理机/ 的/ 个数/ NP/ ./ 4/ 应用/ 将/ 上述/ 并行算法/ 应用/ 于/ 三维/ 电磁/ PIC/ 模拟程序/ NEPTUNE3D/ 中/ ,/ 该/ 程序/ 的/ 基本/ 框架/ 如图/ 4/ 所示/ ./ 在/ 每次/ 迭代/ 中/ ,/ 均/ 需要/ 多个/ 处理机/ 并行执行/ 粒子/ 发射/ 模块/ ./ 在/ 迭代/ 到/ 一定/ 次数/ 满足/ 相关/ 条件/ 后/ ,/ 随着/ 高功率/ 微波/ 源/ 器件/ 内/ 的/ 电磁场/ 变化/ ,/ 该/ 器件/ 内部/ 的/ 发射/ 区域/ 将/ 发射/ 出/ 粒子/ ./ 图/ 5/ 给出/ 了/ 一/ 典型/ 高功率/ 微波/ 源/ 器件/ —/ —/ —/ 带/ 支撑杆/ 的/ MILO/ (/ 磁/ 绝缘体/ 振荡器/ )/ 器件/ 的/ 几何/ 图像/ ./ 图/ 5/ (/ a/ )/ 为/ 三维/ 透视图/ ,/ 图/ 5/ (/ b/ )/ 为/ YZ/ 截面图/ ./ 在/ 长方体/ 网格/ 上/ ,/ 以/ 1184635/ 个/ 网格/ 单元/ 离散/ 计算/ 区域/ ./ 图/ 6/ 给出/ 了/ 在/ 128/ 台/ 处理机/ 上/ ,/ 粒子/ 个数/ 随/ 时间/ 的/ 变化/ 曲线/ ./ 在/ 零/ 时刻/ ,/ 粒子/ 个数/ 为/ 0/ ,/ 表明/ 器件/ 中/ 无/ 粒子/ 存在/ ;/ 随着/ 时间/ 的/ 推移/ ,/ 器件/ 内/ 发射/ 出/ 粒子/ ,/ 在/ 5ns/ 左右/ 粒子/ 个数/ 激增/ 到/ 上百万/ 个/ ;/ 随后/ 在/ 10ns/ 左右/ 粒子/ 个数/ 趋于稳定/ ./ 图/ 6/ 粒子/ 数/ 时变/ 曲线/ (/ 横轴/ 为/ 模拟/ 时间/ ,/ 纵轴/ 为/ 粒子/ 数/ )/ Page5/ 粒子/ 相空间/ 分析/ 是/ 物理/ 定量分析/ 的/ 重要/ 组成部分/ ./ 在/ 高功率/ 微波/ 电磁/ PIC/ 模拟程序/ 中/ 采用/ 上述/ 的/ 并行/ 粒子/ 发射/ 算法/ ,/ 图/ 7/ 中/ 给出/ 了/ 在/ 128/ 台/ 处理机/ 上/ 程序执行/ 到/ 15.5/ ns/ 后/ 得到/ 的/ 粒子/ 相空间/ 图像/ ,/ 其中/ 横轴/ 为/ 粒子/ 在/ z/ 向/ 的/ 位置/ ,/ 纵轴/ 为/ 粒子/ 动量/ ./ 该/ 图图/ 7t/ =/ 15.5/ ns/ 时/ Pz/ -/ Z/ 粒子/ 相空间/ 图像/ 采用/ 上述/ 并行/ 粒子/ 发射/ 算法/ 的/ NEPTUNE3D/ 程序/ 已/ 应用/ 于/ 多种/ 高功率/ 微波/ 源/ 器件/ 的/ 模拟/ 设计/ 中/ ,/ 例如/ ,/ 磁/ 绝缘/ 振荡器/ 、/ 相对论/ 返波管/ (/ RBWO/ )/ 等/ ,/ 并/ 与/ 国际/ 公认/ 的/ 同类/ 软件/ KARAT3D/ 的/ 计算结果/ 进行/ 了/ 比/ 对/ ./ 由于/ 微观/ 的/ 粒子/ 发射/ 最终/ 会/ 影响/ 宏观/ 的/ 物理量/ ,/ 因此/ 我们/ 在/ NEPTUNE3D/ 上/ 采用/ 400/ 万个/ 网格/ 单元/ 、/ 150/ 万个/ 粒子/ 模拟/ 相对论/ 返波管/ 时/ ,/ 分别/ 与/ KARAT3D/ 软件/ 比较/ 了/ 稳态/ 后/ 器件/ 中/ 关键/ 的/ 几个/ 物理量/ ,/ 包括/ 二极管/ 电压/ 、/ 电流/ 、/ 输出/ 能量/ 和/ 频率/ ,/ 结果/ 与/ KARAT3D/ 基本/ 相当/ ./ 更/ 详细/ 的/ 结果/ 可/ 参见/ 文献/ [/ 12/ -/ 13/ ]/ ./ 表/ 1NEPTUNE3D/ 与/ KARAT3D/ 模拟/ RBWO/ 的/ 计算结果/ 比较/ (/ 400/ 万/ 网格/ 、/ 150/ 万/ 粒子/ 、/ 采用/ 算法/ 2/ 和/ 选自/ 文献/ [/ 13/ ]/ )/ 程序/ 二极管/ NEPTUNE3D7505/ ./ 03509.3/ KARAT3D7624/ ./ 93609.35/ 结论/ 和/ 下/ 一步/ 工作/ 在/ 高功率/ 微波/ 源/ 器件/ 三维/ 电磁/ PIC/ 数值/ 模拟/ 中/ ,/ 粒子/ 发射/ 是/ 其中/ 一个/ 重要环节/ ./ 本文/ 首先/ 研究/ 了/ 束流/ 方式/ 下/ 的/ 粒子/ 并行/ 随机/ 生成/ 规律/ ./ 在/ 该/ 应用/ 中/ ,/ 对/ 随机数/ 序列/ 中/ 的/ 随机数/ 存在/ 两种/ 需求/ :/ 其中/ 一些/ 随机数/ 需要/ 在/ 多台/ 处理机/ 上/ 共享/ ,/ 而/ 其他/ 随机数/ 则/ 分布/ 在/ 不同/ 处理机/ 中/ ./ 这种/ 共享/ 与/ 分布/ 需求/ 存在/ 非/ 反映/ 了/ 在/ 累积到/ 一定/ 时刻/ 后/ 整个/ 器件/ 中/ 粒子/ 速度/ 与/ 空间/ 位置/ 之间/ 的/ 关系/ ,/ 可以/ 帮助/ 物理/ 人员/ 分析/ 粒子/ 动能/ 与/ 电磁/ 能量/ 之间/ 的/ 转换/ ./ 图/ 7/ 中/ 也/ 给出/ 了/ 串行/ 程序/ 的/ 粒子/ 相空间/ 图像/ ,/ 可/ 看出/ ,/ 并行程序/ 可以/ 较/ 好/ 地/ 吻合/ 串行/ 程序/ 得到/ 的/ 粒子/ 相空间/ 物理/ 图像/ ./ 确定性/ ,/ 即/ 在/ 程序运行/ 前/ 多台/ 处理机/ 共享/ 随机数/ 序列/ 中/ 的/ 哪些/ 随机数/ 是/ 未知/ 的/ ./ 为/ 满足/ 对/ 并行/ 随机数/ 的/ 共享/ 和/ 分布/ 需求/ ,/ 本文/ 提出/ 了/ 一种/ 基于/ 共享/ 与/ 分布/ 随机数/ 的/ 粒子/ 并行/ 发射/ 算法/ ./ 对于/ 同一/ 随机数/ 序列/ ,/ 将/ 该/ 序列/ 分为/ 共享/ 区/ 和/ 分布区/ ,/ 多台/ 处理机/ 将/ 拥有/ 共享/ 区/ 的/ 全部/ 随机数/ ,/ 而/ 将/ 分布区/ 的/ 随机数/ 按照/ 进程/ 号/ 分组/ ,/ 并/ 分布/ 在/ 不同/ 处理机/ 上/ ./ 数值/ 实验/ 表明/ ,/ 在/ 采用/ 该/ 并行算法/ 的/ 情况/ 下/ ,/ 用/ 我们/ 的/ 三维/ 电磁/ PIC/ 并行程序/ 模拟/ 一/ 典型/ 高功率/ 微波/ 源/ 器件/ ,/ 得到/ 的/ 粒子/ 相空间/ 物理/ 图像/ 可以/ 较/ 好/ 地/ 与/ 串行/ 结果/ 吻合/ ./ 目前/ ,/ 本文/ 的/ 粒子/ 并行/ 随机/ 生成/ 算法/ 中/ ,/ 仍然/ 采用/ 的/ 是/ 与/ 串行/ 程序/ 一样/ 的/ 线性/ 同余/ 随机数/ 生成器/ ./ 随着/ 粒子/ 规模/ 的/ 增大/ ,/ 对/ 随机数/ 生成器/ 的/ 质量/ 要求/ 愈高/ ./ 下/ 一步/ 的/ 工作/ 包括/ 采用/ 高质量/ 的/ 随机数/ 生成/ 工具/ ,/ 例如/ SPRNG/ ,/ 来/ 进行/ 比较/ 和/ 分析/ ./ 致谢/ 感谢/ 北京/ 应用/ 物理/ 与/ 计算/ 数学/ 研究所/ 的/ 董烨/ ,/ 他/ 提供/ 了/ 计算/ 模型/ 参数/ !/ 

