Page1/ 科学计算/ 双路/ 并行/ I/ // O/ 优化/ 方法/ 曹立/ 强莫则/ 尧/ 沈卫/ 超夏芳/ 陈军/ (/ 北京/ 应用/ 物理/ 与/ 计算/ 数学/ 研究所/ 高性能/ 计算中心/ 北京/ 100094/ )/ 摘要/ 科学计算/ 数据/ 集由/ 数据/ 和/ 元/ 数据/ 组成/ ./ 一般/ 条件/ 下/ ,/ 数据/ 的/ 尺寸/ 较大/ ,/ 元/ 数据/ 尺寸/ 较/ 小/ ./ 传统/ 的/ 高性能/ 计算机/ 并行/ 文件系统/ 可以/ 高效率/ 地/ 读写/ 大块/ 连续/ 数据/ ,/ 但是/ 无法/ 高效率/ 地/ 读写/ 大量/ 较小块/ 的/ 元/ 数据/ ./ 一旦/ 大块/ 数据/ 和/ 小块/ 元/ 数据/ 两类/ 读写/ 特征/ 混杂/ 在/ 一起/ ,/ 元/ 数据/ 将/ 较/ 严重/ 地/ 干扰/ 并行/ I/ // O/ ,/ 造成/ 性能/ 的/ 下降/ ./ 为此/ ,/ 文中/ 提出/ 数据/ 与/ 元/ 数据/ 分治/ 的/ 双路/ 并行/ I/ // O/ 方法/ ./ 该/ 方法/ 在/ 高层/ I/ // O/ 库中/ 建立/ 内存/ 文件系统/ 与/ 并行/ 文件系统/ 两级/ 存储/ ,/ 在/ 存储资源/ 之间/ 并行/ 迁移/ 科学计算/ 元/ 数据/ ./ 一方面/ 降低/ 较/ 频繁/ 读写/ 元/ 数据/ 的/ I/ // O/ 延迟/ ,/ 另一方面/ 改变/ 科学计算/ 数据/ 的/ 存储/ 特征/ 与/ 存储/ 模式/ ,/ 从而/ 提高/ 科学计算/ 应用/ 、/ 尤其/ 是/ 数据分析/ 与/ 可视化/ 等/ 读入/ 密集型/ 应用/ 的/ I/ // O/ 效率/ ./ 测试表明/ ,/ 双路/ 并行/ I/ // O/ 方法/ 可/ 提高/ 写/ 性能/ 8/ %/ ~/ 13/ %/ ,/ 提高/ 读/ 性能/ 89/ %/ 到/ 1.01/ 倍/ ./ 关键词/ 并行/ I/ // O/ ;/ 高层/ I/ // O/ 库/ ;/ 性能/ 优化/ ;/ 数据格式/ ;/ 双路/ 并行/ I/ // O1/ 引言/ 科学计算/ 数据/ 场/ 由/ 数据/ 集合/ 组成/ ./ 数据/ 集合/ 包含/ 数据/ 与/ 元/ 数据/ ,/ 其中/ 数据/ 承载/ 计算/ ,/ 元/ 数据/ 记录/ 数据/ 的/ 名称/ 、/ 类型/ 、/ 位置/ 和/ 属性/ 等/ 信息/ ./ 在/ 实际/ 应用/ 中/ ,/ 科学计算/ 程序/ 多/ 使用/ HDF5/ (/ HierarchicalDataFormat5/ )/ ①/ 和/ NetCDF/ (/ NetworkCommonDataForm/ )/ ②/ 等/ 高层/ 库/ 读写/ 数据/ 集合/ ./ 这些/ 高层/ I/ // O/ 库有/ 面向/ 领域/ 的/ 存储/ 模型/ ,/ 可以/ 简化/ 研制/ 应用/ 的/ 复杂度/ ,/ 提高/ 科学/ 数据共享/ 水平/ ./ 科学计算/ 应用/ 大量/ 的/ 读写/ 数据/ 集合/ ./ 从/ I/ // O/ 特征/ 角度/ ,/ 多数/ 元/ 数据/ 尺寸/ 较/ 小/ ,/ 低于/ KB/ 量级/ ,/ 在/ 文件/ 中/ 存储/ 位置/ 分散/ ,/ 对/ I/ // O/ 性能/ 、/ 尤其/ 是/ 大规模/ 并行/ I/ // O/ 性能/ 有/ 一定/ 影响/ ./ 在/ BG/ // L/ 系统/ 上/ ,/ Yu/ 等/ 人/ [/ 1/ ]/ 使用/ FLASHI/ // O/ 和/ HOMME/ 等/ 应用程序/ 分析/ ParallelNetCDF/ 和/ HDF5/ 的/ 读写/ 性能/ ./ 相同/ 条件/ 中/ ,/ 使用/ HDF5/ 的/ 并行/ 输出/ 带宽/ 仅/ 相当于/ MPI/ -/ I/ // O/ 峰值/ 输出/ 带宽/ 的/ 10/ %/ 左右/ ,/ 使用/ ParallelNetCDF/ 的/ 并行/ 输出/ 带宽/ 仅/ 相当于/ MPI/ -/ I/ // O/ 峰值/ 带宽/ 的/ 20/ %/ ~/ 30/ %/ ./ 由于/ 元/ 数据/ 存取/ 的/ 需求/ ,/ 高层/ I/ // O/ 库/ 的/ 读写/ 数量/ 比/ MPI/ -/ I/ // O/ 高/ 2/ 倍/ 以上/ ,/ 并且/ 多数/ 情况/ 下/ 的/ 存取/ 粒度/ 较/ 小/ ,/ 位置/ 规律/ 不/ 明显/ ./ 这是/ 目前/ 高层/ I/ // O/ 库/ 效率/ 较/ 低/ 的/ 主要/ 原因/ 之一/ ./ 两/ 阶段/ I/ // O/ (/ TwoPhaseI/ // O/ )/ [/ 2/ ]/ 与/ 数据/ 过滤/ (/ DataSieving/ )/ [/ 3/ ]/ 等/ 方法/ 可/ 提高/ 小/ 块/ 数据/ 的/ I/ // O/ 性能/ ,/ 但是/ 这些/ 方法/ 主要/ 面向/ 密集/ 非/ 连续/ 存储/ 的/ 特征/ ,/ 与/ 元/ 数据/ 的/ 小块/ 松散/ 非/ 连续/ 特征/ 不/ 一致/ ./ 在/ BG/ // P/ 平台/ 的/ FlashI/ // O/ 测试程序/ 中/ ,/ Latham/ 等/ 人/ [/ 4/ ]/ 依次/ 使用/ 集合/ I/ // O/ 、/ 列/ 存储/ 、/ 非/ 阻塞/ I/ // O/ 等/ 方法/ 优化/ 高层/ I/ // O/ 库/ ParallelNetCDF/ 性能/ ./ 实验/ 环境/ 中/ ,/ 非/ 阻塞/ I/ // O/ 方法/ 有/ 最高/ 的/ 带宽/ 和/ 最好/ 的/ 可扩展性/ ./ 在/ 搭配/ 65536/ 处理器/ 时/ 取得/ 近/ 8GB/ // s/ 的/ 输出/ 带宽/ ,/ 接近/ 文件系统/ 读写/ 带宽/ 的/ 80/ %/ ./ 然而/ ,/ 非/ 阻塞/ I/ // O/ 是/ 一种/ 使用/ 内存/ 缓存数据/ 的/ I/ // O/ 方法/ ./ 当/ 数据/ 规模/ 较大/ 时/ ,/ 非/ 阻塞/ I/ // O/ 会/ 较/ 大幅度降低/ 系统/ 可用内存/ 数量/ ./ 数据/ 的/ 层次化/ 存储/ 是/ 充分/ 利用计算机/ 资源/ ,/ 提高/ I/ // O/ 带宽/ 、/ 缩短/ I/ // O/ 延迟/ 的/ 有效/ 方法/ ./ 其/ 主要/ 挑战/ 一方面/ 在于/ 构建/ 有效/ 的/ 层次/ 存储/ 结构/ ,/ 另一方面/ 在于/ 高效/ 利用/ 近线/ 存储资源/ ./ 文件系统/ 缓存/ 与/ I/ // O/ 代理/ (/ I/ // ODelegationCache/ ,/ IODC/ )/ [/ 5/ -/ 6/ ]/ 可/ 降低/ I/ // O/ 延迟/ ,/ 提高/ I/ // O/ 效率/ ./ 然而/ 许多/ 科学计算/ 数据/ 的/ 规模/ 较大/ ,/ 其中/ 大部分/ 应用/ 对/ 数据/ 有/ 一/ 过性/ 访问/ 的/ 特征/ ./ 缓存/ 与/ I/ // O/ 代理/ 的/ 容量/ 较/ 小/ ,/ 在/ 没有/ 应用/ 指导/ 数据/ 替换/ 策略/ 时/ ,/ 往往/ 不能/ 充分发挥/ 缓存/ 与/ 代理/ 的/ 性能/ ./ IOFSL/ (/ I/ // OForwardingScalabilityLayer/ )/ [/ 7/ -/ 8/ ]/ 是/ 美国/ Argonne/ 实验室/ 、/ LosAlamos/ 实验室/ 和/ Sandia/ 实验室/ 等/ 机构/ 联合/ 研制/ 的/ 可/ 扩展/ I/ // O/ 框架/ ./ 该/ 框架/ 位于/ 高层/ I/ // O/ 库/ 与/ 文件系统/ 之间/ ,/ 使用/ 专有/ 的/ I/ // O/ 节点/ 聚合/ 、/ 转发/ 高层/ I/ // O/ 调用/ ,/ 提高效率/ ./ I/ // OForwarding/ 可以/ 降低/ I/ // O/ 节点/ 竞争/ ,/ 减少/ 数据/ 拥塞/ ,/ 提高/ 大规模/ 并行/ 条件/ 下/ 的/ 可扩展性/ ./ 然而/ ,/ I/ // OForwarding/ 增加/ 了/ 数据/ 的/ 移动/ 距离/ ,/ 当/ I/ // O/ 连续性/ 较/ 好/ ,/ 形成/ 流水线/ 时/ ,/ IOFSL/ 有/ 较/ 高/ 的/ 效率/ ./ 一旦/ I/ // O/ 连续性/ 较弱/ 或者/ 完全/ 随机/ 时/ ,/ IOFSL/ 的/ 效率/ 将/ 受到/ 影响/ ./ 较长时间/ 以来/ ,/ 并行/ 科学计算/ 应用/ 的/ I/ // O/ 面临/ 瓶颈/ 制约/ ./ 本文/ 在/ 应用/ 并行/ I/ // O/ 过程/ 中/ 使用/ 内存/ 文件系统/ 与/ 并行/ 文件系统/ 构建/ 两级/ 存储/ 结构/ ./ 改变/ 高层/ I/ // O/ 库/ 的/ 数据/ 、/ 元/ 数据/ 混合/ 存储/ 为/ 数据/ 、/ 元/ 数据/ 分类/ 存储/ ./ 在/ 并行/ I/ // O/ 过程/ 中/ 迁移/ 规模较/ 小/ 但是/ 存取/ 频次/ 却/ 较/ 高/ 的/ 元/ 数据文件/ 到/ 局部/ 内存/ 文件系统/ ./ 一方面/ 降低/ 元/ 数据/ I/ // O/ 的/ 总/ 延迟/ ,/ 另一方面/ 改善/ 数据/ 在/ 文件系统/ 的/ 存储/ 布局/ ,/ 提高/ 应用程序/ 可/ 获得/ 的/ I/ // O/ 带宽/ ./ 本文/ 的/ 创新/ 主要/ 在于/ :/ (/ 1/ )/ 数据/ 迁移/ 技术/ 在/ 并行/ I/ // O/ 领域/ 的/ 应用/ ./ 已有/ 的/ 数据/ 迁移/ 技术/ 一般/ 应用/ 虚拟化/ 存储/ 等/ 领域/ ,/ 在/ 保障/ 存储资源/ 性能/ 的/ 同时/ 降低/ 单位成本/ ./ 本文/ 将/ 其/ 应用/ 于/ 并行/ I/ // O/ 性能/ 优化/ 中/ ,/ 提高/ 粒度/ 较/ 小/ ,/ 但/ 存取/ 较/ 频繁/ 的/ 元/ 数据/ I/ // O/ 性能/ ,/ 提高/ 并行/ I/ // O/ 效率/ ;/ (/ 2/ )/ 本文/ 将/ 数据/ 、/ 元/ 数据/ 分类/ 存储/ 模式/ 与/ 并行/ I/ // O/ 结合/ ,/ 提出/ 元/ 数据/ 分组/ 并行/ I/ // O/ 模式/ ,/ 在/ 并行/ 环境/ 中/ 保障/ 元/ 数据/ 存储/ 一致性/ ;/ (/ 3/ )/ 本文/ 利用/ 高性能/ 计算机/ 的/ 局部/ 内存/ 文件系统/ 改变/ 并行/ I/ // O/ 特征/ ,/ 优化/ 数据/ 、/ 元/ 数据/ 的/ 存储/ 布局/ ,/ 加速/ 数据/ I/ // O/ ./ 本文/ 第/ 2/ 节/ 介绍/ 高层/ I/ // O/ 库/ ;/ 第/ 3/ 节/ 分析/ 高层/ I/ // O/ 库/ 的/ 存储/ 特征/ ;/ 第/ 4/ 节/ 介绍/ 双路/ 并行/ I/ // O/ 库/ DCPL/ (/ DoubleChannelParallelI/ // OLibrary/ )/ 的/ 结构设计/ ;/ 第/ 5/ 节是/ DCPL/ 的/ 串/ 、/ 并行/ 实现/ ;/ 第/ 6/ 节是/ DCPL/ 的/ 单/ 节点/ 性能/ 分析/ ;/ 第/ 7/ 节是/ 并行/ 应用/ 测试/ ;/ 第/ 8/ 节是/ 结论/ ./ 2/ 高层/ I/ // O/ 库/ 简介/ 科学计算/ 高层/ I/ // O/ 库/ 主要/ 管理/ 集合/ 形式/ 的/ 科/ ①/ ②/ Page3/ 学/ 计算/ 数据/ ./ 科学计算/ 数据/ 场/ 由/ 大量/ 的/ 数据/ 集合/ 组成/ ./ 一个/ 数据/ 集合/ 可以/ 抽象/ 表示/ 为/ 〈/ 数据/ ,/ 元/ 数据/ 〉/ 二元/ 组/ ./ 其中/ 元/ 数据/ 是/ 用于/ 管理/ 数据/ 的/ 数据/ ./ 有/ 了/ 元/ 数据/ ,/ 高层/ I/ // O/ 流程/ 可以/ 分为/ 两/ 部分/ :/ 数据/ I/ // O/ 与/ 元/ 数据/ I/ // O/ ./ 以/ 读数据/ 为例/ ,/ 高层/ I/ // O/ 库/ 的/ 读写/ 步骤/ 一般/ 如图/ 1/ 所示/ ./ 图/ 1/ 的/ 调用/ 分为/ 6/ 个/ 步骤/ :/ 第/ 1/ 步/ ,/ 科学计算/ 程序/ 调用/ 高层/ I/ // O/ 接口/ ;/ 第/ 2/ 步/ ,/ 高层/ I/ // O/ 库/ 定位/ 元/ 数据/ ;/ 第/ 3/ 步/ ,/ 高层/ I/ // O/ 读取/ 元/ 数据/ 并/ 解析/ 其中/ 关于/ 数据/ 的/ 描述/ ,/ 获取数据/ 类型/ 与/ 存储/ 位置/ 等/ 信息/ ;/ 第/ 4/ 步/ ,/ 根据/ 元/ 数据/ 指示/ ,/ 高层/ I/ // O/ 库/ 验证/ 数据/ 的/ 偏移/ 、/ 类型/ 与/ 数量/ ;/ 第/ 5/ 步/ ,/ 高层/ I/ // O/ 库/ 读取数据/ ,/ 并/ 根据/ 需要/ 解码/ 、/ 转换/ 类型/ ;/ 第/ 6/ 步/ ,/ 高层/ I/ // O/ 库/ 返回/ 调用/ ./ 使用/ 高层/ I/ // O/ 库写/ 数据/ 的/ 过程/ 与/ 读数据/ 过程/ 相似/ ,/ 也/ 包含/ 写元/ 数据/ 和/ 写/ 数据/ 两个/ 步骤/ ./ 一些/ 数据管理/ 能力/ 较强/ 的/ 高层/ I/ // O/ 库/ ,/ 例如/ HDF5/ 等/ ,/ 使用/ B/ 树/ 等/ 索引/ 算法/ 为元/ 数据/ 建立/ 索引/ ,/ 提高/ 上述/ 过程/ 中/ 第/ 2/ 步元/ 数据/ 定位/ 的/ 速度/ ./ 并行/ 环境/ 中/ ,/ 高层/ 库/ 的/ I/ // O/ 模式/ 主要/ 有/ 两种/ :/ 进程/ -/ 文件/ 对应/ (/ File/ -/ per/ -/ process/ )/ 模式/ 和/ 共享/ 文件/ (/ Sharedfile/ )/ 模式/ ./ 虽然/ 同/ 为/ 并行/ I/ // O/ ,/ 但是/ 前者/ 进程/ 间/ 无/ 共享/ 数据/ ./ 参与/ 并行/ I/ // O/ 的/ 进程/ 读写/ 各自/ 文件/ ./ 元/ 数据/ 与/ 数据/ 是/ 私有/ 的/ ,/ 有/ 进程/ 属性/ ,/ 其/ 流程/ 与/ 串行/ 过程/ 相似/ ./ 共享/ 文件/ 模式/ 中/ ,/ 并行/ 文件系统/ 提供/ 基本/ 的/ 全局/ 文件/ 视图/ ./ 高层/ I/ // O/ 库/ 在/ 进程/ 间/ 管理/ 、/ 分配/ 元/ 数据/ 与/ 数据/ ./ 数据/ 输出/ 时/ ,/ 它/ 一般/ 采取/ 元/ 数据/ 串行/ I/ // O/ 、/ 数据/ 并行/ I/ // O/ 的/ 方式/ 保障/ 数据/ 存储/ 一致性/ ./ 参与/ 并行/ I/ // O/ 的/ 主/ 进程/ 不仅/ 要/ 管理/ 元/ 数据/ ,/ 还要/ 在/ 进程/ 间/ 切分/ 数据/ 集合/ ,/ 然后/ 由主/ 、/ 从/ 进程/ 共同/ 写/ 数据/ ./ 数据/ 读入/ 时/ ,/ 仍然/ 由主/ 进程/ 读取/ 元/ 数据/ ,/ 然后/ 切分/ 数据/ 集合/ ,/ 主/ 、/ 从/ 进程/ 并行/ 读入/ 数据/ ./ 在/ 科学计算/ 领域/ ,/ 目前/ 高层/ I/ // O/ 库/ 的/ 两个/ 比较/ 重要/ 实现/ 是/ HDF5/ 和/ NetCDF/ ./ HDF5/ 是/ 美国/ 国家/ 超算/ 应用/ 中心/ (/ NationalCenterforSupercomputerApplications/ ,/ NCSA/ )/ 面向/ 科学/ 数据/ 存储/ 研制/ 的/ 一种/ 文件格式/ ./ HDF5/ 支持/ 集合/ 数据/ 的/ I/ // O/ ./ 一个/ HDF5/ 数据/ 集合/ 由/ 数据/ 与/ 元/ 数据/ 两/ 部分/ 组成/ ./ 其中/ 的/ 元/ 数据/ 包括/ 数据/ 的/ 名称/ 、/ 属性/ 、/ 类型/ 、/ 编码方式/ 、/ I/ // O/ 方式/ 等/ 说明/ 信息/ ./ HDF5/ 使用/ B/ 树为/ 数据/ 集/ 建立/ 索引/ ,/ 支持/ 十亿/ 量级/ 的/ 数据/ 查询/ 与/ PB/ 以上/ 量级/ 的/ 数据/ 存储/ ./ HDF5/ 兼容/ 多种/ 操作系统/ ,/ 支持/ 多种/ I/ // O/ 方式/ ,/ 包括/ 系统/ 调用/ 、/ 标准/ I/ // O/ 、/ MPI/ -/ I/ // O/ 等/ ./ 此外/ ,/ HDF5/ 格式/ 有/ 跨平台/ 和/ 自描述/ 特征/ ./ 使用/ HDF5/ 存储/ 的/ 科学/ 数据/ ,/ 可以/ 不/ 依赖/ 文件/ 外/ 的/ 信息/ 还原/ 到/ 其他/ 节点/ ./ 并行/ HDF5/ 是/ HDF5/ 的/ 一种/ I/ // O/ 方式/ ./ 它/ 支持/ 进程/ 并行/ 读写/ 数据/ 集中/ 的/ 数据/ ./ 目前/ ,/ HDF5/ 在/ 科学/ 数据/ 存储/ 领域/ 有/ 较/ 广泛/ 的/ 应用/ ./ 除了/ 较/ 多/ 的/ 计算/ 应用/ 外/ ,/ 一些/ 知名/ 的/ 项目/ 还/ 包括/ HDF/ -/ EOS/ 和/ BioHDF/ 等/ [/ 9/ -/ 10/ ]/ ./ NetCDF/ 是/ 美国/ 大气/ 研究/ 综合/ 协会/ (/ UniversityCorporationforAtmosphericResearch/ ,/ UCAR/ )/ 研制/ 的/ 一种/ 跨/ 网络/ 数据/ 存储/ 格式/ ./ 它/ 支持/ 数据/ 集合/ 的/ 跨平台/ 存储/ 与/ 共享/ ./ 一个/ NetCDF/ 的/ 数据/ 集合/ 包括/ 数据/ 与/ 元/ 数据/ 两/ 部分/ ./ 其中/ 数据/ 有/ 唯一/ 的/ 名称/ ,/ 并/ 使用/ 唯一/ 的/ ID/ 指代/ ,/ 元/ 数据/ 包含/ 维长/ 、/ 变量/ 名称/ 与/ 属性/ 等/ 信息/ ./ NetCDF/ 兼容/ 多种/ 操作系统/ ,/ 有/ 跨平台/ 和/ 自描述/ 特征/ ./ 它/ 使用/ XDR/ ①/ 或者/ HDF5/ 存储/ 数据/ ./ 一个/ NetCDF/ 文件/ ,/ 可以/ 不/ 依赖/ 文件/ 外/ 的/ 信息/ 还原/ 到/ 其他/ 节点/ ./ ParalleNetCDF/ 是/ 对/ NetCDF/ 的/ 并行/ 扩展/ ,/ 它/ 在/ 并行/ I/ // O/ 中/ 支持/ 共享/ 文件/ 模式/ 的/ 数据/ 集/ 共享/ [/ 11/ ]/ ./ 目前/ ,/ NetCDF/ 和/ ParallelNetCDF/ 在/ 环境/ 和/ 气象/ 科学计算/ 领域/ 有/ 较/ 广泛/ 的/ 应用/ ./ 3/ 高层/ I/ // O/ 库/ 的/ 存储/ 特征/ 元/ 数据/ 占据/ 文件/ 的/ 一部分/ 存储资源/ ./ 它/ 改变/ 了/ 科学计算/ 数据/ 在/ 文件/ 中/ 的/ 存储/ 布局/ ./ 以/ Lared/ -/ P/ [/ 12/ ]/ 科学计算/ 应用/ 的/ HDF5/ 数据/ 为例/ ./ Lared/ -/ P/ 是/ 基于/ JASMIN/ 框架/ [/ 13/ -/ 14/ ]/ 研制/ 的/ 并行计算/ 程序/ ./ 它/ 在/ 笛卡尔/ 坐标系/ 内/ 求解/ 电磁场/ Maxwell/ 方程/ 、/ 静电势/ Poission/ 方程/ 和/ 粒子/ 云/ 运动/ 等/ 方程/ ,/ 保存/ 计算结果/ 用于/ 可视化/ 分析/ 与/ 程序/ 重启动/ ./ 分析/ Lared/ -/ P/ 中/ HDF5/ 相关/ 的/ 调用/ ,/ 80/ %/ 以上/ 用于/ 存取数据/ 的/ 名称/ 、/ 位置/ 、/ 类型/ 和/ 属性/ 等/ 元/ 数据/ 信息/ ./ 解剖/ 典型/ 可视化/ 文件/ 中/ 数据/ 、/ 元/ 数据分布/ 如图/ 2/ 所示/ ./ 图中/ 每个/ 块/ 大小/ 8KB/ ,/ 浅色/ 代表/ 数据/ ,/ 深色/ 代表/ 元/ 数据/ ./ ①/ ExternalDataRepresentation/ ./ http/ :/ // // tools/ ./ ietf/ ./ org/ // html/ // Page4/ 从/ 存储/ 规模/ 上/ 分析/ ,/ Lared/ -/ P/ 数据/ 场/ 的/ 元/ 数据/ 仅/ 占/ 总/ 数据/ 存储/ 规模/ 的/ 4.2/ %/ ./ 较少/ 的/ 元/ 数据/ 间隔/ 存储/ 于/ 数据/ 中/ ,/ 一方面/ 降低/ 了/ 文件系统/ 缓存/ 效率/ ,/ 另一方面/ 增加/ 了/ I/ // O/ 操作/ 的/ 不连续性/ ./ 并/ 不是/ 所有/ 数据/ 场/ 的/ 数据/ 与/ 元/ 数据/ 交替/ 存储/ ,/ 但是/ 这种/ 大量/ 数据/ 与/ 较/ 少元/ 数据/ 交替/ 存储/ 的/ 形式/ 在/ 科学计算/ 数据/ 场/ 中长期/ 存在/ ./ 这种/ 数据/ 与/ 元/ 数据/ 交替/ 存储/ 的/ 形式/ ,/ 不仅/ 不能/ 充分利用/ 当前/ 并行/ 文件系统/ 的/ 带宽/ ,/ 也/ 不利于/ 数据/ 再/ 分析/ 中/ 快速/ 获取数据/ 场/ 的/ 概要/ 信息/ ./ 4/ 双路/ 并行/ I/ // O/ 的/ 结构设计/ 高层/ I/ // O/ 库/ 位于/ 并行/ 应用/ 与/ 并行/ 文件系统/ 之间/ ,/ 它/ 可以/ 屏蔽/ 文件系统/ 的/ 差异/ ./ 利用/ 这一/ 性质/ ,/ 我们/ 设计/ 双路/ 并行/ I/ // O/ 库/ DCPL/ (/ DoubleChannelParallelI/ // OLibrary/ )/ ./ DCPL/ 面向/ 科学计算/ 数据/ 集合/ 存储/ 需求/ ./ 支持/ 结构/ 网格/ 、/ 非/ 结构/ 网格/ 和/ 无/ 网格/ 数据/ 存取/ 与/ 管理/ ./ 与/ HDF5/ 和/ NetCDF/ 相似/ ,/ 一个/ DCPL/ 数据/ 集合/ 包括/ 数据/ 和/ 元/ 数据/ 两/ 部分/ ,/ 其中/ 的/ 元/ 数据/ 包括/ 网格/ 类型/ 、/ 属性/ 、/ 编码方式/ 等/ 说明/ 信息/ ./ DCPL/ 使用/ B/ +/ 索引/ 算法/ 对/ 数据/ 集合/ 建立/ 索引/ ,/ 提高/ 数据管理/ 能力/ ./ 目前/ ,/ DCPL/ 已经/ 在/ JASMIN/ 等/ 编程/ 框架/ 中/ 提高/ 大规模/ 并行/ 应用/ 的/ I/ // O/ 效率/ ./ DCPL/ 在/ 单/ 节点/ 内/ 的/ 结构/ 如图/ 3/ 所示/ ./ 使用/ DCPL/ 输出/ 时/ ,/ 数据/ 直接/ 输出/ 到/ 文件系统/ ./ 元/ 数据/ 首先/ 暂存/ 于/ 内存/ 文件系统/ ,/ 待/ DCPL/ 关闭/ 时/ 迁入/ 到/ 文件系统/ ,/ 形成/ 独立/ 的/ 元/ 数据文件/ ./ 读入/ 过程/ 则/ 反之/ ./ 元/ 数据文件/ 首先/ 从/ 文件系统/ 迁入/ 到/ 内存/ 文件系统/ ,/ 然后/ 是/ 元/ 数据/ 与/ 数据/ 的/ 读入/ ./ 内存/ 文件系统/ 有/ 高带宽/ 、/ 低/ 延迟/ 的/ 特征/ ,/ 但是/ 它/ 的/ 容量/ 较/ 小/ ,/ 而且/ 不能/ 永久/ 保存/ 数据/ ./ 并行/ 文件系统/ 有/ 较/ 高/ 的/ 带宽/ ,/ 但是/ 多数/ 条件/ 下/ 延迟/ 较/ 高/ ,/ I/ // O/ 性能/ 受/ I/ // O/ 特征/ 影响/ 较大/ ./ 元/ 数据/ 的/ 暂存/ 与/ 迁移/ 不仅/ 改/ 进程/ -/ 文件/ 对应/ 模式/ 中/ ,/ 参与/ 并行/ I/ // O/ 进程/ 在/ 局部/ 的/ 内存/ 文件系统/ 与/ 全局/ 文件系统/ 间/ 并行/ 迁移/ 元/ 数据/ ./ 此时/ ,/ 每/ 一个/ 进程/ 对应/ 两个/ 文件/ :/ 直接/ 读写/ 的/ 数据文件/ 和/ 迁移/ 的/ 元/ 数据文件/ ./ 进程/ -/ 文件/ 对应/ 模式/ 面临/ 较/ 多/ 数量/ 元/ 数据文件/ 的/ 迁移/ 问题/ ./ 为此/ ,/ 我们/ 设计/ 元/ 数据/ 分组/ 并行/ I/ // O/ 模式/ 作为/ 进程/ -/ 文件/ 对应/ 模式/ 的/ 补充/ ./ 元/ 数据/ 分组/ 并行/ I/ // O/ 模式/ 中/ ,/ 数据/ I/ // O/ 模式/ 与/ 进程/ -/ 文件/ 对应/ 模式/ 一致/ ,/ 但是/ 它/ 的/ 元/ 数据/ I/ // O/ 分组/ ,/ 一组/ 对应/ 一个/ 文件/ ./ 组内主/ 进程/ 维护/ 元/ 数据/ 并行/ 迁移/ 过程/ 中/ 存储/ 一致性/ ./ 其/ 体系结构/ 如图/ 4/ 所示/ ./ 变/ 了/ 数据/ 和/ 元/ 数据/ 的/ 存储/ 布局/ ,/ 还/ 改变/ 元/ 数据/ 的/ I/ // O/ 特征/ ./ 在/ 大部分/ 应用/ 场景/ 中/ 可/ 提高/ I/ // O/ 性能/ ./ 双路/ 并行/ I/ // O/ 为/ 不同/ 的/ 并行/ I/ // O/ 模式/ 设计/ 不同/ 的/ 元/ 数据/ 迁移/ 方法/ ./ 共享/ 文件/ 并行/ I/ // O/ 模式/ 中/ ,/ 双路/ 并行/ I/ // O/ 采取/ 元/ 数据/ 串行/ 、/ 数据/ 并行/ 的/ 方法/ 保障/ 数据/ 存储/ 一致性/ ./ 此时/ ,/ 主/ 进程/ 节点/ 内存/ 文件系统/ 与/ 并行/ 文件系统/ 构成/ 两级/ 存储/ 结构/ ./ 主/ 进程/ 不仅/ 在/ 打开/ 与/ 关闭/ 文件/ 过程/ 中/ 迁入/ 、/ 迁出/ 元/ 数据/ ,/ 还/ 负责管理/ 数据/ 的/ 全局/ 视图/ ./ 参与/ I/ // O/ 的/ 从/ 进程/ 从主/ 进程/ 获取/ 局部/ 数据/ 视图/ 与/ 相关/ 元/ 数据/ ,/ 并行/ 读写/ 数据/ ./ 图/ 4/ 中/ ,/ 数据文件/ 为/ 进程/ 私有/ ,/ 元/ 数据文件/ 在/ 组内/ 共享/ ./ 应用程序/ 仍然/ 按照/ 进程/ -/ 文件/ 对应/ 模式/ 并行/ 打开/ 文件/ ./ 高层/ I/ // O/ 库/ DCPL/ 屏蔽/ 数据/ 与/ 元/ 数据/ 的/ 存储/ 位置/ ,/ 为/ 组内/ 进程/ 提供/ 一致/ 的/ 数据/ 视图/ ./ 输出/ 时/ ,/ 各/ 进程/ 在/ 内存/ 文件系统/ 缓存/ 元/ 数据/ ,/ 直至/ 文件/ 关闭/ ./ 然后/ 将/ 元/ 数据文件/ 合并/ 迁移/ 到/ 并行/ 文件系统/ ./ 在/ 保障/ 数据/ 存储/ 的/ 同时/ 降低/ 总/ 的/ 写/ 延迟/ ./ 读入/ 时/ ,/ 参与/ 并行/ I/ // O/ 的/ 进程/ 首先/ 将/ 与/ 进程/ 对应/ 的/ 元/ 数据/ 迁移/ 到/ 局部/ 内存/ 文件系统/ ,/ 由/ 内存/ 文件系统/ 提高/ 元/ 数据/ 读入/ 性能/ ./ 数据/ 的/ 读写操作/ 不受/ 元/ 数据/ 迁入/ 迁出/ 影响/ ,/ 按/ 需/ 读入/ 或/ 写出/ ./ Page5/ 图/ 4/ 分组/ 并行/ 模式/ 的/ 双路/ I/ // O/ 体系结构/ 元/ 数据/ 迁移/ 不仅/ 优化/ 了/ 数据/ 、/ 元/ 数据/ 的/ 存储/ 布局/ ,/ 还/ 改变/ 了/ 科学计算/ 数据管理/ 模式/ ./ 使用/ 双路/ I/ // O/ 方法/ 后/ ,/ 数据/ 场/ 的/ 存储/ 形式/ 由/ 单一/ 文件/ 变成/ 元/ 数据/ 、/ 数据文件/ 两类/ ./ 应用程序/ 仅/ 需/ 加载/ 容量/ 较/ 小/ 的/ 元/ 数据文件/ 即可/ 获得/ 数据/ 场/ 的/ 描述/ ./ 这/ 对于/ 数据分析/ 与/ 数据/ 再/ 利用/ 等/ 的/ 读入/ 密集型/ 应用/ 有/ 较/ 好/ 的/ 加速/ 效果/ ./ 双路/ 并行/ I/ // O/ 提高/ 了/ 并行/ I/ // O/ 效率/ ./ 然而/ ,/ 元/ 数据/ 迁移/ 弱化/ 了/ 并行/ 进程/ 的/ 读/ -/ 写/ 时序/ 关系/ ,/ 在/ 系统故障/ 时/ 容易/ 发生/ 数据/ 、/ 元/ 数据/ 不/ 一致/ 现象/ ./ 因此/ 我们/ 在/ DCPL/ 的/ 数据/ 中/ 设定/ 元/ 数据/ 迁移/ 成功/ 标志/ ./ 如果/ 标志/ 为/ 真/ ,/ 那么/ 表示/ 数据/ 与/ 元/ 数据/ 一致/ ,/ 数据/ 场/ 完整/ ;/ 如果/ 标志/ 为/ 假/ ,/ 那么/ 表示/ 有元/ 数据/ 缺失/ ,/ 场内/ 数据/ 不/ 完整/ ./ 需由/ 应用/ 程序处理/ 场内/ 数据/ 不/ 完整/ 现象/ ./ 5/ 双路/ 并行/ I/ // O/ 的/ 实现/ 元/ 数据/ 层次/ 存储/ 是/ 双路/ 并行/ I/ // O/ 性能/ 优化/ 的/ 核心技术/ ./ 我们/ 使用/ 内存/ 文件系统/ tmpfs/ ①/ 与/ 并行/ 文件系统/ lustre/ [/ 15/ ]/ 两级/ 存储/ ./ Tmpfs/ 是/ 建立/ 在/ 操作系统/ 虚拟内存/ 设备/ 上/ 的/ 文件系统/ ./ 它/ 是/ Linux/ 系统/ 缺省/ 自带/ 资源/ 之一/ ,/ 一般/ 用于/ 存储/ 临时/ 的/ 系统/ 数据/ ./ Tmpfs/ 的/ 存储/ 调度/ 服从/ 操作系统/ 内存/ 管理/ ,/ 容量/ 根据/ 可用内存/ 数量/ 自动/ 调节/ ./ 由于/ 通用性/ 好/ ,/ 性能/ 高/ ,/ 许多/ 系统/ 服务/ 依赖/ tmpfs/ 交换/ 数据/ ./ 对象/ 存储/ 并行/ 文件系统/ lustre/ 在/ 高性能/ 计算机/ 中有/ 较/ 广泛应用/ ./ 它/ 由/ 对象/ 存储设备/ (/ ObjectStorageTarget/ ,/ OST/ )/ 、/ 元/ 数据/ 服务器/ (/ MetaDataServer/ ,/ MDS/ )/ 和/ 客户端/ 组成/ ./ 目前/ ,/ 大型/ lustre/ 并行/ 文件系统/ 可/ 扩展/ 至/ 数百/ 服务器/ 与/ 上万/ 客户端/ ,/ 提供/ 数十/ PB/ 以上/ 量级/ 存储/ ./ 在/ 双路/ 并行/ I/ // O/ 中/ ,/ 我们/ 使用/ tmpfs/ 临时/ 存储/ 元/ 数据/ ,/ 缩短/ 延迟/ ;/ 使用/ lustre/ 存储/ 数据/ ,/ 提高/ 带宽/ ./ 元/ 数据/ 采用/ 层次/ 存储/ 之后/ ,/ 数据/ 读写/ 流程/ 有/ 一定/ 的/ 变化/ ./ 双路/ I/ // O/ 不仅/ 同时/ 管理/ 数据/ 与/ 元/ 数据文件/ ,/ 还/ 需要/ 在/ 内存/ 文件系统/ 与/ 并行/ 文件系统/ 之间/ 迁入/ 、/ 迁出/ 元/ 数据文件/ ./ 为此/ ,/ 双路/ 并行/ I/ // O/ 使用/ memory/ 与/ changed/ 双/ 开关/ 结构/ 指示/ 元/ 数据/ 状态/ ./ 当/ memory/ 值为/ 真/ ,/ 说明/ 元/ 文件/ 存储/ 于/ 内存/ 文件系统/ ;/ memory/ 值为/ 假/ ,/ 说明/ 元/ 数据文件/ 存储/ 于/ 并行/ 文件系统/ ./ changed/ 为/ 真/ ,/ 说明/ 元/ 数据文件/ 有/ 修改/ ,/ 关闭/ 时须/ 迁移/ 元/ 数据文件/ ;/ changed/ 为/ 假/ ,/ 说明/ 元/ 数据文件/ 无/ 修改/ ,/ 关闭/ 时/ 不/ 需要/ 迁移/ 元/ 数据文件/ ./ 图/ 5/ (/ a/ )/ 是/ 串行/ 条件/ 下/ 打开/ 元/ 数据文件/ 的/ 流程图/ ,/ 其中/ load/ 函数/ 判断/ 数据完整性/ 标志/ ,/ 将/ 元/ 数据文件/ 从/ 文件系统/ 迁移/ 到/ 内存/ ./ 程序/ 首先/ 根据/ 空闲/ 内存容量/ 和/ // dev/ // shm/ 设备/ 读写/ 权限/ 判断/ 内存/ 文件系统/ tmpfs/ 是否/ 可用/ ,/ 然后/ 决定/ 是否/ 使用/ 双路/ I/ // O/ ./ 对于/ 使用/ 双路/ I/ // O/ 的/ 情况/ ,/ 如果/ 需要/ 创建/ 元/ 数据文件/ ,/ ①/ Thetmpfsdocumentation/ ./ https/ :/ // // www/ ./ kernel/ ./ org/ // doc/ // Page6/ 那么/ 在/ 内存/ 文件系统/ 中/ 创建/ 它/ ,/ 并且/ 置/ changed/ 和/ memory/ 开关/ 为/ true/ ,/ 如果/ 不/ 需要/ 创建/ 元/ 数据文件/ ,/ 那么/ 从/ 并行/ 文件系统/ 中/ 加载/ 它/ ,/ 置/ changed/ 开关/ 为/ false/ ,/ memory/ 开关/ 为/ true/ ./ 图/ 5/ (/ b/ )/ 是/ 串行/ 条件/ 下/ 关闭/ 元/ 数据文件/ 流程图/ ,/ 其中/ save/ 函数/ 将/ 元/ 数据文件/ 从/ 内存/ 文件系统/ 迁移/ 到/ 外存/ 文件系统/ ,/ 然后/ 设置/ 迁移/ 成功/ 标志/ ;/ remove/ 函数/ 从/ 内存/ 文件系统/ 删除/ 元/ 数据文件/ ./ 关闭/ 时/ ,/ 首先/ 判断/ 元/ 数据文件/ 是否/ 在/ 内存/ 中/ ./ 如果/ 不/ 在/ 内存/ 中/ ,/ 使用/ 文件系统/ 的/ 调用/ 关闭/ 文件/ ./ 如果/ 在/ 内存/ 中且/ 有/ 修改/ ,/ 那么/ 关闭/ 文件/ 后/ 将/ 文件/ 迁移/ 到/ 文件系统/ ,/ 如果/ 在/ 内存/ 中/ 但是/ 没有/ 修改/ ,/ 那么/ 关闭/ 后/ 从/ 内存/ 文件系统/ 中/ 删除/ 元/ 数据文件/ ./ 元/ 数据/ 分组/ 并行/ 模式/ 中/ ,/ 参与/ 分组/ 的/ 各/ 进程/ 将/ 元/ 数据文件/ 聚合/ 存储/ 于/ 一个/ 文件/ 中/ ./ 文件格式/ 定义/ 如下/ ./ 首先/ 是/ 文件/ 头/ ,/ 元/ 数据文件/ 头/ 中/ 记录/ 了/ 参与/ 分组/ 的/ 进程/ 数量/ ,/ 其后/ 是/ 分/ 属于/ 各个/ 进程/ 的/ 元/ 数据/ 存储/ 二元/ 组/ 〈/ len/ ,/ offset/ 〉/ 列表/ ./ 列表/ 中/ 每一项/ 与/ 一个/ 进程/ 对应/ ,/ 其中/ len/ 代表/ 进程/ 内元/ 数据/ 长度/ ,/ offset/ 代表/ 本/ 进程/ 元/ 数据/ 在/ 文件/ 中/ 的/ 起始/ 位置/ ./ 再后/ 是/ 按/ 列表/ 依次/ 存储/ 的/ 各/ 进程/ 的/ 元/ 数据/ ./ 元/ 数据/ 分组/ 并行/ I/ // O/ 过程/ 中/ ,/ DCPL/ 采用/ MPI/ -/ I/ // O/ 的/ 文件/ 视图/ 与/ 集合/ I/ // O/ [/ 16/ ]/ 迁移/ 元/ 数据/ ./ 文件/ 视图/ 可以/ 在/ 进程/ 间/ 协调/ 分配/ 存储空间/ ,/ 屏蔽/ 各/ 进程/ 读写/ 位置/ 的/ 差异/ ,/ 提高/ I/ // O/ 操作/ 的/ 并行性/ ./ 数据/ 并行/ 迁出/ 部分/ 代码/ 如图/ 6/ 中/ 所示/ ./ 图/ 7/ 并行/ 分组/ I/ // O/ 中元/ 数据/ 的/ 迁入/ 通过/ 元/ 数据/ 的/ 分组/ 并行/ 迁入/ 与/ 迁出/ ,/ 双路/ I/ // O/ 不仅/ 可/ 避免/ 元/ 数据/ 并行/ 读写/ 的/ 拥塞/ ,/ 还/ 可/ 根据/ 系统配置/ 和/ 并行程序/ 的/ 元/ 数据/ 规模/ 调节/ 分组/ 和/ 分组/ 内/ 进程/ 数量/ ,/ 提高/ 计算/ 节点/ 与/ I/ // O/ 服务器/ 的/ 匹配/ 关系/ ./ 此外/ ,/ 元/ 数据/ 分组/ 还/ 降低/ 系统/ 中/ 文件/ 数量/ ,/ 提高/ 数据/ 在/ 并行/ 文件系统/ 上/ 的/ 可/ 管理/ 能力/ ./ 6/ 串行/ 测试/ 使用/ 串行/ 测试程序/ 对比/ DCPL/ 、/ HDF5/ 和/ MPI/ -/ I/ // O/ 的/ 性能/ ./ 与/ DCPL/ 和/ HDF5/ 相比/ ,/ MPI/ -/ I/ // O/ 仅/ 具有/ 数据/ 读写/ 功能/ ,/ 我们/ 使用/ 它/ 对比/ DCPL/ 和/ …/ 对于/ 每/ 一个/ 进程/ :/ …/ // // 切分/ 存储空间/ 进程/ 结束/ …/ 元/ 数据/ 分组/ 迁出/ 的/ 步骤/ 如下/ :/ 第/ 1/ 步/ ,/ 主/ 进程/ 输出/ 元/ 数据文件/ 头/ 与/ 二元/ 组/ 列表/ ;/ 第/ 2/ 步/ ,/ 由/ 各/ 进程/ 根据/ 二元/ 组/ 列表/ 并行/ 进程/ 创建/ MPI/ 数据类型/ ,/ 在/ 文件/ 中/ 切分/ 存储空间/ ;/ 第/ 3/ 步/ ,/ 各/ 进程/ 设定/ 文件/ 视图/ ,/ 屏蔽/ 存储/ 位置/ 的/ 差异/ ;/ 第/ 4/ 步/ ,/ 通过/ 系统/ 调用/ 与/ MPI/ _/ File/ _/ write/ _/ all/ 迁出/ 元/ 数据/ ;/ 第/ 5/ 步/ ,/ 主/ 进程/ 在/ 文件/ 头/ 中/ 设置/ 元/ 数据/ 迁移/ 成功/ 标志/ ./ 数据/ 迁入/ 时/ ,/ 第/ 1/ 步/ ,/ 主/ 进程/ 读入/ 文件/ 头/ ,/ 判断/ 元/ 数据/ 的/ 完整性/ ;/ 第/ 2/ 步/ ,/ 各/ 进程/ 读入/ 二元/ 组/ 列表/ ;/ 第/ 3/ 步/ ,/ 各/ 进程/ 根据/ 二元/ 组/ 列表/ 并行/ 进程/ 创建/ MPI/ 数据类型/ ,/ 在/ 文件/ 中/ 切分/ 存储空间/ ;/ 第/ 4/ 步/ ,/ 通过/ 系统/ 调用/ 与/ MPI/ _/ File/ _/ read/ _/ all/ 并行/ 迁入/ 元/ 数据/ ./ 如图/ 7/ 所示/ ./ HDF5/ 的/ 数据/ I/ // O/ 带宽/ ./ 6.1/ 测试环境/ 测试/ 的/ 硬件/ 环境/ 是/ 一个/ 部署/ 有/ lustre/ 并行/ 文件系统/ 的/ MPP/ 系统/ ./ 该/ 系统/ 有/ 3880/ 个/ 节点/ ./ 每个/ 节点/ 采用/ 2/ 个/ IntelXeonX5670/ 六核/ 处理器/ ,/ 主频/ 2.93/ GHz/ ,/ 配置/ 48GB/ 内存/ ,/ 总计/ 46560/ 个/ 处理器/ 核/ 与/ 181.9/ TB/ 内存/ ./ 系统/ 内/ 并行/ 文件系统/ 配置/ 96/ 台/ 服务器/ ,/ 每个/ 服务器/ 采用/ 2/ 个/ IntelXeonE5640/ 四核/ 处理器/ ,/ 主频/ 2.67/ GHz/ ,/ 配置/ 12GB/ 内存/ 和/ 两个/ 16TB/ 的/ RAID6/ 盘阵/ ,/ 总计/ 3PB/ 存储资源/ ./ 客户端/ 与/ 服务器之间/ 采用/ QDR/ 的/ infiniband/ 互连/ ./ 在/ 较/ 早/ 的/ 并行/ 文件系统/ 性能/ 测试/ 中/ ,/ 它/ 的/ 单/ 进程/ 持续/ 带宽/ Page7/ 约/ 为/ 450MB/ // s/ 左右/ ,/ 多/ 进程/ 并行/ I/ // O/ 峰值/ 带宽/ 超过/ 60GB/ // s/ ./ 6.2/ 单/ 节点/ 性能/ 测试/ 与/ 分析/ 我们/ 设计/ 并/ 实现/ 的/ 节点/ 内/ 测试程序/ maskio/ 由/ 负载/ 计时/ 程序/ 和/ 掩模/ 文件/ 组成/ ./ 负载/ 计时/ 程序/ 具有/ DCPL/ 、/ HDF5/ 和/ MPI/ -/ I/ // O/ 三种/ 读写/ 接口/ ./ 与/ DCPL/ 与/ HDF5/ 相比/ ,/ MPI/ -/ I/ // O/ 只有/ 基础/ 的/ I/ // O/ 功能/ ,/ 因此/ DCPL/ 与/ HDF5/ 输出/ 块/ 分割/ 的/ 三维/ 数据/ 场/ 作为/ 负载/ ;/ MPI/ -/ I/ // O/ 仅/ 依次/ 输出/ 场中/ 的/ 数据/ 块/ ,/ 不/ 输出/ 元/ 数据/ ./ 真实/ 的/ 应用程序/ 的/ I/ // O/ 特征/ 往往/ 没有/ 规律/ 可循/ ./ 我们/ 使用/ 掩模/ 文件/ 记录/ 每/ 一次/ 读写操作/ 的/ 相对/ 位置/ ./ 掩模/ 文件/ 产生/ 于/ 真实/ 的/ 应用/ ,/ 它/ 记录/ 应用程序/ 每/ 一次/ 读写操作/ 发生/ 位置/ ./ 输出/ 时/ ,/ maskio/ 按/ 参数/ 指定/ 大小/ 和/ 数量/ 顺序/ 输出/ ./ 输入/ 时/ ,/ maskio/ 按照/ 掩模/ 文件/ 指示/ 的/ 位置/ 读入/ 数据/ ./ 6.2/ ./ 1/ 单/ 节点/ 性能/ 测试/ 设定/ 数据/ 块/ 总量/ 为/ 5000/ ,/ 大小/ 均匀/ ,/ 测试/ 长度/ 从/ 4KB/ 扩展/ 到/ 16MB/ 的/ 多种/ 情况/ ./ 由/ 5000/ 个/ 数据/ 块/ 构成/ 的/ 数据/ 场中/ ,/ 包括/ 名称/ 、/ 属性/ 与/ 索引/ 在内/ 的/ 元/ 数据/ 总量/ 为/ 1.8/ MB/ ./ 在/ 数据/ 块/ 从/ 4KB/ 增长/ 到/ 16MB/ 的/ 过程/ 中/ ,/ 相应/ 的/ 数据/ 场/ 存储/ 规模/ 从/ 20MB/ 增长/ 到/ 80GB/ ./ DCPL/ 、/ HDF5/ 和/ MPI/ -/ I/ // O/ 三者/ 写/ 性能/ 对/ 比如/ 图/ 8/ (/ a/ )/ 所示/ ,/ 读/ 性能/ 对/ 比如/ 图/ 8/ (/ b/ )/ 所示/ ./ 如图/ 8/ (/ a/ )/ 所示/ ,/ 输出/ 过程/ 中/ ,/ 与/ HDF5/ 相比/ ,/ 节点/ 内/ 的/ DCPL/ 平均/ 带宽/ 提高/ 13/ %/ ./ 相比/ 于/ MPI/ -/ I/ // O/ ,/ 由于/ 没有/ 任何/ 元/ 数据/ 开销/ ,/ 平均/ 带宽/ 是/ HDF5/ 的/ 2.15/ 倍/ ./ 图/ 8/ (/ b/ )/ 中/ ,/ 与/ HDF5/ 相比/ ,/ 单/ 进程/ DCPL/ 的/ 读/ 带宽/ 平均/ 提高/ 到/ 3.51/ 倍/ ./ 16KB/ 时/ 最高/ ,/ 可达/ 7.11/ 倍/ ;/ 1MB/ 与/ 4MB/ 的/ 加速/ 比/ 分别/ 为/ 2.72/ 和/ 1.76/ 倍/ ./ 这/ 说明/ 在/ 较/ 广泛/ 的/ 数据/ 区间/ 内/ ,/ 双路/ I/ // O/ 优化/ 技术/ 对/ 读/ 操作/ 有/ 良好/ 的/ 加速/ 效果/ ./ 6.2/ ./ 2/ 单/ 节点/ 性能/ 分析/ DCPL/ 的/ 读写/ 时间/ 由/ 数据/ 、/ 元/ 数据/ 读写/ 时间/ 和/ 元/ 数据/ 迁入/ 迁出/ 时间/ 组成/ ./ 5000/ 个/ 数据/ 块/ 的/ 数据/ 块/ 名称/ 、/ 类型/ 、/ 说明/ 与/ 属性/ 等/ 元/ 数据量/ 为/ 1.8/ MB/ ./ 在/ lustre/ 缓存/ 的/ 影响/ 下/ ,/ 这些/ 数据/ 从/ tmpfs/ 迁出/ 到/ lustre/ 并行/ 文件系统/ 的/ 时间/ 为/ 0.003/ s/ 左右/ ./ Lustre/ 缓存/ 不/ 命中/ 时/ ,/ 从/ 并行/ 文件系统/ 迁入/ 到/ tmpfs/ 的/ 时间/ 为/ 0.07/ s/ 左右/ ./ 将/ 迁入/ 迁出/ 时间/ 算入/ DCPL/ 的/ 元/ 数据/ 开销/ ,/ 比较/ DCPL/ 、/ HDF5/ 和/ MPI/ -/ I/ // O/ 的/ 数据/ 、/ 元/ 数据/ 输出/ 时间/ 如图/ 9/ (/ a/ )/ 所示/ ,/ 读入/ 时间/ 如图/ 9/ (/ b/ )/ 所示/ ./ 在/ 图/ 9/ (/ a/ )/ 中/ ,/ 文件系统/ 缓存/ 屏蔽/ 了/ 元/ 数据/ 层次/ 存储/ 的/ 效果/ ./ 仅/ 分析/ 元/ 数据/ 输出/ 开销/ 时/ ,/ DCPL/ 与/ HDF5/ 相近/ ./ 然而/ ,/ 元/ 数据/ 层次/ 存储/ 后/ ,/ 数据/ 存储/ 布局/ 连续性/ 有/ 提高/ ,/ 所以/ DCPL/ 的/ 数据/ 输出/ 时间/ 仍然/ 少于/ HDF5/ ./ 图/ 9/ (/ b/ )/ 说明/ 了/ HDF5/ 读入/ 性能/ 低/ 的/ 主要/ 原因/ ./ HDF5/ 的/ 元/ 数据/ 读入/ 开销/ 随着/ 数据/ 块/ 大小/ 的/ 增长/ 而/ 增加/ ,/ DCPL/ 的/ 元/ 数据/ 读入/ 开销/ 相对/ 稳定/ ./ 两者/ 平均/ Page8/ 有/ 7.5/ 倍/ 差距/ ,/ 最大/ 可达/ 12.69/ 倍/ ./ 这是/ DCPL/ 读/ 性能/ 好于/ HDF5/ 的/ 主要/ 原因/ ./ 此外/ ,/ DCPL/ 数据/ 存储/ 连续性/ 较/ 好/ ,/ 这是/ DCPL/ 读入/ 性能/ 好于/ HDF5/ 的/ 次要/ 原因/ ./ 7/ 并行/ 应用/ 测试/ 在/ 上/ 一节/ 说明/ 的/ 测试环境/ 中/ ,/ 我们/ 使用/ Lared/ -/ P/ 程序/ 与/ TeraVAP/ 程序/ 测试/ 双路/ 并行/ I/ // O/ 与/ HDF5/ 的/ 加速/ 比/ ./ 我们/ 设定/ Lared/ -/ P/ 程序/ 数据/ 场/ 大小/ 为/ 20483/ ,/ 单/ 时刻/ 重启动/ 数据/ 规模/ 386GB/ ./ 使用/ 元/ 数据/ 分组/ 并行/ I/ // O/ 模式/ ,/ 6/ 个/ 进程/ 对应/ 一个/ 元/ 数据文件/ ,/ 测试/ 实际/ 应用/ 可/ 获得/ 的/ 并行/ I/ // O/ 性能/ ./ 3072/ 个/ 进程/ 到/ 24576/ 个/ 进程/ 的/ 性能/ 对/ 比如/ 图/ 10/ 所示/ ./ 图/ 10/ 双路/ 并行/ I/ // O/ 与/ HDF5/ 的/ 重启动/ I/ // O/ 带宽/ 比较/ 如图/ 10/ ,/ 双路/ 并行/ I/ // O/ (/ DCPL/ )/ 的/ 平均/ 加速/ 效果/ ,/ 写/ 操作/ 平均/ 提高/ 8/ %/ ,/ 读/ 操作/ 平均/ 提高/ 89/ %/ ./ 12288/ 进程/ 时读/ 加速/ 比/ 最高/ ,/ 提高/ 116/ %/ ./ 该/ 测试/ 说明/ ,/ 双路/ 并行/ I/ // O/ 方法/ 有/ 较/ 好/ 的/ 加速/ 效果/ ,/ 尤其/ 是/ 数据/ 的/ 读入/ 操作/ ,/ 最高/ 可/ 提高/ 1/ 倍/ 以上/ ./ 分析/ 读/ 、/ 写/ 加速/ 效果/ 不/ 平衡/ 的/ 原因/ ./ Lared/ -/ P/ 数据/ 场为/ 一次性/ 的/ 写出/ 与/ 读入/ ./ 写出/ 时/ ,/ 文件系统/ 客户端/ 缓存/ 屏蔽/ 了/ 元/ 数据/ 迁移/ 的/ 效果/ ,/ 因此/ 加速/ 比/ 受到限制/ ;/ 读入/ 时/ ,/ 缓存/ 不易/ 命中/ ,/ 元/ 数据/ 迁移/ 有/ 明显/ 的/ 加速/ 效果/ ,/ 因此/ 有/ 较/ 高/ 的/ 加速/ 比/ ./ TeraVAP/ 软件/ 是/ 中国工程物理研究院/ 高性能/ 数值/ 模拟/ 软件/ 中心/ 研制/ 的/ 数据/ 并行/ 可视化/ 工具/ ,/ 它/ 支持/ HDF5/ 、/ NetCDF/ 等/ 多种/ 格式/ 数据/ 的/ 并行/ 可视化/ ./ 使用/ TeraVAP/ 绘制/ 一帧/ 图片/ 需要/ 经历/ 数据/ 初选/ 、/ 读入/ 、/ 渲染/ 、/ 绘制/ 等/ 过程/ ./ 我们/ 将/ DCPL/ 格式/ 移植/ 到/ TeraVAP/ ,/ 与/ HDF5/ 对比/ 测试/ ./ 测试数据/ 集/ 源自/ 于/ 基于/ JASMIN/ 框架/ 的/ JEMS/ -/ FDTD/ 并行程序/ ./ JEMS/ -/ FDTD/ 是/ 一个/ 使用/ Maxwell/ 方程/ 求解/ 电磁场/ 反射强度/ 的/ 程序/ ./ 设定/ 数据/ 场/ 大小/ 为/ 10243/ ,/ 单/ 时刻/ 数据/ 规模/ 56GB/ ./ 使用/ 32/ ~/ 512/ 进程/ 并行/ 伪/ 彩色/ 绘制/ 电场/ 强度/ ,/ 数据/ I/ // O/ 时间/ 与/ 可视化/ 时间/ 对/ 比如/ 图/ 11/ 所示/ ./ 图/ 11/ 测试/ 中/ 使用/ 了/ TeraVAP/ 自带/ 的/ 计时器/ ,/ 其中/ I/ // O/ 时间/ 包括/ 了/ 数据/ 初选/ 与/ 读入/ 时间/ 之/ 和/ ./ DCPL/ 平均/ 缩短/ TeraVAP/ 的/ I/ // O/ 时间/ 2.01/ 倍/ ,/ 对/ 总/ 绘图/ 时间/ 也/ 有/ 71/ %/ 的/ 加速/ 效果/ ./ 8/ 结束语/ 高层/ I/ // O/ 库是/ 科学计算/ 数据/ 集合/ 管理工具/ ,/ 是/ 许多/ 大型/ 科学计算/ 应用/ 存取数据/ 的/ 基础/ ./ 本文/ 根据/ 数据/ 、/ 元/ 数据/ I/ // O/ 特征/ 差异/ ,/ 在/ 科学计算/ 应用/ 的/ 并行/ I/ // O/ 过程/ 中/ 构造/ 内存/ 文件系统/ 和/ 并行/ 文件系统/ 两层/ 存储/ ,/ 迁移/ 规模较/ 小/ ,/ 存取/ 频次/ 较/ 高/ 的/ 元/ 数据文件/ 到/ 内存/ 文件系统/ ./ 降低/ 元/ 数据/ I/ // O/ 延迟/ ,/ 优化/ 数据/ 、/ 元/ 数据/ 存储/ 布局/ ,/ 提高/ 并行/ I/ // O/ 效率/ ./ 在/ 元/ 数据/ 并行/ 迁移/ 过程/ 中/ ,/ 本文/ 使用/ 集合/ I/ // O/ 为元/ 数据/ 协同/ 分配/ 存储空间/ ,/ 并行/ 读写/ ,/ 提高/ 迁移/ 效率/ ./ 测试表明/ ,/ 双路/ 并行/ I/ // O/ 方法/ 有/ 较/ 好/ 的/ 加速/ 效果/ ,/ 可/ 提高/ 万核/ 应用程序/ 的/ 并行/ 写/ 带宽/ 8/ %/ ~/ 13/ %/ ,/ 并行/ 读/ 带宽/ 89/ %/ 到/ 1.01/ 倍/ ./ 在/ 具有/ 较/ 复杂/ 模型/ 的/ 大规模/ 并行计算/ 应用/ 中/ ,/ 数据/ 、/ 元/ 数据/ 无序/ 读写/ 是/ 一种/ 比较/ 普遍/ 的/ 现象/ ./ 双路/ 并行/ I/ // O/ 可以/ 提高/ 这些/ 应用程序/ 的/ 并行/ 读写/ 带宽/ ,/ 提高/ 应用/ 的/ 执行/ 速度/ ,/ 因此/ 具有/ 较/ 广泛/ 的/ 应用/ 前景/ ./ 

