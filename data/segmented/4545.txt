Page1/ 面向/ ASCRA/ 的/ 循环/ 流水/ 启动/ 间距/ 自动/ 分析/ 及/ 优化/ 郭/ 振华/ 吴/ 艳霞/ 张国/ 印戴葵/ (/ 哈尔滨工程大学/ 计算机科学/ 与/ 技术/ 学院/ 哈尔滨/ 150001/ )/ 摘要/ 在/ 实现/ 循环/ 到/ 流水/ 硬件/ 结构/ 自动/ 映射/ 过程/ 中/ ,/ 迭代/ 间/ 启动/ 间距/ 的/ 自动/ 分析/ 技术/ 是/ 可/ 重构/ 编译器/ 研究/ 的/ 难点/ ./ 在/ 现有/ 细粒度/ 可/ 重构/ 编译器/ 中/ ,/ 主要/ 采用/ 人工/ 输入/ 制导/ 语句/ 的/ 方法/ 来/ 控制/ 循环/ 并行/ 流水/ 硬件/ 结构/ 自动/ 映射/ 所/ 需/ 启动/ 间距/ 信息/ 的/ 生成/ ,/ 该/ 方法/ 只能/ 采用/ 固定/ 启动/ 间距/ 方式/ 对/ 流水/ 硬件/ 结构/ 进行/ 控制/ ,/ 不能/ 充分发挥/ 并行/ 流水/ 硬件/ 结构/ 的/ 性能/ ,/ 同时/ 人工/ 确定/ 启动/ 间距/ 的/ 方法/ 降低/ 了/ 可/ 重构/ 计算/ 应用/ 的/ 部署/ 效率/ ./ 针对/ 细粒度/ 可/ 重构/ 编译器/ 的/ 现状/ ,/ 文中/ 提出/ 了/ 一种/ 面向/ ASCRA/ 的/ 循环/ 流水/ 启动/ 间距/ 自动/ 分析/ 及/ 优化/ 方法/ ./ 在/ 细粒度/ 可/ 重构/ 编译器/ 中/ ,/ 建立/ 多层/ 循环/ 流水/ 迭代/ 间/ 启动/ 间距/ 分析模型/ ,/ 提出/ 非/ 固定/ 启动/ 间距/ 控制策略/ ,/ 采用/ 自动/ 生成/ 算法/ 得到/ 迭代/ 间/ 启动/ 间距/ 向量/ 信息/ ,/ 并/ 采用/ 流水线/ 调度/ 技术/ 对/ 迭代/ 间/ 启动/ 间距/ 进行/ 优化/ ./ 实验/ 结果表明/ ,/ 与/ 现有/ HLS/ 工具/ 相比/ ,/ 文中/ 方法/ 不仅/ 能够/ 提高/ 可/ 重构/ 计算/ 应用/ 在/ 异构/ 加速/ 平台/ 上/ 的/ 部署/ 效率/ ,/ 同时/ 能够/ 有效/ 改善/ 循环/ 应用/ 在/ FPGA/ 协处理器/ 中/ 流水/ 执行/ 时/ 的/ 性能/ ,/ 具有/ 一定/ 的/ 可行性/ ./ 关键词/ 可/ 重构/ 编译/ ;/ 循环/ 流水/ ;/ 自动/ 映射/ ;/ 启动/ 间距/ ;/ 异构/ 加速/ 1/ 引言/ 面向/ CPU/ -/ FPGA/ 异构/ 加速/ 平台/ 的/ 可/ 重构/ 自动化/ 编译/ 工具/ 已经/ 成为/ 了/ 可/ 重构/ 计算/ 领域/ 研究/ 的/ 热点/ ./ 相对/ 于/ 多/ 核/ 处理器/ 的/ 高功耗/ 及/ 并行/ 度过/ 低/ 、/ ASIC/ 芯片/ 成本/ 过于/ 昂贵/ 等/ 缺点/ ,/ 基于/ 片内/ CPU/ -/ FPGA/ 架构/ 的/ 异构/ 加速/ 平台/ 更加/ 适应/ 嵌入式/ 系统/ 中/ 对/ 性能/ 、/ 功耗/ 、/ 成本/ 均/ 比较/ 苛刻/ 的/ 计算/ 密集型/ 应用/ ,/ 例如/ 图像压缩/ 、/ 模式识别/ 、/ 数字/ 信号处理/ 等/ 应用/ ,/ 兼顾/ 了/ 通用/ 处理器/ 的/ 灵活性/ 和/ 专用/ 芯片/ 的/ 高效性/ ./ 计算/ 密集型/ 应用/ 中/ 85/ %/ 左右/ 的/ 程序执行/ 时间/ 都/ 集中/ 在/ 其中/ 的/ 循环/ 部分/ [/ 1/ ]/ ,/ 如何/ 实现/ 循环/ 到/ 高效/ 并行/ 流水/ 硬件/ 结构/ 的/ 自动/ 映射/ 是/ 可/ 重构/ 编译器/ 研究/ 的/ 难点/ ./ 目前/ ,/ 在/ 研究/ 多层/ 循环/ 到/ 并行/ 流水/ 硬件/ 结构/ 自动/ 映射/ 时/ ,/ 主要/ 分为/ 两个/ 方向/ :/ (/ 1/ )/ 以/ CGRA/ [/ 2/ ]/ 为/ 代表/ 的/ 面向/ 粗粒度/ 可/ 重构/ 硬件平台/ 的/ 循环/ 流水/ 硬件/ 结构/ 映射/ ,/ 通过/ 函数/ 级/ 程序/ 特征分析/ ,/ 实现/ 循环/ 到/ 固定/ 流水/ 硬件/ 模板/ 结构/ 的/ 映射/ ,/ 可以/ 简化/ 循环/ 映射/ 的/ 复杂度/ ,/ 但是/ 限制/ 了/ 循环/ 程序/ 对/ 可/ 重构/ 平台/ 的/ 通用性/ ;/ (/ 2/ )/ 以/ Xilinx/ 提出/ 的/ VivadoHLS/ (/ HighLevelSynthesis/ )/ [/ 3/ ]/ 高层次/ 综合/ 工具/ 为/ 代表/ 的/ 细粒度/ 可/ 重构/ 编译/ 工具/ ,/ 通过/ 循环/ 程序/ 特征分析/ ,/ 完成/ 循环/ 程序/ 到/ 异构/ 加速/ 平台/ 的/ 指令/ 级/ 映射/ ,/ 与/ 粗粒度/ 可/ 重构/ 编译器/ 相比/ ,/ 指令/ 级/ 硬件/ 映射/ 具备/ 更/ 广泛/ 的/ 通用性/ 和/ 推广/ 意义/ ./ 本文/ 主要/ 致力于/ 研究/ 细粒度/ 可/ 重构/ 编译器/ 在/ 实现/ 多层/ 循环/ 到/ 并行/ 流水/ 执行/ 硬件/ 结构/ 自动/ 映射/ 时/ 迭代/ 间/ 启动/ 间距/ II/ (/ InitiationInterval/ )/ 的/ 自动/ 分析/ 及/ 优化/ 方法/ ./ 目前/ ,/ VivadoHLS/ [/ 3/ ]/ 、/ ROCCC/ [/ 4/ ]/ 、/ ImpulseC/ [/ 5/ ]/ 等/ 细粒度/ 可/ 重构/ 编译器/ 在/ 实现/ 多层/ 循环/ 到/ 并行/ 流水/ FPGA/ 硬件/ 结构/ 的/ 映射/ 时均/ 采用/ 制导/ 语句/ 方式/ 进行/ 迭代/ 间/ 流水/ 启动/ 间距/ 控制/ ,/ 即/ 在/ 计算/ 密集型/ 应用程序/ 循环/ 代码/ 中/ 人工/ 插入/ 类似/ #/ pragmaII/ =/ xx/ 的/ 制导/ 语句/ 指令/ 方式/ ,/ 实现/ 循环/ 映射/ 成为/ 并行/ 流水/ 硬件/ 结构/ 时/ 迭代/ 间/ 启动/ 间距/ 的/ 生成/ 控制/ ./ 该/ 方式/ 只能/ 针对/ 循环/ 中/ 的/ 每/ 一维/ 迭代/ 空间/ 生成/ 固定值/ 的/ 迭代/ 间/ 启动/ 间距/ ,/ 同时/ 在/ 使用/ 可/ 重构/ 编译器/ 进行/ 可/ 重构/ 计算/ 应用/ 部署/ 时/ ,/ 需要/ 反复/ 迭代/ 综合/ 仿真/ 过程/ 才能/ 最终/ 确定/ 合适/ 的/ 迭代/ 间/ 流水/ 启动/ 间距/ 值/ ,/ 极大/ 地/ 制约/ 了/ 可/ 重构/ 计算/ 应用/ 的/ 部署/ 效率/ ,/ 同时/ 会/ 影响/ 细粒度/ 可/ 重构/ 编译器/ 在/ 工业界/ 的/ 推广/ ./ 为了/ 解决/ 以上/ 问题/ ,/ 本文/ 通过/ 挖掘/ 利用/ 启动/ 间距/ 提升/ 流水/ 并行/ 硬件/ 结构/ 性能/ 的/ 潜力/ ,/ 建立/ 多层/ 循环/ 迭代/ 间/ 启动/ 间距/ 的/ 分析模型/ ,/ 提出/ 一种/ 面向/ 细粒度/ 可/ 重构/ 编译器/ 的/ 循环/ 流水/ 迭代/ 间/ 启动/ 间距/ 自动/ 分析/ 及/ 优化/ 方法/ ,/ 并/ 在/ 基于/ LLVM/ 开源/ 编译/ 框架/ 下/ 开发/ 的/ 细粒度/ 可/ 重构/ 编译器/ ASCRA/ (/ Application/ -/ SpecificCompilerforReconfigurableArchitecture/ )/ [/ 6/ ]/ 中/ 进行/ 了/ 该/ 方法/ 的/ 实现/ 和/ 验证/ ,/ 证明/ 本文/ 方法/ 的/ 有效性/ ./ 本文/ 贡献/ 主要/ 有/ 以下/ 3/ 点/ :/ (/ 1/ )/ 建立/ 循环/ 流水/ 迭代/ 间/ 启动/ 间距/ 自动/ 分析模型/ ,/ 并/ 设计/ 实现/ 了/ 自动/ 分析/ 算法/ ,/ 减少/ 细粒度/ 可/ 重构/ 编译器/ 实现/ 循环/ 流水/ 映射/ 时/ 调试/ 启动/ 间距/ 值/ 的/ 综合/ 仿真/ 迭代/ 次数/ ,/ 可/ 有效/ 提高/ 可/ 重构/ 编译器/ 的/ 自动化/ 水平/ 及/ 可/ 重构/ 计算/ 应用/ 的/ 部署/ 效率/ ./ (/ 2/ )/ 提出/ 循环/ 流水/ 执行/ 时/ 迭代/ 间/ 非/ 固定/ 启动/ 间距/ NF/ _/ II/ (/ Non/ -/ FixedInitiationInterval/ )/ 控制策略/ ./ 与/ 现有/ 制导/ 语句/ 控制/ 固定/ 启动/ 间距/ 方式/ 相比/ ,/ 能够/ 有效/ 减少/ 流水/ 冒泡/ 延迟/ ,/ 提高/ 硬件/ 流水/ 执行/ 数据/ 吞吐/ 率/ ./ (/ 3/ )/ 基于/ 指令/ 调度/ 优化/ 技术/ 提出/ 了/ 循环/ 流水/ 迭代/ 间/ 启动/ 间距/ 优化/ 算法/ ,/ 能够/ 降低/ 循环/ 迭代/ 间/ 启动/ 间距/ 值/ ,/ 进一步提高/ 循环/ 流水/ 执行/ 时/ 的/ 性能/ ./ 本文/ 第/ 2/ 节/ 介绍/ 相关/ 研究/ 工作/ ;/ 第/ 3/ 节/ 介绍/ 循环/ 流水/ 迭代/ 间/ 启动/ 间距/ 自动/ 分析方法/ ;/ 第/ 4/ 节/ 介绍/ 循环/ 流水/ 迭代/ 间/ 启动/ 间距/ 优化/ 算法/ ;/ 第/ 5/ 节/ 给出/ 实验/ 结果/ 和/ 分析/ ;/ 第/ 6/ 节/ 给出/ 本文/ 的/ 结论/ ./ 2/ 相关/ 工作/ 目前/ ,/ 国内外/ 已有/ 多个/ 可/ 重构/ 编译器/ 课题组/ 致力于/ 研究/ 在/ 可/ 重构/ 平台/ 中/ 实现/ 多层/ 循环/ 程序/ 到/ 流水/ 并行/ 硬件/ 结构/ 的/ 自动/ 映射/ ,/ 采用/ 流水线/ 技术/ 提高/ 循环/ 程序/ 硬件/ 的/ 性能/ ./ 其中/ ,/ GarpCC/ 编译器/ [/ 7/ ]/ 中/ 采用/ RIMS/ (/ RausIterativeModuloScheduling/ )/ 调度/ 算法/ 实现/ 循环/ 流水/ 的/ 控制/ 映射/ ,/ 但是/ 只/ 对/ 最/ 内层/ 循环/ 进行/ 流水/ 控制/ ;/ XPP/ [/ 8/ ]/ 中/ 采用/ 流水/ 向/ 量化/ 方法/ ,/ 但是/ 不能/ 处理/ 循环体/ 间/ RAW/ 数据/ 依赖/ 关系/ 引起/ 的/ 非/ 最/ 内层/ 循环/ 迭代/ 间/ 流水/ 启动/ 间距/ 问题/ ;/ VivadoHLS/ [/ 3/ ]/ 、/ ROCCC/ [/ 4/ ]/ 、/ ImpulseC/ [/ 5/ ]/ 等/ 细粒度/ 可/ 重构/ 编译器/ 均/ 采用/ 制导/ 语句/ 方式/ 实现/ 循环/ 流水/ 硬件/ 自动化/ 映射/ 时/ 的/ 流水/ 启动/ 间距/ 控制/ ,/ 仅能/ 实现/ 迭代/ 间/ 固定/ 启动/ 间距/ 控制/ 方式/ ,/ 并且/ 没有/ 实现/ 自动/ 分析方法/ 和/ 相关/ 优化/ 方法/ ./ 为了/ 提高/ 细粒度/ 可/ 重构/ 编译器/ 实现/ 多层/ 循环/ 流水/ 映射/ 的/ 效率/ 和/ 性能/ ,/ 本文/ 基于/ 细粒度/ 可/ 重构/ 编译器/ ASCRA/ 对/ 循环/ 流水/ 迭代/ 间/ 启动/ 间距/ 自动/ 分析/ 和/ Page3/ 优化/ 方法/ 展开/ 了/ 一定/ 的/ 研究/ ./ 多层/ 循环/ 在/ 流水/ 执行/ 时/ ,/ 迭代/ 间/ 的/ 启动/ 间距/ 由/ 数据/ 依赖/ 关系/ 决定/ ,/ 因此/ ,/ 完成/ 启动/ 间距/ 信息/ 的/ 自动化/ 分析/ 需要/ 精确/ 数据/ 依赖/ 关系/ 分析/ 算法/ 支持/ ,/ 本文/ 在/ 改进/ ISL/ 数据流/ 分析方法/ [/ 9/ ]/ 得到/ 的/ 数据/ 依赖/ 关系/ 结果/ 的/ 基础/ 上/ 设计/ 出/ 多层/ 循环/ 流水/ 启动/ 间距/ 自动/ 分析方法/ ./ 本文/ 提出/ 了/ 循环/ 流水/ 启动/ 间距/ 自动/ 分析/ 及/ 优化/ 方法/ ,/ 并/ 在/ 基于/ ARM/ -/ FPGA/ 异构/ 加速/ 平台/ 面向/ 应用领域/ 的/ 细粒度/ 可/ 重构/ 编译器/ ASCRA/ [/ 6/ ]/ 上/ 进行/ 理论/ 实现/ 与/ 验证/ ./ ASCRA/ 基于/ 开源/ 编译/ 框架/ LLVM/ [/ 10/ ]/ 进行/ 设计/ 与/ 实现/ ,/ 可以/ 完成/ C/ -/ to/ -/ VHDL/ 的/ 自动/ 映射/ ,/ ASCRA/ 系统/ 架构图/ 如图/ 1/ 所示/ ./ 首先/ ,/ 将/ 计算/ 密集型/ 应用程序/ 编译成/ LLVM/ 中间代码/ (/ Intermediate/ 图/ 1ASCRA/ 架构图/ 在/ 细粒度/ 可/ 重构/ 编译器/ 中/ ,/ 通过/ 循环/ 流水/ 启动/ 间距/ 自动/ 分析/ 及/ 优化/ 方法/ 不仅/ 可以/ 得到/ 更/ 精准/ 的/ 循环/ 性能/ 评估/ 结果/ ,/ 实现/ 更/ 高效/ 的/ 软硬件/ 自动/ 划分/ 方法/ ;/ 同时/ 在/ 硬件/ 代码/ 自动/ 映射/ 过程/ 中/ ,/ 能够/ 提高/ 可/ 重构/ 计算/ 应用/ 到/ 可/ 重构/ 计算/ 平台/ 的/ 部署/ 效率/ ,/ 提高/ 细粒度/ 可/ 重构/ 编译器/ 的/ 效率/ 和/ 推广/ ./ 3/ 循环/ 流水/ 迭代/ 间/ 启动/ 间距/ 自动/ 分析/ 3.1/ 问题/ 提出/ 在/ 可/ 重构/ 混合/ 计算/ 系统/ 中/ ,/ 由于/ FPGA/ 的/ 可/ 定制/ 性及/ 硬件/ 结构/ 不确定性/ ,/ 导致/ 无法/ 直接/ 利用/ 通用/ 计算机系统/ 结构/ 中/ 所/ 设计/ 的/ 软件/ 流水/ 技术/ 实现/ 多层/ 循环/ 迭代/ 间变/ 启动/ 间距/ 控制/ ./ 现有/ 细粒度/ 可/ 重构/ 编译器/ 在/ 实现/ 多层/ 循环/ 流水/ 并行/ 硬件/ 结构/ 映射/ 时/ ,/ 主要/ 采用/ 制导/ 语句/ 的/ 方法/ 实现/ 迭代/ 间/ 流水/ 启动/ 间距/ 的/ 生成/ ,/ 为了/ 体现/ 本文/ 工作/ 与/ 现有/ 可/ 重构/ 编译器/ 对/ 多层/ 循环/ 流水/ 执行/ 时/ 关于/ 启动/ 间距/ 映射/ 方式/ 的/ 改进/ 之/ 处/ ,/ 本/ 小节/ 采用/ 一个/ 多层/ 嵌套循环/ 的/ 实例/ 描述/ 问题所在/ ./ 如图/ 2/ (/ a/ )/ 所示/ ,/ 显示/ 了/ 一个/ 典型/ 外层/ 循环/ 迭代/ Representation/ ,/ IR/ )/ 表示/ ,/ 采用/ 一些/ 前端/ 优化/ 技术/ 进行/ IR/ 优化/ ;/ 其次/ ,/ 对/ 循环/ 程序/ 进行/ 数据/ 依赖/ 关系/ 分析/ 、/ 流水线/ 划分/ 、/ 迭代/ 间/ 启动/ 间距/ 分析/ 和/ 优化/ ,/ 基于/ 流水线/ 划分/ 结果/ 和/ 启动/ 间距/ 分析/ 结果/ 进行/ 循环/ 程序/ 代价/ 评估/ ,/ 评估/ 将/ 该/ 循环/ 程序/ 映射/ 到/ FPGA/ 上/ 执行/ 时/ 消耗/ 的/ 代价/ 和/ 获得/ 的/ 应用/ 加速/ 比/ ;/ 然后/ ,/ 基于/ 循环/ 程序/ 代价/ 评估/ 结果/ 进行/ 软硬件/ 划分/ ,/ 判断/ 是否/ 将/ 其/ 划分/ 到/ 协处理器/ FPGA/ 硬件加速/ 单元/ 上/ 执行/ ;/ 最后/ 进行/ 代码生成/ ,/ 结合/ 并行/ 编译/ 优化/ 技术/ 和/ 并行/ 存储/ 模型/ 完成/ FPGA/ 并行/ 流水/ 硬件加速/ 单元/ VHDL/ 代码/ 的/ 生成/ ,/ 同时/ 生成/ 软硬件/ 接口/ 驱动程序/ 和/ 将/ 该/ 循环/ 程序/ 封装/ 成/ 接口/ 调用/ 的/ C/ 源程序/ ,/ 完成/ 计算/ 密集型/ 应用程序/ 在/ 异构/ 加速/ 平台/ 上/ 的/ 自动/ 部署/ ./ 间/ 数据/ 相关/ 的/ 嵌套循环/ ,/ 当/ N/ =/ 5/ 时/ 循环体/ 的/ 迭代/ 域/ 及/ 迭代/ 空间/ 中/ RAW/ 数据/ 依赖/ 关系/ 如图/ 2/ (/ b/ )/ 所示/ ./ 细粒度/ 可/ 重构/ 编译器/ 在/ 实现/ 该/ 嵌套循环/ 到/ 可/ 重构/ 混合/ 计算/ 平台/ 流水/ 并行/ 硬件/ 结构/ 自动/ 映射/ 时/ ,/ 将/ 最/ 内层/ 循环体/ 映射/ 成为/ 一个/ 处理单元/ (/ ProcessElement/ ,/ PE/ )/ ,/ 循环/ 控制/ 语句/ 映射/ 成为/ 一个/ 控制/ 单元/ (/ ControlUnit/ ,/ CU/ )/ ,/ 实现/ 对/ 每次/ 迭代/ 启动/ 和/ 结束/ 时间/ 的/ 控制/ ,/ 循环/ 流水/ 控制/ 单元/ 的/ 自动/ 映射/ 需要/ 可/ 重构/ 编译器/ 能够/ 采用/ 自动/ 分析/ 算法/ 获得/ 每次/ 迭代/ 之间/ 的/ 启动/ 间距/ 信息/ ./ 现有/ 细粒度/ 可/ 重构/ 编译器/ 皆/ 采用/ 制导/ 语句/ 方式/ 人工/ 指定/ 迭代/ 间/ 启动/ 间距/ 约束条件/ ,/ 例如/ ,/ Xilinx/ 提供/ 的/ VivadoHLS/ 在/ 实现/ 图/ 2/ (/ a/ )/ 图/ 2/ 嵌套循环/ 及/ N/ =/ 5/ 时带/ 依赖/ 关系/ 的/ 迭代/ 域/ Page4/ 嵌套循环/ 的/ 流水/ 并行/ 硬件/ 结构/ 映射/ 时/ ,/ 通过/ 数次/ 综合/ 和/ 仿真/ 迭代/ ,/ 根据/ 图/ 2/ (/ b/ )/ 迭代/ 域/ 中/ 迭代/ 体间/ RAW/ 数据/ 依赖/ 关系/ 可以/ 得到/ 如图/ 3/ 所示/ 的/ 循环/ 运行/ 时空图/ ,/ 由/ 迭代/ 点/ (/ 3/ ,/ 0/ )/ 与/ 迭代/ 点/ (/ 4/ ,/ 0/ )/ 之间/ 的/ 图/ 3N/ =/ 5/ ,/ II/ =/ 3/ 时/ 循环/ 流水/ 运行/ 时空图/ 通过/ 分析/ 图/ 3/ 所示/ 时空图/ ,/ 可以/ 发现/ 图中/ 虚线/ 箭头/ 所/ 代表/ 的/ RAW/ 数据/ 依赖/ 关系/ 所/ 引起/ 的/ 迭代/ 间/ 启动/ 间距/ 可以/ 进行/ 优化/ ,/ 通过/ 对/ 其/ 启动/ 间距/ 进行/ 手动/ 优化/ 后/ 可以/ 得到/ 如图/ 4/ 所示/ 的/ 循环/ 流水/ 运行/ 时空图/ ,/ 外层/ 循环/ 迭代/ 间/ 启动/ 间距/ 由/ 固定/ 的/ II/ =/ 3/ 变成/ 图/ 4N/ =/ 5/ 时变/ 启动/ 间距/ 循环/ 流水/ 运行/ 时空图/ 通过/ 分析/ 细粒度/ 可/ 重构/ 编译器/ 中/ 采用/ 制导/ 语句/ 生成/ 固定/ 启动/ 间距/ 和/ 非/ 固定/ 启动/ 间距/ 两种/ 循环/ 迭代/ 间/ 流水/ 控制策略/ ,/ 可以/ 发现/ 非/ 固定/ 启动/ 间距/ 控制策略/ 能够/ 更好/ 地/ 提高/ 循环/ 流水/ 的/ 性能/ ./ 但是/ ,/ 按照/ 制导/ 语句/ 方式/ 在/ 细粒度/ 可/ 重构/ 编译器/ 中/ 实现/ 非/ 固定/ 启动/ 间距/ 控制/ 对于/ 用户/ 来说/ 是/ 非常/ 困难/ 的/ ,/ 针对/ 每个/ 多层/ 循环/ 应用程序/ 都/ 需要/ 根据/ 迭代/ 间/ 依赖/ 关系/ 手动/ 分析/ 得到/ 非/ 固定值/ 的/ 启动/ 间距/ 向量/ ,/ 这种/ 工作量/ 对于/ 用户/ 来说/ 是/ 不可/ 接受/ 的/ ./ 另外/ ,/ 在/ 细粒度/ 可/ 重构/ 编译器/ 中/ 采用/ 制导/ 语句/ 方式/ 即/ 手动/ 分析/ 出/ 迭代/ 间/ 最佳/ 启动/ 间距/ 的/ 方法/ ,/ 会/ 在/ 很大/ 程度/ 上/ 由于/ 用户/ 没有/ 得到/ 最佳/ 的/ 启动/ 间距/ 而/ 无法/ 提高/ 循环/ 程序/ 映射/ 生成/ 更优/ 的/ 硬件/ 结构/ ,/ 从而/ 无法/ 得到/ 良好/ 的/ 加速/ 效果/ ./ 这/ 就/ 迫切需要/ 在/ 细粒度/ 可/ 重构/ 编译器/ 中/ 设计/ 并/ 实现/ 一种/ 能够/ 自动/ 得到/ 迭代/ 间/ 启动/ 间距/ 的/ 方法/ ./ 针对/ 这一/ 现状/ ,/ 本文/ 首先/ 建立/ 循环/ 流水/ 启动/ 间距/ 分析模型/ ,/ 并/ 设计/ 实现/ 了/ 自动/ 分析/ 算法/ ;/ 其次/ ,/ 在/ 细粒度/ 可/ 重构/ 编译器/ 中/ 提出/ 了/ 针对/ 循环/ 流水/ 硬件/ 结构/ 的/ 迭代/ 间/ 非/ 固定/ 启动/ 间距/ 控制策略/ ;/ 最后/ ,/ 基于/ 指令/ 调度/ 技术/ 设计/ 并/ 实现/ 了/ 循环/ 流水/ 启动/ 间距/ 自动/ 优化/ 算法/ ./ 上述/ 工作/ 不仅/ 可以/ 有效/ 改善/ 可/ 重构/ 编译器/ 对/ 可/ 重构/ 计算/ 应用/ 的/ 部署/ 效率/ ,/ 还/ 能/ 有效/ 提高/ 循环/ RAW/ 依赖/ 关系/ 约束条件/ (/ 如图/ 3/ 中/ 实线/ 箭头/ 所示/ )/ 选择/ 索引/ 变量/ i/ 确定/ 的/ 循环体/ 迭代/ 间/ 最佳/ 启动/ 间距/ #/ pragmaII/ =/ 3/ ,/ 但是/ ,/ 通过/ 这种/ 制导/ 语句/ 的/ 方式/ 只能/ 确定/ 固定/ 的/ 启动/ 间距/ 大小/ ./ 非/ 固定/ 的/ 启动/ 间距/ 向量/ 犐/ 犐/ =/ (/ 1/ ,/ 1/ ,/ 2/ ,/ 3/ )/ ./ 对/ 多层/ 循环/ 外层/ 循环/ 迭代/ 间/ 采用/ 非/ 固定/ 启动/ 间距/ 方式/ 执行/ 过程/ 进行/ 分析/ ,/ 可以/ 得出/ ,/ 采用/ 非/ 固定/ 启动/ 间距/ 策略/ 能够/ 提高/ 循环/ 程序/ 硬件/ 使用率/ 13.7/ %/ ,/ 减少/ 循环/ 执行/ 时钟/ 周期/ 19/ %/ ./ 流水/ 硬件/ 结构/ 的/ 性能/ ./ 3.2/ 循环/ 流水/ 启动/ 间距/ 分析模型/ 现有/ 可/ 重构/ 编译器/ 在/ 进行/ 多层/ 循环/ 流水/ 硬件/ 结构/ 映射/ 时/ ,/ 将/ 循环体/ 映射/ 成为/ 一个/ 独立/ 的/ 硬件加速/ 单元/ ,/ 通过/ 重叠/ PE/ 单元/ 的/ 执行/ 来/ 实现/ 流水/ 并行/ ,/ 两次/ 相邻/ 循环体/ 执行/ 之间/ 的/ 时间差/ 称为/ 启动/ 间距/ ,/ 可/ 重构/ 编译器/ 将/ 启动/ 间距/ 信息/ 映射/ 成为/ 循环/ 调度/ 控制/ 单元/ ./ 由于/ 细粒度/ 可/ 重构/ 编译器/ 对于/ 多层/ 循环/ 的/ 形式/ 具有/ 一定/ 的/ 限制/ ,/ 因此/ 本文/ 只/ 针对/ 定义/ 1/ 中/ 描述/ 的/ 计数/ 类/ 多层/ 循环/ 程序/ 进行/ 启动/ 间距/ 分析/ ./ 定义/ 1/ ./ 计数/ 类/ 多层/ 循环/ ./ 索引/ 变量/ 向量/ 犐/ =/ (/ I1/ ,/ I2/ ,/ I3/ ,/ …/ ,/ Im/ )/ ,/ 其中/ m/ 为/ 多层/ 循环/ 的/ 最大/ 深度/ ;/ Loop/ (/ r/ )/ 表示/ 索引/ 变量/ 为/ Ir/ 的/ 循环/ ,/ 其中/ 1/ / r/ / m/ ,/ 循环体/ 用/ stmt/ (/ 犐/ r/ )/ 表示/ ,/ 犐/ r/ =/ (/ I1/ ,/ I2/ ,/ I3/ ,/ …/ ,/ Ir/ )/ ,/ 表示/ 循环体/ 由/ 索引/ 向量/ 犐/ r/ 控制/ ,/ 索引/ 变量/ Ir/ =/ (/ pr/ ,/ qr/ ,/ θ/ r/ )/ ,/ 其中/ ,/ pr/ 和/ qr/ 分别/ 表示/ 索引/ 变量/ Ir/ 的/ 初值/ 和/ 终值/ ,/ 且/ 是/ (/ I1/ ,/ I2/ ,/ …/ ,/ Ir/ -/ 1/ )/ 的/ 整值/ 函数/ ,/ θ/ r/ 表示/ 循环/ 变量/ Ir/ 的/ 增量/ 且/ θ/ r/ 为/ 常数/ ./ 为了/ 建立/ 循环/ 流水/ 启动/ 间距/ 信息/ 模型/ ,/ 需要/ 将/ 图/ 5/ 所/ 描述/ 的/ 多层/ 循环/ Loop/ 抽象/ 成如图/ 6/ 所示/ 多个/ 单层/ 循环/ 递归/ 表示/ 的/ 形式/ ./ 其中/ Loop/ (/ m/ )/ 表示/ 最/ 内层/ 循环/ ./ Page5/ 在/ 细粒度/ 可/ 重构/ 编译器/ ASCRA/ 中是/ 对/ 中间代码/ IR/ 进行/ 数据/ 依赖/ 关系/ 分析/ ,/ 将/ 图/ 5/ 所示/ 的/ 高级/ 语言/ 描述/ 形式/ 转换成/ LLVM/ 能够/ 进行/ 分析/ 的/ 数据结构/ ,/ 通过/ LLVMPASS/ 将/ 多层/ 循环/ 描述/ 成/ 一种/ 抽象/ 语法/ 树/ (/ AbstractSyntaxTree/ ,/ AST/ )/ ,/ 筛选/ 符合/ 定义/ 1/ 中所/ 描述/ 的/ 限制/ 条件/ 的/ 计数/ 类/ 多层/ 循环/ ,/ 实现/ 图/ 5/ 到/ 图/ 6/ 循环/ 表示/ 形式/ 的/ 抽象/ 表示/ ./ 本文/ 定义/ 的/ AST/ 数据结构/ 采用/ 定义/ 2/ 中/ 描述/ 的/ SCoPs/ (/ StaticControlParts/ )/ 描述/ ./ 定义/ 2/ ./ SCoPs/ ./ SCoPs/ 由/ context/ 和/ 一系列/ 声明/ statement/ 构成/ 一个二元/ 组/ 〈/ Context/ ,/ [/ Statement/ ]/ 〉/ ./ 其中/ context/ 是/ SCoP/ 约束/ 参数/ 的/ 集合/ ;/ 每个/ 声明/ statement/ 都/ 是/ 一个/ 四元组/ 〈/ Name/ ,/ Domain/ ,/ Schedule/ ,/ [/ Access/ ]/ 〉/ ,/ Statement/ 的/ 单位/ 是/ 多层/ 循环/ Loop/ 中/ 循环体/ stmt/ (/ 犐/ r/ )/ ,/ 其中/ 1/ / r/ / m/ ,/ 其中/ Name/ 表示/ 声明/ statement/ 的/ 名称/ ,/ 是/ 声明/ 的/ 唯一/ 标识符/ ;/ Domain/ 是/ 声明/ 的/ 迭代/ 域/ ,/ 表示/ 一个/ statement/ 在/ 多层/ 循环/ 中/ 的/ 多维/ 迭代/ 空间/ 域/ ,/ 限制/ 了/ statement/ 的/ 迭代/ 范围/ ;/ Schedule/ 是/ 多维/ 空间/ 中/ 迭代/ 向量/ 的/ 整型/ 映射/ ,/ 表示/ 迭代/ 空间/ 中/ statement/ 的/ 迭代/ 向量/ ;/ [/ Access/ ]/ 是/ 声明/ 中/ 对/ 数组/ 元素/ 的/ 访存/ 操作/ 集合/ ,/ 主要/ 包括/ 读/ 、/ 写/ 、/ 读写/ 3/ 种/ ./ 本文/ 提出/ 的/ SCoPs/ 数据结构/ 基于/ LLVM/ 开发/ 的/ 多面体/ 模型/ 分析程序/ 开源/ 软件/ Polly/ 计/ ,/ 由于/ 其/ 能够/ 准确/ 地/ 对/ 不同/ 深度/ 循环体/ 中/ 数组/ 元素/ 访存/ 操作/ 进行/ 描述/ ,/ 有利于/ 对/ 计数/ 类/ 多层/ 循环/ 迭代/ 间/ 的/ 数据/ 依赖/ 关系/ 进行/ 精确/ 分析/ ./ 例如/ ,/ 图/ 7/ 中/ 所示/ 的/ 多层/ 循环/ 可以/ 用图/ 8/ 所示/ SCoPs/ 表示/ ,/ 其中/ ,/ 循环/ Loop/ (/ i/ )/ 中/ 的/ 循环体/ stmt/ (/ i/ )/ =/ Loop/ (/ j/ )/ ,/ 所以/ Statement/ 只/ 描述/ 了/ stmt/ (/ 犐/ j/ )/ 的/ 声明/ ,/ 犐/ j/ =/ (/ i/ ,/ j/ )/ ./ Context/ =/ {/ [/ N/ ]/ }/ ;/ Statement/ =/ {/ Name/ =/ stmt/ [/ i/ ,/ j/ ]/ :/ }/ 利用/ 得到/ 的/ SCoPs/ 数据结构/ 可以/ 进行/ 循环体/ 迭代/ 间/ 数据/ 依赖/ 关系/ 分析/ ,/ 本文/ 基于/ 改进/ 后/ 的/ ISL/ 数据流/ 分析方法/ [/ 9/ ]/ ,/ 可以/ 得到/ 写后/ 读/ (/ ReadAfterWrite/ ,/ RAW/ )/ 、/ 写/ 后写/ (/ WriteAfterWrite/ ,/ WAW/ )/ 、/ 读后/ 写/ (/ WriteAfterRead/ ,/ WAR/ )/ 3/ 种/ 数据/ 依赖/ 关系/ ./ 在/ 可/ 重构/ 编译器/ 中/ 实现/ 循环/ 程序/ 到/ 并行/ 流水/ 硬件/ 结构/ 的/ 自动/ 映射/ 时/ ,/ WAW/ 数据/ 依赖/ 关系/ 表示/ 对/ 存储/ 结构/ 中/ 的/ 数组/ 元素/ 进行/ 数据/ 覆盖/ ,/ 后/ 一次/ 迭代/ 执行/ 时/ 计算出来/ 的/ 结果/ 是/ 正确/ 的/ 数据/ ,/ 而/ 循环/ 程序/ 流水/ 执行/ 时/ ,/ 循环体/ 每/ 一次/ 迭代/ 运行/ 的/ 时钟/ 周期/ 数是/ 相同/ 的/ ,/ 由于/ 迭代/ 间/ 启动/ 间距/ 至少/ 是/ 一个/ 时钟/ 周期/ ,/ 所以/ 对于/ 存储/ 结构/ 中/ 最终/ 的/ 写/ 操作/ ,/ 都/ 是/ 后面/ 所/ 执行/ 的/ 迭代/ 运算/ 的/ 结果/ ,/ 因此/ WAW/ 数据/ 依赖/ 关系/ 不/ 影响/ 程序/ 流水/ 执行/ 时/ 的/ 最终/ 计算结果/ ./ WAR/ 数据/ 依赖/ 关系/ 表示/ 在/ 程序执行/ 时/ ,/ 对于/ 存储单元/ 中/ 的/ 数据/ 先/ 执行/ 读/ 操作/ ,/ 然后/ 才能/ 进行/ 对应/ 存储/ 位置/ 的/ 写/ 操作/ ,/ 为了/ 避免/ 下/ 一次/ 迭代/ 执行/ 时写/ 操作/ 比上/ 一次/ 迭代/ 执行/ 时/ 的/ 读/ 操作/ 提前/ ,/ 从而/ 导致/ 上/ 一次/ 迭代/ 执行/ 时/ 读取/ 错误/ 的/ 数据/ ,/ 在/ 可/ 重构/ 编译器/ 进行/ 循环/ 流水/ 硬件/ 结构/ 的/ 映射/ 时/ ,/ 可以/ 设计/ 数据/ 缓存/ 结构/ ,/ 采用/ 在/ 每/ 一次/ 迭代/ 运行/ 之前/ 将/ 所有/ 的/ 数据/ 元素/ 提前/ 预取/ 的/ 方法/ ,/ 来/ 避免/ WAR/ 对/ 上/ 一次/ 迭代/ 运算/ 所/ 需要/ 的/ 数据/ 产生/ 影响/ ,/ 不/ 影响/ 循环/ 程序/ 流水/ 执行/ 时/ 迭代/ 间/ 启动/ 间距/ 的/ 运算/ ./ 而/ RAW/ 操作/ 表示/ 循环/ 程序执行/ 时/ ,/ 下/ 一次/ 迭代/ 所用/ 到/ 的/ 数据/ 必须/ 是/ 上/ 一次/ 迭代/ 计算/ 得到/ 的/ 结果/ 数据/ ,/ 为了/ 保证/ 程序运行/ 的/ 正确性/ ,/ 除了/ 采用/ 相关/ 的/ 编译/ 优化/ 技术/ 进行/ RAW/ 数据/ 依赖/ 关系/ 消除/ 之外/ ,/ 在/ 循环/ 程序/ 进行/ 流水/ 执行/ 时/ ,/ 下/ 一次/ Page6/ 迭代/ 进行/ 只能/ 等待/ 上/ 一次/ 的/ 迭代/ 运算/ 完成/ ./ 因此/ RAW/ 数据/ 依赖/ 关系/ 是/ 影响/ 循环/ 程序/ 流水/ 执行/ 时/ 迭代/ 间/ 启动/ 间距/ 的/ 关键因素/ ./ 因此/ 本文/ 只/ 考虑/ RAW/ 数据/ 依赖/ 关系/ 的/ 分析/ 结果/ ./ 在/ 实现/ 多层/ 循环/ 迭代/ 间/ 启动/ 间距/ 自动/ 分析/ 的/ 基础/ 上/ ,/ 本文/ 充分利用/ 带有/ 流水线/ 延迟/ 信息/ 的/ RAW/ 数据/ 依赖/ 分析模型/ (/ DataDependenceAnalysisofRAW/ ,/ RAW/ _/ DDA/ )/ ,/ 如/ 定义/ 3/ 所示/ ,/ 并/ 结合/ 流水线/ 调度/ 技术/ 对/ 迭代/ 间/ 启动/ 间距/ 进行/ 优化/ ./ 定义/ 3/ ./ RAW/ _/ DDA/ 模型/ ./ RAW/ _/ DDA/ =/ (/ statement/ ,/ I/ ,/ [/ Array/ ]/ ,/ [/ NEXT/ ]/ )/ ./ 其中/ statement/ 表示/ 多层/ 循环/ 程序/ 中/ 的/ 一个/ 循环体/ stmt/ (/ 犐/ r/ )/ 的/ 声明/ ;/ I/ 表示/ 循环体/ stmt/ (/ 犐/ r/ )/ 索引/ 变量/ Ir/ ,/ 1/ / r/ / m/ ;/ [/ Array/ ]/ 是/ 与/ 索引/ 变量/ Ir/ 相关/ 的/ RAW/ 数据/ 依赖/ 关系/ 涉及/ 到/ 的/ 数组/ 集合/ ,/ 用/ Array/ (/ Ir/ )/ 表示/ ;/ [/ NEXT/ ]/ 表示/ statement/ 声明/ 中/ 所有/ 迭代/ 间/ RAW/ 数据/ 依赖/ 关系/ 集合/ ,/ 用/ NEXT/ (/ Array/ (/ Ir/ )/ )/ 表示/ Array/ (/ Ir/ )/ 中/ 单个/ 数组/ 所/ 引起/ 的/ RAW/ 数据/ 依赖/ 关系/ 集合/ ,/ 其中/ NEXT/ 是/ 一个/ 三元组/ (/ next/ ,/ δ/ ,/ Δ/ )/ ,/ 其中/ δ/ 表示/ 迭代/ 间/ RAW/ 数据/ 依赖/ 关系/ 的/ 依赖/ 距离/ ,/ Δ/ 表示/ 依赖/ 关系/ next/ 在/ 循环体/ stmt/ (/ 犐/ r/ )/ 中/ 跨过/ 的/ 流水/ 段/ 延时/ ./ 为了/ 更好/ 地/ 理解/ 定义/ 3/ 所示/ 的/ RAW/ _/ DDA/ 模型/ ,/ 下面/ 通过/ 一个/ 循环/ 程序/ 例子/ 进行/ 详细/ 阐述/ ./ 如图/ 9/ 所示/ ,/ 表示/ 包含/ 数组/ 元素/ A/ [/ i/ ]/ 和/ B/ [/ i/ ]/ 的/ 循环体/ 程序/ 经过/ 流水线/ 划分/ 后/ 的/ 数据流/ 图/ 结果/ ,/ 其中/ 包含/ 3/ 个/ RAW/ 数据/ 依赖/ 关系/ ./ 在/ RAW/ _/ DDA/ 模型/ 中/ ,/ statement/ 表示/ 该/ 循环/ 程序/ 循环体/ 的/ 声明/ ,/ I/ 表示/ 循环体/ 索引/ 变量/ i/ ,/ [/ Array/ ]/ 是/ 与/ 索引/ 变量/ i/ 相关/ 的/ RAW/ 数据/ 依赖/ 关系/ 涉及/ 到/ 的/ 数组/ 集合/ ,/ 则/ [/ Array/ ]/ =/ {/ A/ [/ i/ ]/ ,/ B/ [/ i/ ]/ }/ ./ 关于/ 数组/ A/ [/ i/ ]/ 包括/ 2/ 个/ RAW/ 数据/ 依赖/ 关系/ next/ _/ A/ _/ 1/ =/ {/ A/ [/ i/ +/ 2/ ]/ →/ A/ [/ i/ +/ 4/ ]/ }/ 和/ next/ _/ A/ _/ 2/ =/ {/ A/ [/ i/ ]/ →/ A/ [/ i/ +/ 4/ ]/ }/ ,/ 其中/ next/ _/ A/ _/ 1/ 的/ 依赖/ 距离/ δ/ =/ 2/ ,/ 跨过/ 的/ 流水/ 段/ 延时/ Δ/ =/ 7/ ,/ 在/ RAW/ _/ DDA/ 模型/ 中/ 表示/ 为/ NEXTnext/ _/ A/ _/ 1/ =/ {/ A/ [/ i/ +/ 2/ ]/ →/ A/ [/ i/ +/ 4/ ]/ ,/ δ/ =/ 2/ ,/ Δ/ =/ 7/ }/ ,/ next/ _/ A/ _/ 2/ 的/ 依赖/ 距离/ δ/ =/ 4/ ,/ 跨过/ 的/ 流水/ 段/ 延时/ Δ/ =/ 7/ ,/ 在/ RAW/ _/ DDA/ 模型/ 中/ 表示/ 为/ NEXTnext/ _/ A/ _/ 2/ =/ {/ A/ [/ i/ ]/ →/ A/ [/ i/ +/ 4/ ]/ ,/ δ/ =/ 4/ ,/ Δ/ =/ 7/ }/ ,/ 则/ 在/ 该/ 循环/ 程序/ 中/ 数组/ 元素/ A/ [/ i/ ]/ 引起/ 的/ RAW/ 数据/ 依赖/ 关系/ 集合/ NEXT/ (/ A/ [/ i/ ]/ )/ =/ {/ NEXTnext/ _/ A/ _/ 1/ =/ {/ A/ [/ i/ +/ 2/ ]/ →/ A/ [/ i/ +/ 4/ ]/ ,/ δ/ =/ 2/ ,/ Δ/ =/ 7/ }/ ,/ NEXTnext/ _/ A/ _/ 2/ =/ {/ A/ [/ i/ ]/ →/ A/ [/ i/ +/ 4/ ]/ ,/ δ/ =/ 4/ ,/ Δ/ =/ 7/ }/ }/ ;/ 关于/ 数组/ B/ [/ i/ ]/ 存在/ RAW/ 数据/ 依赖/ 关系/ next/ _/ B/ _/ 1/ =/ {/ B/ [/ i/ ]/ →/ B/ [/ i/ +/ 2/ ]/ }/ ,/ next/ _/ B/ _/ 1/ 的/ 依赖/ 距离/ δ/ =/ 2/ ,/ 跨过/ 的/ 流水/ 段/ 延时/ Δ/ =/ 4/ ,/ 在/ RAW/ _/ DDA/ 模型/ 中/ 表示/ 为/ NEXTnext/ _/ B/ _/ 1/ =/ {/ B/ [/ i/ ]/ →/ B/ [/ i/ +/ 2/ ]/ ,/ δ/ =/ 4/ ,/ Δ/ =/ 7/ }/ ,/ NEXT/ (/ B/ [/ i/ ]/ )/ =/ {/ NEXTnext/ _/ B/ _/ 1/ =/ {/ B/ [/ i/ ]/ →/ B/ [/ i/ +/ 2/ ]/ ,/ δ/ =/ 4/ ,/ Δ/ =/ 7/ }/ }/ ./ 在/ RAW/ _/ DDA/ 模型/ 中/ ,/ 使用/ [/ NEXT/ ]/ 表示/ 循环/ 程序/ 中/ 所有/ RAW/ 数据/ 依赖/ 关系/ 的/ 集合/ ,/ 因此/ [/ NEXT/ ]/ =/ {/ NEXTnext/ _/ A/ _/ 1/ ,/ NEXTnext/ _/ A/ _/ 2/ ,/ NEXTnext/ _/ B/ _/ 1/ }/ ./ 图/ 9/ 具有/ RAW/ 依赖/ 关系/ 的/ 循环/ 迭代/ 体/ 数据流/ 基于/ 数据/ 依赖/ 关系/ 分析/ 算法/ 得到/ 的/ RAW/ _/ DDA/ 结果/ ,/ 本文/ 对/ 多层/ 循环/ 中/ 每/ 一个/ 循环体/ stmt/ (/ 犐/ r/ )/ 进行/ 迭代/ 间/ 启动/ 间距/ 分析/ ,/ 当/ 循环体/ stmt/ (/ 犐/ r/ )/ 的/ 索引/ 变量/ Ir/ 的/ 边界/ pr/ 或/ qr/ 是/ 变量/ 时/ ,/ 会/ 引起/ 迭代/ 间/ 的/ 启动/ 间距/ 不是/ 一个/ 固定值/ ,/ 本文/ 提出/ 采用/ 向量/ 来/ 表示/ 迭代/ 间/ 启动/ 间距/ 信息/ ,/ 建立/ 非/ 固定/ 启动/ 间距/ 模型/ NF/ _/ II/ (/ None/ -/ FixedInitiationInterval/ )/ ,/ 如/ 定义/ 4/ 所述/ ./ 定义/ 4/ ./ NF/ _/ II/ 模型/ ./ 多层/ 循环/ 中/ 循环体/ 迭代/ 间/ 启动/ 间距/ 信息/ 用/ 二维/ 向量/ 犖/ 犉/ _/ 犐/ 犐/ 表示/ ,/ 犖/ 犉/ _/ 犐/ 犐/ =/ (/ 犐/ 犐/ 1/ ,/ 犐/ 犐/ 2/ ,/ …/ ,/ 犐/ 犐/ r/ ,/ …/ ,/ 犐/ 犐/ m/ )/ ,/ 1/ / r/ / m/ ./ 其中/ 犐/ 犐/ r/ 表示/ 循环体/ stmt/ (/ 犐/ r/ )/ 在/ 索引/ 变量/ Ir/ 控制/ 下/ 流水/ 启动/ 时/ 的/ 延时/ 向量/ ,/ 即/ 循环体/ stmt/ (/ 犐/ r/ )/ 在/ 迭代/ 空间/ 中/ 迭代/ 点/ (/ I1/ ,/ I2/ ,/ …/ ,/ Ir/ ,/ …/ ,/ Im/ )/ 与/ (/ I1/ ,/ I2/ ,/ …/ ,/ Ir/ +/ θ/ r/ ,/ …/ ,/ Im/ )/ 之间/ 的/ 启动/ 延时/ 按照/ 迭代/ 顺序/ 生成/ 的/ 迭代/ 间/ 启动/ 间距/ 向量/ ./ 对于/ 索引/ 变量/ 为/ Ir/ =/ (/ pr/ ,/ qr/ ,/ θ/ r/ )/ 的/ 循环体/ stmt/ (/ 犐/ r/ )/ ,/ 各个/ 迭代/ 点/ 之间/ 启动/ 间距/ 延时/ 按照/ 迭代/ 顺序/ 生成/ ,/ 每次/ 迭代/ 之间/ 的/ 启动/ 延时/ 向量/ 为/ 犐/ 犐/ r/ ./ 例如/ ,/ 当/ 犐/ r/ =/ (/ i/ ,/ j/ )/ ,/ Ii/ =/ (/ 0/ ,/ 4/ ,/ 1/ )/ ,/ Ij/ =/ (/ 0/ ,/ 5/ ,/ 1/ )/ 时/ ,/ 对应/ 的/ 循环/ 程序/ 如图/ 10/ 所示/ ,/ 初始化/ 循环体/ stmt/ (/ 0/ ,/ 0/ )/ 的/ 启动/ 延时/ 为/ 1/ ,/ 假如/ stmt/ (/ 0/ ,/ 0/ )/ 与/ stmt/ (/ 0/ ,/ 1/ )/ 之间/ 的/ 启动/ 延时/ 为/ 2/ ,/ stmt/ (/ 0/ ,/ 1/ )/ 与/ stmt/ (/ 0/ ,/ 2/ )/ 之间/ 的/ 启动/ 延时/ 为/ 1/ ,/ stmt/ (/ 0/ ,/ 2/ )/ 与/ stmt/ (/ 0/ ,/ 3/ )/ 之间/ 的/ 启动/ 延时/ 为/ 1/ ,/ stmt/ (/ 0/ ,/ 3/ )/ 与/ stmt/ (/ 0/ ,/ 4/ )/ 之间/ 的/ 启动/ 延时/ 为/ 2/ ,/ 则/ 循环体/ stmt/ (/ i/ ,/ j/ )/ 在/ 索引/ 变量/ j/ 控制/ 下/ 迭代/ 间/ 流水/ 启动/ Page7/ 间距/ 向量/ 犐/ 犐/ j/ =/ (/ 1/ ,/ 2/ ,/ 1/ ,/ 1/ ,/ 2/ )/ ;/ 假如/ stmt/ (/ 0/ ,/ 0/ )/ 与/ stmt/ (/ 1/ ,/ 0/ )/ 之间/ 的/ 启动/ 延时/ 为/ 1/ ,/ stmt/ (/ 1/ ,/ 0/ )/ 与/ stmt/ (/ 2/ ,/ 0/ )/ 之间/ 的/ 启动/ 延时/ 为/ 3/ ,/ stmt/ (/ 2/ ,/ 0/ )/ 与/ stmt/ (/ 3/ ,/ 0/ )/ 之间/ 的/ 启动/ 延时/ 为/ 1/ ,/ stmt/ (/ 3/ ,/ 0/ )/ 与/ stmt/ (/ 4/ ,/ 0/ )/ 之间/ 的/ 启动/ 延时/ 为/ 2/ ,/ 则/ 循环体/ stmt/ (/ i/ ,/ j/ )/ 在/ 索引/ 变量/ i/ 控制/ 下/ 迭代/ 间/ 流水/ 启动/ 间距/ 向量/ 犐/ 犐/ i/ =/ (/ 1/ ,/ 1/ ,/ 3/ ,/ 1/ ,/ 2/ )/ ;/ 最终/ ,/ 该/ 循环/ 程序/ 的/ 迭代/ 间/ 启动/ 间距/ 信息/ 可以/ 表示/ 为/ 犖/ 犉/ _/ 犐/ 犐/ =/ (/ (/ 1/ ,/ 1/ ,/ 3/ ,/ 1/ ,/ 2/ )/ ,/ (/ 1/ ,/ 2/ ,/ 1/ ,/ 1/ ,/ 2/ )/ )/ ./ NF/ _/ II/ 模型/ 能够/ 表示/ 计数/ 类/ 多层/ 循环/ 中/ 循环体/ stmt/ (/ 犐/ r/ )/ 每次/ 迭代/ 流水/ 执行/ 启动/ 时/ 的/ 精确/ 时间/ ,/ 采用/ 非/ 固定/ 启动/ 间距/ 的/ 思想/ ,/ 实现/ 细粒度/ 可/ 重构/ 编译/ 生成/ 的/ 多层/ 循环/ 流水/ 硬件/ 单元/ 的/ 时序/ 控制/ ,/ 能够/ 有效/ 减少/ 多层/ 循环/ 流水/ 执行/ 时/ 的/ 冒泡/ 现象/ ,/ 提高/ 多层/ 循环/ 流水/ 执行/ 的/ 吞吐/ 率/ ./ 3.3/ 启动/ 间距/ 自动/ 分析/ 算法/ 根据/ RAW/ _/ DDA/ 得到/ 的/ RAW/ 数据/ 依赖/ 关系/ 分析/ 结果/ 进行/ 多层/ 循环/ 的/ 迭代/ 间/ 启动/ 间距/ 分析/ 时/ ,/ 将/ 多层/ 循环/ 按照/ 图/ 5/ 所示/ 递归/ 表示/ 成/ 多个/ 单层/ 循环/ 的/ 形式/ ,/ Loop/ (/ r/ )/ 中/ 循环体/ stmt/ (/ 犐/ r/ )/ 迭代/ 之间/ 启动/ 间距/ 是/ 由/ 与/ 索引/ 变量/ Ir/ 相关/ 的/ RAW/ 数据/ 依赖/ 关系/ 所/ 决定/ 的/ ,/ 其中/ 1/ / r/ / m/ ,/ Loop/ (/ r/ )/ 的/ 启动/ 间距/ 向量/ 犐/ 犐/ r/ 与/ 索引/ 变量/ Ir/ 存在/ 一对一/ 仿射/ 关系/ ,/ 如式/ (/ 1/ )/ 所示/ ,/ 其中/ ,/ k/ 是/ 正整数/ ./ 犐/ 犐/ r/ =/ (/ IIpr/ 循环体/ stmt/ (/ 犐/ r/ )/ 中/ 迭代/ 点/ Ir/ =/ pr/ +/ k/ ·/ θ/ r/ 与/ Ir/ =/ pr/ +/ (/ k/ +/ 1/ )/ ·/ θ/ r/ 之间/ 的/ 启动/ 间距/ 为/ IIpr/ +/ (/ k/ +/ 1/ )/ ·/ θ/ r/ ,/ 启动/ 间距/ IIIr/ 数据/ 依赖/ 关系/ NEXT/ =/ (/ next/ ,/ δ/ ,/ Δ/ )/ 与/ 启动/ 间距/ 向量/ 犐/ 犐/ r/ 中/ 每个/ 启动/ 间距/ IIIr/ 中/ delay/ 表示/ 依赖/ 关系/ next/ 在/ 循环/ Loop/ (/ r/ )/ 中/ 循环体/ 迭代/ 之间/ 的/ 时钟/ 延时/ ./ 对于/ 索引/ 变量/ Ir/ 所/ 控制/ 的/ 循环体/ stmt/ (/ 犐/ r/ )/ 来说/ ,/ 当/ k/ =/ 0/ 时/ ,/ 表示/ 该/ 循环体/ 第一次/ 启动/ ,/ 因此/ ,/ 设置/ 该/ 循环体/ 在/ 索引/ 变量/ Ir/ 控制/ 下/ 的/ 第一次/ 迭代/ 启动/ 时间/ 延时/ 为/ 1/ ./ 当/ k/ >/ 0/ 时/ ,/ 如果/ 存在/ RAW/ 数据/ 依赖/ 关系/ NEXT/ =/ (/ next/ ,/ δ/ ,/ Δ/ )/ ,/ 当/ 依赖/ 关系/ next/ 在/ 循环体/ stmt/ (/ 犐/ r/ )/ 中/ 跨过/ 的/ 流水/ 段/ 延时/ Δ/ 与/ 索引/ 变量/ Ir/ 的/ 增量/ θ/ r/ 之间/ 的/ 乘积/ 小于/ 该/ 依赖/ 关系/ next/ 在/ 循环体/ 迭代/ 之间/ 的/ 时钟/ 延时/ ,/ 说明/ 该/ RAW/ 依赖/ 关系/ 不会/ 影响/ 下/ 一次/ 迭代/ 启动/ 延时/ ,/ 因此/ 下/ 一次/ 迭代/ 的/ 启动/ 间距/ 设置/ 为/ 1/ ;/ 如果/ 依赖/ 关系/ next/ 在/ 循环体/ stmt/ (/ 犐/ r/ )/ 中/ 跨过/ 的/ 流水/ 段/ 延时/ Δ/ 与/ 索引/ 变量/ Ir/ 的/ 增量/ θ/ r/ 之间/ 的/ 乘积/ 大于/ 等于/ 该/ 依赖/ 关系/ next/ 在/ 循环体/ 迭代/ 之间/ 的/ 时钟/ 延时/ ,/ 则/ 说明/ 该/ 依赖/ 关系/ 会/ 影响/ 迭代/ 间/ 启动/ 间距/ 演示/ ,/ 本文/ 首先/ 初始化/ 该/ 依赖/ 关系/ 经过/ 的/ 所有/ 迭代/ 启动/ 延时/ 为/ 1/ ,/ 然后/ 对/ 最后/ 一次/ 迭代/ 进行/ 启动/ 时间/ 推迟/ ,/ 因此/ 当/ k/ %/ delay/ ≠/ 0/ 时/ ,/ 迭代/ 间/ 启动/ 间距/ 置/ 为/ 1/ ,/ 当/ k/ %/ delay/ =/ 0/ 时/ ,/ 进行/ 启动/ 时间/ 推迟/ ,/ 经过/ 对/ 循环/ 程序/ 迭代/ 间/ 执行/ 时间/ 进行/ 分析/ ,/ 得到/ 式/ (/ 2/ )/ 中/ 所示/ 结果/ ./ 本文/ 所/ 提出/ 迭代/ 间/ 启动/ 间距/ 自动/ 分析/ 算法/ 的/ 前提/ 是/ 如何/ 计算/ RAW/ 数据/ 依赖/ 关系/ next/ 在/ 循环体/ 两次/ 迭代/ 之间/ 的/ 时钟/ 延时/ ./ 烄/ IIIr/ =/ 烅/ 烆/ 为了/ 得到/ RAW/ 数据/ 依赖/ 关系/ next/ 在/ 两次/ 迭代/ 之间/ 的/ 延时/ 信息/ delay/ ,/ 本文/ 提出/ 式/ (/ 3/ )/ ~/ (/ 5/ )/ 所示/ 的/ 递归计算/ 方法/ ,/ 在/ 循环/ Loop/ (/ r/ )/ 中/ ,/ 根据/ RAW/ 依赖/ 关系/ next/ 的/ 依赖/ 距离/ δ/ 可以/ 获得/ 具有/ 依赖/ 关系/ next/ 的/ 两次/ 迭代/ 之间/ 的/ 延时/ delay/ ,/ 如式/ (/ 3/ )/ 所示/ ,/ 其中/ T/ (/ Loop/ (/ r/ +/ 1/ )/ )/ 表示/ 在/ 循环/ Loop/ (/ r/ )/ 中/ 索引/ 变量/ 为/ Ir/ 时/ 循环/ Loop/ (/ r/ +/ 1/ )/ 流水/ 执行/ 时/ 的/ 时钟/ 周期/ ./ 循环/ Loop/ (/ r/ )/ 的/ 两次/ 迭代/ 之间/ 延时/ delay/ 由/ 最/ 内层/ 循环/ Loop/ (/ m/ )/ 的/ 循环体/ stmt/ (/ 犐/ m/ )/ 以/ 递归/ 形式/ 计算/ 得到/ ,/ 循环/ Loop/ (/ m/ )/ 的/ 迭代/ 间/ 启动/ 间距/ 向量/ 为/ 犐/ 犐/ m/ ,/ 根据/ 本文/ 提出/ 的/ 非/ 固定/ 启动/ 间距/ 思想/ ,/ 在/ 实现/ 循环/ 内部/ 流水/ 执行/ 的/ 同时/ ,/ 还/ 可以/ 实现/ 循环/ 层间流/ 水/ 执行/ ./ 在/ 进行/ 循环/ 流水/ 迭代/ 间/ 启动/ 间距/ 分析/ 时/ ,/ 首先/ 根据/ 式/ (/ 5/ )/ 对/ 最/ 内层/ 循环/ Loop/ (/ m/ )/ 的/ 迭代/ 间/ 启动/ 间距/ 进行/ 初始化/ ,/ 相邻/ 两次/ 迭代/ stmt/ (/ Im/ )/ 之间/ 的/ 启动/ 间距/ 设置/ 为/ 1/ ,/ 则/ 根据/ 式/ (/ 3/ )/ 可以/ 得到/ Loop/ (/ m/ )/ 中/ RAW/ 数据/ 依赖/ 关系/ NEXT/ =/ (/ next/ ,/ δ/ ,/ Δ/ )/ 所/ 经过/ 的/ 迭代/ 间/ 延时/ 信息/ delay/ =/ δ/ ,/ 则/ 可以/ 根据/ 式/ (/ 2/ )/ 计算/ 出/ 最/ 内层/ 循环/ 每次/ 迭代/ 之间/ 的/ 启动/ 间距/ 向量/ 犐/ 犐/ Im/ ./ 将/ 最/ 内层/ 循环/ 的/ 迭代/ 间/ 流水/ 启动/ 时间/ 确定/ 好/ 之后/ ,/ 可以/ 根据/ 式/ (/ 4/ )/ 计算/ 得出/ r/ =/ m/ -/ 1/ 时/ 的/ 循环/ Loop/ (/ r/ )/ 中/ 内层/ 循环/ Loop/ (/ m/ )/ 流水/ 执行/ 时/ 的/ 运行/ 时钟/ 周期/ 数/ T/ (/ Loop/ (/ r/ )/ )/ ,/ 以/ 循环/ Loop/ (/ m/ )/ 作为/ 循环/ Loop/ (/ m/ -/ 1/ )/ 的/ 循环体/ ,/ 进而/ 根据/ 式/ (/ 2/ )/ ~/ (/ 3/ )/ 可以/ 求/ Page8/ 出/ 循环/ Loop/ (/ m/ -/ 1/ )/ 中/ 每次/ 迭代/ 之间/ 的/ 启动/ 间距/ 向量/ ./ 如式/ (/ 4/ )/ 所示/ ,/ 在/ 计算/ 最/ 内层/ 循环/ Loop/ (/ m/ )/ 的/ 运行/ 时间/ T/ (/ Loop/ (/ m/ )/ )/ 时/ ,/ 由于/ 每次/ 迭代/ 启动/ 时间/ 为/ 一个/ 时钟/ 周期/ ,/ 因此/ 直接/ 将/ 最/ 内层/ 循环/ 的/ 每次/ 迭代/ 启动/ 间距/ 值/ 进行/ 求和/ ./ 在/ 得到/ 最/ 内层/ 循环/ 执行/ 时间/ 之后/ ,/ 结合/ 内层/ 循环/ 迭代/ 间/ 启动/ 间距/ 信息/ ,/ 就/ 可以/ 利用/ 式/ (/ 4/ )/ 递归计算/ 出/ 精确/ 的/ 不同/ 深度/ 循环/ 的/ 迭代/ 运行/ 时间/ ./ 最后/ 根据/ 式/ (/ 2/ )/ 就/ 可以/ 得出/ 多层/ 循环/ 中/ 每/ 一层/ 循环/ 每次/ 迭代/ 之间/ 的/ 启动/ 间距/ 信息/ ,/ 从而/ 得出/ 循环/ 程序/ 的/ NF/ _/ II/ 模型/ ./ delay/ (/ stmt/ (/ 犐/ r/ )/ )/ =/ T/ (/ Loop/ (/ r/ )/ )/ =/ )/ // θ/ m/ )/ // θ/ mk/ =/ 0/ (/ qm/ -/ pm/ ∑/ (/ qm/ -/ pm/ ∑/ k/ =/ 0/ 烄/ 烅/ 烆/ 根据/ 如/ 上/ 所示/ 多层/ 循环/ 中/ 迭代/ 间/ 启动/ 间距/ 计算方法/ ,/ 本文/ 在/ 细粒度/ 可/ 重构/ 编译器/ ASCRA/ 中/ 设计/ 实现/ 了/ 多层/ 循环/ 中/ 循环体/ 流水/ 执行/ 时/ 迭代/ 间/ 启动/ 间距/ 自动/ 分析/ 算法/ ./ 多层/ 循环/ 深度/ 流水/ 执行/ 时/ 迭代/ 间/ 启动/ 间距/ 自动/ 分析/ 算法/ 的/ 伪/ 代码/ 描述/ 如/ 算法/ 1/ 所示/ ./ 首先/ ,/ 对/ 最/ 内层/ 循环/ Loop/ (/ m/ )/ 的/ 启动/ 间距/ 向量/ 犐/ 犐/ m/ 进行/ 分析/ ./ 采用/ 基于/ 硬件/ 延时/ 的/ 流水线/ 划分算法/ [/ 12/ ]/ 对/ 循环体/ stmt/ (/ 犐/ m/ )/ 进行/ 流水线/ 划分/ ;/ 按照/ 式/ (/ 5/ )/ 对/ 最/ 内层/ 循环/ Loop/ (/ m/ )/ 的/ 迭代/ 间/ 启动/ 间距/ 向量/ 犐/ 犐/ m/ 进行/ 初始化/ ,/ 将/ 最/ 内层/ 循环/ 中/ 迭代/ 间/ 启动/ 间距/ 设置/ 为/ 1/ ;/ 然后/ 对/ stmt/ (/ 犐/ m/ )/ 的/ RAW/ _/ DDA/ 模型/ 中/ 数据/ 依赖/ 关系/ 集合/ [/ NEXT/ ]/ 进行/ 筛选/ ,/ 当/ Δ/ ×/ θ/ m/ / δ/ 时/ ,/ 则/ 该/ 依赖/ 关系/ next/ 会/ 对/ 循环体/ 下/ 一次/ 迭代/ 执行/ 产生/ 推后/ 影响/ ,/ 如果/ Δ/ ×/ θ/ m/ </ δ/ ,/ 则/ 说明/ 该/ RAW/ 数据/ 依赖/ 关系/ 不会/ 影响/ 迭代/ 间/ 启动/ 间距/ ,/ 因此/ 将/ 其/ 从/ 数据/ 依赖/ 关系/ 集合/ [/ NEXT/ ]/ 中/ 进行/ 删除/ ,/ 对/ 符合/ 该/ 条件/ 的/ next/ 依赖/ 关系/ 进行/ 遍历/ ,/ 根据/ 式/ (/ 2/ )/ 进行/ 启动/ 间距/ 向量/ 犐/ 犐/ m/ 的/ 更新/ ./ 对于/ RAW/ _/ DDA/ 模型/ 中/ RAW/ 数据/ 依赖/ 关系/ 集合/ [/ NEXT/ ]/ 中/ 每/ 一个/ 依赖/ 关系/ (/ next/ ,/ δ/ ,/ Δ/ )/ ,/ 遍历/ Loop/ (/ m/ )/ 中/ 所有/ 迭代/ 体/ stmt/ (/ Im/ )/ ,/ 根据/ 式/ (/ 3/ )/ 可以/ 得知/ delay/ =/ δ/ ,/ 因此/ ,/ 如果/ k/ %/ δ/ =/ 0/ 并且/ Δ/ ×/ θ/ r/ / δ/ ,/ 说明/ 该/ RAW/ 依赖/ 关系/ next/ 会/ 影响/ 迭代/ 间/ 启动/ 间距/ ,/ 如果/ 该/ 依赖/ 关系/ next/ 在/ 索引/ 变量/ Ir/ 到/ 索引/ 变量/ Is/ 的/ 迭代/ 之间/ ,/ 则/ 首先/ 假设/ 当/ Ir/ </ Is/ -/ θ/ m/ 时/ ,/ 迭代/ stmt/ (/ Ir/ )/ 的/ 启动/ 间距/ 均/ 为/ 1/ ,/ 根据/ 式/ (/ 2/ )/ 可以/ 将/ 迭代/ stmt/ (/ Is/ )/ 的/ 启动/ 推后/ 执行/ ,/ 启动/ 间距/ 为/ IIt/ =/ Δ/ ×/ θ/ m/ -/ δ/ +/ 2/ ,/ 这时/ 可能/ 之前/ 的/ 迭代/ 启动/ 会/ 被/ 其他/ 的/ RAW/ 依赖/ 关系/ 推后/ 执行/ ,/ 因此/ ,/ 将/ 之前/ 的/ 所有/ 迭代/ 启动/ 时间/ 进行/ 求和/ ,/ 将/ 根据/ 式/ (/ 2/ )/ 计算/ 得出/ 的/ 启动/ 间距/ 减去/ 由/ 其他/ RAW/ 依赖/ 关系/ 引起/ 的/ 迭代/ 推后/ 执行/ 时间/ ,/ 得到/ 迭代/ stmt/ (/ Is/ )/ 最终/ 的/ 启动/ 间距/ 延时/ 时间/ IIIr/ =/ IIt/ +/ δ/ -/ sum/ ./ 最后/ ,/ 将/ 得出/ 的/ 迭代/ 体/ stmt/ (/ Ir/ )/ 的/ 启动/ 间距/ 信息/ 加入/ 启动/ 间距/ 向量/ 犐/ 犐/ m/ 中/ ./ 在/ 得到/ 最/ 内层/ 循环/ Loop/ (/ m/ )/ 的/ 启动/ 间距/ 向量/ 犐/ 犐/ m/ 之后/ ,/ 可以/ 根据/ 式/ (/ 4/ )/ 得出/ 最/ 内层/ 循环/ 的/ 运行/ 时间/ T/ (/ Loop/ (/ m/ )/ )/ ,/ 从而/ 可以/ 对/ r/ </ m/ 的/ 外层/ 循环/ Loop/ (/ r/ )/ 进行/ 启动/ 间距/ 分析/ ./ 首先/ ,/ 初始化/ 启动/ 间距/ 向量/ 犐/ 犐/ r/ 中/ 每个/ 迭代/ stmt/ (/ Ir/ )/ 的/ 启动/ 时间/ 间距/ 为/ 1/ ./ 其次/ ,/ 根据/ 算法/ 1/ 的/ 步骤/ (/ 1/ )/ 中/ 的/ 方法/ 对/ 影响/ stmt/ (/ 犐/ r/ )/ 中/ 迭代/ 间/ 启动/ 间距/ 的/ 数据/ 依赖/ 关系/ 集合/ [/ NEXT/ ]/ 进行/ 筛选/ ,/ 将/ 满足条件/ Δ/ ×/ θ/ m/ </ delay/ 的/ 依赖/ 关系/ 删除/ ./ 最后/ ,/ 根据/ Loop/ (/ m/ )/ 的/ 启动/ 间距/ 向量/ 犐/ 犐/ m/ 和/ T/ (/ Loop/ (/ m/ )/ )/ ,/ 结合/ 式/ (/ 2/ )/ ~/ (/ 4/ )/ 对/ 深度/ r/ =/ m/ -/ 1/ 的/ 循环/ Loop/ (/ r/ )/ 进行/ 启动/ 间距/ 向量/ 犐/ 犐/ r/ 的/ 分析/ ./ 最后/ ,/ 按照/ 上述/ 算法/ ,/ 依据/ 索引/ 变量/ 对/ 循环/ 进行/ 遍历/ ,/ 迭代/ 求出/ 每/ 一层/ 循环/ 的/ 迭代/ 间/ 启动/ 间距/ 向量/ 犐/ 犐/ r/ ,/ 构建/ 整个/ 循环/ 的/ 迭代/ 间/ 启动/ 间距/ 信息/ 模型/ NF/ _/ II/ ./ 算法/ 1/ ./ 多层/ 循环/ NF/ _/ II/ 模型/ 自动/ 分析/ 算法/ ./ 输入/ :/ RAW/ _/ DDA/ 模型/ 输出/ :/ 犖/ 犉/ _/ 犐/ 犐/ (/ 1/ )/ 计算/ 最/ 内层/ 循环/ 的/ 启动/ 间距/ 向量/ 犐/ 犐/ m/ ,/ 依据/ 式/ (/ 5/ )/ 初始化/ 犐/ 犐/ m/ ;/ // // 筛选/ RAW/ 依赖/ 关系/ next/ ;/ FOReachArrayINRAW/ _/ DDA/ ./ [/ Array/ ]/ DOFOReach/ (/ next/ ,/ δ/ ,/ Δ/ )/ INArray/ ./ [/ NEXT/ ]/ DOIFArray/ ./ [/ NEXT/ ]/ =/ / THENENDFOR/ // // 遍历/ RAW/ _/ DDA/ ./ [/ NEXT/ ]/ ,/ 更新/ 犐/ 犐/ m/ ;/ FOReach/ (/ next/ ,/ δ/ ,/ Δ/ )/ INRAW/ _/ DDA/ ./ [/ NEXT/ ]/ DOFORIr/ ←/ pmtoqmDOPage9ENDFORENDFOR/ (/ 2/ )/ 根据/ 最/ 内层/ 循环/ 启动/ 间距/ 向量/ 犐/ 犐/ m/ 和/ 式/ (/ 2/ )/ ~/ (/ 5/ )/ 递归计算/ 深度/ 小于/ m/ 的/ 循环/ Loop/ (/ r/ )/ 的/ 启动/ 间距/ 向量/ 犐/ 犐/ r/ ,/ 构建/ NF/ _/ II/ 模型/ ;/ FORr/ ←/ m/ -/ 1to1DO/ 初始化/ 犐/ 犐/ r/ ,/ 根据/ 式/ (/ 3/ )/ 和/ (/ 4/ )/ 计算/ [/ NEXT/ ]/ 中/ next/ 在/ 循环体/ stmt/ (/ 犐/ r/ )/ 中/ 相邻/ 两次/ 迭代/ 之间/ 的/ 延时/ delay/ ,/ 删除/ [/ NEXT/ ]/ 中/ 满足/ Δ/ ×/ θ/ m/ </ delay/ 条件/ 的/ next/ ;/ FOReach/ (/ next/ ,/ δ/ ,/ Δ/ )/ IN/ [/ NEXT/ ]/ DO/ 根据/ 上文/ 建立/ 的/ 多层/ 循环/ 迭代/ 间/ 启动/ 间距/ 信息/ 模型/ ,/ 可以/ 准确/ 地/ 评估/ 出/ 多层/ 循环/ 流水/ 执行/ 时/ 的/ 运行/ 时钟/ 周期/ ,/ 为/ 细粒度/ 可/ 重构/ 编译器/ 中/ 软硬件/ 划分/ 提供/ 更加/ 完善/ 的/ 划分/ 依据/ 信息/ ,/ 同时/ 采用/ 该/ NF/ _/ II/ 自动/ 分析/ 算法/ 获得/ 的/ 多层/ 循环/ 深度/ 流水/ 执行/ 时/ 迭代/ 间/ 非/ 固定/ 启动/ 间距/ 信息/ 能够/ 支持/ 循环/ 流水/ 控制/ 单元/ 的/ 生成/ ./ 4/ 循环/ 流水/ 迭代/ 间/ 启动/ 间距/ 优化/ 在/ 进行/ 多层/ 循环/ 流水/ 迭代/ 间/ 启动/ 间距/ 自动/ 分析方法/ 研究/ 的/ 同时/ ,/ 还/ 在/ 研究/ 如何/ 实现/ 在/ 非/ 固定/ 启动/ 间距/ 的/ 基础/ 上/ 进一步/ 对/ 启动/ 间距/ 模型/ 进行/ 优化/ ,/ 因为/ 最/ 内层/ 循环/ 的/ 执行/ 时间/ 对/ 整个/ 循环/ 性能/ 影响/ 最大/ ,/ 因此/ 本文/ 从/ 降低/ 最/ 内层/ 循环/ 循环体/ 迭代/ 间/ 启动/ 间距/ 向/ 量值/ 方法/ 入手/ ,/ 提出/ 了/ 一种/ 采用/ 流水线/ 调度/ 技术/ 进行/ 启动/ 间距/ 优化/ 的/ 方法/ ./ 在/ 循环/ Loop/ (/ m/ )/ 中/ ,/ 对/ 循环体/ stmt/ (/ 犐/ m/ )/ 采用/ 基于/ 硬件/ 延时/ 的/ 流水线/ 划分/ 技术/ 进行/ 流水线/ 划分/ ,/ 当/ 存在/ 导致/ 下/ 一次/ 迭代/ 推后/ 执行/ 的/ 迭代/ 间/ RAW/ 依赖/ 关系/ next/ 时/ ,/ 启动/ 间距/ 大于/ 1/ ,/ 则/ 可以/ 通过/ 算法/ 2/ 中/ 描述/ 的/ 方法/ 进行/ 最/ 内层/ 循环/ 迭代/ 间/ 启动/ 间距/ 优化/ ,/ 主要/ 思想/ 是/ 将/ 依赖/ 关系/ next/ 中/ 的/ Load/ 指令/ 操作/ 按照/ ALAP/ 调度/ 算法/ 进行/ 流水/ 段/ 延后/ ,/ 对/ Store/ 指令/ 按照/ ASAP/ 调度/ 算法/ 进行/ 流水/ 段数/ 提前/ ,/ 提高/ RAW/ 依赖/ 关系/ 中访存/ 指令/ 之间/ 的/ 时间/ 间隔/ ./ 经过/ 实验/ 表明/ ,/ 该/ 方法/ 对于/ 一些/ 循环/ 程序/ 应用/ 能够/ 有效/ 减少/ 最/ 内层/ 循环/ 中/ 循环体/ 流水/ 执行/ 时/ 迭代/ 间/ 启动/ 间距/ ,/ 从而/ 达到/ 提高/ 循环/ 应用/ 流水/ 执行/ 的/ 性能/ ./ 算法/ 2/ ./ 多层/ 循环/ 启动/ 间距/ 优化/ 算法/ ./ 输入/ :/ stmt/ (/ 犐/ m/ )/ 数据流/ 图/ dfg/ 和/ RAW/ _/ DDA/ 模型/ 输出/ :/ 优化/ 后/ 的/ stmt/ 和/ RAW/ _/ DDA/ 模型/ (/ 1/ )/ 遍历/ RAW/ _/ DDA/ 中/ 的/ [/ NEXT/ ]/ ,/ 在/ dfg/ 中/ 找到/ RAW/ 数据/ 依赖/ 关系/ NEXT/ 对应/ 的/ 回边/ eij/ (/ vi/ →/ vj/ )/ ;/ QE/ ←/ / ;/ // // QE/ 表示/ 回边/ 队列/ FOReachback/ -/ edgeeijINdfgDOIFvi/ ./ h/ >/ vj/ ./ hTHEN/ // // vi/ ./ h/ 表示/ 节点/ vi/ 的/ 流水/ 段数/ ENDFOR/ (/ 2/ )/ 对/ QE/ 中/ 回边/ eij/ 进行/ 遍历/ ,/ 对/ 指令/ 节点/ vi/ 进行/ ASAP/ 调度/ ;/ WHILEQE/ ≠/ / DOeij/ ←/ DEQUEUE/ (/ QE/ )/ ;/ min/ _/ h/ _/ i/ =/ 0/ ;/ IFmin/ _/ h/ _/ i/ >/ 1THENENDWHILE/ (/ 3/ )/ 对/ QE/ 中/ 回边/ eij/ 进行/ 遍历/ ,/ 对/ 指令/ 节点/ vj/ 进行/ ALAP/ 调度/ ;/ WHILEQE/ ≠/ / DOPage10eij/ ←/ DEQUEUE/ (/ QE/ )/ ;/ min/ _/ h/ _/ i/ =/ 0/ ;/ FOReachedgedfg/ ./ ejm/ (/ vj/ →/ vm/ )/ DOENDFORIFmin/ _/ h/ _/ i/ >/ 1THENENDIFENDWHILE/ (/ 4/ )/ 针对/ 优化/ 后/ 的/ stmt/ ,/ 更新/ RAW/ _/ DDA/ 模型/ 中/ 依赖/ 关系/ NEXT/ 中/ 的/ Δ/ 信息/ ./ WHILEQE/ ≠/ / DOeij/ ←/ DEQUEUE/ (/ QE/ )/ ;/ NEXT/ ←/ RAW/ _/ DDA/ ./ [/ NEXT/ ]/ ;/ NEXT/ ./ Δ/ =/ vi/ ./ h/ -/ vj/ ./ h/ ;/ ENDWHILE/ 如图/ 11/ 所示/ ,/ 图/ (/ a/ )/ 和/ (/ b/ )/ 中/ 的/ RAW/ 数据/ 依赖/ 关系/ 均/ 为/ NEXTA/ =/ {/ A/ [/ i/ +/ 2/ ]/ →/ A/ [/ i/ +/ 4/ ]/ ,/ δ/ =/ 2/ }/ ,/ 而/ 迭代/ 间/ 流水/ 段/ 延时/ Δ/ a/ =/ 4/ ,/ Δ/ b/ =/ 3/ ,/ 所/ 得到/ 的/ 迭代/ 间/ 流水/ 启动/ 间距/ 向量/ 犐/ 犐/ 犪/ =/ (/ 1/ ,/ 1/ ,/ 4/ ,/ 1/ ,/ 4/ ,/ 1/ ,/ 4/ ,/ …/ )/ ,/ 犐/ 犐/ 犫/ =/ (/ 1/ ,/ 1/ ,/ 3/ ,/ 1/ ,/ 3/ ,/ 1/ ,/ 3/ ,/ …/ )/ ./ 通过/ 降低/ 数组/ A/ 产生/ 的/ RAW/ 数据/ 依赖/ 关系/ 在/ 循环体/ 中/ 所/ 跨过/ 的/ 流水/ 延时/ ,/ 降低/ 了/ 迭代/ 间/ 流水/ 启动/ 间距/ ,/ 有效/ 地/ 提高/ 了/ 循环/ 程序/ 的/ 数据/ 吞吐/ 率/ ./ 5/ 实验/ 结果/ 与/ 分析/ 本文/ 针对/ 现有/ 细粒度/ 可/ 重构/ 编译器/ 循环/ 流水/ 映射/ 对于/ 迭代/ 间/ 启动/ 间距/ 的/ 制导/ 语句/ 控制/ 方式/ 进行/ 分析/ ,/ 建立/ 了/ 循环/ 流水/ 启动/ 间距/ 信息/ 模型/ ,/ 提出/ 非/ 固定/ 启动/ 间距/ 控制策略/ ,/ 并/ 设计/ 实现/ 自动/ 分析/ 算法/ ,/ 基于/ 流水线/ 调度/ 技术/ 进行/ 了/ 启动/ 间距/ 优化/ ,/ 最后/ 在/ 可/ 重构/ 编译器/ ASCRA/ 中/ ,/ 基于/ Xilinx/ 的/ Zynq/ -/ 7000APSoCZC706/ 开发板/ 进行/ 了/ 功能/ 实现/ 与/ 性能/ 验证/ ./ 在/ ASCRA/ 中/ 实现/ 本文/ 所/ 提出/ 的/ 非/ 固定/ 启动/ 间距/ 控制/ 方式/ 到/ FPGA/ 硬件/ 电路/ 的/ 自动/ 映射/ 时/ ,/ 与/ 现有/ 可/ 重构/ 编译器/ 类似/ ,/ 针对/ 每/ 一个/ 循环/ 程序模块/ ,/ 设计/ 实现/ 一个/ 循环/ 流水/ 调度/ 控制/ 单元/ ,/ 并不需要/ 额外/ 的/ 循环/ 调度/ 控制/ 单元/ ,/ 与/ 生成/ 迭代/ 间/ 固定/ 启动/ 间距/ 的/ 现有/ 可/ 重构/ 编译器/ 不同/ 的/ 是/ ,/ 根据/ 非/ 固定/ 启动/ 间距/ 信息/ 模型/ 生成/ 的/ 循环/ 调度/ 控制/ 单元/ 包含/ 一个/ 额外/ 的/ 存储器/ RAM/ 和/ 一个/ 计数器/ ,/ RAM/ 用来/ 存储/ 本文/ 方法/ 自动/ 分析/ 得到/ 的/ 循环/ 流水/ 迭代/ 间/ 非/ 固定/ 启动/ 间距/ 信息/ ,/ 根据/ RAM/ 中/ 存储/ 的/ 启动/ 间距/ 值/ 使用/ 计数器/ 推后/ 每次/ 迭代/ 的/ 启动/ 使能/ 信号/ ,/ 从而/ 实现/ 循环/ 程序/ 迭代/ 间/ 非/ 固定/ 启动/ 间距/ 的/ 流水/ 执行/ ./ 虽然/ 需要/ 额外/ 的/ RAM/ 硬件资源/ 和/ 计数器/ 所/ 消耗/ 的/ 硬件资源/ ,/ 但是/ 与/ 该/ 方法/ 所/ 提升/ 的/ 性能/ 相比/ ,/ 消耗/ 这个/ 规模/ 的/ FPGA/ 资源/ 还是/ 可以/ 接受/ 的/ ./ 对于/ 循环/ 程序/ 来说/ ,/ 影响/ 程序/ 性能/ 的/ 关键/ 是/ 循环体/ 中/ 的/ 数学/ 运算/ 和/ 逻辑运算/ 指令/ ,/ 一般/ 影响/ 循环/ 流水/ 执行/ 的/ 关键/ 路径/ 都/ 是/ 数学/ 运算/ 中/ 类似/ 乘法/ 运算/ 这样/ 耗时/ 的/ 指令/ ,/ 循环/ 调度/ 控制/ 单元/ 虽然/ 会/ 增加/ RAM/ 存储器/ 的/ 读写操作/ ,/ 但是/ 该/ 操作/ 是/ 可以/ 采用/ 数据/ 预取/ 的/ 方式/ 避免/ 对/ 性能/ 的/ 影响/ ./ 与/ 本文/ 所/ 提出/ 的/ 非/ 固定/ 启动/ 间距/ 控制/ 方式/ 对/ 循环/ 流水/ 执行/ 时/ 的/ 性能/ 提升/ 相比/ ,/ 改善/ 循环/ 调度/ 控制/ 单元/ 所/ 引起/ 的/ 性能/ 降低/ 可以/ 忽略/ 不/ 考虑/ ./ 本文/ 在/ 进行/ 循环/ 流水/ 启动/ 间距/ 分析/ 优化/ 的/ 时候/ ,/ 采用/ 局部优化/ 的/ 思想/ 对/ 循环/ 流水/ 启动/ 间距/ 进行/ 优化/ 与/ 改进/ ,/ 本/ 小节/ 主要/ 采用/ 理论/ 证明/ 和/ 性能/ 测试/ 两种/ 方式/ 进行/ 循环/ 流水/ 启动/ 间距/ 自动/ 分析/ 及/ 优化/ 方法/ 的/ 性能/ 验证/ ./ 现有/ 细粒度/ 可/ 重构/ 编译器/ 采用/ 制导/ 语句/ 方式/ 生成/ 迭代/ 间/ 固定/ 启动/ 间距/ ,/ 对于/ 多层/ 循环/ 中/ 不同/ 深度/ 的/ 循环/ Loop/ (/ r/ )/ 所/ 对应/ 的/ 启动/ 间距/ 模型/ 可以/ 表示/ 成/ 1/ 个/ 一维/ 向量/ ,/ 如式/ (/ 6/ )/ 所示/ ,/ 其中/ 1/ / r/ / m/ ./ 假设/ 所有/ 循环体/ stmt/ (/ 犐/ r/ )/ 的/ 启动/ 时间/ 单位/ 都/ 是/ t/ ,/ 则/ 在/ 采用/ 制导/ 语句/ 生成/ 固定/ 启动/ 间距/ 方式/ 的/ 流水/ 硬件/ 结构/ 中/ ,/ 循环体/ 相邻/ 迭代/ 之间/ 等待时间/ II/ _/ Time/ 如式/ (/ 7/ )/ 所示/ ./ 而/ 采用/ 非/ 固定/ 启动/ 间距/ 控制/ 方式/ 生成/ 的/ 流水/ 硬件/ 结构/ 中/ ,/ 相邻/ 迭代/ 之间/ 的/ 等待时间/ Page11NF/ _/ II/ _/ Time/ 如式/ (/ 8/ )/ 所示/ ./ 在/ 细粒度/ 可/ 重构/ 编译器/ 中/ ,/ 制导/ 语句/ 控制/ 生成/ 的/ 固定/ 启动/ 间距/ 模型/ II/ 中/ ,/ 手动/ 设计/ 的/ 固定/ 启动/ 间距/ IIr/ 最佳值/ 为/ 非/ 固定/ 启动/ 间距/ 向量/ 犐/ 犐/ r/ 中/ 的/ 最大值/ ,/ 如式/ (/ 9/ )/ 所示/ ,/ 其中/ k/ 是/ 正整数/ ./ IIr/ =/ max/ (/ IIpr/ 根据/ 式/ (/ 7/ )/ ~/ (/ 9/ )/ ,/ 可/ 证明/ 得出/ 采用/ 非/ 固定/ 启动/ 间距/ 方式/ 能够/ 减少/ 多层/ 循环/ 流水/ 执行/ 时/ 循环体/ 每次/ 迭代/ 启动/ 等待时间/ ,/ 如式/ (/ 10/ )/ 所示/ ./ 为了/ 验证/ 式/ (/ 10/ )/ 的/ 正确性/ ,/ 本文/ 在/ 细粒度/ 可/ 重构/ 编译器/ ASCRA/ 中/ 进行/ 循环/ 流水/ 启动/ 间距/ 自动/ 分析/ 和/ 优化/ 方法/ 的/ 设计/ 与/ 实现/ ,/ 对/ 多层/ 循环/ 分析/ 得到/ 的/ 启动/ 间距/ 信息/ 不仅/ 可/ 用于/ 支持/ 软硬件/ 划分/ 中/ 硬件/ 性能/ 评估/ ,/ 同时/ 可/ 支持/ 自动/ 映射/ 生成/ 循环/ 流水/ 硬件/ 结构/ 的/ 控制/ 调度/ 单元/ ./ 该/ 方法/ 在/ 提高/ 可/ 重构/ 计算/ 应用/ 部署/ 效率/ 的/ 基础/ 上/ ,/ 还/ 可以/ 有效/ 地/ 提高/ 部分/ 循环/ 的/ 流水/ 性能/ ./ 下文/ 从/ 测试/ 集/ PolyBench/ -/ 3.2/ 中/ 选取/ 了/ 不同/ 循环/ 特征/ 的/ 测试程序/ 进行/ 实验/ 和/ 分析/ ,/ 对比/ 本文/ 提出/ 的/ 循环/ 流水/ 启动/ 间距/ 自动/ 分析/ 及/ 优化/ 方法/ 与/ 现有/ HLS/ 工具/ 采用/ 的/ 制导/ 语句/ 控制/ 方式/ ,/ 测试/ 循环/ 程序/ 在/ FPGA/ 硬件/ 中/ 流水/ 执行/ 时/ 消耗/ 的/ 时钟/ 节拍/ 数/ ,/ 并/ 分析/ 随着/ 循环/ 程序/ 迭代/ 空间/ 的/ 变大/ ,/ 本文/ 方法/ 对/ 循环/ 程序/ 性能/ 加速/ 效果/ 的/ 变化/ ./ 当/ 循环/ 中/ 所有/ 索引/ 变量/ 迭代/ 次数/ 均/ 为/ 常量/ 值时/ ,/ 采用/ 本文/ 方法/ 能够/ 有效/ 提高/ 循环/ 的/ 性能/ ./ 下面/ 采用/ jacobi/ -/ 1D/ 、/ jacobi/ -/ 2D/ 、/ Seidel/ -/ 2D/ 这/ 3/ 个/ 经典/ 循环/ 程序/ 进行/ 测试/ ./ 其中/ ,/ jacobi/ -/ 1D/ 是/ 一个/ 单层/ 循环/ ,/ 索引/ 变量/ Ii/ =/ (/ 0/ ,/ N/ ,/ 1/ )/ ,/ jacobi/ -/ 2D/ 和/ Seidel/ -/ 2D/ 是/ 一个/ 两层/ 循环/ ,/ 循环/ 索引/ 变量/ 向量/ 均/ 为/ 犐/ r/ =/ {/ (/ Ii/ ,/ Ij/ )/ |/ Ii/ =/ (/ 0/ ,/ N/ ,/ 1/ )/ ,/ Ij/ =/ (/ 0/ ,/ N/ ,/ 1/ )/ }/ ,/ 这/ 3/ 个/ 测试程序/ 的/ 共同/ 特征/ 是/ 不同/ 深度/ 循环/ 的/ 索引/ 变量/ 迭代/ 次数/ 均/ 是/ 常量/ ./ 与/ 采用/ 制导/ 语句/ 控制/ 方式/ 的/ 现有/ HLS/ 工具/ 相比/ ,/ 本文/ 方法/ 能够/ 有效/ 减少/ 循环/ 流水/ 执行/ 时/ 的/ 时钟/ 节拍/ 数/ ./ 实验/ 结果/ 如表/ 1/ 所示/ ,/ N/ 表示/ 循环/ 索引/ 变量/ 迭代/ 次数/ ,/ 表/ 1/ 中/ 的/ 测试程序/ 不同/ 深度/ 循环/ 的/ 索引/ 变量/ 迭代/ 次数/ 均/ 为/ N/ ,/ clockcycles/ 表示/ 循环/ 流水/ 执行/ 时/ 消耗/ 的/ 时钟/ 节拍/ 数/ ./ 根据/ 表/ 1/ 中/ 实验/ 结果/ 可以/ 得知/ ,/ 随着/ 迭代/ 空间/ 的/ 增大/ ,/ 采用/ 本文/ 提出/ 的/ 循环/ 流水/ 启动/ 间距/ 自动/ 分析/ 及/ 优化/ 方法/ ,/ 能够/ 有效/ 提高/ 具有/ 常量/ 迭代/ 次数/ 索引/ 变量/ 的/ 循环/ 程序/ 的/ 性能/ ,/ 并且/ 能够/ 保持稳定/ 的/ 性能/ 加速/ 比/ ./ 与/ 采用/ 制导/ 语句/ 方式/ 的/ 现有/ HLS/ 工具/ 相比/ ,/ 采用/ 循环/ 流水/ 启动/ 间距/ 自动/ 分析/ 及/ 优化/ 方法/ 的/ 可/ 重构/ 编译器/ ASCRA/ 分别/ 获得/ 了/ 20/ %/ 、/ 33.3/ %/ 、/ 42.86/ %/ 的/ 稳定/ 加速/ 比/ ./ 测试/ 集/ jacobi/ -/ 1Djacobi/ -/ 2DSeidel/ -/ 2D/ 当/ 循环/ 中/ 的/ 索引/ 变量/ 迭代/ 次数/ 是/ 变量/ 时/ ,/ 会/ 产生/ 不规则/ 形状/ 的/ 迭代/ 域/ 空间/ ,/ 例如/ 三角/ 矩阵/ 乘法/ TRMM/ 的/ 迭代/ 域/ 及/ 迭代/ 空间/ 依赖/ 关系/ ,/ 如图/ 12/ 所示/ ,/ 其/ 特点/ 是/ 迭代/ 域/ 空间/ 属于/ 不规则/ 形状/ ./ 针对/ 具备/ 不规则/ 迭代/ 域/ 空间/ 特征/ 的/ 循环/ 程序/ ,/ 本文/ 选用/ PolyBench/ 测试/ 集中/ Triangular/ 、/ TRMM/ 、/ Trisolv/ 循环/ 程序/ 分别/ 进行/ 测试/ ./ 其中/ ,/ Triangular/ 是/ 一个/ 两层/ 循环/ ,/ 循环/ 索引/ 变量/ 向量/ 犐/ r/ =/ {/ (/ Ii/ ,/ Ij/ )/ |/ Ii/ =/ (/ 0/ ,/ N/ ,/ 1/ )/ ,/ Ij/ =/ (/ 0/ ,/ N/ -/ i/ ,/ 1/ )/ }/ ;/ TRMM/ 是/ 一个三层/ 循环/ ,/ 循环/ 索引/ 变量/ 向量/ 犐/ r/ =/ {/ (/ Ii/ ,/ Ij/ ,/ Ik/ )/ |/ Ii/ =/ (/ 0/ ,/ N/ ,/ 1/ )/ ,/ Ij/ =/ (/ 0/ ,/ N/ ,/ 1/ )/ ,/ Ik/ =/ (/ 0/ ,/ i/ ,/ 1/ )/ }/ ;/ Trisolv/ 是/ 一个/ 两层/ 循环/ ,/ 循环/ 索引/ 变量/ 向量/ 犐/ r/ =/ {/ (/ Ii/ ,/ Ij/ )/ |/ Ii/ =/ (/ 0/ ,/ N/ ,/ 1/ )/ ,/ Ij/ =/ (/ 0/ ,/ i/ -/ 1/ ,/ 1/ )/ }/ ./ 这/ 3/ 个/ 循环/ 程序/ 中均/ 存在/ 索引/ 变量/ 迭代/ 次数/ 与/ 索引/ 变量/ 相关/ 的/ 特征/ ,/ Page12/ 采用/ 本文/ 提出/ 的/ 循环/ 流水/ 启动/ 间距/ 自动/ 分析/ 及/ 优化/ 方法/ ,/ 得到/ 这/ 3/ 个/ 循环/ 程序/ 随着/ 迭代/ 阈值/ N/ 的/ 变化/ ,/ 流水/ 执行/ 时/ 消耗/ 的/ 时钟/ 周期/ 数/ 结果/ ,/ 如图/ 13/ 、/ 图/ 14/ 、/ 图/ 15/ 所示/ ./ 其中/ ,/ 横坐标/ 表示/ 循环/ 索引/ 变量/ 的/ 边界值/ N/ ,/ 随着/ N/ 的/ 增长/ ,/ 循环/ 的/ 迭代/ 次数/ 在/ 增加/ ,/ 纵坐标/ “/ 运行/ 时间/ ”/ 表示/ 循环/ 程序/ 在/ FPGA/ 上/ 流水/ 执行/ 时/ 消耗/ 的/ 时钟/ 节拍/ 数/ ,/ 次/ 纵坐标/ “/ 优化/ 时间/ ”/ 表示/ 现有/ HLS/ 工具/ 与/ 采用/ 本文/ 所提/ 方法/ 实现/ 的/ ASCRA/ 在/ 循环/ 程序/ 流水/ 执行/ 时/ 消耗/ 的/ 时钟/ 节拍/ 数之差/ HLS/ -/ ASCRA/ ./ 根据/ 图/ 13/ 、/ 图/ 14/ 、/ 图/ 15/ 结果/ 可知/ ,/ 与/ 采用/ 制导/ 语句/ 控制/ 方式/ 的/ 现有/ HLS/ 工具/ 相比/ ,/ 本文/ 方法/ 能够/ 有效/ 地/ 减少/ 循环/ 程序/ 流水/ 执行/ 时所/ 消耗/ 的/ 时钟/ 节拍/ 数/ ,/ 提高/ 程序/ 的/ 性能/ ,/ 并且/ 本文/ 方法/ 使/ 循环/ 程序/ 优化/ 的/ 时钟/ 节拍/ 数/ 随着/ N/ 增大/ 而/ 增长/ ./ 对于/ 上述/ 3/ 个/ 循环/ 程序/ ,/ 当/ 迭代/ 阈值/ N/ 增大/ 时/ ,/ 外层/ 循环/ 迭代/ 间/ RAW/ 数据/ 依赖/ 关系/ 距离/ 会/ 小于/ 内层/ 循环/ 一次/ 迭代/ 执行/ 所/ 消耗/ 的/ 时间/ ,/ 从而/ 导致/ 外层/ 循环/ 迭代/ 间/ 启动/ 间距/ 不受/ 其/ RAW/ 数据/ 依赖/ 关系/ 影响/ ,/ 不/ 需要/ 对/ 外层/ 循环/ 迭代/ 间/ 启动/ 间距/ 进行/ 优化/ ./ 因此/ ,/ 本文/ 只/ 对/ 其/ 内层/ 循环/ 启动/ 间距/ 进行/ 优化/ ,/ 即/ 分别/ 对/ 索引/ 变量/ 为/ Ij/ =/ (/ 0/ ,/ N/ -/ i/ ,/ 1/ )/ 、/ Ik/ =/ (/ 0/ ,/ i/ ,/ 1/ )/ 、/ Ij/ =/ (/ 0/ ,/ i/ -/ 1/ ,/ 1/ )/ 的/ 循环/ 进行/ 启动/ 间距/ 优化/ ,/ 减少/ 了/ 内层/ 循环/ 流水/ 执行/ 所/ 消耗/ 的/ 时钟/ 节拍/ 数/ ,/ 进而/ 减少/ 整个/ 循环/ 程序/ 流水/ 执行/ 所/ 消耗/ 的/ 时钟/ 节拍/ 数/ ,/ 提高/ 整个/ 循环/ 程序/ 的/ 性能/ ./ 综上所述/ ,/ 与/ 现有/ HLS/ 工具/ 采用/ 制导/ 语句/ 进行/ 循环/ 流水/ 启动/ 间距/ 控制/ 相比/ ,/ 本文/ 所/ 提出/ 的/ 循环/ 流水/ 启动/ 间距/ 自动/ 分析/ 和/ 优化/ 方法/ 能够/ 自动/ 获得/ 迭代/ 间/ 启动/ 间距/ ,/ 能够/ 有效/ 提高/ 可/ 重构/ 计算/ 应用/ 在/ 异构/ 加速/ 平台/ 上/ 的/ 部署/ 效率/ ;/ 同时/ ,/ 本文/ 提出/ 了/ 非/ 固定/ 启动/ 间距/ 控制策略/ 与/ 基于/ 流水线/ 调度/ 技术/ 的/ 启动/ 间距/ 优化/ 方法/ ,/ 针对/ 特定/ 循环/ 能够/ 有效/ 提高/ 循环/ 在/ FPGA/ 协处理器/ 中/ 流水/ 执行/ 时/ 的/ 性能/ ,/ 并/ 对/ 具有/ 常量/ 索引/ 变量/ 迭代/ 次数/ 特征/ 的/ 循环/ 具有/ 良好/ 的/ 加速/ 比/ ./ 6/ 结束语/ 本文/ 在/ 面向/ CPU/ -/ FPGA/ 异构/ 加速/ 平台/ 的/ 细粒度/ 可/ 重构/ 编译器/ ASCRA/ 中/ 提出/ 了/ 一种/ 循环/ 流水/ 启动/ 间距/ 自动/ 分析/ 及/ 优化/ 方法/ ,/ 针对/ 现有/ HLS/ 工具/ 中/ 制导/ 语句/ 生成/ 固定/ 启动/ 间距/ 的/ 缺陷/ ,/ 本文/ 提出/ 的/ 方法/ 建立/ 了/ 多层/ 循环/ 流水/ 迭代/ 间/ 启动/ 间距/ 分析模型/ ,/ 并/ 提出/ 了/ 非/ 固定/ 启动/ 间距/ 的/ 控制策略/ ,/ 设计/ 实现/ 了/ 自动/ 分析/ 启动/ 间距/ 的/ 算法/ ,/ 最后/ 通过/ 流水线/ 调度/ 方式/ 对/ 多层/ 循环/ 中/ 启动/ 间距/ 进行/ 优化/ ./ 实验/ 结果表明/ ,/ 针对/ 计数/ 类/ 多层/ 循环/ 应用程序/ ,/ 本文/ 方法/ 不仅/ 实现/ 了/ 细粒度/ 可/ 重构/ 编译器/ 中/ 实现/ 循环/ 程序/ 流水/ 硬件/ 结构/ 映射/ 时/ 启动/ 间距/ 分析/ 的/ 自动化/ ,/ 提高/ 了/ 可/ 重构/ 计算/ 应用/ 的/ 部署/ 效率/ ,/ 还/ 能够/ 有效/ 降低/ 循环/ 程序/ 在/ FPGA/ 硬件/ 上/ 流水/ 执行/ 时/ 因为/ 启动/ 间距/ 产生/ 的/ 时钟/ 等待/ 延时/ ,/ 提高/ 了/ 循环/ 程序/ 流水/ 执行/ 的/ 性能/ ./ 本文/ 会/ 继续/ 致力于/ 在/ 异构/ 加速/ 平台/ 上/ 循环/ 流水/ 自动/ 映射/ 方向/ 的/ 研究/ ,/ 下/ 一步/ 会/ 结合/ 参数/ 化/ 并行/ 存储/ 模板/ ,/ 进行/ 循环/ 流水/ 硬件/ 结构/ 的/ 研究/ ,/ 将/ 本文/ 提出/ 的/ 非/ 固定/ 启动/ 间距/ 控制策略/ 在/ 异构/ 加速/ 平台/ 上/ 进行/ 实现/ 和/ 完善/ ./ 致谢/ Xilinx/ 大学/ 合作/ 计划/ 对/ 课题组/ 提供/ 了/ 相应/ 的/ 开发/ 平台/ ,/ 中国科学院计算技术研究所/ 计算机/ 体系结构/ 国家/ 重点/ 实验室/ 对本/ 课题/ 给予/ 了/ 支持/ ,/ 在/ 此/ 表示感谢/ !/ Page13/ 

