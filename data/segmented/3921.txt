Page1/ 面向/ 业务/ 特征/ 的/ 自/ 适应/ 虚拟机/ 迁移/ 带宽/ 分配/ 算法/ 刘诗海/ 1/ )/ ,/ 2/ )/ ,/ 3/ )/ 孙宇清/ 1/ )/ 刘/ 古月/ 4/ )/ 1/ )/ (/ 山东大学/ 计算机科学/ 与/ 技术/ 学院/ 济南/ 250101/ )/ 2/ )/ (/ 中国人民解放军/ 68067/ 部队/ 兰州/ 733000/ )/ 3/ )/ (/ 中国科学院计算技术研究所/ 计算机/ 体系结构/ 国家/ 重点/ 实验室/ 北京/ 100190/ )/ 4/ )/ (/ 北京邮电大学/ 国际/ 学院/ 北京/ 102209/ )/ 摘要/ 虚拟机/ 动态/ 迁移/ 是/ 支持/ 绿色/ 云/ 计算环境/ 的/ 重要/ 技术/ ,/ 迭代/ 时间/ 和/ 宕机/ 时间/ 是/ 迁移/ 性能/ 的/ 衡量/ 指标/ ,/ 而/ 虚拟机/ 迁移/ 时/ 使用/ 的/ 网络带宽/ 和/ 业务/ 运行/ 产生/ 的/ 内存/ 脏页/ 是/ 影响/ 迁移/ 性能/ 的/ 重要/ 因素/ ,/ 因此/ 合理/ 分配/ 迁移/ 带宽/ 和/ 减少/ 脏页/ 率/ 能够/ 有效/ 缩短/ 迭代/ 时间/ 和/ 宕机/ 时间/ ./ 该文/ 提出/ 了/ 一种/ 面向/ 业务/ 特征/ 的/ 自/ 适应/ 虚拟机/ 迁移/ 带宽/ 分配/ 算法/ ,/ 通过/ 对/ 迁移/ 过程/ 中脏页/ 率/ 的/ 分析/ ,/ 预测/ 运行/ 业务/ 的/ 网络带宽/ 使用量/ ,/ 自/ 适应/ 分配/ 虚拟机/ 迁移/ 带宽/ ;/ 引入/ 带宽/ 调整/ 系数/ ,/ 有效/ 处理/ 迁移/ 过程/ 中/ 的/ 业务/ 数据/ 抖动/ 现象/ ,/ 从而/ 确保/ 预测/ 的/ 合理性/ ./ 这一/ 算法/ 能够/ 在/ 保证/ 迁移/ 性能/ 和/ 系统可靠性/ 的/ 同时/ ,/ 减少/ 迭代/ 时间/ 和/ 宕机/ 时间/ ./ 实验/ 表明/ 在/ 带宽/ 资源/ 有限/ 的/ 前提/ 下/ ,/ 该/ 方法/ 能够/ 合理/ 利用/ 空闲/ 带宽/ 资源/ ,/ 提高/ 迁移/ 性能/ ,/ 确保/ 业务/ 服务质量/ ./ 关键词/ 虚拟机/ ;/ 动态/ 迁移/ ;/ 带宽/ 分配/ ;/ 脏页/ 率/ ;/ 绿色/ 计算/ ;/ 云/ 计算/ 1/ 引言/ 云/ 计算环境/ 能够/ 为/ 用户/ 提供/ 安全可靠/ 的/ 计算/ 和/ 存储/ 服务/ ,/ 被/ 称为/ 下一代/ 计算/ 模式/ ./ 它/ 利用/ 虚拟化/ 技术/ 管理/ 共享资源/ ,/ 通过/ 创建/ 多个/ 虚拟机/ 来/ 装载/ 不同/ 服务/ ,/ 以/ 隔离/ 执行/ 环境/ ,/ 满足/ 不同/ 用户/ 的/ 应用/ 需求/ ;/ 并/ 可以/ 自/ 适应/ 分配/ 和/ 调度/ 各种/ 物理/ 资源/ ,/ 从而/ 高效/ 绿色/ 地/ 管理/ 云/ 计算/ 平台/ 中/ 的/ 资源/ 和/ 服务/ [/ 1/ ]/ ./ 其中/ ,/ 虚拟机/ 动态/ 迁移/ (/ LiveMigration/ )/ 技术/ [/ 2/ ]/ 是/ 在/ 不/ 影响/ 服务/ 的/ 前提/ 下/ ,/ 将/ 服务/ 从源/ 主机/ 迁移/ 到/ 目的/ 主机/ 继续/ 运行/ ,/ 以/ 达到/ 动态/ 负载/ 均衡/ 、/ 在线/ 系统维护/ 等/ 目的/ ,/ 是/ 实现/ 绿色/ 资源管理/ 的/ 重要/ 手段/ [/ 3/ ]/ ./ 然而/ ,/ 虚拟机/ 迁移/ 过程/ 有/ 少量/ 的/ 宕机/ 时间/ ,/ 会/ 使/ 服务/ 产生/ 短暂/ 中断/ ,/ 部分/ 地/ 影响/ 服务质量/ 和/ 用户/ 体验/ ;/ 另一方面/ ,/ 虚拟机/ 迁移/ 还/ 占用/ 额外/ 的/ CPU/ 、/ 网络带宽/ 、/ 内存/ 等/ 物理/ 资源/ ,/ 也/ 一定/ 程度/ 影响/ 到/ 云/ 计算环境/ 中/ 的/ 其他/ 服务/ ./ 因此/ ,/ 提高/ 虚拟机/ 迁移/ 性能/ ,/ 是/ 维护/ 高效/ 绿色/ 资源管理/ 的/ 核心/ ,/ 也/ 是/ 虚拟化/ 技术/ 的/ 研究/ 热点/ ./ 虚拟机/ 动态/ 迁移/ 的/ 关键/ 是从/ 源/ 主机/ 高效/ 复制/ 和/ 传输/ 虚拟机/ 内存/ 状态/ 到/ 目的/ 主机/ ,/ 现有/ 的/ 主流/ 虚拟化/ 平台/ 如/ Xen/ 、/ VMware/ 等/ 普遍/ 采用/ 预/ 拷贝/ 算法/ [/ 2/ ]/ 进行/ 虚拟机/ 动态/ 迁移/ ,/ 并且/ 有/ 许多/ 成功/ 的/ 应用/ 如/ 亚马逊/ 、/ IBM/ 等/ 云/ 计算/ 服务平台/ [/ 4/ -/ 6/ ]/ ./ 预/ 拷贝/ 算法/ 分为/ 初始化/ 、/ 迭代/ 拷贝/ 和/ 宕机/ 拷贝/ 3/ 个/ 阶段/ ,/ 通过/ 多轮/ 迭代/ 将/ 虚拟机/ 内存/ 状态/ 从源/ 主机/ 发送到/ 目的/ 主机/ ,/ 待/ 内存/ 同步/ 后/ ,/ 目的/ 主机/ 继续/ 运行/ 虚拟机/ [/ 7/ ]/ ./ 这种/ 方法/ 可以/ 缩短/ 虚拟机/ 迁移/ 时间/ ,/ 提高/ 迁移/ 性能/ ./ 然而/ ,/ 在/ 实际/ 应用/ 中/ ,/ 虚拟机/ 运行/ 不同/ 业务/ 所/ 使用/ 的/ 物理/ 资源/ 如/ 网络带宽/ 和/ 业务/ 运行/ 产生/ 的/ 内存/ 脏页/ 等/ 因素/ 会/ 很大/ 程度/ 上/ 影响/ 迁移/ 性能/ ./ 例如/ ,/ 当/ 虚拟机/ 中/ 运行/ I/ // O/ 密集型/ 业务/ 时/ ,/ 内存/ 修改/ 速率/ 过大/ ,/ 在/ 宕机/ 拷贝/ 时/ 需要/ 拷贝/ 大量/ 内存/ 脏页/ ,/ 增加/ 宕机/ 时间/ ,/ 影响/ 用户/ 访问/ 虚拟机/ 内部/ 的/ 应用/ ./ 另一方面/ ,/ 当/ 可用/ 物理/ 网络带宽/ 小于/ 虚拟机/ 脏页/ 的/ 传输/ 量/ 时/ ,/ 预/ 拷贝/ 算法/ 中/ 迭代/ 发送/ 过程/ 就/ 会/ 强制/ 停止/ ,/ 从而/ 造成/ 内存/ 同步/ 收敛性/ 问题/ [/ 8/ ]/ ./ 针对/ 现有/ 虚拟化/ 平台/ 中/ 动态/ 迁移/ 的/ 预/ 拷贝/ 算法/ 的/ 不足/ ,/ 本文/ 提出/ 了/ 一种/ 面向/ 业务/ 特征/ 的/ 自/ 适应/ 虚拟机/ 迁移/ 带宽/ 分配/ 算法/ ,/ 通过/ 分析/ 迁移/ 迭代/ 过程/ 中/ 的/ 脏页/ 率/ ,/ 使用/ 带宽/ 调整/ 系数/ ,/ 预测/ 运行/ 业务/ 网络带宽/ 使用量/ ,/ 从而/ 自/ 适应/ 分配/ 虚拟机/ 迁移/ 带宽/ ,/ 在/ 保证/ 迁移/ 性能/ 和/ 系统可靠性/ 的/ 同时/ ,/ 减少/ 迭代/ 时间/ 和/ 迁移/ 时间/ ./ 本文/ 第/ 2/ 节/ 介绍/ 相关/ 工作/ ;/ 第/ 3/ 节/ 详细描述/ 算法/ 的/ 整体/ 思路/ ;/ 第/ 4/ 节/ 介绍/ 具体/ 实现/ 以及/ 系统/ 性能/ 分析/ ;/ 最后/ 总结/ 全文/ ./ 2/ 相关/ 工作/ 虚拟机/ 现有/ 的/ 动态/ 迁移/ 技术/ 可/ 分为/ 预/ 拷贝/ 和/ 后/ 拷贝/ 两种/ 方法/ [/ 9/ -/ 10/ ]/ ,/ 基于/ 后/ 拷贝/ (/ Post/ -/ copy/ )/ 算法/ 的/ 动态/ 迁移/ 技术/ 是/ 将/ 内存/ 的/ 同步/ 推迟/ 到/ VM/ 在/ 目的/ 主机/ 上/ 恢复/ 运行/ 之后/ ./ 迁移/ 时先/ 将/ 被/ 迁移/ 虚拟机/ 除/ 内存/ 以外/ 的/ 设备/ 状态/ 在/ 两台/ 主机/ 之间/ 同步/ ,/ 并/ 在/ 目的/ 主机/ 中/ 启动/ 虚拟机/ ,/ 然后/ 使用/ 按/ 需取/ 页/ 的/ 方式/ 实现/ 两端/ 虚拟机/ 内存/ 同步/ ./ 虽然/ 该/ 机制/ 能够/ 保证/ 每个/ 内存/ 页/ 至多/ 复制/ 一次/ ,/ 从根本上/ 避免/ 了/ 冗余/ 数据/ 对/ 网络带宽/ 的/ 占用/ ,/ 但是/ 当/ 虚拟机/ 在/ 目的/ 主机/ 上/ 运行/ ,/ 并/ 访问/ 未/ 同步/ 页面/ 时/ ,/ 该/ 机制/ 会/ 使/ 虚拟机/ 频繁/ 中断/ 以/ 同步/ 内存/ 页/ ,/ 造成/ 虚拟机/ 性能/ 下降/ 以及/ 内存/ 应用/ 执行/ 延时/ 增加/ ./ 同时/ ,/ 也/ 不/ 能够/ 很/ 好/ 地/ 满足/ 动态/ 迁移/ 透明性/ 要求/ ./ 预/ 拷贝/ 方法/ 是/ 现有/ 虚拟化/ 平台/ 普遍/ 采用/ 的/ 迁移/ 方案/ ,/ 它/ 通过/ 迭代/ 拷贝/ 内存/ ,/ 以较/ 短/ 的/ 迭代/ 拷贝/ 时间/ 和/ 宕机/ 时间/ ,/ 实现/ “/ 无缝/ ”/ 的/ 虚拟机/ 动态/ 迁移/ ,/ 以下/ 讨论/ 将/ 主要/ 针对/ 这种/ 方案/ 进行/ 改进/ ./ 在/ 实际/ 应用/ 中/ ,/ 由于/ 虚拟机/ 中/ 运行/ 业务/ 特征/ 的/ 不同/ ,/ 会/ 造成/ 不同/ 程度/ 地/ 延长/ 迭代/ 拷贝/ 时间/ 和/ 宕机/ 时间/ ,/ 影响/ 整体/ 迁移/ 性能/ ,/ 甚至/ 会/ 造成/ 动态/ 迁移/ 失败/ ./ 目前/ ,/ 针对/ 上述/ 问题/ 简单/ 的/ 解决/ 方法/ 是/ 在/ 执行/ 迁移/ 前/ 用户/ 根据/ 经验/ 以及/ 当前/ 业务/ 特征/ ,/ 手动/ 调整/ 迭代/ 发送/ 次数/ 以及/ 每轮/ 发送/ 的/ 缓存/ ,/ 强行/ 制约/ 发送/ 过程/ 中/ 对/ 内存/ 状态/ 的/ 复制/ ./ 但/ 对于/ I/ // O/ 密集型/ 业务/ ,/ 在/ 宕机/ 拷贝/ 时/ 可能/ 还/ 存在/ 大量/ 需/ 发送/ 的/ 内存/ 脏页/ ,/ 延长/ 虚拟机/ 宕机/ 结束/ 时间/ ,/ Page3/ 影响/ 动态/ 迁移/ 过程/ 中/ 外部/ 程序/ 的/ 可/ 访问/ 性/ ./ 为了/ 减少/ 迁移/ 过程/ 中/ 发送/ 的/ 内存/ 数量/ ,/ 现阶段/ 使用/ 最多/ 的/ 是/ 气球/ 驱动/ (/ BalloonDriver/ )/ 机制/ [/ 7/ ]/ ,/ 在/ 迁移/ 准备/ 阶段/ 减少/ 被/ 迁移/ 虚拟机/ 空闲/ 和/ 不/ 使用/ 的/ 内存/ ,/ 但/ 这种/ 方法/ 只/ 能够/ 缩短/ 首轮/ 迭代/ 发送/ 的/ 时间/ ./ 文献/ [/ 11/ ]/ 设计/ 并/ 实现/ 了/ 一种/ 虚拟机/ 迁移/ 的/ 选择/ 策略/ ,/ 用来/ 选择/ 哪个/ 虚拟机/ 应该/ 进行/ 迁移/ ./ 但/ 该/ 方法/ 仅/ 从/ 内存/ 尺寸/ 、/ 脏页/ 率/ 等/ 角度/ 进行/ 虚拟机/ 的/ 选择/ ,/ 未/ 结合/ 业务/ 特征/ ,/ 动态/ 改变/ 带宽/ 分配/ ./ 在/ 使用/ 预/ 拷贝/ 机制/ 进行/ 内存/ 迭代/ 发送/ 时/ ,/ 如果/ 出现/ 迁移/ 数据/ 冗余/ 性过/ 高/ ,/ 就/ 会/ 造成/ 物理/ 资源/ 的/ 损耗/ ./ 为了/ 减少/ 冗余/ 性/ 和/ 内存/ 发送/ 数量/ ,/ Jin/ 等/ 人/ [/ 12/ -/ 13/ ]/ 提出/ 了/ 利用/ 数据/ 压缩算法/ 将/ 每轮/ 发送/ 的/ 内存/ 页面/ 压缩/ 后/ 传输/ ,/ 由于/ 压缩算法/ 的/ 限制/ ,/ 会/ 出现/ 压缩/ 后/ 传输/ 的/ 时间/ 大于/ 未/ 压缩/ 传输/ 的/ 时间/ ,/ 以及/ 对/ 宿主机/ CPU/ 等/ 物理/ 资源/ 的/ 额外/ 消耗/ ./ 孙国飞/ 等/ 人/ [/ 10/ ]/ 利用/ 马尔可夫/ 预测/ 模型/ 优化/ 了/ 预/ 拷贝/ 机制/ 中/ 工作/ 集/ 的/ 选取/ 方法/ ,/ 对/ 传输/ 页面/ 进行/ 了/ 预判/ ,/ 减少/ 了/ 对/ 冗余/ 数据/ 的/ 传输/ ,/ 但/ 该/ 方法/ 只/ 对脏页/ 率/ 较/ 高/ 的/ 情况/ 有/ 较/ 好/ 效果/ ./ 文献/ [/ 15/ ]/ 提出/ 虚拟机/ 迁移/ 算法/ HMDC/ ,/ 将/ Pull/ 阶段/ 产生/ 的/ 内存/ 副本/ 与/ Push/ 阶段/ 产生/ 的/ 内存/ 副本/ 进行/ 组合/ ,/ 再/ 利用/ 异或/ 二进制/ RLE/ 算法/ ,/ 将/ 内存/ 页/ 进行/ 压缩/ ,/ 将/ 压缩/ 的/ 内存/ 页面/ 发送给/ 目的/ 主机/ ./ 通过/ 差值/ 压缩/ ,/ HMDC/ 能够/ 增加/ 吞吐/ 率/ 并/ 减少/ 传递/ 的/ 数据量/ ,/ 从而/ 能/ 较/ 快/ 地/ 复制/ 内存/ 脏页/ ,/ 但是/ 该/ 方法/ 的/ 鲁棒性/ 需/ 进一步/ 研究/ ,/ 如/ 停电/ 或/ 机器/ 崩溃/ 时/ ,/ 如何/ 从源/ 主机/ 进行/ 恢复/ ./ 远程/ 内存/ 访问/ (/ RemoteDirectMemoryAccess/ ,/ RDMA/ )/ 技术/ 是/ 另/ 一种/ 基于/ 预/ 拷贝/ 算法/ 的/ 虚拟机/ 迁移/ 策略/ [/ 14/ ]/ ,/ 它/ 根据/ 主机/ 资源/ 需求/ 和/ 负载/ 情况/ ,/ 选择/ 不同/ 的/ 迁移/ 协议/ ,/ 可以/ 有效/ 减少/ 传输数据/ 量/ ,/ 但是/ 这种/ 方法/ 需要/ 高性能/ 网络/ 支持/ ,/ 在/ 实际/ 应用/ 中/ 会/ 受到/ 局限/ ./ 利用/ 调度/ CPU/ 状态/ 等/ 硬件/ 控制/ 方法/ 限制/ 内存/ 访问/ 次数/ 的/ 迁移/ 策略/ 可以/ 减少/ 迭代/ 发送量/ [/ 16/ ]/ ,/ 但会/ 影响/ 用户/ 访问/ 虚拟机/ 内部/ 的/ 资源/ 和/ 服务质量/ ./ 基于/ “/ 记录/ -/ 重/ 放/ ”/ 技术/ 的/ 迁移/ 从/ 一个/ 检查点/ 状态/ 出发/ ,/ 使用/ 记录/ 的/ 日志/ 向前/ 回滚/ ,/ 达到/ 提高/ 迁移/ 性能/ 的/ 目的/ [/ 17/ ]/ ./ 但/ 在/ 多/ 处理/ 环境/ 中/ ,/ 记录/ 和/ 重放/ 虚拟/ CPU/ 之间/ 的/ 内存/ 同步/ 状态/ 代价/ 很/ 高/ ,/ 增加/ 了/ 迁移/ 难度/ ,/ 性能/ 提高/ 也/ 不是/ 很/ 明显/ ,/ 同时/ 当脏页/ 率/ 大于/ 预/ 拷贝/ 速度/ 时/ 就/ 会/ 失效/ ./ 文献/ [/ 18/ ]/ 中/ 在/ 集群/ 环境/ 中/ 利用/ 分布式文件系统/ 的/ 可扩展性/ 减少/ 迁移/ 时间/ ,/ 只/ 适用/ 于/ GlusterFS/ 文件系统/ ./ 结合/ 内存/ 推送/ 复制/ 以及/ 按/ 需/ 复制/ 两种/ 方式/ 实现/ 虚拟机/ 的/ 快速/ 迁移/ [/ 8/ ]/ ,/ 虽然/ 避免/ 了/ 不必要/ 的/ 状态/ 切换/ ,/ 优化/ 了/ 迁移/ 时间/ ,/ 但是/ 虚拟机/ 的/ 完整/ 状态/ 需要/ 由源/ 和/ 目的/ 宿主机/ 共同/ 维护/ ,/ 否则/ 会/ 导致/ 虚拟机/ 迁移/ 失败/ 和/ 运行/ 状态/ 丢失/ ./ 针对/ 虚拟/ 集群/ 迁移/ ,/ 文献/ [/ 19/ ]/ 提出/ 了/ 一个/ 动态/ 的/ 虚拟机/ 迁移/ 机制/ Shrinker/ ,/ 通过/ 检查/ 同一个/ 虚拟/ 集群/ 中/ 的/ 内存/ 页面/ 以及/ 磁盘/ 块/ ,/ 避免/ 将/ 相同/ 内容/ 的/ 副本/ 进行/ 多次/ 发送/ ,/ 从而/ 减少/ 迁移/ 过程/ 中/ 的/ 迁移/ 数据量/ 以及/ 迁移/ 时间/ ,/ 该/ 方法/ 同样/ 没有/ 结合/ 业务/ 特征/ ,/ 动态/ 改变/ 带宽/ 分配/ ./ 作为/ 虚拟化/ 领域/ 的/ 主流/ 平台/ ,/ 开源/ 虚拟机/ 管理系统/ Xen/ 在/ 使用/ 预/ 拷贝/ 算法/ 实施/ 动态/ 迁移/ 的/ 过程/ 中/ ,/ 使用/ 默认/ 网络带宽/ 传输/ 分配/ 和/ 增量/ 网络带宽/ 分配/ 两种/ 内存/ 传输方式/ [/ 20/ ]/ ./ 其中/ ,/ 默认/ 带宽/ 分配模式/ 是/ 将/ 本轮/ 迭代/ 需要/ 发送/ 的/ 脏/ 页面/ 放入/ 内部/ 定义/ 的/ 缓存/ 中/ ,/ 当/ 需要/ 发送/ 的/ 内存/ 页面/ 被/ 存放/ 完毕/ 或/ 缓存/ 被/ 放满/ 后/ ,/ 通过/ 原生/ 设备/ 驱动/ 或/ 设备/ 模型/ 利用/ 安全/ 硬件/ 接口/ 将/ 缓存/ 中/ 的/ 内存/ 页面/ 全部/ 传输/ 到/ 物理/ 网卡/ ,/ 由/ 物理/ 网卡/ 选择/ 发送/ 时机/ ./ 在/ 实际/ 应用/ 过程/ ,/ 受到/ 实际/ 网络带宽/ 和/ 运行/ 业务/ 特征/ 等/ 影响/ ,/ 当/ 物理/ 带宽/ 使用量/ 较大/ 时/ ,/ 可能/ 会/ 导致/ 大量/ 缓存/ 拥塞/ 在/ 物理/ 网卡/ 处/ 排队/ ,/ 出现/ 迭代/ 过程/ 的/ 收敛性/ 问题/ [/ 7/ ]/ ,/ 并且/ 还会/ 出现/ 发送/ 内存/ 与/ 业务/ 运行/ 抢占/ 带宽/ 的/ 现象/ ,/ 加之/ 预/ 拷贝/ 算法/ 受/ 自身/ 特征/ 约束/ ,/ 影响/ 迁移/ 性能/ 和/ 运行/ 业务/ 服务质量/ ,/ 甚至/ 造成/ 迁移/ 失败/ ./ 增量/ 带宽/ 分配模式/ 是/ 将/ 首轮/ 发送/ 带宽/ 初始化/ 为/ 常量/ ,/ 后续/ 每轮/ 迭代/ 发送/ 带宽/ 是/ 在/ 上/ 一轮/ 迭代/ 时/ 产生/ 的/ 脏页/ 率/ 基础/ 上/ 增加/ 一个/ 常/ 数量/ ,/ 但/ 最大/ 使用/ 带宽/ 不能/ 超过/ 系统/ 限定/ 的/ 常数/ 级/ ./ 该/ 模式/ 受到/ 内部/ 实现/ 机制/ 的/ 限制/ ,/ 在/ 百兆/ 以下/ 网络/ (/ 包括/ 百兆/ )/ 环境/ 是/ 失效/ 的/ ,/ 在/ 千兆/ 以上/ 网络/ (/ 包括/ 千兆/ )/ 环境/ 中/ ,/ 物理/ 带宽/ 使用量/ 较/ 少时/ ,/ 会/ 造成/ 物理/ 带宽/ 资源/ 利用/ 不/ 充分/ ,/ 限制/ 虚拟机/ 迁移/ 性能/ 提升/ ,/ 同时/ 根据/ 单轮/ 脏页/ 率/ 分配/ 发送/ 带宽/ ,/ 对于/ 处理/ 业务/ 突发性/ 和/ 数据/ 抖动/ 性是/ 不合理/ 的/ ./ 3/ 自/ 适应/ 虚拟机/ 迁移/ 带宽/ 分配/ 算法/ 3.1/ 整体/ 思路/ 基于/ 预/ 拷贝/ 机制/ 的/ 虚拟机/ 动态/ 迁移/ 过程/ 包括/ 迁移/ 初始化/ 阶段/ 、/ 迭代/ 拷贝/ 阶段/ 和/ 宕机/ 同步/ 阶段/ 3/ 个/ 方面/ ./ 初始化/ 阶段/ 是/ 对/ 被/ 迁移/ 的/ 虚拟机/ 的/ 基本/ 情况/ 进行/ 收集/ 、/ 判断/ 与/ 确定/ ,/ 并/ 根据/ 迁移/ 虚拟机/ 的/ 信息/ ,/ 在/ 目的/ 主机/ 中/ 申请/ 并/ 检查/ 预定/ 资源/ ,/ 确定/ 迁移/ 的/ 基本/ 条件/ ./ 此/ 阶段/ 所/ 需要/ 的/ 时间/ (/ 表示/ 为/ Tinit/ )/ 不/ 受/ 虚拟机/ 内存大小/ 以及/ 网络带宽/ 的/ 影响/ ,/ 因此/ ,/ 不/ 影响/ 虚拟机/ 动态/ 迁移/ 性能/ ./ Page4/ 迭代/ 拷贝/ 是/ 指/ 利用/ 迭代/ 拷贝/ 的/ 方法/ 将/ 被/ 迁移/ 虚拟机/ 内存/ 从源/ 主机/ 拷贝到/ 目的/ 主机/ ./ 初始化/ 阶段/ 完成/ 后/ ,/ 会/ 进入/ 迭代/ 拷贝/ 阶段/ ./ 迭代/ 拷贝/ 时间/ 越短/ ,/ 业务/ 应用/ 与/ 迁移/ 竞争/ 资源/ 的/ 时间/ 越短/ ,/ 服务质量/ 受到/ 的/ 影响/ 越少/ ./ 若/ 迭代/ 拷贝/ 轮数/ 为/ n/ ,/ 第/ 1/ 轮/ 迁移/ 迭代/ 发送/ 时/ 需要/ 将/ 被/ 迁移/ 虚拟机/ 的/ 所有/ 内存/ 页面/ 从源/ 主机/ 发送到/ 目的/ 主机/ ;/ 从/ 第/ 2/ 轮到/ n/ -/ 1/ 轮/ 迭代/ ,/ 需要/ 根据/ 前/ 一轮/ 产生/ 的/ 内存/ 脏页/ 数量/ 判断/ 和/ 计算/ 本轮/ 所/ 需/ 发送/ 的/ 虚拟机/ 内存/ 页面/ 数/ ,/ 所以/ 在/ 虚拟机/ 内存/ 被/ 修改/ 的/ 速率/ 一定/ 时/ ,/ 被/ 发送/ 的/ 内存/ 脏页/ 数量/ 跟上/ 一轮/ 迭代/ 的/ 时间/ 相关/ ,/ 迭代/ 时间/ 越长/ 产生/ 的/ 脏页/ 量/ 可能/ 会越/ 多/ ,/ 而且/ 迭代/ 发送/ 带宽/ 的/ 大小/ 直接/ 影响/ 到/ 每轮/ 迭代/ 迁移/ 的/ 时间/ ./ 设/ 被/ 迁移/ 虚拟机/ 的/ 内存大小/ 为/ Mmem/ ,/ 每轮/ 发送/ 的/ 内存/ 脏页/ 数量/ 为/ M/ _/ iteri/ ,/ 传输/ 内存/ 脏页/ 使用/ 的/ 网络带宽/ 为/ B/ _/ iteri/ ,/ 每轮/ 迭代/ 使用/ 的/ 时间/ 为/ T/ _/ iteri/ ,/ 根据/ 预/ 拷贝/ 算法/ 可知/ ,/ 第/ 1/ 轮/ 迭代/ 需要/ 发送/ 被/ 迁移/ 虚拟机/ 的/ 全部/ 内存/ ,/ 其它/ 迭代/ 轮次/ (/ 除/ 最后/ 一轮/ 迭代/ )/ 只/ 发送/ 前/ 一轮/ 迭代/ 时/ 由于/ 业务/ 运行/ 产生/ 的/ 内存/ 脏页/ 的/ 数量/ ./ 为此/ ,/ 我们/ 引入/ 式/ (/ 1/ )/ 计算/ 每轮/ 迭代/ 发送/ 内存/ 所/ 需/ 的/ 时间/ ./ 宕机/ 拷贝/ 是/ 指/ 动态/ 迁移/ 过程/ 中/ 虚拟机/ 暂停/ 后/ 将/ 剩余/ 的/ 内存/ 拷贝到/ 目的/ 主机/ ,/ 并/ 在/ 两台/ 主机/ 之间/ 同步/ 内存/ 和/ 相关/ 设备/ 状态/ 的/ 阶段/ ./ 宕机/ 拷贝/ 时间/ 受/ 被/ 迁移/ 虚拟机/ 剩余/ 内存/ 和/ 发送/ 带宽/ 限定/ ,/ 宕机/ 时间/ 越短/ ,/ 越能/ 保证/ 业务/ 的/ 服务质量/ ;/ 如果/ 宕机/ 时间/ 过长/ ,/ 就/ 会/ 影响/ 业务/ 服务/ 请求/ ./ 设/ 剩余/ 的/ 内存/ 脏页/ 拷贝/ 时间/ 为/ Tdown/ ,/ 内存/ 和/ 设备/ 状态/ 同步/ 时间/ 为/ Tdev/ ./ 为此/ ,/ 我们/ 引入/ 式/ (/ 2/ )/ 计算/ 宕机/ 拷贝/ 所/ 需/ 的/ 时间/ ./ 根据上述/ 分析/ 可知/ ,/ 虚拟机/ 动态/ 迁移/ 所/ 需/ 的/ 整体/ 时间/ (/ 表示/ 为/ Ttotal/ )/ 包括/ 迁移/ 初始化/ 时间/ 、/ 迭代/ 拷贝/ 时间/ 和/ 宕机/ 同步/ 拷贝/ 时间/ ,/ 如式/ (/ 3/ )/ 所示/ ./ 现有/ 研究/ 表明/ ,/ 虚拟机/ 动态/ 迁移/ 时间/ 主要/ 取决于/ 迭代/ 拷贝/ 和/ 宕机/ 拷贝/ 所/ 需/ 时间/ ,/ 动态/ 迁移/ 过程/ 中/ 发送/ 内存/ 使用/ 的/ 物理/ 网络带宽/ 和/ 虚拟机/ 脏页/ 率/ 是/ 影响/ 上述/ 性能指标/ 的/ 主要/ 因素/ ./ 当/ 需要/ 传输/ 的/ 内存/ 脏页/ 确定/ 时/ ,/ 网络带宽/ 的/ 大小/ 直接/ 影响/ 到/ 每轮/ 迭代/ 迁移/ 的/ 时间/ ;/ 在/ 最后/ 一轮/ (/ 宕机/ 拷贝/ 阶段/ )/ 网络带宽/ 的/ 合理/ 分配/ 也/ 会/ 影响/ 虚拟机/ 宕机/ 时间/ ./ 综上/ 分析/ ,/ 如果/ 物理/ 网络带宽/ 的/ 使用/ 分配/ 不合理/ ,/ 就/ 会/ 增加/ 后续/ 每轮/ 迭代/ 的/ 时间/ ,/ 迭代/ 时间/ 的/ 增加/ ,/ 势必会/ 造成/ 下/ 一轮/ 被/ 发送/ 的/ 脏页/ 数量/ 增加/ ,/ 造成/ 恶性循环/ ,/ 还/ 可能/ 使/ 迭代/ 过程/ 中/ 活跃/ 页面/ 的/ 数量/ 增加/ ,/ 最后/ 一轮/ 发送/ 时间/ 增加/ ,/ 造成/ 虚拟机/ 宕机/ 时间/ 增加/ ,/ 极端/ 情况/ 下/ ,/ 还会/ 使/ 每轮/ 产生/ 的/ 脏页/ 都/ 为/ 活跃/ 页/ ,/ 全部/ 积攒/ 到/ 最后/ 一轮/ 发送/ ,/ 此时/ 预/ 拷贝/ 算法/ 失效/ ,/ 使/ 动态/ 迁移/ 变为/ 静态/ 迁移/ ,/ 最终/ 不仅/ 会/ 影响/ 虚拟机/ 的/ 迁移/ 的/ 性能/ ,/ 还会/ 影响/ 在/ 虚拟机/ 内部/ 运行/ 业务/ 的/ 服务质量/ ./ Ttotal/ =/ Tinit/ +/ ∑/ n/ -/ 1/ 为此/ ,/ 本文/ 提出/ 了/ 自/ 适应/ 虚拟机/ 迁移/ 带宽/ 分配/ 算法/ ,/ 根据/ 迭代/ 轮数/ 的/ 不同/ ,/ 确定/ 不同/ 的/ 带宽/ 分配/ 方式/ ./ 当/ 第/ 1/ 轮/ 迭代/ 时/ ,/ 根据/ 现阶段/ 网络/ 状态/ 初始化/ 迭代/ 发送/ 带宽/ ;/ 当/ 最后/ 一轮/ 迭代/ 时/ ,/ 将/ 全部/ 剩余/ 带宽/ 发送/ 分配/ 给/ 迭代/ 发送/ 带宽/ ;/ 当/ 其它/ 轮/ 迭代/ 时/ ,/ 根据/ 前/ 一轮/ 迭代/ 产生/ 的/ 脏页/ 率/ 分析/ 当前/ 被/ 迁移/ 虚拟机/ 中/ 运行/ 业务/ 需要/ 的/ 带宽/ ,/ 并/ 结合/ 当前/ 网络/ 状态/ 分配/ 迭代/ 发送/ 带宽/ ./ 这样/ 通过/ 合理/ 调整/ 迭代/ 拷贝/ 过程/ 中/ 的/ 带宽/ 使用量/ ,/ 可以/ 合理/ 利用/ 空闲/ 带宽/ 资源/ ,/ 减少/ 迁移/ 迭代/ 的/ 时间/ ,/ 提高/ 迁移/ 性能/ 和/ 保证/ 业务/ 服务质量/ ./ 具体/ 流程/ 如图/ 1/ 所示/ ./ 3.2/ 数据/ 抖动/ 处理/ 在/ 实际/ 应用/ 中/ ,/ 不同/ 服务/ 占用/ 物理/ 资源/ 不同/ ,/ 如/ 流媒体/ 服务/ 主要/ 是/ 占用/ 网络资源/ ,/ 而/ 电子商务/ 服务/ 则/ 占用/ 网络资源/ 相对/ 较/ 小/ ;/ 相同/ 服务/ 在/ 不同/ 时刻/ 的/ 业务量/ 的/ 变化/ 也/ 带来/ 对/ 物理/ 资源/ 占/ 用量/ 的/ 差异/ ,/ 会/ 引起/ 对/ 内存/ 访问/ 和/ 修改/ 的/ 频率/ 和/ 数量/ 变化/ ,/ 因此/ ,/ 在/ 虚拟机/ 动态/ 迁移/ 过程/ 中/ 每轮/ 迭代/ 发送/ 的/ 脏/ 页数/ 也/ 是/ 变化/ 的/ ./ 所以/ ,/ 迭代/ 过程/ 中/ 产生/ 脏页/ 率/ 客观/ 反映/ 了/ 业务/ 特征/ ,/ 是/ 迭代/ 过程/ 中/ 分配/ 物理/ 网络带宽/ 的/ 主要/ 依据/ ./ 在/ 实际/ 应用/ 中/ ,/ 相同/ 服务/ 的/ 业务量/ 也/ 会/ 随着/ 时间/ 变化/ ,/ 存在/ 应用服务/ 对/ 访问/ 内存/ 数据量/ 突然/ 增大/ 的/ 情况/ ./ 若/ 此时/ 处于/ 虚拟机/ 迁移/ 过程/ ,/ 内存/ 被/ 修改/ 的/ 页面/ 数量/ 瞬间/ 增加/ ,/ 带来/ 本轮/ 产生/ 的/ 脏页/ 率/ 也/ 会/ 随之/ 增大/ ,/ 从而/ 导致/ 后续/ 迭代/ 时间/ 增加/ 和/ 内存/ 脏页/ 的/ 大量/ 重复/ 发送/ ,/ 影响/ 迭代/ 效率/ ./ 最终/ 造成/ 迁移/ 发送/ 带宽/ 分配/ 错误/ ,/ 影响/ 动态/ 迁移/ 性能/ 甚至/ 导致/ 动态/ 迁移/ 失败/ ./ 为了/ 解决/ 上述/ 问题/ ,/ 本文/ 引入/ 带宽/ 调整/ 系数/ α/ ∈/ [/ 0/ ,/ 1/ ]/ ,/ 不仅/ 考虑/ 业务/ 当前/ 运行/ 所/ 使用/ 的/ 带宽/ 和/ 虚拟机/ 迁移/ 过程/ 中/ 历史/ 脏页/ 率/ 反映/ 的/ 业务/ 特征/ ,/ 在/ 考虑/ 业务/ 运行/ 过程/ 数据量/ 抖动/ 性/ 的/ 同时/ ,/ 还/ 可以/ 较/ 准确/ 得到/ 实时/ 业务/ 特征/ 以及/ 本轮/ 迭代/ 业务/ 的/ 带宽/ 使用量/ ./ 因此/ ,/ 我们/ 使用/ 式/ (/ 4/ )/ 计算/ 第/ k/ 轮/ 迭代/ 过程/ 中/ Page5/ 图/ 1/ 迁移/ 带宽/ 分配/ 流程/ 业务/ 使用/ 带宽/ 量/ ./ B/ _/ bw/ =/ α/ ×/ AVG/ ∑/ k/ -/ 1U/ _/ dirty/ 为/ 历史/ 脏页/ 率/ ,/ 例如/ 在/ Xen/ 中/ ,/ 通过/ 函数/ xc/ _/ shadow/ _/ control/ (/ )/ 可以/ 获取/ 每轮/ 迭代/ 发送/ 时/ 产生/ 的/ 脏页/ 率/ ./ 带宽/ 调整/ 系数/ α/ 反映/ 了/ 分配/ 带宽/ 时/ 历史数据/ 和/ 当前/ 数据/ 的/ 影响/ 比例/ ,/ 当/ α/ ∈/ [/ 0/ ,/ 0.5/ )/ 时/ ,/ 表示/ 业务量/ 突然/ 减少/ ,/ 前/ i/ 次/ 迭代/ 期间/ 网络带宽/ 使用量/ 比/ 本轮/ 的/ 大时/ ,/ 应当/ 侧重/ 使用/ 历史数据/ 作为/ 参考/ ;/ 当/ α/ =/ 0.5/ 时/ ,/ 表示/ 当前/ 业务量/ 稳定/ ,/ 网络带宽/ 使用量/ 比较/ 均匀/ ;/ 当/ α/ ∈/ (/ 0.5/ ,/ 1/ ]/ 时/ ,/ 表示/ 当前/ 业务量/ 突然/ 增大/ ,/ 为了/ 防止/ 后续/ 业务量/ 增加/ 与/ 迁移/ 拷贝/ 过程/ 发生/ 带宽/ 抢占/ 现象/ ,/ 应当/ 侧重/ 使用/ 本/ 轮值/ 作为/ 参考/ ./ 带宽/ 调整/ 系数/ α/ 不仅/ 影响/ 预留/ 带宽/ 值/ ,/ 还会/ 影响/ 优化/ 算法/ 的/ 可行性/ 以及/ 迁移/ 性能/ 和/ 业务/ 服务质量/ ./ 由/ 经验/ 可知/ ,/ 该/ 系数/ 可/ 在/ 每轮/ 迭代/ 开始/ 前/ ,/ 利用/ 当前/ 物理/ 带宽/ 使用量/ 与/ 物理/ 带宽/ 总量/ 的/ 比值/ 确定/ 是/ 比较/ 恰当/ 的/ ./ 动态/ 调整/ α/ 值/ 能够/ 真实/ 地/ 反映/ 当前/ 物理/ 网络资源/ 的/ 使用/ 情况/ ,/ 及时/ 有效/ 地/ 根据/ 被/ 迁移/ 虚拟机/ 产生/ 的/ 脏页/ 率/ 预测出/ 本轮/ 迭代/ 过程/ 中/ 业务/ 所/ 需/ 的/ 物理/ 带宽/ ./ 3.3/ 算法/ 本/ 节/ 详细/ 给出/ 面向/ 业务/ 的/ 虚拟机/ 迁移/ 带宽/ 自/ 适应/ 分配/ 算法/ (/ AdaptiveBandwidthAllocation/ ,/ ABA/ )/ ./ 在/ 初始化/ 阶段/ ,/ 一是/ 获取/ 当前/ 物理/ 机所/ 连接/ 网络/ 的/ 信息/ ,/ 包括/ 总/ 带宽/ 量/ 、/ 现阶段/ 网络/ 使用量/ ,/ 并/ 计算/ 物理/ 空闲/ 网络带宽/ ;/ 二是/ 根据/ 迭代/ 轮数/ ,/ 确定/ 带宽/ 分配/ 规则/ ./ 当为/ 首轮/ 拷贝/ 时/ ,/ 需要/ 拷贝/ 所有/ 内存/ 页面/ ,/ 因此/ 根据/ 现阶段/ 网络/ 状态/ 初始化/ 发送/ 带宽/ 量/ 即可/ ,/ 当/ 出于/ 宕机/ 拷贝/ (/ last/ _/ iter/ )/ 阶段/ 时/ ,/ 虚拟机/ 为/ 宕机/ 状态/ ,/ 对/ 业务/ 无/ 响应/ ,/ 因此/ 将/ 空闲/ 带宽/ 全部/ 用于/ 传送/ 内存/ 页面/ ,/ 以/ 保证/ 最/ 短时间/ 内/ 内存/ 页面/ 传送/ 完毕/ ;/ 当为/ 其它/ 迭代/ 拷贝/ 轮数/ 时/ ,/ 进入/ 第/ 2/ 阶段/ ./ 迭代/ 运行/ 阶段/ 分/ 计算/ 预留/ 带宽/ 和/ 修正/ 预留/ 带宽/ 两个/ 步骤/ ./ 第/ 1/ 步/ 业务/ 预留/ 带宽/ 计算/ ,/ 根据/ 初始化/ 阶段/ 获取/ 的/ 物理/ 网络/ 信息/ 计算/ 系数/ α/ ,/ 并/ 利用/ 脏页/ 率/ 计算/ 业务/ 预留/ 带宽/ 量/ ,/ 为了/ 避免/ 数据/ 抖动/ 对/ 预留/ 带宽/ 计算结果/ 的/ 影响/ ,/ 利用/ 式/ (/ 4/ )/ 进行/ 计算/ ./ 第/ 2/ 步/ 预留/ 带宽/ 修正/ ,/ 第/ 1/ 步中/ 虽然/ 优化/ 了/ 数据/ 抖动/ 对/ 预留/ 带宽/ 计算/ 的/ 影响/ ,/ 但/ 业务/ 变化/ 引起/ 脏页/ 率/ 变化/ ,/ 可能/ 会/ 造成/ 计算/ 得出/ 的/ 业务/ 预留/ 带宽/ 大于/ 现阶段/ 空闲/ 带宽/ ./ 如果/ 出现/ 此种/ 情况/ ,/ 需要/ 对/ 业务/ 预留/ 带宽/ 量/ 进行/ 修正/ ./ 具体方法/ 为/ ,/ 利用/ 现阶段/ 使用/ 带宽/ 量/ 和/ 计算/ 得出/ 的/ 业务/ 预留/ 带宽/ 之间/ 的/ 比值/ ,/ 对/ 现有/ 空闲/ 带宽/ 进行/ 调配/ ./ 第/ 3/ 步/ ,/ 计算/ 迭代/ 发送/ 带宽/ ./ 根据/ 第/ 2/ 步/ 计算结果/ ,/ 计算/ 出/ 本轮/ 迭代/ 发送/ 使用/ 带宽/ ,/ 然后/ 进入/ 页面/ 迭代/ 发送/ ./ 详细/ 算法/ 见/ 算法/ 1/ ./ 算法/ 1/ ./ 自/ 适应/ 迁移/ 带宽/ 分配/ 算法/ (/ ABA/ 算法/ )/ ./ 输入/ :/ 迭代/ 轮次/ iter/ 输出/ :/ 本轮/ 次/ 分配/ 带宽/ E/ _/ bw1/ ./ IF/ (/ iter/ =/ =/ 1/ )/ THEN/ // // 第/ 1/ 轮/ 迭代/ 2/ ./ 初始化/ 迭代/ 发送/ 带宽/ E/ _/ bw3/ ./ returnE/ _/ bw4/ ./ ENDIF5/ ./ 获取/ 物理/ 网络/ 总/ 带宽/ T/ _/ bw/ ,/ 物理/ 使用/ 带宽/ U/ _/ bwPage66/ ./ 计算/ 物理/ 空闲/ 带宽/ F/ _/ bw/ =/ T/ _/ bw/ -/ U/ _/ bw7/ ./ IF/ (/ iter/ =/ =/ last/ _/ iter/ )/ THEN/ // // 最后/ 一轮/ 迭代/ 8/ ./ E/ _/ bw/ =/ F/ _/ bw9/ ./ returnF/ _/ bw10/ ./ ENDIF11/ ./ 计算/ 调节/ 系数/ α/ =/ U/ _/ bw/ // T/ _/ bw12/ ./ 获取/ 本轮/ 次脏页/ 率/ U/ _/ dirty/ [/ iter/ ]/ 13/ ./ 计算/ 前/ iter/ -/ 1/ 轮脏页/ 率/ 的/ 平均值/ 14/ ./ 计算/ 业务/ 当前/ 预留/ 带宽/ B/ _/ bw/ =/ α/ ×/ D/ _/ avg/ +/ (/ 1/ -/ α/ )/ ×/ U/ _/ dirty/ [/ iter/ ]/ 15/ ./ IF/ (/ B/ _/ bw/ >/ F/ _/ bw/ )/ THEN16/ ./ 修正/ 业务/ 预留/ 带宽/ 17/ ./ ENDIF18/ ./ returnE/ _/ bw/ =/ F/ _/ bw/ -/ B/ _/ bw4/ 系统/ 实现/ 与/ 性能/ 分析/ 4.1/ 基于/ Xen/ 的/ 系统/ 实现/ 开源/ 的/ Xen/ 虚拟化/ 平台/ 已经/ 成为/ 虚拟化/ 领域/ 的/ 主流/ 技术/ ,/ 因此/ 本文/ 基于/ Xen/ 平台/ 实现/ 了/ ABA/ 算法/ ./ 由于/ Xen/ 自身/ 不/ 具有/ 获取/ 当前/ 物理/ 网络/ 环境/ 的/ 功能/ ,/ 根据/ 本文/ 算法/ 的/ 需求/ ,/ 需要/ 在/ 迁移/ 源码/ 中/ 增加/ 物理/ 带宽/ 获取/ 模块/ ,/ 由于/ 在/ Xen/ 的/ 半/ 虚拟环境/ 中/ 迁移/ 过程/ 需要/ 陷入/ 到/ 操作系统/ 中/ 调用/ 超级/ 调用/ (/ Hypercall/ )/ 实现/ 对/ 敏感/ 指令/ 的/ 模拟/ 执行/ ,/ 当/ 在/ 迁移/ 源码/ 中/ 调用/ Linux/ 系统/ 函数/ 带宽/ 获取/ 模块/ 时会/ 出现/ 系统/ 调用/ 冲突/ ,/ 造成/ 动态/ 迁移/ 失败/ ./ 为此/ ,/ 本文/ 将/ 获取/ 物理/ 网络函数/ 编写成/ 独立/ 的/ 多线程/ 守护/ 进程/ ,/ 迁移/ 过程/ 中/ 所/ 需要/ 的/ 物理/ 网络/ 信息/ 全部/ 以/ 文件/ 流/ 的/ 方式/ 获取/ ./ 这样/ 可以/ 减少/ 对/ 迁移/ 过程/ 的/ 影响/ ./ 本文/ 获取/ 当前/ 物理/ 网络带宽/ 的/ 基本思路/ 为/ ,/ 利用/ Linux/ 系统/ 函数/ ,/ 首先/ 根据/ 物理/ 机/ 网卡/ 的/ 相关/ 信息/ 获取/ 当前/ 网络/ 的/ 物理/ 总/ 带宽/ ,/ 然后/ 每/ 间隔/ t/ 秒/ 收集/ 并/ 记录/ 一次/ 网络/ 收包/ 和/ 发包/ 的/ 具体/ 数量/ ,/ 最后/ 利用/ 式/ (/ 5/ )/ 和/ (/ 6/ )/ 计算/ 出/ 当前/ 已/ 用/ 物理/ 带宽/ 和/ 空闲/ 物理/ 带宽/ ./ Ubw/ =/ 其中/ ,/ Ubw/ 为/ 当前/ 已/ 用/ 物理/ 带宽/ ,/ Fbw/ 为/ 当前/ 空闲/ 物理/ 带宽/ ,/ Tbw/ 为/ 当前/ 物理/ 总/ 带宽/ ,/ Spack/ 和/ Rpack/ 分别/ 存放/ 物理/ 机/ 发送/ 和/ 接收/ 数据包/ 的/ 数量/ ./ 在/ 式/ (/ 6/ )/ 中/ 通过/ 物理/ 机/ 的/ 接收/ 和/ 发送/ 数据包/ 的/ 数量/ 计算/ 出现/ 有/ 物理/ 网络/ 中/ 已/ 使用/ 的/ 网络带宽/ ,/ 此/ 带宽/ 不仅/ 包括/ 当前/ 迁移/ 虚拟机/ 时所/ 使用/ 的/ 带宽/ ,/ 还/ 包括/ 物理/ 机中/ 其它/ 虚拟机/ 和/ 其它/ 程序/ 所/ 使用/ 的/ 网络带宽/ 量/ ./ 现实/ 中/ 业务量/ 的/ 大小/ 是/ 随机/ 变化/ 的/ ,/ 这里/ 时间/ t/ 的/ 选择/ 会/ 直接/ 影响/ Ubw/ 取值/ ,/ 例如/ :/ 当/ 间隔时间/ t/ 取值/ 过/ 小时/ ,/ 会/ 出现/ Spacki/ 与/ Spacki/ -/ 1/ 或/ Rpacki/ 与/ Rpacki/ -/ 1/ 两/ 两/ 之间/ 的/ 差值/ 为/ 零/ ,/ 无法/ 得到/ Ubw/ 的/ 值/ ,/ 造成/ 带宽/ 分配/ 失败/ ;/ 当/ 间隔时间/ t/ 过大时/ ,/ 由于/ 业务量/ 随机/ 变化/ ,/ 造成/ Ubw/ 不能/ 精确/ 地/ 体现/ 当前/ 物理/ 带宽/ 的/ 使用量/ ./ 根据/ 经验/ ,/ 本文/ 设定/ 间隔时间/ t/ 为/ 1s/ ./ 4.2/ 实验/ 环境/ 实验/ 平台/ 选用/ 了/ 配置/ 为/ AMDOpteron/ 四核/ 处理器/ (/ 2.0/ GHz/ )/ 、/ 40GB/ 内存/ 和/ SCSI/ 磁盘/ 接口/ 的/ 曙光/ 服务器/ ./ 在/ 千兆/ 网络/ 中/ 使用/ NFS/ (/ NetworkFileSystem/ )/ 共享/ 存储/ 模式/ ,/ 并/ 采用/ 内核/ 2.6/ ./ 18/ 的/ Linux/ 操作系统/ 和/ Xen/ -/ 4.1/ ./ 0/ 虚拟化/ 平台/ ,/ 在/ 半/ 虚拟化/ 环境/ 中/ 配置/ 1/ 个/ VCPU/ ,/ 2GB/ 内存/ 和/ 10GB/ 磁盘空间/ 的/ Linux/ 操作系统/ 的/ 虚拟机/ ./ 迁移/ 不/ 使用/ 专用/ 网络/ ,/ 与/ 物理/ 机/ 共享/ 同一/ 网络/ ./ 并/ 选择/ TPC/ -/ W/ ①/ 和/ SPEC/ -/ web2009/ ②/ 两种/ Benchmark/ 代表/ 网络/ 密集型/ 业务/ 和/ 内存/ 密集型/ 业务/ ./ 为了/ 验证/ 在/ I/ // O/ 密集/ 环境/ 下/ 利用/ ABA/ 算法/ 实施/ 虚拟机/ 迁移/ 的/ 优化/ 效果/ ,/ 利用/ 上述/ Benchmark/ 分别/ 对/ Xen/ 自有/ 的/ 两种/ 传输/ 算法/ 和/ ABA/ 算法/ 进行/ 迁移/ 时间/ 、/ 宕机/ 时间/ 、/ 设备/ 迁移/ 时间/ 和/ 服务质量/ 等/ 方面/ 的/ 对比性/ 测试/ ./ 下述/ 实验/ 中/ Xen/ _/ 0/ 表示/ Xen/ 自有/ 的/ 无/ 带宽/ 分配/ 算法/ ,/ Xen/ _/ 50/ 表示/ Xen/ 自有/ 的/ 增量/ 带宽/ 分配/ 算法/ ,/ Xen/ _/ ABA/ 表示/ 本文/ 提出/ 的/ ABA/ 迁移/ 算法/ ./ 4.3/ 迁移/ 性能/ 测试/ 与/ 分析/ 首先/ 测试/ 不同/ 环境/ 下/ 业务量/ 对/ 宕机/ 时间/ 、/ 设备/ 传输/ 时间/ 、/ 迭代/ 发送/ 时间/ 和/ 迁移/ 总/ 时间/ 的/ 影响/ ./ TPC/ -/ W/ 环境/ 下/ 的/ 测试/ 结果/ 如图/ 2/ (/ a/ )/ 、/ (/ b/ )/ 所示/ ./ 在/ 图/ 2/ (/ a/ )/ 中/ ,/ 柱形/ 框/ 表示/ 不同/ 迁移/ 算法/ 下/ 的/ 宕机/ 时间/ ,/ 折线/ 表示/ 了/ 不同/ 迁移/ 算法/ 下/ 的/ 设备/ 传输/ 时间/ ./ 实验/ 结果表明/ ABA/ 算法/ 比/ Xen/ 自有/ 的/ 算法/ 带来/ 宕机/ 时间/ 缩短/ 了/ 50/ %/ 以上/ ,/ 设备/ 传输/ 时间/ 也/ 有/ 明显/ 减少/ ,/ 并且/ 随着/ 业务量/ 的/ 增加/ 宕机/ 时间/ 波动/ 很小/ ./ 从图/ 2/ (/ b/ )/ 记录/ 的/ 迭代/ 时间/ 和/ 迁移/ 总/ 时间/ 可以/ 看出/ ,/ ABA/ 算法/ 在/ 迭代/ 时间/ 和/ 迁移/ 总/ 时间/ 两/ 方面/ 都/ 低于/ 增量/ 分配/ 算法/ ,/ 略高于/ 无/ 带宽/ 分配/ 算法/ ,/ 结合/ 图/ 2/ ①/ ②/ Page7/ (/ a/ )/ 可知/ ,/ ABA/ 算法/ 在/ 迭代/ 期间/ 需要/ 预留/ 业务/ 使用/ 带宽/ ,/ 才/ 造成/ 迭代/ 时间/ 略高于/ 无/ 带宽/ 分配/ 算法/ ,/ 迭代/ 发送/ 过程/ 虚拟机/ 处于/ 运行/ 状态/ ,/ 加之/ 业务/ 预留/ 带宽/ 的/ 存在/ ,/ 因此/ 不会/ 对/ 业务/ 性能/ 有过/ 大/ 的/ 影响/ ./ SPECweb/ 环境/ 下/ 的/ 测试/ 结果/ 如图/ 2/ (/ c/ )/ 和/ (/ d/ )/ 所示/ ./ 在/ 图/ 2/ (/ c/ )/ 中/ ,/ 柱形/ 框/ 表示/ 不同/ 迁移/ 算法/ 时/ 的/ 宕机/ 时间/ ,/ 折线/ 表示/ 了/ 不同/ 迁移/ 算法/ 时/ 的/ 设备/ 传输/ 图/ 2/ 迁移/ 性能/ 测试/ 与/ 分析/ 4.4/ 业务/ 服务质量/ 测试/ 与/ 分析/ 随后/ ,/ 我们/ 测试/ 了/ 不同/ 环境/ 下/ 虚拟机/ 动态/ 迁移/ 的/ 内存/ 发送/ 速率/ 以及/ 对/ 运行/ 业务/ 的/ 服务质量/ 的/ 影响/ ,/ 其中/ 运行/ 业务/ 的/ 服务质量/ 是/ 由/ 测试/ 使用/ 的/ Benchmark/ 自动/ 统计/ 生成/ ./ TPC/ -/ W/ 环境/ 下/ 的/ 测试/ 结果/ 如图/ 3/ (/ a/ )/ 和/ (/ b/ )/ 所示/ ./ 从图/ 3/ (/ a/ )/ 可以/ 看出/ ABA/ 算法/ 在/ 发送/ 速率/ 方面/ 总是/ 低于/ Xen/ 自有/ 的/ 两种/ 算法/ ,/ 在/ 无/ 带宽/ 控制/ 时脏页/ 率/ 与/ 带宽/ 发送/ 时间/ 无/ 明显/ 规律/ ;/ 增量/ 带宽/ 分配/ 时/ ,/ 随着/ 脏页/ 率/ 的/ 增加/ 发送/ 速率/ 也/ 呈上升/ 趋势/ ,/ ABA/ 算法/ 中/ ,/ 发送/ 速率/ 会/ 随脏页/ 率/ 的/ 变化/ 而/ 动态/ 调整/ 并/ 为/ 业务/ 预留/ 部分/ 带宽/ ./ 在/ 图/ 3/ (/ b/ )/ 中/ ,/ 基准/ QoS/ 表示/ 系统/ 自动/ 计算/ 的/ 理论/ 业务/ 服务质量/ 参考值/ ,/ 在/ 不同/ 业务量/ 下/ ,/ 实际/ 业务/ 服务质量/ 越/ 接近/ 该值/ 说明/ 其/ 服务质量/ 越/ 好/ ,/ 实验/ 结果表明/ 使用/ ABA/ 算法/ 迁移/ 时/ ,/ 业务/ 的/ 服务质量/ 总是/ 优于/ Xen/ 自有/ 的/ 两种/ 方法/ ,/ 这/ 说明/ 在/ ABA/ 算法/ 中/ 预留/ 时间/ ./ 从图/ 2/ (/ c/ )/ 中/ 可以/ 看出/ 对于/ 内存/ 密集型/ 业务/ 来说/ 3/ 种/ 算法/ 在/ 宕机/ 时间/ 上/ 的/ 差别/ 很小/ ,/ 但/ ABA/ 算法/ 可以/ 减少/ 设备/ 传输/ 时间/ ./ 整体/ 波动/ 较为/ 平缓/ ./ 在/ 图/ 2/ (/ d/ )/ 中/ 的/ 显示/ 可知/ ,/ ABA/ 算法/ 的/ 迭代/ 时间/ 和/ 迁移/ 总/ 时间/ 还是/ 优于/ 增量/ 带宽/ 分配/ 算法/ ,/ 由于/ 预留/ 业务/ 使用/ 带宽/ 的/ 原因/ ,/ 迭代/ 时间/ 和/ 迁移/ 总/ 时间/ 略高于/ 无/ 带宽/ 分配/ 算法/ ./ 业务/ 带宽/ 提高/ 了/ 迁移/ 过程/ 中/ 的/ 业务/ 服务质量/ ./ 结合/ 图/ 2/ (/ a/ )/ 、/ (/ b/ )/ 与/ 图/ 3/ (/ a/ )/ 、/ (/ b/ )/ 可以/ 得出/ 在/ 网络/ 密集型/ 业务/ 环境/ 中/ ABA/ 算法/ 在/ 迁移/ 过程/ 中/ 预留/ 了/ 网络带宽/ ,/ 使/ 迭代/ 发送/ 时间/ 和/ 迭代/ 总/ 时间/ 略高于/ 无/ 带宽/ 分配/ 算法/ ,/ 但/ 其/ 宕机/ 时间/ 最短/ 以及/ 业务/ 服务质量/ 最优/ ./ SPECweb/ 环境/ 下/ 的/ 测试/ 结果/ 如图/ 3/ (/ c/ )/ 和/ (/ d/ )/ 所示/ ./ SPECweb/ 属于/ I/ // O/ 密集型/ 业务/ ,/ 对/ 内存/ 使用/ 较为/ 频繁/ ,/ 单位/ 时间/ 内/ 产生/ 的/ 脏页/ 较/ 多/ ,/ 从图/ 3/ (/ c/ )/ 所示/ 可知/ ,/ ABA/ 算法/ 根据/ 脏页/ 率/ 判断/ 出/ 业务/ 需求/ 带宽/ 量/ 较大/ ,/ 为了/ 保证/ 服务质量/ ,/ 在/ 带宽/ 分配/ 时/ 业务/ 预留/ 带宽/ 占/ 的/ 比重/ 较大/ ,/ 因此/ 发送/ 使用/ 带宽/ 量/ 较/ 小/ ,/ 最终/ 造成/ 宕机/ 时间/ 和/ 迁移/ 时间/ 有所增加/ ,/ 这/ 与/ 上节/ 的/ 分析/ 结果/ 吻合/ ./ 本文/ 按/ 算法/ 类型/ 分类/ ,/ 将/ 不同/ 业务量/ 下/ 成功率/ 、/ 错误率/ 和/ 容忍/ 率取/ 平均值/ 后/ 进行/ 统计/ ,/ 如图/ 3/ (/ d/ )/ 所示/ ./ 使用/ ABA/ 算法/ 迁移/ 时/ ,/ Page8/ 图/ 3/ 业务/ 服务质量/ 测试/ 与/ 分析/ 业务/ 服务/ 的/ 成功率/ 在/ 99/ %/ 以上/ ,/ 比/ 使用/ Xen/ 自有/ 方法/ 提高/ 了/ 2/ %/ 左右/ ;/ 在/ 容忍度/ 方面/ 达到/ 了/ 99.96/ %/ ,/ 业务/ 请求/ 基本上/ 能/ 全都/ 得到/ 响应/ ./ 从/ 错误率/ 的/ 角度/ 来看/ ,/ ABA/ 算法/ 在/ 0.05/ %/ 以下/ ,/ 分别/ 比/ 无/ 带宽/ 算法/ 和/ 增量/ 带宽/ 算法/ 降低/ 了/ 20/ %/ 和/ 10/ %/ 左右/ ./ 因此/ ,/ 可以/ 看出/ ABA/ 算法/ 在/ 迁移/ 过程/ 中/ 确保/ 业务/ 服务质量/ ./ 5/ 总结/ 与/ 展望/ 虚拟化/ 技术/ 能够/ 在/ 云/ 计算/ 平台/ 中/ 创建/ 多个/ 虚拟机/ 作为/ 虚拟/ 操作/ 平台/ ,/ 满足/ 多用户/ 共享/ 隔离/ 执行/ 环境/ 的/ 需求/ ,/ 并/ 通过/ 虚拟机/ 迁移/ 技术/ 灵活/ 和/ 动态/ 地/ 管理/ 物理/ 资源/ ,/ 实现/ 高效/ 绿色/ 资源管理/ ./ 在/ 实际/ 应用/ 过程/ 中/ ,/ 不同/ 业务/ 特性/ 等/ 因素/ 对/ 虚拟机/ 迁移/ 效率/ 有/ 很大/ 影响/ ,/ 虚拟机/ 动态/ 迁移/ 过程/ 需要/ 传输/ 大量/ 内存/ 页面/ ,/ 造成/ 动态/ 迁移/ 与/ 应用程序/ 性能/ 下降/ ./ 为/ 解决/ 这一/ 问题/ ,/ 本文/ 提出/ 一种/ 面向/ 业务/ 特征/ 的/ 虚拟机/ 动态/ 迁移/ 带宽/ 分配/ 算法/ ,/ 通过/ 实时/ 分析/ 运行/ 业务/ 的/ 特征/ ,/ 利用/ 迁移/ 迭代/ 过程/ 中/ 内存/ 脏页/ 率/ 和/ 带宽/ 调整/ 系数/ ,/ 预测/ 下/ 一/ 时刻/ 运行/ 业务/ 对/ 物理/ 网络带宽/ 的/ 使用量/ ,/ 从而/ 自/ 适应/ 分配/ 虚拟机/ 动态/ 迁移/ 使用/ 的/ 物理/ 带宽/ ,/ 减少/ 了/ 迭代/ 时间/ 和/ 宕机/ 时间/ ./ 实验/ 结果表明/ ,/ 本/ 算法/ 能够/ 在/ 物理/ 带宽/ 资源/ 有限/ 的/ 前提/ 下/ ,/ 合理/ 利用/ 空闲/ 物理/ 带宽/ 资源/ ,/ 减少/ 虚拟机/ 迭代/ 时间/ 和/ 宕机/ 时间/ ,/ 提高/ 虚拟机/ 迁移/ 性能/ 和/ 业务/ 服务质量/ ./ 未来/ 工作/ 将/ 针对/ 复杂/ 网络/ 环境/ 的/ 迁移/ 带宽/ 分配/ 优化/ ,/ 解决/ 多层次/ 复杂/ 异构/ 网络/ 环境/ 中/ 虚拟机/ 动态/ 迁移/ 的/ 通用性/ 与/ 适应性/ ;/ 增加/ 相关/ 约束条件/ ,/ 更/ 精确/ 地/ 分配/ 虚拟机/ 动态/ 迁移/ 过程/ 中/ 的/ 使用/ 带宽/ ,/ 以/ 提高/ 虚拟机/ 迁移/ 性能/ 和/ 业务/ 服务质量/ ./ 致谢/ 感谢/ 中国科学院计算技术研究所/ 计算机/ 体系结构/ 国家/ 重点/ 实验室/ 孙毓忠/ 教授/ 和/ 山东大学/ 计算机科学/ 与/ 技术/ 学院/ 系统安全/ 与/ 隐私/ 保护/ 实验室/ 季/ 大祥/ 同学/ 对/ 本文/ 的/ 建议/ 和/ 帮助/ !/ 

