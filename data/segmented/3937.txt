Page1/ 面向/ 驱动/ 配置/ 的/ 自动/ 日志/ 插入方法/ 研究/ 刘虎球/ 1/ )/ 马超/ 1/ )/ 白家/ 驹/ 2/ )/ 1/ )/ (/ 清华大学/ 计算机科学/ 与/ 技术/ 系/ 北京/ 100084/ )/ 2/ )/ (/ 西安电子科技大学/ 计算机/ 学院/ 西安/ 710126/ )/ 摘要/ 驱动/ 的/ 可靠/ 运行/ 对于/ 操作系统/ 至关重要/ ,/ 驱动/ 的/ 长久/ 稳定/ 运行/ 依赖于/ 正确/ 的/ 驱动/ 配置/ ./ 由于/ 硬件/ 本身/ 存在/ 大量/ 约束条件/ ,/ 对系统/ 进行/ 修改/ ,/ 或者/ 对/ 驱动/ 、/ 内核/ 升级/ ,/ 或者/ 对/ 设备/ 更新换代/ 时/ 容易/ 发生/ 驱动/ 配置/ 错误/ ,/ 而/ 该类/ 错误/ 尚/ 无法/ 通过/ 现有/ 的/ 方法/ 直接/ 进行/ 定位/ 和/ 解决/ ./ 文中/ 设计/ 并/ 实现/ 了/ AiLsDc/ (/ AutomaticallyinsertingLogsystemforDriverconfiguration/ )/ 自动/ 日志/ 插入/ 辅助/ 检错/ 系统/ ,/ 能够/ 根据/ 参数/ 配置/ 规范/ 文档/ 中/ 的/ 规则/ 进行/ 驱动/ 配置/ 检查/ ./ AiLsDc/ 首先/ 按照/ 定义/ 的/ 驱动/ 配置/ 规范/ 规格/ XML/ 文档/ 对/ 驱动/ 源码/ 进行/ 插装/ 和/ 修改/ ,/ 运行/ 时/ 动态/ 检查/ 驱动/ 的/ 配置/ 是否/ 满足/ 配置/ 规范/ 文档/ 的/ 要求/ ./ 当/ 出现/ 参数/ 违例/ 时/ ,/ 日志/ 记录/ 模块/ 将会/ 自动记录/ 可能/ 引起/ 该/ 违例/ 的/ 错误/ 原因/ 和/ 错误/ 位置/ ./ 通过/ 对比/ 和/ 检查/ 日志/ ,/ 能够/ 在/ 出错/ 时/ 快速/ 定位/ 从而/ 辅助/ 纠错/ ,/ 提高/ 开发/ 效率/ ./ 实用性/ 评测/ 表明/ ,/ 系统/ 能够/ 捕获/ 配置/ 异常/ ,/ 而/ 性能/ 评测/ 结果表明/ ,/ AiLsDc/ 系统/ 在/ 提高/ 驱动/ 的/ 可靠性/ 的/ 同时/ ,/ 带来/ 的/ 开销/ 很小/ ./ 关键词/ 操作系统/ ;/ 可靠性/ ;/ 驱动/ 配置/ 错误/ 检查/ ;/ 日志/ 注入/ 1/ 引言/ 在/ 当前/ 的/ 通用/ 操作系统/ 中/ ,/ 驱动/ 常常/ 以/ 模块/ 的/ 形式/ 加载/ 到/ 内核/ 中/ 运行/ ,/ 并且/ 代码/ 量/ 大/ ./ 在/ Linux/ 中/ ,/ 驱动/ 占据/ 了/ 操作系统/ 70/ %/ 的/ 代码/ ./ 然而/ ,/ 该/ 部分/ 代码/ 所/ 含/ 错误/ 是/ 内核/ 的/ 3/ ~/ 7/ 倍/ [/ 1/ ]/ ,/ 在/ Windows/ 中/ ,/ 85/ %/ 的/ 系统/ 崩溃/ 和/ 驱动/ 的/ 错误/ 相关/ [/ 2/ ]/ ,/ 因而/ 驱动/ 的/ 可靠性/ 对系统/ 至关重要/ [/ 3/ ]/ ./ 统计/ 表明/ ,/ 在/ 驱动/ 代码/ 中/ ,/ 驱动/ 配置/ 相关/ 代码/ 占据/ 了/ 字符/ 驱动/ 51/ %/ 代码/ ,/ 配置/ 的/ 正确性/ 直接/ 决定/ 设备/ 能否/ 正常/ 工作/ ,/ 研究/ 驱动/ 的/ 正确/ 配置/ 对/ 提高/ 驱动/ 可靠性/ 具有/ 重要/ 意义/ ./ 由于/ 设备/ 驱动/ 的/ 开发/ 常常/ 和/ 系统/ 开发/ 是/ 分离/ 的/ ,/ 因此/ 内核/ 扩展/ 功能/ 发生/ 的/ 细微/ 改变/ 都/ 可能/ 引起/ 驱动/ 出现/ 不/ 稳定/ 现象/ ./ 另外/ ,/ 许多/ 驱动/ 开发者/ 违反/ 内核/ 扩展/ 使用/ 规范/ ,/ 当/ 操作系统/ 配置/ 发生/ 改变/ 时/ ,/ 该种/ 违例/ 将/ 无法/ 提供/ 正确/ 的/ 服务/ 给/ 驱动程序/ ,/ 引起/ 设备/ 不/ 稳定/ 工作/ ,/ 甚至/ 崩溃/ ./ 寄存器/ 接口/ 配置/ 规范/ 是/ 驱动/ 配置/ 的/ 关键/ 组成部分/ ,/ 设备/ 对系统/ 的/ DMA/ 地址/ 等/ 配置/ 参数/ 存在/ 严格/ 约束/ ./ 以/ USB/ 主机/ 控制器/ 中/ 的/ 帧/ 基址/ 寄存器/ 为例/ ①/ ,/ 图/ 1/ 中/ 描述/ 的/ 即/ 为/ UHCI/ (/ UniversalHostControllerInterface/ )/ 主机/ 控制器/ (/ HCD/ )/ 驱动/ 的/ 帧/ 基址/ 寄存器/ (/ frame/ _/ dma/ _/ handle/ )/ 的/ 数据结构/ ./ 1.2/ ./ 3.4/ ./ 5/ ./ frame/ _/ dma/ _/ handle/ 的/ 值/ 即/ 为/ 帧/ 基址/ 的/ DMA/ 地址/ 参数/ ,/ 需要/ 写入/ UHCI/ 控制器/ 的/ 帧/ 基址/ 寄存器/ ,/ 查看/ UHCI/ 设备/ 手册/ 得到/ 帧/ 基址/ 寄存器/ 的/ 相关/ 约束条件/ 如表/ 1/ 所示/ ./ 表项/ 名称/ FLBASEADD/ 地址/ 基/ 地址/ +/ (/ 08/ -/ 0B/ )/ H/ 属性/ 可读/ 可/ 写/ 宽度/ 32bitUHCI/ 硬件/ 手册/ [/ UHCIrevision1/ ./ 1section2/ ./ 1.5/ ]/ 指出/ 帧/ 基址/ 寄存器/ 要求/ 低/ 12/ 位/ 对齐/ ,/ 在/ 实际/ 写入/ 时/ 必须/ 保证/ 低/ 12/ 位为/ 0/ ,/ 即/ 大小/ 为/ 4KB/ ./ 驱动/ 开发者/ 在/ 此处/ 使用/ 内核/ 扩展/ 的/ 内存/ 管理/ 接口/ 时/ ,/ 应/ 注意/ 使用/ alloc/ _/ page/ 或/ alloc/ _/ pages/ 扩展/ ,/ 如果/ 使用/ kmalloc/ ,/ 则/ 在/ 内存/ 调试/ 开启/ 尾/ 对齐/ 时/ 可能/ 引发/ 错误/ ,/ 使得/ 设备/ 不能/ 正常/ 工作/ ./ 另外/ ,/ 在/ USB/ 的/ UHCI/ 驱动/ ,/ TD/ (/ TransactionDescriptor/ )/ 和/ QH/ (/ QueueHeader/ )/ 的/ 缓冲区/ 则/ 要求/ 16/ 字节/ 对齐/ ./ 根据/ 设备/ 手册/ 要求/ ,/ 填入/ 设备/ 的/ DMA/ 地址/ 必须/ 是/ 物理/ 内存地址/ ,/ 不能/ 使用/ 内核/ 的/ 线性/ 地址/ ./ 但是/ 在/ 部分/ 系统/ 实现/ 机制/ 中/ ,/ 内核/ 的/ 1GHz/ 以内/ 线性/ 地址/ 和/ 物理地址/ 一致/ ,/ 因此/ 当/ 页表/ 扩充/ 或/ 配置/ 表/ 发生/ 改变/ 时/ ,/ 没有/ 转换/ 的/ 线性/ 内存地址/ 直接/ 填入/ DMA/ 将/ 可能/ 引起/ 系统/ 崩溃/ ./ 同时/ ,/ 程序员/ 对/ 自己/ 的/ 程序/ 常常/ 足够/ 自信/ ,/ 测试/ 周期/ 较/ 短/ ./ 而/ 设备/ 驱动/ 的/ 功能/ 和/ 正确性/ 测试/ 常常/ 依赖于/ 具体/ 的/ 硬件/ ,/ 测试/ 场景/ 偏少/ ,/ 通常/ 仅仅/ 关心/ 驱动/ 功能/ 实现/ ,/ 因而/ 没有/ 过多/ 考虑/ 系统/ 环境/ 配置/ 等/ 相关/ 的/ 功能测试/ ./ 除了/ 系统/ 环境/ 方面/ 以外/ ,/ 还/ 存在/ 大量/ 的/ 设备/ 相关/ 的/ 潜在/ 约束/ ,/ 驱动/ 配置/ 都/ 需要/ 考虑/ ./ 在/ 数组/ 的/ 使用/ 和/ 配置/ 上/ ,/ 同样/ 存在/ 大量/ 的/ 隐形/ 约束/ ./ 例如/ USB/ 设备/ 的/ 语言/ ID/ (/ LANGID/ )/ 数组/ 要求/ 非/ NULL/ 结束/ ,/ 是/ 以/ UNICODE/ 编码/ ,/ 因此/ 一个/ 大小/ 为/ N/ 个/ 字节/ 的/ 数组/ 实际/ 只能/ 存储/ N/ -/ 2/ 个/ 字节/ ./ 在/ PCI/ 的/ 设备/ 手册/ 中/ ②/ ,/ 还/ 列出/ 了/ 大量/ 空间/ 范围/ 约束/ ,/ 如/ 在/ PCI/ 配置/ 地址/ 空间/ 中/ ,/ 对/ 寄存器/ 的/ 配置/ 空间/ 存在/ 隐性/ 地址/ 约束/ ,/ PCI/ 内存/ 映射/ 地址/ 的/ 物理/ 对齐/ ,/ 寄存器/ 地址/ 的/ OFFSET/ 在/ BASE/ 的/ 基础/ 上/ 不能/ 超过/ 256/ 个/ 字节/ ./ 在/ 本文/ 中/ ,/ 作者/ 把/ 一些/ 由于/ 设备/ 交互/ 参数/ 不/ 规范/ 或者/ 设备/ 返回值/ 引起/ 的/ 差错/ 以及/ 上述/ 提到/ 的/ 错误/ 等/ 统一/ 归纳/ 为/ 驱动/ 配置/ 错误/ ./ 由于/ 配置/ 常常/ 与/ 语义/ 相关/ ,/ 研究/ 难度/ 大/ ,/ 当前/ 很少/ 有/ 研究者/ 针对/ 驱动/ 相关/ 的/ 配置/ 进行/ 研究/ ./ Kadav/ 和/ Swift/ [/ 4/ ]/ 指出/ ,/ 以往/ 的/ 驱动/ 可靠性/ 研究/ 中/ 人们/ 常常/ 关注/ 声卡/ 、/ 存储/ 、/ 网络设备/ 的/ 驱动/ 代码/ 错误/ 检查/ ,/ 而/ 大量/ 的/ 驱动/ 配置/ 中/ 的/ 错误/ 没有/ 得到/ 重视/ ./ 并且/ 这些/ 配置/ 相关/ 的/ 错误/ 常常/ 引起/ 设备/ 出现异常/ 并且/ 难以/ 定位/ ,/ 该类/ 错误/ 并/ 不能/ 通过/ ShadowDriver/ [/ 5/ ]/ 等/ 技术/ 予以/ 解决/ ./ 在/ 以往/ 的/ 驱动/ 可靠性/ 研究/ 中/ ,/ 人们/ 常常/ 通过/ 快速/ 重启/ 设备/ 等/ 方法/ 对/ 驱动/ 进行/ 错误/ 隔离/ 与/ 恢复/ ,/ 或者/ 通过/ 静态/ 分析/ 的/ 方法/ 对/ 驱动/ 错误/ 进行/ 检查/ ./ 但是/ ,/ ①/ ②/ Page3/ 这些/ 方法/ 均/ 无法/ 直接/ 解决/ 配置/ 相关/ 的/ 驱动/ 错误/ ./ 而且/ 配置/ 错误/ 一旦/ 发生/ ,/ 将/ 对/ 设备/ 的/ 正确/ 运行/ 产生/ 致命/ 影响/ ./ 比较/ 常见/ 的/ 错误/ 如/ 打印机/ 错误/ ,/ UHCI/ 、/ EHCI/ (/ EnhancedHostControllerInterface/ )/ 异常/ 反复/ 重启/ 等/ ./ 驱动/ 配置/ 与/ 语义/ 存在/ 一定/ 关系/ ,/ 因此/ 仅/ 从/ 源码/ 上/ 检查/ 是/ 不够/ 的/ ./ 本文/ 设计/ 的/ 驱动/ 配置/ 检查/ 一方面/ 依赖于/ 驱动/ 源码/ 本身/ 的/ 编程/ 规范/ ,/ 另一方面/ 还/ 依赖于/ 驱动/ 的/ 配置/ 规格/ 文件/ ./ 在/ 源码/ 中/ 可以/ 利用/ 变量名/ 和/ 注释/ 等/ 语义/ 信息提取/ 配置/ 的/ 正确性/ 要求/ ,/ 而/ 配置/ 规格/ 文档/ 部分/ 可以/ 通过/ 在/ 设备/ 正确/ 运行/ 时/ 辅助/ 生成/ ,/ 也/ 可以/ 通过/ 设备/ 手册/ 生成/ ./ 驱动/ 配置/ 错误/ 常常/ 发生/ 在/ 系统管理员/ 对系统/ 进行/ 修改/ ,/ 或者/ 对/ 驱动/ 、/ 内核/ 升级/ ,/ 或者/ 设备/ 更新换代/ 时/ ./ 由于/ 该类/ 错误/ 不能/ 通过/ 重启/ 等/ 方法/ 解决/ ,/ 因此/ 必须/ 依赖于/ 一些/ 调试/ 方法/ 进行/ 快速/ 定位/ ./ 在/ 此/ 情形/ 下/ ,/ 日志/ 是/ 一种/ 有效/ 的/ 调试/ 和/ 错误诊断/ 方案/ ,/ 通过/ 查看/ 和/ 对比/ 日志/ 信息/ 能够/ 快速/ 定位/ 到/ 由/ 硬件/ 或/ 系统/ 环境/ 变化/ 引起/ 的/ 驱动/ 错误/ 位置/ ./ 本文/ 旨在/ 设计/ 一个/ 驱动/ 配置/ 的/ 正确性/ 检查/ 模型/ ,/ 并/ 在/ 模型/ 基础/ 上/ 实现/ 自动/ 日志/ 插入/ 辅助/ 检错/ 系统/ (/ AiLsDc/ )/ ./ 系统/ 按照/ 配置/ 规格/ 文档/ ,/ 对/ 配置/ 的/ 参数/ 进行/ 检查/ ,/ 通过/ 在/ 可能/ 出错/ 的/ 部位/ 插入/ 相关/ 的/ 日志/ ,/ 运行/ 时/ 动态/ 检查/ ,/ 出错/ 时/ 对比/ 和/ 检查/ 日志/ ,/ 使得/ 能够/ 快速/ 定位/ 错误/ 从而/ 辅助/ 检/ 纠错/ ,/ 进而/ 提高/ 系统/ 的/ 可靠性/ ./ 本文/ 首次/ 针对/ 驱动/ 配置/ 问题/ 提出/ 了/ 一种/ 可行/ 的/ 解决方案/ ,/ 在/ 提高/ 驱动/ 可靠性/ 的/ 同时/ ,/ 对系统/ 性能/ 等/ 的/ 副作用/ 影响/ 较/ 小/ ./ 本文/ 第/ 2/ 节/ 主要/ 介绍/ 当前/ 的/ 国内外/ 关于/ 驱动/ 可靠性/ 和/ 配置/ 相关/ 的/ 研究/ 现状/ ;/ 第/ 3/ 节/ 重点/ 介绍/ 针对/ 驱动/ 配置/ 问题/ 提出/ 的/ AiLsDc/ 模型/ ;/ 第/ 4/ 节/ 主要/ 介绍/ 根据/ AiLsDc/ 模型/ 实现/ 的/ AiLsDc/ 系统/ ,/ 就/ 系统结构/ 和/ 重点/ 功能模块/ 进行/ 详细/ 阐述/ ;/ 第/ 5/ 节/ 给出/ 系统/ 的/ 实用性/ 评测/ 结果/ ;/ 第/ 6/ 节/ 给出/ 系统/ 的/ 性能/ 评测/ 结果/ ;/ 第/ 7/ 节对/ 全文/ 进行/ 简要/ 总结/ ./ 2/ 相关/ 工作/ 驱动/ 的/ 错误/ 检查/ ,/ 主要/ 包括/ 静态/ 检查和/ 动态/ 检测/ 两大类/ ./ 其中/ 静态/ 检查/ 主要/ 包括/ Mondrix/ [/ 6/ ]/ 、/ SafeDrive/ [/ 7/ ]/ 、/ KINT/ [/ 8/ ]/ 、/ CFix/ [/ 9/ ]/ 、/ Dingo/ [/ 10/ -/ 11/ ]/ 、/ BGI/ [/ 12/ ]/ 等/ ./ 然而/ ,/ 已有/ 的/ 静态/ 检查/ 方法/ 无法/ 对/ 带有/ 特殊/ 语义/ 的/ 配置/ 参数/ 进行/ 解析/ ./ Dingo/ [/ 10/ ]/ 是/ 针对/ 文档/ 不/ 规范/ 和/ 语义/ 混淆/ 等/ 问题/ ,/ 提出/ 的/ 一种/ 基于/ 协议/ 状态/ 自动机/ 的/ 描述/ 设备/ 协议/ 的/ 语言/ Tingu/ ,/ 辅助/ 驱动/ 开发/ ./ 但是/ 该/ 方法/ 一方面/ 要求/ 驱动/ 全部/ 重写/ ,/ 工作量/ 巨大/ ,/ 直到/ Termite/ 出现/ 该/ 问题/ 才/ 得到/ 了/ 部分/ 缓解/ [/ 11/ ]/ ;/ 另一方面/ ,/ 仍/ 不能/ 解决/ 环境/ 发生变化/ 时/ 引起/ 的/ 驱动/ 配置/ 问题/ ./ CFix/ [/ 9/ ]/ 等/ 针对/ 的/ 是/ 具体/ 的/ 错误/ ,/ 如/ 并发/ 问题/ 的/ 解决/ ,/ 与/ 驱动/ 配置/ 相关/ 的/ 错误/ 相关性/ 更是/ 较/ 小/ ./ 在/ 动态/ 隔离/ 与/ 恢复/ 上/ ,/ 主要/ 有/ Swift/ 组/ 的/ Nooks/ [/ 13/ ]/ 等/ 一系列/ 研究成果/ ./ Nooks/ 通过/ 对/ Wrapper/ 等/ 接口/ 进行/ 检查/ 转换/ ,/ 并/ 通过/ 语言/ 的/ 安全/ 规范/ 、/ 虚拟内存/ 保护/ 、/ 降低/ 执行/ 权限/ 等/ 机制/ 实现/ 隔离/ 、/ 恢复/ 、/ 兼容/ 现有/ 系统/ 等/ 目标/ ./ 此/ 方法/ 通过/ 动态/ 隔离/ 与/ 检测/ 机制/ 有效/ 防止/ 了/ 系统/ 崩溃/ ,/ 但是/ 仍旧/ 不能/ 解决/ 因为/ 系统/ 环境/ 改变/ 或者/ 用户/ 输入/ 改变/ 而/ 引起/ 的/ 错误/ 定位/ 以及/ 错误/ 恢复/ 的/ 问题/ ./ ShadowDriver/ [/ 5/ ]/ 、/ FGFT/ [/ 14/ ]/ 等/ 方法/ 则/ 将/ 驱动/ 的/ 可靠性/ 研究/ 集中/ 在/ 驱动/ 的/ 错误/ 隔离/ 与/ 恢复/ 上/ ./ 该类/ 方案/ 旨在/ 解决/ 硬件/ 的/ 短暂性/ 错误/ 和/ 突发/ 错误/ ./ 其中/ ,/ ShadowDriver/ 主要/ 有/ active/ 和/ passive/ 两种/ 工作/ 模式/ ./ 在/ passive/ 工作/ 模式/ 中/ ,/ 主要/ 是/ 记录/ OS/ 为/ 驱动/ 提供/ 的/ 具体/ 数据/ 内容/ ,/ 当/ 偶发性/ 错误/ 发生/ 时/ ,/ 驱动/ 进入/ active/ 模式/ ,/ 重启/ 设备/ ,/ 利用/ passive/ 记录/ 的/ 数据/ 对/ 对/ 设备/ 进行/ 初始化/ ,/ 即可/ 使/ 设备/ 重新/ 正常/ 运行/ ./ 但是/ ,/ 配置/ 引发/ 的/ 错误/ 并/ 不/ 属于/ 短暂性/ 和/ 突发/ 错误/ 的/ 范畴/ ./ 该类/ 错误/ 一旦/ 发生/ ,/ 则/ 需要/ 对系统/ 环境/ 或者/ 驱动/ 本身/ 进行/ 修改/ 才能/ 解决/ ./ 另外/ 还有/ 一些/ 通过/ 用户/ 态/ 和/ 虚拟化/ 等/ 技术/ 实现/ 的/ Micro/ -/ Driver/ [/ 15/ ]/ 、/ XEN/ [/ 16/ ]/ 等/ 方法/ ./ 虚拟化/ 方法/ 能够/ 有效/ 防止/ 驱动/ 的/ 恶意/ 攻击/ ,/ 并且/ 驱动/ 崩溃/ 不会/ 对/ 宿主/ 系统/ 造成/ 致命/ 影响/ ./ 该/ 技术/ 能够/ 通过/ 快照/ 等/ 方法/ 对/ 环境/ 出现/ 的/ 问题/ 进行/ 回滚/ ,/ 但是/ 并/ 不能/ 有/ 针对性/ 地/ 定位/ 和/ 解决/ 这些/ 问题/ ./ 用户/ 态/ 驱动/ 则/ 主要/ 是/ 为了/ 方便/ 用户/ 调试/ ,/ 并且/ 从/ 安全/ 角度/ 来看/ ,/ 配置/ 错误/ 几乎/ 不/ 在/ 该类/ 驱动/ 的/ 涉及/ 范畴/ 之内/ ./ 已有/ 的/ 一些/ 配置/ 相关/ 的/ 工作/ [/ 17/ ]/ 主要/ 关心/ 的/ 是/ 驱动/ 的/ 灵活性/ 配置/ 和/ 加载/ 的/ 实现/ ,/ 甚至/ 更/ 多/ 关注/ 的/ 是/ 一个/ 具体/ 的/ 设备/ 驱动/ 配置/ ,/ 如/ 打印机/ 驱动/ 配置文件/ 的/ 更新/ [/ 18/ ]/ ./ IComment/ [/ 19/ ]/ 巧妙/ 地/ 通过/ 对/ 程序/ 的/ 注释/ 进行/ 学习/ ,/ 从/ 注释/ 中/ 提取/ 程序员/ 标注/ 的/ 隐含/ 信息/ ,/ 如/ 数据格式/ 和/ 数值/ 范围/ 等/ ,/ 进而/ 检查/ 注释/ 和/ 程序/ 自身/ 的/ 不一致性/ 问题/ ./ 该/ 方法/ 能够/ 检查/ 出/ 一些/ 程序/ 错误/ ,/ 但是/ 对/ 配置/ 错误/ 的/ 检查/ 并/ 不/ 普适/ ./ 事实上/ ,/ 由于/ 系统/ 环境/ 或者/ 内核/ 改变/ 而/ 引起/ 的/ Page4/ 驱动/ 配置/ 相关/ 的/ 错误/ ,/ 可以/ 通过/ 对/ 内核/ 扩展/ 的/ 使用/ 规范/ 来/ 进行/ 检查/ 并/ 辅助/ 解决/ ./ 但是/ 该类/ 错误/ 常常/ 存在/ 相关/ 的/ 语义/ 信息/ ,/ 如/ DMA/ 地址/ 的/ 对齐/ 问题/ ./ 程序/ 在/ 大多数/ 系统/ 上/ 可能/ 运行/ 正常/ ,/ 但是/ 当/ 系统/ 的/ 硬件/ 配置/ 出现/ 改变/ 或者/ 内核/ 扩展/ 使用/ 不/ 规范/ 时则/ 可能/ 带来/ 隐患/ 甚至/ 运行/ 错误/ ./ 在/ 理论/ 上/ ,/ 符号化/ 执行/ 技术/ 能够/ 从/ 一定/ 程度/ 上/ 解决/ 配置/ 错误/ 问题/ ./ 而/ 实际上/ ,/ 由于/ 配置/ 的/ 语义/ 正确性/ 在/ 符号化/ 执行/ 中/ 并/ 不/ 便于/ 定义/ ,/ 因此/ 符号化/ 执行/ 技术/ 一直/ 未能/ 用于/ 解决/ 该类/ 问题/ ./ SymDrive/ [/ 20/ ]/ 尽管/ 使用/ 了/ 符号化/ 执行/ 技术/ ,/ 但是/ 主要/ 是/ 为了/ 实现/ 在/ 没有/ 设备/ 的/ 情况/ 下/ ,/ 也/ 可以/ 对/ 设备/ 驱动/ 进行/ 符号化/ 测试/ ./ 因此/ ,/ 目前/ 很少/ 有/ 方法/ 能够/ 有效/ 地/ 解决/ 驱动/ 配置/ 问题/ ./ 驱动/ 配置/ 一方面/ 需要/ 依赖于/ 驱动/ 本身/ 的/ 语义/ 信息/ ,/ 该/ 信息/ 需要/ 从/ 设备/ 手册/ 或者/ 源码/ 的/ 有效/ 变量名/ 等/ 内容/ 上/ 获取/ ;/ 另一方面/ ,/ 还/ 需要/ 能够/ 在/ 出现/ 错误/ 时/ ,/ 及时发现/ 和/ 定位/ 错误/ ./ 本文/ 提出/ AiLsDc/ 系统对/ 设备/ 驱动/ 的/ 配置/ 进行/ 规范/ 处理/ ,/ 另外/ 还/ 设计/ 了/ 一种/ 通用/ 的/ 可/ 转换/ 的/ XML/ 格式/ 配置/ 规格/ 文档/ ,/ 用于/ 在/ 运行/ 时/ 对/ 配置/ 内容/ 进行/ 动态/ 检查/ ./ 该/ 系统对/ 一些/ 需要/ 约束/ 的/ 寄存器/ 值/ 以及/ 敏感/ 的/ 数据结构/ 的/ 参数/ 值域/ 进行/ 检查/ ,/ 阻止/ 驱动/ 使用/ 错误/ 的/ 配置/ 参数/ ,/ 及时发现/ 可能/ 的/ 错误/ 并/ 记录/ 相应/ 的/ 日志/ 信息/ ,/ 以便/ 于/ 程序员/ 快速/ 定位/ 错误/ 并/ 找到/ 错误/ 发生/ 的/ 原因/ ./ 3/ 驱动/ 配置/ 敏感/ 模型/ 驱动/ 的/ 配置/ 主要/ 针对/ 设备/ 的/ 寄存器/ 或者/ 总线/ 进行/ ,/ 如/ DMA/ 基址/ 寄存器/ 的/ 配置/ 、/ 打印机/ 属项/ 设置/ 等/ ./ 这种/ 配置/ 的/ 数据/ 常常/ 包含/ 相关/ 的/ 基址/ 、/ 掩码/ 、/ 长度/ 限制/ 及/ 可能/ 的/ 返回值/ 等/ ./ 因此/ 需要/ 设计/ 一种/ 通用/ 的/ 正确/ 的/ 参数/ 规格/ 规范/ 用于/ 对/ 驱动/ 进行/ 动态/ 的/ 配置/ 检查/ ./ 本节/ 的/ 3.1/ 节/ 给出/ 一种/ 规范/ 的/ 配置/ 文档/ 格式/ ,/ 3.2/ 节/ 给出/ 系统/ 依赖/ 的/ 检测/ 标记/ 插装/ 方法/ ,/ 3.3/ 节/ 给出/ AiLsDc/ 驱动/ 配置/ 模型/ ./ 3.1/ 参数/ 配置/ 规范/ 文档/ 的/ 规格/ 描述/ ,/ 具体/ 规范/ 如表/ 2/ ./ 为了/ 便于/ 扩展/ ,/ 使用/ XML/ 格式/ 进行/ 参数/ 配置/ 项目/ 文档/ 声明/ 〈/ ?/ xmlversion/ =/ "/ 1.0/ "/ encoding/ =/ "/ GB2312/ "/ ?/ 〉/ 注解/ 格式/ 〈/ !/ -/ thisisanotation/ !/ -/ -/ 〉/ 配置/ 内容/ 〈/ 标记/ 名/ 属性/ 名/ =/ "/ 属性/ 值/ "/ …/ 〉/ 以/ 文中/ 提到/ 的/ UHCI/ 帧/ 基址/ 寄存器/ 为例/ ,/ 基本/ 约束条件/ 为/ 低/ 12/ 位尾/ 对齐/ ,/ 转换/ 为/ XML/ 描述/ 则/ 如图/ 2/ 所示/ ./ 〈/ ?/ xmlversion/ =/ "/ 1.0/ "/ encoding/ =/ "/ GB2312/ "/ ?/ 〉/ 〈/ !/ -/ -/ USBFLBASEADDregister/ ,/ withlow12bitsreservedtozero/ !/ -/ -/ 〉/ 〈/ USBFLBASEADDaddress/ =/ "/ %/ UHCI/ _/ BAR/ _/ BASE/ %/ +/ 08H/ "/ ,/ type/ =/ "/ UINT/ _/ 32/ "/ ,/ kind/ =/ "/ W/ "/ ,/ mask/ =/ 00000FFF/ ,/ action/ =/ "/ log/ "/ 〉/ 在/ 图/ 2/ 中/ ,/ 标记/ 名为/ FLBASEADD/ ,/ 地址/ 约束/ 为/ 相应/ 的/ 寄存器/ 地址/ ./ 需要/ 注意/ 的/ 是/ ,/ %/ UHCI/ _/ BAR/ _/ -/ BASE/ %/ 表示/ 该值/ 由/ 系统/ 决定/ ,/ 属于/ 变量/ ,/ 实际上/ 该/ 变量/ 即为/ PCI/ 配置/ 空间/ 的/ BAR/ 基址/ ./ type/ 定义/ 了/ 该/ 标记/ 名/ 的/ 数据类型/ ,/ UINT/ _/ 32/ 表示/ 无/ 符号/ 32/ 位数/ ,/ 而/ kind/ 则/ 表示/ 输入输出/ 的/ 方向/ ,/ mask/ 表示/ 低位/ 无效/ ,/ 并/ 执行/ 强制/ 检查/ ./ 属性/ 的/ 值域/ 具体/ 含有/ 的/ 类型/ 和/ 属/ 项则/ 如表/ 3/ 所示/ ,/ 表项/ 允许/ 缺省/ ./ 表项/ address/ 寄存器/ 地址/ typekindmask/ 数值/ 大小/ 与/ type/ 一致/ ,/ 对应/ 位为/ 1/ 表示/ 改位/ 数值/ 有/ length/ 字符串/ 长度/ 域/ ,/ type/ 域/ 长度/ 等/ ret/ -/ -/ 缺省/ 不/ 检查/ ;/ 0/ 非负值/ 检查/ action/ 可能/ 违例/ 时/ 执行/ 动作/ ,/ 默认/ 为/ 日志/ 具体/ 的/ 语义/ 信息/ 规范/ 依赖于/ 具体/ 的/ 设备/ 文档/ 或者/ 源码/ 中/ 蕴含/ 的/ 规格/ 说明/ ./ 在/ 程序/ 编码/ 中/ ,/ 程序员/ 总是/ 会/ 利用/ 特殊/ 的/ 类型/ 或/ 特殊/ 的/ 变量名/ 来/ 表示/ 特定/ 的/ 语义/ 信息/ ./ 因此/ 本文/ 欲/ 采用/ 源码/ 的/ 变量/ 分析方法/ 来/ 提取/ 部分/ 配置/ 规格/ 描述/ XML/ 标签/ 内容/ ,/ 同时/ 结合/ 注释/ 加以/ 修正/ ,/ 对于/ 不能/ 利用/ 该种/ 方式/ 规范/ 的/ 参数/ 配置/ 则/ 从/ 设备/ 手册/ 中/ 提取/ ./ 3.2/ 配置/ 检测/ 标记/ 随着/ 计算机设备/ 的/ 极大丰富/ ,/ 驱动/ 更是/ 显得/ 复杂多变/ ,/ 一个/ 设备/ 可能/ 同时/ 存在/ 多个/ 驱动/ ,/ 而/ 一个/ 驱动/ 同样/ 也/ 可能/ 兼容/ 多款/ 设备/ ./ 兼容性/ 的/ 出现/ 减少/ 了/ 驱动/ 开发/ 的/ 工作量/ ,/ 但/ 由于/ 测试/ 较少/ 和/ 协议/ 兼容问题/ ,/ 同样/ 也/ 带来/ 了/ 可靠性/ 隐患/ ./ 在/ 3.1/ 节中/ 已经/ 定义/ 了/ 配置/ 可以/ 检查/ 使用/ 的/ 规范/ 文档/ 格式/ ,/ 但是/ 如何/ 生成/ 该类/ 文档/ 则/ 成/ 了/ 首要/ 的/ Page5/ 问题/ ./ 设定/ 配置/ 检查/ 规则/ 可/ 辅助/ 生成/ 参数/ 规范/ 规格/ 配置文件/ ./ 在/ 驱动/ 中/ ,/ 存在/ 大量/ 需要/ 规范/ 的/ 配置/ 参数/ ,/ 该类/ 参数/ 包括/ 配置/ 的/ 返回/ 结果/ ./ 例如/ ,/ 当/ 驱动/ 设备/ 相关/ 的/ 输入/ 函数/ 的/ 返回值/ 为/ 负时/ ,/ 会/ 自动/ 插入/ 日志/ 信息/ ;/ 对/ 中断/ 处理函数/ 进行/ 检测/ ,/ 检测/ 是否/ 出现/ 中断/ 风暴/ 或者/ 中断/ 丢失/ ;/ 在/ DMA/ 地址/ 中/ 根据/ SIZE/ 进行/ 尾/ 对齐/ 检查/ ;/ 以及/ 定时器/ 、/ 设备/ 文件/ 、/ 锁/ 等/ 规范/ 检查/ ,/ 以/ 提高/ 驱动/ 的/ 可靠性/ ./ 以/ 配置/ 相关/ 函数/ 返回值/ 为/ 负值/ 或/ void/ / 返回/ NULL/ 时/ 执行/ 日志/ 的/ 自动/ 插入/ 为例/ ,/ 首先/ 需要/ 自动/ 定位/ 驱动/ 调用/ 的/ 可疑/ 关键/ 函数/ 的/ 返回/ 位置/ 的/ 关键/ 函数/ ,/ 插装/ 检测/ 标记/ ,/ 供/ 动态/ 运行/ 时/ 使用/ ./ 当/ 驱动/ 运行/ 时/ 发现/ 驱动/ 的/ 参数/ 或/ 返回值/ 不/ 符合/ 参数/ 配置/ 规范/ 中/ 的/ 描述/ 时/ ,/ 则/ 将/ 该处/ 的/ 返回值/ 和/ 文件/ 位置/ 等/ 有效/ 信息/ 作为/ 日志/ 予以/ 记录/ ./ 如/ DMA/ 地址/ 分配/ 函数/ dma/ _/ alloc/ 失败/ 时会/ 返回/ NULL/ ,/ 通过/ 在/ 驱动程序/ 中/ 定位/ dma/ _/ alloc/ ,/ 并/ 插入/ 检测/ 标记/ ,/ 检查/ 返回值/ 是否/ 非空/ ,/ 为/ 空时/ 则/ 插入/ 日志/ 记录/ ./ 同样/ ,/ Linux/ 的/ 驱动/ 和/ 内核/ 代码/ 质量/ 虽然/ 良莠不齐/ ,/ 但是/ 编程/ 规范/ 上/ 依旧/ 存在/ 较/ 多/ 可取之处/ ,/ 例如/ 变量名/ 中/ 可以/ 提取/ 出/ 大量/ 语义/ 信息/ ./ IComment/ 利用/ 程序/ 中/ 的/ 注释/ 信息/ ,/ 通过/ 自然语言/ 处理/ 模型/ 分析/ 其中/ 源码/ 和/ 注释/ 不/ 一致/ 时/ 的/ 信息/ ./ 从/ 变量名/ 中/ 提取/ 语义/ 信息/ 则/ 相对/ 更为/ 规范/ 和/ 有效/ ,/ 并且/ 辅助/ 进行/ 类型/ 检查/ ,/ 提取/ 的/ 语义/ 信息/ 可以/ 用于/ 生成/ 配置/ 规范/ XML/ 文档/ ,/ 并/ 对/ 该/ 变量/ 插入/ 检测/ 标记/ ,/ 运行/ 时/ 根据/ 检测/ 标记/ 对/ 该/ 变量/ 进行/ 跟踪/ 分析/ ,/ 出现异常/ 时/ 执行/ 定义/ 的/ action/ 操作/ ./ 3.3/ AiLsDc/ 模型/ AiLsDc/ 模型/ 由/ 系统/ 状态/ 、/ 符号/ 集/ 、/ XML/ 规范/ 集/ 、/ 初始状态/ 、/ 结束/ 状态/ 、/ 操作/ 集/ 、/ 转换/ 函数/ 构成/ ,/ 下面/ 将/ 分别/ 进行/ 描述/ ./ 系统/ 状态/ :/ 模型/ 在/ 针对/ 不同/ 符号/ 输入/ 转移/ 到/ 的/ 可能/ 的/ 一种/ 执行/ 状态/ ,/ 使用/ 符号/ q/ 表示/ ,/ 状态/ 的/ 集合/ 使用/ Q/ 表示/ ./ 符号/ 集/ :/ 模型/ 接受/ 的/ 输入/ 符号/ 集合/ ,/ 针对/ 一个/ XML/ 规格/ 的/ 规范/ 文档/ 可以/ 提取/ 出/ 的/ 具体/ 符号/ 作为/ 模型/ 的/ 输入/ ,/ 具体/ 的/ 一个/ 符号/ 使用/ s/ 表示/ ,/ 而/ 符号/ 的/ 集合/ 使用/ S/ 集合/ 表示/ ./ 其中/ 每个/ 输入/ 符号/ 一般/ 伴随/ 一些/ 访问/ 方式/ 存在/ ,/ 如读/ 、/ 写/ 、/ 执行/ 等/ ,/ 结合/ 具体/ 的/ 操作/ 可以/ 描述/ 为/ sops/ ./ XML/ 规范/ 集/ :/ 模型/ 对应/ 的/ 配置/ 规范/ 规则/ ,/ 每个/ 规范/ 分离/ 出/ 不同/ 规格/ 的/ 规范/ 符号/ 集/ ,/ 使用/ 符号/ R/ 表示/ ,/ 而/ 一个/ 配置/ 规范/ 规则/ r/ 包含/ 较/ 多/ 的/ 属性/ ,/ 针对/ 具体/ 的/ 属性/ 存在/ 不同/ 的/ 运算/ ,/ 使用/ 符号/ p/ (/ r/ )/ 来/ 表示/ ./ 初始状态/ :/ 模型/ 转换/ 的/ 初始状态/ ,/ 是/ Q/ 的/ 一个/ 特殊/ 元素/ ,/ 使用/ 符号/ q0/ 表示/ ./ 结束/ 状态/ :/ 模型/ 转换/ 的/ 结束/ 状态/ ,/ 同/ q0/ 一样/ 是/ Q/ 的/ 一个/ 特殊/ 状态/ ,/ 使用/ 符号/ qe/ 表示/ ./ 操作/ 集/ :/ 指针/ 模型/ 在/ 转移/ 到/ 不同/ 状态/ 时/ 可能/ 执行/ 的/ 一些/ 操作/ ,/ 使用/ 符号/ a/ 表示/ 一个/ 具体/ 的/ 操作/ ,/ 使用/ 符号/ A/ 来/ 表示/ 操作/ 的/ 集合/ ./ 转换/ 函数/ :/ 用于/ 描述/ 模型/ 的/ 状态/ 转移/ 变化/ ,/ 使用/ 符号/ f/ 表示/ ,/ 在/ 输入/ 集/ 的/ 作用/ 下/ 根据/ 规则/ 集/ 发生/ 不同/ 的/ 状态/ 转换/ ,/ 并/ 执行/ 不同/ 的/ 操作/ ,/ 转换/ 函数/ 的/ 集合/ 使用/ 符号/ F/ 来/ 表示/ ./ 转移/ 函数/ 的/ 输入输出/ 可以/ 形式化/ 描述/ 为/ 其中/ qn/ 为/ 模型/ 的/ 当前/ 状态/ ,/ 此时/ 遇到/ 符号/ sops/ ,/ 并/ 根据/ 定义/ 在/ 规则/ r/ 上/ 的/ p/ 运算/ 结果/ 为/ true/ 时/ 转移/ 到/ 状态/ qn/ +/ 1/ ,/ 并/ 执行/ 操作/ a/ ./ 综上/ ,/ 则/ AiLsDc/ 模型/ 可以/ 表示/ 为/ 七元/ 组/ :/ 通过/ AiLsDc/ 模型/ 能够/ 将/ XML/ 配置/ 规格/ 规范/ 文档/ 转换成/ 驱动/ 源码/ 中/ 的/ 检测/ 标记/ ,/ 并/ 在/ 运行/ 时/ 针对/ 检测/ 标记/ 执行/ 对应/ 的/ 操作/ ./ 以图/ 1/ 的/ XML/ 配置/ 规范/ 为例/ ,/ 规定/ 了/ 驱动/ 在/ 对/ USBFLBASEADD/ 寄存器/ 进行/ 赋值/ 时/ ,/ 需要/ 检查/ 尾/ 对齐/ ./ 下面/ 将/ 结合/ AiLsDc/ 模型/ 进行/ 具体/ 阐述/ ./ 其中/ 符号/ FLBASEADD/ 本身/ 可能/ 包含/ 的/ 访问/ 方式/ 有读/ 和/ 写/ ,/ 因此/ 使用/ swrite/ ,/ sread/ 表示/ ,/ 为了/ 便于/ 描述/ 约定/ va/ =/ %/ UHCI/ _/ BAR/ _/ BASE/ %/ +/ 08H/ ,/ 而/ null/ 表示/ 不/ 执行/ 任何/ 操作/ ./ F/ =/ {/ (/ q0/ ,/ (/ swrite/ ,/ p1/ (/ raddress/ )/ )/ )/ ×/ f/ →/ (/ q1/ ,/ null/ )/ ,/ 上述/ 函数/ 转换/ 表示/ ,/ 当/ 针对/ 一个/ 具体/ 的/ 读/ 操作/ 时/ ,/ 只要/ 地址/ 合法/ 即可/ ,/ 不/ 执行/ 任何/ 操作/ ./ 当/ 遇到/ 一个/ 配置/ 请求/ 时/ ,/ 则/ 需要/ 和/ 规格书/ 中/ 的/ 掩码/ 进行/ &/ 操作/ ,/ 如果/ 结果/ 不为/ 0/ 则/ 执行/ log/ 操作/ ./ Page64AiLsDc/ 系统/ AiLsDc/ 系统/ 在/ AiLsDc/ 模型/ 的/ 基础/ 上/ 实现/ ./ 主要/ 包括/ XML/ 配置/ 规范/ 文档/ 、/ 检测/ 标记/ 和/ 运行/ 时/ 辅助/ 日志/ 记录/ 等/ 功能模块/ ./ 通过/ 对/ 变量名/ 、/ 文档/ 等/ 进行/ 分析/ ,/ 提取/ 有效/ 信息/ 合成/ XML/ 配置/ 文档/ ,/ 并/ 根据/ 文档/ 要求/ 在/ 驱动/ 的/ 合适/ 位置/ 插入/ 相应/ 的/ 检测/ 标记/ ,/ 最后/ 在/ 运行/ 时/ 对/ 配置/ 信息/ 进行/ 检测/ ./ 当/ 出现异常/ 时/ ,/ 及时/ 捕获/ 出错/ 信息/ ,/ 并/ 记录/ 日志/ ,/ 方便/ 进行/ 错误/ 定位/ ./ 通过/ 静态/ 分析/ 和/ 规则/ 分析/ 等/ 方法/ 生成/ 驱动/ 配置/ 规格/ 规范/ XML/ 文档/ ,/ AiLsDc/ 系统/ 根据/ XML/ 文档/ 对/ 源码/ 进行/ 检测/ 标记/ 的/ 插装/ ,/ 在/ 运行/ 时/ 执行/ 既定/ 的/ 配置/ 参数/ 检查/ ./ 本/ 章节/ 将/ 就/ 系统/ 的/ 架构/ 、/ XML/ 的/ 生成/ 方案/ 、/ 日志/ 规范/ 记录/ 以及/ 动态/ 检查/ 的/ 具体/ 实现/ 等/ 进行/ 详细/ 探讨/ ./ 4.1/ 系统/ 架构图/ AiLsDc/ 系统/ 通过/ 对/ 驱动/ 配置/ 规格/ 规范/ XML/ 文档/ 进行/ 分析/ ,/ 对/ 设备/ 驱动/ 的/ 配置/ 源码/ 进行/ 自动/ 修改/ ,/ 实现/ 辅助/ 日志/ 记录/ 功能/ ./ 如图/ 3/ 所示/ ,/ 主要/ 包括/ 静态/ 插装/ 和/ 动态/ 检查/ 两/ 部分/ ,/ 前者/ 完成/ 源码/ 的/ 静态/ 检测/ 标记/ 的/ 插装/ ,/ 后者/ 则/ 是/ 在/ 运行/ 时/ 按照/ 配置/ 参数/ 的/ 要求/ 在/ 检测/ 标记/ 处/ 执行/ 检测/ 操作/ ,/ 出现异常/ 则/ 自动记录/ 其/ 日志/ ./ 图中/ 左侧/ 边框/ 表示/ 规范/ 生成/ 的/ 功能/ 范围/ ,/ 右侧/ 上下/ 虚/ 边框/ 内/ 分别/ 对应/ 静态/ 和/ 动态/ 检查/ 的/ 功能/ 范畴/ ./ 其中/ 实线/ 表示/ 系统/ 功能模块/ 的/ 数据流/ 控制关系/ ./ 同样/ ,/ 为了/ 更/ 细致/ 地/ 阐述/ 系统/ 的/ 实现/ 过程/ ,/ 下面/ 结合/ AiLsDc/ 模型/ 进行/ 阐述/ ./ 仍/ 以图/ 1/ 的/ XML/ 配置/ 规范/ 为例/ ,/ 针对/ USBFLBASEADD/ 寄存器/ 的/ 配置/ 源码/ 进行/ 修改/ ,/ 修改/ 前/ 的/ 源码/ [/ linux2/ ./ 6.38/ ,/ uhci/ -/ hcd/ ./ c/ ,/ loc185/ ]/ 如图/ 4/ 所示/ ./ 177/ ./ …/ …/ 184.185/ ./ …/ 201/ ./ 从图/ 4/ 可以/ 看出/ ,/ USB/ -/ HCD/ (/ 主机/ 控制器/ )/ 对/ 帧/ 基址/ 寄存器/ 执行/ DMA/ 地址/ 的/ 配置/ 功能/ ./ AiLsDc/ 对/ 源码/ 进行/ 分析/ 时/ ,/ 首先/ 检查/ 到/ swrite/ 操作/ ,/ 并且/ 地址/ 为/ uhci/ -/ >/ io/ _/ addr/ +/ USBFLBASEADD/ ,/ 执行/ p1/ (/ raddress/ )/ 为/ 真/ ,/ 故/ 转移/ 至/ q2/ 状态/ ,/ 并/ 对/ 驱动/ 的/ 配置/ 执行/ p2/ (/ rmask/ )/ 检查/ ,/ 作为/ 检测/ 标记/ 的/ 形式/ 实现/ 在/ 驱动/ 源码/ 中/ ,/ 由于/ 模型/ 本身/ 支持/ 对/ 参数/ 进行/ 变换/ ,/ 因此/ 插装/ 的/ 检测/ 代码/ 位于/ 参数/ 配置/ 执行/ 之前/ ,/ 修改/ 后/ 的/ 源码/ 如图/ 5/ 所示/ ./ 177/ ./ …/ 184.185/ ./ 186.187/ ./ …/ 203/ ./ staticvoidconfigure/ _/ hc/ (/ structuhci/ _/ hcd/ / uhci/ )/ 上述/ 伪/ 源码/ 实现/ 后/ ,/ 对/ 代码/ 进行/ 模块/ 编译/ 和/ 加载/ 后/ ./ 当/ 动态/ 运行/ 到/ 此/ 位置/ 后/ ,/ 将会/ 在/ 第/ 185/ 行/ 执行/ 驱动/ 配置/ 的/ 参数/ 检查/ ,/ 如果/ 参数/ 配置/ 不/ 符合规范/ ,/ 将/ 执行/ AiLog/ (/ AssistinsertLog/ )/ 函数/ ,/ 具体/ 实现/ 的/ 方案/ 在/ 4.2/ 节/ 细述/ ./ 4.2/ 参数/ 与/ 日志/ 规范/ AiLsDc/ 模型/ 依赖于/ XML/ 驱动/ 配置/ 规范/ ,/ 驱动/ 配置/ 规范/ 的/ 提取/ 方法/ 是/ 模型/ 的/ 重要/ 输入/ 基础/ ,/ 对此/ ,/ 规范/ 生成/ 办法/ 中/ 包含/ 静态/ 分析/ 和/ 规则/ 分析/ 两种/ 途径/ ./ 其中/ 静态/ 分析/ 是/ 指/ 通过/ 对/ 源码/ 进行/ 分析/ ,/ 提取/ 其中/ 有效/ 的/ 配置/ 规范/ ,/ 利用/ 变量名/ 、/ 函数/ 名/ 等/ 提取/ 关键/ 的/ 配置/ 参数/ ,/ 生成/ XML/ 配置/ 规格/ 文档/ ./ 同时/ ,/ 可以/ 参考/ IComment/ 的/ 实现/ 方案/ ,/ 从/ 注释/ 中/ 提取/ 配置/ 的/ 有效/ 语义/ 信息/ ./ 中断/ 的/ 出现/ 大大提高/ 了/ 系统/ 的/ 执行/ 效率/ ,/ 但是/ 同样/ 带来/ 了/ 中断/ 风暴/ 和/ 中断/ 缺失/ 等/ 问题/ ./ 当/ 驱动/ 的/ 配置/ 发生/ 改变/ 后/ ,/ 可能/ 引发/ 中断/ 风暴/ 等/ 问题/ ,/ 一旦/ 设备/ 发生/ 该类/ 问题/ ,/ 设备/ 将/ 无法/ 正常/ 完成/ 相应/ 的/ 功能/ ./ 中断/ 风暴/ 容易/ 引起/ 部分/ 任务/ 的/ 处理器/ 饥饿/ ,/ 而/ 中断/ Page7/ 缺失/ 则/ 可能/ 造成/ 相关/ 进程/ 无限/ 等待/ ./ 在/ Linux/ 的/ 驱动/ 中/ ,/ 中断/ 处理函数/ 大都/ 包含/ 返回值/ 类型/ irqreturn/ _/ t/ ,/ 函数/ 名中/ 包含/ _/ interrupt/ 或/ _/ irq/ 字段/ ./ 通过/ 分析/ 函数/ 名/ 及其/ 返回值/ 特征/ ,/ 利用/ AiLsDc/ 模型/ ,/ 在/ 源码/ 上/ 插入/ 检测/ 标记/ ,/ 运行/ 时/ 动态/ 检查/ 系统/ 的/ 中断/ 处理/ 频率/ ,/ 在/ 一定/ 周期/ 内/ ,/ 如果/ 中断/ 处理函数/ 的/ 频率/ 过高/ ,/ 则/ 记录/ 可能/ 的/ 日志/ 信息/ ./ 如果/ 一直/ 没有/ 发生/ 中断/ 处理/ 请求/ ,/ 就/ 可能/ 存在/ 中断/ 缺失/ 问题/ ,/ 同样/ 执行/ 异常/ 日志/ 记录/ 操作/ ./ 由于/ 中断/ 的/ 输出/ 日志/ 信息/ 可能/ 会/ 严重/ 降低/ 磁盘/ 类/ 驱动/ 的/ 性能/ ,/ 因此/ 为了/ 检查/ 方便/ ,/ 对/ 中断/ 缺失/ 和/ 中断/ 风暴/ 记录/ 的/ 日志/ 信息/ 只/ 包含/ 一条/ 日志/ 表示/ 已经/ 发现/ 中断/ 缺失/ 问题/ ./ 当/ 中断/ 再次/ 来/ 临时/ ,/ 显示/ 中断/ 缺失/ 已/ 解决/ ./ 在/ 此/ 过程/ 中/ ,/ 不再/ 输出/ 中断/ 缺失/ 相关/ 的/ 日志/ ./ 对/ 中断/ 风暴/ 的/ 处理/ ,/ 一旦/ 检测/ 到/ 中断/ 风暴/ ,/ 输出/ 日志/ 显示/ 检测/ 到/ 中断/ 风暴/ ,/ 当/ 频数/ 降低/ 到/ 规格/ 的/ 阈值/ 以下/ 时/ ,/ 则/ 输出/ 中断/ 风暴/ 已/ 结束/ ./ 在/ 此/ 过程/ 中/ ,/ 不/ 输出/ 任何/ 的/ 中断/ 风暴/ 信息/ ./ 在/ 4.1/ 节中/ 已经/ 讲述/ 了/ AiLsDc/ 的/ 驱动/ 配置/ 参数/ 检查/ 流程/ ./ 最终/ 会/ 根据/ 是否/ 违例/ 来/ 调用/ AiLog/ 函数/ ./ 日志/ 的/ 规范/ 表述/ 对于/ 后续/ 的/ 日志/ 分析/ 具有/ 重要/ 意义/ ,/ 因而/ 在/ 此/ 给出/ AiLog/ 函数/ 的/ 实现/ 的/ 伪码/ 示例/ ,/ 如图/ 6/ 所示/ ./ 1.2/ ./ 3.4/ ./ 5.6/ ./ 7/ .#/ defineAiLog/ (/ path/ ,/ loc/ ,/ value/ ,/ type/ )/ \/ if/ (/ type/ =/ =/ INT/ (/ 32/ // 16/ // 8/ )/ orUINT/ (/ 32/ // 16/ // 8/ )/ )/ // // 数值/ \/ printk/ (/ KERN/ _/ AILSDC/ "/ AILSDC/ :/ %/ s/ %/ d/ %/ d/ \/ n/ "/ ,/ elseif/ (/ type/ =/ =/ string/ )/ // // 字符串/ \/ printk/ (/ KERN/ _/ AILSDC/ "/ AILSDC/ :/ %/ s/ %/ d/ %/ s/ \/ n/ "/ ,/ else/ // // 指针/ 等/ \/ printk/ (/ KERN/ _/ AILSDC/ "/ AILSDC/ :/ %/ s/ %/ d/ %/ p/ \/ n/ "/ ,/ 该/ 类型/ 和/ XML/ 中/ 预定/ 义/ 的/ 数值/ 类型/ 、/ 字符串/ 、/ 指针/ 类型/ 一致/ ./ 当/ 驱动/ 对/ 配置/ 的/ 寄存器/ 的/ 参数/ 不/ 符合规范/ 时/ ,/ 会/ 执行/ 日志/ 记录/ ./ 在/ 传入/ 的/ 参数/ 中/ ,/ path/ 由/ __/ FILE/ __/ 宏/ 决定/ ,/ 而/ loc/ 则/ 由/ __/ LINE/ __/ 宏/ 决定/ ,/ 该/ 方案/ 使得/ 出现/ 错误/ 时/ ,/ 通过/ 查看/ 日志/ 能够/ 快速/ 定位/ 到/ 出现/ 问题/ 的/ 位置/ ./ 5/ 实用性/ 评测/ 实用性/ 评测/ 中/ 主要/ 针对/ 一些/ 提出/ 的/ XML/ 配置/ 规则/ ,/ 构造/ 测试用例/ ,/ 观察/ 系统/ 能够/ 捕获/ 异常/ ./ 本文/ 中/ 使用/ 了/ 针对性/ 错误/ 注入/ 和/ 随机/ 错误/ 注入/ 两种/ 方法/ 构造/ 驱动/ 配置/ 异常/ 测试/ 情景/ ,/ 进而/ 观测/ AiLsDc/ 系统/ 能否/ 捕获/ 该类/ 异常/ 行为/ ./ 5.1/ 错误/ 注入/ 测试/ 为了/ 对/ AiLsDc/ 模型/ 的/ 检测/ 能力/ 进行/ 评估/ ,/ 本文/ 将/ 使用/ 针对性/ 错误/ 注入/ 和/ 随机/ 错误/ 注入/ 等/ 方法/ 对/ Linux/ 的/ 驱动/ 进行/ 测试/ ./ 其中/ ,/ 被测/ Linux/ 版本/ 为/ 2.6/ ./ 38/ ,/ GCC/ 编译器/ 版本/ 为/ 4.3/ ./ 0/ ,/ 测试/ 依赖/ 环境/ Fedora14/ ./ 分别/ 选择/ RTL8169/ 、/ 85567LF/ -/ 3/ 、/ HDA/ 、/ USB/ 驱动/ 进行/ 错误/ 注入/ 测试/ ./ 对于/ RTL8169/ 独立/ 网卡/ 和/ 85567LF/ -/ 3/ 集成/ 网卡/ 驱动/ ,/ 针对/ 网络/ MAC/ 地址/ 配置/ 进行/ 检查/ ,/ 当/ 用户/ 改变/ 网卡/ 地址/ 时/ ,/ 能够/ 在/ 驱动/ 中/ 发现/ 并/ 记录/ 日志/ 或者/ 输出/ 提示信息/ ./ 对于/ HDA/ 声卡/ 驱动/ ,/ 通过/ 错误/ 地/ 修改/ 其/ DMA/ 缓存/ 地址/ ,/ 使/ 其/ 无法/ 正常/ 播放/ ,/ 然后/ 检测/ 其中/ 的/ 错误/ ,/ 同时/ 检测/ 中断/ 的/ 处理/ 频率/ ./ 针对/ USB/ -/ HCD/ 和/ USB/ 设备/ 驱动/ ,/ 则/ 通过/ 修改/ 帧/ 地址/ 寄存器/ 的/ DMA/ 为/ 非/ 对齐/ ,/ 检查/ 是否/ 能够/ 捕获/ 该类/ 异常/ 等/ ./ 在/ 此基础/ 上/ 再/ 进行/ 随机/ 错误/ 测试/ ,/ 通过/ 修改/ 或者/ 删除/ 部分/ 配置/ 参数/ ,/ 使/ 其/ 配置/ 逻辑/ 发生/ 改变/ ,/ 检测/ 是否/ 能够/ 捕获/ 与/ 之/ 相关/ 的/ 错误/ 类型/ 并/ 记录/ 异常/ 日志/ ,/ 错误/ 注入/ 的/ 测试/ 结构/ 如表/ 4/ 所示/ ./ 设备/ 驱动/ RTL8169/ 网卡/ 针对性/ 错误/ 注入/ 82567LF/ -/ 3/ 针对性/ 错误/ 注入/ HDA/ 声卡/ 针对性/ 错误/ 注入/ USB/ -/ HCD/ 针对性/ 错误/ 注入/ USB/ 设备/ 针对性/ 错误/ 注入/ 需要/ 指出/ 的/ 是/ ,/ 表/ 4/ 中/ 列出/ 的/ 均/ 是/ 异常/ 相关/ 的/ 错误/ ,/ 从而/ 验证/ AiLsDc/ 是否/ 能够/ 捕获/ 该种/ 异常/ ./ 根据/ PCI/ 手册/ ,/ 驱动/ 配置/ 到/ 硬件/ 的/ 地址/ 相关/ 参数均/ 要求/ 物理地址/ 对齐/ ,/ 同时/ 还/ 存在/ 大量/ 的/ 隐形/ 约束/ 等/ ./ 针对/ 该类/ 约束/ 进行/ 了/ 正确性/ 评测/ ,/ 从表/ 4/ 的/ 结果/ 看出/ ,/ AiLsDc/ 模型/ 能够/ 捕获/ 到/ 预期/ 的/ 异常/ ,/ 便于/ 发现/ 和/ 快速/ 定位/ 相关/ 错误/ ./ 5.2/ 注入/ 检测/ 分析/ AiLsDc/ 系统/ 根据/ 驱动/ 配置/ 规范/ 对/ 驱动/ 配置/ 进行/ 检查/ ,/ 其中/ 包括/ 常规/ 的/ 寄存器/ 的/ 参数/ 检查/ 、/ 软硬件/ Page8/ 地址/ 检查/ 、/ 中断/ 频度/ 检查/ 等/ ./ 系统/ 同样/ 支持/ 按照/ 定义/ 的/ 检测/ 规则/ 对/ 驱动/ 源码/ 自动/ 注入/ 检测/ 标记/ ,/ 在/ 运行/ 时/ 记录/ 日志/ ./ 针对/ Linux2/ ./ 6.38/ 的/ 驱动/ 部分/ 源码/ 进行/ 了/ 日志/ 注入/ 检查/ ,/ 其中/ 主要/ 包括/ ,/ 插入/ 中断/ 频度/ 检测/ 标记/ 、/ 关键/ 寄存器/ 参数/ 检查/ 标记/ 、/ DMA/ 地址/ 参数/ 检查/ 等/ ./ 从表/ 5/ 中/ 可以/ 看出/ ,/ 根据/ 自定义/ 的/ 规则/ ,/ 累计/ 插入/ 了/ 198/ 处/ 检测/ 标记/ ,/ 网络/ 相对/ 较/ 多/ ./ 对/ 插入/ 检测/ 标记/ 后/ 的/ 源码/ 进行/ 检查/ ,/ 没有/ 发现/ 不合理/ 的/ 日志/ 注入/ ./ 在/ 插入/ 过程/ 中/ ,/ 进行/ 了/ 严格/ 的/ 匹配/ ,/ 防止/ 误报/ 发生/ ./ 在/ 寄存器/ 的/ 参数/ 检查/ 中/ ,/ 经过/ 检查/ ,/ 没有/ 发现/ 漏报/ ./ 但是/ 在/ 中断/ 频度/ 检测/ 钩子/ 的/ 检测/ 标记/ 的/ 插入/ 中/ ,/ 部分/ 书写/ 不/ 规范/ 的/ 驱动/ 将/ 无法/ 通过/ 规则/ 检测/ 的/ 方式/ 注入/ 检测/ 标记/ ,/ 需要/ 程序员/ 增加/ 注解/ ,/ 目前/ AiLsDc/ 对/ 该类/ 问题/ 未/ 进行/ 处理/ ./ 5.3/ 相关/ 技术/ 比较/ 配置/ 引起/ 的/ 错误/ 常常/ 是/ 由于/ 使用者/ 改变/ 了/ 系统/ 环境/ ,/ 或者/ 驱动/ 移植/ 的/ 环境/ 发生/ 了/ 变化/ ./ 在/ 传统/ 的/ 可靠性/ 问题/ 研究/ 中/ ,/ ShadowDriver/ 等/ 机制/ 通过/ 重启/ 驱动/ 的/ 方法/ 来/ 解决/ 驱动/ 出现/ 的/ 突发性/ 或/ 短暂性/ 问题/ ,/ 但是/ 并/ 不能/ 解决/ 该类/ 配置/ 问题/ ,/ 也/ 不能/ 辅助/ 驱动/ 开发者/ 快速/ 定位/ 和/ 解决/ 该/ 错误/ ./ FTGT/ 利用/ 驱动/ 的/ 电源/ 管理/ 功能/ ,/ 按照/ 事务性/ 对/ 驱动/ 的/ 配置/ 进行/ 备份/ ,/ 当/ 出现/ 错误/ 时/ 直接/ 将/ 设备/ 状态/ 恢复/ 到/ 正常/ 状态/ ./ 该/ 方法/ 虽然/ 相比/ SD/ 有/ 了/ 更/ 高/ 的/ 效率/ ,/ 但是/ 当/ 系统/ 环境/ 变化/ 时/ ,/ 之前/ 的/ 驱动/ 状态/ 将/ 不再/ 可用/ ,/ 直接/ 恢复/ 将会/ 引起/ 致命/ 错误/ 甚至/ 设备/ 的/ 永久性/ 损坏/ ./ 例如/ ,/ 对/ DMA/ 地址/ 的/ 直接/ 配置/ ,/ 则/ 可能/ 污染/ 系统/ 的/ 关键/ 区域/ 内存/ ,/ 引起/ 系统/ 不/ 稳定/ ,/ 出现/ 破坏/ 系统/ 的/ 关键/ 数据/ 的/ 现象/ ./ 6/ 性能/ 评测/ 由于/ 一个/ 具体/ 的/ 驱动/ 配置/ 规则/ 对/ 一个/ 驱动/ 的/ 影响/ 较/ 小/ ,/ 并/ 不能/ 很/ 好/ 地/ 评估/ AiLsDc/ 的/ 性能/ 开销/ ,/ 下文/ 中将/ 主要/ 针对/ 中断/ 风暴/ 和/ 中断/ 缺失/ 的/ 异常/ 日志/ 记录/ 开销/ 进行/ 评估/ ./ 主流/ 的/ Linux/ 驱动/ 都/ 是/ 用/ 中断/ 的/ 方法/ 与/ 设备/ 进行/ 数据交换/ ,/ 从而/ 提高效率/ ,/ 因此/ 性能/ 开销/ 的/ 评估/ 具有/ 代表性/ 和/ 普适性/ ./ 本文/ 采用/ 标准/ 的/ netperf/ 和/ postmark/ 工具/ 对/ 网卡/ 和/ 硬盘/ 驱动/ 进行/ 性能/ 测评/ ;/ 针对/ 声卡/ ,/ 则/ 采用/ 录音/ 和/ 放音/ 软件/ 进行/ 测评/ ,/ 针对/ USB/ 控制器/ 和/ USB/ 设备/ 则/ 用/ USB/ 存储/ 的/ 吞吐/ 率/ 和/ CPU/ 占用率/ 等/ 指标/ 进行/ 对比/ 分析/ ./ 由于/ 测试/ 的/ 硬件/ 环境/ 为/ X86/ 体系结构/ ,/ 因此/ 在/ 源码/ arch/ 目录/ 下/ 只有/ x86/ 源码/ 在/ 统计/ 和/ 修改/ 范畴/ 之内/ ./ 由于/ 驱动/ 性能/ 测试/ 与/ 硬件/ 实验/ 环境/ 息息相关/ ,/ 并且/ 网络/ 测试/ 中/ 需要/ 使用/ 服务器/ ,/ 因此/ 一并/ 给出/ 测试/ 的/ 硬件/ 环境参数/ ,/ 如表/ 6/ 所示/ ./ OSFedora14/ (/ 2.6/ ./ 38/ )/ Fedora14/ (/ 2.6/ ./ 35/ )/ CPUPentium/ (/ R/ )/ Dual/ -/ CoreCPUCache2048KB/ 内存/ 2GBDDR2/ 硬盘/ 500GB7200r/ // min200GB7200r/ // min/ 网卡/ RealtekRTL/ -/ 8169GigabitNetperf/ 目前/ 已经/ 被/ 广泛/ 用于/ 测试/ 网络/ 的/ 吞吐量/ 和/ 资源/ 消耗/ 评测/ ,/ 并/ 支持/ 对/ TCP/ 和/ UDP/ 两种/ 协议/ 测试/ ,/ 支持/ RR/ 参数/ 测试/ 系统/ 的/ 时延/ ,/ 同时/ 支持/ STREAM/ 测试/ 网络系统/ 的/ 吞吐量/ ./ 在/ 组合/ 测试/ 过程/ 中/ ,/ 单/ 次测试/ 时间/ 均/ 为/ 30s/ ,/ 每个/ 项目/ 累计/ 测试/ 10/ 次/ ,/ 并/ 使用/ 最小值/ 、/ 最大值/ 、/ 平均值/ 作为/ 实际/ 的/ 评测/ 依据/ ,/ 使用/ 的/ netperf/ 版本号/ 为/ 2.6/ ./ 0/ ./ RR/ 参数/ 测试/ 以/ 请求/ 和/ 回复/ 的/ 吞吐量/ 为/ 基准/ ./ 在/ TCP/ 测试/ 中/ ,/ 每次/ 收发/ 的/ 报文/ 中均/ 只有/ 一个/ 字节/ ,/ 发送缓冲区/ 大小/ 分别/ 为/ 16384Bytes/ ,/ 接收缓冲区/ 大小/ 为/ 87380Bytes/ ./ 在/ UDP/ _/ RR/ 测试/ 中/ ,/ 发送/ 和/ 接收缓冲区/ 大小/ 默认/ 都/ 是/ 114688Bytes/ ,/ 同样/ 每次/ 接收/ 和/ 回复/ 的/ 报文/ 中/ 只有/ 一个/ 字节/ 的/ 数据/ ./ 图/ 7/ 和/ 图/ 8/ 分别/ 展示/ 的/ 是/ TCP/ _/ RR/ 、/ UDP/ _/ RR/ 参数/ 在/ 集成/ 网卡/ 上/ 的/ 吞吐量/ 和/ CPU/ 占用/ 情况/ 的/ 统计分析/ 结果/ ./ 图中/ 的/ “/ Linux/ ”/ 是/ 原始/ 的/ Linux/ 操作系统/ 测试/ 结果/ ,/ “/ AiLsDc/ ”/ 则/ 是/ 在/ Linux/ 上/ 修改/ 实现/ 的/ AiLsDc/ 图/ 7TCP/ _/ RR/ 和/ UDP/ _/ RR/ 测试/ 的/ 吞吐量/ 对比/ 分析/ 图/ Page9/ 系统/ ./ 而/ min/ 、/ max/ 和/ ave/ 分别/ 对应/ 特定/ 测试/ 参数/ 下/ 的/ 最小值/ 、/ 最大值/ 和/ 平均值/ ./ 图/ 8TCP/ _/ RR/ 和/ UDP/ _/ RR/ 测试/ 的/ CPU/ 占用率/ 从图/ 中/ 可以/ 看出/ ,/ AiLsDc/ 系统/ 相比/ Linux/ 在/ 吞吐/ 率上/ 存在/ 细微/ 损失/ ,/ 虽然/ 增加/ 了/ 少量/ 的/ CPU/ 利用率/ ,/ 但是/ 整体/ 性能/ 影响/ 均/ 非常/ 小/ ./ Netperf/ 的/ TCP/ _/ STREAM/ 和/ UDP/ _/ STREAM/ 参数/ 可以/ 分别/ 对系统/ TCP/ 和/ UDP/ 吞吐量/ 进行/ 测评/ ./ 其中/ TCP/ _/ STREAM/ 的/ 接收缓冲区/ 大小/ 为/ 87380Bytes/ ,/ 发送缓冲区/ 的/ 大小/ 为/ 16384Bytes/ ,/ 系统/ 每次/ 发送/ 的/ 消息/ 长度/ 等于/ 发送缓冲区/ 大小/ ./ 在/ UDP/ _/ STREAM/ 中/ ,/ socket/ 套/ 接字/ 缓存/ 大小/ 为/ 114688Bytes/ ,/ 消息/ 长度/ 为/ 65507Bytes/ ./ 图/ 9/ 和/ 图/ 10/ 分别/ 展示/ 的/ 是/ TCP/ _/ STREAM/ 、/ UDP/ _/ STREAM/ 参数/ 在/ 集成/ 网卡/ 上/ 的/ 吞吐量/ 和/ CPU/ 占用/ 情况/ 的/ 统计分析/ 结果/ ./ 图/ 9TCP/ _/ STREAM/ 和/ UDP/ _/ STREAM/ 测试/ 的/ 吞吐量/ 图/ 10TCP/ _/ STREAM/ 和/ UDP/ _/ STREAM/ 的/ CPU/ 占用率/ 从图/ 中/ 可以/ 看出/ ,/ AiLsDc/ 相比/ Linux/ 系统/ 的/ 吞吐量/ 并/ 没有/ 受到/ 影响/ ,/ CPU/ 利用率/ 相比/ Linux/ 提高/ 了/ 3/ %/ 左右/ ,/ 在/ 可以/ 接受/ 的/ 范围/ 之内/ ./ 本文/ 主要/ 通过/ 3/ 种/ 途径/ 对/ 硬盘/ 驱动/ 进行/ 评测/ ./ 分别/ 是/ ,/ 通过/ dd/ 测试/ 硬盘/ 的/ 读/ 速度/ 、/ 写/ 速度/ 、/ 和/ 混合/ 读写/ 速度/ ,/ 结果/ 如表/ 7/ 所示/ ./ 针对/ 文件系统/ 则/ 使用/ iozone/ 测试/ 文件系统/ 的/ 吞吐量/ ,/ 使用/ postmark/ 测试/ 文件系统/ 的/ 并发/ 性能/ ./ 评估/ 项目/ 读/ 速度/ Linux131AiLsDc131/ 从表/ 7/ 中/ 可以/ 看出/ ,/ 在/ Linux/ 和/ AiLsDc/ 上/ ,/ dd/ 的/ 访问/ 速率/ 并/ 没有/ 明显降低/ ./ 在/ 计算机/ 中/ ,/ 磁盘/ 并/ 不/ 直接/ 提供/ 给/ 上层/ 应用/ 使用/ ,/ 而是/ 需要/ 经由/ 文件系统/ 进行/ 管理/ ./ 因此/ 这里/ 用/ postmark/ 对/ Linux/ 系统/ 和/ AiLsDc/ 系统/ 的/ 并发/ 性/ 进行/ 评测/ 、/ 对比/ 和/ 分析/ ./ 测试/ 参数设置/ 如下/ ,/ 设置/ 文件/ 的/ 大小/ 为/ 10000/ ~/ 20000Bytes/ ;/ 事务/ 数/ 分别/ 为/ 30000/ ,/ 50000/ ,/ 80000/ 次/ ;/ 并发/ 文件/ 数从/ 1000/ 到/ 4000/ ,/ 每隔/ 200/ 进行/ 一次/ 测试/ ,/ 然后/ 针对/ 访问速度/ 绘制/ 曲线图/ ./ 图/ 11/ 和/ 图/ 12/ 分别/ 绘制/ 的/ 是/ postmark/ 针对/ Linux/ 和/ AiLsDc/ 系统/ 在/ 不同/ 的/ 事务/ 数/ 随着/ 并发/ 文件/ 数/ 增长/ 时/ ,/ 系统/ 的/ Page10/ 读写/ 速率/ 变化/ 曲线图/ ./ 图中/ “/ Linux/ (/ 30000/ )/ ”/ 、/ “/ AiLsDc/ (/ 30000/ )/ ”/ 分别/ 展示/ Linux/ 系统/ 和/ AiLsDc/ 系统/ 在/ 事务/ 数为/ 30000/ 个/ 时/ 访问速度/ 伴随/ 并发/ 文件/ 数/ 的/ 变化趋势/ ,/ 图中/ 的/ 其它/ 4/ 种/ 标识符/ 以此类推/ ./ 当/ 事务/ 数/ 参数/ 一定/ 时/ ,/ 取图/ 中/ 对应/ 的/ 两条/ 曲线/ 分析/ ,/ 可以/ 发现/ ,/ AiLsDc/ 系统/ 相比/ Linux/ 系统/ ,/ 性能/ 并未/ 受/ 明显/ 影响/ ./ 两个/ 系统/ 的/ 整体/ 变化趋势/ 一致/ ,/ 表明/ 性能/ 影响/ 较/ 小/ ./ 为了/ 测试/ 系统/ 改进/ 后/ 对流/ 媒体/ 的/ 播放/ 支持/ ,/ 同样/ 对/ 声卡/ 驱动/ 进行/ 改进/ ./ 声卡/ 驱动/ 测试/ 主要/ 利用/ rhythmbox/ 程序/ 播放/ 一分钟/ 歌曲/ ,/ 观察/ 声卡/ 驱动/ 的/ CPU/ 利用率/ 的/ 变化/ ./ 测试/ 结果表明/ ,/ 声音/ 在/ AiLsDc/ 系统/ 上/ 播放/ 连续/ ,/ CPU/ 利用率/ 和/ Linux/ 系统/ 相当/ ,/ 变化/ 曲线/ 如图/ 13/ 所示/ ./ 在/ 上/ 文中/ 提到/ ,/ 设备/ 驱动/ 除了/ PCI/ 驱动/ ,/ 还有/ 大量/ 的/ USB/ 串行/ 传输/ 驱动/ ,/ 因此/ 本文/ 针对/ USB/ 驱动/ 则/ 主要/ 通过/ 对/ U盘/ 的/ 读写/ 速度/ 进行/ 测试/ ,/ 通过/ hdparm/ 工具/ 对/ U盘/ 进行/ 读写/ 测试/ ./ 表/ 8/ 中/ 展示/ 了/ hdparm/ 对/ 三星/ 和/ 金士顿/ 两款/ 具体/ 的/ 设备/ 的/ 测试/ 结果/ ./ 两款/ 不同/ 厂商/ 的/ U盘/ 评测/ 速度/ 均/ 表明/ ,/ AiLsDc/ 系统/ 并/ 没有/ 对系统/ 性能/ 造成/ 影响/ ,/ 读取/ 访问/ 速率/ 基本一致/ ./ 系统/ 三星/ 读写/ 速度/ // (/ MB/ ·/ s/ -/ 1/ )/ Linux1189/ ./ 6425.601146/ ./ 5915.84/ AiLsDc1123/ ./ 7425.591128/ ./ 1115.85/ 上面/ 的/ 性能/ 评测/ 表明/ ,/ AiLsDc/ 系统/ 按照/ 预定/ 义/ 的/ 驱动/ 配置/ 规范/ 实现/ 后/ ,/ 相比/ Linux/ 系统/ ,/ 性能/ 上/ 并未/ 产生/ 大/ 的/ 影响/ ./ AiLsDc/ 系统/ 在/ 实现/ 驱动/ 配置/ 规范/ 检查/ 的/ 同时/ ,/ 保持/ 了/ 较优/ 的/ 性能/ ./ 7/ 总结/ 驱动/ 配置/ 错误/ 常常/ 发生/ 在/ 系统管理员/ 对系统/ 进行/ 修改/ ,/ 或者/ 对/ 驱动/ 、/ 内核/ 进行/ 升级/ ,/ 或者/ 设备/ 更新换代/ 时/ ./ 该类/ 错误/ 由于/ 不能/ 通过/ 重启/ 等/ 方法/ 解决/ ,/ 因此/ 必须/ 依赖于/ 一些/ 调试/ 方法/ 进行/ 快速/ 定位/ ./ 本文/ 设计/ 了/ 一个/ 驱动/ 配置/ 的/ 正确性/ 检查/ 模型/ ,/ 并/ 在/ 模型/ 基础/ 上/ 设计/ 并/ 实现/ 了/ AiLsDc/ 系统/ ,/ 能/ 在/ 可能/ 出错/ 的/ 部位/ 插入/ 相关/ 的/ 日志/ ,/ 通过/ 对比/ 和/ 检查/ 日志/ ,/ 使得/ 出错/ 时/ 能够/ 快速/ 定位/ 从而/ 辅助/ 纠错/ ./ 实用性/ 评测/ 和/ 性能/ 评测/ 结果表明/ ,/ AiLsDc/ 系统/ 不仅/ 保持/ 了/ 较/ 好/ 的/ 性能/ ,/ 而且/ 提高/ 了/ 驱动/ 的/ 可靠性/ ./ 致谢/ 本文/ 作者/ 得到/ 了/ 清华大学/ 计算机科学/ 与/ 技术/ 系/ 操作系统/ 实验室/ 的/ 老师/ 和/ 同学/ 们/ 的/ 许多/ 帮助/ 和/ 建议/ ,/ 在/ 此/ 表示感谢/ ./ 同时/ 也/ 感谢/ 审稿人/ 对/ 本文/ 提出/ 宝贵意见/ 和/ 建议/ !/ 

