Page1/ 超级/ 计算/ 系统/ 互连/ 网络/ 带内/ 管理/ 的/ 实现/ 与/ 评测/ 1/ )/ (/ 国防科学技术大学/ 计算机/ 学院/ 长沙/ 410073/ )/ 2/ )/ (/ 国防科学技术大学/ 并行/ 与/ 分布式计算/ 重点/ 实验室/ 长沙/ 410073/ )/ 摘要/ 互连/ 网络/ 是/ 超级/ 计算/ 系统/ 的/ 关键部件/ ,/ 其/ 易管理性/ 将/ 直接/ 影响/ 整个/ 系统/ 的/ RAS/ 特性/ (/ 可靠性/ 、/ 可用性/ 和/ 服务性/ )/ ./ “/ 天河/ 二号/ ”/ 超级/ 计算/ 系统/ 采用/ 了/ 定制/ 的/ 高速/ 互连/ 网络/ ,/ 该/ 网络/ 由/ 大约/ 5856/ 块/ 网络/ 交换/ 芯片/ NRC/ 和/ 18304/ 块/ 网络接口/ 芯片/ NIC/ 构成/ ,/ 其/ 互连/ 规模/ 极其/ 巨大/ ./ 为了/ 实现/ 对系统/ 内/ 众多/ 网络/ 芯片/ 及其/ 端口/ 的/ 高效率/ 配置/ 和/ 监控/ 等/ 管理/ 操作/ ,/ 该/ 互连/ 网络/ 采用/ 了/ 基于/ 带内/ 的/ 网络管理/ 技术/ ./ 该文/ 描述/ 了/ 带/ 内/ 网络管理/ 的/ 设计/ 与/ 实现/ ,/ 具体/ 包括/ 网络管理/ 功能/ 、/ 网络管理/ 总体/ 结构/ 、/ 带内/ 管理/ 描述符/ 格式/ 与/ 报文/ 处理/ 流程/ 、/ 管理软件/ 的/ 总体/ 框架/ 等/ ./ 基于/ 部署/ 在/ 国家/ 超级/ 计算/ 广州/ 中心/ 的/ 实际/ 系统/ ,/ 该文/ 对/ “/ 天河/ 二号/ ”/ 互连/ 网络/ 带内/ 的/ 管理/ 进行/ 了/ 测试/ ,/ 测试/ 结果/ 证明/ 了/ 带/ 内/ 管理/ 的/ 高效性/ ./ 关键词/ 超级/ 计算/ 系统/ ;/ 互连/ 网络/ ;/ 带内/ 管理/ ;/ 天河/ 二号/ 1/ 引言/ 超级/ 计算/ 系统/ 互连/ 网络/ 的/ 管理/ 主要/ 由/ 硬件/ 和/ 软件/ 两/ 部分/ 实现/ ,/ 其/ 硬件/ 部分/ 主要/ 负责/ 提供/ 管理/ 通路/ 、/ 产生/ 状态/ 信息/ 和/ 支持/ 测试/ 诊断/ 等/ ,/ 而/ 软件/ 部分/ 主要/ 负责/ 分发/ 网络/ 配置/ 、/ 采集/ 网络/ 状态/ 、/ 报告/ 网络故障/ ,/ 对/ 故障/ 部件/ 进行/ 测试/ 诊断/ ,/ 并/ 提供/ 友好/ 的/ 用户/ 管理/ 界面/ 等/ ./ 就/ 网络管理/ 通路/ 而言/ ,/ 通常/ 有/ 两种/ 实现/ 方式/ ,/ 即带/ 内/ 网络管理/ (/ In/ -/ bandNetworkManage/ -/ ment/ ,/ INM/ )/ 和/ 带外/ 网络管理/ (/ Out/ -/ bandNetworkManagement/ ,/ ONM/ )/ ./ 带外/ 网络管理/ 的/ 管理/ 通道/ 独立/ 于/ 网络/ 自身/ 的/ 数据通道/ ,/ 而/ 带/ 内/ 网络管理/ 的/ 管理/ 信息/ 传输/ 与/ 数据传输/ 共用/ 同一/ 通道/ ./ 与/ 带外/ 网络管理/ 相比/ ,/ 带内/ 网络管理/ 的/ 优点/ 主要/ 体现/ 在/ 3/ 个/ 方面/ :/ 一是/ 性能/ 高/ ,/ 带内/ 网络管理/ 使用/ 高速/ 数据通道/ 传输/ 管理/ 报文/ ,/ 其/ 性能/ 远高于/ 使用/ I2C/ [/ 1/ ]/ 、/ JTAG/ [/ 2/ ]/ 、/ SMBus/ [/ 3/ ]/ 等/ 低速/ 通道/ 的/ 带外/ 网络管理/ ./ 二是/ 实现/ 代价/ 低/ ,/ 实现/ 带内/ 网络管理/ 的/ 硬件/ 部分/ 只/ 需要/ 在/ 网络/ 芯片/ 设计/ 时/ 增加/ 传输/ 和/ 处理/ 管理/ 报文/ 的/ 硬件/ 逻辑/ ,/ 而/ 实现/ 带外/ 网络管理/ 通常/ 需要/ 多种/ 电子器件/ (/ 例如/ I2CHub/ 等/ )/ ./ 带内/ 网络管理/ 使/ 网络/ 具备/ 自治/ 管理/ 能力/ ,/ 并且/ 通过/ 对/ 管理/ 报文/ 合理/ 地/ 进行/ 流控/ ,/ 可/ 将/ 管理/ 流量/ 对/ 数据/ 流量/ 的/ 性能/ 影响/ 降/ 至极/ 低/ ./ 三是/ 保持/ 了/ 故障/ 的/ 一致性/ ,/ 带内/ 网络管理/ 报文/ 和/ 数据/ 报文/ 使用/ 相同/ 的/ 传输/ 通道/ ,/ 所以/ 并/ 不会/ 额外/ 增加/ 网络管理/ 通道/ 的/ 故障/ ,/ 保持/ 了/ 管理/ 通道/ 与/ 数据通道/ 故障/ 的/ 一致性/ ./ 带外/ 网络管理/ 额外/ 增加/ 了/ 管理/ 信息/ 传输/ 通道/ ,/ 因此/ 不可避免/ 地/ 引入/ 新/ 故障/ 源/ ./ 目前/ ,/ 排名/ 世界/ HPCTOP500/ ①/ 榜首/ 的/ “/ 天河/ 二号/ (/ TH/ -/ 2/ )/ ”/ 超级/ 计算/ 系统/ 采用/ 了/ 带/ 内/ 网络管理/ 技术/ ,/ 不但/ 提供/ 了/ 丰富/ 的/ 网络管理/ 功能/ ,/ 而且/ 增强/ 了/ 超大规模/ 互连/ 网络/ 的/ 可管理性/ ./ 本文/ 介绍/ TH/ -/ 2/ 互连/ 网络/ 带内/ 网络管理/ 的/ 设计/ 、/ 实现/ 与/ 评测/ ./ 全文/ 分/ 6/ 节/ ,/ 第/ 2/ 节/ 简单/ 介绍/ TH/ -/ 2/ 互连/ 网络结构/ ;/ 第/ 3/ 节/ 详细/ 阐述/ 带内/ 网络管理/ 的/ 设计/ 与/ 实现/ ;/ 第/ 4/ 节/ 测试/ 与/ 分析/ TH/ -/ 2/ 互连/ 网络/ 带内/ 网络管理/ 的/ 性能/ ;/ 第/ 5/ 节/ 阐述/ 相关/ 研究/ ;/ 最后/ 总结/ 全文/ 并/ 展望未来/ 工作/ ./ 2TH/ -/ 2/ 互连/ 网络/ TH/ -/ 2/ 超级/ 计算/ 系统/ 采用/ 全/ 定制/ 的/ 高速/ 互连/ 网络/ ,/ 该/ 网络/ 主要/ 由/ 两款/ ASIC/ 芯片/ 构成/ ,/ 分别/ 是/ 高速/ 网络接口/ 芯片/ (/ High/ -/ speedNetworkInterfaceChip/ ,/ NIC/ )/ 和/ 高阶/ 网络/ 路由/ 芯片/ (/ High/ -/ radixNetworkRoutingChip/ ,/ NRC/ )/ [/ 4/ ]/ ./ 2.1/ 网络接口/ 芯片/ NICNIC/ 主要/ 负责/ 计算/ 节点/ 和/ 服务/ 节点/ 与/ 互连/ 网络/ 的/ 接入/ ./ NIC/ 实现/ 了/ PCIE/ -/ G3/ ×/ 16/ 主机/ 接口/ 和/ 14Gbps/ ×/ 8/ 网络接口/ ./ 支持/ 短消息/ (/ Mini/ -/ Packet/ ,/ MP/ )/ 和/ 远程/ 直接/ 内存/ 访问/ (/ RemoteDirectlyMemoryAccess/ ,/ RDMA/ )/ 两种/ 数据传输/ 机制/ ./ 采用/ 基于/ 硬件/ 逻辑/ 的/ 动态/ 连接/ 机制/ 提供/ 消息/ 可靠/ 传输/ 和/ 消息/ 流量/ 控制/ [/ 5/ ]/ ./ NIC/ 设计/ 了/ 支持/ 用户/ 级/ 通信/ 的/ 虚/ 端口/ (/ VirtualPort/ ,/ VP/ )/ 机制/ ./ 每个/ VP/ 由/ 一组/ 可编程/ 的/ 寄存器/ 和/ 相应/ 的/ 内存/ 数据结构/ 组成/ ,/ 这些/ 资源/ 被/ 内存/ 映射/ 到/ 用户/ 地址/ 空间/ ./ NIC/ 提供/ 40/ 个/ VP/ 给/ 软件/ 使用/ ,/ 其中/ 8/ 个/ VP/ 为/ PIO/ (/ ProgrammableInput/ // Output/ )/ 类型/ ,/ 另外/ 32/ 个/ VP/ 为/ DMA/ (/ DirectlyMemoryAccess/ )/ 类型/ ./ NIC/ 为/ 每个/ PIO/ 类型/ VP/ 提供/ 了/ 专享/ 的/ 硬件/ 描述符/ 队列/ (/ HardwareDescriptorQueue/ ,/ HDQ/ )/ ,/ 软件/ 用/ PIO/ 写/ 方式/ 向/ NIC/ 提交/ 描述符/ ./ 对于/ DMA/ 类型/ 的/ VP/ ,/ NIC/ 用/ DMA/ 读/ 的/ 方式/ 取/ 描述符/ ,/ 描述符/ 队列/ 存放/ 在/ 主存/ 中/ ,/ 故/ 称为/ 软件/ 描述符/ 队列/ (/ SoftwareDescriptorQueue/ ,/ SDQ/ )/ ./ 此外/ ,/ 软件/ 在/ 主机/ 内存/ 中为/ 每个/ VP/ 分配/ 专享/ 的/ MP/ 接收/ 队列/ (/ Mini/ -/ PacketQueue/ ,/ MPQ/ )/ 和/ 事件队列/ (/ EventQueue/ ,/ EQ/ )/ ./ MPQ/ 用于/ 接收/ 远端/ 节点/ 发送/ 的/ MP/ 报文/ ,/ EQ/ 用于/ 实现/ NIC/ 硬件/ 向/ 软件/ 通告/ 发送/ 或/ 接收数据/ 完成/ 事件/ ./ 2.2/ 网络/ 路由/ 芯片/ NRCNRC/ 主要/ 负责/ 网络/ 报文/ 的/ 路由/ 与/ 交换/ ./ NRC/ 实现/ 了/ 24/ 个/ 网络/ 端口/ 的/ 无/ 阻塞/ 全/ 交换/ 功能/ ,/ 网络/ 端口/ 采用/ 14Gbps/ ×/ 8/ 链路/ ,/ 报文交换/ 的/ 吞吐/ 率/ 达到/ 5.376/ Tbps/ ./ 为了/ 降低/ 全/ 交叉开关/ (/ Crossbar/ )/ 后/ 端/ 实现/ 的/ 难度/ ,/ 芯片/ 内部/ 采用/ 瓦片/ 式/ 交换/ 结构/ [/ 6/ -/ 7/ ]/ ,/ 即将/ 24/ 个/ Tile/ 组织/ 为/ 4/ ×/ 6/ 的/ 阵列/ ./ 报文/ 传输/ 的/ 物理/ 通道/ 划分/ 为/ 6/ 个/ 虚/ 通道/ (/ VirtualChannel/ ,/ VC/ )/ ,/ 报文交换/ 采用/ 虚切通/ (/ VirtualCut/ -/ Through/ ,/ VCT/ )/ 方式/ [/ 8/ ]/ ./ 利用/ 动态分配/ 多/ 队列/ (/ DynamicallyAllocatedMulti/ -/ Queue/ ,/ DAMQ/ )/ 技术/ 达到/ 了/ 减少/ 缓冲区/ 所/ 需要/ 的/ 存储资源/ 的/ 目的/ [/ 9/ ]/ ./ 报文/ 路由/ 采用/ 基于/ 分布式/ 查表/ 的/ 自/ 适应/ 路由/ ,/ 即/ 在/ 网络/ 中/ 每个/ NRC/ 芯片/ 的/ 端口/ 保存/ 一张/ 路由表/ ,/ 该/ 路由表/ 为/ 进入/ 本/ 端口/ 的/ 网络/ 报文/ 指明/ 了/ 到/ 系统/ 中/ 各个/ 目的/ 节点/ 时/ 应该/ 选择/ 的/ 本/ NRC/ 芯片/ 输出/ 端口/ 集合/ ./ 报文/ 路由/ 时/ 根据/ 各个/ 输出/ 端口/ 链路/ 状态/ 进行/ 自/ 适应/ 均衡/ 负载/ ./ 当/ 节点/ 间通信/ 时/ ,/ 源/ 节点/ 只/ 需要/ 直接/ 在/ 报文/ 头部/ 填/ ①/ HPCTOP500/ ./ http/ :/ // // www/ ./ top500/ ./ org/ // ,/ 2015Page3/ 写/ 目的/ 节点/ 编号/ 并/ 将/ 报文/ 注入/ 网络/ 即可/ ./ 当/ 网络/ 构建/ 时/ ,/ 需要/ 通过/ 网络管理/ 工具/ 将/ 预先/ 设计/ 的/ 路由表/ 加载/ 到/ 系统/ 中/ 各个/ NRC/ 或/ 其/ 相应/ 存储器/ 件/ (/ 即/ E2prom/ )/ ./ 2.3/ 互连/ 拓扑/ 结构/ TH/ -/ 2/ 互连/ 网络/ 采用/ 胖/ 树结构/ ,/ 该/ 结构/ 的/ 物理/ 实现/ 分为/ 3/ 层/ :/ (/ 1/ )/ 第/ 1/ 层/ 由/ 计算机/ 柜/ 构成/ ,/ 每个/ 计算机/ 柜/ 包含/ 4/ 个/ 机框/ ,/ 机框/ 内/ 的/ 底层/ 交换机/ (/ BottomSwitch/ )/ 连接/ 32/ 个/ 计算/ 节点/ ,/ 并/ 上行/ 连接/ 到/ 叶/ 通信/ 图/ 1TH/ -/ 2/ 互连/ 网络拓扑/ 结构/ 上述/ 底层/ 交换机/ 、/ 叶/ 交换机/ 、/ 根/ 交换机/ 分别/ 由/ 6/ 、/ 1/ 、/ 6/ 块/ NRC/ 芯片/ 构成/ ,/ 这/ 3/ 种/ 交换机/ 分别/ 拥有/ 20/ 、/ 24/ 、/ 48/ 个/ 用于/ 扩展/ 互连/ 的/ 网络/ 端口/ ,/ 扩展/ 互连/ 端口/ 之间/ 使用/ QSFP/ 封装/ 的/ AOC/ 光纤/ 进行/ 互连/ ./ 综上所述/ ,/ 构建/ TH/ -/ 2/ 大规模/ 的/ 互连/ 网络/ 共/ 使用/ NRC/ 芯片/ 约/ 5856/ 块/ ,/ 使用/ NIC/ 芯片/ 约/ 18304/ 块/ ,/ 使用/ AOC/ 光纤/ 约/ 46000/ 根/ ./ 互连/ 网络管理/ 的/ 目标/ 是/ 实现/ 对/ 上述/ 大规模/ 互连/ 网络/ 各个/ 芯片/ 及其/ 端口/ 高效/ 地/ 实施/ 配置/ 、/ 监控/ 、/ 测试/ 、/ 诊断/ 等/ 管理/ 操作/ ./ 3TH/ -/ 2/ 互连/ 网络管理/ 3.1/ 网络管理/ 功能/ 为了/ 增强/ 网络系统/ 的/ 可管理性/ ,/ 我们/ 为/ TH/ -/ 2/ 互连/ 网络/ 定义/ 了/ 丰富/ 的/ 网络管理/ 功能/ ,/ 具体/ 包括/ 网络/ 配置/ 、/ 状态/ 监控/ 、/ 故障/ 主动/ 报告/ 、/ 路径/ 追踪/ [/ 10/ ]/ 、/ 拓扑/ 发现/ [/ 11/ ]/ 、/ 链路/ 内/ 建/ 自测试/ (/ Build/ -/ inSelf/ -/ Test/ ,/ BIST/ )/ [/ 12/ ]/ 等/ ./ (/ 1/ )/ 参数/ 配置/ ./ 当/ 计算/ 节点/ 和/ 交换机/ 加电后/ ,/ 需要/ 对/ 网络接口/ 和/ 交换/ 芯片/ 运行/ 时/ 配置/ 参数/ 进行/ 初始化/ ./ 无论是/ 在线/ 初始化/ 芯片/ 配置/ 参数/ ,/ 还是/ 芯片/ 在/ 机柜/ ./ 全/ 系统/ 共有/ 143/ 个/ 计算机/ 柜/ ;/ (/ 2/ )/ 第/ 2/ 层为/ 叶/ 通信/ 机柜/ ,/ 每个/ 叶/ 通信/ 机柜/ 包含/ 3/ 组叶/ 交换机/ (/ LeafSwitch/ )/ ,/ 每组/ 的/ 20/ 块/ 叶/ 交换机/ 实现/ 了/ 与/ 3/ 个/ 计算机/ 柜内/ 所有/ 底层/ 交换机/ 的/ 互连/ ,/ 并/ 上行/ 连接/ 到/ 根/ 通信/ 机柜/ ./ 全/ 系统/ 共有/ 16/ 个叶/ 通信/ 机柜/ ;/ (/ 3/ )/ 第/ 3/ 层为/ 根/ 通信/ 机柜/ ,/ 每个/ 根/ 通信/ 机柜/ 包含/ 30/ 块根/ 交换机/ (/ RootSwitch/ )/ ,/ 根/ 交换机/ 是/ 整个/ 胖/ 树结构/ 的/ 顶层/ ./ 全/ 系统/ 共/ 8/ 个根/ 通信/ 机柜/ ./ 图/ 1/ 为/ TH/ -/ 2/ 互连/ 网络拓扑/ 结构/ 示意图/ [/ 4/ ]/ ./ 加电后/ 从/ 存储器/ 件/ E2prom/ 中/ 读取/ 配置/ 参数/ ,/ 都/ 需要/ 网络管理/ 提供/ 参数/ 配置/ 功能/ ./ 同时/ ,/ TH/ -/ 2/ 采用/ 分布式/ 查表/ 路由/ ,/ 所以/ 网络/ 配置/ 参数/ 除了/ 包括/ 物理层/ 和/ 数据/ 链路层/ 等/ 参数/ 外/ ,/ 还/ 包括/ 网络层/ 路由表/ 参数/ ./ (/ 2/ )/ 状态/ 监控/ ./ 通过/ 状态/ 监控/ ,/ 可以/ 实时/ 地/ 了解/ 网络/ 的/ 健康状况/ ,/ 这/ 对于/ 网络/ 的/ 调试/ 、/ 测试/ 和/ 日常/ 维护/ 具有/ 重要/ 作用/ ./ 为了/ 灵活性/ ,/ 对/ 互连/ 网络/ 基本/ 状态/ 的/ 监控/ 通常/ 采用/ 轮询/ 方式/ ./ 在/ 互连/ 网络/ 提供/ 状态/ 信息/ 支持/ 方面/ ,/ 一是/ 按照/ 重要性/ 对/ 状态/ 信息/ 分级/ ,/ 从而/ 减少/ 管理系统/ 对/ 网络/ 状态/ 信息/ 的/ 访问量/ ,/ 缩短/ 网络故障/ 定位/ 时间/ ./ 二是/ 提供/ 尽可能/ 丰富/ 的/ 状态/ 信息/ ,/ 特别/ 是/ 数据/ 链路层/ 的/ 状态/ 信息/ ,/ 例如/ 报文/ 重传/ 计数/ 和/ 报文/ 重传/ 率/ 等/ ,/ 从而/ 为/ 网络/ 的/ 数据/ 链路层/ 故障/ 处理/ 提供/ 重要依据/ ./ (/ 3/ )/ 故障/ 报告/ ./ 除了/ 对/ 互连/ 网络/ 的/ 基本/ 状态/ 采用/ 轮询/ 方式/ 进行/ 监控/ 外/ ,/ 对于/ 网络/ 中/ 出现/ 的/ 某些/ 类型/ 的/ 严重/ 故障/ (/ 例如/ 链路/ 断开/ )/ ,/ 应该/ 能够/ 实时/ 地/ 报告/ 到/ 网络管理/ 平台/ (/ 例如/ 管理/ 服务器/ 及/ 运行/ 的/ 管理程序/ )/ ,/ 所以/ TH/ -/ 2/ 互连/ 网络/ 支持/ 网络故障/ 的/ 主动/ 报告/ 功能/ ./ 为了/ 增强/ 主动/ 报告/ 功能/ 的/ 灵活性/ ,/ 支持/ 通过/ Page4/ 配置/ 参数/ 对/ 故障/ 主动/ 报告/ 行为/ 进行/ 控制/ ./ 例如/ ,/ 通过/ 设置/ 故障/ 屏蔽/ 寄存器/ ,/ 可以/ 选择/ 主动/ 报告/ 错误/ 的/ 种类/ ./ (/ 4/ )/ 路径/ 追踪/ ./ 与/ IP/ 路由/ 追踪/ [/ 10/ ]/ 类似/ ,/ 该/ 功能/ 为/ 分布式/ 查表/ 路由/ 互连/ 网络/ 提供/ 一种/ 查询/ 计算/ 节点/ 间/ 路由/ 路径/ 的/ 机制/ 与/ 方法/ ,/ 其/ 原理/ 是/ 根据/ 网络管理/ 人员/ 提供/ 的/ 源/ 和/ 目的/ 计算/ 节点/ ,/ 通过/ 连续/ 访问/ 节点/ 接口/ 芯片/ 和/ 网络/ 路由/ 芯片/ 的/ 相关/ 寄存器/ 和/ 路由表/ 信息/ ,/ 仿真/ 计算/ 出/ 从源/ 节点/ 出发/ 经过/ 各个/ 中间/ 各级/ 网络/ 芯片/ 的/ 路由/ 过程/ ,/ 从而/ 判断/ 出路/ 由/ 的/ 正确性/ (/ 即/ 可达性/ )/ ,/ 并/ 获得/ 路由/ 路径/ 信息/ ./ 此外/ ,/ 还/ 可以/ 进一步/ 检查/ 该/ 路由/ 路径/ 中/ 各个/ 网络/ 端口/ 的/ 链路层/ 状态/ ./ (/ 5/ )/ 拓扑/ 发现/ ./ 拓扑/ 发现/ 是/ 高性能/ 互连/ 网络/ 应该/ 支持/ 的/ 重要/ 网络管理/ 功能/ 之一/ [/ 11/ ]/ ./ 该/ 功能/ 不但/ 可以/ 用于/ 检查/ 光纤/ 和/ 网络/ 端口/ 连接/ 关系/ 的/ 正确性/ ,/ 而且/ 发现/ 的/ 网络拓扑/ 信息/ 可/ 用于/ 管理程序/ 根据/ 路由/ 算法/ 自动/ 生成/ 全/ 系统/ 路由表/ 配置/ 参数/ 并/ 加载/ 到/ 各个/ 网络/ 路由/ 芯片/ 中/ ./ 实现/ 故障/ 报告/ 和/ 拓扑/ 发现/ 功能/ 的/ 前提/ 是/ 系统/ 中/ 的/ 每个/ 网络/ 芯片/ 及其/ 端口/ 具有/ 唯一/ 的/ 标识/ ./ 在/ TH/ -/ 2/ 系统/ 中/ ,/ 拓扑/ 发现/ 由/ 运行/ 在/ 管理/ 服务器/ 的/ 管理程序/ 发起/ ,/ 采用/ 宽度/ 优先/ 搜索算法/ 获得/ 系统/ 中/ 所有/ 网络/ 端口/ 对/ 的/ 连接/ 关系/ 信息/ ./ (/ 6/ )/ 链路/ 测试/ ./ 为了/ 快速/ 定位/ 网络/ 链路/ 故障/ ,/ 网络管理/ 需要/ 对/ 网络/ 链路/ 故障诊断/ 与/ 测试/ 提供/ 支持/ ./ BIST/ 是/ 一种/ 在/ 芯片/ 内部/ 自行/ 产生/ 测试/ 信号/ 并/ 自行/ 检测/ 信号/ 质量/ 的/ 可/ 测试/ 性/ 增强/ 技术/ [/ 12/ ]/ ./ 通常/ ,/ HSS/ 生产/ 厂商/ 已/ 在/ 物理层/ 的/ 各/ 通道/ 上/ 已经/ 内置/ 了/ BIST/ 测试/ 功能/ ,/ 但/ 这/ 只能/ 针对/ 单条/ 物理/ 通道/ 进行/ 测试/ ./ 在/ TH/ -/ 2/ 系统/ 中/ ,/ 我们/ 在/ 数据/ 链路层/ 提供/ 对/ 绑定/ 后/ 的/ 多通道/ 进行/ 并行/ 测试/ 功能/ ,/ 不仅/ 缩短/ 测试/ 时间/ ,/ 而且/ 可以/ 在/ 数据/ 链路层/ 上/ 对/ 通信/ 链路/ 的/ 信号/ 传输/ 质量/ 进行/ 精确/ 评估/ ./ 通常/ ,/ 底层/ 硬件/ 只/ 需为/ 上层/ 软件/ 提供/ 基本/ 支持/ ,/ 上层/ 软件/ 可/ 在/ 硬件/ 基础/ 上/ 实现/ 更/ 复杂/ 的/ 功能/ ./ 为了/ 实现/ 上述/ 丰富/ 的/ 网络管理/ 功能/ ,/ 带内/ 网络管理/ 硬件/ 大致/ 需要/ 提供/ 4/ 种/ 基本功能/ :/ (/ 1/ )/ 寄存器/ 访问/ ./ 支持/ 对/ 网络/ 芯片/ 的/ 配置/ 和/ 状态/ 寄存器/ 进行/ 按址/ 访问/ ./ 同时/ ,/ 网络/ 芯片/ 及其/ 端口/ 拥有/ 保存/ 其/ 标识/ 信息/ 的/ 配置/ 寄存器/ ,/ 而且/ 相连/ 芯片/ 端口/ 能够/ 自动/ 获得/ 对方/ 芯片/ 和/ 端口/ 标识/ 信息/ ./ NRC/ 的/ 路由表/ 表项/ 可/ 采用/ 间接/ 地址/ 方式/ 访问/ ,/ 即/ 通过/ 读写/ NRC/ 的/ 路由表/ 配置/ 寄存器/ 而/ 访问/ 路由表/ 表项/ ;/ (/ 2/ )/ E2prom/ 访问/ ./ 支持/ 保存/ 网络/ 芯片/ 配置/ 参数/ 的/ E2prom/ 存储器/ 进行/ 按址/ 访问/ ./ E2prom/ 中/ 存储/ 了/ 网络/ 芯片/ 所有/ 配置/ 寄存器/ 以及/ 路由表/ 的/ 默认值/ ,/ 芯片/ 加电后/ 可/ 自动/ 从/ E2prom/ 中/ 读取/ 配置/ 参数/ 对/ 芯片/ 进行/ 配置/ ;/ (/ 3/ )/ 故障/ 主动/ 报告/ ./ 支持/ 网络/ 芯片/ 主动/ 向/ 管理/ 服务器/ 报告/ 故障/ 信息/ ,/ 支持/ 通过/ 相关/ 配置/ 寄存器/ 对/ 故障/ 主动/ 报告/ 行为/ 进行/ 控制/ ;/ (/ 4/ )/ 链路/ 级/ BIST/ ./ 支持/ 对/ 网络/ 端口/ 链路/ 质量/ 进行/ 测试/ ,/ 支持/ 通过/ 访问/ 网络/ 芯片/ 相关/ 配置/ 寄存器/ 对/ 测试/ 过程/ 进行/ 控制/ (/ 例如/ 测试/ 的/ 启动/ 与/ 停止/ 、/ 测试/ 时间/ 、/ 测试/ 强度/ 等/ )/ ,/ 支持/ 通过/ 访问/ 网络/ 芯片/ 相关/ 状态/ 寄存器/ 获取/ 测试/ 结果/ ./ 3.2/ 网络管理/ 总体/ 结构/ 为了/ 实现/ 上述/ 网络管理/ 功能/ ,/ TH/ -/ 2/ 互连/ 网络/ 主要/ 采用/ 带内/ 网络管理/ 技术/ ,/ 即/ 对/ 网络/ 芯片/ 寄存器/ 访问/ 、/ E2prom/ 访问/ 、/ 芯片/ 故障/ 的/ 主动/ 报告/ 、/ 链路/ 自测试/ 的/ 启动/ 和/ 测试/ 结果/ 收集/ 直接/ 依赖于/ 连接/ 在/ 网络/ 中/ 的/ 管理/ 服务器/ 与/ 网络/ 芯片/ 进行/ 交互/ 实现/ ,/ 而且/ 交互/ 过程/ 主要/ 体现/ 为/ 发送/ 和/ 接收/ 管理/ 报文/ ./ 具体/ 而言/ ,/ 寄存器/ 和/ E2prom/ 访问/ 是/ 管理/ 服务器/ 向/ 网络/ 芯片/ 发送/ 管理/ 请求/ 报文/ ,/ 而/ 网络/ 芯片/ 向/ 管理/ 服务器/ 应答/ 管理/ 响应/ 报文/ 实现/ ./ 管理/ 请求/ 报文/ 可/ 携带/ 所/ 要/ 访问/ 对象/ 的/ 地址/ 和/ // 或/ 数据/ 信息/ ,/ 响应/ 报文/ 主要/ 携带/ 管理/ 请求/ 的/ 完成/ 情况/ 和/ // 或/ 数据/ 信息/ ./ 故障/ 主动/ 报告/ 和/ 链路/ 自测试/ 功能/ 的/ 配置/ 和/ 启动/ 都/ 可/ 通过/ 管理/ 服务器/ 向/ 网络/ 芯片/ 发送/ 管理/ 请求/ 报文/ 实现/ ./ 芯片/ 发生/ 故障/ 时/ 可/ 主动/ 地向/ 管理/ 服务器发送/ 携带/ 故障/ 编码/ 信息/ 的/ 管理/ 报文/ ./ TH/ -/ 2/ 系统/ 带内/ 网络管理/ 的/ 总体/ 结构/ 如图/ 2/ 所示/ ./ 在/ 该/ 结构/ 中/ ,/ 每个/ NRC/ 和/ NIC/ 芯片/ 中/ 实现/ 网络管理/ 代理/ 模块/ (/ NetworkManagementAgent/ ,/ NMA/ )/ ,/ 该/ 模块/ 首要/ 功能/ 是/ :/ 接收/ 管理/ 请求/ 报文/ ,/ 并/ 根据/ 报文/ 内容/ 做/ 相应/ 处理/ (/ 例如/ 读/ 或/ 写/ 寄存器/ )/ ,/ 然后/ 根据/ 请求/ 报文/ 处理结果/ 构造/ 管理/ 响应/ 报文/ ./ NMA/ 模块/ 还/ 可以/ 根据/ 配置/ 主动/ 产生/ 管理/ 报文/ 并/ 向/ 管理/ 服务器发送/ ./ 运行/ 在/ 网络管理/ 服务器/ (/ NM/ -/ Server/ )/ 上/ 的/ 管理程序/ 负责/ 将/ 用户/ 的/ 网络管理/ 命令/ 或/ 操作/ 转换/ 为/ 单个/ 或/ 多个/ 管理/ 请求/ 报文/ ,/ 并/ 通过/ 服务器/ 的/ NIC/ 注入/ 互连/ 网络/ ./ 用户/ 通过/ 网络管理/ 客户端/ (/ NM/ -/ Client/ )/ 主机/ 使用/ 网络管理/ 接口/ ,/ 即/ 登录/ 管理/ 服务器/ 并/ 使用/ 命令行/ 接口/ (/ CommandLineInterface/ ,/ CLI/ )/ 或/ 使用/ 本地/ 主机/ 的/ 图形化/ 用户/ 管理/ 界面/ (/ GraphicUserInterface/ ,/ GUI/ )/ 实现/ 对/ 网络系统/ 的/ 管理/ ./ 对于/ 规模/ 较大/ 的/ 互连/ 网络/ ,/ 可/ 设置/ 多个/ 管理/ 服务器/ 分别/ 管理/ 逻辑/ 隔离/ 的/ 区域/ (/ 简称/ 为/ 管理/ 区间/ )/ ./ 单个/ 管理/ 客户端/ 可以/ 通过/ 不同/ 的/ 管理/ 服务器/ 访问/ 不同/ 的/ 管理/ 区间/ ./ Page5/ 图/ 2/ 带内/ 网络管理/ 总体/ 结构/ 3.3/ 网络管理/ 描述符/ 格式/ TH/ -/ 2/ 互连/ 网络/ 带内/ 网络管理/ 使用/ 长度/ 固定/ 为/ 4/ 个/ Flit/ 的/ 管理/ 报文/ ./ Flit/ 定义/ 为/ 该/ 网络/ 数据/ 链路层/ 所/ 传输/ 的/ 长度/ ,/ 固定/ 为/ 198/ 位/ 宽/ 的/ 数据/ 单元/ ./ 管理/ 报文/ 的/ 头/ Flit/ 包含/ 了/ 管理/ 报文/ 使用/ 的/ VC/ 、/ 报文/ 长度/ 、/ 路由/ 跳步/ 数等/ 信息/ ,/ 其尾/ Flit/ 包含/ 了/ 覆盖/ 报文/ 关键/ 信息/ 域/ 的/ CRC/ 信息/ ,/ 用于/ 实现/ 数据/ 链路层/ 的/ 可靠/ 传输/ ./ 该/ 互连/ 网络/ 共/ 实现/ 了/ 6/ 个/ VC/ ,/ 分别/ 为/ VC0/ ~/ VC5/ ./ 管理/ 报文/ 单独/ 使用/ VC3/ ./ 管理/ 请求/ 报文/ 是/ NIC/ 硬件/ 逻辑/ 根据/ 用户/ 提交/ 到/ SDQ/ 中/ 的/ 管理/ 报文/ 描述符/ 生成/ 的/ ./ 管理/ 描述符/ 长度/ 为/ 512/ 位/ ,/ 图/ 3/ 给出/ 了/ 管理/ 描述符/ 的/ 格式/ 定义/ ./ 其位域/ 信息/ 简单/ 介绍/ 如下/ :/ (/ 1/ )/ DestID/ ./ 目的/ 网络/ 芯片/ 图/ 3/ 网络管理/ 描述符/ 格式/ 的/ ID/ ./ 如果/ 向/ 没有/ 配置/ ID/ 信息/ 的/ 网络/ 芯片/ 发送/ 管理/ 请求/ 报文/ ,/ 则/ 需要/ 将/ 该域/ 设置/ 为/ 全/ “/ 1/ ”/ ,/ 否则/ 将/ 被/ 目的/ 网络/ 芯片/ 检查/ 为/ 错误/ 报文/ 而/ 丢弃/ ;/ (/ 2/ )/ DestVP/ ./ 运行/ 在/ 管理/ 服务器/ 的/ 管理程序/ 接收/ 该/ 描述符/ 相应/ 管理/ 响应/ 报文/ 的/ VP/ 号/ ;/ (/ 3/ )/ SrcVP/ ./ 运行/ 在/ 管理/ 服务器/ 的/ 管理程序/ 发送/ 管理/ 请求/ 报文/ 所/ 使用/ 的/ VP/ 号/ ;/ (/ 4/ )/ DestType/ ./ 芯片/ 类型/ ,/ 用于/ 区分/ NIC/ 和/ NRC/ 两种/ 芯片/ ;/ (/ 5/ )/ RtType/ ./ 报文/ 路由/ 类型/ ./ 管理/ 报文/ 采用/ 源/ 路由/ ,/ 区别/ 于/ 数据/ 报文/ 所/ 采用/ 的/ 分布式/ 查表/ 路由/ ;/ (/ 6/ )/ Fen/ ./ 强/ 阻塞/ 执行/ 标记/ ./ “/ 0/ ”/ 表示/ 非/ 阻塞/ 执行/ ,/ “/ 1/ ”/ 表示/ 当且/ 仅/ 当前/ 一/ 描述符/ 执行/ 完毕/ 才/ 执行/ 该/ 描述符/ ;/ (/ 7/ )/ Err/ ./ 描述符/ 错误/ 标志/ ./ 对/ 描述符/ 进行/ 检查/ ,/ 如果/ 发现/ 描述符/ 格式/ 错误/ ,/ 则/ 置位/ ;/ (/ 8/ )/ Type/ 、/ S/ // M/ 、/ Page6Inst/ ./ 这/ 3/ 个/ 位域/ 用于/ 区分/ 各种/ 传输层/ 报文/ (/ 例如/ 立即/ 数/ 报文/ MP/ 、/ 集合/ 通信/ 控制/ 报文/ CP/ 等/ )/ ,/ 管理/ 报文/ 被/ 视为/ 是/ 一种/ 特殊/ 的/ MP/ 报文/ ;/ (/ 9/ )/ Lint/ ./ 源端/ 中断/ 控制/ 位/ ,/ 决定/ 管理/ 报文/ 是否/ 在/ 源端/ 产生/ 完成/ 中断/ ;/ (/ 10/ )/ Rint/ ./ 目的/ 端/ 中断/ 控制/ 位/ ,/ 决定/ 管理/ 报文/ 到达/ 目的/ 端后/ 是否/ 产生/ MPQ/ 非/ 空中/ 断/ ;/ (/ 11/ )/ Head/ ./ 描述符/ 标识/ ;/ (/ 12/ )/ TransactionID/ ./ 用于/ 标识/ 请求/ 响应/ 报文/ 间/ 的/ 对应/ 关系/ 的/ 事务/ 号/ ,/ 其/ 范围/ 为/ 0/ ~/ 216/ -/ 1/ ./ FRoutingFieldF/ 和/ BRoutingFieldF/ 是/ 管理/ 报文/ 的/ 路由/ 域/ ./ 其中/ ,/ FRoutingFieldF/ 表示/ 从/ 管理/ 服务器/ 向/ 目的/ 网络/ 芯片/ 传输/ 管理/ 报文/ 所用/ 的/ 路由/ 域/ ,/ 而/ BRoutingFieldF/ 表示/ 从/ 目标/ 网络/ 芯片/ 向/ 管理/ 服务器/ 传输/ 管理/ 报文/ 所用/ 的/ 路由/ 域/ ./ 路由/ 域/ 的/ 格式/ 定义/ 为/ 〈/ HopNum/ ,/ Hop0/ ,/ Hop1/ ,/ …/ ,/ Hop19/ 〉/ ,/ 每一/ 跳步/ 的/ NRC/ 芯片/ 输出/ 端口/ Hopi/ 和/ 有效/ 跳步/ 数/ HopNum/ 都/ 用/ 5/ 位/ 表示/ ,/ 整个/ 路由/ 域/ 总长度/ 为/ 105/ 位/ ./ 在/ 管理/ 报文/ 描述符/ 中/ ,/ 用于/ 网络/ 芯片/ 的/ NMA/ 模块/ 进行/ 解释/ 执行/ 和/ 信息反馈/ 的/ 域/ 为/ NMPType/ 和/ NMPData/ ./ 其中/ ,/ NMPType/ 域/ 为/ 6/ 位/ ,/ 共/ 定义/ 了/ 11/ 种/ 可用/ 类型/ ,/ 包括/ :/ (/ 1/ )/ 寄存器/ 访问/ 5/ 种/ :/ 分为/ 寄存器/ 读/ 请求/ 、/ 寄存器/ 读/ 响应/ 、/ 寄存器/ 写/ 请求/ 、/ 寄存器/ 写/ 响应/ 和/ 寄存器/ 访问/ 请求/ 报文/ 错误/ 的/ 响应/ 报文/ ;/ (/ 2/ )/ E2prom/ 访问/ 类型/ :/ 也/ 分为/ 5/ 种/ ,/ 分别/ 与/ 寄存器/ 访问/ 报文/ 相对/ 应/ ;/ (/ 3/ )/ 故障/ 主动/ 报告/ 类型/ 报文/ ./ 请求/ 报文/ 错误/ 的/ 响应/ 报文/ 是/ NMA/ 检查/ 到/ 请求/ 报文/ 错误/ 而/ 产生/ 的/ ,/ 其/ 目的/ 是/ 向/ 管理/ 服务器/ 报告/ 请求/ 报文/ 错误/ 原因/ ,/ 例如/ 访问/ 地址/ 越界/ 等/ ./ 在/ TH/ -/ 2/ 互连/ 网络/ 中/ ,/ NIC/ 和/ HNR/ 芯片/ 的/ 寄存器/ 值均/ 设计/ 为/ 64/ 位/ ,/ 其/ 地址/ 分别/ 为/ 12/ 位/ 和/ 15/ 位/ ,/ E2prom/ 选用/ 了/ 64KB/ 容量/ ,/ 其/ 每/ 字节/ 项/ 的/ 索引/ 地址/ 为/ 16/ 位/ ./ 根据/ 最大化/ 硬件资源/ 利用/ 和/ 为/ 上层/ 软件/ 提供/ 灵活性/ 的/ 原则/ ,/ 每个/ 寄存器/ 访问/ 管理/ 报文/ 可/ 访问/ 1/ ~/ 2/ 个/ 寄存器/ ,/ 每个/ E2prom/ 访问/ 管理/ 报文/ 可/ 访问/ 1/ ~/ 6/ 个/ 字节/ 项/ ./ 3.4/ 管理/ 报文/ 的/ 数据流/ 3.4/ ./ 1/ 管理/ 程序接口/ 基于/ NIC/ 硬件/ ,/ 我们/ 实现/ 了/ GLEX/ (/ GalaxyExpress/ )/ 通信/ 软件系统/ ,/ 为/ 其他/ 应用软件/ 提供/ 了/ 基础/ 的/ 消息传递/ 框架/ ./ GLEX/ 由/ 用户/ 级/ 编程/ 接口/ 库/ Libglex/ ,/ 内核模块/ gdev/ ,/ TCP/ // IP/ 驱动/ gnet/ ,/ PXE/ 驱动/ gpxenet/ 和/ 一些/ 管理工具/ 组成/ ./ 为了/ 将/ 数量/ 较少/ 的/ 高性能/ HDQ/ 资源分配/ 给/ 应用软件/ 使用/ ,/ GLEX/ 限定/ 了/ 只能/ 通过/ SDQ/ 提交/ 管理/ 描述符/ ./ GLEX/ 为/ 发送/ 管理/ 请求/ 报文/ 和/ 接收/ 管理/ 响应/ 报文/ 提供/ 了/ 如下/ 两个/ 基本/ 函数/ :/ 犵/ 犾/ 犲/ 狓/ _/ 狉/ 犲/ 狋/ _/ 狋/ 犵/ 犾/ 犲/ 狓/ _/ 狊/ 犲/ 狀/ 犱/ _/ 犿/ 犵/ 犿/ 狋/ _/ 狉/ 犲/ 狇/ (/ 犵/ 犾/ 犲/ 狓/ _/ 犲/ 狆/ _/ 犺/ 犪/ 狀/ 犱/ 犾/ 犲/ _/ 狋/ 犲/ 狆/ ,/ 狊/ 狋/ 狉/ 狌/ 犮/ 狋/ 犵/ 犾/ 犲/ 狓/ _/ 犿/ 犵/ 犿/ 狋/ _/ 犻/ 狀/ 犳/ 狅/ / 狉/ 犲/ 狇/ ,/ 犻/ 狀/ 狋/ 32/ _/ 狋/ 犳/ 犾/ 犪/ 犵/ )/ ;/ 犵/ 犾/ 犲/ 狓/ _/ 狉/ 犲/ 狋/ _/ 狋/ 犵/ 犾/ 犲/ 狓/ _/ 狉/ 犲/ 犮/ 犲/ 犻/ 狏/ 犲/ _/ 犿/ 犵/ 犿/ 狋/ _/ 犪/ 犮/ 犽/ (/ 犵/ 犾/ 犲/ 狓/ _/ 犲/ 狆/ _/ 犺/ 犪/ 狀/ 犱/ 犾/ 犲/ _/ 狋/ 犲/ 狆/ ,/ 犻/ 狀/ 狋/ 32/ _/ 狋/ 狋/ 犻/ 犿/ 犲/ 狅/ 狌/ 狋/ ,/ 狊/ 狋/ 狉/ 狌/ 犮/ 狋/ 犵/ 犾/ 犲/ 狓/ _/ 犿/ 犵/ 犿/ 狋/ _/ 犻/ 狀/ 犳/ 狅/ / 犪/ 犮/ 犽/ )/ ;/ 其中/ ,/ ep/ 表示/ 系统/ 通信/ 端点/ ,/ 每个/ MPI/ 进程/ 只能/ 使用/ 单个/ ep/ ,/ 而且/ 在/ 使用/ 前/ 需要/ 通过/ 调用/ glex/ _/ create/ _/ ep/ (/ )/ 函数/ 进行/ 创建/ ,/ 使用/ 结束/ 后/ 通过/ 调用/ glex/ _/ destroy/ _/ ep/ (/ )/ 函数/ 进行/ 释放/ ./ Flag/ 标记/ 可以/ 用来/ 控制/ 管理/ 报文/ 的/ 处理/ 行为/ ,/ 例如/ 是否/ 需要/ 阻塞/ 执行/ 、/ 是否/ 以/ 中断/ 方法/ 从/ MPQ/ 中/ 获取/ 报文/ 等/ ./ Req/ _/ timeout/ 用来/ 指定/ 接收/ 管理/ 响应/ 报文/ 的/ 超时/ 时间/ ./ 由于/ 管理/ 报文/ 通过/ 高速/ 互连/ 网络/ 传输/ ,/ 其/ 请求/ 响应/ 时间/ 非常/ 短/ (/ 可/ 参见/ 下文/ 评测/ 结果/ )/ ,/ 所以/ req/ _/ timeout/ 通常/ 设置/ 为/ 1/ 秒/ ./ Structglex/ _/ mgmt/ _/ info/ 是/ 在/ 内存/ 中/ 存放/ 管理/ 请求/ 和/ 响应/ 报文/ 的/ 公共/ 数据结构/ ,/ 该/ 结构/ 涵盖/ 了/ 各种/ 管理/ 报文/ 的/ 信息/ 域/ ./ Glex/ _/ ret/ _/ t/ 为/ 函数/ 执行/ 后/ 的/ 返回/ 码/ ./ 3.4/ ./ 2/ 管理/ 报文/ 在/ NIC/ 中/ 的/ 数据流/ 针对/ 管理/ 报文/ ,/ NIC/ 芯片/ 需要/ 实现/ 4/ 方面/ 数据流/ 的/ 处理/ :/ (/ 1/ )/ 主机/ 产生/ 的/ 管理/ 请求/ 报文/ ./ 由/ 管理程序/ 向/ SDQ/ 提交/ 管理/ 描述符/ 后/ ,/ 经过/ NIC/ 的/ 描述符/ 队列/ 管理/ 与/ 仲裁/ 、/ 描述符/ 分发/ 等/ 模块/ 处理/ 后/ 进入/ MP/ 发送/ 处理部件/ ./ 该/ 部件/ 根据/ 描述符/ 携带/ 的/ 相关/ 信息/ 构造/ 管理/ 报文/ 头/ ,/ 再/ 经过/ 发送/ 仲裁/ 与/ 报文/ 变换/ 模块/ 将/ 管理/ 报文/ 转换/ 为/ 链路层/ 的/ Flit/ ,/ 然后/ 通过/ 数据/ 链路层/ (/ LinkLevelProtocols/ ,/ LLP/ )/ 发送到/ 物理层/ ;/ (/ 2/ )/ 到达/ NIC/ -/ NMA/ 的/ 管理/ 请求/ 报文/ ./ 从/ LLP/ 层/ 接收/ 到/ 的/ 管理/ 报文/ 经过/ NIC/ 的/ 报文/ 变换/ 与/ 分发/ 模块/ 后/ ,/ 进入/ 管理/ 请求/ 报文/ 接收/ FIFO/ ./ NIC/ -/ NMA/ 模块/ 从/ 该/ FIFO/ 中/ 读取/ 管理/ 请求/ 报文/ 进行/ 处理/ ;/ (/ 3/ )/ NIC/ -/ NMA/ 产生/ 的/ 管理/ 响应/ 报文/ ./ NIC/ -/ NMA/ 处理/ 管理/ 请求/ 后/ 产生/ 的/ 管理/ 应答/ 报文/ ,/ 或/ 主动/ 产生/ 的/ 故障/ 报告/ 报文/ 进入/ 管理/ 响应/ 报文/ 的/ 发送/ FIFO/ ,/ 等待/ 发送/ 仲裁/ 与/ 报文/ 变换/ 模块/ 将/ 管理/ 报文/ 转换/ 为/ 链路层/ 的/ Flit/ ,/ 然后/ 经过/ LLP/ 层/ 发送到/ 物理层/ ;/ (/ 4/ )/ 达到/ 主机/ 的/ 管理/ 响应/ 报文/ ./ 从/ LLP/ 层/ 接收/ 到/ 的/ 管理/ 报文/ 经过/ NIC/ 的/ 报文/ 变换/ 与/ 分发/ 模块/ 后/ ,/ 进入/ RDMA/ 读/ 响应/ // 管理/ 响应/ 接收/ FIFO/ ,/ 再/ 经过/ DMA/ 写/ 管理/ 、/ MP/ 接收/ 队列/ 管理/ 模块/ 的/ 处理/ 后/ ,/ 进入/ 主机/ 内存/ 中/ 属于/ 特定/ VP/ 的/ MPQ/ 中/ ,/ 从而/ 通过/ 硬件/ 中断/ 或/ 被动/ 查询/ 的/ 方式/ 由/ 管理软件/ 获取/ 并/ 处理/ ./ Page7/ 图/ 4/ 给出/ 了/ NIC/ 芯片/ 处理/ 管理/ 报文/ 的/ 数据流/ ./ 可见/ ,/ NIC/ 为了/ 支持/ 带内/ 网络管理/ ,/ 除了/ 需要/ MP/ 处理部件/ 对/ 管理/ 请求/ 报文/ 进行/ 特殊/ 处理/ 外/ ,/ 只/ 需要/ 增图/ 4/ 管理/ 报文/ 在/ NIC/ 中/ 的/ 数据流/ 3.4/ ./ 3/ 管理/ 报文/ 在/ NRC/ 中/ 的/ 数据流/ 针对/ 管理/ 报文/ ,/ NRC/ 芯片/ 需要/ 实现/ 3/ 方面/ 的/ 处理/ :/ (/ 1/ )/ 转发/ 管理/ 报文/ ./ 如果/ 接收/ 到/ 目的/ 为/ 其他/ NRC/ // NIC/ 芯片/ 的/ 管理/ 报文/ ,/ 则/ 直接/ 经过/ 由/ Tile/ 构成/ 的/ NOC/ (/ NetworkonChip/ )/ 网络/ 进行/ 报文交换/ ,/ 并/ 从/ 正确/ 的/ 端口/ 输出/ 到/ 下/ 一/ 跳步/ NRC/ // NIC/ 芯片/ ;/ (/ 2/ )/ 吸收/ 管理/ 报文/ ./ 如果/ 接收/ 到/ 目的/ 为本/ NRC/ 芯片/ 的/ 管理/ 报文/ ,/ 则/ 交给/ 本/ 芯片/ 的/ NRC/ _/ NMA/ 模块/ 进行/ 处理/ ;/ (/ 3/ )/ 产生/ 管理/ 报文/ ./ 本/ NRC/ 芯片/ 产生/ 管理/ 响应/ 报文/ 或/ 主动/ 故障/ 报告/ 报文/ ,/ 并/ 从/ 本/ 芯片/ 的/ 正确/ 端口/ 输出/ 到/ 下/ 一/ 跳步/ NRC/ // NIC/ ./ 图/ 5/ 管理/ 报文/ 在/ NRC/ 中/ 的/ 数据流/ 加/ NIC/ _/ NMA/ 处理/ 模块/ ,/ 该/ 模块/ 处理/ 以本/ 芯片/ 为/ 管理/ 目标/ 芯片/ 的/ 管理/ 请求/ 报文/ ,/ 产生/ 相应/ 的/ 管理/ 响应/ 报文/ ,/ 并/ 在/ 芯片/ 发生/ 故障/ 时/ 主动/ 产生/ 报告/ 报文/ ./ 图/ 5/ 给出/ 了/ NRC/ 芯片/ 转发/ 、/ 吸收/ 和/ 产生/ 管理/ 报文/ 的/ 数据流/ ./ 在/ 实现/ 中/ ,/ 为了/ 节省/ 长线/ 资源/ ,/ 管理/ 报文/ 从/ 输入/ 端口/ 到/ NMA/ 模块/ 和/ 从/ NMA/ 模块/ 到/ 输出/ 端口/ 都/ 采用/ 中继/ (/ RelayStation/ ,/ RS/ )/ 方式/ 实现/ ./ 而且/ ,/ 为/ 进一步/ 降低/ 芯片/ 后/ 端/ 实现/ 的/ 难度/ ,/ 传输/ 管理/ 报文/ Flit/ 采用/ 多/ 拍/ 流水/ 传送/ 方式/ ./ 总体而言/ ,/ RS/ 模块/ 的/ 功能/ 是/ 将/ NOC/ 送来/ 的/ 管理/ 报文/ 传递/ 给/ NMA/ 模块/ ,/ 并/ 将/ NMA/ 送来/ 的/ 管理/ 报文/ 传递/ 到/ 正确/ 的/ 端口/ ./ 对于/ 单个/ RS/ 模块/ 而言/ ,/ 需要/ 处理/ 4/ 个/ 流向/ 的/ 数据/ :/ (/ 1/ )/ 将/ NOC/ 送入/ 的/ 管理/ 报文/ 向/ NMA/ 方向/ 送/ 出/ ;/ (/ 2/ )/ 将/ 左/ 相邻/ RS/ 送入/ 的/ 管理/ 报文/ 向/ NMA/ 方向/ 送/ Page8/ 出/ ;/ (/ 3/ )/ 将/ 右/ 相邻/ RS/ 或/ NMA/ 送入/ 的/ 输出/ 端口/ 为本/ 端口/ 的/ 管理/ 报文/ 向本/ 端口/ LLP/ 层/ 送/ 出/ ;/ (/ 4/ )/ 将/ 右/ 相邻/ RS/ 或/ NMA/ 送入/ 的/ 输出/ 端口/ 不是/ 本/ 端口/ 的/ 管理/ 报文/ 向/ 左/ 相邻/ RS/ 送出/ ./ RS/ 传送/ 管理/ 报文/ 的/ 数据/ 宽度/ 为/ 20/ 位/ ,/ 所以/ 传送/ 管理/ 报文/ 的/ 一个/ Flit/ 需要/ 10/ 个/ 时钟/ 周期/ ,/ 而/ 传送/ 单个/ 管理/ 报文/ 需要/ 40/ 个/ 时钟/ 周期/ ./ NRC/ 芯片/ 设计/ 为/ 24/ 端口/ ,/ 所以/ 需要/ 实例/ 化/ 24/ 个/ RS/ 模块/ ,/ 各个/ RS/ 模块/ 构成/ 的/ 简单/ Mesh/ 结构/ 网络/ ./ 3.5/ 管理/ 报文/ 的/ 处理/ 两款/ 芯片/ NIC/ 和/ NRC/ 对/ 管理/ 报文/ 处理/ 的/ 模块/ 分别/ 为/ NIC/ _/ NMA/ 和/ NRC/ _/ NMA/ ,/ 两个/ 模块/ 在/ 功能/ 实现/ 方面/ 既有/ 共同点/ 又/ 存在/ 差异/ ./ 在/ NRC/ 中/ ,/ 如图/ 6/ 所示/ ,/ 管理/ 报文/ 会/ 从/ RS/ 网络/ 中/ 任意/ 一行/ 的/ 最后/ 一个/ RS/ 模块/ 进入/ NMA/ 模块/ ,/ 该/ 模块/ 首先/ 通过/ nmp/ _/ unpacker/ 子/ 模块/ 对报/ 文解/ 封装/ ,/ 然后/ 由/ nmp/ _/ distributor/ 子/ 模块/ 根据/ 报文/ 类型/ 将/ 其分/ 发给/ 相应/ 的/ 功能/ 处理/ 模块/ ,/ 其/ 处理/ 完成/ 后/ 产生/ 的/ 管理/ 响应/ 报文/ 和/ 主动/ 产生/ 的/ 故障/ 报告/ 报文/ 被/ nmp/ _/ collector/ 子/ 模块/ 收集/ 后/ 进入/ 管理/ 报文/ 输出/ 队列/ nmp/ _/ output/ _/ fifo/ 等待/ 发送/ ,/ 最后/ nmp/ _/ packer/ 从/ 该报/ 文/ 输出/ 队列/ 中/ 取出/ 管理/ 报文/ ,/ 并/ 根据/ 报文/ 路由/ 域/ 指定/ 的/ 当前/ 跳步/ 输出/ 端口/ 将/ 报文/ 发送到/ 正确/ 的/ RS/ 行/ 的/ 相连/ RS/ 模块/ ./ 在/ NIC/ 芯片/ 中/ ,/ 从/ 网络/ 传输/ 而来/ 的/ 管理/ 请求/ 报文/ 被/ 网络接口/ 模块/ 接收/ 后/ ,/ 直接/ 交给/ 该/ 芯片/ 的/ NMA/ 模块/ 进行/ 处理/ ./ 在/ NMA/ 模块/ 中/ ,/ 管理/ 报文/ 首先/ 进入/ 缓冲区/ ,/ 然后/ 根据/ 报文/ 类型/ 将/ 其/ 分派/ 给/ 相应/ 的/ 功能/ 处理/ 模块/ ,/ 接着/ 处理/ 完成/ 产生/ 的/ 管理/ 响应/ 报文/ 以及/ 主动/ 产生/ 的/ 故障/ 报告/ 报文/ 被/ 调度/ 到/ LLP/ 层/ 报文/ 发送/ 模块/ ,/ 最后/ 进入/ 物理层/ 传输/ ./ 除了/ 管理/ 报文/ 接收/ 和/ 发送/ 的/ 接口/ 不同/ 外/ ,/ NMA/ 对/ 管理/ 报文/ 处理/ 以及/ 主动/ 报告/ 报文/ 的/ 产生/ 模块/ 的/ 功能/ 及/ 实现/ 在/ 两款/ 芯片/ 中/ 基本相同/ ./ 这些/ 功能/ 及/ 实现/ 基本相同/ 的/ 子/ 模块/ 简单/ 描述/ 如下/ :/ (/ 1/ )/ nmp/ _/ distributor/ 子/ 模块/ ./ 根据/ 管理/ 请求/ 报文/ NMPType/ 域值/ ,/ 将/ 请求/ 报文/ 分发/ 到/ 相应/ 的/ 功能/ 处理/ 模块/ ;/ (/ 2/ )/ reg/ _/ access/ 子/ 模块/ ./ 解释/ 寄存器/ 访问/ 请求/ 报文/ 内容/ ,/ 并/ 产生/ 寄存器/ 读/ 或/ 写/ 信号/ ,/ 然后/ 根据/ 读出/ 的/ 寄存器/ 数据/ 或/ 写/ 完成/ 情况/ 产生/ 响应/ 报文/ ./ 每个/ 寄存器/ 访问/ 请求/ 报文/ 可以/ 最多/ 可/ 携带/ 两个/ 寄存器/ 访问/ 请求/ ;/ (/ 3/ )/ eep/ _/ access/ 子/ 模块/ ./ 解释/ E2prom/ 访问/ 请求/ 报文/ 内容/ ,/ 并/ 向/ I2C/ 主控制/ 模块/ 产生/ E2prom/ 读/ 或/ 写/ 信号/ ,/ 然后/ 根据/ 读出/ 的/ 数据/ 或/ 写/ 完成/ 情况/ 产生/ 响应/ 报文/ ./ 每个/ E2prom/ 访问/ 请求/ 报文/ 最多/ 可/ 携带/ 6/ 个/ E2prom/ 项/ 访问/ 请求/ ;/ (/ 4/ )/ active/ _/ report/ 子/ 模块/ ./ 根据/ 被/ 监控/ 模块/ 的/ 故障/ 报告/ 信号/ 、/ 报告/ 使能/ 寄存器/ 、/ 故障/ 屏蔽/ 寄存器/ 等/ ,/ 产生/ 故障/ 主动/ 报告/ 报文/ ;/ (/ 5/ )/ nmp/ _/ collector/ 子/ 模块/ ./ 从/ reg/ _/ access/ 、/ eep/ _/ access/ 和/ active/ _/ report/ 子/ 模块/ 收集/ 管理/ 报文/ 并/ 将/ 其/ 交给/ 后续/ 模块/ 进行/ 处理/ ./ 该/ 模块/ 需要/ 对/ 多个/ 模块/ 产生/ 的/ 管理/ 报文/ 并发/ 请求/ 进行/ 仲裁/ ,/ 并/ 以/ 管理/ 报文/ 的/ 4/ 个/ Flit/ 为/ 单位/ 进行/ 发送/ 调度/ ./ 调度/ 采用/ 固定/ 优先级/ 仲裁/ ,/ 且/ 保证/ 管理/ 响应/ 报文/ 比/ 故障/ 主动/ 报告/ 报文/ 具有/ 更/ 高/ 的/ 优先级/ ./ 3.6/ 管理软件/ 的/ 框架/ TH/ -/ 2/ 网络管理/ 软件/ 主要/ 由/ 管理/ 服务器软件/ 和/ 管理/ 客户端/ 软件/ 构成/ ./ 管理/ 服务器软件/ 可以/ 通过/ NIC/ 直接/ 管理/ 高速/ 网络/ ,/ 管理/ 客户端/ 软件/ 通过/ 以太网/ 与/ 网络管理/ 服务器软件/ 通信/ ,/ 而/ 获取/ 高速/ 网络/ 的/ 状态/ ,/ 并/ 能够/ 对/ 网络/ 进行/ 配置管理/ ./ 具体/ 而言/ ,/ 管理/ 服务器软件/ 部署/ 在/ 管理/ 服务器/ 上/ ,/ 实现/ 网络拓扑/ 、/ 网络故障/ 、/ 网络/ 测量/ 的/ 管理/ 与/ 告警/ 推送/ 等/ 功能/ ./ 网络/ 测量/ 功能/ 包括/ 配置/ 策略/ 自动/ 模块/ 和/ 性能/ 分析/ 模块/ ;/ 网络拓扑/ 管理/ 包括/ 拓扑/ 发现/ 、/ 拓扑/ 建模/ ;/ 网络故障/ 管理/ 包括/ 事件/ 采集/ 和/ 故障/ 分析/ ;/ 视图/ 服务/ 接口/ 为/ 管理/ 客户端/ 提供/ 了/ 服务/ 接口/ ./ 管理/ 服务器软件/ 通过/ 发送/ 管理/ 请求/ 报文/ 并/ 接收/ 管理/ 响应/ 报文/ ,/ 获取/ 高速/ 网络/ 的/ 状态/ 信息/ ,/ 并/ 能够/ 对/ 网络/ 进行/ 配置/ ,/ 实现/ 对/ 互连/ 网络/ 的/ 有效/ 管理/ ,/ 支持/ 交换机/ 状态/ 采集/ 和/ 路由/ 静态/ 配置/ 等/ 功能/ ./ 管理/ 客户端/ 软件/ 提供/ 统一/ 的/ 可视化/ 的/ 管理/ 视图/ ,/ 包括/ 拓扑/ 视图/ 、/ 故障/ 视图/ 、/ 设备/ 视图/ 、/ 流量/ 视图/ 和/ 日志/ 视图/ ./ 拓扑/ 视图/ 提供/ 了/ 互连/ 网络/ 物理/ 视图/ 和/ 逻辑/ 视图/ ,/ 网络/ 物理/ 视图/ 提供/ 了/ 物理/ 机柜/ 的/ 部署/ 等/ 图示/ ,/ 逻辑/ 视图/ 提供/ 了/ 网络/ 节点/ 、/ 计算/ 节点/ 、/ 存储/ 节点/ 和/ 服务/ 节点/ 间/ 的/ 连接/ 关系/ 图示/ ,/ 并/ 支持/ 网络/ 分层/ 的/ 拓扑/ 显示/ 功能/ ,/ 支持/ 拓扑/ 视图/ 可/ 编辑/ 功能/ ;/ 故障/ 视图/ 以/ 可视化/ 方式/ 给出/ 网络故障/ 发生/ 时间/ 、/ 告警/ 触发/ 位置/ 、/ 故障/ 原因/ 和/ 故障/ 的/ 严重/ 程度/ 描述/ ;/ 配置/ 视图/ 提供/ 了/ 网络/ 性能/ 配置/ 和/ 路由/ 配置/ 等/ 功能/ ./ 图/ 7/ 给出/ 了/ Page9TH/ -/ 2/ 互连/ 网络管理/ 软件/ 呈现/ 的/ 一个/ 底层/ 交换机/ 的/ 拓扑/ 视图/ ./ 除/ 提供/ 上述/ 图形/ 用户/ 接口/ 外/ ,/ 为了/ 快捷/ 地图/ 7/ 网络管理/ 软件/ 界面/ 示例/ 由于/ 网络/ 监控/ 的/ 重点/ 是/ 链路/ 状态/ (/ 包括/ 链路/ 的/ 握手/ 次数/ 、/ 重传/ 次数/ 、/ 链路/ 宽度/ 、/ 芯片/ 温度/ 等/ )/ ,/ 所以/ 管理/ 客户端/ 软件/ 可/ 采用/ 多种/ 模式/ 监控/ 网络/ 状态/ :/ (/ 1/ )/ 单次/ 模式/ ./ 用户/ 通常/ 只是/ 需要/ 单次/ 查看/ 芯片/ 的/ 状态/ 信息/ ,/ 例如/ 温度/ 信息/ 、/ 链路/ 宽度/ ./ 这类/ 信息/ 的/ 特点/ 是/ 结果/ 相对/ 稳定/ ,/ 变化/ 的/ 幅度/ 和/ 频率/ 较/ 小/ ;/ (/ 2/ )/ 循环/ 模式/ ./ 用户/ 需要/ 连续/ 地/ 查看/ 芯片/ 的/ 状态/ 信息/ ,/ 例如/ 链路/ 握手/ 次数/ ./ 这类/ 信息/ 的/ 特点/ 是/ 在/ 异常情况/ 下/ 变化/ 的/ 幅度/ 和/ 频率/ 可能/ 都/ 较大/ ;/ (/ 3/ )/ 比较/ 模式/ ./ 用户/ 关心/ 芯片/ 状态/ 的/ 变化/ 情况/ ,/ 例如/ 在/ 调试/ 过程/ 中/ 链路/ 的/ 重传/ 次数/ 信息/ ./ 这类/ 信息/ 的/ 特点/ 是/ 其/ 绝对值/ 参考价值/ 较/ 小/ ,/ 而/ 差值/ 更有意义/ ./ 因此/ ,/ 客户端程序/ 需要/ 支持/ 可调/ 的/ 扫描/ 间隔/ ,/ 并/ 自动/ 比较/ 相邻/ 两次/ 扫描/ 结果/ ./ 4/ 性能/ 评测/ 与/ 分析/ 本节/ 将/ 对/ TH/ -/ 2/ 互连/ 网络/ 带内/ 网络管理/ 的/ 性能/ 进行/ 测试/ 与/ 分析/ ./ 实际上/ ,/ TH/ -/ 2/ 互连/ 网络/ 在/ 实现/ 了/ 带/ 内/ 网络管理/ 的/ 同时/ ,/ 还/ 提供/ 了/ 带外/ 网络管理/ 接口/ ./ 这/ 主要/ 考虑/ 到/ 两/ 方面/ 因素/ :/ 一是/ 由于/ 带内/ 管理/ 报文/ 传输/ 依赖于/ 网络/ 自身/ ,/ 所以/ 对于/ 某些/ 特殊/ 情况/ 下/ 的/ 网络/ 参数/ 配置/ 还/ 需要/ 借助/ 带外/ 网络管理/ ,/ 例如/ 为了/ 优化/ 链路/ 质量/ ,/ 对/ 物理层/ HHS/ 的/ FFE/ (/ FeedForwardEqualization/ )/ 参数/ 进行/ 调制/ 等/ ./ 二是/ 充分考虑/ 到/ 大规模/ 互连/ 网络管理/ 的/ 复杂性/ 与/ 重要性/ ,/ 增加/ 网络管理/ 的/ 设计/ 余量/ ,/ 提供/ 多/ 途径/ 的/ 网络管理/ ./ 进行/ 网络/ 调试/ ,/ 管理/ 客户端/ 软件/ 还/ 可以/ 向/ 管理/ 用户/ 提供/ 命令行/ 接口/ ./ 在/ 整个/ 测试/ 过程/ 中/ ,/ 测试/ 对象/ 无论是/ 带内/ 还是/ 带外/ 网络管理/ ,/ 其/ 管理/ 命令/ 都/ 是/ 在/ 连接/ 到/ TH/ -/ 2/ 系统/ 的/ 同一个/ 管理/ 服务器/ 上/ 执行/ ./ 该/ 管理/ 服务器/ 不仅/ 通过/ NIC/ 接入/ TH/ -/ 2/ 高速/ 互连/ 网络/ ,/ 而且/ 通过/ 万兆/ 以太网/ (/ GigabitEthernet/ )/ 接入/ 了/ 带外/ 监控/ 网络/ ./ TH/ -/ 2/ 系统/ 带外/ 监控/ 网络/ 主要/ 依靠/ I2C/ 通路/ 实现/ 系统/ 的/ 配置/ 与/ 监控/ ./ 在/ 具体/ 实现/ 方面/ ,/ 每个/ 计算/ 和/ 通信/ 机框/ 内/ 都/ 有/ 一块/ 嵌入式/ 监控/ 板/ ,/ 该/ 监控/ 板上/ 的/ ARM/ 处理器/ 和/ FLASH/ 存储器/ 等/ 硬件/ 构成/ 一个/ 轻量级/ 嵌入式/ 系统/ ,/ 所有/ 监控/ 板/ 通过/ 以太网/ 相连/ ,/ 并/ 与/ 接入/ 以太网/ 的/ 管理/ 服务器/ 构成/ 带外/ 监控/ 网络/ ./ 管理/ 服务器/ 采用/ 两种/ 方式/ 访问/ 带外/ 监控/ 网络/ ,/ 一是/ 通过/ Telnet/ 登录/ 到/ 监控/ 板子/ 系统管理/ 其/ 所在/ 机框/ 内/ 的/ 部件/ ,/ 二是/ 通过/ 向/ 监控/ 板子/ 系统/ 发送/ 基于/ TCP/ // IP/ 协议/ 传输/ 的/ 带外/ 网络管理/ 报文/ 进行/ 管理/ ./ 在/ 最终/ 定型/ 的/ 管理/ 体系结构/ 中/ ,/ 带外/ 网络管理/ 主要/ 负责/ 机框/ 内/ 计算/ 板/ 和/ 交换/ 板/ 的/ 加切/ 电/ 和/ 硬/ 复位/ 操作/ ,/ 同时/ 负责/ 对板/ 上/ 温度/ 和/ 电压/ 的/ 监控/ ;/ 带内/ 网络管理/ 主要/ 负责/ 网络/ 芯片/ 的/ 配置/ 与/ 监控/ 等/ ./ 网络管理/ 操作/ 延迟/ 是/ 评价/ 大规模/ 高速/ 互连/ 网络管理/ 的/ 性能/ 的/ 重要/ 指标/ 之一/ [/ 13/ ]/ ./ 因此/ ,/ 本节/ 对/ TH/ -/ 2/ 互连/ 网络/ 的/ 带/ 内/ 和/ 带外/ 两种/ 网络管理/ 方式/ 进行/ 寄存器/ 访问/ 、/ E2prom/ 访问/ 、/ 全网/ 拓扑/ 发现/ 的/ 延迟/ 性能/ 做/ 了/ 对比/ 测试/ ./ 此外/ ,/ 由于/ 带内/ 网管/ 占用/ 数据传输/ 通道/ ,/ 本节/ 还/ 对/ 带/ 内/ 管理/ 对/ 网络/ 性能/ 的/ 影响/ 进行/ 了/ 理论/ 分析/ ./ 最后/ ,/ 测试/ 了/ TH/ -/ 2/ 系统/ 带内/ 网络管理/ 对/ 上/ Page10/ 一代/ 系统/ 带外/ 网络管理/ 的/ 性能/ 改善/ 情况/ ./ 4.1/ 寄存器/ 访问/ 性能/ 测试/ 首先/ ,/ 我们/ 对比/ 测试/ 了/ 带/ 内/ 和/ 带外/ 的/ 寄存器/ 访问/ 性能/ ./ 对于/ 带内/ 网络管理/ 而言/ ,/ 我们/ 先行/ 测试/ 了/ 访问/ 与/ 管理/ 服务器/ 直连/ NRC/ 寄存器/ 的/ 性能/ ./ 由于/ 上层/ 管理软件/ 及其/ 底层/ 驱动程序/ 存在/ 访问/ 开销/ 并会/ 带来/ 测量误差/ ,/ 所以/ 性能/ 测试/ 过程/ 采取/ 多次/ 测量/ 求/ 平均值/ 的/ 方法/ ./ 具体/ 而言/ ,/ 带内/ 网络管理/ 上层/ 软件/ 在/ 构造/ 了/ 管理/ 报文/ 并/ 通过/ glex/ _/ create/ _/ ep/ (/ )/ 函数/ 申请/ 到/ 硬件/ VP/ 资源/ 后/ ,/ 连续/ N/ 次/ 执行/ 如下/ 操作/ 事务/ :/ (/ 1/ )/ 通过/ glex/ _/ send/ _/ mgmt/ _/ req/ (/ )/ 函数/ 发送/ 管理/ 请求/ 报文/ ;/ (/ 2/ )/ 等待/ 该/ 请求/ 报文/ 相应/ 的/ 管理/ 响应/ 报文/ 达到/ ,/ 然后/ 通过/ glex/ _/ receive/ _/ mgmt/ _/ ack/ (/ )/ 函数/ 接收/ 管理/ 响应/ 报文/ ./ 在/ 上述/ N/ 次/ 请求/ —/ 响应/ 事务/ 串行/ 执行/ 完后/ 再/ 释放/ VP/ 资源/ ./ 该/ 过程/ 避免/ 了/ VP/ 资源/ 申请/ 与/ 释放/ 带来/ 的/ 额外/ 延迟/ 开销/ ./ 对于/ 带外/ 网络管理/ 而图/ 8/ 单/ 跳步/ 寄存器/ 访问/ 性能/ 测试/ 结果/ 图/ 8/ (/ d/ )/ 给出/ 了/ 带/ 内/ 网络管理/ 单次/ 事务/ 访问/ 两个/ 寄存器/ 的/ 性能/ 测试/ 结果/ ./ 可见/ :/ (/ 1/ )/ 各种/ 情况/ 的/ 寄存器/ 访问/ 平均/ 延迟/ 都/ 随着/ 循环/ 测试/ 次数/ N/ 的/ 增加/ 而/ 降低/ ;/ (/ 2/ )/ 单次/ 写/ 两个/ 寄存器/ 与/ 单个/ 寄存器/ 的/ 延迟/ 基本相同/ ;/ (/ 3/ )/ 单次/ 读/ 两个/ 寄存器/ 的/ 延迟/ 比读/ 单个/ 寄存器/ 的/ 延迟/ 长/ ,/ 但/ 前者/ 小于/ 后者/ 的/ 2/ 倍/ ./ 究其原因/ ,/ NMA/ 模块/ 在/ 接收/ 到/ 寄存器/ 写/ 请求/ 报文/ 后/ 立即/ 返回/ 言/ ,/ 也/ 采取/ 了/ 类似/ 方法/ 降低/ 额外/ 通信/ 开销/ ,/ 限于/ 篇幅/ 不再/ 赘述/ ./ 在/ 文中/ 的/ 各/ 实验/ 中/ ,/ 除了/ 特别/ 说明/ 是/ 在/ 网络/ 处于/ 繁忙/ 状态/ 下/ 测试/ 之外/ ,/ 对/ 带/ 内/ 管理/ 的/ 性能/ 测试/ 都/ 是/ 在/ 网络/ 处于/ 空闲/ 状态/ 下/ 进行/ 的/ ./ 图/ 8/ (/ a/ )/ ~/ (/ c/ )/ 给出/ 了/ 带/ 内/ 和/ 带外/ 方式/ 访问/ 寄存器/ 的/ 性能/ 对比/ 测试/ 结果/ ./ 测试/ 过程/ 中/ ,/ 寄存器/ 访问/ 操作/ 分为/ 读/ 和/ 写/ ;/ 每个/ 请求/ —/ 响应/ 事务/ 只/ 访问/ 单个/ 64/ 位/ 的/ 寄存器/ ;/ 每次/ 访问/ 对象/ 固定/ 为/ 某个/ 常用/ 的/ 链路/ 状态/ 寄存器/ ./ 可见/ :/ (/ 1/ )/ 随着/ 循环/ 测试/ 次数/ N/ 的/ 不断/ 增加/ ,/ 带内/ 与/ 带外/ 方式/ 单/ 次访问/ 单个/ 寄存器/ 的/ 时间/ 趋于稳定/ ;/ (/ 2/ )/ 寄存器/ 的/ 带/ 内/ 访问/ 的/ 延迟/ 远/ 低于/ 带外/ 访问/ 延迟/ ./ 例如/ 在/ 循环/ 测试/ 次数/ N/ =/ 1000/ 次时/ ,/ 带内/ 和/ 带/ 外读/ 寄存器/ 的/ 延迟/ 分别/ 为/ 6.73/ μ/ s/ 和/ 4816.66/ μ/ s/ ,/ 后者/ 大约/ 是/ 前者/ 的/ 716/ 倍/ ;/ (/ 3/ )/ 寄存器/ 的/ 带/ 外读/ 延迟/ 与/ 带外/ 写/ 延迟/ 基本/ 相等/ ,/ 寄存器/ 的/ 带/ 内/ 写/ 延迟/ 略微/ 低于/ 带内读/ 延迟/ ./ 寄存器/ 写/ 响应/ 报文/ ,/ 而/ 不用/ 等待/ 寄存器/ 写/ 操作/ 完成/ ,/ 而/ 在/ 接收/ 到/ 寄存器/ 读/ 请求/ 报文/ 后必/ 需要/ 等待/ 寄存器/ 读/ 操作/ 完成/ 后/ 才能/ 返回/ 携带/ 寄存器/ 值/ 的/ 读/ 响应/ 报文/ ./ 带内/ 方式/ 访问/ 寄存器/ 的/ 性能/ 远远/ 高于/ 带外/ 方式/ ,/ 其/ 主要/ 原因/ 在于/ :/ 带外/ 的/ I2C/ 是/ 一种/ 低速/ 总线/ ,/ 其/ 串行/ 的/ 8/ 位/ 双向/ 数据/ 传输速率/ 在/ 标准/ 模式/ 下仅/ 有/ 100kbps/ [/ 1/ ]/ ,/ 其/ 带宽/ 远远/ 低于/ 直接/ 使用/ 互连/ 网络/ 高/ Page11/ 速/ 链路/ 的/ 带/ 内/ 方式/ ./ 使用/ 低速/ 的/ 带外/ 方式/ 管理/ 管理/ 高速/ 互连/ 网络/ 已经/ 难以/ 适应/ 超级/ 计算/ 系统/ 互连/ 规模/ 不断/ 增大/ 的/ 发展趋势/ ./ 4.2/ E2prom/ 访问/ 性能/ 测试/ 在/ TH/ -/ 2/ 互连/ 网络/ 中/ ,/ 两种/ 网络/ 芯片/ 的/ 配置/ 参数/ 都/ 是/ 保存/ 在/ E2prom/ 存储器/ 中/ ,/ 而且/ 系统/ 中/ 每个/ 网络/ 芯片/ 对应/ 一个/ E2prom/ ./ 系统/ 选择/ 的/ E2prom/ 容量/ 为/ 64KB/ ,/ 地址/ 长度/ 为/ 16/ 位/ ,/ 每个/ 地址/ 存储/ 单字节/ 数据/ ./ 与/ 寄存器/ 访问/ 相同/ ,/ 对/ E2prom/ 的/ 访问/ 也/ 可/ 采用/ 带内/ 和/ 带外/ 两种/ 方式/ ./ 为了/ 全面/ 比较/ 两种/ 方式/ 访问/ E2prom/ 的/ 性能/ ,/ 本/ 实验/ 首先/ 测试/ 了/ 各种/ 方式/ 下/ 的/ E2prom/ 读写/ 的/ 性能/ ,/ 且/ 每次/ 读写/ 的/ 目标/ 都/ 是/ E2prom/ 存储器/ 的/ 单字节/ 数据/ ./ 图/ 9/ 给出/ 了/ N/ 次/ 循环/ 测试/ 的/ 性能/ 对比/ 结图/ 9E2prom/ 访问/ 性能/ 测试/ 结果/ 由于/ 带内/ 访问/ E2prom/ 的/ 每个/ 管理/ 请求/ 报文/ 最多/ 可/ 携带/ 6/ 个/ 独立/ 的/ 地址/ ,/ 而/ 相应/ 的/ 管理/ 响应/ 报文/ 可/ 携带/ 6KB/ 的/ 数据/ ./ 为了/ 进一步/ 全面/ 了解/ 带内/ 访问/ E2prom/ 的/ 性能/ ,/ 本/ 实验/ 将/ 管理/ 请求/ 报文/ 携带/ 的/ E2prom/ 单元/ 地址/ 数从/ 1/ 变化/ 到/ 6/ ,/ 并/ 统计/ 各种/ 循环/ 测试/ 次数/ 下/ 的/ 平均/ 访问/ 延迟/ ,/ 其/ 测试/ 结果/ 如图/ 9/ (/ c/ )/ 和/ (/ d/ )/ 所示/ ./ 可见/ ,/ 单次/ E2prom/ 访问/ 的/ 延迟/ 随着/ 访问/ 字节数/ 的/ 增加/ 而/ 线性/ 增长/ ./ 具体/ 而言/ ,/ 在/ 管理/ 请求/ 报文/ 中/ 每/ 增加/ 1/ 个/ 访问/ 地址/ ,/ 其读/ 和/ 写访问/ E2prom/ 的/ 延迟/ 分别/ 增加/ 约/ 150/ μ/ s/ 和/ 3000/ μ/ s/ ./ 果/ ,/ 其中/ 图/ 9/ (/ a/ )/ 为/ N/ 的/ 取值/ 从/ 1/ ~/ 10/ (/ 步长/ 为/ 1/ )/ 的/ 测试/ 结果/ ,/ 图/ 9/ (/ b/ )/ 为/ N/ 的/ 取值/ 从/ 10/ ~/ 100/ (/ 步长/ 为/ 10/ )/ 的/ 测试/ 结果/ ./ 可见/ ,/ 在/ 单/ 次访问/ E2prom/ 时/ ,/ 带内读/ 和/ 写/ E2prom/ 的/ 延迟/ 基本一致/ ,/ 带外/ 读/ 和/ 写/ E2prom/ 的/ 延迟/ 也/ 基本一致/ ,/ 这/ 主要/ 是因为/ 上层/ 管理软件/ 及其/ 驱动程序/ 的/ 访问/ 开销/ 隐藏/ 了/ 底层/ 硬件/ 的/ 读/ 或/ 写访问/ E2prom/ 的/ 延迟/ 差异/ ./ 但是/ ,/ 随着/ 循环/ 访问/ 次数/ N/ 的/ 增加/ ,/ 各种/ 访问/ 方式/ 的/ 延迟/ 很快/ 趋于稳定/ ;/ 稳定/ 情况/ 下/ 各种/ 操作/ 方式/ 的/ 延迟/ 对比/ 结果/ 为/ :/ 带外/ 写/ / 带内/ 写/ >/ 带外/ 读/ / 带内读/ ./ 与/ 寄存器/ 访问/ 相比/ ,/ 即使/ 以带/ 内/ 方式/ 访问/ E2prom/ ,/ 其/ 访问/ 延迟/ 非常/ 大/ ,/ 这/ 是因为/ :/ E2prom/ 存储器/ 通常/ 只/ 提供/ I2C/ 接口/ ,/ NMA/ 模块/ 通过/ I2C/ 接口/ 访问/ 该/ 存储器/ 成为/ 了/ 带/ 内/ 访问/ E2prom/ 性能/ 瓶颈/ ./ 4.3/ 跳步/ 数/ 敏感性/ 测试/ 带内/ 网络管理/ 的/ 管理/ 报文/ 是/ 通过/ 高速/ 互连/ 网络/ 自身/ 传输/ 的/ ,/ 而/ 网络/ 传输/ 距离/ (/ 网络/ 跳步/ 数/ )/ 将会/ 影响/ 报文/ 的/ 传输/ 延迟/ ,/ 所以/ 寄存器/ 和/ E2prom/ 的/ 访问/ 延迟/ 必然/ 受到/ 网络/ 跳步/ 数/ 的/ 影响/ ./ 由于/ 网络/ 传输/ 管理/ 报文/ 时/ ,/ 并/ 不/ 区分/ 管理/ 报文/ 的/ 种类/ ,/ 所以/ 为了/ 了解/ 带内/ 访问/ 延迟/ 对/ 网络/ 跳步/ 数/ 的/ 敏感性/ ,/ 只/ 需要/ 测量/ 各种/ 跳步/ 数/ 情况/ 下/ 的/ 寄存器/ 访问/ 延迟/ 即可/ ./ 在/ TH/ -/ 2/ 互连/ 网络/ 中/ ,/ 网络/ 最大/ 跳步/ 数为/ 9/ 跳/ ,/ 而/ 通过/ 带内/ 访问/ NRC/ 芯片/ 的/ 最大/ 跳步/ 数为/ 8/ 跳/ ./ 本/ 实验/ 在/ TH/ -/ 2/ 互连/ 网络/ 中/ 选择/ 距离/ 测试/ 所用/ 管理/ 服务器/ Page12/ 的/ 网络/ 跳步/ 数/ 分别/ 为/ 从/ 0/ ~/ 8/ 的/ NRC/ 芯片/ 进行/ 访问/ ./ 为了/ 降低/ 软件/ 开销/ 和/ 测量误差/ ,/ 带内/ 网络管理/ 在/ 每种/ 网络/ 距离/ 情况/ 下读/ 单个/ 寄存器/ 的/ 循环/ 测试/ 次数/ 均/ 设置/ 为/ 1000/ 次/ ./ 测试/ 结果/ 如图/ 10/ 所示/ ,/ 可见/ 寄存器/ 访问/ 延迟/ 随着/ 网络/ 跳步/ 数/ 的/ 增加/ 基本/ 呈现/ 线性/ 增长/ ./ 通过/ 进一步/ 分析/ 与/ 计算/ 测试/ 结果/ 可知/ ,/ 带内/ 管理/ 报文/ 传输/ 单个/ 网络/ 跳步/ 的/ 双向/ 延迟/ 约/ 为/ 0.8762/ μ/ s/ ./ 如果/ 将/ 管理/ 请求/ —/ 响应/ 事务/ 时间/ 简单/ 建模/ 为/ 管理/ 报文/ 传输/ 延迟/ 与/ 管理/ 报文/ 处理/ 延迟/ 之/ 和/ ,/ 则/ 可/ 给出/ 带内/ 网络管理/ 访问/ 寄存器/ 和/ E2prom/ (/ 假设/ 只/ 考虑/ 每个/ 管理/ 报文/ 访问/ 单个/ 寄存器/ 或/ E2prom/ 项/ 的/ 情况/ )/ 延迟/ 的/ 近似/ 模型/ 为/ 带/ 内/ 访问/ 延迟/ =/ 管理/ 报文/ 处理/ 延迟/ +/ (/ 跳步/ 数/ +/ 1/ )/ ×/ 管理/ 报文/ 单跳/ 双向/ 传输/ 延迟/ ./ 则/ 根据/ 以上/ 各/ 实验/ 的/ 相关/ 测试/ 结果/ 可知/ ,/ 寄存器/ 访问/ 管理/ 报文/ 的/ 处理/ 延迟/ 大约/ 为/ 5.9597/ μ/ s/ ,/ E2prom/ 访问/ 管理/ 报文/ 的/ 处理/ 延迟/ 大约/ 为/ 157.8260/ μ/ s/ ./ 4.4/ 拓扑/ 发现/ 性能/ 测试/ TH/ -/ 2/ 互连/ 网络拓扑/ 发现/ 过程/ 简单/ 描述/ 为/ :/ 从/ 管理/ 服务器/ 的/ NIC/ 芯片/ 开始/ 探索/ 与/ 之/ 相连/ 的/ NRC/ 芯片/ ,/ 并/ 构建/ 指向/ 该/ NRC/ 芯片/ 的/ 源/ 路由表/ (/ 在/ 管理/ 服务器/ 内存/ 中/ 分配/ 的/ 用来/ 记录/ 管理/ 服务器/ 与/ 各个/ 网络/ 芯片/ 间/ 往返/ 路由/ 路径/ 的/ 数据结构/ )/ 表项/ ,/ 访问/ 该/ NRC/ 芯片/ 各个/ 端口/ 所/ 记录/ 的/ 对方/ 端口/ 的/ 标记/ 信息/ (/ 该/ 信息/ 记录/ 对方/ 端口/ 的/ 芯片/ 类型/ 、/ 芯片/ 编号/ 和/ 端口/ 编号/ 等/ )/ ,/ 并/ 根据/ 标记/ 信息/ 分/ 情况/ 处理/ :/ (/ 1/ )/ 若该/ 端口/ 连接/ NIC/ 芯片/ ,/ 则/ 记录/ 与/ 该/ NIC/ 芯片/ 的/ 邻接/ 关系/ ;/ (/ 2/ )/ 若该/ 端口/ 连接/ NRC/ 芯片/ ,/ 且/ 未记录/ 与/ 该/ 芯片/ 的/ 邻接/ 关系/ ,/ 则/ 将/ 该/ NRC/ 芯片/ 加入/ 队列/ 等待/ 处理/ 并/ 记录/ 与/ 该/ 芯片/ 的/ 邻接/ 关系/ ;/ (/ 3/ )/ 若该/ 端口/ 连接/ NRC/ 芯片/ ,/ 且/ 已/ 记录/ 与/ 该/ 芯片/ 的/ 邻接/ 关系/ ,/ 则/ 无需/ 重复/ 处理/ ;/ (/ 4/ )/ 当/ 队列/ 非空/ 的/ ,/ 则/ 依次/ 获取/ NRC/ 的/ 芯片/ 编号/ ,/ 构建/ 访问/ NRC/ 芯片/ 的/ 源/ 路由表/ ,/ 并/ 重复/ 上述/ 端口扫描/ 过程/ ./ 在/ 正常/ 情况/ 下/ ,/ 当队/ 列为/ 空时/ ,/ 意味着/ 整个/ 互连/ 网络系统/ 的/ 拓扑/ 结构/ 发现/ 过程/ 结束/ ./ 此时/ ,/ 不但/ 构造/ 了/ 访问/ 系统/ 中/ 任意/ 网络/ 芯片/ 的/ 源/ 路由表/ ,/ 而且/ 所有/ 网络/ 芯片/ 端口/ 间/ 的/ 邻接/ 关系/ 也/ 已经/ 记录/ 完成/ ./ TH/ -/ 2/ 互连/ 网络系统/ 共/ 5856/ 块/ NRC/ 芯片/ 和/ 18304/ 块/ NIC/ 芯片/ ,/ 本/ 实验/ 将/ 统计/ 基于/ 带内/ 管理/ 的/ 拓扑/ 发现/ 的/ 性能/ ./ 由于/ 网络/ 闲忙/ 状态/ 影响/ 管理/ 报文/ 传输/ 延迟/ ,/ 本/ 实验/ 分为/ 两种/ 情况/ 进行/ :/ (/ 1/ )/ 网络/ 处于/ 空闲/ 状态/ ,/ 即/ 系统/ 所有/ 计算/ 节点/ 为/ idle/ 状态/ ;/ (/ 2/ )/ 网络/ 处于/ 繁忙/ 状态/ ,/ 即将/ 系统/ 中/ 18304/ 个/ 计算/ 节点/ 分为/ 数目/ 基本/ 相等/ 的/ 8/ 组/ ,/ 对/ 每组/ 节点/ 持续/ 进行/ 组内/ AlltoAll/ 通信/ 测试/ ./ 本/ 实验/ 分别/ 测试/ 了/ 两种/ 情况/ 下/ 的/ 拓扑/ 发现/ 耗用/ 的/ 时间/ ,/ 且/ 对/ 每种/ 情况/ 分别/ 测试/ 20/ 次/ ./ 图/ 11/ 给出/ 了/ 拓扑/ 发现/ 的/ 性能/ 测试/ 结果/ ./ 在/ 网络/ 空闲/ 和/ 繁忙/ 时/ ,/ 拓扑/ 发现/ 的/ 平均/ 时间/ 分别/ 为/ 472822/ μ/ s/ 和/ 490885/ μ/ s/ ,/ 后者/ 比/ 前者/ 只/ 增加/ 了/ 约/ 3.8/ %/ ./ 可见/ ,/ 基于/ 带内/ 的/ 网络拓扑/ 发现/ 非常/ 高效/ ,/ 发现/ TH/ -/ 2/ 系统/ 所有/ 网络/ 芯片/ 低于/ 500ms/ ,/ 而且/ 网络/ 的/ 繁忙/ 状态/ 对/ 管理/ 报文/ 传输/ 性能/ 影响/ 非常/ 小/ ./ 4.5/ 对/ 网络/ 性能/ 的/ 影响/ 分析/ 管理/ 报文/ 与/ 数据/ 报文/ 的/ 传输/ 共享/ 底层/ 物理/ 链路/ ,/ 因此/ 带内/ 管理/ 不可避免/ 的/ 会/ 影响/ 网络/ 数据传输/ 性能/ ./ 为了/ 进一步/ 评估/ 带内/ 管理/ 对/ 网络/ 性能/ 的/ 影响/ 程度/ ,/ 我们/ 首先/ 对此/ 进行/ 理论/ 分析/ ./ 假设/ 对/ TH/ -/ 2/ 互连/ 网络/ 5856/ 块/ NRC/ 芯片/ 执行/ 一次/ 状态/ 扫描/ 过程/ ./ 带内/ 管理/ 采用/ 请求/ -/ 响应/ 模式/ 对/ 管理/ 报文/ 进行/ 流控/ ./ 在/ 读取/ 每个/ NRC/ 芯片/ 状态/ 时/ ,/ 再/ 假设/ 每个/ 端口/ 读取/ 10/ 个/ 状态/ 寄存器/ ,/ 则/ 扫描/ 单个/ NRC/ 共/ 需要/ 发送/ 120/ 个/ 管理/ 请求/ 报文/ ./ 根据/ 4.1/ 节/ 的/ 实验/ ,/ 带内读/ 寄存器/ 的/ 硬件/ 延迟/ 约/ 为/ 6.73/ μ/ s/ ,/ 而/ 从/ 生成/ 管理/ 请求/ 描述符/ 、/ 发送/ 管理/ 请求/ 报/ ,/ 到/ 接收/ 相应/ 的/ 管理/ 响应/ 报文/ ,/ 整个/ 过程/ 的/ 延迟/ 大约/ 为/ 7.40/ μ/ s/ ./ 根据/ 4.3/ 节/ 的/ 实验/ ,/ 单个/ 网络/ 跳/ Page13/ 步/ 的/ 双向/ 延迟/ 大约/ 为/ 0.88/ μ/ s/ ./ 表/ 1/ 给出/ 了/ TH/ -/ 2/ 系统/ 带内/ 网络管理/ 某次/ 拓扑/ 发现/ 的/ 所有/ NRC/ 距离/ 管理/ 服务器/ 的/ 网络/ 跳步/ 统计/ 情况/ ./ 跳步/ 数/ (/ hop/ )/ 数量/ (/ Amount/ )/ 跳步/ 数/ (/ hop/ )/ 数量/ (/ Amount/ )/ 01234/ 全/ 系统/ 状态/ 扫描时间/ 为/ 系统/ 中/ 每个/ NRC/ 状态/ 扫描时间/ 之/ 和/ ,/ 而/ 每个/ NRC/ 状态/ 扫描时间/ 约等于/ 管理/ 请求/ 处理/ 延迟/ 与/ 管理/ 报文/ 传输/ 延迟/ 之/ 和/ ./ 根据/ 以上/ 参数/ 可/ 计算/ 扫描/ 整个/ 系统/ NRC/ 状态/ 的/ 时间/ (/ 表示/ 为/ Timescan/ )/ 的/ 方法/ 如式/ (/ 1/ )/ 所示/ ,/ 其中/ M/ 表示/ 扫描/ 每个/ NRC/ 所/ 需/ 的/ 请求/ -/ 响应/ 事务/ 数目/ ;/ Ri/ 表示/ 编号/ 为/ i/ 的/ NRC/ 芯片/ ;/ k/ 为/ 系统/ 中/ NRC/ 芯片/ 的/ 总数/ ;/ P/ (/ Ri/ )/ 表示/ 芯片/ Ri/ 对/ 管理/ 请求/ 报文/ 的/ 处理/ 延迟/ ;/ T/ (/ Ri/ )/ 表示/ 访问/ 芯片/ Ri/ 时/ 管理/ 报文/ 的/ 双向/ 传输/ 延迟/ ./ 对于/ TH/ -/ 2/ 系统/ 而言/ ,/ k/ =/ 5856/ ,/ M/ =/ 120/ ./ 式/ (/ 1/ )/ 第/ 2/ 步骤/ 中/ 的/ DP/ 和/ DT/ 分别/ 表示/ 管理/ 请求/ 报文/ 处理/ 延迟/ 和/ 单/ 跳/ 双向/ 传输/ 延迟/ ,/ TH/ -/ 2/ 系统/ 的/ DP/ 和/ DT/ 分别/ 取值/ 为/ 7.40/ μ/ s/ 和/ 0.88/ μ/ s/ ;/ Amount/ (/ hop/ )/ 表示/ 系统/ 中距离/ 管理/ 服务器/ 网络/ 跳步/ 数/ 等于/ hop/ 的/ NRC/ 芯片/ 的/ 数目/ ,/ 其/ 统计/ 情况/ 如表/ 1/ 所示/ ./ 由此/ ,/ 可/ 计算/ 出带/ 内/ 网络管理/ 扫描/ TH/ -/ 2/ 网络系统/ 所有/ NRC/ 芯片/ 的/ 时间/ 约/ 为/ 9.38/ s/ ./ Timescan/ =/ M/ ·/ ∑/ 为了/ 评估/ 带内/ 管理/ 对/ 网络/ 性能/ 的/ 影响/ ,/ 需要/ 进一步/ 计算/ 出/ 扫描/ TH/ -/ 2/ 网络/ 所/ 产生/ 的/ 数据量/ ./ 对于/ 执行/ 一次/ 网络系统/ 状态/ 扫描/ 而言/ ,/ 共/ 访问/ 5856/ 个/ NRC/ ,/ 访问/ 每个/ NRC/ 需要/ 120/ 个/ 请求/ 报文/ 和/ 相应/ 120/ 个/ 响应/ 报文/ ,/ 每个/ 管理/ 报文/ 包含/ 4/ 个/ Flit/ ,/ 每个/ Flit/ 包含/ 198/ 位/ 数据/ ./ 所以/ ,/ 扫描/ 一次/ 网络/ 状态/ 产生/ 的/ 管理/ 报文/ 双向/ 数据量/ 为/ 1.0367/ GB/ ,/ 其/ 平均/ 带宽/ 为/ 0.1105/ Gbps/ ./ TH/ -/ 2/ 网络/ 链路/ 双向/ 带宽/ 为/ 224Gbps/ ,/ 所以/ 即使/ 执行/ 连续/ 的/ 网络/ 状态/ 扫描/ ,/ 带内/ 管理/ 产生/ 的/ 流量/ 在/ 最差/ 情况/ 下/ 也/ 只/ 占/ 网络/ 可用/ 带宽/ 的/ 0.0493/ %/ ./ 实际/ 的/ 带宽/ 测试/ 与/ 系统/ 使用/ 情况/ 也/ 表明/ ,/ 带内/ 网络管理/ 流量/ 对/ 普通/ 数据/ 流量/ 的/ 带宽/ 影响/ 可/ 忽略不计/ ./ 同时/ ,/ 由于/ 网络/ 实现/ 中/ 管理/ 报文/ 比/ 普通/ 数据/ 报文/ 具有/ 更/ 高/ 的/ 调度/ 优先级/ ,/ 所以/ 数据/ 报文/ 流量/ 对/ 网络管理/ 流量/ 的/ 性能/ 影响/ 也/ 非常低/ ./ 4.6/ 与/ TH/ -/ 1A/ 网络管理/ 的/ 比较/ 部署/ 于/ 国家/ 超级/ 计算/ 天津/ 中心/ 的/ “/ 天河/ -/ 1A/ (/ TH/ -/ 1A/ )/ ”/ 是/ TH/ -/ 2/ 的/ 前/ 一代/ 计算/ 系统/ ./ TH/ -/ 1A/ 系统/ 的/ 全/ 定制/ 高速/ 互连/ 网络/ 采用/ 了/ 基于/ I2C/ 的/ 带外/ 网络管理/ ,/ 其/ 管理/ 架构/ 与/ TH/ -/ 2/ 系统/ 互连/ 网络/ 带外/ 管理/ 基本相同/ ./ 与/ TH/ -/ 1A/ 相比/ ,/ TH/ -/ 2/ 网络管理/ 的/ 改进/ 主要/ 体现/ 在/ 3/ 个/ 方面/ :/ (/ 1/ )/ TH/ -/ 2/ 网络/ 芯片/ 增加/ 了/ 大量/ 配置/ 寄存器/ 和/ 状态/ 寄存器/ ,/ 大大/ 增强/ 了/ 可/ 配置/ 性/ 和/ 可/ 观测/ 性/ ;/ (/ 2/ )/ TH/ -/ 2/ 网络/ 芯片/ 中/ 所有/ 寄存器/ 都/ 采用/ 了/ 按址/ 访问/ (/ 常用/ 寄存器/ 采用/ 直接/ 地址/ 访问/ ,/ 而/ 少数/ 寄存器/ 采用/ 间接/ 地址/ 访问/ )/ ,/ 这/ 区别/ 于/ TH/ -/ 1A/ 网络/ 芯片/ 中将/ 所有/ 寄存器/ 串接/ 成/ 扫描/ 链/ 的/ 技术/ ;/ (/ 3/ )/ TH/ -/ 1A/ 只/ 采用/ 了/ 基于/ I2C/ 的/ 带外/ 网络管理/ 方式/ ,/ 而/ TH/ -/ 2/ 采用/ 了/ 带/ 内/ 与/ 带/ 外相/ 结合/ ,/ 并且/ 主要/ 将/ 带/ 内/ 用于/ 网络/ 芯片/ 的/ 配置/ 与/ 监控/ 的/ 网络管理/ 方式/ ./ 为了/ 直观/ 了解/ TH/ -/ 2/ 系统/ 带内/ 网络管理/ 对/ TH/ -/ 1A/ 系统/ 网络/ 带内/ 管理/ 性能/ 的/ 改进/ 情况/ ,/ 我们/ 分别/ 对/ 两个/ 系统/ 的/ 网络管理/ 软件/ 扫描/ 网络/ 状态/ 的/ 时间/ 进行/ 统计/ ./ 每次/ 网络/ 状态/ 扫描/ 需要/ 访问/ 网络/ 中/ 所有/ 物理/ 端口/ 的/ 链路/ 重传/ 计数器/ 并/ 记录/ 使用/ 的/ 时间/ ,/ 每个/ 系统/ 进行/ 10/ 次/ 状态/ 扫描/ ./ 表/ 2/ 给出/ 了/ 两个/ 系统/ 网络/ 状态/ 扫描/ 所/ 访问/ 网络/ 芯片/ 数目/ 、/ 物理/ 端口/ 数目/ 和/ 平均/ 状态/ 扫描时间/ ./ 可见/ ,/ 与/ 带外/ 网络管理/ 相比/ ,/ 带内/ 网络管理/ 显著/ 提高/ 了/ 网络管理/ 效率/ ./ 表/ 2TH/ -/ 1A/ 与/ TH/ -/ 2/ 互连/ 网络管理/ 性能/ 比较/ 系统/ 名称/ NRC/ 数目/ 物理/ 端口/ 数目/ 平均/ 状态/ 扫描时间/ // sTH/ -/ 1ATH/ -/ 25/ 相关/ 研究/ “/ 天河/ ”/ 系列/ 超级计算机/ 由/ 国防科技大学/ 研制/ ./ 第一代/ TH/ -/ 1A/ 计算/ 系统/ 采用/ 了/ CPU/ 和/ GPU/ 相结合/ 的/ 异构/ 融合/ 计算/ 体系结构/ ,/ 并/ 设计/ 了/ 专用/ 的/ 高带宽/ 低/ 延迟/ 互连/ 网络/ 实现/ 了/ 计算/ 与/ 通信/ 的/ 平衡/ ./ 文献/ [/ 14/ ]/ 对/ TH/ -/ 1A/ 计算/ 系统/ 的/ 软硬件/ 结构/ 进行/ 了/ 详细描述/ ./ 文献/ [/ 15/ -/ 16/ ]/ 进一步/ 详细描述/ 了/ TH/ -/ 1A/ 互连/ 网络/ 的/ 消息传递/ 服务/ (/ Message/ -/ PassingService/ )/ 模型/ ./ TH/ -/ 2/ 是/ 第二代/ “/ 天河/ ”/ 计算/ 系统/ ,/ 它/ 使用/ MIC/ 处理器/ 作为/ 计算/ 节点/ 的/ 加速/ 部件/ ,/ 实现/ 了/ 计算/ 性能/ Page14/ 的/ 提升/ ./ TH/ -/ 2/ 计算/ 系统/ 设计/ 了/ NIC/ 和/ NRC/ 两款/ 网络/ 芯片/ 实现/ 了/ 系统/ 的/ 互连/ ./ 文献/ [/ 4/ ,/ 17/ ]/ 对/ 该/ 互连/ 网络/ 的/ 用户/ 级/ 通信/ 机制/ 、/ 集合/ 操作/ 卸载/ 方法/ 、/ 端到/ 端/ 可靠/ 通信/ 实现/ 等/ 方面/ 进行/ 了/ 阐述/ ./ 互连/ 网络/ 的/ 易/ 管理型/ 直接/ 影响/ 超级/ 计算/ 系统/ 的/ 可用性/ ,/ 因此/ 本文/ 重点/ 关注/ 了/ TH/ -/ 2/ 计算/ 系统/ 的/ 互连/ 网络管理/ ,/ 详细描述/ 了/ 带/ 内/ 网络管理/ 的/ 实现/ 与/ 性能/ 评测/ ./ 除了/ “/ 天河/ ”/ 超级/ 计算/ 系统/ 外/ ,/ 世界/ 上/ 一些/ 著名/ 的/ 超级/ 计算/ 系统/ 也/ 采用/ 了/ 专用/ 定制/ 高速/ 互连/ 网络/ ,/ 例如/ IBMBlueGene/ // Q/ [/ 18/ ]/ ,/ FujitsuTofu/ [/ 19/ ]/ ,/ CrayGemini/ [/ 20/ ]/ 等/ ./ 其中/ ,/ Gemini/ 互连/ 网络/ 采用/ 自/ 适应/ 路由/ 传输/ 网络/ 数据/ ,/ 并/ 采用/ 源/ 路由/ 传输/ 用于/ 故障诊断/ 的/ 控制/ 报文/ ./ 作为/ 一种/ 高性能/ 、/ 高/ 可靠/ 的/ 互连/ 网络协议/ ,/ Infiniband/ [/ 21/ ]/ 已经/ 成为/ 高性能/ 计算/ 和/ 云/ 计算/ 领域/ 重要/ 的/ 互连/ 技术/ ./ InfiniBand/ 的/ 子网/ 管理/ 相关/ 研究/ 已经/ 比较/ 成熟/ ,/ 并/ 产生/ 了/ 开放/ 的/ 网络管理/ 软件/ OpenSM/ ./ 文献/ [/ 13/ ,/ 22/ -/ 23/ ]/ 对/ OpenSM/ 网络拓扑/ 发现/ 、/ 路由/ 机制/ 、/ 故障诊断/ 进行/ 了/ 研究/ ./ Mellanox/ 设计/ 的/ FabricIT/ 实现/ 了/ InfiniBand/ 子网/ 管理/ ,/ 支持/ 通道/ 映射/ 、/ 诊断/ 和/ 调试/ 等/ 功能/ ./ 在/ 大规模/ 计算/ 系统管理/ ,/ 特别/ 是/ 集群/ 管理/ 方面/ ,/ 国内外/ 不少/ 研究/ 机构/ 提出/ 了/ 各种/ 监控/ 管理/ 软件架构/ ,/ 例如/ ganglia/ [/ 24/ ]/ 、/ supermon/ [/ 25/ ]/ 和/ parmon/ [/ 26/ ]/ 等/ ./ 这些/ 研究/ 项目/ 重点/ 解决/ 的/ 是/ 大规模/ 计算/ 系统/ 各种/ 软硬件/ 资源/ 及其/ 状态/ 的/ 分布式/ 监控/ 和/ 管理/ 问题/ ./ 在/ 网络管理/ 的/ 功能设计/ 方面/ ,/ 文献/ [/ 10/ -/ 11/ ]/ 分别/ 就/ 拓扑/ 发现/ 和/ 路径/ 追踪/ 进行/ 了/ 深入研究/ ./ 6/ 结论/ 与/ 展望/ 评价/ 互连/ 网络/ 质量/ 的/ 测度/ 主要/ 包括/ 高性能/ 、/ 低功耗/ 、/ 高/ 可靠/ 、/ 易/ 管理/ 等/ ./ 高性能/ 通常/ 指/ 网络/ 的/ 通信/ 带宽/ 高/ 和/ // 或/ 通信/ 延迟/ 低等/ ./ 高性能/ 往往/ 是/ 网络/ 设计/ 追求/ 的/ 首要/ 目标/ ,/ 而易/ 管理/ 却/ 常常/ 由于/ 各种因素/ 而/ 被忽视/ 或/ 未/ 得到/ 足够/ 的/ 重视/ ./ 实际上/ ,/ 忽视/ 网络/ 易/ 管理/ 的/ 重要性/ 得不偿失/ ./ 首先/ ,/ 在/ 网络/ 调试/ 阶段/ ,/ 可管理性/ 差/ 的/ 网络/ 将/ 需要/ 更/ 多/ 的/ 人力/ 和/ 精力/ 投入/ 到/ 网络/ 的/ 调试/ 和/ 测试/ 过程/ ./ 再者/ ,/ 在/ 网络/ 维护/ 过程/ 中/ ,/ 可管理性/ 差/ 的/ 网络/ 需要/ 专业性/ 更强/ 的/ 技术人员/ 从事/ 网络管理/ 和/ 维护/ 工作/ ./ 此外/ ,/ 在/ 网络/ 出现/ 故障/ 的/ 情况/ 下/ ,/ 可管理性/ 差/ 的/ 网络/ 将/ 需要/ 更长/ 的/ 故障/ 定位/ 和/ 处理/ 时间/ ,/ 才能/ 恢复/ 网络/ 的/ 正常/ 运行/ ,/ 这/ 将/ 延长/ 用户/ 作业/ 的/ 完成/ 时间/ 并/ 影响/ 用户/ 体验/ 质量/ ./ TH/ -/ 2/ 超级/ 计算/ 系统/ 采用/ 了/ 基于/ 带内/ 的/ 网络管理/ 技术/ ,/ 取得/ 了/ 良好/ 的/ 实际/ 应用/ 效果/ ./ 本文/ 主要/ 介绍/ 了/ TH/ -/ 2/ 互连/ 网络/ 带内/ 管理/ 的/ 实现/ 与/ 评测/ ./ 下/ 一步/ 相关/ 工作/ 包括/ :/ 一是/ 研究/ 增强型/ 带内/ 管理/ 协议/ ,/ 进一步提高/ 带内/ 网络管理/ 的/ 容错/ 能力/ ;/ 二是/ 将/ 高效/ 的/ 带/ 内/ 网络管理/ 与/ 系统/ 计算/ 资源管理/ 结合/ 起来/ ,/ 在/ 计算/ 资源分配/ 时/ 充分利用/ 带内/ 网络管理/ 可/ 提供/ 的/ 网络/ 状态/ 信息/ ,/ 从而/ 提高/ 系统/ 的/ 可靠性/ 和/ 可用性/ ./ 

