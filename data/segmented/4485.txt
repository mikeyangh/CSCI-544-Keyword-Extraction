Page1FPGA/ +/ DSP/ 异构/ 视频/ 处理/ 系统/ 中/ 基于/ SRIO/ 的/ 数据/ 高效/ 传输/ 方法/ (/ 北京航空航天大学/ 计算机/ 学院/ 数字/ 媒体/ 北京市/ 重点/ 实验室/ 北京/ 100191/ )/ 摘要/ 数据传输/ 一直/ 是/ 影响/ 嵌入式/ 视频/ 系统/ 实时处理/ 能力/ 的/ 关键环节/ ./ 随着/ 视频/ 应用/ 的/ 多路/ 化/ 和/ 高清化/ ,/ 混合/ 多处理器/ 结构/ 已/ 成为/ 嵌入式/ 视频/ 处理/ 系统/ 的/ 主要/ 发展趋势/ ,/ 异构/ 处理器/ 之间/ 数据/ 的/ 高效/ 传输/ 对系统/ 性能/ 的/ 影响/ 变得/ 比/ 以前/ 更加/ 突出/ ./ 文中/ 针对/ FPGA/ +/ DSP/ 异构/ 视频/ 处理/ 系统/ 中/ 的/ 数据传输/ 问题/ ,/ 在/ 分析/ 处理器/ 结构/ 和/ 视频/ 数据格式/ 特征/ 的/ 基础/ 上/ ,/ 提出/ 了/ 一种/ 基于/ 高速/ 串行接口/ SRIO/ (/ SerialRapidI/ // O/ )/ 的/ 数据/ 高效/ 传输/ 方法/ ./ 该/ 方法/ 分别/ 以/ FPGA/ 、/ DSP/ 作为/ 系统/ 的/ 传输/ 、/ 处理/ 核心/ ,/ 在/ FPGA/ 处理器/ 上/ 采用/ 视频/ 三/ 分量/ 数据/ 重组/ 方法/ 并/ 使用/ 包头/ 信息/ 较/ 小/ 的/ SRIO/ 流写/ 事务/ SWRITE/ (/ StreamingWrite/ )/ ,/ 简化/ 视频/ 传输/ 格式/ 的/ 同时/ 提高/ 了/ SRIO/ 视频/ 数据包/ 的/ 传输/ 效率/ ;/ 在/ DSP/ 处理器/ 上/ 通过/ 预定/ 义/ 接收端/ 数据/ 存储单元/ 和/ 采用/ 简洁/ 的/ SRIO/ 门铃/ 事务/ (/ DOORBELL/ )/ 应答/ 机制/ ,/ 节约/ 了/ DSP/ 在/ 传输/ 过程/ 中/ 的/ 时间/ 开销/ ./ 实验/ 结果表明/ ,/ 文中/ 设计/ 的/ SRIO/ 高效/ 传输/ 方法/ 在/ 占用/ 较少/ 的/ FPGA/ 资源/ 的/ 条件/ 下/ 传输速度/ 达/ 理论值/ 的/ 81/ %/ 以上/ ./ 关键词/ FPGA/ +/ DSP/ ;/ 视频/ 数据/ ;/ SRIO/ ;/ 高效/ 传输/ 1/ 引言/ 视频/ 应用领域/ 的/ 快速增长/ 和/ 传感器/ 技术/ 的/ 迅速/ 发展/ 推动/ 了/ 视频/ 时空/ 分辨率/ 的/ 提高/ ,/ 同时/ 也/ 使/ 多路/ 化/ 、/ 高清化/ 成为/ 视频/ 应用/ 发展/ 的/ 一种/ 趋势/ ./ 视频/ 数据量/ 的/ 激增/ 不仅/ 给/ 处理/ 平台/ 的/ 计算能力/ 带来/ 了/ 严峻/ 挑战/ ,/ 同时/ 也/ 给/ 视频/ 处理/ 系统/ 中/ 处理器/ 间/ 数据/ 的/ 高速传输/ 造成/ 了/ 极大/ 困难/ ./ 例如/ ,/ 当/ 使用/ YCbCr420/ 采样/ 格式/ 采集/ 视频/ 数据/ 时/ ,/ 一路/ 分辨率/ 为/ 720/ ×/ 576/ ,/ 帧/ 率/ 为/ 25/ 帧/ // 秒/ 的/ D1/ 数字视频/ 原始数据/ 率约/ 为/ 119Mbps/ ,/ 一路/ 1080P30/ 高清/ 数字视频/ 的/ 原始数据/ 率高达/ 712Mbps/ ./ 因此/ ,/ 在/ 视频/ 处理/ 系统/ 设计/ 中/ 除了/ 要/ 关注/ 处理器/ 的/ 性能/ 和/ 计算能力/ 之外/ ,/ 研究/ 和/ 解决/ 处理器/ 间/ 视频/ 数据/ 的/ 高效/ 传输/ 问题/ 同样/ 重要/ ./ 目前/ ,/ 嵌入式/ 视频/ 处理/ 系统/ 中/ 常用/ 的/ 互连/ 和/ 传输/ 接口/ EMIF/ (/ ExternalMemoryInterface/ )/ 等/ 已/ 难以/ 满足/ 多路/ 或/ 高清/ 视频/ 的/ 大/ 数据量/ 传输/ 需求/ [/ 1/ -/ 3/ ]/ ./ 高速/ 串行接口/ SRIO/ 作为/ RapidIO/ 的/ 一个/ 重要/ 分支/ ,/ 是/ 面向/ 嵌入式/ 系统/ 开发/ 提出/ 的/ 高/ 可靠/ 、/ 高性能/ 、/ 基于/ 包交换/ 的/ 新一代/ 高速/ 互联/ 技术/ ,/ SRIO/ 技术/ 的/ 发展/ 为/ 异构/ 处理器/ 间/ 的/ 高速/ 互联/ 提供/ 了/ 另/ 一种/ 可能/ ./ 特别/ 是/ 近年来/ 推出/ 的/ 数字/ 信号处理器/ (/ DigitalSignalProcessor/ ,/ DSP/ )/ 和/ 现场/ 可编程/ 门阵列/ (/ FieldProgrammableGateArray/ ,/ FPGA/ )/ 等/ 嵌入式/ 处理器/ 普遍/ 集成/ 高速/ 差分/ 串行/ 收发器/ ,/ 很大/ 程度/ 上/ 促进/ 了/ SRIO/ 的/ 发展/ 应用/ [/ 4/ -/ 7/ ]/ ./ 尽管/ SRIO/ 具有/ 可选/ 的/ 1.25/ Gbps/ 、/ 2.5/ Gbps/ 、/ 3.125/ Gbps/ 等/ 多种/ 传输速率/ ,/ 然而/ 这/ 只是/ 理论值/ ,/ 低效/ 的/ 传输/ 机制/ 设计/ 或是/ 繁琐/ 的/ 实现/ 过程/ 都/ 会/ 导致/ 其/ 传输速度/ 的/ 大幅/ 降低/ ./ 例如/ :/ 文献/ [/ 8/ ]/ 基于/ 多核/ DSP/ 设计/ 实现/ 了/ 声纳/ 基阵/ 处理/ 系统/ ,/ 此/ 系统/ 使用/ SRIO/ 的/ 普通/ 读/ 事务/ NREAD/ (/ NormalRead/ )/ 、/ 普通/ 写/ 事务/ NWRITE/ (/ NormalWrite/ )/ 、/ 门铃/ 事务/ DOORBELL/ 以及/ 对/ RapidIO/ 内部/ 寄存器/ 进行/ 操作/ 的/ MAINTENCE/ 事务/ ,/ 传输/ 方法/ 上/ 未加/ 优化/ ,/ 测试/ 1.25/ Gbps/ 工作/ 模式/ 下/ 传输速率/ 约/ 为/ 257Mbps/ ,/ 仅/ 达到/ SRIO/ 理论值/ 的/ 25/ %/ ;/ 文献/ [/ 9/ ]/ 通过/ 在/ FPGA/ 端/ 采用/ 乒乓/ 存储/ 结构/ ,/ 并/ 使用/ 带/ 响应/ 的/ 写/ 事务/ NWRITE/ _/ R/ (/ NormalWritewithResponse/ )/ 与/ DOORBELL/ 等/ SRIO/ 事务/ 设计/ 传输/ 机制/ ,/ 数据/ 率/ 比/ 未加/ 优化/ 的/ 方法/ 有/ 了/ 明显/ 提升/ ,/ 达到/ SRIO/ 理论/ 带宽/ 的/ 74/ %/ ./ 由于/ 现有/ 方法/ 在/ 设计/ SRIO/ 传输/ 机制/ 时/ 缺乏/ 针对/ 视频/ 数据/ 和/ 异构/ 处理器/ 结构/ 特点/ 的/ 考虑/ ,/ 直接/ 采用/ 已有/ 技术/ 难以/ 满足/ 异构/ 视频/ 处理/ 系统/ 中/ 视频/ 的/ 高效/ 传输/ 和/ 处理/ 需求/ ./ 此外/ ,/ 现有/ 视频/ 处理/ 系统/ 大多/ 偏重于/ 功能/ 的/ 实现/ ,/ 硬件资源/ 的/ 开销/ 较大/ ./ 例如/ ,/ 文献/ [/ 10/ ]/ 提出/ 的/ 方法/ 需要/ 为/ FPGA/ 外挂/ 两片/ 同步/ 动态/ 存储器/ SDRAM/ (/ SynchronousDynamicRandomAccessMemory/ )/ ,/ 增加/ 资源/ 占用/ 的/ 同时/ ,/ 加大/ 了/ 系统/ 软硬件/ 设计/ 的/ 复杂度/ ./ 文献/ [/ 11/ ]/ 采用/ 基于/ DSP/ 主动/ 发送数据/ 的/ 传输/ 方案/ ,/ 该/ 方案/ 需要/ FPGA/ 向/ DSP/ 发送/ 中断/ 信号/ 以/ 请求/ 数据/ ,/ 每/ 中断/ 一次/ DSP/ 可以/ 发送/ 1/ // 4/ 帧/ 的/ 视频/ 数据/ ,/ 因此/ 显示/ 一帧/ 视频/ 需要/ 4/ 次/ 中断/ ./ 由于/ DSP/ 在/ 进行/ 视频/ 处理/ 工作/ 的/ 同时/ 还要/ 负责/ 数据传输/ ,/ 无疑/ 加大/ 了/ DSP/ 时间/ 与/ 资源/ 的/ 开销/ ./ 本文/ 在/ 分析/ 视频/ 数据/ 和/ 异构/ 处理器/ 结构/ 特点/ 的/ 基础/ 上/ 提出/ 了/ 一种/ 基于/ SRIO/ 总线/ 的/ 数据/ 高效/ 传输/ 方法/ ./ 该/ 方法/ 通过/ 在/ FPGA/ 处理器/ 上/ 采用/ 视频/ 三/ 分量/ 数据/ 重组/ 方法/ 并/ 使用/ 包头/ 信息/ 较/ 短/ 的/ SWRITE/ 事务/ ,/ 简化/ 视频/ 传输/ 格式/ 的/ 同时/ 提高/ 了/ SRIO/ 上/ 视频/ 数据包/ 的/ 传输/ 效率/ ;/ 在/ DSP/ 处理器/ 上/ 通过/ 预定/ 义/ 接收端/ 数据/ 存储单元/ 和/ 采用/ 简洁/ 的/ DOORBELL/ 应答/ 机制/ ,/ 节约/ 了/ DSP/ 在/ 传输/ 过程/ 中/ 的/ 时间/ 开销/ ./ 本文/ 方法/ 由于/ 仅/ 采用/ SWRITE/ 、/ NREAD/ 和/ DOORBELL/ 这/ 3/ 种/ SRIO/ 事务/ ,/ 减化/ 了/ 实现/ 过程/ 的/ 复杂度/ ./ 此外/ ,/ 由于/ 视频/ 数据/ 是/ 以/ 行为/ 单位/ 在/ FPGA/ 上/ 存储/ 的/ ,/ 并且/ 在/ 存储/ 过程/ 中/ ,/ 采用/ FIFO/ 视频/ 缓冲/ 队列/ 取代/ 资源/ 占用率/ 较/ 高/ 的/ RAM/ ,/ 因此/ 系统对/ FPGA/ 内存/ 资源/ 占用/ 较/ 少/ ,/ 无需/ 外部/ 存储器/ ,/ 降低/ 了/ 软硬件/ 设计/ 的/ 难度/ ./ 实验/ 证明/ ,/ 本文/ 使用/ SRIO/ 单通道/ 并/ 采用/ 1.25/ Gbps/ 工作/ 速度/ ,/ 传输速率/ 达/ 829Mbps/ 以上/ ,/ 可/ 满足/ 六路/ D1/ 视频/ 或/ 一路/ 1080p/ 高清/ 视频/ 的/ 传输/ 需求/ ./ 文中/ 以/ 一路/ D1/ 视频/ 传输/ 为例/ 做出/ 说明/ 及/ 验证/ 方法/ 的/ 可行性/ ./ 本文/ 第/ 2/ 节/ 对系统/ 的/ 整体/ 概况/ 进行/ 描述/ ,/ 包括/ 本文/ 所/ 采用/ 的/ 视频/ 处理/ 系统/ 的/ 结构/ 、/ 视频/ 数据格式/ 的/ 分析/ 、/ SRIO/ 事务/ 类型/ 的/ 介绍/ 以及/ SRIO/ 传输/ 过程/ 的/ 介绍/ 等/ 内容/ ;/ 第/ 3/ 节/ 详细/ 介绍/ 本文/ 提出/ 的/ 异构/ 处理器/ 间/ SRIO/ 高效/ 传输/ 方法/ ,/ 主要/ 分为/ 方法/ 处理/ 流程/ 、/ SRIO/ 高效/ 传输/ 机制/ 设计/ 与/ 方法/ 的/ 实现/ 3/ 个/ 主要/ 部分/ ;/ 第/ 4/ 节/ 首先/ 对/ 实验/ 环境/ 进行/ 介绍/ ,/ 然后/ 分别/ 给出/ 方法/ 的/ SRIO/ 传输速率/ 测试/ 与/ FPGA/ 资源/ 使用/ 情况/ 的/ 相关/ 实验/ 结果/ ./ 2/ 系统/ 概述/ 2.1/ FPGA/ +/ DSP/ 异构/ 视频/ 处理/ 系统结构/ 由于/ 数据/ 计算能力/ 强/ 、/ 功能/ 定制/ 灵活/ ,/ DSP/ 和/ Page3FPGA/ 已/ 成为/ 嵌入式/ 视频/ 处理/ 系统/ 中/ 应用/ 最/ 广泛/ 的/ 两种/ 处理器/ ./ 其中/ ,/ DSP/ 是/ 一种/ 适合/ 进行/ 数字/ 信号处理/ 运算/ 的/ 微处理器/ [/ 12/ ]/ ,/ 主要/ 用来/ 实现/ 各种/ 数字/ 信号处理/ 算法/ ;/ FPGA/ 虽然/ 具有/ 体系结构/ 灵活/ 、/ 集成度/ 高/ 以及/ 适用范围/ 广等/ 特点/ [/ 13/ ]/ ,/ 但/ 相对/ 于/ DSP/ 而言/ ,/ 其/ 算法/ 程序/ 的/ 设计/ 难度/ 大/ 、/ 开发周期/ 较长/ ./ 现有/ 主流/ 的/ 基于/ 多处理器/ 的/ 视频/ 处理/ 系统/ 主要/ 有/ 基于/ DSP/ +/ DSP/ 同构/ 处理器/ 架构/ 和/ FPGA/ +/ DSP/ 异构/ 处理器/ 架构/ 两种/ ./ 相比之下/ ,/ 同构/ 处理器/ 架构/ 在/ 设计/ 上/ 比/ 异构/ 架构/ 下/ 的/ 视频/ 处理/ 系统/ 简单/ ,/ 但是/ 处理器/ 大多/ 只能/ 选择/ 带有/ 视频/ 接口/ 的/ 专用/ DSP/ (/ 例如/ TI/ 的/ DM64/ ×/ 系列/ 和/ DaVinci/ 系列/ )/ ,/ 这/ 类/ 处理器/ 除了/ 具有/ 专用/ 的/ 视频/ 接口/ 外/ ,/ 往往/ 还/ 在/ 内部/ 集成/ 了/ 专用/ 协处理器/ 用于/ 完成/ 标准/ 视频/ 处理/ 算法/ (/ 如/ H/ ./ 265/ 编码/ 算法/ )/ ./ 但/ 由于/ 此类/ 处理器/ 属于/ 半/ 定制/ 类型/ ,/ 其/ 灵活性/ 较差/ 并且/ 对/ 视频/ 处理/ 算法/ 的/ 限制/ 大/ ,/ 因此/ DSP/ +/ DSP/ 同构/ 处理器/ 架构/ 主要/ 面向/ 标准/ 视频/ 处理/ 应用领域/ ./ 而/ FPGA/ +/ DSP/ 异构/ 处理器/ 架构/ 在/ 视频/ 接口/ 的/ 适应性/ 和/ 算法/ 设计/ 的/ 灵活性/ 方面/ 更/ 具有/ 优势/ :/ 首先/ ,/ FPGA/ 作为/ 协处理器/ 可以/ 完成/ 视频/ 接口/ 的/ 扩展/ 、/ 格式/ 转换/ 、/ 预处理/ 和/ 系统/ 的/ 控制/ 工作/ [/ 14/ -/ 17/ ]/ ,/ 由于/ FPGA/ 具有/ 完全/ 可/ 定制/ 的/ 特点/ ,/ 因此/ 在/ 接口/ 设计/ 和协/ 处理/ 方面/ 比/ 同构/ 处理器/ 结构/ 具有/ 更/ 高/ 的/ 灵活性/ ;/ 其次/ ,/ DSP/ 处理器/ 可以/ 从/ 接口/ 和/ 控制/ 任务/ 中/ 脱离/ 出来/ ,/ 只/ 作为/ 主/ 处理器/ 专注/ 于/ 完成/ 大量/ 视频/ 数据/ 的/ 计算/ 和/ 处理/ ./ 此外/ ,/ FPGA/ +/ DSP/ 异构/ 处理器/ 架构/ 下/ 的/ DSP/ 在/ 芯片/ 选择/ 上/ 可以/ 不/ 局限于/ 专用/ DSP/ ,/ 因此/ 能够/ 选用/ 更/ 高性能/ 的/ 通用/ DSP/ 处理器/ ,/ 大大提高/ 了/ 系统/ 的/ 处理/ 能力/ 和/ 算法/ 设计/ 的/ 灵活性/ ./ 本文/ 设计/ 了/ FPGA/ +/ DSP/ 异构/ 视频/ 处理/ 系统/ ./ 在/ 该/ 系统/ 中/ ,/ 根据/ FPGA/ 与/ DSP/ 处理器/ 的/ 各自/ 特点/ ,/ 并/ 综合/ 考虑/ 视频/ 处理/ 系统/ 的/ 常用/ 任务/ 的/ 特点/ 及/ 处理器/ 间/ 负载/ 均衡/ 的/ 要求/ ,/ 对/ 处理/ 任务/ 进行/ 了/ 划分/ ./ 其中/ ,/ FPGA/ 主要/ 用于/ 视频/ 数据/ 的/ 采集/ 、/ 格式/ 转换/ 、/ 预处理/ 、/ 数据传输/ 和/ 逻辑/ 控制/ 等/ 任务/ ;/ DSP/ 主要/ 用于/ 视频/ 的/ 处理/ 、/ 分析/ 和/ 编码/ 等/ 核心/ 工作/ ./ 在/ 存储/ 方面/ ,/ FPGA/ 处理器/ 采用/ 以/ 视频/ 行为/ 单位/ 完成/ 数据/ 采集/ 和/ 预处理/ 的/ 方法/ ,/ 其片/ 上/ 存储资源/ 可以/ 满足/ 需求/ ,/ 避免/ 了/ 增加/ 片/ 外存储器/ ;/ 而/ DSP/ 在/ 计算/ 过程/ 中/ 需要/ 存取/ 大量/ 视频/ 数据/ 和/ 中间/ 处理结果/ ,/ 片内/ 存储/ 远/ 无法/ 满足要求/ ,/ 因此/ 为/ 其/ 设计/ 了/ 专门/ 的/ DDR3/ 片/ 外存储器/ ./ 图/ 1/ 所示/ 的/ FPGA/ +/ DSP/ 混合/ 处理器/ 的/ 硬件/ 结构/ 具有/ 广泛/ 的/ 通用性/ ,/ 可以/ 作为/ 多种/ 视频/ 处理/ 系统/ 的/ 核心/ 硬件/ 单元/ ,/ 例如/ 视频/ 分析/ 、/ 处理/ 和/ 编码/ 系统/ 等/ ./ 图/ 1FPGA/ +/ DSP/ 异构/ 视频/ 处理/ 系统/ 硬件/ 结构/ 2.2/ 视频/ 数据格式/ 视频/ 数据/ 除有/ 一般/ 大/ 数据/ 的/ 规模性/ 和/ 高速性/ 特点/ 外/ ,/ 在结构上/ 还/ 具有/ 独特/ 的/ 规则性/ 和/ 统一性/ ./ 例如/ ,/ 当前/ 普遍/ 采用/ 的/ PAL/ 制式/ ITU/ -/ RBT/ ./ 656/ 数字视频/ 在/ 行/ 和/ 帧/ 结构/ 上/ 就/ 具有/ 严格/ 的/ 规则性/ ./ 图/ 2/ 和/ 图/ 3/ 分别/ 给出/ 了/ 该类/ 数字视频/ 在/ YCbCr422/ 通用/ 采样/ 格式/ 下/ 的/ 行/ 结构/ 和/ 帧/ 结构/ ./ 每个/ 视频/ 行/ 包含/ 了/ 行/ 控制/ 信号/ 和/ 视频/ 数据信号/ 两/ 部分/ ./ 其中/ ,/ 行/ 控制/ 信号/ 为/ 每个/ 视频/ 行/ 起始/ 的/ 288/ 字节/ ,/ 包括/ 前四/ 字节/ 的/ 有效/ 视频/ 结束/ 信号/ EAV/ (/ EndofActiveVideo/ )/ ,/ 280/ 字节/ 的/ 固定/ 填充/ 数据/ ,/ 以及/ 最后/ 4/ 字节/ 的/ 有效/ 视频/ 帧/ 开始/ 信号/ SAV/ (/ StartofActiveVideo/ )/ ;/ 视频/ 数据信号/ 由/ Y/ 、/ Cb/ 、/ Cr3/ 种/ 视频/ 分量/ 构成/ ,/ 每行/ 视频/ 含有/ 720/ 字节/ Y/ ,/ 360/ 字节/ Cb/ 和/ Cr/ ,/ 共/ 1440/ 字节/ ./ 其/ 排列/ 顺序/ 为/ Cb/ ,/ Y/ ,/ Cr/ ,/ Y/ ,/ Cb/ ,/ Y/ ,/ Cr/ ,/ …/ ,/ 其中/ ,/ 前/ 3/ 个/ Cb/ ,/ Y/ ,/ Cr/ 采样/ 的/ 是/ 一个/ 数据/ 点/ 的/ 亮度/ 信号/ 和/ 两个/ 色差/ 信号/ ,/ 而/ 接下来/ Page4/ 的/ Y/ 采样/ 是/ 下/ 一个点/ 的/ 亮度/ 信号/ ,/ 以此类推/ ./ 完整/ 的/ 一帧/ BT/ ./ 656/ 视频/ 数据/ 是/ 由源/ 视频/ 经过/ 行/ 扫描/ 形成/ 的/ 奇场/ 和/ 偶场/ 组成/ ,/ 如图/ 3/ 所示/ ./ PAL/ 制式/ 中/ 第/ 1/ ~/ 312/ 行/ 表示/ 偶场/ ,/ 第/ 313/ ~/ 625/ 行/ 表示/ 奇场/ ,/ 其中/ 有效/ 场为/ 第/ 23/ ~/ 310/ 行/ 和/ 第/ 336/ ~/ 623/ 行/ ,/ 可/ 使用/ SAV/ 和/ EAV/ 中/ 的/ 标志/ 信号/ 来/ 表示/ 有效/ 场/ 和/ 无效/ 场/ ./ 视频/ 数据/ 除了/ 在/ 采集/ 端/ 具有/ 严格/ 的/ 规则性/ 外/ ,/ 在/ 处理过程/ 中/ 对/ 数据/ 也/ 有/ 统一性/ 的/ 要求/ ./ 例如/ ,/ YCbCr420/ 是/ 目前/ 视频/ 处理/ 系统/ 中/ 采用/ 最为/ 广泛/ 的/ 视频格式/ [/ 18/ ]/ ,/ 3/ 种/ 视频/ 分量/ 一般/ 是/ 按/ 帧/ 被/ 依次/ 独立/ 处理/ ./ 因此/ ,/ 在/ 本文/ 视频/ 采集/ 过程/ 中/ ,/ FPGA/ 处理器/ 首先/ 要/ 将/ 按点/ 依次/ 采集/ 的/ YCbCr422/ 视频/ 数据/ 转换/ 为/ 按行/ 和/ 帧/ 排列/ 的/ YCbCr420/ 格式/ ./ 在/ YCbCr422/ 格式/ 中/ ,/ 隔点/ 分别/ 采集/ Cb/ 和/ Cr/ 分量/ ,/ 在/ YCbCr420/ 格式/ 中/ 奇数/ 行隔点/ 采样/ Cb/ 分量/ ,/ 偶数/ 行隔点/ 采样/ Cr/ 分量/ ,/ 如图/ 4/ 所示/ ,/ 图中/ 每个/ 方格/ 代表/ 一个/ 像素点/ ,/ 每个/ 圆形/ 代表/ 一种/ 分量/ ,/ 两种/ 格式/ 中/ 采集/ 所有/ 点/ 的/ Y/ 分量/ ./ 针对/ 视频/ 数据/ 在结构上/ 的/ 规范性/ 特点/ 以及/ 处理/ 上/ 的/ 统一性/ 要求/ ,/ 本文/ 为/ FPGA/ 与/ DSP/ 处理器/ 上/ 的/ 收发/ 缓冲区/ 各自/ 分配/ 3/ 个/ 视频/ 缓冲/ 队列/ ,/ 以/ 实现/ 视频/ 数据/ 三/ 分量/ 的/ 快速/ 分离/ ,/ 并/ 为/ 两/ 处理器/ 上/ 帧/ 数据/ 的/ 高效/ 整合/ 提供/ 了/ 条件/ ./ 首先/ ,/ 在/ 分离/ 过程/ 中/ 同时/ 完成/ 视频格式/ 转换/ 工作/ (/ YCbCr422/ 转为/ YCbCr420/ )/ ,/ 即/ 采集/ 到/ 的/ 视频/ 数据/ 按照/ 奇场/ 和/ 偶场/ 及/ 视频/ 分量/ 顺序/ 依次/ 输入/ ,/ 舍弃/ 奇场/ 中/ Cr/ 数据/ 和/ 偶场/ 中/ Cb/ 数据/ ,/ 剩余/ 视频/ 数据/ 按照/ 分量/ 不同/ 存入/ 对应/ 视频/ 缓冲/ 队列/ ./ 其次/ ,/ 在/ 预定/ 义好/ DSP/ 接收端/ 数据/ 存储/ 地址/ 后/ ,/ 对/ 分离/ 后/ 的/ 视频/ 三/ 分量/ 进行/ 打包/ 传输/ ,/ 使得/ 每种/ 视频/ 分量/ 存到/ DSP/ 指定/ 地址/ 中/ 形成/ 整帧/ 数据结构/ ,/ 从而/ 减少/ DSP/ 计算/ 数据/ 存储/ 地址/ 上/ 的/ 时间/ 开销/ ./ 2.3/ SRIO/ 事务/ 操作/ 为了/ 适应/ 多种类型/ 数据/ 的/ 高速传输/ ,/ SRIO/ 从/ IO/ 逻辑/ (/ InputOutputLogical/ )/ 与/ 消息传递/ (/ MessagePassing/ )/ 两个/ 层面/ 提供/ 了/ 如表/ 1/ 所示/ 的/ 8/ 种/ 事务/ 功能/ ,/ 这些/ 事务/ 涵盖/ 了/ 从/ 原子/ 到/ 数据包/ 的/ 广泛应用/ 方式/ ./ 其中/ ,/ IO/ 逻辑/ 包括/ Atomic/ 、/ NREAD/ 、/ NWRITE/ 、/ NWRITE/ _/ R/ 、/ SWRITE/ 与/ MAINTENANCE/ 几种/ ;/ 消息传递/ 包括/ DOORBELL/ 与/ MESSAGE/ 两种/ ./ SRIO/ 事务/ 名称/ Atomic/ ,/ NREADAtomic/ ,/ NWRITE/ ,/ NWRITE/ _/ RSWRITEMAINTENCEDOORBELLMESSAGEAtomic/ 为/ 原子/ 操作/ ;/ NREAD/ 事务/ 为/ 普通/ 读/ 操作/ ,/ 可以/ 直接/ 从/ 对/ 端/ 内存/ 取数/ ,/ 一包/ 最大/ 为/ 256Bytes/ ;/ 普通/ 写/ 操作/ 有/ NWRITE/ 和/ NWRITE/ _/ R/ 两种/ ,/ 可以/ 直接/ 往/ 对/ 端/ 内存/ 写数/ ,/ 一包/ 最大/ 为/ 256Bytes/ ;/ SWRITE/ 事务/ 具有/ 包头/ 信息/ 短/ 、/ 传输数据/ 是/ 8Bytes/ 的/ 整数倍/ 、/ 长度/ 不能/ 超过/ 256Bytes/ 等/ 特点/ ;/ MAIN/ -/ TENANCE/ 用于/ 对/ RapidIO/ 内部/ 寄存器/ 的/ 读写操作/ ,/ 可以/ 配置/ 整个/ RapidIO/ 网络/ 上/ 各个/ 节点/ 的/ 参数/ ;/ DOORBELL/ 的/ 包头/ 和/ 携带/ 的/ 信息/ 都/ 很/ 短/ ,/ 用于/ 提供/ 一个/ 快速/ 的/ 短消息/ 通知/ ;/ MESSAGE/ 用于/ 传输/ 大/ 数据包/ ,/ 每次/ 最多/ 4KBytes/ 数据/ ./ 在/ 分析/ SRIO/ 事务/ 特点/ 基础/ 上/ ,/ 结合/ 视频/ 处理/ 系统/ 中/ 视频/ 数据/ 的/ 高速传输/ 需求/ ,/ 本文/ 对/ SRIO/ 的/ 传输/ 机制/ 进行/ 了/ 定制/ 和/ 优化/ ./ 在/ SRIO/ 事务/ 选择/ 上/ ,/ 由于/ 系统/ 中/ 需要/ 由/ FPGA/ 读取/ DSP/ 处理/ 后/ 的/ 视频/ 数据/ ,/ 因此/ 选择/ 了/ 常规/ 的/ NREAD/ 事务/ ./ 3/ 种写/ 事务/ 中/ ,/ 尽管/ NWRITE/ _/ R/ 可/ 有效/ 防止/ 数据包/ 的/ 丢失/ ,/ 提高/ 数据包/ 写入/ 的/ 正确率/ ,/ 但是/ 由于/ 本文/ 是/ 通过/ 地址/ 偏移/ 的/ 方式/ 向/ DSP/ 写入/ 视频/ 数据/ 的/ ,/ 该/ 方法/ 不会/ 因为/ 数据包/ 的/ 丢失/ 而/ 造成/ 视频/ 数据/ 的/ 累积/ 错误/ ,/ 因此/ 无需/ 选用/ 设计/ 较为/ 复杂/ 的/ NWRITE/ _/ R/ 事务/ ./ 相比/ NWRITE/ 事务/ ,/ SWRITE/ 写/ 事务/ 具有/ 包头/ 信息/ 短/ 、/ 打包/ 率高及/ 实现/ 简单/ 等/ 特点/ ,/ 因此/ 本文/ SRIO/ 写/ 事务/ 选择/ SWRITE/ 事务/ ./ 由于/ 本/ 系统/ 中/ SRIO/ 仅/ 用于/ 两个/ 异构/ 处理器/ 间/ 点到点/ 的/ 数据传输/ ,/ 并未/ 使用/ SRIO/ 桥/ 芯片/ ,/ 因此/ 无需/ 通过/ MAINTENCE/ 事务/ 修改/ 和/ 维护/ SRIO/ 收发/ 地址/ 等/ 内部/ 寄存器/ ./ 此外/ ,/ 为/ 简化/ SRIO/ 传输/ 过程/ 实现/ 的/ 复杂度/ ,/ 选用/ 简洁/ 的/ DOORBELL/ 事务/ 用于/ 异构/ 处理器/ 间/ 的/ 传输/ 控制/ ./ 综上/ ,/ 本文/ SRIO/ 传输/ 过程/ 中/ 采用/ SWRITE/ 、/ DOOR/ -/ BELL/ 和/ NREAD/ 这/ 3/ 种/ 事务/ ,/ 显著/ 降低/ 了/ 设计/ 实现/ 的/ 复杂度/ ./ 2.4/ SRIO/ 传输/ 过程/ SRIO/ 数据传输/ 过程/ 是/ 基于/ 请求/ 和/ 响应/ 机制/ Page5/ 的/ ./ 发起/ 端/ 请求/ IREQ/ (/ InitiatorRequest/ )/ 是/ 一次/ 事务/ 的/ 开始/ ,/ 用户/ 控制/ IREQ/ 端口/ 组织/ 请求/ 数据包/ ,/ 数据包/ 经过/ SRIO/ 链路/ 发送到/ 目标/ 请求/ 端口/ TREQ/ (/ TargetRequest/ )/ 进行/ 解析/ ,/ 目标/ 端/ 用户/ 控制目标/ 响应/ 端口/ TRESP/ (/ TargetResponse/ )/ 组织/ 响应/ 数据包/ ,/ 数据包/ 经过/ SRIO/ 链路/ 发送/ 回/ 发起/ 端/ 响应/ 端口/ IRESP/ (/ InitiatorResponse/ )/ 解析/ ./ 图/ 5/ 为/ 一次/ 典型/ 的/ 基于/ IP/ 核/ 的/ 端/ 到/ 端/ SRIO/ 传输/ 过程/ 示意图/ ,/ 图中/ 用户/ A/ 发送/ SRIO/ 请求/ 给/ 用户/ B/ (/ 步骤/ (/ 1/ )/ ~/ (/ 3/ )/ )/ ,/ 用户/ B/ 响应/ 用户/ A/ 的/ SRIO/ 请求/ (/ 步骤/ (/ 4/ )/ ~/ (/ 6/ )/ )/ ,/ 具体步骤/ 如下/ :/ (/ 1/ )/ 用户程序/ A/ 控制/ IREQ/ 端口/ 信号/ ,/ 填充/ 请求/ 数据包/ 信息/ ,/ 如包/ 类型/ 等/ ;/ (/ 2/ )/ IP/ 核/ A/ 根据/ 用户/ 填入/ 信息/ 封装/ 为/ SRIO/ 数据包/ 并发/ 送到/ SRIO/ 链路/ ;/ (/ 3/ )/ IP/ 核/ B/ 收到/ 请求/ 数据包/ ,/ 解析/ 后/ 通过/ TREQ/ 端口/ 通知/ 用户程序/ B/ ;/ (/ 4/ )/ 用户程序/ B/ 根据/ 请求/ ,/ 控制/ TRESP/ 端口/ 组织/ 响应/ 数据包/ ,/ 填入/ 响应/ 数据/ ;/ (/ 5/ )/ IP/ 核/ B/ 封装/ 响应/ 数据/ 为/ SRIO/ 响应/ 数据包/ 并发/ 送到/ SRIO/ 链路/ ;/ (/ 6/ )/ IP/ 核/ A/ 收到/ 响应/ 数据包/ ,/ 解析/ 后/ 通过/ IRE/ -/ SP/ 端口/ 通知/ 用户程序/ A/ ,/ 用户程序/ A/ 接收/ 并/ 处理/ 响应/ 数据包/ ./ 3/ 异构/ 处理器/ 间/ SRIO/ 高效/ 传输/ 方法/ 3.1/ 处理/ 流程/ 视频/ 编码器/ 多以/ Y/ 、/ Cb/ 、/ Cr3/ 种/ 视频/ 分量/ 的/ 数据/ 块/ 为/ 单位/ 进行/ 编码/ ./ 为/ 提高/ 编码/ 效率/ ,/ 避免/ 反复/ 搬运/ 数据/ 造成/ DSP/ 处理/ 时间/ 和/ 资源/ 的/ 浪费/ ,/ 本文/ 在/ DSP/ 接收数据/ 时/ ,/ 为/ 其/ 设计/ 了/ 3/ 个/ 接收缓冲区/ 用于/ 视频/ 数据/ 三/ 分量/ 的/ 分离/ ,/ 在/ FPGA/ 端/ 设计/ 3/ 个/ 发送/ 缓冲/ 队列/ 与/ 之/ 对应/ ./ 对于/ 采集/ 的/ 视频/ 数据/ ,/ FPGA/ 首先/ 根据/ 其/ 原始数据/ 的/ Y/ 、/ Cb/ 、/ Cr/ 三/ 通道/ 格式/ 组织/ 并/ 按/ 视频/ 序列/ 流/ 打包/ 生成/ 待/ 发送/ 的/ 数据包/ ,/ 然后/ 采用/ 包头/ 信息/ 较/ 短/ 的/ SWRITE/ 事务/ 实现/ FPGA/ 向/ DSP/ 写/ 数据/ 的/ 操作/ ,/ 不同/ 通道/ 的/ 视频/ 序列/ 直接/ 写入/ DSP/ 端/ 预定/ 义/ 的/ DDR3/ 缓冲区/ ,/ 当/ SWRITE/ 事务/ 操作/ 完成/ 后/ ,/ FPGA/ 发送/ DOORBELL/ 事务/ 通知/ DSP/ 解析/ 视频/ 数据/ 并/ 进行/ 处理/ 计算/ ,/ FPGA/ 向/ DSP/ 发送数据/ 过程/ 如图/ 6/ 所示/ ./ 当/ DSP/ 处理/ 完/ 一帧/ 视频/ 数据/ 后/ ,/ 通过/ EDMA/ (/ EnhancedDirectMemoryAccess/ )/ 将/ 处理/ 后/ 的/ 视频/ 数据/ 搬运/ 到/ DSP/ 端/ DDR3/ 的/ 输出/ 缓冲区/ ,/ 在/ FPGA/ 端/ 设计/ 3/ 个/ 接收/ 缓冲/ 队列/ 与/ 之/ 对应/ ./ 当/ DSP/ 处理/ 完/ 接收/ 到/ 的/ 视频/ 数据/ 后/ ,/ 通过/ 向/ FPGA/ 发送/ DOORBELL/ 事务/ 通知/ FPGA/ 收取/ 处理/ 好/ 的/ 视频/ 数据/ ,/ 最后/ 由/ FPGA/ 通过/ NREAD/ 事务/ 请求/ 读回/ 处理/ 后/ 的/ 视频/ 数据/ ,/ FPGA/ 从/ DSP/ 接收数据/ 过程/ 如图/ 7/ 所示/ ./ 方法/ 以/ FPGA/ 作为/ 传输/ 链路/ 核心/ ,/ DSP/ 作为/ 视频/ 数据处理/ 核心/ ,/ 分别/ 设计/ FPGA/ 和/ DSP/ 端/ SRIO/ 程序/ ,/ 其中/ ,/ FPGA/ 端/ 程序/ 包括/ 发起/ 端/ 请求/ IREQ/ 和/ 发起/ 端/ 响应/ IRESP/ ;/ DSP/ 端/ 程序/ 包括/ 目标/ 端/ 请求/ TREQ/ 和/ 目标/ 端/ 响应/ TRESP/ ./ 如图/ 8/ 所示/ ,/ SRIO/ 传输/ 过程/ 中仅/ 采用/ SWRITE/ 、/ DOORBELL/ 和/ NREAD/ 这/ 3/ 种/ 事务/ ,/ 显著/ 降低/ 了/ 设计/ 实现/ 的/ 复杂度/ ./ 下面/ 就/ SRIO/ 传输/ 机制/ 和/ 方法/ 实现/ 两/ 方面/ 加以/ 详细/ 介绍/ ./ 3.2/ SRIO/ 高效/ 传输/ 机制/ 设计/ 为了/ 实现/ SRIO/ 的/ 高效/ 传输/ ,/ 本文/ 在/ FPGA/ 端/ 首先/ 对/ 采集/ 到/ 的/ 视频/ 数据/ 进行/ 发送/ 前/ 的/ 重新/ 组织/ ,/ Page6/ 如图/ 9/ 所示/ ./ 具体/ 组织/ 过程/ 如下/ ,/ FPGA/ 采集/ 打包/ 格式/ 的/ YCbCr422/ 视频/ 数据/ ,/ 为/ 3/ 种/ 分量/ 设置/ 各自/ 视频/ 缓冲/ 队列/ ,/ 用于/ 分离/ 并/ 暂存/ 视频/ 分量/ ./ 在/ 分离/ 过程/ 的/ 同时/ 完成/ 视频格式/ 转换/ 工作/ (/ YCbCr422/ 转为/ YCbCr420/ )/ ./ 采集/ 到/ 的/ 视频/ 数据/ 按照/ 奇场/ 和/ 偶场/ 及/ 视频/ 分量/ 顺序/ 依次/ 输入/ ,/ 舍弃/ 奇场/ 中/ Cr/ 数据/ 和/ 偶场/ 中/ Cb/ 数据/ ,/ 剩余/ 视频/ 数据/ 按照/ 分量/ 不同/ 存入/ 对应/ 视频/ 缓冲/ 队列/ ./ 当/ 一个/ 完整/ 视频/ 行/ 的/ 分量/ 数据/ 都/ 写入/ 各自/ 视频/ 缓冲/ 队列/ 后/ ,/ 分别/ 读取/ 各/ 视频/ 缓冲/ 队列/ ,/ 以/ 视频/ 行为/ 单位/ 将/ 720/ 字节/ Y/ 分量/ 和/ 360/ 字节/ Cb/ (/ 或/ Cr/ )/ 分量/ 写入/ SRIO/ 发送/ 缓冲/ 队列/ (/ TxFifo/ )/ ./ 至此/ ,/ SRIO/ 发送/ 缓冲/ 队列/ TxFifo/ 中/ 已经/ 存入/ 以/ 平面/ 格式/ 视频/ 行/ L/ 为/ 单位/ 的/ YCbCr420/ 视频/ 数据/ ,/ 等待/ 发送/ ./ 由于/ SRIO/ 链路/ 是/ 以/ 包为/ 单位/ 传输数据/ 的/ ,/ 因此/ 为了/ 提高/ 数据包/ 的/ 传输/ 效率/ ,/ 在/ 数据/ 发送/ 过程/ 中/ 采用/ 包头/ 信息/ 较/ 短/ 的/ SWRITE/ 事务/ ,/ 设置/ 其/ 有效/ 字节/ 为/ SRIO/ 协议/ 所/ 规定/ 的/ 最大/ 字节数/ 256Bytes/ ,/ 此时/ 该/ 事务/ 有效/ 数据/ 打包/ 率为/ 95/ %/ ,/ 能/ 达到/ 最快/ 的/ SRIO/ 写/ 速率/ ./ 在/ 传输/ 过程/ 中/ ,/ 需要/ 为/ 每个/ SWRITE/ 事务/ 包/ 设置/ 特定/ 地址/ 和/ 数据/ 长度/ ,/ 视频/ 数据/ 以/ 行为/ 单位/ 进行/ 循环/ 发送/ ./ 由于/ SRIO/ 数据包/ 最大/ 有效/ 数据/ 载荷/ 为/ 256Bytes/ ,/ 在/ 保证/ 数据完整性/ 并/ 满足/ SWRITE/ 传输数据/ 是/ 8Bytes/ 整数倍/ 要求/ 的/ 前提/ 下/ ,/ 为/ 最大/ 程度/ 提高/ SRIO/ 传输/ 效率/ ,/ 应/ 尽量减少/ 数据包/ 个数/ ./ 因此/ ,/ 本文/ 将/ 720Bytes/ 的/ Y/ 数据/ 划分/ 为/ 3/ 个/ SWRITE/ 包/ ,/ 每包/ 传输/ 240Bytes/ ,/ 包/ 存储/ 地址/ 可以/ 由/ 帧/ 基/ 地址/ 、/ Y/ 分量/ 偏移量/ 和行/ 偏移量/ 计算/ 获得/ ,/ 3/ 个/ 包/ 存储/ 地址/ 连续/ 增加/ ;/ 360/ 字节/ Cb/ (/ 或/ Cr/ )/ 数据/ 采用/ 两个/ SWRITE/ 事务/ 包/ 发送/ ,/ 并/ 规定/ 两个/ 数据包/ 的/ 有效/ 数据/ 长度/ 分别/ 为/ 184Bytes/ 和/ 176Bytes/ ,/ 存储/ 地址/ 由/ 帧/ 基/ 地址/ 、/ Cb/ // Cr/ 分量/ 偏移量/ 和行/ 偏移量/ 计算/ 获得/ ./ 为了/ 提高/ DSP/ 的/ 视频/ 处理/ 效率/ ,/ 在/ 本/ 异构/ 视频/ 处理/ 系统/ 中/ ,/ 采用/ 由/ FPGA/ 发送/ NREAD/ 读/ 请求/ 方式/ 读取/ DSP/ 处理/ 后/ 的/ 视频/ 数据/ ,/ DSP/ 仅/ 需/ 对/ NREAD/ 请求/ 进行/ 读/ 响应/ 即可/ ,/ 该/ 响应/ 过程/ 对/ DSP/ 是/ 透明/ 的/ ,/ 如此/ 可/ 极大/ 程度/ 减小/ DSP/ 在/ 传输/ 过程/ 中/ 的/ 时间/ 与/ 资源/ 开销/ ,/ 使得/ DSP/ 可以/ 专注/ 于/ 视频/ 处理/ 工作/ ./ 其/ 传输/ 过程/ 与/ SWRITE/ 事务/ 类似/ ,/ 即/ 为/ 每个/ NREAD/ 事务/ 包/ 设置/ 特定/ 地址/ 和/ 长度/ ,/ 视频/ 数据/ 按行/ 循环/ 发送/ ./ 为/ 最大/ 程度/ 提高/ SRIO/ 写/ 事务/ 效率/ ,/ 参照/ SWRITE/ 事务/ 的/ 数据包/ 划分/ 方式/ 以及/ 包/ 存储/ 地址/ 的/ 计算/ 方式/ ,/ 将/ 720Bytes/ 的/ Y/ 数据/ 划分/ 为/ 3/ 个/ NREAD/ 包/ ,/ 每包/ 传输/ 240Bytes/ ,/ 包/ 存储/ 地址/ 可以/ 由/ 帧/ 基/ 地址/ 、/ Y/ 分量/ 偏移量/ 和行/ 偏移量/ 计算/ 获得/ ,/ 3/ 个/ 包/ 存储/ 地址/ 连续/ 增加/ ;/ 360/ 字节/ Cb/ (/ 或/ Cr/ )/ 数据/ 采用/ 两个/ NREAD/ 事务/ 包/ 发送/ ,/ 并/ 规定/ 两个/ 数据包/ 的/ 有效/ 数据/ 长度/ 分别/ 为/ 184Bytes/ 和/ 176Bytes/ ,/ 存储/ 地址/ 由/ 帧/ 基/ 地址/ 、/ Cb/ // Cr/ 分量/ 偏移量/ 和行/ 偏移量/ 计算/ 获得/ ./ 此外/ ,/ 预定/ 义/ DSP/ 端/ 数据/ 存储单元/ 是/ 传输/ 机制/ 设计/ 的/ 另/ 一/ 重要/ 组成/ ,/ 如图/ 10/ 所示/ ./ 预定/ 义/ DSP/ 端/ 数据/ 存储单元/ 包括/ SWRITE/ 和/ NREAD/ 事务/ 的/ 存储/ 地址/ 计算/ ./ 由于/ 此/ 两种/ 事务/ 地址/ 计算方法/ 相同/ ,/ 故/ 下面/ 以/ SWRITE/ 事务/ 为例/ 进行/ 说明/ ./ FPGA/ 发送/ 的/ 每个/ SWRITE/ 事务/ 包中/ 携带/ 的/ 数据/ 将/ 被/ 按/ 顺序/ 写入/ DSP/ 的/ 视频/ 缓冲区/ 中/ 的/ 连续/ 存储空间/ ,/ 为/ 实现/ 高效/ SRIO/ 传输/ 过程/ 应/ 使用/ 高/ 载荷/ SWRITE/ 事务/ 包/ ./ 因此/ ,/ 在/ 综合/ 考虑/ 采集/ 视频/ 过程/ 特点/ 和/ 视频/ 存储/ 计算/ 特点/ 后/ ,/ 规定/ :/ (/ 1/ )/ TxFifo/ 中/ 数据/ 按/ 视频/ 行/ L/ (/ Line/ )/ 排列/ ,/ 每行/ 按照/ 720/ 字节/ Y/ 、/ 360/ 字节/ Cb/ (/ 或/ Cr/ )/ 数据/ 顺序排列/ ;/ (/ 2/ )/ 每个/ SWRITE/ 事务/ 包中/ 数据/ 只能/ 包含/ 一种/ 分量/ (/ 即/ Y/ // Cb/ // Cr/ 中/ 的/ 一种/ )/ ,/ 数据/ 存储/ 地址/ 依次/ 连续/ 递增/ ;/ (/ 3/ )/ 在/ DSP/ 视频/ 缓冲区/ 中/ 数据/ 按/ 视频/ 帧/ F/ (/ Frame/ )/ 存储/ ,/ 每帧/ 数据/ 中/ 同一/ 分量/ 连续/ 存储/ ,/ 组成/ 各/ 分量/ 矩阵/ ,/ 便于/ DSP/ 完成/ 视频/ 处理/ ./ 3.3/ 低/ 复杂度/ SRIO/ 传输/ 方法/ 实现/ 本文/ 在/ 传输/ 视频/ 数据/ 过程/ 中仅/ 使用/ SWRITE/ 、/ Page7NREAD/ 和/ DOORBELL/ 这/ 3/ 种/ SRIO/ 事务/ ,/ 其中/ DOORBELL/ 事务/ 仅/ 用来/ 发送/ 中断/ 信号/ ,/ 操作/ 相对/ MESSAGE/ 更为/ 简洁/ ./ 同时/ ,/ 使用/ 逻辑/ 与/ 控制/ 较/ RAM/ (/ RandomAccessMemory/ )/ 简单/ 的/ FIFO/ (/ FirstInFirstOut/ )/ 存储/ 机制/ 也/ 在/ 一定/ 程度/ 上/ 降低/ 了/ 设计/ 的/ 复杂度/ ,/ 并且/ 节约/ 了/ FPGA/ 的/ 资源/ 占用/ ./ 具体/ 实现/ 过程/ 如下/ :/ (/ 1/ )/ 在/ 视频/ 数据/ 由/ FPGA/ 写入/ DSP/ 过程/ 中/ ,/ FPGA/ 作为/ 主动/ 发起/ 端/ ,/ 将/ 模数转换/ 后/ 的/ 数字视频/ 通过/ SWRITE/ 事务/ 写入/ DSP/ 对应/ 的/ DDR3/ 存储/ 区/ ,/ 为/ 保证/ 内存/ 访问/ 的/ 正确性/ ,/ 视频/ 在/ 写/ DDR3/ 存储/ 区时/ ,/ DSP/ 不得/ 对/ 该/ 存储/ 区/ 进行/ 操作/ ./ 当/ FPGA/ 写/ 完/ 一帧/ 数据/ 之后/ ,/ 发送/ 一个/ DOORBELL/ 事务/ ,/ 通知/ DSP/ 可以/ 对/ 该/ 帧/ 数据/ 进行/ 处理/ ,/ 保证/ FPGA/ 与/ DSP/ 之间/ 的/ 同步/ ./ 为了/ 保证/ DSP/ 上/ 处理/ 的/ 连续性/ ,/ 在/ DSP/ 上/ 设置/ 了/ 8/ 帧/ 缓冲区/ ,/ 可以/ 循环/ 对/ 数据/ 帧/ 进行/ 处理/ ./ (/ 2/ )/ 在/ 视频/ 数据/ 由/ DSP/ 写入/ FPGA/ 的/ 过程/ 中/ ,/ 每当/ DSP/ 处理/ 完/ 一帧/ 视频/ 之后/ ,/ 发送/ DOORBELL/ 事务/ 通知/ FPGA/ 可以/ 进行/ 数据/ 读取/ ./ FPGA/ 接收/ 到/ 该/ 同步/ 信号/ 之后/ ,/ 作为/ 主动/ 发起/ 端/ ,/ 将/ DSP/ 处理/ 后/ 的/ 视频/ 数据/ 通过/ NREAD/ 事务/ 读入/ FPGA/ 的/ RxFifo/ 缓存/ 中/ ./ 在/ 实际/ 运行/ 过程/ 中/ ,/ 为/ 保证/ 数模转换/ 后/ 视频/ 的/ 连续性/ ,/ 必须/ 维持/ FPGA/ 端/ RxFifo/ 缓存/ 不空/ ,/ 同时/ 要/ 兼顾/ 数据/ 采集/ 的/ 帧/ 率/ ./ 方法/ 中/ 所/ 采集/ 的/ 模拟/ 视频/ 帧/ 率/ 为/ 25/ 帧/ // 秒/ ,/ 即/ 每/ 40ms/ 采集/ 一帧/ ./ 但/ 在/ 实际/ 采集/ 过程/ 中/ ,/ 帧/ 率会/ 受到/ 摄像头/ 采集/ 图像/ 的/ 复杂程度/ 影响/ 而/ 产生/ 偏差/ ,/ 为了/ 防止出现/ 同步/ 问题/ ,/ 规定/ 在/ DSP/ 处理/ 完两帧/ 数据/ 后/ 向/ FPGA/ 发送/ DOORBELL/ ,/ 使/ 其/ 进行/ 读/ 操作/ ./ 在读/ 的/ 过程/ 中/ ,/ FPGA/ 只/ 需/ 维护/ 自己/ 的/ RxFifo/ 即可/ ./ 在/ 设计/ 状态机/ 实现/ 读写/ 功能/ 时/ ,/ 以读/ 优先/ 的/ 方式/ 进行/ 操作/ ,/ 设置/ RxFifo/ 的/ Prog/ _/ empty/ 信号/ 为/ 2000Bytes/ ,/ 即当/ RxFifo/ 中/ 的/ 数据/ 小于/ 2000Bytes/ 时/ ,/ 进行/ 读/ 操作/ ,/ 否则/ ,/ 进行/ 写/ 操作/ ./ 在/ 读数据/ 的/ 过程/ 中/ ,/ 不能/ 进行/ 写/ 操作/ ,/ 但/ 此时/ 模拟/ 视频/ 却/ 仍然/ 在/ 实时/ 输入/ ,/ 为了/ 保证/ 读数据/ 的/ 时间/ 内/ 采集/ 用/ 的/ TxFifo/ 缓冲区/ 不/ 溢出/ 需要/ 计算/ TxFifo/ 的/ 最大值/ ./ 具体/ 控制/ 过程/ 如下/ :/ (/ 1/ )/ SWRITE/ 事务/ 的/ 触发/ :/ 由于/ 视频/ 是/ 以/ 行为/ 单位/ 进行/ 采集/ 并/ 传输/ 到/ TxFifo/ 的/ ,/ 因此/ ,/ 为/ 保证/ 行/ 数据结构/ 的/ 完整性/ ,/ 当/ TxFifo/ 中/ 数据/ 不少/ 于/ 一行/ (/ 720/ 字节/ Y/ ,/ 360/ 字节/ Cb/ 或/ Cr/ )/ 且/ 此时/ 没有/ 读/ 请求/ 时/ ,/ 可/ 发送数据/ ,/ 即/ 通过/ SWRITE/ 事务/ 完成/ 一次/ 写/ 操作/ ./ (/ 2/ )/ DOORBELL/ 事务/ 的/ 触发/ :/ 在/ FPGA/ 向/ DSP/ 发送数据/ 时/ ,/ 当/ 完成/ 一帧/ 数据/ 的/ 传输/ 且/ 此时/ 没有/ 读/ 请求/ 时/ ,/ 即可/ 通过/ 发送/ DOORBELL/ 事务/ 通知/ DSP/ 处理/ 接收/ 到/ 的/ 当前/ 帧/ 数据/ ;/ 在/ FPGA/ 从/ DSP/ 读取数据/ 过程/ 中/ ,/ 当/ DSP/ 处理/ 完两帧/ 视频/ 数据/ 时/ 发送/ DOORBELL/ 事务/ 通知/ FPGA/ 读取/ 第一/ 帧/ 数据/ ./ (/ 3/ )/ NREAD/ 事务/ 的/ 触发/ :/ 以/ FPGA/ 端/ 接收缓冲区/ RxFifo/ 中/ 数据量/ 和/ DSP/ 发送给/ FPGA/ 的/ DOORBELL/ 事务/ 为/ 触发/ 条件/ ,/ 当/ RxFifo/ 中有/ 多于/ 一行/ 的/ 剩余/ 空间/ 即可/ 组织/ NREAD/ 事务/ 完成/ 一行/ 数据/ 的/ 读取/ ./ 另外/ ,/ 规定/ 3/ 种/ 事务/ 发送/ 优先级/ 由高到/ 低/ 分别/ 为/ NREAD/ 、/ DOORBELL/ 和/ SWRITE/ 事务/ ./ 当/ NREAD/ 事务/ 发出/ 后/ ,/ DSP/ 的/ SRIO/ 硬件/ 接口/ 开始/ 组织/ 响应/ 数据包/ ,/ 响应/ 数据包/ 数据量/ 大/ ,/ 时间/ 紧迫/ 程度/ 高/ ,/ 需要/ 尽早/ 开始/ 响应/ 数据包/ 组织/ ,/ 同时/ NREAD/ 和/ DOORBELL/ 事务/ 占用/ 发送/ 周期/ 少/ ,/ 因此/ NREAD/ 发送/ 优先级/ 最高/ ;/ DSP/ 收到/ DOORBELL/ 事务/ 后/ 解锁/ 视频/ 帧/ 存储/ 区/ ,/ 开始/ 视频/ 处理/ 工作/ ,/ 因此/ DOORBELL/ 优先级/ 高于/ SWRITE/ 事务/ ./ Xinlinx/ 公司/ 的/ SRIOIP/ 核/ 提供/ IREQ/ 、/ IRESP/ 、/ TREQ/ 、/ TRESP4/ 个/ 端口/ ./ 由于/ 本文/ 方法/ FPGA/ 在/ 读写/ 过程/ 中/ 都/ 是/ 作为/ 传输数据/ 包/ 的/ 发起/ 端/ ,/ 而/ DSP/ 作为/ 响应/ 端/ 只/ 需/ 接收/ 和/ 发送/ 简洁/ 的/ DOORBELL/ 信号/ ,/ 其/ TREQ/ 与/ TRESP/ 端口/ 实现/ 相对/ 简单/ ./ 因此/ ,/ 传输/ 过程/ 设计/ 的/ 难度/ 主要/ 集中/ 在/ FPGA/ 端的/ IREQ/ 与/ IRESP/ 两个/ 端口/ ./ 其中/ ,/ IREQ/ 模块/ 做/ 为/ 一次/ 事务/ 的/ 开始/ ,/ 负责/ 组织/ 请求/ 数据包/ ;/ IRESP/ 模块/ 负责/ 接收/ NREAD/ 的/ 响应/ 数据包/ ./ 下面/ 将/ 对此/ 两个/ 模块/ 的/ 设计/ 进行/ 详细/ 介绍/ ./ 3.3/ ./ 1/ 发起/ 端/ 请求/ (/ IREQ/ )/ 设计/ 发起/ 端/ 请求/ 模块/ 包含/ 以下/ 4/ 部分/ :/ CON/ (/ Con/ -/ troller/ )/ 、/ TIK/ (/ Tickler/ )/ 、/ IGEN/ (/ IREQGenerator/ )/ 和/ TxFifo/ ./ 其中/ ,/ CON/ 是/ 整个/ IREQ/ 模块/ 的/ 核心/ 控制/ 部分/ ,/ 是/ 一次/ SRIO/ 请求/ 事务/ 包/ 的/ 起点/ ,/ 它/ 负责/ 检测/ 是否/ 发送数据/ 、/ 控制/ 何时/ 发送数据/ 以及/ 组织/ 数据包/ 信息/ ,/ CON/ 监控/ TxFifo/ 状态/ ,/ 控制/ TIK/ 完成/ 数据包/ 发送/ ;/ TIK/ 负责/ 具体/ 的/ 数据组织/ 工作/ ,/ 产生/ 数据包/ 包头/ 信息/ ,/ 并/ 将/ 包头/ 信息/ 传递/ 到/ IGEN/ ,/ 监控/ IGEN/ 状态/ 并/ 向/ CON/ 反馈/ ;/ IGEN/ 负责/ 与/ IP/ 核/ 的/ IREQ/ 端口/ 协同/ 将/ 组织/ 好/ 的/ 数据包/ 信息/ 传递/ 给/ IP/ 核/ ,/ 完整/ 的/ 数据包/ 包括/ 包头/ 信息/ 和/ 数据/ 信息/ ,/ IGEN/ 的/ 包头/ 信息/ 来自/ TIK/ ,/ 数据/ 信息/ 可以/ 直接/ 取自/ TxFifo/ 或接/ Page8/ 收/ TIK/ 传递/ 的/ 数据/ ;/ TxFifo/ 是/ 发送数据/ 缓冲/ 队列/ ./ SRIO/ 用户程序/ IREQ/ 模块/ 结构/ 如图/ 11/ 所示/ ,/ 视频/ 数据/ 依次/ 流经/ TxFifo/ 和/ IGEN/ ,/ 最终/ 由/ IGEN/ 传递/ 到/ IP/ 核/ 的/ IREQ/ 端口/ 并/ 通过/ 链路/ 发出/ ./ CON/ 是/ FPGA/ 端/ 所有/ SRIO/ 请求/ 的/ 发起者/ ,/ 也/ 是/ FPGA/ 控制/ SRIO/ 通路/ 数据/ 收发/ 的/ 核心/ ,/ 使用/ CON/ 模块/ 请求/ 事务/ 状态机/ 完成/ SRIO/ 通路/ 控制/ 工作/ ,/ 如图/ 12/ 所示/ ./ 状态机/ 包含/ 6/ 种/ 状态/ :/ INIT/ (/ Initial/ )/ 、/ RDY/ (/ Ready/ )/ 、/ SW/ (/ SWRITE/ )/ 、/ DB/ (/ DOORBELL/ )/ 、/ NR/ (/ NREAD/ )/ 和/ SEND/ 状态/ ./ (/ 1/ )/ INIT/ 状态/ 是/ 状态机/ 的/ 初始状态/ ,/ 当/ SRIO/ 硬件/ 初始化/ 成功/ 后/ 进入/ RDY/ 状态/ ,/ 否则/ 继续/ 等待/ ;/ (/ 2/ )/ RDY/ 状态/ 表示/ SRIO/ 链路/ 正常/ ,/ 当/ 发送/ 请求/ 来临/ 并且/ IP/ 核/ 就绪/ 时/ ,/ 进入/ 对应/ 发送/ 请求/ 状态/ ,/ 若/ SRIO/ 链路/ 异常/ ,/ 则/ 进入/ INIT/ 状态/ ;/ (/ 3/ )/ NR/ 、/ DB/ 和/ SW/ 状态/ 分别/ 是/ 发送/ NREAD/ 事务/ 、/ DOORBELL/ 事务/ 和/ SWRITE/ 事务/ 状态/ ,/ 每种/ 事务/ 分别/ 组织/ 各自/ 的/ 有效/ 事务/ 信息/ ,/ 当/ IP/ 核/ 状态/ 就绪/ 时/ 进入/ SEND/ 状态/ ,/ 否则/ 等待/ ,/ 若/ SRIO/ 链路/ 出现异常/ 或者/ 中断/ ,/ 则/ 进入/ RDY/ 状态/ ;/ (/ 4/ )/ SEND/ 状态/ 为/ SRIO/ 请求/ 事务/ 发送/ 状态/ ,/ CON/ 模块/ 将/ 组织/ 好/ 的/ 数据信号/ 传递/ 给/ TIK/ 模块/ ,/ 命令/ TIK/ 模块/ 开始/ 组织/ 数据包/ 的/ 包头/ 信息/ ,/ 并/ 发送/ SRIO/ 数据包/ ,/ 当/ TIK/ 完成/ 数据/ 接收/ 则/ 进入/ RDY/ 状态/ ,/ 否则/ 继续/ 等待/ ,/ 若/ 出现/ 链路/ 异常/ 或者/ 中断/ ,/ 则/ 进入/ RDY/ 状态/ ./ 3.3/ ./ 2/ 发起/ 端/ 响应/ (/ IRESP/ )/ 设计/ SRIO/ 用户程序/ 的/ IRESP/ 模块/ 主要/ 负责/ 接收/ 并/ 解析/ DSP/ 发送/ 的/ NREAD/ 响应/ 事务/ 包/ 数据/ ,/ 主要/ 包括/ IHAN/ (/ IRESPHandler/ )/ 和/ RxFifo/ 两/ 部分/ ,/ IHAN/ 负责/ 接收/ 及/ 解析/ 数据包/ ,/ RxFifo/ 是/ 接收数据/ 缓冲/ 队列/ ./ IHAN/ 接收/ 解析/ 数据/ 工作/ 由/ IHAN/ 模块/ 事务/ 解析/ 状态机/ 控制/ 完成/ ,/ 如图/ 13/ 所示/ ./ IHAN/ 状态机/ 只/ 包括/ 3/ 个/ 状态/ :/ INIT/ 、/ RDY/ 和/ RECV/ 状态/ ./ (/ 1/ )/ INIT/ 状态/ 是/ 初始状态/ ,/ 表示/ 当前/ SRIO/ 硬件/ 链路/ 连接/ 仍/ 未/ 建立/ 成功/ ,/ 当/ SRIO/ 链路/ 建立/ 成功/ 后/ 进入/ RDY/ 状态/ ,/ 否则/ 等待/ ;/ (/ 2/ )/ RDY/ 状态/ 表示/ 当前/ IHAN/ 模块/ 处于/ 空闲/ 状态/ ,/ 可以/ 接收/ 响应/ 事务/ ,/ 当/ 响应/ 事务/ 到来/ 时/ ,/ 进入/ RECV/ 状态/ ,/ 当/ SRIO/ 链路/ 断开/ 时/ ,/ 进入/ INIT/ 状态/ ;/ (/ 3/ )/ RECV/ 状态/ 表示/ 当前/ 正在/ 接收/ IP/ 核/ IRESP/ 端口/ 数据/ 信息/ ,/ 同时/ 完成/ 向/ RxFifo/ 写入/ 操作/ ,/ 当/ 数据/ 接收/ 完成/ 时/ ,/ 进入/ RDY/ 状态/ ,/ 当/ SRIO/ 链路/ 端口/ 时/ ,/ 进入/ INIT/ 状态/ ,/ 否则/ 继续/ 接收数据/ ,/ 处于/ RECV/ 状态/ ./ 4/ 实验/ 结果/ 4.1/ 实验/ 环境/ 本文/ 视频/ 处理/ 系统/ 选用/ TI/ 公司/ 的/ TMS320C6678DSP/ 芯片/ 及/ XILINX/ 公司/ 的/ XC5VSX50TFPGA/ 芯片/ ./ 其中/ ,/ TMS320C6678/ 有/ 8/ 个/ TMS320C66xDSP/ 核/ ,/ 单核/ 工作频率/ 为/ 1.0/ GHz/ 或/ 1.25/ GHz/ ,/ 其/ SRIO/ 接口/ 可/ 配置/ 成/ 单通道/ 、/ 双通道/ 或/ 四/ 通道/ 模式/ ,/ 单通道/ 可/ 选择/ 工作/ 在/ 1.25/ Gbps/ 、/ 2.5/ Gbps/ 、/ 3.125/ Gbps/ 和/ 5Gbps4/ 种/ 速率/ 模式/ 下/ ①/ ;/ XC5VSX50T/ 芯片/ 包含/ 12/ 个/ GTP/ 串行/ 高速/ 收发器/ 、/ 288/ 个/ DSP48E/ 硬件/ 模块/ 、/ 8160/ 个/ Slices/ 、/ 4752KbBlockRAM/ 和/ 6/ 个/ CMT/ 时钟/ 管理/ 模块/ ②/ ./ 此外/ ,/ 系统/ 选用/ Xilinx/ 公司/ 提供/ 的/ LogiCOREIPSerialRapidIOv5/ ./ 6/ 版本/ 的/ SRIOIP/ 核/ ,/ 此款/ IP/ 核/ 支持/ Virtex4/ 、/ Virtex5/ 和/ Spartan6/ 等/ 系列/ FPGA/ ,/ 共/ 包括/ 以下/ 3/ 个/ 功能模块/ :/ 逻辑/ 与/ 传输层/ 模块/ 、/ 缓冲/ ①/ ②/ Page9/ 区/ 模块/ 及/ 物理层/ 模块/ ./ 为/ 方便/ 用户/ 进行/ 操作/ ,/ 以上/ 3/ 个/ 模块/ 被/ 集成/ 到/ RIO/ _/ WRAPPER/ 模块/ 中/ ./ 此外/ ,/ RIO/ _/ WRAPPER/ 模块/ 还/ 提供/ 了/ RocketIO/ 封装/ 、/ 时钟/ 、/ 复位/ 和/ 寄存器/ 管理/ 模块/ ,/ 为/ 系统/ 提供/ 了/ 硬件/ 支持/ ./ 除/ 硬件/ 选型/ 外/ ,/ 系统/ 硬件/ 布线/ 参数/ 也/ 会/ 影响/ SRIFO/ 传输速率/ ,/ 本文/ 使用/ 文献/ [/ 19/ ]/ 所提/ 方法/ 对系统/ 进行/ 硬件/ 仿真/ ,/ 并/ 参考/ 仿真/ 结果/ 完成/ PCB/ 设计/ ,/ 本/ FPGA/ +/ DSP/ 异构/ 视频/ 处理/ 系统/ 实物图/ 如图/ 14/ 所示/ ./ 图/ 14FPGA/ +/ DSP/ 异构/ 视频/ 处理/ 系统/ 实物/ 4.2/ SRIO/ 传输速率/ 测试/ 本文/ 将/ SRIO/ 总线/ 速率/ 设置/ 为/ 1.25/ Gbps/ 模式/ ,/ 由于/ SRIO/ 总线/ 物理层/ 采用/ 8b/ // 10b/ 编码/ ,/ 因此/ SRIO/ 传输/ 理论/ 带宽/ 为/ 1Gbps/ ./ 由于/ 本文/ 提出/ 的/ 方法/ 中/ SWRITE/ 事务/ 、/ NREAD/ 事务/ 都/ 是/ 由/ FPGA/ 发起/ 的/ ,/ 因此/ ,/ 在/ FPGA/ 端/ 需要/ 按照/ 各种/ 事务/ 优先级/ 顺序/ 分/ 时/ 复用/ IREQ/ 端口/ 进行/ 数据/ 收发/ ;/ 另一方面/ ,/ 由于/ 传输/ 过程/ 中/ 的/ 数据/ 打包/ 需要/ 占用/ 一定/ 时间/ 和/ 空间/ 开销/ ,/ 因此/ ,/ SRIO/ 实际/ 传输速率/ 跟/ 理论值/ 是/ 有/ 一定/ 差距/ 的/ ./ 基于/ 上述/ 实验/ 设定/ ,/ 针对/ FPGA/ +/ DSP/ 异构/ 视频/ 处理/ 系统/ ,/ 本文/ 需要/ 测试/ FPGA/ 通过/ SWRITE/ 事务/ 与/ NREAD/ 事务/ 读写/ DSP/ 端/ DDR3/ 存储器/ 的/ 速率/ ,/ 并/ 对/ FPGA/ 资源/ 使用/ 情况/ 进行/ 测试/ ./ 由于/ 受到/ 硬件/ 系统/ 中/ 调试/ 工具/ 的/ 限制/ ,/ 不能/ 通过/ 计算机/ 实时/ 反馈/ 硬件/ 工作/ 状态/ ./ 故/ 在/ 测试/ 本文/ 方法/ SRIO/ 链路/ 发送/ 与/ 接收数据/ 速率/ 时/ ,/ 通过/ 检查/ 1s/ 时间/ 内/ DDR3/ 存储器/ 中/ 写入/ 数据/ 长度/ 得到/ FPGA/ 向/ DSP/ 发送数据/ 的/ 速率/ ;/ 类似/ 地/ ,/ 通过/ 检查/ 1s/ 时间/ 内/ FPGA/ 收到/ 数据包/ 的/ 数量/ 得到/ FPGA/ 读取/ DSP/ 的/ 速率/ ./ (/ 1/ )/ SWRITE/ 事务/ 速率/ 测试/ 为/ 测试/ 本文/ 方法/ FPGA/ 的/ SRIO/ 发送/ 速率/ ,/ 在/ 一秒钟/ 时间/ 内/ FPGA/ 不间断/ 发送/ 特定/ 图像/ 数据/ 到/ DSP/ 的/ DDR3/ 存储器/ 中/ ,/ 发送/ 结束/ 后/ 通过/ CCS/ 工具/ 及/ DSP/ 仿真器/ 导出/ DDR3/ 存储/ 内容/ ,/ 在/ 计算机/ 上/ 检查/ 写入/ 数据/ 长度/ ,/ 该/ 数据/ 长度/ 即/ 是/ FPGA/ 的/ SRIO/ 发送/ 速率/ ./ 本文/ 对/ SWRITE/ 事务/ 进行/ 测试/ ,/ 检查/ DDR3/ 存储/ 内容/ ,/ 发现/ 写入/ 数据/ 符合/ 递增/ 规律/ ,/ 数据/ 正确/ 无误/ ,/ 平均/ 每秒/ 写入/ 数据/ 长度/ 880Mb/ ,/ 即/ FPGA/ 向/ DSP/ 通过/ SRIO/ 发送/ 速率/ 为/ 880Mbps/ ,/ 达到/ 传输速率/ 理论值/ 的/ 86/ %/ ,/ SRIO/ 写/ 速率/ 测试/ 表如表/ 2/ 所示/ ./ 次数/ 123/ (/ 2/ )/ NREAD/ 事务/ 速率/ 测试/ 为/ 测试/ 本文/ 方法/ FPGA/ 通过/ SRIO/ 读取/ DDR3/ 的/ 速率/ 和/ 正确性/ ,/ 在/ 一秒/ 时间/ 内/ ,/ 由/ FPGA/ 向/ DSP/ 连续/ 发送/ NREAD/ 请求/ 事务/ ,/ 在/ FPGA/ 端/ 接收/ NREAD/ 响应/ 事务/ ,/ 检查/ 收到/ 数据/ 正确性/ 并/ 记录/ 收到/ 的/ 数据包/ 数量/ ,/ 通过/ ChipScope/ 工具/ 及/ FPGA/ 仿真器/ 检查数据/ 正确性/ 标志/ 位及/ 数据包/ 数量/ ./ 本文/ 测试/ 平均/ 读/ 速度/ 为/ 829Mbps/ ,/ 达到/ 传输速率/ 理论值/ 的/ 81/ %/ ,/ 数据/ 正确/ 无误/ ,/ SRIO/ 读/ 速率/ 测试/ 表如表/ 3/ 所示/ ./ 次数/ 123/ (/ 3/ )/ 方法/ 比较/ 本节/ 将/ 对/ SRIO/ 的/ 读/ 速率/ 、/ 写/ 速率/ 以及/ SRIO/ 事务/ 类型/ 3/ 方面/ 对/ 本文/ 方法/ 与/ 其他/ 文献/ 方法/ 进行/ 对比/ 分析/ ./ 表/ 4/ 为/ 本文/ 方法/ 与/ 其他/ 文献/ 方法/ 在/ SRIO/ 读写/ 速率/ 方面/ 的/ 对比/ 表/ ./ 其中/ ,/ 文献/ [/ 8/ ]/ 为/ 未加/ 任何/ 优化/ 的/ 传统/ 方法/ ,/ 采用/ SRIO/ 的/ 1.25/ Gbps/ 的/ 工作/ 模式/ ,/ 由于/ 此文/ 未/ 对/ 传输/ 方法/ 进行/ 优化/ ,/ 其/ 读写/ 速率/ 均/ 较/ 低/ ,/ 只能/ 达到/ 理论/ 带宽/ 的/ 25/ %/ 左右/ ./ 文献/ [/ 9/ ]/ 通过/ 在/ FPGA/ 端/ 采用/ 乒乓/ 存储/ 结构/ 保障/ 视频/ 数据传输/ 流畅性/ 的/ 同时/ ,/ 在/ DSP/ 端/ 预定/ 义/ 了/ 数据/ 接收/ 的/ 存储单元/ ,/ 此文/ SRIO/ 工作/ 在/ 3.125/ Gbps/ 的/ 工作/ 模式/ 下/ ,/ 传输速率/ 为/ 2320Mbps/ ,/ 约/ 占/ 理论/ 带宽/ 的/ 74/ %/ ./ 从表/ 2/ 中/ 可以/ 看出/ 当/ SRIO/ 同样/ 工作/ 在/ 1.25/ Gbps/ 模式/ 时/ ,/ 本文/ 方法/ 在/ 读写/ 速率/ 上/ 明显/ 优于/ 文献/ [/ 8/ ]/ 方法/ ,/ 可以/ 达到/ 829Mbps/ 以上/ ./ 由于/ 文献/ [/ 9/ ]/ 方法/ 工作/ 在/ 3.125/ Gbps/ 与/ 本文/ 不同/ ,/ 故/ 我们/ 针对/ SRIO/ 的/ 读写/ 传输/ 效率/ 进行/ 对比/ ,/ 本文/ 也/ 具有/ 较/ 明显/ 优势/ ./ Page10/ 表/ 4SRIO/ 传输速率/ 的/ 对比/ 表/ 文献/ [/ 8/ ]/ 方法/ (/ 1.25/ Gbps/ )/ 文献/ [/ 9/ ]/ 方法/ (/ 3.125/ Gbps/ )/ 本文/ 方法/ (/ 1.25/ Gbps/ )/ 在/ SRIO/ 使用/ 的/ 事务/ 类型/ 方面/ ,/ 文献/ [/ 8/ ]/ 采用/ NREAD/ 、/ NWRITE/ 、/ DOORBELL/ 与/ MAINTENCE4/ 种/ SRIO/ 事务/ ,/ 比/ 本文/ 多/ 了/ 一种/ 事务/ ,/ 在/ 设计/ 上/ 更为/ 复杂/ ,/ 此外/ ,/ NWRITE/ 事务/ 在/ IREQ/ 端/ 需要/ 控制/ 18/ 种/ 信号/ ,/ 而/ 本文/ 采用/ 的/ SWRITE/ 事务/ 相比/ NWRITE/ 减少/ 了/ 数据包/ 事务/ 类型/ 、/ 数据包/ 编号/ 、/ 打包/ 字节/ 使能/ 和/ 打包/ 字节/ 计数/ 4/ 种/ 信号/ ,/ 因此/ 只/ 需/ 控制/ 14/ 种/ 信号/ 即可/ ,/ 也/ 一定/ 程度/ 上/ 降低/ 了/ 设计/ 复杂度/ ./ 由于/ 文献/ [/ 9/ ]/ 系统/ 中/ 只/ 涉及/ FPGA/ 向/ DSP/ 写/ 数据/ ,/ 故/ SRIO/ 未/ 使用/ 读/ 相关/ 的/ 事务/ ,/ 但是/ 其/ 使用/ 的/ NWRITE/ _/ R/ 为/ 带/ 响应/ 的/ 写/ 操作/ ,/ 实现/ 相对/ 复杂/ ./ 4.3/ FPGA/ 资源/ 占用/ 测试/ 本文/ FPGA/ 作为/ 视频/ 传输/ 的/ 核心/ 控制器/ ,/ 其/ 资源/ 占用/ 情况/ 也/ 是/ 衡量/ 视频/ 数据/ 高效/ 传输/ 的/ 重要/ 指标/ 之一/ ./ 除/ FPGA/ 的/ SliceRegisters/ 、/ LookUpTable/ (/ LUT/ )/ 和/ BlockRAM/ // FIFO/ 这/ 3/ 种/ 资源/ 外/ ,/ 数据传输/ 过程/ 中/ 用于/ FPGA/ 与/ DSP/ 间/ 数据/ 读写/ 同步/ 的/ DSP/ 中断/ 次数/ 也/ 会/ 影响/ 传输/ 效率/ ./ 过多/ 的/ 中断/ 次数/ 会/ 增加/ FPGA/ 与/ DSP/ 间/ 的/ 交互/ 时间/ ,/ 带来/ DSP/ 的/ 编码/ 延迟/ ,/ 从而/ 降低/ 数据传输/ 和/ 处理/ 效率/ ,/ 表/ 5/ 为/ 本文/ 方法/ 与/ 其他/ 方法/ 在/ FPGA/ 资源/ 占用/ 上/ 的/ 对比/ 表/ ,/ 考虑/ 到/ 中断/ 次数/ 对/ 传输/ 效率/ 的/ 影响/ ,/ 故/ 在/ 表中/ 加入/ 一行/ 中断/ 次数/ 的/ 统计/ ./ NumberofSliceRegistersNumberofSliceLUTsNumberofBlockRAM/ // FIFODSP/ 中断/ 次数/ // 帧/ 由表/ 5/ 可知/ ,/ 与/ 直接/ 方法/ 和/ 文献/ [/ 11/ ]/ 方法/ 相比/ ,/ 本文/ 提出/ 的/ 视频/ 传输/ 方法/ 对/ FPGA/ 中/ SliceRegisters/ 和/ LUT/ 占用/ 较少/ ./ 在/ 存储资源/ 方面/ ,/ 由于/ 直接/ 方法/ 是/ 在/ FPGA/ 内部/ 完成/ 视频/ 采集/ 时/ 奇偶/ 场/ 的/ 合并/ ,/ 故/ 需要/ 占用/ 大量/ 的/ FPGA/ 片上/ 存储资源/ BlockRAM/ // 257/ -/ 829FIFO/ ,/ 而/ 本文/ 方法/ 在/ FPGA/ 处理器/ 上/ 只/ 需以/ 行为/ 单位/ 缓存/ 及/ 传输/ 视频/ 数据/ ,/ 视频/ 的/ 奇偶/ 场合/ 并/ 在/ DSP/ 处理器/ 上/ 实现/ ,/ 因此/ 本文/ 方法/ 相比/ 直接/ 方法/ 在/ FPGA/ 存储资源/ 占用/ 上/ 有/ 了/ 明显/ 地/ 减少/ ;/ 相比/ 文献/ [/ 11/ ]/ 方法/ ,/ 本文/ 方法/ 无需/ 外接/ RAM/ ,/ 减少/ 存储资源/ 占用/ 的/ 同时/ 降低/ 了/ 硬件/ 设计/ 的/ 复杂度/ ./ 在/ 与/ DSP/ 的/ 交互/ 方面/ ,/ 文献/ [/ 11/ ]/ 方法/ 通过/ DSP/ 中断/ 方式/ 同步/ FPGA/ 与/ DSP/ 之间/ 的/ 数据传输/ 过程/ ,/ 在/ FPGA/ 向/ DSP/ 发送/ 1/ 帧/ 视频/ 数据/ 完成/ 后/ ,/ 发送/ 第/ 1/ 次/ 中断/ 通知/ DSP/ 进行/ 数据处理/ ,/ 当/ DSP/ 处理/ 完/ 1/ // 4/ 帧/ 数据/ 时/ ,/ 由/ FPGA/ 发送/ 第/ 2/ 次/ 中断/ 通知/ DSP/ 发送/ 处理/ 后/ 的/ 1/ // 4/ 帧/ 数据/ ,/ 以此类推/ ,/ 当/ DSP/ 将/ 完整/ 的/ 1/ 帧/ 处理/ 后/ 的/ 数据/ 发送至/ FPGA/ 需要/ 4/ 次/ 中断/ ,/ 故此/ 方法/ FPGA/ 发送/ 与/ 接收/ 1/ 帧/ 数据/ 共/ 需要/ 5/ 次/ 中断/ ;/ 而/ 直接/ 方法/ 中/ FPGA/ 是/ 在/ 检测/ 到/ DSP/ 存储器/ 中有/ 数据/ 后/ 就/ 发/ 中断/ 进行/ 取数/ ,/ 因此/ 读取/ 1/ 帧/ 视频/ 数据/ 需要/ 比/ 文献/ [/ 11/ ]/ 多/ 的/ 中断/ 次数/ ;/ 相比之下/ ,/ 本文/ 提出/ 的/ 方法/ 传输/ 一帧/ 图像/ 仅/ 需要/ 两次/ 中断/ 即可/ 实现/ FPGA/ 与/ DSP/ 的/ 同步/ ./ 数据/ 的/ 传输/ 过程/ 相对/ DSP/ 完全/ 透明/ ,/ 使/ FPGA/ 能/ 专注/ 于/ 传输/ 控制/ ,/ DSP/ 专注/ 于/ 视频/ 处理/ ,/ 有效/ 保障/ 了/ 视频/ 传输/ 效率/ ./ 5/ 总结/ 针对/ FPGA/ +/ DSP/ 异构/ 处理器/ 结构特征/ 和/ 视频/ 数据格式/ 特征/ ,/ 本文/ 提出/ 了/ 一种/ 以/ FPGA/ 作为/ 传输/ 核心/ 的/ SRIO/ 高效/ 传输/ 方法/ ./ 该/ 方法/ 通过/ 在/ FPGA/ 处理器/ 上/ 采用/ 视频/ 三/ 分量/ 数据/ 重组/ 方法/ 并/ 使用/ 包头/ 信息/ 较/ 短/ 的/ SWRITE/ 事务/ 简化/ 视频/ 传输/ 格式/ 的/ 同时/ 提高/ SRIO/ 视频/ 数据包/ 的/ 传输/ 效率/ ;/ 通过/ 在/ DSP/ 处理器/ 上/ 预定/ 义/ 接收端/ 数据/ 存储单元/ 和/ 采用/ 简洁/ 的/ DOORBELL/ 应答/ 机制/ 节约/ 了/ DSP/ 在/ 传输/ 过程/ 中/ 的/ 时间/ 开销/ ./ 在/ 方法/ 实现/ 上/ ,/ 本文/ 仅/ 采用/ 3/ 种/ SRIO/ 事务/ ,/ 降低/ 了/ 设计/ 的/ 复杂度/ ./ 实验/ 结果表明/ ,/ 本文/ 方法/ 在/ 占用/ 较少/ FPGA/ 片上/ 资源/ 的/ 条件/ 下/ ,/ 读写/ 速率/ 可达/ SRIO/ 理论值/ 的/ 81/ %/ 以上/ ,/ 可/ 满足/ 六路/ D1/ 视频/ 或/ 单路/ 高清/ 视频/ 传输/ 需求/ ./ 在/ 实际/ 工程/ 中/ ,/ 可/ 通过/ 提高/ SRIO/ 单通道/ 工作频率/ 或/ 采用/ 多通/ Page11/ 道/ 传输/ 等/ 方式/ 进一步提高/ 方法/ 传输速率/ ,/ 以/ 满足/ 更/ 多/ 路标/ 清/ 乃至/ 多路/ 高清/ 视频/ 大/ 数据量/ 的/ 传输/ 需求/ ./ 

