Page1/ 基于/ Parray/ 数组/ 类型/ 的/ 矩阵/ 乘法/ 实现/ 崔翔/ 1/ )/ ,/ 2/ )/ 李晓雯/ 2/ )/ 陈一/ / 1/ )/ (/ 北京大学/ 信息/ 科学技术/ 学院/ 高/ 可信/ 教育部/ 重点/ 实验室/ 北京/ 100871/ )/ 2/ )/ (/ 河南大学/ 计算机/ 与/ 信息/ 工程学院/ 河南/ 开封/ 475000/ )/ 摘要/ 介绍/ 针对/ 异构/ 集群/ 体系结构/ 特点/ 设计/ 的/ 编程/ 接口/ Parray/ ./ Parray/ 使用/ 数组/ 类型/ 对/ 数据/ 的/ 物理/ 存储/ 和/ 逻辑/ 结构/ 进行/ 分离/ ./ Parray/ 使用/ 统一/ 的/ 线程/ 数组/ 类型/ 表示/ 各种/ 进程/ (/ 线程/ )/ 的/ 创建/ 以及/ 它们/ 之间/ 的/ 控制/ 流转/ ./ 通过/ 矩阵/ 乘法/ 实例/ 演示/ Parray/ 程序设计/ 的/ 特点/ :/ 该/ 程序/ 由/ 一个/ 单/ CPU/ 线程/ 程序/ 演变/ 为/ 多/ CPU/ 线程/ 程序/ 、/ 再/ 演变/ 为/ GPU/ 线程/ 程序/ —/ —/ —/ 程序/ 的/ 各次/ 演变/ 仅/ 通过/ 数组/ 类型/ 的/ 变化/ 和/ 代码/ 的/ 细微/ 修改/ 即可/ 完成/ ./ 介绍/ 使用/ Parray/ 实现/ 的/ 高性能/ GPU/ 矩阵/ 乘法/ ,/ 在/ 天河/ 1A/ 单/ 节点/ 上/ 的/ 测试/ 性能/ 和/ CUBLAS4/ ./ 0/ 相当/ ,/ 同时/ 该/ 代码/ 可以/ 工作/ 于/ 不同/ 物理/ 存储/ 方式/ 的/ 数组/ ./ 关键词/ GPU/ 集群/ ;/ 程序设计/ ;/ 矩阵/ 乘法/ ;/ 编程/ 接口/ ;/ 性能/ 优化/ 1/ 引言/ 的/ 主流/ 架构/ ./ 异构/ 集群/ 的/ 体系结构/ 特点/ 表现/ 为/ :/ 异构/ 的/ 数据/ 存储/ 和/ 异构/ 的/ 计算/ 单元/ ./ 程序员/ 需要/ 针对/ 异构/ 集群/ 的/ 体系结构/ 特点/ 进行/ 使用/ GPU/ 加速/ 的/ 异构/ 集群/ 逐渐/ 成为/ 超级/ 计算/ 程序设计/ 以/ 得到/ 高性能/ 的/ 代码/ [/ 1/ -/ 3/ ]/ ./ 针对/ 其/ 异构/ 数据/ Page2/ 存储/ 的/ 特点/ ,/ 数据/ 通常/ 需要/ 进行/ 多维度/ 的/ 划分/ ./ 针对/ 其/ 异构计算/ 单元/ 的/ 特点/ ,/ 程序员/ 需要/ 创建/ 和/ 调用/ 不同/ 种类/ 的/ 线程/ ./ 目前/ 程序员/ 进行/ 异构/ 集群/ 程序设计/ 通常/ 使用/ MPI/ +/ Pthread/ +/ CUDA/ 的/ 方式/ [/ 4/ ]/ ./ 此/ 方式/ 的/ 弊端/ 表现/ 在/ :/ (/ 1/ )/ 缺乏/ 对/ 多维/ 数组/ 操作/ 的/ 有效/ 支持/ ./ C语言/ 并/ 无/ 对/ 多维/ 嵌套/ 数组/ 操作/ 的/ 有效/ 支持/ ,/ 此处/ 所/ 讲/ 的/ 数组/ 可以/ 是/ 分布/ 在/ 集群/ 中/ 不同/ 节点/ 存储器/ 的/ 数组/ ,/ 也/ 可以/ 指/ 单机/ 上/ 分布/ 于/ 不同/ GPU/ 设备/ 存储器/ 的/ 数组/ ./ 在/ MPI/ +/ Pthread/ +/ CUDA/ 方式/ 下/ ,/ 多维/ 数组/ 的/ 操作/ 通过/ 物理/ 寻址/ 实现/ ,/ 代码/ 表现/ 为/ 复杂/ 的/ 偏移/ 计算/ 表达式/ 和/ 多维/ 嵌套循环/ ./ 并且/ ,/ 代码/ 只能/ 工作/ 于/ 数组/ 的/ 特定/ 数据/ 物理/ 排列/ 方式/ ;/ (/ 2/ )/ 缺乏/ 对/ 不同/ 种类/ 线程/ 调用/ 的/ 统一/ 表示/ 方式/ ./ MPI/ 进程/ 、/ Pthread/ 线程/ 和/ CUDA/ 线程/ 的/ 创建/ 和/ 调用/ 方式/ 各不相同/ ,/ 因此/ ,/ 程序员/ 需要/ 学习/ 和/ 组合/ 各种/ 异构计算/ 单元/ 的/ 操作/ 方式/ ./ GPU/ 集群/ 编程/ 模型/ 和/ 方法/ 的/ 研究/ 面临/ 一个/ 两难/ 的/ 选择/ :/ 一方面/ ,/ 程序员/ 希望/ 有/ 较/ 高/ 的/ 抽象层次/ 而/ 不必/ 关心/ 系统/ 低层/ 的/ 细节/ 特征/ ;/ 另一方面/ ,/ 当前/ 新/ 体系结构/ 的/ 发展趋势/ 要求/ 在/ 源程序/ 一级/ 区分/ 多种不同/ 类型/ 的/ 处理器/ 和/ 数据/ 存储/ 传输方式/ ,/ 而/ 不是/ 强迫/ 程序员/ 使用/ 某种/ 特定/ 的/ 方式/ ./ 传统/ 上/ ,/ 侧重/ 前/ 一种/ 选择/ 的/ 思想/ 是/ “/ 隐藏/ ”/ (/ hiding/ )/ ,/ 不少/ 基于/ 变量/ 共享/ 或/ 共享/ 存储/ 的/ 编程/ 模型/ 如/ OpenMP/ 、/ OpenCL/ 和/ PGAS/ 类/ 语言/ 都/ 属于/ 这一/ 设计/ ;/ 侧重/ 后/ 一种/ 选择/ 的/ 思想/ 是/ “/ 暴露/ ”/ (/ exposure/ )/ ,/ 比如/ MPI/ 和/ CUDA/ 都/ 暴露/ 了/ 相当/ 多/ 的/ 低层/ 系统/ 特征/ ./ 不当/ 的/ 暴露/ 会/ 使/ 并行/ 编程/ 过于/ 困难/ ,/ 而/ 过度/ 的/ 隐藏/ 会/ 使/ 源程序/ 严重/ 缺少/ 并行/ 化/ 信息/ 并/ 过于/ 依赖/ 低层/ 优化/ 从而/ 难以达到/ 高性能/ ./ 这/ 也/ 是/ 当前/ GPU/ 集群/ 通常/ 采用/ MPI/ +/ Pthread/ +/ CUDA/ 方式/ 进行/ 程序设计/ 的/ 原因/ ,/ 因为/ 针对/ “/ 暴露/ ”/ 的/ 体系结构/ 特征/ 编程/ 可以/ 取得/ 良好/ 的/ 性能/ ./ GPU/ 集群/ 设计/ 的/ 初衷/ 是/ 取得/ 高性能/ ,/ 而/ GPU/ 集群/ 的/ 特点/ 决定/ 了/ :/ 如果/ 要/ 在/ 其/ 上/ 得到/ 高性能/ 的/ 代码/ ,/ 则/ 必须/ 要/ 考虑/ 其/ 异构/ 特点/ 并/ 针对/ 其/ 体系结构/ 特点/ 进行/ 程序设计/ 而/ 不能/ 忽视/ 之/ ./ 因此/ ,/ GPU/ 集群/ 编程/ 工具/ 设计/ 应该/ 尽量/ 减轻/ 程序员/ 的/ 编程/ 难度/ 、/ 简化/ 编程/ ,/ 同时/ “/ 暴露/ ”/ 与/ 性能/ 相关/ 的/ 体系结构/ 特征/ ,/ 使/ 程序员/ 能/ 进行/ 有效/ 控制/ ,/ 以/ 得到/ 顶级/ 性能/ 的/ 代码/ ./ 基于/ 上述/ 思想/ ,/ 我们/ 实现/ 了/ GPU/ 集群/ 上/ 的/ 编程/ 工具/ Parray/ ./ Parray/ 是/ 一种/ 针对/ 异构/ 集群/ 体系结构/ 特点/ 设计/ 的/ 编程/ 接口/ [/ 5/ -/ 6/ ]/ ,/ 通过/ 引入/ 数组/ 类型/ 对/ C语言/ 进行/ 扩充/ ./ Parray/ 使用/ 数组/ 类型/ 对/ 数据/ 的/ 物理/ 存储/ 和/ 逻辑/ 结构/ 进行/ 分离/ ,/ 为/ 多维/ 数组/ 维度/ 逻辑/ 操作/ 提供/ 程序语言/ 层面/ 的/ 支持/ ;/ Parray/ 使用/ 统一/ 的/ 线程/ 数组/ 类型/ 表示/ 各种/ 进程/ (/ 线程/ )/ 的/ 创建/ 以及/ 它们/ 之间/ 的/ 控制/ 流转/ ./ 本文/ 首先/ 介绍/ Parray/ 的/ 数组/ 类型/ ./ 之后/ ,/ 通过/ 矩阵/ 乘法/ 实例/ 演示/ Parray/ 程序设计/ 的/ 特点/ :/ 该/ 程序/ 由/ 一个/ 单/ CPU/ 线程/ 程序/ 演变/ 为/ 多/ CPU/ 线程/ 程序/ 、/ 再/ 演变/ 为/ GPU/ 线程/ 程序/ ./ 由于/ 使用/ Parray/ 针对/ 数据/ 的/ 逻辑/ 结构/ 进行/ 编程/ ,/ 代码/ 可以/ 运行/ 于/ 不同/ 的/ 数组/ 物理/ 存储/ 方式/ ;/ 由于/ 对/ 不同/ 种类/ 线程/ 使用/ 统一/ 的/ 数组/ 表示/ 方式/ ,/ 程序/ 的/ 各次/ 演变/ 仅/ 通过/ 数组/ 类型/ 的/ 变化/ 和/ 代码/ 的/ 细微/ 修改/ 即可/ 完成/ ./ 本文/ 最后/ 介绍/ 使用/ Parray/ 实现/ 的/ 高性能/ GPU/ 矩阵/ 乘法/ ,/ 在/ 天河/ 1A/ 单/ 节点/ 上/ 的/ 测试/ 性能/ 和/ CUBLAS4/ ./ 0/ 相当/ ,/ 同时/ 也/ 给出/ 该/ 代码/ 工作/ 于/ 不同/ 物理/ 存储/ 方式/ 数组/ 的/ 测试/ 性能/ ./ 使用/ Parray/ 实现/ 的/ 另/ 一个/ 典型/ 代码/ 为/ GPU/ 集群/ 上/ 的/ FFT/ ,/ 该/ 代码/ 在/ 天河/ 1A/ 上/ 进行/ 了/ 全/ 系统/ 性能/ 测试/ ;/ 由于/ 篇幅/ 限制/ ,/ 此/ 工作/ 将/ 在/ 其他/ 论文/ 中/ 进行/ 介绍/ ./ 2Parray/ 的/ 数组/ 类型/ Parray/ 是/ 一种/ 针对/ GPU/ 和/ GPU/ 集群/ 的/ 编程/ 接口/ [/ 5/ -/ 6/ ]/ ./ Parray/ 通过/ 数组/ 类型/ ,/ 实现/ 了/ 数组/ 数据/ 物理/ 存储/ 与/ 逻辑/ 结构/ 概念/ 上/ 的/ 分离/ ,/ 本节/ 将/ 介绍/ Parray/ 中/ 各种/ 不同/ 的/ 数组/ 类型/ 和/ 使用/ 方法/ ./ 同时/ ,/ Parray/ 以/ 统一/ 方式/ 表示/ 各种/ 进程/ (/ 线程/ )/ 的/ 创建/ 以及/ 它们/ 之间/ 的/ 控制/ 流转/ ./ 2.1/ 自然/ 数组/ 自然/ 数组/ 指/ 的/ 是/ 数组/ 数据/ 元素/ 的/ 逻辑/ 下标/ 和/ 物理/ 偏移/ 相一致/ 的/ 数组/ 类型/ ./ 如图/ 1/ 所示/ ,/ 为/ Parray/ 的/ 自然/ 数组/ 示例/ 代码/ ./ 1/ .#/ parray/ {/ pinnedfloat/ [/ [/ 3/ ]/ [/ 2/ ]/ ]/ [/ 4/ ]/ }/ 犃/ 2/ .#/ create/ 犃/ (/ x/ )/ 3/ ./ for/ (/ inti/ =/ 0/ ;/ i/ </ $/ dim/ (/ 犃/ )/ $/ ;/ i/ ++/ )/ x/ [/ $/ 犃/ [/ i/ ]/ $/ ]/ =/ i/ -/ 1/ ;/ 4/ ./ printf/ (/ "/ arrayaccess/ :/ %/ d/ \/ n/ "/ ,/ x/ [/ $/ 犃/ [/ 5/ ]/ [/ 2/ ]/ $/ ]/ )/ ;/ 5/ ./ printf/ (/ "/ numberofrows/ =/ %/ d/ \/ n/ "/ ,/ $/ dim/ (/ 犃/ _/ 0/ )/ $/ )/ ;/ 6/ .#/ destroy/ 犃/ (/ x/ )/ 在/ Parray/ 代码/ 中/ ,/ 与/ Parray/ 有关/ 的/ 成分/ 通常/ 为/ 以/ “/ #/ ”/ 起始/ 的/ 一段/ 代码/ 或/ 以成/ 对/ 的/ “/ $/ ”/ 括起/ 的/ 代码/ ./ 这样/ ,/ Parray/ 编译器/ 可以/ 对/ 该/ 代码/ 方便/ 的/ 进行/ 预处理/ ,/ 提取/ Parray/ 有关/ 的/ 语言/ 成分/ ,/ 并/ 展开/ 成为/ 目标/ C语言/ 代码/ ./ 在/ 该/ 代码/ 片段/ 中/ ,/ 第/ 1/ 行/ 首先/ 声/ Page3/ 明/ 一个/ 数组/ 类型/ 犃/ ,/ 该/ 类型/ 为/ [/ [/ 3/ ]/ [/ 2/ ]/ ]/ [/ 4/ ]/ 维度/ 的/ 浮点数/ (/ 可以/ 视为/ 6/ 行/ 4/ 列/ 的/ 数组/ ,/ 其中/ 行/ 维度/ 6/ 又/ 被/ 分解/ 为/ 3/ 和/ 2/ 两个/ 维度/ )/ ,/ 且/ 存储/ 的/ 物理/ 位置/ 为/ 不/ 分页/ 内存/ (/ pinned/ 表示/ )/ ;/ 该行/ 代码/ 只是/ 声明/ 一种/ 类型/ ,/ 即/ 看待/ 物理/ 存储器/ 中/ 数据/ 存储/ 的/ 一种/ 方式/ ,/ 而/ 并未/ 分配/ 其/ 需要/ 的/ 真正/ 的/ 物理/ 存储空间/ ./ 而后/ ,/ 第/ 2/ 行/ 代码/ 使用/ Parray/ 的/ create/ 语句/ ,/ 声明/ 一个/ 浮点数/ 的/ 指针/ x/ ,/ 按照/ 犃/ 类型/ 的/ 需要/ 分配/ 相应/ 的/ 物理/ 存储器/ 空间/ ,/ 即/ 不/ 分页/ 内存/ 中/ 可以/ 存储/ (/ 3/ ×/ 2/ )/ ×/ 4/ 个/ 浮点数/ 的/ 空间/ ,/ 空间/ 的/ 起始/ 地址/ 存储/ 在/ 指针/ x/ 中/ ./ 第/ 3/ 行/ 循环/ 语句/ 对/ x/ 指向/ 的/ 数组/ 进行/ 初始化/ ,/ $/ dim/ (/ 犃/ )/ $/ 代表/ 类型/ 犃/ 的/ 维度/ 大小/ 即/ 24/ ,/ $/ 犃/ [/ i/ ]/ $/ 代表/ 按照/ 犃/ 的/ 根/ 维度/ 取/ 第/ i/ 个/ 元素/ 的/ 偏移量/ ./ 当然/ ,/ 由于/ 犃/ 为/ 自然/ 数组/ ,/ $/ 犃/ [/ i/ ]/ $/ 等于/ i/ ./ 第/ 4/ 行/ 代码/ 打印/ x/ [/ $/ 犃/ [/ 5/ ]/ [/ 2/ ]/ $/ ]/ 的/ 元素/ 值/ ,/ 其中/ $/ 犃/ [/ 5/ ]/ [/ 2/ ]/ $/ 代表/ 对应/ 犃/ 类型/ 的/ 行和列/ 维度/ (/ 即/ 犃/ _/ 0/ 维度/ 和/ 犃/ _/ 1/ 维度/ )/ 值/ 分别/ 为/ 5/ 和/ 2/ 的/ 元素/ 的/ 物理/ 偏移/ 值/ ./ 第/ 5/ 行/ 代码/ 打印/ 类型/ 犃/ 的/ 犃/ _/ 0/ 维度/ 的/ 大小/ ,/ 即/ 类型/ 犃/ 的/ 行/ 数值/ 6/ ./ 最后/ ,/ 第/ 6/ 行/ 代码/ 释放/ x/ 指针/ 指向/ 的/ 对应/ 类型/ 犃/ 的/ 物理/ 存储空间/ ./ 数组/ 的/ 嵌套/ 维度/ 构成/ 维度/ 的/ 树结构/ ./ 对于/ 图/ 1/ 中/ 定义/ 的/ 类型/ 犃/ ,/ 其/ 维度/ 构成/ 如图/ 2/ 所示/ 的/ 树结构/ ./ 对于/ 类型/ 犃/ ,/ 可以/ 将/ 其/ 视为/ 一维/ 、/ 二维/ 或/ 三维/ 数组/ ./ 作为/ 一维/ 数组/ 访问/ 时/ ,/ x/ [/ $/ 犃/ [/ i/ ]/ $/ ]/ 即为/ x/ [/ i/ ]/ ;/ 作为/ 二维/ 数组/ 访问/ 时/ ,/ x/ [/ $/ 犃/ [/ 5/ ]/ [/ 2/ ]/ $/ ]/ 即为/ x/ [/ 5/ ×/ 4/ +/ 2/ ]/ ;/ 作为/ 三维/ 数组/ 访问/ 时/ ,/ x/ [/ $/ 犃/ [/ [/ i/ ]/ [/ j/ ]/ ]/ [/ k/ ]/ $/ ]/ 即为/ x/ [/ (/ i/ ×/ 2/ +/ j/ )/ ×/ 4/ +/ k/ ]/ 或/ x/ [/ i/ ×/ 8/ +/ j/ ×/ 4/ +/ k/ ]/ ./ 根据/ 维度/ 的/ 方括号/ 嵌套/ 结构/ ,/ 类型/ 犃/ 的/ 根/ 维度/ 又/ 分解/ 为/ 类型/ 犃/ _/ 0/ 和/ 类型/ 犃/ _/ 1/ ,/ 维度/ 分别/ 为/ [/ 3/ ]/ [/ 2/ ]/ 和/ [/ 4/ ]/ ;/ 类型/ 犃/ _/ 0/ 又/ 进一步/ 分解/ 为/ 犃/ _/ 0/ _/ 0/ 和/ 犃/ _/ 0/ _/ 1/ ,/ 维度/ 分别/ 为/ [/ 3/ ]/ 和/ [/ 2/ ]/ ./ 在/ Parray/ 中/ ,/ 维度/ 的/ 名称/ 均/ 遵循/ 上述/ 的/ 命名/ 原则/ ./ 事实上/ ,/ 这些/ 分解/ 出来/ 的/ 部分/ 类型/ 亦可/ 在/ 程序/ 中/ 作为/ 已有/ 类型/ 使用/ ./ 例如/ ,/ 程序员/ 可以/ 使用/ 语句/ 1/ .#/ create/ 犃/ _/ 1/ (/ y/ )/ 在/ 不/ 分页/ 内存/ 中/ 分配/ 4/ 个/ 浮点数/ 大小/ 的/ 空间/ y/ ./ 同样/ ,/ $/ dim/ (/ 犃/ _/ 1/ )/ $/ 可以/ 用来/ 得到/ 类型/ 犃/ _/ 1/ 的/ 维度/ 大小/ ,/ 即/ 4/ ./ y/ [/ $/ 犃/ _/ 1/ [/ i/ ]/ $/ ]/ 可以/ 用来/ 访问/ y/ 指针/ 指向/ 的/ 类型/ 为/ 犃/ _/ 1/ 数组/ 的/ 第/ i/ 个/ 元素/ ./ Parray/ 中/ ,/ 自然/ 数组/ 类型/ 的/ 维度/ 和/ C语言/ 中/ 的/ 数组/ 维度/ 一样/ ,/ 遵循/ 行/ 优先/ 和/ 右侧/ 维度/ 变化/ 最快/ 的/ 原则/ ./ 图/ 1/ 中/ 定义/ 的/ 类型/ 犃/ 对应/ 的/ 数组/ 在/ 内存/ 中/ 的/ 物理/ 元素/ 分布/ 如图/ 3/ 所示/ :/ 同一/ 行/ 的/ 元素/ 在/ 内存/ 中/ 连续/ ./ 犃/ [/ [/ 0/ ]/ [/ 0/ ]/ ]/ [/ 0/ ]/ 犃/ [/ [/ 0/ ]/ [/ 0/ ]/ ]/ [/ 1/ ]/ 犃/ [/ [/ 0/ ]/ [/ 0/ ]/ ]/ [/ 2/ ]/ 犃/ [/ [/ 0/ ]/ [/ 0/ ]/ ]/ [/ 3/ ]/ 犃/ [/ [/ 0/ ]/ [/ 1/ ]/ ]/ [/ 0/ ]/ 犃/ [/ [/ 0/ ]/ [/ 1/ ]/ ]/ [/ 1/ ]/ 犃/ [/ [/ 0/ ]/ [/ 1/ ]/ ]/ [/ 2/ ]/ 犃/ [/ [/ 0/ ]/ [/ 1/ ]/ ]/ [/ 3/ ]/ 犃/ [/ [/ 1/ ]/ [/ 0/ ]/ ]/ [/ 0/ ]/ 犃/ [/ [/ 1/ ]/ [/ 0/ ]/ ]/ [/ 1/ ]/ 犃/ [/ [/ 1/ ]/ [/ 0/ ]/ ]/ [/ 2/ ]/ 犃/ [/ [/ 1/ ]/ [/ 0/ ]/ ]/ [/ 3/ ]/ 犃/ [/ [/ 1/ ]/ [/ 1/ ]/ ]/ [/ 0/ ]/ 犃/ [/ [/ 1/ ]/ [/ 1/ ]/ ]/ [/ 1/ ]/ 犃/ [/ [/ 1/ ]/ [/ 1/ ]/ ]/ [/ 2/ ]/ 犃/ [/ [/ 1/ ]/ [/ 1/ ]/ ]/ [/ 3/ ]/ 犃/ [/ [/ 2/ ]/ [/ 0/ ]/ ]/ [/ 0/ ]/ 犃/ [/ [/ 2/ ]/ [/ 0/ ]/ ]/ [/ 1/ ]/ 犃/ [/ [/ 2/ ]/ [/ 0/ ]/ ]/ [/ 2/ ]/ 犃/ [/ [/ 2/ ]/ [/ 0/ ]/ ]/ [/ 3/ ]/ 犃/ [/ [/ 2/ ]/ [/ 1/ ]/ ]/ [/ 0/ ]/ 犃/ [/ [/ 2/ ]/ [/ 1/ ]/ ]/ [/ 1/ ]/ 犃/ [/ [/ 2/ ]/ [/ 1/ ]/ ]/ [/ 2/ ]/ 犃/ [/ [/ 2/ ]/ [/ 1/ ]/ ]/ [/ 3/ ]/ 2.2/ 人工/ 数组/ 在/ Parray/ 中/ ,/ 数组/ 的/ 物理/ 存储/ 与/ 逻辑/ 视图/ 在/ 概念/ 上/ 进行/ 分离/ :/ 类型/ 提供/ 且/ 仅仅/ 提供数据/ 的/ 逻辑/ 视图/ ,/ 与/ 数据/ 的/ 物理/ 存储空间/ 无关/ ;/ 数组/ 维度/ 变换/ 和/ 转置/ 通过/ 人工/ 数组/ 实现/ ./ 人工/ 数组/ 是/ 指/ 含有/ 一个/ 或/ 多个/ 人工/ 维度/ 的/ 数组/ 类型/ ,/ 人工/ 维度/ 来自/ 于/ 对/ 已有/ 数组/ 类型/ 维度/ 的/ 引用/ ./ 人工/ 数组/ 的/ 示例/ 见/ 下列/ 代码/ (/ 如图/ 4/ )/ ./ 1/ .#/ parray/ {/ pinnedfloat/ [/ 4/ ]/ [/ 3/ ]/ }/ 犃/ 2/ .#/ parray/ {/ pinnedfloat/ [/ #/ 犃/ _/ 1/ ]/ [/ #/ 犃/ _/ 0/ ]/ }/ 犅/ 3/ .#/ create/ 犃/ (/ x/ )/ 4/ ./ x/ [/ $/ 犃/ [/ 3/ ]/ [/ 2/ ]/ $/ ]/ =/ 123/ ;/ 5/ ./ printf/ (/ "/ arrayaccess/ :/ %/ d/ \/ n/ "/ ,/ x/ [/ $/ 犅/ [/ 2/ ]/ [/ 3/ ]/ $/ ]/ )/ ;/ 6/ ./ printf/ (/ "/ numberofrows/ =/ %/ d/ \/ n/ "/ ,/ $/ dim/ (/ 犅/ _/ 0/ )/ $/ )/ ;/ 7/ .#/ destroy/ 犃/ (/ x/ )/ 图/ 4/ 的/ 代码/ 中/ ,/ 第/ 1/ 行/ 声明/ 一个/ 4/ 行/ 3/ 列/ 的/ 自然/ 数组/ 类型/ 犃/ ,/ 第/ 2/ 行/ 声明/ 一个/ 人工/ 数组/ 类型/ 犅/ ,/ 其/ 两个/ 维度/ 为/ #/ 犃/ _/ 1/ 和/ #/ 犃/ _/ 0/ ./ 以/ #/ 起始/ 的/ 维度/ 代表/ 该/ 维度/ 引用/ 自/ 其他/ 数组/ 类型/ 的/ 已有/ 维度/ ,/ 并/ 同时/ 引用/ 其/ 维度/ 数值/ 和/ 偏移/ 函数/ ./ 本例/ 中/ ,/ 数组/ 类型/ 犅/ 的/ 两个/ 维度/ 将/ 犃/ 的/ 两个/ 维度/ 进行/ 了/ 调转/ ./ 第/ 4/ 行/ 代码/ 以/ 类型/ 犃/ 的/ 视图/ 对/ 数组/ 第/ 3/ 行第/ 2/ 列/ 的/ 元素/ 赋值/ 123/ ,/ 第/ 5/ 行/ 代码/ 以/ 类型/ 犅/ 的/ 视图/ 取得/ 数组/ 第/ 2/ 行第/ 3/ 列/ 的/ 元素/ ,/ 即为/ 123/ ./ 第/ 6/ 行/ 代码/ 以/ 类型/ 犅/ 的/ 视图/ 打印/ 数组/ 的/ 行数/ ,/ 即/ 类型/ 犅/ 的/ 第/ 1/ 个/ 维度/ 的/ 维度/ 值/ ,/ 即为/ 3.2/ ./ 3/ 线程/ 数组/ 程/ 数组/ ./ 型/ 犕/ 犢/ 犜/ 犃/ ,/ 其/ 维度/ 为/ 2/ ×/ 2.1/ .#/ parray/ {/ pthd/ [/ 2/ ]/ [/ 2/ ]/ }/ 犕/ 犢/ 犜/ 犃/ 在/ Parray/ 中/ ,/ 使用/ parray/ 命令/ 同样/ 可以/ 声明/ 线/ 如下/ 代码/ 声明/ 一个/ PthreadCPU/ 线程/ 数组/ 类/ Page4/ 如下/ 代码/ 声明/ 一个/ CUDA/ 线程/ 数组/ 类型/ 犕犢犆犝犇/ 犃/ 犜/ 犃/ ,/ 其/ 维度/ 为/ 8/ ×/ 8/ ×/ 16/ ×/ 16/ ./ 由于/ Parray/ 编译器/ 会为/ 每/ 一个/ 被/ detour/ 调用/ 的/ CUDA/ 线程/ 数组/ 生成/ 相应/ 的/ 内核/ 函数/ ,/ 因此/ 在/ 代码/ 中/ 跟/ 在/ 关键字/ cuda/ 之后/ 的/ worki/ 和/ worko/ 为/ 该/ 内核/ 函数/ 的/ 形参/ ./ 1/ .#/ parray/ {/ cuda/ (/ float2/ / worki/ ,/ float2/ / worko/ )/ [/ [/ 128/ // 16/ ]/ [/ 128/ // 16/ ]/ ]/ [/ [/ 16/ ]/ [/ 16/ ]/ ]/ }/ 犕犢犆犝犇/ 犃/ 犜/ 犃/ 如下/ 代码/ 声明/ 一个/ MPI/ 进程/ 数组/ 类型/ 犕/ 犢/ 犕/ 犘/ 犐/ 犜/ 犃/ ,/ 其/ 维度/ 为/ 2.1/ .#/ parray/ {/ mpi/ [/ 2/ ]/ }/ 犕/ 犢/ 犕/ 犘/ 犐/ 犜/ 犃/ 2.4/ 线程/ 数组/ 的/ 调用/ 在/ Parray/ 中/ ,/ 和/ 数据/ 数组/ 一样/ ,/ 同构/ 的/ 进程/ 或/ 线程/ 也/ 可以/ 组成/ 数组/ ,/ 各/ 同构/ 线程/ 数组/ 执行/ 各自/ 的/ 代码/ ./ 各/ 同构/ 线程/ 数组/ 的/ 代码/ 块/ ,/ 以/ 类似/ 于/ 函数调用/ 的/ 静态/ 嵌套/ 的/ 形式/ 书写/ 于/ 相同/ 的/ 程序/ 上下文/ 中/ ./ 程序/ 的/ 控制流/ 由/ 外层/ 线程/ 数组/ 的/ 代码/ 块/ 转移/ 到/ 内层/ 线程/ 数组/ 的/ 代码/ 块/ ,/ 并/ 在/ 内层/ 线程/ 数组/ 的/ 代码/ 块/ 执行/ 完毕/ 之后/ 再/ 转移/ 回/ 外层/ 线程/ 数组/ 的/ 代码/ 块/ ./ 2.4/ ./ 1/ 主/ 进程/ 到/ 线程/ 数组/ 的/ 调用/ 图/ 5/ 是/ 一个/ 简单/ 的/ Parray/ 的/ 线程/ 数组/ 调用/ 代码/ 示例/ ./ 其中/ ,/ 第/ 1/ 行/ mainhost/ 说明/ 该/ 代码/ 是/ 一个/ 在/ 单机/ 上/ 运行/ 的/ 程序/ ,/ 并/ 开始/ 主/ 进程/ 运行/ 的/ 代码/ ;/ 第/ 2/ 行/ 通过/ parray/ 命令/ 声明/ 一个/ PthreadCPU/ 线程/ 数组/ 类型/ 犕/ 犢/ 犜/ 犃/ ,/ 该/ 数组/ 的/ 维度/ 为/ 2/ ×/ 2/ ;/ 第/ 3/ 行/ 通过/ detour/ 命令/ 调用/ 线程/ 数组/ myta/ ,/ 使得/ 其中/ 的/ 每/ 一个/ 线程/ 执行/ 第/ 4/ 行/ 的/ 打印/ 语句/ ,/ 该/ 打印/ 语句/ 打印/ 各个/ 线程/ 对应/ 的/ 自己/ 在/ 该/ 线程/ 数组/ 中/ 的/ ID/ (/ 即/ $/ tid/ $/ )/ 和/ 在线/ 程/ 数组/ 中/ 对应/ 的/ 0/ 维度/ 的/ ID/ (/ 即/ $/ tid/ _/ 0/ $/ )/ ;/ 该/ detour/ 调用/ 执行/ 完毕/ 后/ ,/ 在/ 第/ 5/ 行/ 控制/ 流程/ 转/ 回到/ mainhost/ 对应/ 的/ 主/ 进程/ ./ 1/ .#/ mainhost/ {/ 2/ .#/ parray/ {/ pthd/ [/ 2/ ]/ [/ 2/ ]/ }/ 犕/ 犢/ 犜/ 犃/ 3/ .#/ detour/ 犕/ 犢/ 犜/ 犃/ (/ )/ {/ 4/ ./ printf/ (/ "/ myta/ %/ d/ %/ d/ \/ n/ "/ ,/ $/ tid/ $/ ,/ $/ tid/ _/ 0/ $/ )/ ;/ 5/ ./ }/ 6/ ./ }/ 图/ 5/ 中/ 代码/ 的/ 执行/ 结果/ 如图/ 6/ 所示/ ./ 1/ ./ myta002/ ./ myta103/ ./ myta214/ ./ myta312/ ./ 4.2/ CUDA/ 线程/ 数组/ 的/ 调用/ 图/ 7/ 中/ 的/ 代码/ 示例/ 了/ mainhost/ 主/ 进程/ 对/ CUDA/ 线程/ 数组/ 的/ detour/ 调用/ ,/ 该段/ 代码/ 使用/ CUDA/ 线程/ 数组/ 在/ GPU/ 上/ 对/ 128/ ×/ 128/ 的/ 正方形/ float2/ 进行/ 转置/ ./ 在/ 转置/ 过程/ 中/ ,/ 使用/ 到/ 了/ GPU/ 共享存储器/ ,/ 算法/ 基本思路/ 和/ CUDASDK/ 中/ 的/ 示例/ 是/ 一样/ 的/ ./ 在/ 代码/ 的/ 第/ 1/ 行/ ,/ 声明/ 在/ 设备/ 存储器/ 上/ 的/ 数据类型/ 犇/ 犃/ 犜/ 犃/ ,/ 该/ 类型/ 将/ 128/ ×/ 128/ 的/ 正方形/ 数据/ 做/ 了/ 进一步/ 的/ 维度/ 划分/ ,/ 将/ 其/ 划分/ 为/ 8/ ×/ 8/ 个/ 16/ ×/ 16/ 的/ 小/ 正方形/ ;/ 代码/ 的/ 第/ 2/ 行/ ,/ 声明/ 需要/ 被/ 调用/ 的/ CUDA/ 线程/ 数组/ 类型/ 犕犢犆犝犇/ 犃/ 犜/ 犃/ ,/ 其/ 维度/ 为/ 8/ ×/ 8/ ×/ 16/ ×/ 16/ ,/ 此外/ ,/ 还/ 声明/ 了/ 该/ CUDA/ 线程/ 数组/ 对应/ 内核/ 函数/ 的/ 形参/ worki/ 和/ worko/ ,/ 用来/ 向/ 内核/ 函数/ 传递/ 设备/ 存储器/ 的/ 指针/ ;/ 代码/ 的/ 第/ 3/ ~/ 4/ 行/ ,/ 声明/ 需要/ 用到/ 的/ GPU/ 共享存储器/ 的/ 自然/ 数组/ 类型/ 犃/ 和/ 人工/ 数组/ 类型/ 犅/ ,/ 用来/ 对/ 共享存储器/ 进行/ 无/ 存储体/ 冲突/ 的/ 访问/ ./ 1/ .#/ parray/ {/ dmemfloat2/ [/ [/ 128/ // 16/ ]/ [/ 16/ ]/ ]/ [/ [/ 128/ // 16/ ]/ [/ 16/ ]/ ]/ }/ 犇/ 犃/ 犜/ 犃/ 2/ .#/ parray/ {/ cuda/ (/ float2/ / worki/ ,/ float2/ / worko/ )/ 3/ .#/ parray/ {/ smemfloat2/ [/ 16/ ]/ [/ 17/ ]/ }/ 犃/ 4/ .#/ parray/ {/ smemfloat2/ [/ #/ 犃/ _/ 0/ ]/ [/ 16/ #/ 犃/ _/ 1/ ]/ }/ 犅/ 5.6/ .#/ mainhost/ {/ 7/ ./ …/ // // 初始化/ 操作/ ,/ 分配/ GPU/ 和/ 内存/ 等/ 8/ .#/ detour/ 犕犢犆犝犇/ 犃/ 犜/ 犃/ (/ adri/ ,/ adro/ )/ {/ 9/ .#/ create/ 犃/ (/ tile/ )/ 10/ ./ tile/ [/ $/ 犅/ [/ $/ tid/ _/ 1/ _/ 0/ $/ ]/ [/ $/ tid/ _/ 1/ _/ 1/ $/ ]/ $/ ]/ =/ 11/ .#/ sync/ {/ }/ 12/ ./ worko/ [/ $/ 犇/ 犃/ 犜/ 犃/ [/ [/ $/ tid/ _/ 0/ _/ 1/ $/ ]/ [/ $/ tid/ _/ 1/ _/ 0/ $/ ]/ ]/ 13/ ./ }/ 14/ ./ …/ // // 释放/ 操作/ ,/ 释放/ GPU/ 和/ 内存/ 等/ 15/ ./ }/ 在/ 代码/ 的/ mainhost/ 主/ 进程/ 中/ ,/ 首先/ 第/ 7/ 行/ 进行/ GPU/ 初始化/ 和/ 存储空间/ 分配/ 的/ 操作/ ,/ 之后/ 第/ 8/ 行/ 使用/ detour/ 命令/ 调用/ 犕犢犆犝犇/ 犃/ 犜/ 犃/ 线程/ 数组/ 对/ adri/ 指向/ 的/ 数据/ 进行/ 转置/ ,/ 结果/ 数据/ 放到/ adro/ 指针/ 的/ 位置/ ./ 在犕犢犆犝犇/ 犃/ 犜/ 犃/ 线程/ 数组/ 被/ 调用/ 执行/ 的/ 代码/ 中/ ,/ 第/ 9/ 行先/ 使用/ create/ 命令/ 分配/ 需要/ 使用/ 的/ 共享存储器/ 空间/ ,/ 之后/ 第/ 10/ 行/ 各个/ GPU/ 线程/ 通过/ 数据/ 数组/ 类型/ 访问/ 将/ 设备/ 存储器/ 中/ 的/ 数据/ 读入/ 到/ 共享存储器/ 中/ ,/ 在/ 第/ 11/ 行/ 各个/ 线程/ 块/ 进行/ 同步/ 之后/ ,/ 在/ 第/ 12/ 行/ 各个/ GPU/ 线程/ 再/ 通过/ 数据/ 数组/ 类型/ 访问/ 将/ 转置/ 后/ 的/ 共享存储器/ 中/ 的/ 数据/ 写/ 回到/ 设备/ 存储器/ 中/ ./ 最后/ ,/ 对犕犢犆犝犇/ 犃/ 犜/ 犃/ 线程/ 数组/ 中/ 的/ detour/ 调用/ 返回/ 之后/ ,/ mainhost/ 主/ 进程/ 在/ 第/ 14/ 行/ 进行/ GPU/ 和/ 存储空间/ 释放/ 的/ 操作/ ./ 需要/ 注意/ 的/ 是/ ,/ 在/ 代码/ 第/ 2/ 行/ 声明/ CUDA/ 线程/ Page5/ 数组/ 类型/ 犕犢犆犝犇/ 犃/ 犜/ 犃/ 时/ ,/ 犕犢犆犝犇/ 犃/ 犜/ 犃/ _/ 0/ 的/ 维度/ 8/ ×/ 8/ 对应/ 到/ girdDim/ ./ y/ 和/ girdDim/ ./ x/ ,/ 犕犢犆犝犇/ 犃/ 犜/ 犃/ _/ 1/ 的/ 维度/ 16/ ×/ 16/ 对应/ 到/ blockDim/ ./ y/ 和/ blockDim/ ./ x/ ;/ 与/ 此/ 相对/ 应/ ,/ 犕犢犆犝犇/ 犃/ 犜/ 犃/ 线程/ 数组/ 被/ detour/ 调用/ 的/ 代码/ 块/ 中/ ,/ $/ tid/ _/ 0/ _/ 0/ $/ 、/ $/ tid/ _/ 0/ _/ 1/ $/ 、/ $/ tid/ _/ 1/ _/ 0/ $/ 和/ $/ tid/ _/ 1/ _/ 1/ $/ 分别/ 对应/ 到/ CUDA/ 内建/ 变量/ blockIdx/ ./ y/ 、/ blockIdx/ ./ x/ 、/ threadIdx/ ./ y/ 和/ threadIdx/ ./ x/ ./ 3/ 矩阵/ 乘法/ 代码/ 演变/ 3.1/ 单/ CPU/ 线程/ 矩阵/ 乘法/ 单/ CPU/ 线程/ 矩阵/ 乘法/ 代码/ 为/ 典型/ 的/ 三重/ 循环/ ./ 使用/ Parray/ 书写/ 的/ 单/ CPU/ 线程/ 矩阵/ 乘法/ 代码/ 如图/ 8/ 所示/ ./ 代码/ 第/ 1/ 行/ 声明/ 数组/ 类型/ 犕/ ,/ 为/ 存储/ 在/ 分页/ 内存/ 中/ 的/ 1024/ ×/ 1024/ 个/ 浮点数/ 类型/ ;/ 代码/ 第/ 2/ ~/ 4/ 行/ 使用/ create/ 命令/ 在/ 内存/ 中/ 创建/ 3/ 个/ 数组/ 类型/ 犕/ 的/ 存储空间/ ,/ 起始/ 地址/ 分别/ 存储/ 在/ 指针/ 变量/ a/ 、/ b/ 和/ c/ 中/ (/ 指针/ 变量/ a/ 、/ b/ 和/ c/ 为/ 已/ 声明/ 的/ 全局变量/ )/ ;/ 代码/ 第/ 5/ ~/ 11/ 行为/ 计算/ 矩阵/ 乘法/ 的/ 典型/ 三重/ 循环/ ,/ 将/ 指针/ a/ 处/ 存储/ 的/ 数组/ 类型/ 犕/ 的/ 矩阵/ 和/ 指针/ b/ 处/ 存储/ 的/ 数组/ 类型/ 犕/ 的/ 矩阵/ 做/ 乘法/ ,/ 其/ 结果/ 存储/ 在/ 指针/ c/ 处/ :/ 循环/ 变量/ i/ 、/ 循环/ 数组/ 类型/ 犕/ 的/ _/ 0/ 维度/ 即/ $/ dim/ _/ 0/ (/ 犕/ )/ $/ =/ 1024/ 次/ ,/ 循环/ 变量/ j/ 、/ 循环/ 数组/ 类型/ 犕/ 的/ _/ 1/ 维度/ 即/ $/ dim/ _/ 1/ (/ 犕/ )/ $/ =/ 1024/ 次/ ,/ 对/ 每/ 一个/ 结果/ 矩阵/ 中/ 的/ 元素/ 做/ 计算/ ,/ 即将/ a/ [/ $/ 犕/ [/ i/ ]/ [/ k/ ]/ $/ ]/ (/ 解释/ 为/ 指针/ a/ 处/ 存储/ 的/ 视为/ 数组/ 类型/ 犕/ 的/ 数组/ 的/ i/ 行/ k/ 列/ 的/ 元素/ )/ 和/ b/ [/ $/ 犕/ [/ k/ ]/ [/ j/ ]/ $/ ]/ (/ 解释/ 为/ 指针/ b/ 处/ 存储/ 的/ 视为/ 数组/ 类型/ 犕/ 的/ 数组/ 的/ k/ 行/ j/ 列/ 的/ 元素/ )/ 相乘/ ,/ 累加/ 到/ 变量/ Cvalue/ ,/ 而后/ 将/ Cvalue/ 写/ 回到/ c/ [/ $/ 犕/ [/ i/ ]/ [/ j/ ]/ $/ ]/ (/ 解释/ 为/ 指针/ c/ 处/ 存储/ 的/ 视为/ 数组/ 类型/ 犕/ 的/ 数组/ 的/ i/ 行/ j/ 列/ 的/ 元素/ )/ ;/ 最后/ ,/ 代码/ 第/ 12/ ~/ 14/ 行/ 使用/ destroy/ 命令/ 释放/ 指针/ 变量/ a/ 、/ b/ 、/ c/ 指向/ 的/ 数组/ 类型/ 犕/ 的/ 存储空间/ ./ 1/ .#/ parray/ {/ pagedfloat/ [/ 1024/ ]/ [/ 1024/ ]/ }/ 犕/ 2/ .#/ create/ 犕/ (/ a/ )/ 3/ .#/ create/ 犕/ (/ b/ )/ 4/ .#/ create/ 犕/ (/ c/ )/ 5/ ./ for/ (/ inti/ =/ 0/ ;/ i/ </ $/ dim/ _/ 0/ (/ 犕/ )/ $/ ;/ i/ ++/ )/ 6/ ./ for/ (/ intj/ =/ 0/ ;/ j/ </ $/ dim/ _/ 1/ (/ 犕/ )/ $/ ;/ j/ ++/ )/ {/ 7/ ./ floatCvalue/ =/ 0/ ;/ 8/ ./ for/ (/ intk/ =/ 0/ ;/ k/ </ $/ dim/ _/ 1/ (/ 犕/ )/ $/ ;/ k/ ++/ )/ 9/ ./ Cvalue/ +/ =/ a/ [/ $/ 犕/ [/ i/ ]/ [/ k/ ]/ $/ ]/ / b/ [/ $/ 犕/ [/ k/ ]/ [/ j/ ]/ $/ ]/ ;/ 10/ ./ c/ [/ $/ 犕/ [/ i/ ]/ [/ j/ ]/ $/ ]/ =/ Cvalue/ ;/ 11/ ./ }/ 12/ .#/ destroy/ 犕/ (/ a/ )/ 13/ .#/ destroy/ 犕/ (/ b/ )/ 14/ .#/ destroy/ 犕/ (/ c/ )/ 3.2/ 多/ CPU/ 线程/ 矩阵/ 乘法/ 延续/ 图/ 8/ 中/ 代码/ 的/ 思路/ ,/ 可以/ 使用/ Parray/ 书写/ 出多/ CPU/ 线程/ 的/ 矩阵/ 乘法/ 代码/ ./ 如图/ 9/ 所示/ ,/ 假设/ 4/ 个/ CPU/ 线程/ 计算/ 目标/ 矩阵/ 犆/ ,/ 4/ 个/ 线程/ 根据/ 自己/ 的/ 下标/ 不同/ 分别/ 计算/ 犆/ 中/ 1/ // 4/ 方阵/ 的/ 数据/ ./ 使用/ Parray/ 书写/ 的/ 多/ CPU/ 线程/ 矩阵/ 乘法/ 代码/ 如图/ 10/ 所示/ ./ 代码/ 第/ 1/ 行/ 声明/ 数组/ 类型/ 犕/ ,/ 根据/ 图/ 12/ 所示/ ,/ 维度/ 划分/ 为/ (/ 2/ ×/ 512/ )/ ×/ (/ 2/ ×/ 512/ )/ ;/ 代码/ 第/ 2/ 行/ 声明/ CPU/ 线程/ 数组/ 类型/ 犕/ 犢/ _/ 犜/ 犃/ ,/ 维度/ 划分/ 为/ 2/ ×/ 2/ ;/ 代码/ 第/ 6/ 行对/ 线程/ 数组/ 犕/ 犢/ _/ 犜/ 犃/ 进行/ 调用/ ,/ 4/ 个/ 线程/ 分别/ 完成/ 各自/ 的/ 计算/ ,/ 每个/ 线程/ 需要/ 计算/ $/ dim/ _/ 0/ _/ 1/ (/ 犕/ )/ $/ ×/ $/ dim/ _/ 1/ _/ 1/ (/ 犕/ )/ $/ 即/ 512/ ×/ 512/ 个/ 元素/ ,/ 第/ 7/ ~/ 8/ 行/ 的/ 循环/ 变量/ i/ 和/ 循环/ 变量/ j/ 负责/ 每次/ 循环/ 计算/ 一个/ 元素/ ,/ 第/ 9/ ~/ 16/ 行即/ 为/ 计算/ 一个/ 元素/ 的/ 代码/ ./ 1/ .#/ parray/ {/ pagedfloat/ [/ [/ 2/ ]/ [/ 512/ ]/ ]/ [/ [/ 2/ ]/ [/ 512/ ]/ ]/ }/ 犕/ 2/ .#/ parray/ {/ pthd/ [/ 2/ ]/ [/ 2/ ]/ }/ 犕/ 犢/ _/ 犜/ 犃/ 3/ .#/ create/ 犕/ (/ a/ )/ 4/ .#/ create/ 犕/ (/ b/ )/ 5/ .#/ create/ 犕/ (/ c/ )/ 6/ .#/ detour/ 犕/ 犢/ _/ 犜/ 犃/ {/ 7/ ./ for/ (/ inti/ =/ 0/ ;/ i/ </ $/ dim/ _/ 0/ _/ 1/ (/ 犕/ )/ $/ ;/ i/ ++/ )/ 8/ ./ for/ (/ intj/ =/ 0/ ;/ j/ </ $/ dim/ _/ 1/ _/ 1/ (/ 犕/ )/ $/ ;/ j/ ++/ )/ {/ 9/ ./ float/ / pa/ =/ a/ +/ $/ 犕/ [/ [/ $/ tid/ _/ 0/ $/ ]/ [/ i/ ]/ ]/ [/ 0/ ]/ $/ ;/ 10/ ./ float/ / pb/ =/ b/ +/ $/ 犕/ [/ 0/ ]/ [/ [/ $/ tid/ _/ 1/ $/ ]/ [/ j/ ]/ ]/ $/ ;/ 11/ ./ floatCvalue/ =/ 0/ ;/ 12/ ./ for/ (/ intk/ =/ 0/ ;/ k/ </ $/ dim/ _/ 1/ (/ 犕/ )/ $/ ;/ k/ ++/ )/ 13/ ./ Cvalue/ +/ =/ pa/ [/ $/ 犕/ [/ 0/ ]/ [/ k/ ]/ $/ ]/ 14/ ./ / pb/ [/ $/ 犕/ [/ k/ ]/ [/ 0/ ]/ $/ ]/ ;/ 15/ ./ c/ [/ $/ 犕/ [/ [/ $/ tid/ _/ 0/ $/ ]/ [/ i/ ]/ ]/ [/ [/ $/ tid/ _/ 1/ $/ ]/ [/ j/ ]/ ]/ $/ ]/ 16/ ./ =/ Cvalue/ ;/ 17/ ./ }/ 18/ ./ }/ 19/ .#/ destroy/ 犕/ (/ a/ )/ 20/ .#/ destroy/ 犕/ (/ b/ )/ 21/ .#/ destroy/ 犕/ (/ c/ )/ 对于/ 图/ 9/ 中/ 圆点/ 所示/ 的/ 元素/ 的/ 计算/ ,/ 应该/ 由/ 下标/ 为/ (/ 1/ ,/ 0/ )/ 的/ 线程/ 完成/ ,/ 该/ 元素/ 在/ 块/ 内/ 的/ 下标/ 为/ (/ i/ ,/ j/ )/ ,/ 因此/ ,/ 该/ 元素/ 为/ c/ [/ $/ 犕/ [/ [/ 1/ ]/ [/ i/ ]/ ]/ [/ [/ 0/ ]/ [/ j/ ]/ ]/ $/ ]/ ,/ Page6/ 其中/ ,/ 通过/ 线程/ 数组/ 下标/ 1/ 和/ 0/ 对块/ 进行/ 寻址/ ,/ 通过/ 块/ 内/ 数据/ 元素/ 下标/ i/ 和/ j/ 对/ 元素/ 进行/ 偏移/ 寻址/ ,/ 更/ 一般/ 的/ ,/ 矩阵/ 犆/ 中/ 的/ 元素/ 即为/ c/ [/ $/ 犕/ [/ [/ $/ tid/ _/ 0/ $/ ]/ [/ i/ ]/ ]/ [/ [/ $/ tid/ _/ 1/ $/ ]/ [/ j/ ]/ ]/ $/ ]/ ./ 对/ 该/ 元素/ 的/ 计算/ 需要/ 图/ 12/ 中/ pa/ 指针/ 指示/ 的/ 矩阵/ 犃/ 中/ 的/ 一行/ 元素/ 和/ pb/ 指针/ 指示/ 的/ 矩阵/ 犅/ 中/ 的/ 一列/ 元素/ ./ 图/ 13/ 中/ 代码/ 第/ 9/ 行/ 计算/ pa/ 指针/ 的/ 位置/ ,/ 使用/ 线程/ 数组/ 下标/ $/ tid/ _/ 0/ $/ 和/ 块/ 内行/ 下标/ i/ 计算/ 矩阵/ 犃/ 中行/ 方向/ 的/ 偏移/ $/ 犕/ [/ [/ $/ tid/ _/ 0/ $/ ]/ [/ i/ ]/ ]/ [/ 0/ ]/ $/ ;/ 同样/ ,/ 代码/ 第/ 10/ 行/ 计算/ pb/ 指针/ 的/ 位置/ ,/ 使用/ 线程/ 数组/ 下标/ $/ tid/ _/ 1/ $/ 和/ 块/ 内列/ 下标/ j/ 计算/ 犅/ 中/ 列/ 方向/ 的/ 偏移/ $/ 犕/ [/ 0/ ]/ [/ [/ $/ tid/ _/ 1/ $/ ]/ [/ j/ ]/ ]/ $/ ./ 第/ 12/ ~/ 14/ 行/ ,/ 使用/ 循环/ 将/ 犃/ 中/ 一行/ 的/ 元素/ pa/ [/ $/ 犕/ [/ 0/ ]/ [/ k/ ]/ $/ ]/ 和/ 犅/ 中/ 一列/ 的/ 元素/ pb/ [/ $/ 犕/ [/ k/ ]/ [/ 0/ ]/ $/ ]/ 分别/ 相乘/ 并/ 累加/ ,/ 最后/ ,/ 将/ 该/ 元素/ 的/ 计算结果/ 写/ 回到/ c/ [/ $/ 犕/ [/ [/ $/ tid/ _/ 0/ $/ ]/ [/ i/ ]/ ]/ [/ [/ $/ tid/ _/ 1/ $/ ]/ [/ j/ ]/ ]/ $/ ]/ ./ 3.3/ GPU/ 线程/ 矩阵/ 乘法/ 对图/ 10/ 上/ 的/ 代码/ 稍加/ 修改/ ,/ 可以/ 得到/ GPU/ 线程/ 矩阵/ 乘法/ 代码/ ./ GPU/ 线程/ 矩阵/ 乘法/ 代码/ 如图/ 11/ 所示/ ,/ 与/ 图/ 10/ 代码/ 的/ 区别/ 用/ 下划线/ 标出/ ./ 第/ 1/ 行/ 声明/ 数组/ 类型/ 犕/ 为/ GPU/ 设备/ 存储器/ 类型/ ,/ 这样/ 在/ 第/ 5/ ~/ 7/ 行/ 执行/ create/ 指令/ 时/ ,/ 创建/ 的/ 存储空间/ 位于/ GPU/ 设备/ 存储器/ ;/ 第/ 2/ 行/ 声明/ 犕/ 犢/ _/ 犜/ 犃/ 为/ GPU/ 线程/ 数组/ 类型/ ,/ 同时/ 给出/ 该/ GPU/ 线程/ 数组/ 对应/ 内核/ 函数/ 的/ 形式参数/ 列表/ ,/ 第/ 8/ 行在/ 调用/ GPU/ 线程/ 数组/ 犕/ 犢/ _/ 犜/ 犃/ 时/ ,/ 将/ 实参/ 列表/ 传递/ 给/ 内核/ 函数/ (/ 此例/ 中/ ,/ 形参/ 和/ 实参/ 均/ 为/ a/ 、/ b/ 和/ c/ )/ ;/ 除此之外/ ,/ 图/ 11/ 中/ 的/ 代码/ 和/ 图/ 10/ 的/ 代码/ 完全相同/ ./ 注意/ ,/ 图/ 11/ 代码/ 中/ 不/ 包括/ 对/ GPU/ 设备/ 存储器/ 数据传输/ 或/ 初始化/ 的/ 内容/ ./ 1/ .#/ parray/ {/ dmemfloat/ [/ [/ 2/ ]/ [/ 512/ ]/ ]/ [/ [/ 2/ ]/ [/ 512/ ]/ ]/ }/ 犕/ 2/ .#/ parray/ {/ cuda/ (/ float/ / a/ ,/ float/ / b/ ,/ float/ / c/ )/ 3/ ./ [/ 2/ ]/ [/ 2/ ]/ }/ 犕/ 犢/ _/ 犜/ 犃/ 4/ ./ INIT/ _/ GPU/ (/ 0/ )/ ;/ 5/ .#/ create/ 犕/ (/ a/ )/ 6/ .#/ create/ 犕/ (/ b/ )/ 7/ .#/ create/ 犕/ (/ c/ )/ 8/ .#/ detour/ 犕/ 犢/ _/ 犜/ 犃/ (/ a/ ,/ b/ ,/ c/ )/ {/ 9/ ./ for/ (/ inti/ =/ 0/ ;/ i/ </ $/ dim/ _/ 0/ _/ 1/ (/ 犕/ )/ $/ ;/ i/ ++/ )/ 10/ ./ for/ (/ intj/ =/ 0/ ;/ j/ </ $/ dim/ _/ 1/ _/ 1/ (/ 犕/ )/ $/ ;/ j/ ++/ )/ {/ 11/ ./ float/ / pa/ =/ a/ +/ $/ 犕/ [/ [/ $/ tid/ _/ 0/ $/ ]/ [/ i/ ]/ ]/ [/ 0/ ]/ $/ ;/ 12/ ./ float/ / pb/ =/ b/ +/ $/ 犕/ [/ 0/ ]/ [/ [/ $/ tid/ _/ 1/ $/ ]/ [/ j/ ]/ ]/ $/ ;/ 13/ ./ floatCvalue/ =/ 0/ ;/ 14/ ./ for/ (/ intk/ =/ 0/ ;/ k/ </ $/ dim/ _/ 1/ (/ 犕/ )/ $/ ;/ k/ ++/ )/ 15/ ./ Cvalue/ +/ =/ pa/ [/ $/ 犕/ [/ 0/ ]/ [/ k/ ]/ $/ ]/ 16/ ./ / pb/ [/ $/ 犕/ [/ k/ ]/ [/ 0/ ]/ $/ ]/ ;/ 17/ ./ c/ [/ $/ 犕/ [/ [/ $/ tid/ _/ 0/ $/ ]/ [/ i/ ]/ ]/ [/ [/ $/ tid/ _/ 1/ $/ ]/ [/ j/ ]/ ]/ $/ ]/ 18/ ./ =/ Cvalue/ ;/ 19/ ./ }/ 20/ ./ }/ 21/ .#/ destroy/ 犕/ (/ a/ )/ 22/ .#/ destroy/ 犕/ (/ b/ )/ 23/ .#/ destroy/ 犕/ (/ c/ )/ 3.4/ 演变/ 的/ GPU/ 线程/ 矩阵/ 乘法/ 实际上/ ,/ 图/ 11/ 中/ 的/ 代码/ 使用/ 了/ 4/ 个/ GPU/ 线程/ 计算/ 矩阵/ 乘法/ ,/ 这/ 并/ 不/ 符合/ GPU/ 体系结构/ 计算/ 的/ 特点/ ./ 理想/ 的/ 做法/ 是/ 使用/ 1024/ ×/ 1024/ 个/ GPU/ 线程/ ,/ 每/ 一个/ 线程/ 计算/ 犆/ 中/ 的/ 一个/ 元素/ ,/ 得到/ 图/ 12/ 所示/ 代码/ ./ 与/ 图/ 11/ 代码/ 的/ 区别/ 以/ 粗/ 斜体/ 标出/ :/ 第/ 1/ 行/ 和/ 第/ 2/ 行/ 分别/ 修正/ 数组/ 类型/ 犕/ 和/ 线程/ 数组/ 犕/ 犢/ _/ 犜/ 犃/ 的/ 维度/ 大小/ ,/ 程序/ 其他/ 部分/ 不变/ ./ 1/ .#/ parray/ {/ dmemfloat/ [/ [/ 1024/ ]/ [/ 1/ ]/ ]/ [/ [/ 1024/ ]/ [/ 1/ ]/ ]/ }/ 犕/ 2/ .#/ parray/ {/ cuda/ (/ float/ / a/ ,/ float/ / b/ ,/ float/ / c/ )/ 3/ ./ [/ 1024/ ]/ [/ 1024/ ]/ }/ 犕/ 犢/ _/ 犜/ 犃/ 4/ ./ INIT/ _/ GPU/ (/ 0/ )/ ;/ 5/ .#/ create/ 犕/ (/ a/ )/ 6/ .#/ create/ 犕/ (/ b/ )/ 7/ .#/ create/ 犕/ (/ c/ )/ 8/ .#/ detour/ 犕/ 犢/ _/ 犜/ 犃/ (/ a/ ,/ b/ ,/ c/ )/ {/ 9/ ./ for/ (/ inti/ =/ 0/ ;/ i/ </ $/ dim/ _/ 0/ _/ 1/ (/ 犕/ )/ $/ ;/ i/ ++/ )/ 10/ ./ for/ (/ intj/ =/ 0/ ;/ j/ </ $/ dim/ _/ 1/ _/ 1/ (/ 犕/ )/ $/ ;/ j/ ++/ )/ {/ 11.12/ ./ 13.14/ ./ 15.16/ ./ 17/ ./ c/ [/ $/ 犕/ [/ [/ $/ tid/ _/ 0/ $/ ]/ [/ i/ ]/ ]/ [/ [/ $/ tid/ _/ 1/ $/ ]/ [/ j/ ]/ ]/ $/ ]/ 18.19/ ./ }/ 20/ ./ }/ 21/ .#/ destroy/ 犕/ (/ a/ )/ 22/ .#/ destroy/ 犕/ (/ b/ )/ 23/ .#/ destroy/ 犕/ (/ c/ )/ 3.5/ 化简/ 的/ GPU/ 线程/ 矩阵/ 乘法/ 图/ 12/ 中/ 的/ 代码/ 可以/ 做/ 进一步/ 的/ 简化/ ./ 图/ 12/ 中/ 代码/ 第/ 1/ 行/ ,/ 大小/ 为/ 1/ 的/ 两个/ 维度/ 可以/ 省略/ ;/ 由于/ 每个/ GPU/ 线程/ 计算/ 犆/ 中/ 的/ 一个/ 元素/ ,/ 图/ 12/ 中/ 代码/ 第/ 9/ ~/ 10/ 行/ 的/ 循环/ 不再/ 需要/ ./ 简化/ 后/ 的/ 代码/ 如图/ 13/ 所示/ ./ 1/ .#/ parray/ {/ dmemfloat/ [/ 1024/ ]/ [/ 1024/ ]/ }/ 犕/ 2/ .#/ parray/ {/ cuda/ (/ float/ / a/ ,/ float/ / b/ ,/ float/ / c/ )/ 3/ ./ [/ 1024/ ]/ [/ 1024/ ]/ }/ 犕/ 犢/ _/ 犜/ 犃/ 4/ ./ INIT/ _/ GPU/ (/ 0/ )/ ;/ 5/ .#/ create/ 犕/ (/ a/ )/ 6/ .#/ create/ 犕/ (/ b/ )/ 7/ .#/ create/ 犕/ (/ c/ )/ 8/ .#/ detour/ 犕/ 犢/ _/ 犜/ 犃/ (/ a/ ,/ b/ ,/ c/ )/ {/ 9/ ./ float/ / pa/ =/ a/ +/ $/ 犕/ [/ $/ tid/ _/ 0/ $/ ]/ [/ 0/ ]/ $/ ;/ 10/ ./ float/ / pb/ =/ b/ +/ $/ 犕/ [/ 0/ ]/ [/ $/ tid/ _/ 1/ $/ ]/ $/ ;/ 11/ ./ floatCvalue/ =/ 0/ ;/ 12/ ./ for/ (/ intk/ =/ 0/ ;/ k/ </ $/ dim/ _/ 1/ (/ 犕/ )/ $/ ;/ k/ ++/ )/ 13/ ./ Cvalue/ +/ =/ pa/ [/ $/ 犕/ [/ 0/ ]/ [/ k/ ]/ $/ ]/ 14/ ./ / pb/ [/ $/ 犕/ [/ k/ ]/ [/ 0/ ]/ $/ ]/ ;/ 15/ ./ c/ [/ $/ 犕/ [/ $/ tid/ _/ 0/ $/ ]/ [/ $/ tid/ _/ 1/ $/ ]/ $/ ]/ =/ Cvalue/ ;/ 16/ ./ }/ 17/ .#/ destroy/ 犕/ (/ a/ )/ 18/ .#/ destroy/ 犕/ (/ b/ )/ 19/ .#/ destroy/ 犕/ (/ c/ )/ Page7/ 图/ 14/ 的/ 代码/ 为/ 《/ CUDA/ 编程/ 手册/ 》/ [/ 7/ ]/ 中/ 作为/ 示例/ 的/ 矩阵/ 乘法/ 内核/ 代码/ ,/ 和/ 图/ 13/ 中/ Parray/ 书写/ 的/ 代码/ 具有/ 同样/ 的/ 思路/ :/ 每个/ GPU/ 线程/ 计算/ 犆/ 中/ 的/ 一个/ 元素/ ,/ 第/ 5/ 行/ 计算/ 在/ 矩阵/ 犃/ 中/ 的/ 访问/ 偏移/ (/ 对应/ 图/ 16/ 代码/ 的/ 第/ 9/ 行/ )/ ,/ 第/ 6/ 行/ 计算/ 在/ 矩阵/ 犅/ 中/ 的/ 访问/ 偏移/ (/ 对应/ 图/ 16/ 代码/ 的/ 第/ 10/ 行/ )/ ,/ 第/ 8/ ~/ 11/ 行做/ 累加/ 计算/ 并/ 写出/ 一个/ 元素/ 的/ 计算结果/ (/ 对应/ 图/ 13/ 代码/ 的/ 第/ 12/ ~/ 15/ 行/ )/ ./ 1/ .__/ global/ __/ voidMatMulKernel2/ ./ (/ Matrix/ 犃/ ,/ Matrix/ 犅/ ,/ Matrix/ 犆/ )/ {/ 3/ ./ // // Eachthreadcomputesoneelementof/ 犆/ 4/ ./ // // byaccumulatingresultsintoCvalue5/ ./ introw/ =/ blockIdx/ ./ y/ / blockDim/ ./ y/ +/ threadIdx/ ./ y/ ;/ 6/ ./ intcol/ =/ blockIdx/ ./ x/ / blockDim/ ./ x/ +/ threadIdx/ ./ x/ ;/ 7/ ./ floatCvalue/ =/ 0/ ;/ 8/ ./ for/ (/ inte/ =/ 0/ ;/ e/ </ 犃/ ./ width/ ;/ ++/ e/ )/ 9/ ./ Cvalue/ +/ =/ 犃/ ./ elements/ [/ row/ / 犃/ ./ width/ +/ e/ ]/ 10/ ./ / 犅/ ./ elements/ [/ e/ / 犅/ ./ width/ +/ col/ ]/ ;/ 11/ ./ 犆/ ./ elements/ [/ row/ / 犆/ ./ width/ +/ col/ ]/ =/ Cvalue/ ;/ 12/ ./ }/ 图/ 14CUDA/ 编程/ 手册/ 中/ 的/ GPU/ 线程/ 矩阵/ 乘法/ 代码/ 3.6/ 不同/ 数组/ 存储/ 方式/ 的/ GPU/ 线程/ 矩阵/ 乘法/ 尽管/ 图/ 13/ 和/ 图/ 14/ 中/ 的/ 代码/ 完成/ 同样/ 的/ 功能/ ,/ 但是/ ,/ 只/ 需/ 对/ 图/ 13/ 代码/ 中/ 的/ 数组/ 类型/ 稍加/ 修改/ ,/ 便/ 可以/ 使/ 其/ 工作/ 于/ 不同/ 的/ 数组/ 物理/ 存储/ 方式/ ./ 之前/ 的/ 代码/ 均/ 工作/ 于行/ 优先/ 存储/ 的/ 数组/ ,/ 如图/ 15/ 所示/ ,/ 图中/ 线条/ 连接/ 的/ 元素/ 顺序/ 即/ 为/ 其/ 在/ 内存/ 中/ 实际/ 存储/ 的/ 顺序/ ./ 在/ 图/ 16/ 所示/ 的/ 矩阵/ 乘法/ 中/ ,/ 正方形/ 矩阵/ 并非/ 行/ 优先/ 存储/ ./ 它/ 的/ 数组/ 元素/ 的/ 存储/ 方式/ 按照/ 图中/ 线条/ 连接/ 的/ 元素/ 顺序/ 在/ 内存/ 中/ 连续/ 存储/ ./ 对图/ 13/ 中/ 的/ 代码/ 稍加/ 修改/ ,/ 得到/ 图/ 17/ 所示/ 的/ 代码/ ,/ 可以/ 工作/ 于图/ 16/ 所示/ 的/ 数组/ 物理/ 存储/ 方式/ ./ 代码/ 的/ 区别/ 以/ 粗/ 斜体/ 标出/ :/ 第/ 1/ 行/ 和/ 第/ 2/ 行/ 修改/ 了/ 数组/ 类型/ 犕/ 的/ 声明/ ,/ 程序/ 其他/ 部分/ 不变/ ./ 1/ .#/ parray/ {/ dmemfloat/ [/ 2/ ]/ [/ 1024/ ]/ [/ 512/ ]/ }/ 犃/ 2/ .#/ parray/ {/ float/ [/ #/ 犃/ _/ 1/ ]/ [/ [/ #/ 犃/ _/ 0/ ]/ [/ #/ 犃/ _/ 2/ ]/ ]/ }/ 犕/ 3/ .#/ parray/ {/ cuda/ (/ float/ / a/ ,/ float/ / b/ ,/ float/ / c/ )/ 4/ ./ [/ 1024/ ]/ [/ 1024/ ]/ }/ 犕/ 犢/ _/ 犜/ 犃/ 5/ ./ INIT/ _/ GPU/ (/ 0/ )/ ;/ 6/ .#/ create/ 犕/ (/ a/ )/ 7/ .#/ create/ 犕/ (/ b/ )/ 8/ .#/ create/ 犕/ (/ c/ )/ 9/ .#/ detour/ 犕/ 犢/ _/ 犜/ 犃/ (/ a/ ,/ b/ ,/ c/ )/ {/ 10/ ./ float/ / pa/ =/ a/ +/ $/ 犕/ [/ $/ tid/ _/ 0/ $/ ]/ [/ 0/ ]/ $/ ;/ 11/ ./ float/ / pb/ =/ b/ +/ $/ 犕/ [/ 0/ ]/ [/ $/ tid/ _/ 1/ $/ ]/ $/ ;/ 12/ ./ floatCvalue/ =/ 0/ ;/ 13/ ./ for/ (/ intk/ =/ 0/ ;/ k/ </ $/ dim/ _/ 1/ (/ 犕/ )/ $/ ;/ k/ ++/ )/ 14/ ./ Cvalue/ +/ =/ pa/ [/ $/ 犕/ [/ 0/ ]/ [/ k/ ]/ $/ ]/ 15/ ./ / pb/ [/ $/ 犕/ [/ k/ ]/ [/ 0/ ]/ $/ ]/ ;/ 16/ ./ c/ [/ $/ 犕/ [/ $/ tid/ _/ 0/ $/ ]/ [/ $/ tid/ _/ 1/ $/ ]/ $/ ]/ =/ Cvalue/ ;/ 17/ ./ }/ 18/ .#/ destroy/ 犕/ (/ a/ )/ 19/ .#/ destroy/ 犕/ (/ b/ )/ 20/ .#/ destroy/ 犕/ (/ c/ )/ 图/ 17/ 不同/ 数组/ 存储/ 方式/ 的/ GPU/ 线程/ 矩阵/ 乘法/ 代码/ 图/ 17/ 中/ 代码/ 第/ 1/ 行/ 声明/ 自然/ 数组/ 类型/ 犃/ ,/ 其/ 维度/ 为/ 2/ ×/ 1024/ ×/ 512/ ,/ 对应/ 图/ 16/ 中/ 数组/ 的/ 物理/ 存储/ 方式/ ,/ 即/ 数组/ 左右/ 两边/ 2/ 个/ 1024/ ×/ 512/ 的/ 数据/ ,/ 在/ 内存/ 中/ 连续/ 存储/ ;/ 第/ 2/ 行/ 声明/ 人工/ 数组/ 类型/ 犕/ ,/ 犕/ 的/ _/ 0/ 维度/ 为/ #/ 犃/ _/ 1/ ,/ 即/ 犃/ 的/ _/ 1/ 维度/ ,/ 大小/ 为/ 1024/ ,/ 犕/ 的/ _/ 1/ 维度/ 为/ [/ #/ 犃/ _/ 0/ ]/ [/ #/ 犃/ _/ 2/ ]/ ,/ 即/ 犃/ 的/ _/ 0/ 维度/ 和/ _/ 2/ 维度/ ,/ 大小/ 为/ 2/ ×/ 512/ ./ 这样/ ,/ 通过/ 人工/ 数组/ 类型/ 犕/ ,/ 将/ 物理/ 存储/ 为/ 自然/ 数组/ 类型/ 犃/ 的/ 数据/ ,/ 从/ 逻辑/ 上/ 视为/ 1024/ ×/ 1024/ 的/ 正方形/ 数组/ ./ 同理/ ,/ 可以/ 修改/ 图/ 17/ 中/ 数组/ 类型/ 犕/ 的/ 声明/ ,/ 使/ 之/ 可以/ 计算/ 其他/ 物理/ 存储/ 方式/ 的/ 数组/ ,/ 程序/ 其他/ 部分/ 不变/ ./ 对于/ 图/ 18/ (/ a/ )/ 中/ 示意/ 的/ 数组/ 存储/ 方式/ ,/ 只/ 需/ 将/ 数组/ 类型/ 犕/ 的/ 声明/ 修改/ 为/ 如下/ 即可/ :/ 1/ .#/ parray/ {/ dmemfloat/ [/ 4/ ]/ [/ 1024/ ]/ [/ 256/ ]/ }/ 犃/ 2/ .#/ parray/ {/ float/ [/ #/ 犃/ _/ 1/ ]/ [/ [/ #/ 犃/ _/ 0/ ]/ [/ #/ 犃/ _/ 2/ ]/ ]/ }/ 犕/ 对于/ 图/ 18/ (/ b/ )/ 中/ 示意/ 的/ 数组/ 存储/ 方式/ ,/ 只/ 需/ 将/ 数组/ 类型/ 犕/ 的/ 声明/ 修改/ 为/ 如下/ 即可/ :/ 1/ .#/ parray/ {/ dmemfloat/ [/ 2/ ]/ [/ 2/ ]/ [/ 512/ ]/ [/ 512/ ]/ }/ 犃/ 2/ .#/ parray/ {/ float/ [/ [/ #/ 犃/ _/ 0/ ]/ [/ #/ 犃/ _/ 2/ ]/ ]/ [/ [/ #/ 犃/ _/ 1/ ]/ [/ #/ 犃/ _/ 3/ ]/ ]/ }/ 犕/ 4GPU/ 高性能/ 矩阵/ 乘法/ 4.1/ 算法/ 描述/ 在/ GPU/ 上/ 计算/ 矩阵/ 犃/ 和/ 矩阵/ 犅/ 的/ 乘积/ 得到/ 矩/ Page8/ 阵/ 犆/ 的/ 计算/ 可以/ 按照/ 下述/ 分块/ 的/ 方式/ 进行/ :/ 每/ 一个/ 线程/ 块/ 负责/ 计算/ 矩阵/ 犆/ 的/ 一个/ 子块/ Csub/ ,/ 而/ 该/ 线程/ 块/ 中/ 的/ 每/ 一个/ 线程/ 负责/ 计算/ 子块/ Csub/ 中/ 的/ 若干个/ 元素/ ./ Csub/ 是/ 两个/ 长方形/ 矩阵/ 的/ 乘积/ :/ 矩阵/ 犃/ 的/ 和/ Csub/ 具有/ 相同/ 行数/ 的/ 长方形/ 矩阵/ 乘以/ 矩阵/ 犅/ 的/ 和/ Csub/ 具有/ 相同/ 列数/ 的/ 长方形/ 矩阵/ ,/ 如图/ 19/ 所示/ ./ 由于/ GPU/ 硬件/ 存储/ 的/ 限制/ ,/ 这/ 两个/ 长方形/ 的/ 矩阵/ 也/ 被/ 分割/ 为/ 相应/ 的/ 子块/ ,/ 称为/ Asub/ 和/ Bsub/ ,/ Csub/ 为/ 对应/ Asub/ 和/ Bsub/ 子块/ 矩阵/ 乘积/ 的/ 和/ ./ Csub/ 的/ 大小/ 决定/ 了/ 每轮/ 运算/ 必须/ 被/ 加载/ 到/ GPU/ 芯片/ 的/ 数据量/ 大小/ ./ 如果/ Csub/ 过/ 小/ ,/ 则/ SGEMM/ 会/ 变成/ 一个/ 带宽/ 受限/ 的/ 问题/ ./ 假设/ Asub/ 、/ Bsub/ 和/ Csub/ 的/ 大小/ 分别/ 为/ m/ ×/ k/ 、/ k/ ×/ n/ 和/ m/ ×/ n/ ,/ 而/ 矩阵/ 犃/ 、/ 犅/ 和/ 犆/ 分别/ 被/ 分为/ M/ ×/ K/ 、/ K/ ×/ N/ 和/ M/ ×/ N/ 个/ 这样/ 的/ 子块/ ./ 计算/ 一个/ Csub/ 需要/ 从/ 设备/ 存储器/ 中取/ K/ 个/ Asub/ 和/ Bsub/ ./ 由于/ 在/ 矩阵/ 犆/ 中/ 有/ M/ ×/ N/ 个/ Csub/ ,/ 则/ 整个/ 计算/ 需要/ 从/ 设备/ 存储器/ 中取/ M/ ×/ m/ ×/ N/ ×/ n/ ×/ K/ ×/ k/ ×/ (/ 1/ // m/ +/ 1/ // n/ )/ 个/ 浮点数/ ./ 在/ 文献/ [/ 1/ ]/ 中/ 对/ 文献/ [/ 8/ ]/ 中/ 的/ 实现/ 进行/ 了/ 改进/ ,/ 该/ 算法/ 以行/ 优先/ 的/ 方式/ 设计/ ./ 线程/ 块/ 的/ 线程/ 数目/ 为/ 128/ ,/ 被/ 组织/ 成/ 4/ ×/ 32/ 的/ 格式/ ./ Csub/ 的/ 大小/ 为/ 16/ ×/ 256/ ./ 每/ 一个/ 线程/ 块/ 负责/ 计算/ 一个/ Csub/ ,/ 而/ 一个/ 线程/ 负责/ 计算/ Csub/ 中/ 的/ 两列/ ./ 图/ 20/ 显示/ 了/ 每/ 一个/ 线程/ 块/ 的/ 流程图/ ./ 首先/ ,/ 线程/ 块/ 申请/ 16/ ×/ 32/ 的/ 共享存储器/ 空间/ 用于/ 存储/ 矩阵/ 犃/ 的/ 子/ 块/ ,/ 每/ 一个/ 线程/ 申请/ 寄存器/ 用于/ 存储/ Csub/ 中/ 的/ 16/ 个/ float2/ ,/ 即/ 32/ 个/ float/ ./ 在/ 使用/ 线程/ ID/ 计算/ 出/ 访问/ 矩阵/ 犃/ 、/ 犅/ 和/ 犆/ 的/ 指针/ 位置/ 之后/ ,/ 进入/ 一个/ 循环/ ./ 在/ 每/ 一轮/ 循环/ 中/ ,/ 一个/ 线程/ 块/ 从/ 设备/ 存储器/ 中/ 读入/ 16/ ×/ 32/ 的/ Asub/ 的/ 数据/ 到/ 共享存储器/ 中/ ,/ 之后/ ,/ 又/ 一个/ 内层/ 的/ 循环/ 被/ 执行/ :/ 在/ 每/ 一轮/ 内层/ 循环/ 中/ ,/ 一个/ 线程/ 从/ 矩阵/ 犅/ 中/ 读入/ 一个/ float2/ ,/ 把/ 这/ 两个/ float/ 和/ 共享存储器/ 中/ 相应/ 的/ 数据/ 做/ 计算/ ,/ 将/ 结果/ 累加/ 到/ Csub/ 对应/ 的/ 寄存器/ 中/ ./ 最后/ ,/ 每个/ 线程/ 将/ 其/ 计算/ 的/ 两列/ Csub/ 的/ 数据/ 写回/ 设备/ 存储器/ 中/ ./ 使用/ Parray/ 实现/ 的/ 文献/ [/ 1/ ]/ 中/ GPU/ 高性能/ 矩阵/ 乘法/ 算法/ 的/ 代码/ 如图/ 21/ 所示/ ./ 1/ .#/ subprogSGEMM/ (/ da/ ,/ db/ ,/ dc/ ,/ type/ )/ 2/ .#/ global/ {/ 3/ .#/ parray/ {/ cuda/ (/ float/ / a/ ,/ float/ / b/ ,/ float/ / c/ )/ 4/ ./ [/ [/ N/ // 16/ ]/ [/ N/ // 256/ ]/ ]/ [/ [/ 4/ ]/ [/ 32/ ]/ ]/ }/ CUDA5/ .#/ parray/ {/ dmemfloat6/ ./ [/ [/ N/ // 16/ ]/ [/ [/ 4/ ]/ [/ 4/ ]/ ]/ #/ type/ _/ 0/ ]/ [/ [/ N/ // 32/ ]/ [/ 32/ ]/ #/ type/ _/ 1/ ]/ }/ 犃/ 7/ .#/ parray/ {/ dmemfloat8/ ./ [/ [/ N/ // 32/ ]/ [/ 32/ ]/ #/ type/ _/ 0/ ]/ [/ [/ N/ // 256/ ]/ [/ [/ 128/ ]/ [/ 2/ ]/ ]/ #/ type/ _/ 1/ ]/ }/ 犅/ 9/ .#/ parray/ {/ dmemfloat/ [/ #/ 犃/ _/ 0/ ]/ [/ #/ 犅/ _/ 1/ ]/ }/ 犆/ 10/ .#/ parray/ {/ dmemfloat/ [/ #/ 犆/ _/ 0/ _/ 1/ ]/ [/ #/ 犆/ _/ 1/ _/ 1/ _/ 1/ ]/ }/ 犆/ 011/ .#/ parray/ {/ smemfloat/ [/ 32/ ]/ [/ 17/ ]/ }/ 犛/ // // avoidbankconflict12/ .#/ parray/ {/ smemfloat/ [/ 32/ #/ 犛/ _/ 0/ ]/ [/ [/ 4/ ]/ [/ 4/ ]/ #/ 犛/ _/ 1/ ]/ }/ 犛/ 013/ .#/ parray/ {/ rmemfloat/ [/ 16/ ]/ [/ 2/ ]/ }/ 犚/ 14/ ./ }/ 15/ .#/ detourCUDA/ (/ da/ ,/ db/ ,/ dc/ )/ {/ 16/ .#/ create/ 犛/ (/ s/ )/ 17/ .#/ create/ 犚/ (/ r/ )/ 18/ .#/ pragmaunroll19/ ./ for/ (/ inti/ =/ 0/ ;/ i/ </ $/ size/ (/ 犚/ )/ $/ ;/ i/ ++/ )/ r/ [/ i/ ]/ =/ 0/ ;/ 20/ ./ a/ +/ =/ 21/ ./ $/ 犃/ [/ [/ $/ tid/ _/ 0/ _/ 0/ $/ ]/ [/ [/ 0/ ]/ [/ $/ tid/ _/ 1/ _/ 0/ $/ ]/ ]/ ]/ [/ [/ 0/ ]/ [/ $/ tid/ _/ 1/ _/ 1/ $/ ]/ ]/ $/ ;/ 22/ ./ b/ +/ =/ $/ 犅/ [/ 0/ ]/ [/ [/ $/ tid/ _/ 0/ _/ 1/ $/ ]/ [/ [/ $/ tid/ _/ 1/ $/ ]/ [/ 0/ ]/ ]/ ]/ $/ ;/ 23/ ./ c/ +/ =/ $/ 犆/ [/ [/ $/ tid/ _/ 0/ _/ 0/ $/ ]/ [/ 0/ ]/ ]/ [/ [/ $/ tid/ _/ 0/ _/ 1/ $/ ]/ [/ [/ $/ tid/ _/ 1/ $/ ]/ [/ 0/ ]/ ]/ ]/ $/ ;/ 24/ ./ for/ (/ inti/ =/ 0/ ;/ i/ </ $/ size/ (/ 犃/ _/ 1/ _/ 0/ )/ $/ ;/ i/ ++/ )/ {/ 25/ .#/ copy/ 犃/ _/ 0/ _/ 1/ _/ 0/ (/ a/ +/ $/ 犃/ _/ 1/ _/ 0/ [/ i/ ]/ $/ )/ 26/ ./ to/ 犛/ 0/ _/ 1/ _/ 0/ (/ s/ +/ $/ 犛/ 0/ [/ $/ tid/ _/ 1/ _/ 1/ $/ ]/ [/ [/ 0/ ]/ [/ $/ tid/ _/ 1/ _/ 0/ $/ ]/ ]/ $/ )/ 27/ .#/ sync/ _/ 128/ ./ for/ (/ intm/ =/ 0/ ;/ m/ </ $/ size/ (/ 犃/ _/ 1/ _/ 1/ )/ $/ ;/ m/ ++/ )/ {/ 29/ ./ float2b2/ ;/ 30/ ./ float/ / b1/ =/ b/ +/ $/ 犅/ _/ 0/ [/ i/ ]/ [/ m/ ]/ $/ ;/ 31/ ./ if/ (/ $/ cnt/ (/ 犅/ _/ 1/ _/ 1/ _/ 1/ )/ $/ )/ b2/ =/ (/ (/ float2/ / )/ b1/ )/ [/ 0/ ]/ ;/ 32/ ./ else/ {/ b2/ ./ x/ =/ b1/ [/ 0/ ]/ ;/ b2/ ./ y/ =/ b1/ [/ $/ 犅/ _/ 1/ _/ 1/ _/ 1/ [/ 1/ ]/ $/ ]/ ;/ }/ 33/ .#/ pragmaunroll34/ ./ for/ (/ intj/ =/ 0/ ;/ j/ </ 16/ ;/ j/ ++/ )/ {/ 35/ ./ r/ [/ $/ 犚/ [/ j/ ]/ [/ 0/ ]/ $/ ]/ +/ =/ b2/ ./ x/ / s/ [/ $/ 犛/ [/ m/ ]/ [/ j/ ]/ $/ ]/ ;/ 36/ ./ r/ [/ $/ 犚/ [/ j/ ]/ [/ 1/ ]/ $/ ]/ +/ =/ b2/ ./ y/ / s/ [/ $/ 犛/ [/ m/ ]/ [/ j/ ]/ $/ ]/ ;/ }/ 37/ ./ }/ 38/ .#/ sync/ _/ 139/ ./ }/ 40/ .#/ copy/ 犚/ (/ r/ )/ to/ 犆/ 0/ (/ c/ )/ 41/ ./ }/ 42/ .#/ end/ 图/ 21Parray/ 实现/ 的/ GPU/ 高性能/ 矩阵/ 乘法/ 代码/ Page94/ ./ 2/ 性能/ 测试/ 我们/ 对/ 上述/ 代码/ 在/ 天河/ 1A/ 系统/ 单/ 节点/ 上/ 进行/ 了/ 性能/ 测试/ (/ 单/ FermiGPU/ 、/ 驱动程序/ 版本/ 为/ CUDA4/ ./ 0/ )/ ,/ 如图/ 22/ 所示/ ./ 图中/ ,/ ParraySGEMM/ 为/ Parray/ 代码/ 工作/ 于行/ 优先/ 物理/ 存储/ 方式/ 数组/ 时/ 的/ 性能/ ,/ ParraySGEMMofMatrix1/ 为/ Parray/ 代码/ 工作/ 于图/ 18/ (/ a/ )/ 示意/ 的/ 物理/ 存储/ 方式/ 数组/ 时/ 的/ 性能/ ,/ ParraySGEMMofMatrix2/ 为/ Parray/ 代码/ 工作/ 于图/ 18/ (/ b/ )/ 示意/ 的/ 物理/ 存储/ 方式/ 数组/ 时/ 的/ 性能/ ,/ CUBLAS4/ ./ 0/ 为/ 天河/ 1A/ 系统/ 预装/ 的/ CUBLAS/ 数学/ 库/ 的/ 性能/ ./ 可以/ 看出/ ,/ Parray/ 矩阵/ 乘法/ 代码/ 工作/ 于行/ 优先/ 和/ 图/ 18/ (/ a/ )/ 示意/ 的/ 物理/ 存储/ 方式/ 的/ 数组/ 时/ 性能/ 相当/ ,/ 这是/ 由于/ 在/ 这/ 两种/ 存储/ 方式/ 下/ ,/ 对/ GPU/ 设备/ 存储器/ 的/ 访问/ 都/ 是/ 以/ 基本/ 凝聚/ 的/ 方式/ 进行/ 的/ ,/ 同时/ ,/ Parray/ 矩阵/ 乘法/ 和/ CUBLAS4/ ./ 0/ 的/ 实现/ 具有/ 相当/ 的/ 性能/ ,/ 这/ 说明/ Parray/ 编程/ 接口/ 本身/ 并/ 不/ 引起/ 性能/ 的/ 损耗/ ./ 同时/ ,/ Parray/ 矩阵/ 乘法/ 代码/ 可以/ 工作/ 于图/ 18/ (/ b/ )/ 示意/ 的/ 物理/ 存储/ 方式/ 的/ 数组/ ,/ 这/ 对于/ CUBLAS4/ ./ 0/ 或/ 直接/ 使用/ CUDA/ 书写/ 的/ 代码/ 是/ 无法/ 做到/ 的/ ./ 5/ 总结/ 本文/ 介绍/ 了/ 针对/ 异构/ 集群/ 体系结构/ 特点/ 设计/ 的/ 编程/ 接口/ Parray/ ./ Parray/ 使用/ 数组/ 类型/ 对/ 数据/ 的/ 物理/ 存储/ 和/ 逻辑/ 结构/ 进行/ 分离/ ,/ 为/ 多维/ 数组/ 维度/ 逻辑/ 操作/ 提供/ 了/ 程序语言/ 层面/ 的/ 支持/ ;/ Parray/ 使用/ 统一/ 的/ 线程/ 数组/ 类型/ 表示/ 各种/ 进程/ (/ 线程/ )/ 的/ 创建/ 以及/ 它们/ 之间/ 的/ 控制/ 流转/ ./ 本文/ 通过/ 矩阵/ 乘法/ 实例/ 演示/ Parray/ 程序设计/ 的/ 特点/ :/ 该/ 程序/ 由/ 一个/ 单/ CPU/ 线程/ 程序/ 演变/ 为/ 多/ CPU/ 线程/ 程序/ 、/ 再/ 演变/ 为/ GPU/ 线程/ 程序/ ./ 由于/ 使用/ Parray/ 针对/ 数据/ 的/ 逻辑/ 结构/ 进行/ 编程/ ,/ 代码/ 可以/ 运行/ 于/ 不同/ 的/ 数组/ 物理/ 存储/ 方式/ ;/ 由于/ 对/ 不同/ 种类/ 线程/ 使用/ 统一/ 的/ 数组/ 表示/ 方式/ ,/ 程序/ 的/ 各次/ 演变/ 仅/ 通过/ 数组/ 类型/ 的/ 变化/ 和/ 代码/ 的/ 细微/ 修改/ 即可/ 完成/ ./ 本文/ 介绍/ 使用/ Parray/ 实现/ 的/ 高性能/ GPU/ 矩阵/ 乘法/ ,/ 在/ 天河/ 1A/ 单/ 节点/ 上/ 的/ 测试/ 性能/ 和/ CUBLAS4/ ./ 0/ 相当/ ,/ 同时/ 也/ 给出/ 该/ 代码/ 工作/ 于/ 不同/ 物理/ 存储/ 方式/ 数组/ 的/ 测试/ 性能/ ./ 使用/ Parray/ 实现/ 的/ 另/ 一个/ 典型/ 代码/ 为/ GPU/ 集群/ 上/ 的/ FFT/ ,/ 该/ 代码/ 在/ 天河/ 1A/ 上/ 进行/ 了/ 全/ 系统/ 性能/ 测试/ ;/ 由于/ 篇幅/ 限制/ ,/ 此/ 工作/ 将/ 在/ 其他/ 论文/ 中/ 进行/ 介绍/ ./ 

