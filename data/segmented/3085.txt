Page1/ 基于/ FPGA/ 的/ 细粒度/ 并行/ CYK/ 算法/ 加速器/ 设计/ 与/ 实现/ 夏飞/ 1/ )/ 窦勇/ 1/ )/ 宋健/ 2/ )/ 雷/ 国庆/ 1/ )/ 1/ )/ (/ 国防科学技术大学/ 计算机/ 学院/ 长沙/ 410073/ )/ 2/ )/ (/ 中国人民解放军/ 61785/ 部队/ 北京/ 100075/ )/ 摘要/ 基于/ 随机/ 上下文/ 无关/ 文法/ (/ SCFG/ )/ 理论/ 模型/ 进行/ RNA/ 二级/ 结构/ 预测/ 是/ 目前/ 采用/ 计算方法/ 研究/ RNA/ 二级/ 结构/ 的/ 一种/ 重要途径/ ./ 由于/ 基于/ SCFG/ 模型/ 的/ 标准/ 结构/ 预测/ 算法/ (/ Coche/ -/ Younger/ -/ Kasami/ ,/ CYK/ )/ 巨大/ 的/ 时空/ 复杂度/ ,/ 对/ CYK/ 算法/ 进行/ 加速/ 成为/ 计算/ 生物学/ 领域/ 一个/ 极具/ 挑战性/ 的/ 热点问题/ ./ CYK/ 的/ 并行/ 性能/ 受限于/ 算法/ 多维度/ 、/ 非/ 一致性/ 的/ 数据/ 依赖/ 关系/ 和/ 较/ 低/ 的/ 计算/ // 通信/ 比/ ,/ 现有/ 的/ 基于/ 通用/ 微处理器/ 结构/ 的/ 大规模/ 并行处理/ 方案/ 不能/ 获得/ 令人满意/ 的/ 加速/ 效果/ ,/ 并且/ 大规模/ 并行/ 计算机系统/ 硬件/ 设备/ 的/ 购置/ 、/ 使用/ 、/ 日常/ 维护/ 的/ 成本/ 高昂/ ,/ 其/ 适用性/ 受到/ 诸多/ 限制/ ./ 文中/ 在/ 深入分析/ CYK/ 算法/ 计算/ 特征/ 的/ 基础/ 上/ ,/ 基于/ FPGA/ 平台/ 提出/ 并/ 实现/ 了/ 一种/ 细粒度/ 的/ 并行/ CYK/ 算法/ ./ 设计/ 采用/ 了/ 对/ 三维/ 动态/ 规划/ 矩阵/ “/ 按/ 区域分割/ ”/ 和/ “/ 逐层/ 按列/ 并行处理/ ”/ 的/ 计算/ 策略/ 实现/ 了/ 多个/ 处理单元/ 间/ 的/ 负载/ 均衡/ ;/ 采用/ 数据/ 预取/ 、/ 滑动/ 窗口/ 和/ 数据/ 传递/ 流水线/ 实现/ 处理单元/ 间/ 的/ 数据/ 重用/ ,/ 有效/ 解决/ 了/ 计算/ 和/ 通信/ 间/ 的/ 平衡/ 问题/ ;/ 设计/ 了/ 一种/ 类似/ 脉动阵列/ (/ systolic/ -/ likearray/ )/ 结构/ 的/ 主从/ 多/ PE/ 并行计算/ 阵列/ ,/ 并/ 在/ 目前/ 最/ 大规模/ 的/ FPGA/ 芯片/ (/ XilinxXC5VLX330/ )/ 上/ 成功/ 集成/ 了/ 16/ 个/ 处理单元/ (/ processingelements/ )/ ,/ 实验/ 结果表明/ 作者/ 提出/ 的/ CYK/ 算法/ 加速器/ 结构/ 具备/ 良好/ 的/ 可扩展性/ ./ 当/ RNA/ 序列/ 长度/ 为/ 959bps/ ,/ CM/ 模型/ 状态/ 数为/ 3145/ 时/ ,/ 与/ 运行/ 在/ Intel/ 双核/ E52002/ ./ 5GHzCPU/ 、/ 2.0/ GB/ 主存/ 通用/ 计算/ 上/ 的/ Infernal/ -/ 1.0/ 软件/ 相比/ ,/ 可/ 获得/ 超过/ 14/ 倍/ 的/ 加速/ 效果/ ./ 配置/ 一个/ FP/ -/ GA/ 算法/ 加速器/ 的/ 通用/ 计算/ 平台/ 的/ 综合/ 处理/ 性能/ 与/ 包含/ 20/ 个/ Intel/ -/ XeonCPU/ 的/ PC/ 集群/ 相当/ ,/ 而/ 硬件/ 成本/ 仅为/ 后者/ 的/ 20/ %/ ,/ 系统/ 功耗/ 不到/ 后者/ 的/ 10/ %/ ./ 关键词/ 生物/ 信息学/ ;/ RNA/ ;/ 二级/ 结构/ 预测/ ;/ SCFG/ 模型/ ;/ 并行/ CYK/ 算法/ ;/ FPGA/ ;/ 硬件/ 加速器/ 1/ 引言/ 随着/ 人类/ 基因组/ 及/ 多种/ 模式/ 生物/ 测序/ 项目/ 的/ 完成/ ,/ 生物/ 信息学/ 的/ 研究/ 已/ 步入/ 后基因组/ 时代/ ./ 序列/ 比/ 对/ 和/ 搜索/ 已/ 成为/ 分子生物学/ 领域/ 最/ 重要/ 的/ 基础性/ 工作/ ./ 目前/ 在/ DNA/ 和/ 蛋白质/ 序列/ 分析/ 领域/ 已有/ 许多/ 经典/ 的/ 研究/ 工具/ ,/ 如/ BLAST/ [/ 1/ ]/ 、/ FASTA/ [/ 2/ ]/ 、/ HM/ -/ MER/ [/ 3/ ]/ 、/ ClustalW/ [/ 4/ ]/ 等/ ./ 而/ 自/ 20/ 世纪/ 80/ 年代/ 中期/ 具有/ 催化/ 性质/ 的/ RNA/ 被/ 发现/ 以来/ ,/ RNA/ 所起/ 的/ 各种/ 重要/ 生物化学/ 功能/ 如/ 蛋白质/ 装配/ 、/ mRNA/ 剪接/ 和/ 编辑/ 、/ RNA/ 与/ 蛋白质/ 的/ 相互作用/ 以及/ RNA/ 干扰/ 等/ 引起/ 了/ 人们/ 的/ 日益/ 关注/ 与/ 重视/ ./ 由于/ RNA/ 的/ 各种/ 重要/ 功能/ 与其/ 结构/ 直接/ 相关/ ,/ 并且/ RNA/ 分子结构/ 上/ 的/ 保守/ 性/ 大于/ 序列/ 的/ 保守/ 性/ ,/ 有时/ 序列/ 本身/ 相似/ 度/ 很/ 低/ 的/ 两个/ RNA/ 分子/ 有/ 可能/ 具有/ 很/ 相似/ 的/ 结构/ ,/ 所以/ 仅仅/ 采用/ 传统/ 的/ 序列/ 分析/ 工具/ (/ 如/ BLAST/ 、/ FASTA/ 等/ )/ 无法/ 满足/ 对/ RNA/ 结构/ 特性/ 研究/ 的/ 需求/ ./ 另一方面/ ,/ 由于/ 结构/ 信息/ 的/ 加入/ 大大增加/ 了/ RNA/ 序列/ 分析/ 的/ 复杂性/ ,/ 关于/ RNA/ 序列/ 分析模型/ 及/ 二级/ 结构/ 预测/ 方法/ ,/ 一直/ 是/ 近年来/ 生物/ 信息学/ 研究/ 的/ 热点/ 和/ 难点/ 问题/ ./ 目前/ ,/ 最/ 直接/ 的/ RNA/ 结构/ 测定方法/ 是/ 采用/ X射线/ 衍射/ 和/ 核磁共振/ (/ NMR/ )/ ,/ 这种/ 方法/ 虽然/ 结果/ 精确/ 可靠/ 但是/ 只有/ 在/ 有/ 条件/ 的/ 实验室/ 环境/ 下/ 才能/ 进行/ ,/ 并且/ 其/ 过程/ 非常/ 耗时/ 和/ 昂贵/ ./ 因此/ 采用/ 计算机/ 和/ 数学模型/ 预测/ RNA/ 序列/ 二级/ 结构/ 的/ 方法/ 被/ 广泛/ 采用/ ,/ 成为/ 近年来/ 研究/ 的/ 热点/ ./ 目前/ 存在/ 三类/ 主要/ 的/ RNA/ 二级/ 结构/ 预测/ 方法/ :/ 基于/ 热力学/ 模型/ 的/ Zuker/ 最小/ 自由/ 能/ 方法/ [/ 5/ ]/ 、/ 基于/ 比较/ 序列/ 分析模型/ 的/ 多/ 序列/ 比/ 对/ 方法/ [/ 6/ ]/ 和/ 基于/ 随机/ 上下文/ 无关/ 文法/ (/ SCFG/ )/ 的/ 结构/ 预测/ 方法/ [/ 7/ ]/ ./ 其中/ ,/ SCFG/ 理论/ 是/ 目前/ 最好/ 的/ RNA/ 二级/ 结构/ 建模/ 方法/ ,/ 在/ RNA/ 二级/ 结构/ 预测/ 研究/ 领域/ 占有/ 重要/ 地位/ ,/ 目前/ 基于/ SCFG/ 理论/ 模型/ 的/ 标准/ 比/ 对/ 算法/ 为/ Coche/ -/ Younger/ -/ Kasami/ ,/ 简称/ CYK/ 算法/ ./ CYK/ 算法/ 用于/ 实现/ 单条/ 序列/ 与/ 单个/ RNA/ 家族/ 的/ 共变/ 模型/ (/ covariancemodel/ ,/ 简称/ CM/ 模型/ )/ 进行/ 比/ 对/ ,/ 从而/ 判断/ 该/ RNA/ 序列/ 是否/ 属于/ 该/ 家族/ 并且/ 进一步/ 地/ 得到/ 该/ 序列/ 的/ 二级/ 结构/ ./ CYK/ 算法/ 是/ 一种/ 三维/ 动态/ 规划/ 算法/ [/ 8/ -/ 10/ ]/ ,/ 根据/ 矩阵/ 填充/ 方向不同/ ,/ 又/ 可/ 分为/ inside/ 和/ outside/ 两种/ 算法/ ,/ 但/ 本质/ 上/ 并/ 无/ 不同之处/ ./ CYK/ 算法/ 的/ 时间/ 复杂度/ 为/ O/ (/ KL2/ +/ BL3/ )/ ,/ 空间/ 复杂度/ 为/ O/ (/ KL2/ )/ ,/ 其中/ L/ 是/ RNA/ 序列/ 长度/ ,/ B/ 是/ 分支/ 状态/ 个数/ ,/ K/ 是/ CM/ 模型/ 中/ 的/ 状态/ 数/ ./ 由于/ 巨大/ 的/ 时空/ 复杂度/ ,/ 标准/ CYK/ 算法/ 并/ 不/ 适合/ 处理/ 较/ 大规模/ 的/ RNA/ 序列/ ./ 以/ LSURNA/ 序列/ 为例/ ,/ 在/ 单个/ Alpha/ 处理器/ 上/ ,/ 执行/ 不带/ 回溯/ 的/ CYK/ // inside/ 算法/ 需要/ 17391s/ [/ 11/ ]/ (/ 约/ 4.8/ h/ )/ ,/ 带/ 回溯/ 的/ CYK/ // inside/ 算法/ 则/ 需要/ 27798s/ (/ 约/ 7.72/ h/ )/ ,/ 并且/ 存储/ 需求/ 超过/ 150GB/ [/ 10/ ]/ ,/ 将/ 人类/ 全/ 基因组/ 中/ 的/ RNA/ 片段/ 与/ 目前/ Rfam/ 数据库/ 中/ 的/ RNA/ 二级/ 结构/ 模型/ 进行/ 比/ 对/ 需要/ 300/ 年/ [/ 23/ ]/ ,/ 因此/ 对/ CYK/ 算法/ 进行/ 加速/ 成为/ 一个/ 极具/ 挑战性/ 的/ 问题/ ./ 目前/ 人们/ 主要/ 采用/ 软件/ 并行/ 方案/ 基于/ 多处理器/ 平台/ 如/ Cluster/ 系统对/ CYK/ 算法/ 实现/ 加速/ ./ Hill/ 等/ 人于/ 1991/ 年/ 提出/ 了/ 一种/ 按照/ 对角线/ 方向/ 并行/ 的/ 无/ 回溯/ CYK/ // inside/ 算法/ ,/ 在/ 7/ 个/ 处理器/ 上/ 可以/ 获得/ 3.5/ 倍/ 的/ 加速/ 效果/ [/ 12/ ]/ ./ 2005/ 年/ ,/ 中国科学院/ Tan/ 等/ 人/ 提出/ 了/ 对/ 三维/ 动态/ 规划/ 矩阵/ 采用/ 层内/ 并行处理/ 策/ Page3/ 略/ ,/ 对/ 矩阵/ 进行/ 等/ 面积/ 的/ 动态/ 任务/ 划分/ ,/ 在/ 多个/ 处理器/ 上/ 并行执行/ ./ 但/ 由于/ CYK/ 算法/ 中/ 每个/ 元素/ 的/ 计算/ 量/ 与其/ 在/ 矩阵/ 中所处/ 的/ 位置/ 相关/ ,/ 这种/ 常规/ 的/ 按/ 面积/ 等/ 分/ 的/ 任务/ 划分/ 策略/ 会/ 导致/ 处理器/ 负载/ 不/ 平衡/ ,/ 并且/ 随着/ 处理器/ 个数/ 的/ 增加/ ,/ 计算/ 过程/ 中/ 的/ 通信/ 开销/ 随之/ 增长/ ./ 算法/ 复杂/ 的/ 数据/ 依赖/ 关系/ 导致/ 处理器/ 间/ 的/ 数据通信/ 粒度/ 小/ ,/ 通信/ 次数/ 频繁/ ,/ 因而/ 并行处理/ 的/ 效率/ 不高/ ./ 在/ 由/ 8/ 个/ 节点/ (/ 每个/ 节点/ 包括/ 4/ 个/ 2.4/ GHzAMDOpteronCPU/ 和/ 8GB/ 主存/ ,/ 一共/ 32/ 个/ 处理器/ )/ 构成/ 的/ Cluster/ 上/ 执行/ 长度/ 为/ 1542/ 的/ LSURNA/ 序列/ 的/ 比/ 对/ 只能/ 获得/ 19/ 倍/ 的/ 加速/ 效果/ [/ 13/ ]/ ,/ 并行处理/ 效率/ 不到/ 60/ %/ ./ 新加坡/ 南洋/ 理工大学/ Liu/ 等/ 人/ 提出/ 在/ PC/ 集群/ 上/ 按/ 状态/ 层/ 方向/ 流水/ 处理/ 的/ 层间/ 并行处理/ 方案/ ,/ 在/ 设计/ 时/ 根据/ 元素/ 位置/ 与/ 计算/ 量/ 之间/ 的/ 关系/ ,/ 在/ 进行/ 计算/ 区域/ 划分/ 时/ 采用/ 了/ 近似/ 等/ 负载/ 的/ 任务/ 划分/ 策略/ ,/ 即/ 单个/ 元素/ 计算/ 量/ 较/ 小/ 的/ 区域/ 包含/ 的/ 列数/ 较/ 多/ ,/ 单个/ 元素/ 计算/ 量/ 较大/ 的/ 区域/ 包含/ 的/ 列数/ 较/ 少/ ,/ 尽量/ 让/ 每个/ 处理器/ 负责/ 计算/ 的/ 元素/ 的/ 计算/ 量/ 之/ 和/ 相等/ 而/ 不是/ 元素/ 个数/ 相等/ ./ 研究/ 表明/ ,/ 新/ 算法/ 的/ 并行处理/ 效率/ 显著/ 提高/ (/ 在/ 包含/ 20/ 个/ Intel/ -/ Xeon2/ ./ 0GHzCPU/ 的/ 多处理器/ 平台/ 和/ 包含/ 48/ 个/ 1.0/ GHzAlphaEV68/ 处理器/ 的/ Cluster/ 上/ 执行/ LSURNA/ 序列/ 的/ 比/ 对/ ,/ 可以/ 达到/ 16/ 倍/ 和/ 36/ 倍/ 的/ 加速/ 效果/ [/ 11/ ]/ )/ ,/ 但是/ 大规模/ 并行/ 计算机系统/ 硬件/ 设备/ 的/ 购置/ 、/ 使用/ 、/ 日常/ 维护/ 的/ 成本/ 高昂/ ,/ 包含/ 20/ 个/ Intel/ -/ XeonCPU/ 的/ PCCluster/ 系统/ 硬件/ 成本/ 超过/ 20/ 万元/ ,/ 系统/ 功耗/ 超过/ 3kW/ ,/ 而/ 由/ 48/ 个/ Alpha/ 处理器/ 构成/ 的/ Cluster/ 成本/ 超过/ 40/ 万元/ ,/ 系统/ 功耗/ 超过/ 6kW/ ,/ 只有/ 少数/ 机构/ 才/ 有/ 实力/ 采购/ 使用/ ,/ 而/ 非/ 一般/ 用户/ 所/ 能/ 用得上/ ./ 近年来/ ,/ FPGA/ (/ FieldProgrammableGateArray/ )/ 器件/ 以/ 其/ 可编程/ 特性/ 、/ 细粒度/ 并行/ 能力/ 、/ 丰富/ 的/ 计算资源/ 、/ 灵活/ 的/ 算法/ 适应性/ 、/ 低/ 硬件/ 代价/ 和/ 高性能/ 功耗/ 比/ 成为/ 理想/ 的/ 可编程/ 系统/ 平台/ ./ 以/ 目前/ 世界/ 上/ 的/ 两大/ FPGA/ 芯片/ 制造商/ 的/ 高端/ 产品/ 为例/ ,/ XilinxVirtex5/ 系列/ 的/ 高端/ 产品/ XC5VLX330/ 片内/ 集成/ 了/ 51840/ 个/ Slice/ ,/ 总计/ 331776/ 个/ 逻辑/ 单元/ ;/ 288/ 个/ BRAM/ ,/ 总计/ 10368Kb/ 存储容量/ ;/ 片内/ 还/ 集成/ 了/ 192/ 个/ DSP/ 模块/ ,/ 可/ 达到/ 105GMACS/ 的/ 处理/ 能力/ ./ AlteraStratixIII/ 系列/ 的/ 高端/ 产品/ EP3SL340/ 集成/ 了/ 135200/ 个/ 自/ 适应/ 逻辑/ 模块/ (/ ALM/ )/ ,/ 338000/ 个/ 等价/ 逻辑/ 单元/ (/ LE/ )/ ;/ 1144/ 个/ M9K/ 存储器/ 模块/ 和/ 48/ 个/ M144K/ 存储器/ 模块/ ,/ 片内/ 存储容量/ 超过/ 17208Kb/ ;/ 片内/ 还/ 集成/ 了/ 576/ 个/ 18/ ×/ 18/ 乘法器/ 模块/ ,/ 可以/ 达到/ 300GMACS/ 的/ 处理/ 能力/ ./ 同时/ 现有/ 的/ 高档/ FPGA/ 芯片/ 还/ 支持/ PCI/ -/ E/ 、/ Ethernet/ 、/ RocketIO/ 等/ 多种/ IO/ 接口/ ,/ 而/ 芯片/ 硬件/ 成本/ 不足/ 2/ 万元/ ,/ 最大/ 功耗/ 不足/ 30W/ ./ 另一方面/ ,/ 由于/ 生物/ 信息学/ 领域/ 经典/ 的/ 动态/ 规划/ 算法/ 往往/ 具备/ 良好/ 的/ 位级/ (/ bit/ -/ wise/ )/ 并行性/ ,/ CPU/ 与/ FPGA/ 相结合/ 的/ 生物/ 信息学/ 算法/ 加速器/ 成为/ 了/ 研究/ 的/ 热点/ ./ 目前/ 已有/ 许多/ 基于/ FPGA/ 器件/ 对/ RNA/ 二级/ 结构/ 预测/ 方法/ 实现/ 硬件加速/ 的/ 报道/ ,/ 例如/ 2006/ 年/ Tan/ 等/ 人/ 在/ FPGA/ 上/ 实现/ 了/ 基于/ 最小/ 自由/ 能/ 模型/ 的/ 细粒度/ 并行/ Zuker/ 算法/ [/ 14/ ]/ ,/ 2008/ 年/ ArpithJacob/ 实现/ 了/ 基于/ 最大/ 碱基/ 互补/ 配对/ 模型/ 的/ Nussinov/ 算法/ [/ 15/ ,/ 21/ ]/ ,/ 但是/ 现有/ 的/ 研究/ 仅限于/ 在/ FPGA/ 上/ 对/ 二维/ 动态/ 规划/ 算法/ 的/ 并行/ 化/ ,/ 并未/ 涉及/ 到/ 更/ 高/ 维度/ 的/ CYK/ 三维/ 动态/ 规划/ 算法/ ./ 文献/ [/ 16/ -/ 17/ ]/ 基于/ FPGA/ 器件/ 实现/ 了/ CFG/ 模型/ 的/ 解析/ 过程/ ,/ 但/ 并未/ 涉及/ CYK/ 算法/ 的/ 计算/ 过程/ ./ 最近/ ,/ Moscola/ 等/ 人/ 提出/ 了/ 两种/ 基于/ FPGA/ 的/ 细粒度/ CYK/ 算法/ 并行计算/ 结构/ ,/ 该/ 结构/ 对/ 小规模/ 的/ RNA/ 序列/ 和/ CM/ 模型/ 可以/ 获得/ 大约/ 24/ 倍/ 左右/ 的/ 加速/ 比/ ,/ 但/ 该/ 结构/ 是/ 针对/ 特定/ CM/ 模型/ 的/ ,/ 为/ 特定/ CM/ 模型/ 定制/ 计算/ 逻辑/ 将/ 耗费/ 大量/ FPGA/ 逻辑/ 资源/ ,/ 目前/ 只能/ 支持/ 长度/ 大约/ 为/ 100bps/ 的/ RNA/ 二级/ 结构/ 预测/ ,/ 这/ 意味着/ Rfam8/ ./ 0/ 中/ 只有/ 5/ %/ 的/ CM/ 模型/ 能够/ 在/ Moscola/ 的/ 硬件平台/ 上/ 运行/ ./ 本文/ 针对/ 无/ 回溯/ 的/ CYK/ // inside/ 算法/ 的/ 全部/ 计算/ 过程/ ,/ 提出/ 了/ 一种/ 基于/ FPGA/ 平台/ 的/ 细粒度/ 并行算法/ ,/ 采用/ “/ 按/ 区域分割/ ”/ 和/ “/ 逐层/ 按列/ 并行处理/ ”/ 的/ 计算/ 策略/ 对/ 三维/ 动态/ 规划/ 矩阵/ 的/ 计算/ 实现/ 了/ 细粒度/ 的/ 并行/ 化/ ,/ 使得/ 多个/ 处理单元/ 间/ 的/ 负载/ 尽可能/ 均衡/ ;/ 并/ 在/ 此基础/ 上/ 设计/ 和/ 实现/ 了/ 一种/ 类似/ 脉动阵列/ (/ systolic/ -/ likearray/ )/ 结构/ 的/ 主从/ 多/ PE/ 并行计算/ 阵列/ ./ 阵列/ 由/ 一个/ 主/ 处理单元/ 和/ 多个/ 从/ 处理单元/ 串联/ 构成/ ,/ 只有/ 主/ 处理单元/ 具备/ 外部/ 存储器/ 数据/ 载入/ 权限/ ./ 设计/ 通过/ 重组/ 单元/ 计算/ 顺序/ 、/ CM/ 模型/ 预取/ 、/ 数据/ 缓存/ 、/ 滑动/ 窗口/ 和/ 数据/ 传递/ 流水线/ 等/ 策略/ 实现/ 处理单元/ 间/ 的/ 数据/ 重用/ ,/ 从而/ 减少/ 对片/ 外/ 存储/ 带宽/ 的/ 需求/ ,/ 实现/ 计算/ 和/ 通信/ 之间/ 的/ 平衡/ ./ 此外/ 本文/ 提出/ 的/ 硬件/ 算法/ 和/ 电路/ 结构/ 与/ RNA/ 序列/ 和/ CM/ 模型/ 无关/ ./ 我们/ 在/ 单个/ FPGA/ 芯片/ 上/ 成功/ 集成/ 了/ 16/ 个/ PE/ ,/ 实验/ 结果表明/ ,/ 与/ 运行/ 在/ Intel/ 双核/ E5200CPU/ ,/ 2.0/ GB/ 主存/ 通用/ 计算机/ 平台/ 上/ 的/ RNA/ 结构/ 预测/ 软件/ Infernal/ -/ 1.0/ 相比/ ,/ 可/ 获得/ 超过/ 14/ 倍/ 的/ 加速/ 效果/ ./ 配置/ 一个/ FPGA/ 算法/ 加速器/ 的/ 计算/ 平台/ 的/ 综合/ 处理/ 性能/ 与/ 包含/ 20/ 个/ Xeon2/ ./ 0GHzCPU/ 的/ Cluster/ 相当/ ,/ 而/ 硬件/ 成本/ 约/ 为/ 3.5/ 万元/ ,/ 仅为/ 后者/ 的/ 20/ %/ ;/ 系统/ 功耗/ 不/ 超过/ 200W/ ,/ 仅为/ 后者/ 的/ 10/ %/ ./ Page42CYK/ 算法/ 2.1/ 算法/ 简介/ CYK/ 算法/ 用于/ 实现/ 单条/ RNA/ 序列/ 与/ RNA/ 家族/ 对应/ CM/ (/ CovarianceModel/ )/ 模型/ 之间/ 的/ 比/ 对/ ,/ 以/ 判定/ 该/ 序列/ 是否/ 属于/ 该/ 家族/ ./ CYK/ 算法/ 考虑/ 到/ 了/ 结构/ 信息/ ,/ 是/ 一个/ 典型/ 的/ 三维/ 动态/ 规划/ 算法/ ./ 算法/ 的/ 输入/ 为/ 一条/ 长度/ 为/ L/ 的/ RNA/ 序列/ x/ =/ x1x2/ …/ xL/ 和/ 一个/ CM/ 模型/ ./ CM/ 模型/ [/ 18/ ]/ 是/ Eddy/ 和/ Durbin/ 提出/ 的/ max/ (/ i/ -/ 1/ / mid/ / j/ )/ [/ M/ (/ i/ ,/ mid/ ,/ kl/ )/ +/ M/ (/ mid/ +/ 1/ ,/ j/ ,/ kr/ )/ ]/ ,/ S/ (/ k/ )/ =/ BIF/ 图/ 1CYK/ // inside/ 算法/ 三维/ 动态/ 规划/ 矩阵/ 的/ 计算/ 过程/ 上述/ 公式/ 中/ 的/ M/ (/ i/ ,/ j/ ,/ k/ )/ 代表/ 当前/ 计算/ 的/ 元素/ ,/ i/ ,/ j/ ,/ k/ 是/ 元素/ 在/ 三维/ 矩阵/ 中/ 的/ 坐标/ ./ S/ (/ k/ )/ 表示/ 当前/ 状态/ 的/ 类型/ ,/ 其中/ BIF/ 表示/ 分支/ 状态/ ,/ 其它/ 状态/ 如/ D/ ,/ S/ ,/ MP/ ,/ ML/ ,/ IL/ ,/ MR/ ,/ IR/ ,/ E/ 统称/ 为/ 非/ 分支/ 状态/ ./ C/ (/ k/ )/ 表示/ 当前/ 状态/ 的/ 子/ 状态/ 集合/ ,/ γ/ 表示/ 当前/ 状态/ 的/ 某个/ 子/ 状态/ ,/ ek/ 和/ tk/ 分别/ 代表/ 当前/ 状态/ 下/ 的/ 字符/ 生成/ 概率/ 和子/ 状态/ 转移/ 概率/ ,/ 变量/ d/ =/ j/ -/ i/ +/ 1/ ./ 无/ 回溯/ 的/ CYK/ // inside/ 算法/ 的/ 计算/ 过程/ 是从/ 三维/ 矩阵/ 最/ 下层/ (/ 每/ 一层/ 称为/ 一个/ deck/ ,/ 它/ 对应/ CM/ 模型/ 中/ 的/ 一个/ 状态/ )/ 边缘/ 的/ 元素/ 开始/ ,/ 沿/ 对角线/ 按照/ 波前/ (/ wavefront/ )/ 顺序/ 进行/ 计算/ ./ 每层/ 元素/ 的/ 计算/ 启动/ 前/ 首先/ 判断/ CM/ 模型/ 中/ 当前/ 状态/ 层/ 的/ 类型/ ,/ 根据/ 当前/ 状态/ 类型/ 选择/ 公式/ 中/ 的/ 一个/ 分支/ 执行/ ./ 当下/ 层/ 一种/ 进行/ RNA/ 二级/ 结构/ 分析/ 的/ 概率模型/ ,/ 它/ 利用/ 了/ 随机/ 上下文/ 无关/ 文法/ (/ SCFG/ )/ ,/ 从/ 一组/ 相关/ 的/ RNA/ 序列/ 之间/ 的/ 多/ 序列/ 比/ 对/ 和/ 一致/ 结构/ 中/ 构建/ ,/ 以/ 刻画/ RNA/ 家族/ 的/ 结构/ 和/ 序列/ 信息/ ./ CM/ 模型/ 由/ K/ 个/ 不同/ 的/ 状态/ 、/ 状态/ 间/ 的/ 连接/ 关系/ 以及/ 每/ 一个/ 状态/ 对应/ 的/ 字符/ 生成/ 概率/ (/ ek/ )/ 和/ 状态/ 转移/ 概率/ (/ tk/ )/ 组成/ ,/ 而/ 状态/ 信息/ 中/ 包括/ 当前/ 状态/ 的/ 类型/ 、/ 编号/ 、/ 父/ // 子/ 状态/ 的/ 数量/ 以及/ 编号/ ./ CYK/ 算法/ 的/ 核心/ 是/ 不断/ 地/ 迭代/ 计算/ 一个/ 截面/ 为/ 三角形/ 的/ 三维/ 矩阵/ [/ 19/ ]/ (/ 如图/ 1/ 所示/ )/ ,/ 迭代/ 公式/ 如下/ (/ 1/ / i/ / j/ +/ 1/ ,/ 0/ / j/ / L/ ,/ 1/ / k/ / K/ )/ :/ deck/ 所有/ 元素/ 计算/ 完毕/ 后/ 再/ 计算/ 上/ 一层/ 的/ 元素/ ./ 计算/ 过程/ 由下/ 至上/ 逐层/ 推进/ ,/ 直到/ CM/ 模型/ 的/ 根/ 节点/ (/ 对应/ 矩阵/ 最上层/ 的/ 三角形/ )/ 中/ 的/ 所有/ 元素/ 算/ 完/ ./ 此时/ 元素/ M/ (/ 1/ ,/ L/ ,/ 1/ )/ (/ 图/ 3/ 最上层/ 三角/ 矩阵/ 顶点/ 位置/ 的/ 单元/ )/ 的/ 值/ 就是/ 最终/ 比/ 对/ 分值/ ,/ 它/ 代表/ 该/ 序列/ 与/ 当前/ RNA/ 家族/ 的/ 相似/ 度/ ./ 基于/ FPGA/ 平台/ 对/ CYK/ 算法/ 进行/ 细粒度/ 并行/ 化/ 同样/ 面临/ 一系列/ 的/ 挑战/ :/ (/ 1/ )/ CYK/ 算法/ 多维度/ 、/ 非/ 一致性/ 的/ 数据/ 依赖/ 关系/ (/ 数据/ 相关性/ 跨越/ 矩阵/ 三维空间/ ,/ 并且/ 数据/ 相关/ 距离/ 随/ 元素/ 的/ 位置/ 变化/ )/ 导致/ 计算/ 过程/ 中/ 任务/ 划分/ 困难/ ,/ 难以实现/ 负载平衡/ ;/ (/ 2/ )/ 程序/ 空间/ 局部性/ 差/ (/ 访存/ 粒度/ 小/ (/ 以/ KB/ 为/ 单位/ )/ ,/ 每次/ 读写操作/ 的/ 数据量/ 不等且/ 不/ 连续/ )/ ,/ 导致/ 访存/ 调度/ 困难/ ;/ (/ 3/ )/ FPGA/ 片内/ 存储资源/ 不能/ 满足/ 矩阵/ 犗/ (/ L3/ )/ 的/ 存储/ 需求/ ,/ 导致/ 片/ 外存储器/ 访问/ 延时/ 将/ 成为/ 提高/ 并行处理/ 效率/ 的/ 瓶颈/ ./ 在/ CM/ 模型/ 中/ ,/ 三维/ 矩阵/ 的/ 层数/ K/ 大约/ 是/ 序列/ 长度/ L/ 的/ 3/ 倍/ ,/ 以/ 长度/ 为/ 2898bps/ 的/ LSURNA/ 序列/ 为例/ ,/ 对/ 该/ 序列/ 进行/ 比/ 对/ 需要/ 计算/ 的/ 三维/ 矩阵/ 的/ 层数/ 为/ 9023/ ,/ 每层/ 的/ 存储/ 需求/ 大约/ 为/ 32MB/ ,/ 而/ 目前/ 容量/ 最大/ 的/ FPGA/ 器件/ 片内/ 存储容量/ 不足/ 2MB/ ,/ 因此/ 有限/ 的/ 片/ 内/ 存储容量/ 和/ 相对/ 较/ 低/ 的/ 存储/ 带宽/ (/ FPGA/ 工作频率/ 不到/ CPU/ 的/ 1/ // 5/ )/ 是/ 对/ CYK/ 算法/ 实现/ 硬件加速/ 的/ 瓶颈/ ./ 2.2/ 程序/ 特征/ 分析法/ 计算/ 过程/ 具备/ 以下/ 4/ 个/ 特征/ ./ 通过/ 对/ CYK/ 算法/ 的/ 进一步/ 分析/ ,/ 可以/ 发现/ 算/ Page5/ 特征/ 1/ ./ 三维/ 矩阵/ 中/ 每个/ 元素/ 的/ 计算/ 量/ 与/ 当前/ 状态/ 的/ 类型/ 和/ 所处/ 的/ 位置/ 相关/ ./ 根据/ CYK/ 算法/ 迭代/ 公式/ ,/ 如果/ 第/ k/ 层为/ 非/ 分支/ 层/ ,/ 则/ 元素/ M/ (/ i/ ,/ j/ ,/ k/ )/ 的/ 计算/ 量/ (/ 即/ 加法/ 和/ 比较/ 操作/ 的/ 执行/ 次数/ )/ 与/ 当前/ 状态/ k/ 的/ 子/ 状态/ 数量/ 有关/ ./ 例如/ MP/ 状态/ 层/ 元素/ M/ (/ i/ ,/ j/ ,/ k/ )/ 的/ 计算/ 需要/ 执行/ 7/ 次/ 加法/ 和/ 6/ 次/ 比较/ 运算/ ,/ 而/ 其它/ 非/ 分支/ 状态/ 层/ 每个/ 元素/ 的/ 计算/ 需要/ 执行/ 3/ ~/ 7/ 次/ 加法/ 和/ 比较/ 运算/ ,/ 具体/ 的/ 计算/ 量/ 由/ CM/ 模型/ 中该/ 层/ 对应/ 的/ 子/ 状态/ 数量/ 确定/ ./ 而/ 如果/ 第/ k/ 层为/ 分支/ 层/ ,/ 根据/ 公式/ 中/ 分支/ 层/ 元素/ 的/ 数据/ 依赖/ 关系/ 可知/ 元素/ M/ (/ i/ ,/ j/ ,/ k/ )/ 的/ 计算/ 量/ C/ (/ i/ ,/ j/ ,/ k/ )/ 依赖于/ 元素/ 下标/ i/ 和/ j/ 的/ 值/ ./ C/ (/ i/ ,/ j/ ,/ k/ )/ =/ j/ -/ i/ +/ 2/ ,/ 状态/ 层/ k/ 中/ 第/ j/ 列/ 元素/ M/ (/ / ,/ j/ ,/ k/ )/ 的/ 计算/ 量/ C/ (/ / ,/ j/ ,/ k/ )/ 等于/ 本列/ 所有/ 元素/ 的/ 计算/ 量/ 之/ 和/ :/ C/ (/ / ,/ j/ ,/ k/ )/ =/ (/ j/ +/ 1/ )/ / (/ j/ +/ 2/ )/ 烄/ 烅/ (/ j/ +/ 1/ )/ / s/ ,/ s/ ∈/ {/ 3/ ,/ 4/ ,/ 5/ ,/ 6/ ,/ 7/ }/ ,/ 烆/ 状态/ 层/ k/ 中/ 相邻/ 两列/ 元素/ 的/ 计算/ 量/ 之/ 差为/ Δ/ C/ (/ j/ ,/ j/ +/ 1/ ,/ k/ )/ =/ j/ +/ 2/ ,/ s/ ,/ s/ ∈/ {/ 3/ ,/ 4/ ,/ 5/ ,/ 6/ ,/ 7/ }/ ,/ 根据/ 式/ (/ 1/ )/ ,/ 可以/ 发现/ 非/ 分支/ 层/ 元素/ M/ (/ i/ ,/ j/ ,/ k/ )/ 的/ 计算/ 量/ 为/ 常数/ s/ ,/ 而/ 在/ 分支/ 层/ k/ 中/ 同列/ 元素/ 的/ 计算/ 量/ 由/ 下/ 往/ 上/ 逐渐/ 增加/ ,/ 同行/ 元素/ 的/ 计算/ 量/ 由/ 左/ 往右/ 逐渐/ 增加/ ,/ 其中/ 三角/ 矩阵/ 右上角/ 元素/ M/ (/ 1/ ,/ L/ ,/ k/ )/ {/ 图/ 2RNA/ 家族/ CM/ 模型/ 示例/ 特征/ 3/ ./ 层内/ (/ Deck/ )/ 元素/ 的/ 数据/ 依赖/ 关系/ 取决于/ 状态/ 类型/ ,/ 既/ 可能/ 存在/ 于/ 同层/ 元素/ 内部/ 也/ 可能/ 存在/ 于/ 不同/ 层/ 的/ 元素/ 之间/ ,/ 从而/ 导致/ 计算/ 过程/ 中/ 存在/ 大量/ 细粒度/ 不/ 连续/ 的/ 存储/ 访问/ ./ 根据/ CYK/ 算法/ 的/ 迭代/ 公式/ ,/ 每/ 一层/ 元素/ 在/ 计算/ 时/ 都/ 要/ 根据/ 当前/ 状态/ 的/ 类型/ 选择/ 执行/ 不同/ 的/ 分/ 的/ 计算/ 量/ 最大/ ,/ 它/ 分别/ 依赖于/ 其/ 左/ 、/ 右子/ 状态/ 层/ 的/ 第/ 1/ 行/ 和/ 第/ L/ 列/ ,/ 因此/ 采用/ 常规/ 的/ 等/ 面积/ 的/ 任务/ 划分/ 策略/ 将/ 导致/ 负载/ 不/ 平衡/ ./ 而/ 根据/ 式/ (/ 2/ )/ 和/ (/ 3/ )/ ,/ 可以/ 发现/ 非/ 分支/ 状态/ 层中/ 相邻/ 两列/ 元素/ 的/ 计算/ 量/ 之/ 差为/ 常数/ s/ ,/ 在/ 分支/ 层中/ 相邻/ 两列/ 元素/ 的/ 计算/ 量/ 之/ 差/ 也/ 很小/ ,/ 为/ O/ (/ L/ )/ 量级/ ,/ L/ 为/ RNA/ 序列/ 的/ 长度/ ./ 为此/ 我们/ 采用/ 了/ 按/ 矩阵/ 列/ 顺序/ 进行/ 循环/ 分配/ 的/ 任务/ 划分/ 策略/ ,/ 根据/ 处理单元/ (/ PE/ )/ 的/ 数目/ 将/ 状态/ 层/ 矩阵/ 划分/ 为/ 若干/ 区域/ ,/ 每个/ 区域/ 包含/ p/ 列/ 元素/ (/ p/ 为/ PE/ 的/ 个数/ )/ ,/ 在/ 同一个/ 区域/ 中/ ,/ 每次/ 为/ 每个/ PE/ 分配/ 一列/ ,/ 按照/ 列/ 顺序/ 依次/ 进行/ 计算/ ./ 特征/ 2/ ./ 状态/ 层/ (/ deck/ )/ 之间/ 的/ 数据/ 相关/ 距离/ 是/ 不/ 确定/ 的/ ,/ 它/ 由/ RNA/ 序列/ 家族/ CM/ 模型/ 中/ 父子/ 节点/ 的/ 连接/ 关系/ 决定/ ./ 图/ 2/ 所示/ 的/ RNA/ 家族/ CM/ 模型/ 包含/ 24/ 个/ 节点/ 共/ 81/ 个/ 状态/ [/ 10/ ]/ ./ 图中/ 的/ 弧线/ 代表/ 状态/ (/ 也/ 就是/ 三维/ 矩阵/ 层/ 与/ 层/ )/ 之间/ 的/ 数据/ 依赖/ 关系/ ./ 从图/ 中/ 可以/ 看出/ ,/ 每/ 一个/ 状态/ (/ 层/ )/ 的/ 计算所/ 依赖/ 的/ 数据/ 层/ 的/ 数量/ (/ 最少/ 为/ 0/ ,/ 最大/ 为/ 6/ )/ 和/ 位置/ 都/ 是/ 不/ 确定/ 的/ ,/ 数据/ 相关/ 距离/ 可能/ 为/ 0/ (/ 即/ 依赖于/ 本层/ 的/ 数据/ )/ ,/ 也/ 可能/ 为/ 几十/ 、/ 几百/ 乃至/ 上千/ (/ 图/ 2/ 中/ 第/ 10/ 层/ 的/ 计算/ 便/ 依赖于/ 第/ 46/ 层/ 的/ 元素/ )/ ./ 此外/ ,/ 每/ 一个/ 状态/ 层/ 的/ 存储/ 开销/ 均/ 为/ O/ (/ L2/ )/ ,/ 有限/ 的/ FPGA/ 片内/ 存储空间/ 无法/ 满足/ CYK/ 算法/ 的/ 存储/ 需求/ ./ 针对/ 该/ 问题/ ,/ 我们/ 采用/ 了/ “/ 按/ 区域分割/ ”/ 和/ “/ 逐层/ 按列/ 并行处理/ ”/ 的/ 细粒度/ 处理/ 策略/ ,/ 将/ 整个/ 矩阵/ 划分/ 为/ 多个/ 区域/ ,/ 逐个/ 区域/ 、/ 逐层/ 计算/ ,/ 避免/ 存储/ 整个/ 三角/ 矩阵/ ,/ 将/ 计算/ 过程/ 的/ 存储/ 需求/ 由/ MB/ 量级/ 减少/ 为/ KB/ 量级/ ,/ 从而/ 满足/ FPGA/ 器件/ 存储资源/ 的/ 限制/ ./ 支/ ./ 对于/ 非/ 分支/ (/ 状态/ )/ 层/ 而言/ ,/ 每/ 一个/ 数据/ 在/ 计算/ 时/ 最/ 多/ 依赖/ 6/ 个子/ 状态/ 的/ 数据/ (/ 并且/ 这/ 6/ 个/ 数据/ 位于/ 不同/ 状态/ 层/ )/ ,/ 最少/ 需要/ 1/ 个子/ 状态/ 的/ 数据/ ./ (/ 1/ )/ 若/ 当前/ 状态/ k/ 为/ D/ 或/ S/ :/ 则/ 元素/ M/ (/ i/ ,/ j/ ,/ k/ )/ 的/ 计算/ 依赖于/ 子/ 状态/ 对应/ Deck/ 中/ 处于/ 相同/ 位置/ 的/ 元素/ (/ i/ ,/ j/ )/ ;/ Page6/ (/ 2/ )/ 若/ 当前/ 状态/ k/ 为/ MP/ :/ 则/ 元素/ M/ (/ i/ ,/ j/ ,/ k/ )/ 的/ 计算/ 依赖于/ 子/ 状态/ 对应/ Deck/ 中/ 当前/ 位置/ 左下方/ 的/ 元素/ (/ i/ +/ 1/ ,/ j/ -/ 1/ )/ ;/ (/ 3/ )/ 若/ 当前/ 状态/ k/ 为/ ML/ 或者/ IR/ :/ 则/ 元素/ M/ (/ i/ ,/ j/ ,/ k/ )/ 的/ 计算/ 依赖于/ 子/ 状态/ 对应/ Deck/ 中/ 当前/ 位置/ 下图/ 3/ 非/ 分支/ 状态/ 层/ 数据/ 依赖/ 关系/ 示意图/ 对/ 分支/ (/ BIF/ )/ 状态/ 层/ k/ 而言/ ,/ 每个/ 元素/ 依赖于/ 其/ 左子/ 状态/ 层/ 的/ 第/ i/ 行和右子/ 状态/ 层/ 的/ 第/ j/ 列/ 元素/ ./ 如图/ 4/ 所示/ ,/ 元素/ M/ (/ i/ ,/ j/ ,/ k/ )/ 的/ 值/ 等于/ 其/ 左子/ 状态/ 同行/ 元素/ M/ (/ i/ ,/ / ,/ kleft/ )/ 与/ 右子/ 状态/ 同列/ 元素/ M/ (/ / ,/ j/ ,/ kright/ )/ 之/ 和/ 的/ 最大值/ ./ 根据/ 特征/ 2/ ,/ 不管/ 是/ 何图/ 4/ 分支/ (/ 状态/ )/ 层/ 数据/ 依赖/ 关系/ 示意图/ 特征/ 4/ ./ 分支/ 状态/ 是/ 计算/ 的/ 瓶颈/ ,/ 可以/ 使用/ 数据/ 重用/ 策略/ 减少/ 对/ 访存/ 带宽/ 的/ 需求/ ./ CYK/ 算法/ 时间/ 复杂度/ 表达式/ O/ (/ KL2/ +/ BL3/ )/ 中/ 的/ KL2/ 为/ 非/ 分支/ 状态/ 层/ 的/ 计算/ 开销/ ,/ BL3/ 为/ 分支/ 状态/ 层/ 的/ 计算/ 开销/ ,/ 两者/ 的/ 比例/ 为/ KL2/ // BL3/ =/ K/ // BL/ ,/ 一般来讲/ ,/ K/ ≈/ 3L/ ,/ 并且/ 当/ 序列/ 长度/ L/ 大于/ 1024/ 时/ ,/ B/ / 3/ ,/ 分支/ 状态/ 层/ 的/ 计算/ 开销/ 超过/ 90/ %/ ,/ 并且/ 该/ 比例/ 随着/ 序列/ 长度/ 的/ 增加/ 显著/ 增加/ ,/ 所以/ 分支/ 状态/ 层/ 是/ 计算/ 的/ 性能/ 瓶颈/ ./ 根据/ 算法/ 特征/ 3/ ,/ 分支/ 状态/ 的/ 计算/ 依赖于/ 左右两个/ 子/ 状态/ 上/ 三角/ 矩阵/ 的/ 行/ // 列元方/ 的/ 元素/ (/ i/ +/ 1/ ,/ j/ )/ ;/ (/ 4/ )/ 若/ 当前/ 状态/ k/ 为/ MR/ 或者/ IR/ :/ 则/ 元素/ M/ (/ i/ ,/ j/ ,/ k/ )/ 的/ 计算/ 依赖于/ 子/ 状态/ 对应/ Deck/ 中/ 当前/ 位置/ 左侧/ 的/ 元素/ (/ i/ ,/ j/ -/ 1/ )/ ./ 种/ 类型/ 的/ 状态/ ,/ 其子/ 状态/ 数据/ 层/ 与/ 父/ 状态/ 数据/ 层/ 的/ 距离/ 是/ 不/ 确定/ 的/ ,/ 并且/ 该/ 数据/ 无法/ 存储/ 在/ FPGA/ 片内/ ,/ 所以/ 在/ 计算/ 时/ 将/ 导致/ 大量/ 不/ 连续/ 和/ 跳跃性/ 的/ 片外/ 存储/ 访问/ ./ 素/ ,/ 如果/ 按照/ 波前/ 计算/ (/ wavefront/ )/ 策略/ 沿/ 对角线/ 方向/ 推进/ ,/ 则/ 需要/ 反复/ 从片/ 外/ 载入/ 计算所/ 需/ 的/ 行/ // 列/ 元素/ ./ 为了/ 减少/ 片外/ 存储/ 访问/ 开销/ ,/ 我们/ 采用/ 了/ 以下/ 几种/ 数据/ 重用/ 策略/ ./ (/ 1/ )/ 右子/ 状态/ 列/ 元素/ 重用/ 从图/ 4/ 可以/ 看到/ ,/ 元素/ M/ (/ i/ ,/ j/ ,/ k/ )/ 的/ 计算/ 依赖于/ 其右子/ 状态/ 层/ 第/ j/ 列/ 元素/ (/ (/ c/ )/ 子图/ 用/ 阴影/ 填充/ 的/ 元素/ )/ M/ (/ / ,/ j/ ,/ kright/ )/ )/ ./ 对/ 一个/ PE/ 而言/ ,/ 如果/ 采用/ 按列/ 顺序/ 进行/ 计算/ 的/ 策略/ ,/ 当/ 计算/ 位置/ 从/ M/ (/ i/ ,/ j/ ,/ k/ )/ 移动/ 至/ M/ (/ i/ -/ 1/ ,/ j/ ,/ k/ )/ 时/ ,/ 只/ 需要/ 载入/ 一个/ 新/ 的/ 元素/ ,/ 其余/ Page7/ (/ j/ -/ i/ )/ 个列/ 元素/ 都/ 可以/ 重用/ ,/ 并且/ 子/ 状态/ 层/ 的/ 计算/ 在/ 父/ 状态/ 层/ 计算/ 之前/ 已经/ 完成/ ,/ 如果/ 能/ 将/ 本列/ 元素/ 缓存/ 在/ 片/ 内/ 则/ 可/ 避免/ 片外/ 存储/ 访问/ ./ (/ 2/ )/ 左子/ 状态/ 行/ 元素/ 重用/ 从图/ (/ b/ )/ 可以/ 看到/ ,/ 元素/ M/ (/ i/ ,/ j/ ,/ k/ )/ 的/ 计算/ 依赖于/ 其/ 左子/ 状态/ 层中/ 的/ 同行/ 元素/ M/ (/ i/ ,/ / ,/ kleft/ )/ ./ 如果/ 将/ BIF/ 状态/ 层/ 第/ i/ 行/ 的/ p/ 个/ 元素/ (/ 图/ (/ a/ )/ 中/ 用/ 阴影/ 填充/ 的/ 一行/ 元素/ )/ 分配/ 到/ p/ 个/ 处理单元/ 上/ 同时/ 执行/ ,/ 同时/ 将/ 载入/ 的/ 左子/ 状态/ 层/ 第/ i/ 行/ 元素/ (/ 图/ (/ b/ )/ 中/ 用/ 阴影/ 填充/ 的/ 一行/ 元素/ )/ 广播/ 到/ 所有/ 的/ p/ 个/ 处理单元/ 上/ ,/ 则/ 可/ 实现/ 对/ 载入/ 的/ 左子/ 状态/ 行/ 元素/ 的/ 重用/ ,/ 从而/ 减少/ 片外/ 存储/ 访问/ 开销/ ./ (/ 3/ )/ 非/ 分支/ 状态/ 元素/ 的/ 重用/ 根据/ 图/ 3/ 所示/ 的/ 非/ 分支/ 状态/ 元素/ 的/ 数据/ 依赖/ 关系/ ,/ 如果/ 当前/ 状态/ 为/ MP/ 、/ MR/ 和/ IR/ ,/ 则/ 第/ j/ 列/ 元素/ M/ (/ / ,/ j/ ,/ k/ )/ 的/ 计算/ 依赖于/ 子/ 状态/ 层中/ 相邻/ 的/ 第/ j/ -/ 1/ 列/ ./ 如果/ 每个/ 处理单元/ 每次/ 负责/ 一列/ 元素/ 的/ 计算/ ,/ 并/ 将/ 计算结果/ 存储/ 在/ 局部/ 存储器/ 中/ ,/ 又/ 因为/ 子/ 状态/ 层/ 的/ 计算/ 在/ 父/ 状态/ 层/ 计算/ 之前/ 已经/ 完成/ ,/ 则/ 当前/ 状态/ 层/ 第/ j/ 列/ 元素/ 的/ 计算所/ 需/ 的/ 数据/ 都/ 在/ FPGA/ 片内/ (/ 要么/ 在/ 本地/ 存储器/ 中/ ,/ 要么/ 在/ 相邻/ 的/ 前/ 一个/ 处理/ 单图/ 5CYK/ 算法/ 加速器/ 结构/ PCI/ -/ E/ 接口/ 控制器/ 基于/ XilinxIPCore/ 实现/ ,/ 负责/ 加速器/ 与/ 主机/ 间/ 的/ 数据通信/ ,/ 有效/ 数据传输/ 带宽/ 可达/ 1GB/ // s/ ./ DDRII/ 存储/ 控制器/ 负责/ 实现/ 对片/ 外/ DDRIIDRAM/ 的/ 存储/ 访问/ ./ CYK/ 算法/ 逻辑/ 包括/ PE/ 元/ 的/ 局部/ 存储器/ 中/ )/ ,/ 而/ 不/ 需要/ 访问/ 片/ 外存储器/ ./ 采用/ 上述/ 数据/ 重用/ 策略/ 可以/ 极大/ 地/ 减少/ 计算/ 过程/ 中对片/ 外子/ 状态/ 层/ 数据/ 访问/ 的/ 带宽/ 需求/ ./ 3CYK/ 算法/ 加速器/ 3.1/ 系统结构/ 如图/ 5/ 所示/ ,/ CYK/ 算法/ 加速器/ 系统/ 平台/ 由/ 一台/ 个人/ 计算机/ (/ HostPC/ )/ 和/ 一个/ 可/ 重构/ 算法/ 加速器/ 组成/ ,/ 个人/ 计算机/ 作为/ 系统/ 的/ 主机/ ./ 系统/ 主机/ 负责/ 与/ 用户/ 的/ 交互/ ,/ 将/ 用户/ 输入/ 的/ RNA/ 序列/ 和/ CM/ 加载/ 至/ 算法/ 加速器/ ,/ 并/ 启动/ 加速器/ ;/ 算法/ 加速器/ 完成/ 无/ 回溯/ 的/ CYK/ // inside/ 算法/ 的/ 全部/ 计算/ 过程/ ,/ 然后/ 将/ 比/ 对/ 得分/ 报告/ 给/ 主机/ ./ 加速器/ 以/ 高性能/ 商用/ FPGA/ 芯片/ (/ XC5VLX330/ )/ 为/ 基础/ ,/ 配置/ 两个/ 4GBDDRII/ 大容量/ 商用/ 存储器/ ,/ 通过/ 高带宽/ 的/ PCI/ -/ E/ ×/ 8/ 数据通道/ 与/ 主机/ 相连/ ,/ 实现/ 通用/ 处理器/ 与/ 算法/ 加速器/ 的/ 协同工作/ ./ 可编程/ 的/ FPGA/ 芯片/ 是/ 算法/ 加速器/ 的/ 核心/ ,/ 内部/ 由/ PCI/ -/ E/ 接口/ 控制器/ 、/ DDRII/ 存储/ 控制器/ 和/ CYK/ 算法/ 逻辑/ 三/ 部分/ 构成/ ./ 阵列/ 控制器/ 、/ PE/ 阵列/ 、/ 列/ 同步/ 和/ 写/ 回/ 控制器/ 模块/ 等/ 部分/ ./ 其中/ PE/ 阵列/ 控制/ 模块/ 负责/ 控制/ PE/ 阵列/ 的/ 初始化/ 、/ 实现/ 动态/ 任务/ 划分/ (/ 对/ 三维/ 矩阵/ 实施/ 按列/ 循环/ 分配/ ,/ 并/ 将/ 其/ 加载/ 至/ PE/ 阵列/ )/ ./ PE/ 阵列/ 负责/ 三维/ 动/ Page8/ 态/ 规划/ 矩阵/ 的/ 并行计算/ ,/ 它/ 由/ 一系列/ PE/ 模块/ 串联/ 构成/ ,/ 其中/ 第一个/ 模块/ 是/ 主/ 处理单元/ (/ MasterPE/ )/ ,/ 其余/ 模块/ 为/ 从/ 处理单元/ (/ SlavePE/ )/ ./ 每/ 一个/ PE/ 模块/ 都/ 包括/ 一个/ 局部/ 存储器/ (/ LocMem/ ,/ 采用/ FPGA/ 片内/ 分布式/ 的/ 存储资源/ 实现/ ,/ 用于/ 存储/ 编码/ 后/ 的/ RNA/ 序列/ )/ 和/ 一片/ 计算结果/ 缓存/ 区/ ,/ 缓存/ 区/ 包含/ 16/ 个/ 存储/ 区域/ ,/ 采用/ FPGA/ 片内/ BlockRAM/ 实现/ ,/ 最/ 多/ 可以/ 缓存/ 16/ 个子/ 状态/ 层/ 对应/ 位置/ 的/ 一列/ 元素/ ./ PE/ 间/ 的/ 数据/ 传递/ 寄存器/ 组/ 用于/ 实现/ 非/ 分支/ 状态/ 的/ 数据/ 在/ PE/ 阵列/ 中/ 的/ 重用/ (/ 根据/ 图/ 3/ (/ b/ )/ 所示/ ,/ MP/ 、/ R/ 状态/ 层/ 第/ j/ 列/ 元素/ 的/ 计算/ 依赖于/ 子/ 状态/ 层/ 左侧/ j/ -/ 1/ 列/ 的/ 元素/ )/ ./ 由于/ 每/ 一列/ 元素/ 的/ 计算/ 量/ 并/ 不/ 完全/ 相等/ ,/ 列/ 同步/ 和/ 写/ 回/ 控制器/ 模块/ 负责/ 控制/ PE/ 阵列/ 的/ 计算/ 同步/ 和/ 将/ 部分/ 状态/ 层/ 数据/ 写回/ DRAM/ (/ 如果/ 当前/ 状态/ 层为/ 左/ S/ ,/ 需要/ 将/ 数据/ 从/ PE/ 的/ 局部/ 存储器/ (/ Loc/ -/ Mem/ )/ 中写/ 回至/ DRAM/ )/ ./ 3.2/ 无/ 回溯/ 的/ 细粒度/ 并行/ CYK/ // inside/ 算法/ 标准/ CYK/ 算法/ 采用/ 如图/ 1/ 所示/ 的/ 逐层/ 依次/ 计图/ 6/ 细粒度/ 并行/ CYK/ // inside/ 算法/ 的/ 任务/ 划分/ 与/ 计算/ 顺序/ 算/ 的/ 策略/ ,/ 层内/ 采用/ 沿/ 对角线/ 按照/ 波前/ (/ wavefront/ )/ 顺序/ 进行/ 计算/ ./ 根据/ CYK/ 算法/ 特征/ 2/ ,/ 对/ 当前/ 状态/ 层/ 的/ 计算/ 而言/ ,/ 它/ 所/ 依赖/ 的/ 数据/ 层/ 的/ 数量/ 和/ 位置/ 都/ 是/ 不/ 确定/ 的/ ,/ FPGA/ 芯片/ 的/ 内部/ 存储容量/ 不能/ 满足/ O/ (/ L2/ )/ 的/ 存储/ 需求/ ;/ 而/ 根据/ CYK/ 算法/ 特征/ 1/ ,/ 采用/ 常规/ 的/ 等/ 面积/ 任务/ 划分/ 策略/ 将/ 导致/ 负载/ 不/ 平衡/ ,/ 所以/ 我们/ 采用/ 了/ 图/ 6/ (/ a/ )/ 所示/ 的/ 采用/ “/ 按/ 区域分割/ ”/ 和/ “/ 逐层/ 并行处理/ ”/ 的/ 计算/ 策略/ ./ 首先/ 将/ 整个/ 三维/ 矩阵/ 沿/ 维度/ k/ 按列/ 垂直/ 切/ 分为/ 若干/ 区域/ (/ section/ )/ ,/ 每/ 一个/ 区域/ 仍/ 是/ 一个三维/ 矩阵/ ,/ 它/ 包含/ 了/ 每/ 一个/ 状态/ 层/ 的/ n/ 列/ 元素/ ,/ n/ 为/ PE/ 阵列/ 的/ 规模/ ;/ 然后/ 从/ k/ =/ K/ 开始/ ,/ 依次/ 计算/ 每个/ 区域/ 内/ 的/ 所有/ 状态/ 层/ ,/ 直到/ k/ =/ 1/ ./ 区域/ 内/ 每/ 一个/ 状态/ 层内/ 的/ 计算/ 采用/ 细粒度/ 并行/ 的/ 方式/ ,/ 每个/ PE/ 每次/ 负责/ 计算/ 当前/ 状态/ 层中/ 的/ 一列/ 元素/ ,/ 当本/ 区域/ 当前/ 状态/ 层中/ 的/ 所有/ 元素/ 计算/ 完毕/ 后/ ,/ 再/ 将/ 下/ 一/ 状态/ 层/ 分配/ 给/ PE/ 阵列/ ./ 如图/ 6/ (/ a/ )/ 所示/ ,/ 我们/ 以/ 包含/ 4/ 个/ PE/ 的/ 处理/ 阵列/ 为例/ 说明/ 处理过程/ ./ 图中/ 的/ 三维/ 动态/ 规划/ 矩阵/ 犕/ 被/ 划分/ 为/ 3/ 个/ 区域/ Page9/ (/ Section1/ ,/ Section2/ ,/ Section3/ )/ ,/ 每个/ 区域/ 包含/ K/ 层/ ,/ 每层/ 包含/ 4/ 列/ 元素/ ./ 图中/ 标示/ 的/ 数字/ 和/ 虚线/ 箭头/ 代表/ 计算/ 顺序/ ./ 首先/ 将/ Section1/ 中/ 的/ k/ =/ K/ 层/ 加载/ 至/ PE/ 阵列/ ,/ 然后/ 计算/ 第/ K/ -/ 1/ 层/ ,/ 当本/ 区域/ 最上层/ (/ k/ =/ 1/ )/ 算/ 完后/ 再/ 将/ Section2/ 的/ 第/ K/ 层/ 加载/ 至/ PE/ 阵列/ ,/ 直到/ 最后/ 一个/ 区域/ Section3/ 的/ 最上层/ (/ k/ =/ 1/ )/ 中/ 的/ 所有/ 元素/ 算/ 完/ ./ 对/ 每/ 一个/ 状态/ 层/ 的/ 计算/ 而言/ ,/ 首先/ 需要/ 根据/ 当前/ 状态/ 的/ 类型/ 选择/ 执行/ 哪个/ 不同/ 的/ 分支/ ./ 如图/ 6/ (/ b/ )/ 、/ (/ c/ )/ 所示/ ,/ 图中/ 填充/ 阴影/ 的/ 4/ 列/ 元素/ 表示/ 当前/ 状态/ 层/ 的/ 计算/ 区域/ ,/ 它们/ 被/ 同时/ 分配/ 至/ PE1/ ~/ PE4/ 上/ 并行计算/ ./ 图中/ 标示/ 五角星/ 的/ 单元/ 表示/ PE/ 阵列/ 当前/ 计算/ 的/ 元素/ 所处/ 的/ 位置/ ./ 如果/ 是非/ 分支/ 状态/ 层/ ,/ 则/ 每/ 一个/ PE/ 的/ 计算/ 都/ 按照/ 图/ 6/ (/ c/ )/ 子图/ 所示/ 从/ 当/ 前列/ 算法/ 1/ ./ Fine/ -/ grainedParallelCYK/ // insideAlgorithmwithoutTraceback/ ./ Input/ :/ R/ :/ anRNAsequenceR/ =/ r1r2/ …/ rLoflengthL/ ;/ Output/ :/ M/ [/ 1/ ,/ L/ ,/ 1/ ]/ :/ optimalglobalalignmentscore/ ;/ Variables/ :/ i/ ,/ j/ ,/ k/ :/ elementlocationindexinthethree/ -/ dimensionalDP/ -/ matrix/ ;/ S/ (/ k/ )/ :/ thetypeofcurrentstatek/ ;/ C/ (/ k/ )/ :/ thestatesthatkcantransitto/ ;/ P/ (/ k/ )/ :/ thesetofparentsofstatek/ ;/ BEGIN/ :/ ParallelCYK/ // insideDatainput/ :/ S2/ :/ if/ (/ p/ =/ 1/ )/ // // it/ ’/ stheMasterPELoadM/ [/ / ,/ jp/ ,/ kright/ ]/ oftherightchilddeckfromownlocalon/ -/ chipmemory/ )/ ;/ forall/ γ/ ∈/ C/ (/ k/ )/ do/ {/ LoadM/ [/ / ,/ jp/ -/ 1/ ,/ γ/ ]/ fromexternalDRAM/ }/ ;/ LoadM/ [/ / ,/ jp/ ,/ kright/ ]/ oftherightchilddeckfromownlocalon/ -/ chipmemory/ )/ ;/ Calculation/ :/ S4/ :/ if/ (/ S/ (/ k/ )/ =/ BIF/ )/ thenSynchronization/ :/ S5/ :/ PE/ _/ pwaitinguntilthelastPE/ _/ nprocessingfinished/ ;/ Dataoutput/ :/ S6/ :/ if/ (/ S/ (/ k/ )/ isaleftsubstateofBIF/ )/ ,/ thensendM/ (/ / ,/ jp/ ,/ k/ )/ toexternalDRAM/ ;/ Sectionadvance/ :/ 图/ 7/ 无/ 回溯/ 的/ 细粒度/ 并行/ CYK/ // inside/ 算法/ 的/ 底部/ 位置/ 开始/ (/ 即/ 三角形/ 的/ 斜边/ )/ ,/ 按照/ 由下/ 至上/ 的/ 顺序/ 执行/ ./ 根据/ 式/ (/ 1/ )/ ,/ 处于/ 同一/ 对角线/ 位置/ 的/ 元素/ 计算/ 量/ 相等/ ,/ 所以/ 在/ 任意/ 时刻/ ,/ PE/ 阵列/ 当前/ 计算/ 的/ 元素/ 总是/ 处于/ 三角/ 矩阵/ 的/ 同/ 一条/ 对角线/ 上/ ./ 如果/ 是/ 分支/ 状态/ 层/ ,/ 则/ 每/ 一个/ PE/ 的/ 计算/ 都/ 按照/ 图/ 6/ (/ b/ )/ 所示/ ,/ 从/ 当/ 前列/ 的/ 顶部/ 位置/ 开始/ ,/ 按照/ 由上至下/ 的/ 顺序/ 执行/ ./ 根据/ 算法/ 特征/ 3/ ,/ 每个/ PE/ 负责/ 计算/ 区域/ 中/ 的/ 一列/ 元素/ ,/ 当/ 计算/ 位置/ 由上至下/ 移动/ 时/ ,/ 其右子/ 状态/ 的/ 列/ 元素/ 可以/ 重用/ ./ 对/ 整个/ PE/ 阵列/ 而言/ ,/ 由于/ 都/ 要/ 使用/ 左子/ 状态/ 的/ 同一/ 行/ 元素/ ,/ 所以/ 可/ 将/ 从/ DRAM/ 中/ 载入/ 的/ 第/ i/ 行/ 元素/ 广播/ 至/ 所有/ 处理单元/ 实现/ 行/ 元素/ 的/ 重用/ ./ 图/ 7/ 采用/ 单/ 程序/ 多/ 数据模型/ (/ SPMD/ ,/ SingleProgramMultipleData/ )/ 描述/ 了/ 细粒度/ 并行/ CYK/ // Page10inside/ 算法/ 执行/ 过程/ ./ 算法/ 的/ 输入/ 为/ 一条/ 长度/ 为/ L/ 的/ RNA/ 序列/ x/ =/ x1/ …/ xL/ 和/ 一个/ 包含/ K/ 个/ 状态/ 的/ CM/ 模型/ ./ 算法/ 的/ 核心/ 是/ 两重/ For/ 循环/ 语句/ ,/ 循环体/ 内部/ 按照/ 图/ 6/ (/ a/ )/ 所示/ 的/ 任务/ 划分/ 策略/ 将/ 当前/ 状态/ 层中/ 一块/ 包含/ n/ 列/ 元素/ 的/ 区域/ 加载/ 至/ PE/ 阵列/ 进行/ 处理/ ./ 在/ 初始化/ 阶段/ ,/ 每/ 一个/ PE/ 单元/ 在/ 本地/ 存储器/ 中/ 选择/ 一个/ 空闲/ 的/ 存储/ 区域/ 存放/ 将要/ 计算/ 出/ 的/ 列/ 元素/ (/ 语句/ S1/ )/ ,/ 然后/ 根据/ 当前/ 状态/ 类型/ 选择/ 执行/ 不同/ 的/ 分支/ ./ 处理过程/ 包括/ 数据/ 载入/ (/ datainput/ )/ 、/ 列/ 元素/ 计算/ (/ calculation/ )/ 、/ 列/ 同步/ (/ synchronization/ )/ 、/ 数据/ 输出/ (/ dataoutput/ )/ 和/ 新/ 区域/ 分配/ (/ sectionadvance/ )/ 5/ 个/ 步骤/ ./ 在/ 数据/ 载入/ 阶段/ ,/ 不同/ 类型/ 的/ PE/ 单元/ 根据/ 当前/ 的/ 状态/ 采用/ 不同/ 的/ 数据/ 载入/ 方式/ (/ S2/ )/ :/ 只有/ 主/ 处理单元/ (/ MasterPE/ ,/ p/ =/ 1/ )/ 具备/ 外部/ 存储器/ 访问/ 权限/ ,/ 如果/ 当前/ 状态/ 为/ BIF/ ,/ 则/ MasterPE/ 从/ 本地/ 局部/ 存储器/ 中/ 读取/ 右子/ 状态/ 的/ 列/ 元素/ ,/ 从/ DRAM/ 中/ 读取/ 左子/ 状态/ 的/ 行/ 元素/ 并/ 将/ 其/ 发送至/ 所有/ PE/ 单元/ (/ S21/ )/ ;/ 如果/ 当前/ 状态/ 为/ MR/ 、/ IR/ 或者/ MP/ ,/ 则/ MasterPE/ 计算所/ 需/ 的/ 数据/ 都/ 在/ 片/ 外存储器/ 中/ ,/ 需要/ 从片/ 外存储器/ 载入/ 计算所/ 需/ 的/ 所有/ 子/ 状态/ 的/ 第/ j/ -/ 1/ 列/ 元素/ (/ S22/ )/ ;/ 如果/ 当前/ 状态/ 为/ 其它/ 非/ 分支/ 状态/ ,/ 则/ PE/ 单元/ 计算所/ 需/ 的/ 数据/ 都/ 在/ 本地/ 存储器/ 中/ ,/ 只/ 需/ 从/ 局部/ 存储器/ 中/ 载入/ 所/ 需/ 的/ 子/ 状态/ 第/ j/ 列/ 元素/ 即可/ (/ S23/ )/ ./ 与/ 主/ 处理单元/ 的/ 区别/ 在于/ ,/ 从/ 处理单元/ (/ SlavePE/ )/ 不/ 发出/ 数据/ 载入/ 请求/ ,/ 它/ 根据/ 当前/ 的/ 状态/ 类型/ ,/ 选择/ 从/ 本地/ 局部/ 存储器/ 中/ 读取数据/ 、/ 从前/ 一个/ PE/ 局部/ 存储器/ 中/ 读取数据/ 或者/ 等待/ 接收/ 主/ 处理单元/ 读回/ 的/ 数据/ (/ S3/ )/ ./ PE/ 单元/ 的/ 计算/ 过程/ 采用/ 数据/ 驱动/ 的/ 流水线/ 模型/ ,/ 一旦/ 计算所/ 需/ 的/ 有效/ 数据/ 到达/ 便/ 启动/ 该/ 分支/ 对应/ 的/ 计算/ 流水线/ ./ 尽管/ 所有/ PE/ 都/ 使用/ 标准/ CYK/ 算法/ 的/ 迭代/ 公式/ ,/ 但是/ 需要/ 根据/ 不同/ 的/ 状态/ 类型/ 采用/ 不同/ 的/ 计算/ 顺序/ :/ 如果/ 是非/ 分支/ 状态/ 层/ ,/ 则/ 按照/ 由下/ 至上/ 顺序/ 计算/ ;/ 如果/ 是/ 分支/ 状态/ 层/ ,/ 则/ 按照/ 由上至下/ 的/ 顺序/ 执行/ 计算/ (/ S4/ )/ ./ 所有/ PE/ 的/ 计算结果/ 都/ 缓存/ 在/ 各自/ 的/ 局部/ 存储器/ 中/ ./ 由于/ 每/ 一列/ 元素/ 的/ 计算/ 量/ 不/ 等/ ,/ 所以/ 当前/ PE/ 完成/ 本列/ 元素/ 的/ 计算/ 后要/ 进入/ 列/ 同步/ 等待/ 状态/ (/ PE/ 在/ 同步/ 等待/ 的/ 同时/ 执行/ 写回/ 操作/ )/ ,/ 以便/ 保持数据/ 依赖/ 关系/ 的/ 一致性/ (/ S5/ )/ ./ 如果/ 当前/ 状态/ 是/ 分支/ 状态/ 的/ 左子/ 状态/ ,/ 则/ 所有/ PE/ 都/ 需要/ 将/ 当前/ 的/ 计算结果/ 写/ 回片/ 外存储器/ (/ 因为/ 分支/ 的/ 左子/ 状态/ 数据/ 在/ 未来/ 很长/ 一段时间/ 内/ 都/ 不会/ 使用/ )/ ./ PE/ 阵列/ 采用/ 依次/ 写/ 回/ 的/ 策略/ ,/ 先算/ 完先/ 写/ 回/ ,/ 尽量/ 将/ 写/ 回/ 开销/ 隐藏/ 在/ 计算/ 开销/ 中/ ./ 如果/ 当前/ 状态/ 是/ MR/ 、/ IR/ 或者/ MP/ 状态/ ,/ 则/ 只有/ 最后/ 一个/ 从/ 处理单元/ 需要/ 将/ 当前/ 的/ 计算结果/ 写/ 回片/ 外存储器/ (/ 该/ PE/ 的/ 计算结果/ 位于/ 当前/ 计算/ 区域/ 的/ 最/ 右侧/ ,/ 下/ 一个/ 区域/ 计算/ 时/ 将/ 会/ 被/ 用到/ )/ ./ 除此以外/ ,/ 所有/ PE/ 的/ 计算结果/ 都/ 保存/ 在/ 局部/ 存储器/ 中/ ,/ 以便/ 在/ 后续/ 的/ 计算/ 中/ 使用/ 或者/ 通过/ 数据/ 传递/ 寄存器/ 供/ 相邻/ 的/ 下/ 一个/ PE/ 使用/ (/ S6/ )/ ./ 当/ 数据/ 写回/ 操作/ 完成/ 后/ ,/ 执行/ 局部/ 存储器/ 数据/ 替换/ 操作/ :/ 如果/ 某一/ 状态/ 的/ 所有/ 父/ 状态/ 都/ 已算/ 完/ ,/ 则/ 释放/ 该/ 状态/ 占用/ 的/ 数据/ 缓冲区/ (/ S7/ )/ ./ 当/ 最后/ 一个/ PE/ (/ PE/ [/ n/ ]/ )/ 计算/ 完成/ 并/ 将/ 结果/ 写/ 回后/ (/ 说明/ 此时/ 本/ 区域/ 的/ 计算/ 任务/ 已/ 完成/ )/ ,/ PE/ 控制/ 模块/ 将/ 本/ 区域/ 的/ 下/ 一个/ 状态/ 层/ 加载/ 至/ PE/ 阵列/ (/ S8/ )/ ,/ 然后/ 所有/ PE/ 同时/ 开始/ 执行/ 新/ 区域/ 的/ 计算/ ./ 所有/ PE/ 单元/ 重复/ 上述/ 计算/ 过程/ 直到/ 新/ 指派/ 的/ 元素/ 列号/ 超出/ 输入/ 的/ RNA/ 序列/ 的/ 长度/ (/ 此时/ 当前/ PE/ 处于/ 空闲/ 状态/ ,/ 直到/ 阵列/ 中/ 所有/ 的/ PE/ 计算/ 完成/ )/ ./ 当/ 三维/ 矩阵/ 最后/ 一个/ 状态/ 层/ 的/ 计算/ 完成/ 后/ ,/ PE/ 阵列/ 将/ 最终/ 的/ 计算结果/ M/ (/ 1/ ,/ L/ ,/ 1/ )/ 写/ 回片/ 外存储器/ ,/ 计算/ 过程/ 终止/ ./ 3.3/ PE/ 模块/ 的/ 设计/ PE/ 模块/ 的/ 功能/ 是/ 按照/ CYK/ // inside/ 递归/ 公式/ 实现/ 对/ 三维/ 动态/ 规划/ 矩阵/ 元素/ 的/ 计算/ ./ 主要/ 由/ PE/ 控制/ 模块/ (/ PEControlModule/ )/ 、/ 分值/ 计算/ 模块/ (/ ComputationModule/ )/ 、/ RNA/ 序列/ 存储器/ (/ SeqMem/ )/ 、/ CM/ 模型/ 存储器/ (/ CMmodelinfobuf/ )/ 和/ 计算结果/ 局部/ 缓存/ 区/ (/ Deckbufs/ )/ 5/ 部分/ 构成/ ./ 如图/ 8/ 所示/ ,/ PE/ 控制/ 模块/ 主要/ 包含/ 一个/ 控制/ 状态机/ 和/ 数据/ IO/ 通路/ ./ 控制/ 状态机/ 负责/ 实现/ PE/ 模块/ 的/ 初始化/ ,/ 从片/ 外/ DDRII/ 存储器/ 中/ 载入/ RNA/ 序列/ 和/ CM/ 模型/ 的/ 当前/ 状态/ 信息/ ;/ 启动/ PE/ 模块/ 的/ 计算/ ,/ 控制数据/ 载入/ 、/ 分值/ 计算/ 、/ 阵列/ 同步/ 以及/ 数据/ 写/ 回/ 和/ 替换/ ./ 分值/ 计算/ 模块/ (/ 图/ 8/ 中部/ 的/ 虚/ 线框/ 部分/ )/ 由/ END/ 、/ DSPLR/ 和/ BIF3/ 个子/ 模块/ 构成/ ,/ 用于/ 实现/ 对应状态/ 分支/ 的/ 计算/ ./ 3/ 个子/ 模块/ 的/ 内部结构/ 大致相同/ ,/ 都/ 由/ 一个/ 32/ 位/ 加法器/ 和/ 一个/ 32/ 位/ 比较/ 器/ 构成/ ,/ 主要/ 区别/ 在于/ 子/ 模块/ 数据/ 输入/ 来源/ 不同/ ./ END/ 状态/ 不/ 需要/ 从/ 外部/ 载入/ 数据/ ,/ 该/ 状态/ 在/ 整个/ 计算/ 过程/ 中/ 被/ 作为/ 特例/ 处理/ ;/ D/ 、/ S/ 和/ L/ 状态/ 的/ 计算/ 只/ 需要/ 从本/ PE/ 的/ 局部/ 数据/ 缓存/ 区/ 载入/ 数据/ ,/ 而/ 在/ P/ 、/ R/ 状态/ 下/ ,/ 主/ 处理单元/ 需要/ 从/ 外部/ DDRII/ 存储器/ 载入/ 之前/ 的/ Page11/ 图/ 8PE/ 模块/ 结构/ 中间/ 结果/ ,/ 从/ 处理单元/ 则/ 从/ 相邻/ 的/ 前/ 一个/ PE/ 载入/ 数据/ ;/ 在/ 分支/ 状态/ 下/ ,/ BIF/ 计算/ 模块/ 需要/ 从/ 外部/ DDRII/ 存储器/ 载入/ 左子/ 状态/ 层/ (/ layerkleft/ )/ 和/ 从/ 自身/ 局部/ 缓存/ 区中/ 载入/ 右子/ 状态/ 层/ (/ layerkright/ )/ 的/ 数据/ ./ 所有/ 子/ 模块/ 的/ 计算结果/ 都/ 先/ 存入/ 局部/ 缓存/ 区中/ ,/ 当本列/ 元素/ 计算/ 完成/ 后/ 再/ 根据/ 当前/ 状态/ 的/ 类型/ 判断/ 是否/ 需要/ 写回/ DRAM/ ./ RNA/ 序列/ 存储器/ (/ SeqMem/ )/ 用于/ 存储/ 当前/ 的/ RNA/ 序列/ ./ 系统/ 初始化/ 时/ ,/ 由/ PE/ 控制/ 模块/ 将/ RNA/ 序列/ 从/ DRAM/ 中/ 取出/ ,/ 存入/ 序列/ 存储器/ ./ 相对/ 于/ FPGA/ 的/ 存储容量/ 而言/ ,/ CM/ 模型/ 的/ 存储/ 需求/ 过大/ ,/ 不能/ 将/ 其/ 完整/ 地/ 存储/ 在/ 片/ 内/ ,/ 因此/ 在/ 计算/ 过程/ 中仅/ 将/ 当前/ 状态/ 层/ 计算所/ 需/ 的/ 信息/ 从/ DRAM/ 中/ 读出/ 缓存/ 在/ FPGA/ 片内/ ./ 为了/ 实现/ 对/ 概率/ 矩阵/ 元素/ 的/ 并行/ 查询/ ,/ 我们/ 为/ 每个/ PE/ 都/ 设置/ 了/ 一个/ CM/ 模型/ 存储器/ ,/ 采用/ FPGA/ 片内/ 分布式/ 存储资源/ 实现/ ./ 计算结果/ 存储器/ (/ Deckbufs/ )/ 由/ 16/ 个/ 相对/ 独立/ 的/ 存储/ 区域/ (/ Deckbuf/ )/ 组成/ ,/ 每/ 一个/ 存储/ 区/ 可以/ 存储/ 三角/ 矩阵/ 的/ 一列/ ,/ 使用/ FPGA/ 片内/ 存储/ 块/ 实现/ (/ BlockRAM/ )/ ,/ 用于/ 存储/ 本/ PE/ 的/ 计算结果/ ./ 局部/ 缓存/ 区/ 采用/ 双/ 端口/ 设计/ ,/ 可以/ 直接/ 被/ 本/ PE/ 和/ 相邻/ 的/ 下/ 一个/ PE/ 访问/ ./ 假设/ 当前/ PE/ 的/ 编号/ 为/ p/ ,/ 则/ Deckbufs/ 中/ 存储/ 的/ 是/ 当前/ section/ 的/ 第/ p/ 列/ 元素/ ,/ 但/ 这/ 16/ 列/ 元素/ 都/ 位于/ 不同/ 的/ 状态/ 层/ ./ 每个/ 存储/ 区域/ 都/ 设置/ 了/ 两个/ 寄存器/ ,/ 其中/ 位置/ 寄存器/ (/ deck/ _/ id/ )/ 用于/ 记录/ 所/ 存储/ 的/ 数据/ 所处/ 的/ 状态/ 层/ 编号/ ,/ 父/ 状态/ 寄存器/ (/ p/ _/ cnt/ )/ 记录/ 还/ 未/ 计算/ 出/ 的/ 本/ 状态/ 层/ 对应/ 的/ 父/ 状态/ 数量/ (/ 即本/ 状态/ 层/ 元素/ 还要/ 用到/ 的/ 次数/ )/ ./ 当/ p/ _/ cnt/ =/ 0/ 时/ ,/ 则/ 释放/ 该/ 存储/ 区/ ,/ 并/ 将/ 其/ 加入/ 可用/ 存储/ 区/ 集合/ ./ 结果/ 缓存/ 区/ 的/ 设置/ 与/ CM/ 模型/ 中/ BIF/ 状态/ 的/ 个数/ 和/ RNA/ 家族/ 解析/ 树结构/ 相关/ ,/ 16/ 个/ 缓存/ 区/ 已/ 能够/ 满足/ 当前/ 设计/ 的/ 需求/ ./ 4/ 实验/ 与/ 性能/ 分析/ 4.1/ 并行/ 效率/ 分析/ 硬件/ CYK/ // inside/ 算法/ 加速器/ 的/ 执行/ 总/ 时间/ (/ T/ )/ 等于/ 矩阵/ 单元/ 的/ 计算/ 时间/ (/ Tc/ )/ 、/ 同步/ 等待/ 和/ 写/ 回/ 开销/ (/ Tm/ )/ 、/ 数据/ 载入/ (/ TLB/ )/ 以及/ 列/ 转换/ (/ sectionadvance/ )/ 开销/ 之/ 和/ ,/ 其中/ 列/ 转换/ 开销/ 只有/ 在/ 当前/ 区域/ 所有/ 元素/ 计算/ 完成/ 后/ 才/ 会/ 产生/ ,/ 并且/ 每次/ 列/ 转换/ 只/ 需要/ 改变/ PE/ 的/ 列/ 下标/ ,/ 时间/ 开销/ 为/ O/ (/ 1/ )/ ,/ 可以/ 忽略/ ,/ 而/ 数据/ 载入/ (/ TL/ )/ 开销/ 只有/ 在/ 分支/ 状态/ 下/ 才/ 会/ 产生/ ./ 假设/ p/ 是/ 处理/ 阵列/ 的/ 规模/ ,/ L/ 是/ RNA/ 序列/ 的/ 长度/ ,/ B/ 为/ 分支/ 状态/ 数量/ ,/ K/ 为/ 整个/ CM/ 模型/ 状态/ 数量/ ,/ 参数/ s/ =/ [/ L/ // p/ ]/ ./ 由于/ 计算/ 过程/ 中/ 的/ 并行处理/ 方式/ 不同/ ,/ 我们/ 将/ 分支/ 状态/ 和/ 非/ 分支/ 状态/ 分开/ 考虑/ ./ 在/ 非/ 分支/ 状态/ 下/ ,/ 三角/ 矩阵/ 的/ 计算/ 开销/ (/ TC1/ )/ 为/ TC1/ =/ (/ p/ +/ 2p/ +/ …/ +/ sp/ )/ ·/ Δ/ t1/ ,/ 写回/ 开销/ (/ TM1/ )/ 为/ TM1/ =/ 110/ (/ 为/ 平均/ 一个/ 单元/ 的/ 计算/ 开销/ )/ ,/ Δ/ t2/ =/ 1/ (/ 平均/ 一个/ Page12/ 单元/ 的/ 写/ 回/ 开销/ )/ ./ 因此/ ,/ 所有/ 非/ 分支/ 状态/ 层/ 的/ 时间/ 开销/ (/ TNB/ )/ 为/ TNB/ =/ (/ TC1/ +/ TM1/ )/ ·/ (/ K/ -/ B/ )/ ./ 在/ 分支/ 状态/ 下/ ,/ 三角/ 矩阵/ 的/ 计算/ 开销/ (/ TC2/ )/ 为/ TC2/ =/ [/ 12p/ ]/ 2/ ·/ Δ/ t3/ ,/ 写回/ 开销/ (/ TM2/ )/ 为/ TM2/ =/ L/ ·/ (/ L/ +/ 1/ )/ Δ/ t4/ ,/ 数据/ 载入/ 开销/ (/ TLB/ )/ 在/ PE/ 阵列/ 启动/ 当前/ 对角线/ 元素/ 的/ 计算/ 时/ 产生/ ,/ 从/ masterPE/ 发出/ 片/ 外存储器/ 访问/ 地址/ ,/ 到/ 第一个/ 元素/ 进入/ PE/ 阵列/ ,/ 每个/ 区域/ 需要/ 发出/ (/ s/ -/ 1/ )/ ·/ p/ 次/ 访存/ 请求/ (/ s/ 为/ 当前/ 计算/ 的/ 区域/ 编号/ )/ ,/ 平均/ 每次/ 访存/ 需要/ 16/ 个/ 时钟/ 周期/ ,/ 所以/ TLB/ =/ (/ p/ +/ 2p/ +/ …/ +/ sp/ )/ ·/ 16/ ./ 这里/ ,/ Δ/ t3/ =/ 2/ (/ 执行/ 一次/ 加法/ 和/ 一次/ 比较/ 操作/ )/ ,/ Δ/ t4/ =/ 16/ (/ 元素/ 按/ 矩阵/ 列/ 顺序/ 写回/ )/ ./ 因此/ ,/ 所有/ 分支/ 状态/ 层/ 的/ 时间/ 开销/ (/ TB/ )/ 为/ TB/ =/ (/ TC2/ +/ TM2/ +/ TLB/ )/ ·/ B/ ./ 我们/ 可以/ 得出/ 总/ 的/ 计算/ 开销/ (/ TC/ )/ 为/ 硬件/ CYK/ // inside/ 算法/ 总/ 执行/ 时间/ (/ 包括/ 计算/ 和/ 写/ 回/ ,/ 按/ 时钟/ 周期/ 数/ 计算/ )/ 为/ TNB/ 和/ TB/ 之/ 和/ :/ T/ =/ (/ TC1/ +/ TM1/ )/ ·/ (/ K/ -/ B/ )/ +/ (/ TC2/ +/ TM2/ +/ TLB/ )/ ·/ B/ 根据/ 式/ (/ 4/ )/ 和/ (/ 5/ )/ ,/ CYK/ // inside/ 算法/ 加速器/ 的/ 并行执行/ 效率/ (/ EC/ )/ 为/ PE/ 数量/ 表/ 1CYK/ 算法/ 加速器/ 并行/ 效率/ RNA/ 序列/ SRPRNAB/ =/ 4/ ,/ L/ =/ 301/ ,/ K/ -/ B/ =/ 923p/ =/ 4s/ =/ 18/ ,/ Ec/ =/ 91/ %/ s/ =/ 29/ ,/ Ec/ =/ 94/ %/ s/ =/ 76/ ,/ Ec/ =/ 93/ %/ s/ =/ 95/ ,/ Ec/ =/ 93/ %/ s/ =/ 387/ ,/ Ec/ =/ 95/ %/ 93p/ =/ 8s/ =/ 9/ ,/ Ec/ =/ 87/ %/ s/ =/ 15/ ,/ Ec/ =/ 92/ %/ s/ =/ 38/ ,/ Ec/ =/ 91/ %/ s/ =/ 48/ ,/ Ec/ =/ 90/ %/ s/ =/ 194/ ,/ Ec/ =/ 93/ %/ 91p/ =/ 16s/ =/ 5/ ,/ Ec/ =/ 83/ %/ s/ =/ 8/ ,/ Ec/ =/ 90/ %/ s/ =/ 19/ ,/ Ec/ =/ 88/ %/ s/ =/ 24/ ,/ Ec/ =/ 86/ %/ s/ =/ 97/ ,/ Ec/ =/ 89/ %/ 87p/ =/ 20s/ =/ 4/ ,/ Ec/ =/ 81/ %/ s/ =/ 6/ ,/ Ec/ =/ 89/ %/ s/ =/ 16/ ,/ Ec/ =/ 86/ %/ s/ =/ 19/ ,/ Ec/ =/ 83/ %/ s/ =/ 78/ ,/ Ec/ =/ 87/ %/ 85p/ =/ 32s/ =/ 3/ ,/ Ec/ =/ 78/ %/ s/ =/ 4/ ,/ Ec/ =/ 85/ %/ s/ =/ 10/ ,/ Ec/ =/ 82/ %/ s/ =/ 12/ ,/ Ec/ =/ 78/ %/ s/ =/ 49/ ,/ Ec/ =/ 82/ %/ 81/ 对/ 相同/ 规模/ 的/ PE/ 阵列/ 和/ 特定/ 的/ CM/ 模型/ 而言/ ,/ 即/ p/ 、/ K/ 和/ B/ 都/ 不变/ ,/ 显然/ α/ 的/ 值/ 将/ 随着/ 序列/ 的/ 长度/ L/ 的/ 增加/ 而/ 减小/ ,/ 所以/ 并行/ 效率/ EC/ 增大/ ./ 但/ 在/ 一般/ 情况/ 下/ ,/ CM/ 模型/ 的/ 状态/ 总数/ K/ 和/ 分支/ 状态/ 数量/ B/ 都/ 会/ 随/ 序列/ 长度/ 的/ 增加/ 而/ 增大/ ,/ 我们/ 将/ K/ ≈/ 3/ ·/ L/ 代入/ 式/ (/ 7/ )/ 并/ 进行/ 变换/ 得到/ 由于/ p/ 不变/ ,/ 而/ B/ 的/ 值/ 本身/ 很小/ ,/ L/ / B/ ,/ 所以/ α/ 的/ 值/ 随着/ L/ 的/ 增大/ 而/ 减小/ ,/ 从而/ 导致/ 并行/ 效率/ Ec/ 增大/ ./ 实际上/ 对/ 不同/ 规模/ 的/ RNA/ 序列/ 而言/ ,/ 随着/ 长/ EC/ =/ TCT/ =/ 1/ 将/ TC1/ ,/ TC2/ ,/ TM1/ ,/ TM2/ 和/ TLB/ 分别/ 代入/ ,/ 当/ L/ / p/ ,/ K/ / B/ 时/ ,/ 可/ 得到/ α/ 的/ 近似值/ :/ 根据/ 式/ (/ 6/ )/ 和/ (/ 7/ )/ ,/ 以/ SSURNA/ 序列/ (/ L/ =/ 1545/ ,/ K/ =/ 4789/ ,/ B/ =/ 30/ )/ 为例/ ,/ 当/ p/ =/ 16/ 时/ ,/ 加速器/ 的/ 并行执行/ 效率/ (/ Ec/ )/ 接近/ 90/ %/ ,/ 可见/ 细粒度/ 并行/ CYK/ 算法/ 具有/ 良好/ 的/ 可扩展性/ ./ 表/ 1/ 是/ 在/ 不同/ 的/ 阵列/ 规模/ 和/ 输入/ 条件/ 下/ ,/ 根据/ 式/ (/ 6/ )/ 计算/ 得出/ 的/ 并行/ 效率/ ,/ 从表中/ 可以/ 看出/ ,/ 随着/ RNA/ 序列/ 长度/ 和/ 处理器/ 个数/ 的/ 增加/ ,/ 并行/ 效率/ 随之/ 下降/ ./ 我们/ 可以/ 从式/ (/ 7/ )/ 出发/ 分析/ 原因/ :/ 对同/ 一条/ RNA/ 序列/ 而言/ ,/ 序列/ 的/ 长度/ L/ 、/ CM/ 模型/ 状态/ 的/ 数量/ K/ 以及/ 分支/ 状态/ 数量/ B/ 的/ 值/ 都/ 不变/ ,/ 处理器/ 个数/ p/ 的/ 增加/ 将/ 导致/ α/ 的/ 值/ 增大/ ,/ 从而/ 导致/ 并行/ 效率/ EC/ 降低/ ./ 实际上/ 处理器/ 个数/ p/ 的/ 增加/ 导致/ MasterPE/ 的/ 同步/ 等待时间/ 和/ 数据/ 载入/ 开销/ 增大/ ,/ 因为/ 只有/ 最后/ 一个/ PE/ 计算/ 完成/ 后/ 才能/ 给/ PE/ 阵列/ 分配/ 新/ 的/ 计算/ 任务/ ;/ 而/ 另一方面/ PE/ 数量/ 增加/ 缩短/ 了/ 计算/ 时间/ ,/ 导致/ PE/ 阵列/ 计算/ 部分/ 占/ 整个/ 任务/ 处理/ 时间/ 的/ 比例/ 下降/ ./ 度/ L/ 的/ 增加/ ,/ 分支/ 状态/ 数量/ 也/ 随之/ 增加/ ,/ 而/ 根据/ 算法/ 特征/ 4/ 的/ 分析/ ,/ 分支/ 状态/ 层/ 的/ 计算/ 开销/ 占/ 整个/ 开销/ 的/ 90/ %/ 以上/ ,/ 计算/ 开销/ 部分/ 增长/ 的/ 幅度/ (/ 为/ O/ (/ L3/ )/ 量级/ )/ 远大于/ 写/ 回/ 和/ 数据/ 载入/ 开销/ (/ 为/ O/ (/ L2/ )/ 量级/ )/ ,/ 从而/ 在/ PE/ 阵列/ 规模/ 一定/ 的/ 情况/ 下/ ,/ 对/ 较/ 大规模/ 的/ 问题/ 能够/ 取得/ 更好/ 的/ 加速/ 效果/ ./ 4.2/ 实验/ 环境/ 我们/ 在/ 测试/ 平台/ 上/ 实现/ 了/ 硬件/ CYK/ 算法/ 加速器/ ./ 测试/ 平台/ 由/ 一台/ 通用/ 计算机/ 和/ 一个/ 算法/ 加速器/ 构成/ ./ 主机/ 配置/ 为/ Intel/ 双核/ E5200/ 处理器/ ,/ 2.0/ GB/ 主存/ ./ 算法/ 加速器/ 硬件/ 主要/ 包括/ 1/ 片/ XilinxVirtex5/ 系列/ FPGA/ 芯片/ (/ XC5VLX330/ )/ ,/ 两条/ 总/ 容量/ 为/ Page134GB/ 的/ DDRIISODIMM/ 存储/ 条/ (/ KingstonKVR667D2S5/ // 2G/ )/ ,/ 加速器/ 通过/ PCI/ -/ E/ ×/ 8/ 数据通道/ 与/ 主机/ 相连/ ./ 算法/ 加速器/ 支持/ 动态/ 重构/ ,/ 可/ 在/ 60ms/ 内/ 完成/ 不同/ 规模/ 的/ CM/ 模型/ 间/ 的/ 快速/ 切换/ ,/ 与/ 配置/ 时间/ 为/ 秒/ 级/ 的/ 常规/ 配置/ 方法/ (/ 如/ JTAG/ 或/ 并行/ Slect/ -/ MAP/ )/ 相比/ ,/ FPGA/ 的/ 配置/ 效率/ 提高/ 了/ 2/ ~/ 3/ 个/ 数量级/ ./ CYK/ // inside/ 软件/ 版本/ 为/ Infernal/ -/ 1.0/ ,/ 由/ 美国华盛顿大学/ 医学院/ SeanEddy/ 实验室/ 开发/ [/ 22/ ]/ ,/ 分别/ 在/ IntelE5200/ 双核/ CPU/ 、/ AMD9650/ 四核/ 以及/ IntelQ9400/ 四核/ CPU3/ 种/ 不同/ 平台/ 上/ 运行/ ./ 4.3/ FPGA/ 资源/ 利用/ 我们/ 在/ 目前/ 最/ 大规模/ 的/ 商用/ FPGA/ 器件/ XilinxXC5VLX330/ 平台/ 上/ 实现/ 了/ 硬件/ CYK/ 算法/ 加速器/ ./ 从表/ 2/ 的/ 资源/ 使用/ 情况/ 可以/ 看到/ ,/ 在/ XC5VLX330/ 上/ 能够/ 实现/ 最/ 大规模/ 为/ 16/ -/ PE/ 的/ 处理/ 阵列/ ,/ 片内/ 逻/ 阵列/ 规模/ 片内/ 逻辑/ 资源/ 利用率/ BRAM/ 存储/ 利用率/ 频率/ // MHz1/ -/ PE16438/ // 207360/ (/ 8/ %/ )/ 25/ // 288/ (/ 9/ %/ )/ 1928/ -/ PE50046/ // 207360/ (/ 24/ %/ )/ 137/ // 288/ (/ 48/ %/ )/ 16816/ -/ PE88458/ // 207360/ (/ 42/ %/ )/ 265/ // 288/ (/ 92/ %/ )/ 164/ 表/ 3/ 不同/ 平台/ 下/ 的/ 软硬件/ 算法/ 执行/ 时间/ (/ s/ )/ 与/ 加速/ 比/ 测试/ 序列/ IntelE5200/ ①/ 0.251/ ./ 005.031/ ./ 08.601/ ./ 00279.51/ ./ 00798.61/ ./ 00AMD9650/ ②/ 0.221/ ./ 144.211/ ./ 17.151/ ./ 23227.21/ ./ 23614.31/ ./ 29IntelQ9400/ ③/ 0.211/ ./ 194.201/ ./ 26.371/ ./ 35224.91/ ./ 24605.71/ ./ 32FPGA/ (/ 8/ -/ PE/ )/ ④/ 0.064/ ./ 400.796/ ./ 41.207/ ./ 1738.77/ ./ 21111.27/ ./ 25FPGA/ (/ 16/ -/ PE/ )/ ⑤/ 0.0357/ ./ 100.4710/ ./ 70.6213/ ./ 920.113/ ./ 9055.914/ ./ 30/ 注/ :/ 硬件/ 环境/ :/ ①/ IntelDual/ -/ CoreE52002/ ./ 50GHzCPU/ ,/ 2.0/ GB/ 内存/ ;/ ②/ AMDPhenom9650QuadCPU/ ,/ 2.3/ GHz/ ,/ 3.0/ GB/ 内存/ ;/ ③/ IntelCore2Q9400QuadCPU/ ,/ 2.66/ GHz/ ,/ 3.0/ GB/ 内存/ ;/ ④/ FPG/ 加速/ (/ 8/ -/ PE/ )/ ,/ 160MHz/ ,/ 4.0/ GB/ 内存/ ;/ ⑤/ FPGA/ 加速器/ (/ 16/ -/ PE/ )/ ,/ 160MHz/ ,/ 4.0/ GB/ 内存/ ./ (/ 2/ )/ 性能/ 功耗/ 比图/ 9/ 是/ CYK/ 算法/ 加速器/ 与/ 通用/ 微处理器/ 的/ 性能/ // 功耗/ 对比/ ./ 我们/ 同样/ 以/ IntelE5200/ 双核/ 微处理器/ 为/ 参照/ ,/ 3/ 种/ 通用/ 微处理器/ 的/ 平均/ 功耗/ 约/ 为/ 65W/ ~/ 95W/ ,/ 而/ V5/ 系列/ 中/ 最/ 大规模/ 的/ XC5VLX330/ 芯片/ 的/ 功耗/ 不/ 超过/ 20W/ ,/ 仅为/ CPU/ 功耗/ 的/ 1/ // 3/ ~/ 1/ // 5/ ./ AMD/ 和/ Intel/ 四核/ 平台/ 的/ 性能/ 为/ E5200/ 处理器/ 的/ 1.3/ 倍/ ,/ 但/ CPU/ 功耗/ 大约/ 是/ 后者/ 的/ 1.5/ 倍/ ,/ 所以/ 就/ RNA/ 二级/ 结构/ 预测/ 应用/ 而言/ ,/ 3/ 种/ 通用/ 微处理器/ 的/ 性能/ 功耗/ 比/ 数据/ (/ t/ =/ 1000P/ // W/ )/ 比较/ 接近/ ,/ 而/ 包含/ 16/ 个/ PE/ 的/ FPGA/ 算法/ 加速器/ 的/ 性能/ 功耗/ 比是/ 通用/ 微处理器/ 的/ 30/ 倍/ 以上/ ./ 此外/ ,/ 使用/ 电流计/ (/ 型号/ HIOKI3290/ )/ 的/ 测试/ 结果表明/ ,/ 配置/ IntelE5200/ 双核/ CPU/ ,/ 2.0/ GB/ 内存/ 的/ 主机/ 在/ 运行/ Infernal/ -/ 1.0/ 程辑/ 资源/ 利用率/ 为/ 42/ %/ ,/ 而/ 存储资源/ 的/ 利用率/ 达到/ 了/ 92/ %/ ,/ 可见/ 存储资源/ 是/ 系统/ 实现/ 的/ 瓶颈/ ./ 从/ 时钟/ 频率/ 一栏/ 可以/ 看到/ ,/ 阵列/ 规模/ 从/ 8/ -/ PE/ 扩大/ 为/ 16/ -/ PE/ 时/ ,/ 加速器/ 的/ 工作频率/ 并/ 没有/ 出现/ 显著/ 的/ 下降/ ,/ 这/ 也/ 从/ 实验/ 上/ 进一步/ 验证/ 了/ 系统/ 的/ 可扩展性/ ./ 4.4/ 与/ 基于/ 单/ CPU/ 平台/ 的/ 软件/ CYK/ 处理/ 方案/ 对比/ (/ 1/ )/ 计算/ 时间/ 与/ 加速/ 比/ 我们/ 测试/ 了/ Infernal/ -/ 1.0/ 程序/ 在/ 3/ 种/ 不同/ 的/ 通用/ 微处理器/ 平台/ 下/ 的/ 执行/ 时间/ ,/ 并/ 与/ 硬件/ 加速器/ 进行/ 了/ 比较/ ./ 硬件/ CYK/ 算法/ 执行/ 时间/ 包括/ 加速器/ 计算/ 时间/ 和/ 数据/ 输入输出/ 开销/ ,/ FPGA/ 频率/ 为/ 160MHz/ ./ 从表/ 3/ 可以/ 看到/ ,/ 以/ Intel/ 双核/ E5200/ 处理器/ 为/ 参照/ ,/ 串行/ Infernal/ 程序/ 在/ 3/ 种/ 计算/ 平台/ 上/ 执行/ 的/ 性能/ 比较/ 接近/ (/ AMD/ 和/ Intel/ 四核/ 平台/ 的/ 速度/ 大约/ 为/ E5200CPU/ 的/ 1.1/ ~/ 1.3/ 倍/ )/ ,/ 但是/ 16/ -/ PE/ 的/ 硬件/ CYK/ 算法/ 加速器/ 性能/ 明显/ 超过/ 这/ 3/ 种/ 通用/ 微处理器/ ./ 在/ 算法/ 加速器/ 上/ 执行/ RNaseP/ 序列/ (/ 长度/ 为/ 379/ ,/ 模型/ 状态/ 数为/ 1176/ )/ 的/ 二级/ 结构/ 比/ 对/ 可/ 获得/ 接近/ 14/ 倍/ 的/ 加速/ 比/ ,/ 而/ 当/ 测试/ 序列/ 长度/ 为/ 959bps/ ,/ CM/ 模型/ 状态/ 数为/ 3145/ 时/ ,/ 可/ 获得/ 14.3/ 倍/ 的/ 加速/ 效果/ ./ 测试/ 平台/ RnaseP/ 时间/ 加速/ 比/ 序时/ 的/ 平均/ 功耗/ 为/ 150W/ ,/ 而/ 配置/ 一块/ FPGA/ 加速卡/ 的/ 算法/ 加速/ 平台/ 功耗/ 不/ 超过/ 180W/ ,/ 仅/ 增加/ 了/ Page1420/ %/ ,/ 但/ 获得/ 了/ 超过/ 14/ 倍/ 的/ 性能/ 提升/ ./ 4.5/ 与/ 基于/ 多/ CPU/ (/ Cluster/ )/ 平台/ 的/ 软件/ 并行/ CYK/ 处理/ 方案/ 对比/ (/ 1/ )/ 计算/ 时间/ 与/ 加速/ 比/ 为了/ 与/ 相关/ 工作/ [/ 11/ ,/ 13/ ]/ 进行/ 比较/ ,/ 我们/ 选取/ 了/ 两组/ 有/ 代表性/ 的/ 测试/ 序列/ (/ RNaseP/ 和/ SRPRNA/ )/ 和/ 对应/ 的/ CM/ 模型/ 进行/ 对比/ 测试/ ./ Liu/ 和/ Tan/ 等/ 人/ 分别/ 在/ XeonCluster/ [/ 11/ ]/ (/ 由/ 10/ 个/ 节点/ 构成/ ,/ 每个/ 节点/ 包含/ 2/ 个/ Intel/ -/ Xeon2/ ./ 0GHzCPU/ ,/ 1GB/ 主存/ )/ 和/ AMDCluster/ [/ 13/ ]/ (/ 由/ 8/ 个/ 节点/ 构成/ ,/ 每个/ 节点/ 包含/ 4/ 个/ 2.4/ GHzAMDOpteronCPU/ 和/ 8GB/ 主存/ )/ 平台/ 上/ 使用/ 标准/ C/ 和/ MPI/ 函数库/ 实现/ 了/ 无/ 回溯/ 的/ 并行/ CYK/ // inside/ 算法/ ./ 从图/ 10/ 可以/ 看到/ ,/ 在/ 这/ 两条/ 标准/ 测试/ 序列/ 下/ ,/ 细粒度/ 硬件/ CYK/ 算法/ 的/ 加速/ 效果/ 都/ 优于/ 软件/ 并行/ 方案/ ./ 以/ 执行/ RNasePRNA/ 序列/ 的/ 比/ 对/ 为例/ ,/ 在/ 由/ 8/ 个/ Xeon/ 处理器/ 构成/ 的/ Cluster/ 上测/ 得/ 的/ 加速/ 比为/ 5.1/ ,/ 按照/ 并行/ 效率/ 换算/ ,/ 在/ 16/ 个/ Xeon/ 处理器/ 上/ 最/ 多/ 可/ 获得/ 7/ 倍/ 的/ 加速/ 效果/ ;/ 在/ 由/ 8/ 个/ AMD/ 处理器/ 构成/ 的/ Cluster/ 上测/ 得/ 的/ 加速/ 比为/ 5.9/ ,/ 在/ 16/ 个/ AMD/ 处理器/ 上/ 可/ 获得/ 10.5/ 倍/ 的/ 加速/ 效果/ ./ 而/ 使用/ 包含/ 8/ -/ PE/ 的/ 算法/ 加速器/ 可/ 获得/ 接近/ 7/ 倍/ 的/ 加速/ 效果/ ,/ 使用/ 包含/ 16/ -/ PE/ 的/ 处理/ 阵列/ 可/ 获得/ 超过/ 14/ 倍/ 的/ 加速/ 比/ ./ 从图/ 中/ 还/ 可以/ 看到/ ,/ 软件/ 并行/ 方案/ 的/ 加速/ 性能/ 随着/ 处理器/ 个数/ 的/ 增加/ 而/ 下降/ ,/ 而/ 使用/ 算法/ 加速器/ 可/ 获得/ 接近/ 线性/ 的/ 加速/ 果/ ,/ 显示/ 出/ 细粒度/ 硬件/ CYK/ 算法/ 良好/ 的/ 可扩展性/ ./ (/ 2/ )/ 性能/ 价格比/ 与/ 性能/ 功耗/ 比图/ 11/ 是/ FPGA/ 算法/ 加速器/ 与/ 基于/ 多/ CPU/ 的/ Cluster/ 平台/ 的/ 性能/ 、/ 价格/ 和/ 功耗/ 对比/ ./ 为了/ 便于/ 比较/ ,/ 所有/ 指标/ 都/ 以/ 包含/ 16/ 个/ 处理器/ 的/ XeonCluster/ 为/ 参照/ ./ 从/ 系统/ 造价/ 上/ 看/ ,/ 3/ 种/ Cluster/ 系统/ 的/ 造价/ 大约/ 在/ 10/ ~/ 16/ 万元/ 之间/ ,/ 而/ 配置/ 一个/ FPGA/ (/ XC5VLX330/ )/ 算法/ 加速器/ 的/ 通用/ 计算/ 平台/ 的/ 价格/ 大约/ 为/ 3.5/ 万元/ ,/ 仅为/ Cluster/ 系统/ 的/ 20/ ~/ 30/ %/ ./ 从/ 系统/ 功耗/ 上/ 看/ ,/ 目前/ 单个/ 微处理器/ 的/ 平均/ 功耗/ 为/ 65W/ ~/ 95W/ [/ 20/ ]/ ,/ 以/ 平均/ 功耗/ 80W/ 计算/ ,/ 由/ 16/ 个/ CPU/ 构成/ 的/ Intel/ -/ Xeon/ 、/ AMD/ 和/ AlphaCluster/ 平台/ 的/ 功耗/ 大概/ 在/ 2kW/ ~/ 3kW/ 之间/ ./ 而/ 使用/ 电流计/ 的/ 测试/ 结果表明/ ,/ 包含/ 16/ 个/ PE/ 的/ XC5VLX330/ 芯片/ 功耗/ 不/ 超过/ 20W/ ,/ 算法/ 加速器/ 的/ 平均/ 功耗/ 小于/ 30W/ ,/ 整个/ 加速器/ 系统/ 平台/ (/ 包括/ 主机/ 和/ 加速器/ )/ 的/ 总/ 功耗/ 不/ 超过/ 200W/ ,/ 仅为/ Cluster/ 系统/ 功耗/ 的/ 10/ %/ 左右/ ./ 从/ 对/ CYK/ 算法/ 的/ 整体/ 加速/ 效果/ 来看/ ,/ 包含/ 一个/ FPGA/ 算法/ 加速器/ 的/ 计算/ 平台/ 的/ 性能/ 与/ 包含/ 20/ 个/ Intel/ -/ XeonCPU/ 的/ PC/ 集群/ 相当/ ,/ 而/ 从/ 性能/ 价格比/ (/ s/ =/ 100P/ // C/ )/ 和/ 性能/ 功耗/ 比/ (/ t/ =/ 100P/ // W/ )/ 参数/ 来看/ ,/ 基于/ FPGA/ 平台/ 的/ 细粒度/ 并行/ CYK/ 算法/ 加速器/ 方案/ 明显/ 优于/ 传统/ 的/ 基于/ 通用/ 微处理器/ 的/ PCCluster/ 解决方案/ ./ 5/ 结论/ 基于/ 随机/ 上下文/ 无关/ 文法/ (/ SCFG/ )/ 模型/ 的/ CYK/ 算法/ 是/ 一类/ 重要/ 的/ RNA/ 二级/ 结构/ 预测/ 方法/ ,/ 现有/ 的/ 基于/ 大规模/ 并行处理/ 平台/ 的/ CYK/ 算法/ 加速/ 方案/ 受限于/ 计算/ 通信/ 比/ ,/ 随着/ 问题/ 规模/ 的/ 增长/ 并行处理/ 效率/ 明显/ 下降/ ,/ 此外/ 大规模/ 并行/ 计算机系统/ 硬件/ 设备/ 的/ 购置/ 、/ 使用/ 、/ 日常/ 维护/ 的/ 成本/ 高昂/ ,/ 其/ 适用性/ 受到/ 诸多/ 限制/ ./ 本文/ 在/ 深入分析/ CYK/ 算法/ 计算/ 特征/ 的/ 基础/ 上/ ,/ 基于/ FPGA/ 平台/ 提出/ 并/ 实现/ 了/ 一种/ 细粒度/ 的/ 并行/ CYK/ 算法/ ./ 设计/ 采用/ 了/ 对/ 三维/ 动态/ 规划/ Page15/ 矩阵/ 按/ 状态/ 层/ 方向/ 进行/ 区域分割/ 、/ 区域/ 内/ 逐层/ 计算/ 、/ 状态/ 层内/ 按/ 矩阵/ 列/ 顺序/ 并行处理/ 的/ 任务/ 划分/ 策略/ ,/ 实现/ 了/ 处理单元/ 间/ 的/ 负载平衡/ ;/ 采用/ 数据/ 预取/ 、/ 滑动/ 窗口/ 和/ 数据/ 传递/ 流水线/ 实现/ 处理单元/ 间/ 的/ 数据/ 重用/ ,/ 采用/ 数据/ 驱动/ 的/ 计算/ 流水线/ 隐藏/ 片外/ 数据/ 载入/ 开销/ ,/ 达到/ 每个/ 时钟/ 周期/ 流出/ 一个/ 结果/ 的/ 效果/ ,/ 有效/ 解决/ 了/ 计算/ 和/ 通信/ 间/ 的/ 平衡/ 问题/ ;/ 设计/ 了/ 一种/ 类似/ 脉动阵列/ (/ systolic/ -/ likearray/ )/ 结构/ 的/ 主从/ 多/ PE/ 并行计算/ 阵列/ ,/ 并/ 在/ 单片/ FPGA/ (/ XC5VLX330/ )/ 上/ 成功/ 集成/ 了/ 16/ 个/ PE/ ,/ 实验/ 结果表明/ 我们/ 提出/ 的/ CYK/ 算法/ 加速器/ 结构/ 具备/ 良好/ 的/ 可扩展性/ ./ 当/ RNA/ 序列/ 长度/ 为/ 959bps/ ,/ CM/ 模型/ 状态/ 数为/ 3145/ 时/ ,/ 与/ 运行/ 在/ Intel/ 双核/ E5200/ 通用/ 微处理器/ 上/ 的/ Infernal/ -/ 1.0/ 软件/ 相比/ ,/ 可/ 获得/ 超过/ 14/ 倍/ 的/ 加速/ 效果/ ./ 就/ 对/ CYK/ 算法/ 的/ 加速/ 效果/ 而言/ ,/ 配置/ 一个/ FPGA/ 算法/ 加速器/ 的/ 通用/ 计算/ 平台/ 的/ 处理/ 性能/ 与/ 包含/ 20/ 个/ Intel/ -/ XeonCPU/ 的/ PC/ 集群/ 相当/ ,/ 而/ 硬件/ 成本/ 仅为/ 后者/ 的/ 20/ %/ ,/ 系统/ 功耗/ 不到/ 后者/ 的/ 10/ %/ ./ 

