Page1/ 一种/ 高效率/ 的/ 实时/ 协同/ 编辑/ 中/ 的/ 意图/ 保持/ 操作/ 转换/ 算法/ 1/ )/ (/ 武汉大学/ 计算机/ 学院/ 武汉/ 430072/ )/ 2/ )/ (/ 软件工程/ 国家/ 重点/ 实验室/ 武汉/ 430072/ )/ 摘要/ 作为/ 一类/ 高级/ 分布式系统/ ,/ 实时/ 协同/ 编辑/ 系统/ 允许/ 不同/ 地点/ 的/ 用户/ 同时/ 编辑/ 共享/ 文档/ ,/ 具有/ 高/ 响应/ 性/ 和/ 高/ 并发/ 性/ 的/ 特点/ ./ 操作/ 转换/ (/ OperationalTransformation/ ,/ OT/ )/ 算法/ 能够/ 保留/ 所有/ 用户/ 操作/ 的/ 效果/ 并/ 维护/ 数据/ 的/ 一致性/ ,/ 是/ 协同/ 编辑/ 系统/ 首选/ 的/ 并发/ 控制/ 方法/ ./ 为了/ 提高/ 远程/ 操作/ 的/ 响应/ 时间/ ,/ 文中/ 提出/ 了/ 一种/ 意图/ 保持/ 的/ OT/ 算法/ (/ MergingOperationsbasedOperationalTransformation/ ,/ MOOT/ )/ ./ 该/ 算法/ 基于/ 这样/ 一个/ 事实/ ,/ 大多数/ 情况/ 下/ ,/ 协同/ 编辑/ 中/ 插入/ 操作/ 的/ 数量/ 明显/ 多于/ 删除/ 操作/ ./ 因此/ ,/ MOOT/ 构造/ 了/ 一种/ 优化/ 的/ 操作/ 历史/ 结构/ ,/ 即/ 删除/ 操作/ 排/ 在/ 插入/ 操作/ 前面/ ,/ 避免/ 算法/ 的/ 计算/ 时间/ 依赖于/ 大多数/ 操作/ ./ 更进一步/ ,/ MOOT/ 在/ 重构/ 过程/ 中/ 移除/ 无效/ 操作/ ,/ 有效/ 的/ 压缩/ 了/ 操作/ 历史/ 的/ 大小/ ./ 为了/ 验证/ 算法/ 的/ 有效性/ ,/ 在/ 不同/ 插入/ 比例/ 情况/ 下/ ,/ 将/ MOOT/ 算法/ 与/ 当前/ 性能/ 最优/ 的/ ABT/ 算法/ 进行/ 了/ 对比/ 实验/ ./ 实验/ 结果表明/ ,/ MOOT/ 算法/ 具有/ 更/ 高/ 的/ 计算/ 效率/ ,/ 在/ 合理/ 的/ 比例/ 情况/ 下/ ,/ 其/ 计算/ 时间/ 大约/ 是/ ABT/ 算法/ 的/ 计算/ 时间/ 的/ 十分之一/ ./ 关键词/ 实时/ 协同/ 编辑/ ;/ 并发/ 控制/ ;/ 操作/ 转换/ ;/ 社交/ 网络/ 1/ 引言/ 2013/ 年/ 图灵奖/ 得主/ LeslieLamport/ ①/ 的/ 主要/ 成就/ 来源于/ 1978/ 年/ 发表/ 的/ 一篇/ 关于/ 分布式系统/ 的/ 论文/ [/ 1/ ]/ ./ 该篇/ 论文/ 是/ 计算机/ 科学史/ 上/ 引用/ 率/ 最高/ 的/ 论文/ 之一/ (/ oneofthemostcitedinthehistoryofcomputerscience/ )/ ./ 作为/ 分布式系统/ 的/ 进一步/ 发展/ ,/ 实时/ 协同工作/ 系统/ 在/ 继承/ 了/ Lamport/ 事件/ 关系/ 的/ 基础/ 上/ ,/ 所/ 演化出/ 的/ 操作/ 转换/ (/ OperationalTrans/ -/ formation/ ,/ OT/ )/ 算法/ 吸引/ 了/ 相关/ 学者/ 的/ 大量/ 的/ 研究/ ./ OT/ 作为/ 一种/ 乐观/ 并发/ 控制算法/ ,/ 被/ 广泛/ 用于/ 支持/ 纯/ 文本/ ②/ 、/ Word/ 和/ PowerPoint/ [/ 2/ -/ 3/ ]/ 、/ Spreadsheet/ [/ 4/ ]/ 、/ 2D/ 图像/ [/ 5/ ]/ 、/ 2D/ 和/ 3D/ 图形/ [/ 6/ -/ 7/ ]/ 以及/ CAD/ [/ 8/ -/ 10/ ]/ 的/ 协同/ 编辑/ 工作/ ./ 随着/ 移动/ 计算/ 、/ 云/ 计算/ 、/ 大/ 数据/ 的/ 发展/ ,/ OT/ 算法/ 的/ 性能/ 逐渐/ 成为/ 关注/ 的/ 焦点/ ./ Shao/ 等/ 人/ [/ 11/ ]/ 指出/ 实现/ 意图/ 保持/ 且/ 经过/ 严格/ 证明/ 的/ ABT/ 算法/ (/ Admissibility/ -/ BasedTransformation/ )/ 在/ 计算/ 性能/ 上/ 优于/ 其他/ 的/ OT/ 算法/ ./ 基于/ ABT/ 算法/ 框架/ [/ 12/ ]/ 、/ 支持/ String/ 操作/ 的/ ABST/ [/ 13/ ]/ ,/ 异步/ 协同/ 的/ ABTS/ [/ 11/ ]/ 以及/ 支持/ anyundo/ 的/ ABTU/ [/ 14/ ]/ 等/ 算法/ 相继/ 被/ 提出/ ./ ABT/ 算法/ 维护/ 特殊/ 的/ 操作/ 历史/ HB/ (/ HistoryBuffer/ )/ ,/ 即/ 插入/ 操作/ 在/ 删除/ 操作/ 之前/ ,/ 避免/ 了/ 删除/ 操作/ 对/ 插入/ 操作/ 的/ 影响/ ,/ 很/ 自然/ 地/ 保持/ 了/ 操作/ 对象/ 之间/ 的/ 位置/ 关系/ ./ 与/ 已有/ 的/ OT/ 算法/ 相比/ ,/ ABT/ 算法/ 不仅/ 能够/ 实现/ 意图/ 保持/ 而且/ 具有/ 更/ 高/ 的/ 计算/ 效率/ ./ 但是/ ,/ ABT/ 算法/ 的/ 计算/ 时间/ 严重/ 依赖于/ 插入/ 操作/ 的/ 数量/ ./ 相关/ 文献/ 表明/ [/ 15/ ]/ ,/ 在/ 协同/ 编辑/ 中/ 插入/ 操作/ 的/ 数量/ 远远/ 多于/ 删除/ 操作/ ,/ 插入/ 操作/ 占/ 总/ 操作数/ 80/ %/ 是/ 一个/ 比较/ 合理/ (/ reasonable/ )/ 的/ 比例/ ./ 因此/ ,/ ABT/ 算法/ 重构/ 的/ HB/ 结构/ 并非/ 是/ 最/ 合理/ 的/ ./ 另一方面/ ,/ 协同/ 编辑/ 过程/ 中/ 存在/ 着/ 许多/ 无效/ 操作/ 对/ (/ 插入/ 的/ 对象/ 随后/ 又/ 被/ 删除/ )/ ,/ 将/ 它们/ 从/ HB/ 中/ 移除/ 不仅/ 不会/ 影响/ 其他/ 操作/ ,/ 而且/ 能够/ 减少/ 不必要/ 的/ 计算/ ./ 基于/ 以上/ 两点/ 考虑/ ,/ 本文/ 提出/ 了/ 一种/ 合并/ 无效/ 操作/ 的/ MOOT/ 算法/ (/ MergingOperationsBasedonOperationalTransformation/ )/ ./ 本文/ 第/ 2/ 节为/ OT/ 相关/ 的/ 研究/ 工作/ ;/ 第/ 3/ 节为/ OT/ 的/ 基本/ 模型/ 与/ 算法/ 分析/ ;/ 第/ 4/ 节为/ MOOT/ 算法/ 的/ 详细描述/ ;/ 第/ 5/ 节为/ MOOT/ 算法/ 的/ 实例/ 分析/ ;/ 第/ 6/ 节为/ 实验/ 研究/ ;/ 第/ 7/ 节为/ 全文/ 总结/ ./ 2/ 相关/ 工作/ Ellis/ 等/ 人/ [/ 16/ ]/ 在/ 1989/ 年/ 首次/ 提出/ 操作/ 转换/ 的/ 概念/ ,/ 建立/ 了/ OT/ 算法/ 的/ 基本/ 模型/ ./ 第一个/ OT/ 算法/ (/ dOPT/ )/ 被/ 成功/ 应用/ 到/ 了/ 协同/ 编辑/ 系统/ Grove/ ./ 基于/ dOPT/ 算法/ ,/ 杨光信/ 等/ 人/ [/ 17/ ]/ 提出/ 了/ 面向对象/ 数据模型/ 的/ 并发/ 控制/ 方法/ ./ Ressel/ 等/ 人/ [/ 18/ ]/ 发现/ 了/ dOPT/ 的/ “/ puzzle/ ”/ (/ 某些/ 场景/ 下/ 各个/ 站点/ 的/ 结果/ 不/ 一致/ )/ 并/ 提出/ 转换/ 函数/ 正确性/ 的/ 充分/ 必要条件/ (/ TP1/ 和/ TP2/ )/ ./ 之后/ ,/ 不断/ 有/ 新/ 的/ 算法/ 被/ 提出/ ,/ 尽管/ 声称/ 能够/ 满足/ TP1/ 和/ TP2/ ,/ 但/ 随后/ 都/ 被/ 其他/ 算法/ 证明/ 存在/ “/ puzzle/ ”/ ./ 设计/ 满足/ TP2/ 条件/ 的/ 转换/ 函数/ 是/ 非常/ 困难/ 的/ ./ 2014/ 年/ Randolph/ 等/ 人/ [/ 19/ ]/ 指出/ ,/ 非/ 全序/ OT/ 算法/ 的/ 转换/ 函数/ 都/ 不能/ 同时/ 满足/ TP1/ 和/ TP2/ 条件/ ./ 经过/ 自动机/ 合成/ 的/ 正确/ 转换/ 函数/ 需要/ 为/ 操作/ 添加/ 额外/ 的/ 信息/ ./ 大部分/ OT/ 算法/ 通过/ 控制/ 过程/ (/ 也/ 称作/ 集成/ 过程/ )/ 摆脱/ 了/ TP2/ 对/ 转换/ 函数/ 的/ 限制/ ./ 这类/ 算法/ 不/ 需要/ 转换/ 函数/ 在/ 所有/ 情况/ 下/ 都/ 能/ 获得/ 正确/ 的/ 结果/ ./ 控制/ 过程/ 负责/ 调度/ 远程/ 操作/ 与/ 操作/ 历史/ 中/ 的/ 操作/ 进行/ 转换/ ,/ 根据/ 操作/ 的/ 全局/ 顺序/ 来/ 产生/ 唯一/ 的/ 转换/ 路径/ ./ SOCT4/ [/ 20/ ]/ 利用/ 集中式/ 的/ sequencer/ 产生/ 全局/ 有序/ 的/ 操作/ 序列/ ,/ GOTO/ [/ 21/ ]/ 结合/ 状态/ 向量/ 和/ 站点/ 优先级/ 来/ 判断/ 操作/ 之间/ 的/ 全序/ 关系/ ,/ TIBOT/ [/ 22/ ]/ 定义/ 的/ 全序/ 要求/ 各个/ 站点/ 的/ 逻辑/ 时钟/ 是/ 同步/ 的/ ./ 每/ 一个/ 操作/ 在/ 所有/ 站点/ 进行/ 转换/ 的/ 操作/ 序列/ 都/ 是/ 相同/ 的/ ,/ 最终/ 得到/ 的/ 操作/ 历史/ 也/ 是/ 相同/ 的/ ./ 控制/ 过程/ 还有/ 另外/ 一个/ 作用/ ,/ 就是/ 处理/ 偏/ 并发/ 操作/ 的/ 集成/ ./ 在/ 协同/ 编辑/ 环境/ 下/ ,/ 并发/ 操作/ 有/ 可能/ ①/ ②/ Page3/ 产生/ 于/ 不同/ 的/ 文档/ 状态/ ,/ 导致/ 操作/ 对象/ 的/ 位置/ 不/ 具有/ 可比性/ [/ 23/ ]/ ./ 因此/ ,/ 直接/ 调用/ 转换/ 函数/ 可能/ 会/ 导致/ 结果/ 不/ 一致/ 的/ 情况/ 发生/ ./ GOT/ [/ 24/ ]/ 算法/ 补充/ 了/ 基本操作/ 转换/ 的/ 概念/ ,/ 提出/ 了/ 包含/ 转换/ IT/ (/ InclusiveTransformation/ )/ 的/ 逆/ 过程/ 排除/ 转换/ ET/ (/ ExclusiveTransformation/ )/ ./ ET/ 能够/ 将/ 不同/ 文档/ 状态/ 下/ 的/ 操作/ 转换成/ 相同/ 状态/ 下/ 的/ 操作/ ./ 交换/ 两个/ 操作/ 的/ 执行/ 顺序/ 是/ 先/ 调用/ ET/ 然后/ 调用/ IT/ ,/ 这个/ 过程/ 被/ 封装/ 为/ SWAP/ 函数/ ./ Suleiman/ 等/ 人/ [/ 25/ ]/ 提出/ 了/ 前/ 向/ 转换/ FT/ (/ ForwardTransposition/ )/ 和/ 后/ 向/ 转换/ BT/ (/ BackwardTransposition/ )/ 的/ 概念/ ./ 通过/ 文献/ [/ 26/ ]/ 的/ 分析/ ,/ FT/ 和/ BT/ 本质/ 上/ 分别/ 等价/ 于/ IT/ 和/ SWAP/ ./ SOCT2/ [/ 25/ ]/ 的/ 控制/ 过程/ 接收/ 到/ 远程/ 操作/ 后/ ,/ 将/ 站点/ 的/ 操作/ 历史/ 分类排列/ ,/ 因/ 操作/ 在/ 前/ ,/ 并发/ 操作/ 在/ 后/ ,/ 并发/ 操作/ 序列/ 是/ 需要/ 进行/ 转换/ 的/ ./ 该/ 排列/ 被/ 大多数/ OT/ 算法/ 用来/ 寻找/ 并发/ 操作/ 集/ ./ Sun/ 等/ 人/ 认为/ 转换/ 函数/ 和/ 控制/ 过程/ 是/ 松散/ 耦合/ 的/ ./ 转换/ 函数/ 定义/ 操作/ 之间/ 的/ 互相/ 转换/ ,/ 与/ 具体/ 的/ 应用/ 相关/ ,/ 而/ 控制/ 过程/ 负责/ 调度/ 远程/ 操作/ 与/ HB/ 中/ 的/ 操作/ 进行/ 转换/ ,/ 是/ 独立/ 于/ 具体/ 应用/ 的/ ./ 因此/ ,/ Sun/ 等/ 人/ [/ 3/ ,/ 27/ ]/ 将/ 控制/ 过程/ 封装/ 成/ 通用/ 协同/ 引擎/ GCE/ (/ GenericCollaborativeEngine/ )/ ,/ 并/ 应用/ 到/ 单/ 用户程序/ 向/ 多用户/ 的/ 透明/ 转换/ ./ 意图/ 保持/ 是/ 一种/ 更加/ 严格/ 的/ 一致性/ ./ Sun/ 等/ 人/ [/ 28/ ]/ 最早/ 提出/ OT/ 算法/ 不仅/ 要/ 实现/ 结果/ 一致性/ ,/ 而且/ 要/ 保证/ 最终/ 的/ 结果/ 反应/ 了/ 操作/ 的/ 意图/ ,/ 即/ 意图/ 保持/ ./ 然而/ 意图/ 的/ 定义/ 一直/ 是/ 模糊/ 的/ ./ Li/ 等/ 人/ [/ 29/ -/ 30/ ]/ 认为/ 意图/ 保持/ 包含/ 了/ 结果/ 一致/ ,/ 并/ 明确/ 的/ 将/ 操作/ 的/ 意图/ 定义/ 成/ 操作/ 作用/ 对象/ 之间/ 的/ 位置/ 关系/ ./ 全序/ 的/ OT/ 算法/ 在/ 静默/ 状态/ (/ 协同/ 会话/ 结束/ )/ 的/ 结果/ 依赖于/ 操作/ 的/ 全序/ 关系/ ,/ 不/ 一定/ 能够/ 保持/ 操作/ 的/ 意图/ ./ TTF/ [/ 31/ ]/ 利用/ 分布式系统/ 中/ 的/ 墓碑/ (/ Tombstone/ )/ 概念/ ,/ 保留/ 被/ 删除/ 的/ 字符/ ,/ 使得/ 对/ 插入/ 操作/ 的/ 转换/ 具有/ 位置/ 单调/ 递增/ 的/ 性质/ ,/ 能够/ 保持/ 操作/ 对象/ 之间/ 的/ 前后/ 关系/ ./ TTF/ 需要/ 在/ 站点/ 同时/ 维护/ 物理/ 视图/ 和/ 逻辑/ 视图/ ,/ 物理/ 视图/ 保存/ 了/ 逻辑/ 视图/ 中/ 被/ 删除/ 的/ 对象/ ,/ 用户/ 与/ 逻辑/ 视图/ 进行/ 交互/ ,/ 而待/ 转换/ 的/ 操作/ 都/ 是/ 基于/ 物理/ 视图/ 的/ ./ 这种/ 方法/ 的/ 空间/ 消耗/ 比较/ 大/ ,/ 并且/ 视图/ 之间/ 的/ 转换/ 也/ 需要/ 耗费/ 大量/ 计算/ 时间/ ./ LBT/ [/ 32/ ]/ 为/ 协同/ 编辑/ 中/ 的/ 所有/ 对象/ 定义/ 全局/ 顺序/ ,/ 但是/ 从/ 偏序/ 推演/ 到/ 全序/ 的/ 过程/ 需要/ 花费/ 大量/ 的/ 计算/ 时间/ 和/ 空间/ ./ ABT/ 在/ 所有/ 站点/ 维护/ 插入/ 在/ 前/ 删除/ 在/ 后/ 的/ HB/ 结构/ ,/ 避免/ 了/ 删除/ 操作/ 对/ 插入/ 操作/ 的/ 影响/ ,/ 简化/ 了/ 意图/ 保持/ 的/ 实现/ 过程/ ./ 在/ 实时/ 协同/ 编辑/ 中/ ,/ 可选/ 的/ 乐观/ 并发/ 控制算法/ 还/ 包括/ CRDT/ (/ CommutativeReplicatedDataType/ )/ [/ 33/ -/ 35/ ]/ ./ CRDT/ 通过/ 为/ 协同/ 编辑/ 过程/ 中/ 出现/ 的/ 每/ 一个/ 对象/ 定义/ 全局/ 有序/ 并且/ 唯一/ 的/ 标识/ ,/ 实现/ 操作/ 之间/ 的/ 可/ 交换/ 性/ ,/ 最终/ 确保/ 结果/ 一致/ ./ 与/ CRDT/ 相比/ ,/ 意图/ 保持/ 的/ OT/ 实现/ 了/ 更/ 强/ 的/ 一致性/ ,/ 结果/ 更/ 接近/ 用户/ 的/ 实际/ 意图/ ./ 目前/ ,/ CRDT/ 方法/ 还/ 没有/ 得到/ 广泛/ 的/ 实际/ 应用/ ./ 文献/ [/ 36/ -/ 37/ ]/ 提供/ 了/ ABT/ 算法/ 与/ 其他/ OT/ 算法/ 在/ 集成/ 远程/ 操作/ 时/ 的/ 性能/ 比较/ ./ 实验/ 结果表明/ ,/ ABT/ 算法/ 是/ 当前/ 效率/ 最高/ 的/ 操作/ 转换/ 算法/ ./ 然而/ ,/ ABT/ 重构/ 的/ 操作/ 历史/ 是否是/ 最优/ 的/ ,/ 值得/ 商榷/ ./ 3OT/ 基本/ 模型/ 与/ 算法/ 分析/ OT/ 算法/ 从/ 协同/ 编辑/ 系统/ 中/ 抽象/ 出/ 两个/ 元/ 操作/ (/ 插入/ 、/ 删除/ )/ ,/ 操作/ 的/ 对象/ 是/ 线性/ 排列/ 的/ ./ OT/ 算法/ 能够/ 推广/ 到/ 其他/ 具有/ 复杂/ 结构/ 的/ 协同/ 系统/ [/ 38/ ]/ ./ 操作/ 之间/ 的/ 先后/ 关系/ 建立/ 在/ Lamport/ 定义/ 的/ “/ happened/ -/ before/ ”/ 理论/ 基础/ 之上/ ./ 站点/ 执行/ 的/ 操作/ 都/ 被/ 保存/ 在/ HB/ 中/ ./ 操作/ 转换/ 的/ 基本/ 思想/ 是/ 本地/ 操作/ 立即/ 执行/ ,/ 远程/ 操作/ 经过/ 转换/ 之后/ 再/ 执行/ ,/ 各个/ 站点/ 按照/ 不同/ 的/ 顺序/ 执行/ 操作/ 之后/ 获得/ 相同/ 的/ 结果/ ./ 定义/ 1/ ./ 因果关系/ ./ 给定/ 任意/ 两个/ 分别/ 位于/ 站点/ i/ 和/ 站点/ j/ 上/ 的/ 操作/ Oa/ 和/ Ob/ ,/ 称/ Oa/ 和/ Ob/ 存在/ 因果关系/ (/ 记作/ Oa/ →/ Ob/ )/ ,/ 当且/ 仅/ 当/ Oa/ 和/ Ob/ 满足/ 下列/ 3/ 个/ 条件/ 之一/ :/ (/ 1/ )/ i/ =/ j/ 并且/ 操作/ Oa/ 发生/ 在/ Ob/ 之前/ ;/ (/ 2/ )/ i/ ≠/ j/ 并且/ 操作/ Oa/ 在/ 站点/ j/ 的/ 执行/ 先于/ 操作/ Ob/ 的/ 产生/ ;/ (/ 3/ )/ 存在/ 操作/ Ox/ ,/ 并且/ 有/ Oa/ →/ Ox/ 和/ Ox/ →/ Ob/ ./ 定义/ 2/ ./ 并发/ 关系/ ./ 给定/ 任意/ 两个/ 操作/ Oa/ 和/ Ob/ ,/ 称/ Oa/ 和/ Ob/ 存在/ 并发/ 关系/ (/ 记作/ Oa/ ‖/ Ob/ )/ ,/ 当且/ 仅/ 当/ Oa/ 和/ Ob/ 既/ 不/ 满足/ Oa/ →/ Ob/ ,/ 也/ 不/ 满足/ Ob/ →/ Oa/ ./ 根据/ 定义/ 1/ 、/ 2/ ,/ 图/ 1/ (/ a/ )/ 中/ 操作/ o1/ 与/ o2/ 是/ 并发/ 关系/ ,/ 图/ 1/ (/ c/ )/ 中/ o1/ 与/ o2/ 是/ 因果关系/ ./ 每个/ 操作/ 都/ 会/ 携带/ 状态/ 向量/ 犛/ 犞/ (/ StateVector/ )/ 的/ 信息/ ,/ 用来/ 判断/ 操作/ 之间/ 的/ 关系/ ./ 犛/ 犞/ 是/ 一个/ 长度/ 固定/ 的/ 向量/ ,/ 长度/ 等于/ 协同/ 站点/ 的/ 数目/ ,/ 其中/ 每个/ 分量/ 对/ 应该/ 站点/ 已/ 执行/ 操作/ 的/ 数目/ ./ 如果/ 操作/ o1/ 来自/ 站点/ i/ ,/ o2/ 来自/ 站点/ j/ ,/ 并且/ 犛/ 犞/ o1Page4/ 为了/ 方便/ 讨论/ ,/ 共享/ 的/ 文档/ 通常/ 被/ 看作/ 是/ 字符/ 的/ 集合/ ,/ 字符串/ (/ 起始/ 位置/ 为/ 0/ )/ ./ 协同/ 编辑/ 中/ 的/ 两个/ 基本操作/ :/ ins/ (/ p/ ,/ c/ )/ 表示/ 在/ 位置/ p/ 插入/ 字符/ c/ ;/ del/ (/ p/ )/ 表示/ 删除/ 位置/ p/ 的/ 字符/ ./ 每个/ 站点/ 对应/ 一位/ 用户/ ./ 图/ 2/ 解释/ 了/ 操作/ 转换/ 的/ 基本/ 思想/ ./ 两个/ 用户/ 共同/ 编辑文档/ (/ 初始/ 为/ “/ abc/ ”/ )/ ,/ 站点/ 1/ 发起/ 操作/ o1/ =/ ins/ (/ 2/ ,/ d/ )/ ,/ 站点/ 2/ 同时/ 发起/ 操作/ o2/ =/ del/ (/ 1/ )/ ./ 本地/ 产生/ 的/ 操作/ 都/ 会/ 被/ 立刻/ 执行/ ,/ 然后/ 广播/ 给/ 其他/ 站点/ ./ 其中/ ,/ 犛/ 犞/ o1/ =/ [/ 00/ ]/ 、/ 犛/ 犞/ o2/ =/ [/ 00/ ]/ ,/ o1/ ‖/ o2/ ./ 当/ 站点/ 2/ 接收/ 到/ 站点/ 1/ 的/ 插入/ 操作/ 时/ ,/ 由于/ 已经/ 删除/ 了/ b/ ,/ 操作/ o1/ 被/ 转换/ 到/ 位置/ p/ =/ 1/ 执行/ ./ 同理/ ,/ 当/ 站点/ 1/ 接收/ 到/ 站点/ 2/ 的/ 操作/ 时/ ,/ 由于/ 插入/ 的/ 字符/ d/ 并/ 没有/ 移动/ 字符/ b/ 的/ 位置/ ,/ 所以/ 仍然/ 执行/ del/ (/ 1/ )/ ./ 最终/ ,/ 两个/ 站点/ 都/ 获得/ 了/ 一致/ 的/ 结果/ ./ Ressel/ 等/ 人/ [/ 18/ ]/ 提出/ 了/ OT/ 算法/ 的/ 充分/ 必要条件/ TP1/ 和/ TP2/ ,/ 分别/ 对应/ 图/ 1/ (/ a/ )/ 和/ 图/ 1/ (/ b/ )/ 的/ 场景/ ./ TP1/ 确保/ 两个/ 并发/ 操作/ o1/ ‖/ o2/ ,/ 先/ 执行/ o1/ 再/ 执行/ o2/ 的/ 结果/ 等于/ 先/ 执行/ o2/ 再/ 执行/ o1/ 的/ 结果/ ./ TP2/ 确保/ 3/ 个/ 并发/ 操作/ o1/ ‖/ o2/ ‖/ o3/ ,/ o3/ 对/ [/ o2o1/ ]/ 和/ [/ o1o2/ ]/ 转换/ 之后/ 得到/ 相同/ 的/ 形式/ ,/ 其中/ [/ o2o1/ ]/ 和/ [/ o1o2/ ]/ 的/ 执行/ 效果/ 相同/ ./ 定义/ 3/ ./ 偏/ 并发/ 关系/ ./ 当/ 两个/ 并发/ 操作/ 产生/ 于/ 不同/ 的/ 文档/ 状态/ 时/ ,/ 称/ 这/ 两个/ 操作/ 是/ 偏/ 并发/ 关系/ ./ 操作/ 的/ 位置/ p/ 都/ 是/ 相对/ 于/ 某个/ 文档/ 状态/ 的/ ,/ 不同/ 文档/ 状态/ 下/ 的/ p/ 不/ 具有/ 可比性/ ./ 站点/ 产生/ 操作/ o/ 时/ 的/ 文档/ 状态/ 称作/ o/ 的/ 定义/ 状态/ ,/ 也/ 称/ 操作/ 上下文/ (/ operationcontext/ )/ [/ 39/ ]/ ,/ 记为/ C/ (/ o/ )/ ./ 文档/ 状态/ 由/ 从/ 原始/ 状态/ 到/ 当前/ 状态/ 所/ 执行/ 的/ 操作/ 序列/ 来/ 表示/ ./ 在/ 图/ 1/ (/ c/ )/ 中/ ,/ C/ (/ o3/ )/ =/ [/ ]/ 、/ C/ (/ o2/ )/ =/ [/ o1/ ]/ 并且/ o2/ ‖/ o3/ ,/ 因此/ o2/ 与/ o3/ 是/ 偏/ 并发/ 的/ 关系/ ./ 假设/ o1/ =/ ins/ (/ 2/ ,/ a/ )/ 、/ o2/ =/ ins/ (/ 3/ ,/ b/ )/ 、/ o3/ =/ del/ (/ 2/ )/ ,/ o3/ 对/ [/ o1o2/ ]/ 转换/ 之后/ 得到/ o3/ =/ del/ (/ 4/ )/ ,/ o1/ 对/ o3/ 转换/ 之后/ 得到/ o1/ =/ ins/ (/ 2/ ,/ a/ )/ ./ 由于/ C/ (/ o2/ )/ ≠/ C/ (/ o3/ )/ ,/ o2/ 对/ o3/ 直接/ 转换/ 之后/ 得到/ o2/ =/ ins/ (/ 2/ ,/ b/ )/ ,/ [/ o1o2o3/ ]/ ≠/ [/ o3o1o2/ ]/ ,/ 造成/ 了/ 不/ 一致/ 的/ 结果/ ./ 可以/ 看出/ ,/ 偏/ 并发/ 操作/ 之间/ 不能/ 直接/ 进行/ 转换/ ./ 定义/ 4/ ./ 等价/ 操作/ 集合/ ./ 从/ 同一/ 文档/ 状态/ 出发/ ,/ 执行/ 两个/ 不同/ 操作/ 集合/ 之后/ 得到/ 相同/ 的/ 状态/ ,/ 它们/ 被称作/ 等价/ 操作/ 集合/ ./ 在/ 接收/ 到/ 所有/ 操作/ 之后/ ,/ 尽管/ 每个/ 站点/ 执行/ 了/ 不同/ 的/ 操作/ 序列/ ,/ 但是/ 满足/ TP1/ 和/ TP2/ 条件/ 的/ 转换/ 函数/ 能够/ 保证/ 所有/ 站点/ 已/ 执行/ 的/ 操作/ 集是/ 等价/ 的/ ./ 另外/ ,/ 控制/ 过程/ 也/ 会/ 根据/ 已/ 执行/ 的/ 操作/ 构造/ 等价/ 的/ 操作/ 历史/ ./ 3.1/ 转换/ 函数/ OT/ 算法/ 需要/ 定义/ 元/ 操作/ 之间/ 的/ 互相/ 转换/ ,/ 称作/ 包含/ 转换/ 函数/ IT/ ./ 按照/ 已经/ 建立/ 的/ 符号/ ,/ 对于/ 任何/ 一个/ 操作/ o/ ,/ o/ ./ t/ 表示/ 操作/ 的/ 类型/ (/ 插入/ 、/ 删除/ )/ ,/ o/ ./ c/ 表示/ 操作/ 的/ 作用/ 字符/ ,/ o/ ./ p/ 表示/ 操作/ 的/ 位置/ ,/ o/ ./ id/ 表示/ 产生/ 该/ 操作/ 的/ 站点/ 标识/ ,/ o/ ./ num/ 表示/ 该/ 操作/ 是/ 站点/ 的/ 第/ num/ 个/ 操作/ ./ 操作/ 转换/ 只会/ 改变/ o/ ./ p/ 的/ 值/ ,/ 其他/ 属性/ 保持/ 不变/ ./ IT/ (/ o1/ ,/ o2/ )/ 要求/ o1/ 和/ o2/ 是/ 定义/ 在/ 相同/ 文档/ 状态/ 下/ 的/ 并发/ 操作/ ,/ 转换/ 之后/ C/ (/ o1/ )/ =/ C/ (/ o2/ )/ +/ [/ o2/ ]/ ./ 为了/ 处理/ 偏/ 并发/ 操作/ ,/ OT/ 算法/ 定义/ 了/ IT/ 的/ 逆/ 过程/ 排除/ 转换/ 函数/ ET/ ,/ 目的/ 是/ 将/ 在/ 不同/ 状态/ 下/ 产生/ 的/ 操作/ 转换/ 到/ 相同/ 状态/ 下/ ./ 函数/ 1/ 、/ 2/ 给出/ 了/ 常见/ 的/ 转换/ 函数/ 的/ 具体/ 定义/ ./ / 代表/ 空/ 操作/ ,/ 不/ 产生/ 任何/ 实际效果/ ./ 函数/ 1/ ./ IT/ (/ o1/ ,/ o2/ )/ :/ o1/ ./ 1/ ./ o12/ ./ IFo1/ ./ p/ >/ o2/ ./ p3/ ./ IFo2/ ./ t/ =/ ins4/ ./ o1/ ./ p/ ·/ ·/ =/ o1/ ./ p/ +/ 1/ ;/ 5/ ./ ELSE6/ ./ o1/ ./ p/ ·/ ·/ =/ o1/ ./ p/ -/ 1/ ;/ 7/ ./ ENDIF8/ ./ ELSIFo1/ ./ p/ =/ o2/ ./ p9/ ./ IFo1/ ./ t/ =/ o2/ ./ t/ =/ inso1/ ./ id/ >/ o2/ ./ id10/ ./ o1/ ./ p/ ·/ ·/ =/ o1/ ./ p/ +/ 1/ ;/ 11/ ./ ELSIFo1/ ./ t/ =/ delo2/ ./ t/ =/ ins12/ ./ o1/ ./ p/ ·/ ·/ =/ o1/ ./ p/ +/ 1/ ;/ 13/ ./ ELSIFo1/ ./ t/ =/ o2/ ./ t/ =/ del14/ ./ o115/ ./ ENDIF16/ ./ ENDIF17/ ./ RETURNo1/ ;/ 函数/ 2/ 给出/ 的/ ET/ 的/ 定义/ 并/ 没有/ 包括/ 所有/ 的/ 情况/ ./ 假如/ o1/ =/ ins/ (/ p/ +/ 1/ ,/ c/ )/ 、/ o2/ =/ ins/ (/ p/ ,/ c/ )/ 、/ o3/ =/ del/ (/ p/ )/ ,/ 那么/ IT/ (/ o1/ ,/ o3/ )/ =/ IT/ (/ o2/ ,/ o3/ )/ =/ ins/ (/ p/ ,/ c/ )/ ./ 可/ Page5/ 以/ 看出/ ,/ IT/ 不是/ 单射/ 函数/ ,/ 所以/ ET/ 并/ 不能/ 满足/ 可逆/ 的/ 要求/ ./ 这种/ 情况/ 下/ ,/ 只有/ 在/ 调用/ IT/ (/ o1/ ,/ o3/ )/ 之前/ 记录/ o1/ 的/ 位置/ 信息/ ,/ ET/ (/ o1/ ,/ o3/ )/ 时才/ 会/ 返回/ o1/ ./ 关于/ ET/ 和/ IT/ 的/ 可逆性/ 将/ 在/ 4.3/ 节/ 进行/ 详细/ 讨论/ ./ SWAP/ 函数/ 通过/ 先/ 调用/ ET/ (/ o1/ ,/ o2/ )/ 得到/ o1/ ,/ 再/ 调用/ IT/ (/ o2/ ,/ o1/ )/ 得到/ o2/ ,/ 实现/ 交换/ 操作/ 的/ 执行/ 顺序/ ,/ [/ o2o1/ ]/ =/ [/ o1o2/ ]/ ./ 函数/ 2/ ./ ET/ (/ o1/ ,/ o2/ )/ :/ o1/ ./ 1/ ./ o12/ ./ IFo1/ ./ p/ >/ o2/ ./ p3/ ./ IFo2/ ./ t/ =/ ins4/ ./ o1/ ./ p/ ·/ ·/ =/ o1/ ./ p/ -/ 1/ ;/ 5/ ./ ELSE6/ ./ o1/ ./ p/ ·/ ·/ =/ o1/ ./ p/ +/ 1/ ;/ 7/ ./ ENDIF8/ ./ ELSIFo1/ ./ p/ =/ o2/ ./ p9/ ./ IFo1/ ./ t/ =/ o2/ ./ t/ =/ del10/ ./ o1/ ./ p/ ·/ ·/ =/ o1/ ./ p/ +/ 1/ ;/ 11/ ./ ENDIF12/ ./ ENDIF13/ ./ RETURNo1/ ;/ 3.2/ 控制/ 过程/ 控制/ 过程/ 负责/ 调度/ 远程/ 操作/ 与/ 站点/ HB/ 中/ 的/ 操作/ 进行/ 转换/ ./ 如果/ 远程/ 操作/ o/ 的/ 因/ 操作/ 还/ 未/ 被/ 接收/ ,/ 则/ 将/ 该/ 操作/ 加入/ 到/ 等待/ 队列/ 中/ ,/ 直到/ 发生/ 在/ o/ 之前/ 的/ 所有/ 操作/ 都/ 已/ 接收/ ,/ o/ 才/ 会/ 被/ 控制/ 过程/ 集成/ 到/ HB/ 中/ ./ 只有/ 操作/ 上下文/ 相同/ 的/ 操作/ 才能/ 通过/ 操作/ 转换/ 获得/ 可/ 交换/ 执行/ ./ 因此/ ,/ 控制/ 过程/ 的/ 首要任务/ 是/ 寻找/ 远程/ 操作/ o/ 正确/ 的/ 操作/ 上下文/ 环境/ ./ 当/ 站点/ 调用/ 控制/ 过程/ 集成/ 操作/ o/ 时/ ,/ 显然/ 接收站/ 点/ 已经/ 将/ o/ 所有/ 的/ 因/ 操作/ 集成/ 到/ 了/ HB/ 中/ ./ 如果/ 能够/ 将/ o/ 的/ 因/ 操作/ 和/ 并发/ 操作/ 区分/ 开来/ ,/ 那么/ 因/ 操作/ 集合/ 就/ 等价/ 于/ C/ (/ o/ )/ ./ 然后/ ,/ 对/ 并发/ 操作/ 逐个/ 进行/ 包含/ 转换/ ,/ 将/ 操作/ 的/ 定义/ 状态/ 递增/ 到/ 当前/ 的/ 文档/ 状态/ ,/ 即可/ 获得/ 该/ 操作/ 在/ 远程/ 站点/ 的/ 执行/ 形式/ ./ 具体/ 而言/ ,/ 假如/ 两个/ 站点/ 的/ 操作/ 历史/ 如下/ :/ 站点/ 1/ ./ H1/ =/ [/ o1ao1bo1c/ ]/ ;/ 站点/ 2/ ./ H2/ =/ [/ o2ao1ao2bo1bo2c/ ]/ ,/ 站点/ 2/ 接收/ 到/ 操作/ o1c/ ./ C/ (/ o1c/ )/ =/ [/ o1ao1b/ ]/ ,/ 而/ C/ (/ o2a/ )/ =/ [/ ]/ ,/ 不能/ 直接/ 调用/ IT/ (/ o1c/ ,/ o2a/ )/ ./ 如果/ 站点/ 2/ 的/ H2/ =/ [/ o1ao1bo2ao2bo2c/ ]/ ,/ C/ (/ o1c/ )/ =/ C/ (/ o2a/ )/ ,/ o1c/ =/ IT/ (/ o1c/ ,/ o2a/ )/ 并且/ C/ (/ o1c/ )/ =/ C/ (/ o2b/ )/ ./ 依此类推/ ,/ o1c/ 对/ [/ o2ao2bo2c/ ]/ 转换/ 之后/ 等同于/ 当前/ 文档/ 状态/ 下/ 产生/ 的/ 操作/ ./ 关键/ 的/ 步骤/ 在于/ 构造/ H2/ 的/ 等价/ 操作/ 集合/ H2/ ./ Suleiman/ 等/ 人/ [/ 25/ ]/ 设计/ 了/ Separate/ 函数/ ,/ 负责/ 把/ HB/ 重/ 构成/ 因/ 操作/ 在/ 前/ 并发/ 操作/ 在/ 后/ ./ 具体做法/ :/ 从左到右/ 扫描/ 站点/ 操作/ 历史/ H/ 并用/ l/ 记录/ 当前/ 访问/ 的/ 最后/ 一个/ 因/ 操作/ 在/ H/ 中/ 的/ 位置/ ,/ 如果/ H/ [/ i/ ]/ 是/ 操作/ o/ 的/ 因/ 操作/ ,/ 则/ 将/ 操作/ H/ [/ i/ ]/ 交换/ 到/ H/ [/ l/ +/ 1/ ]/ 所在/ 的/ 位置/ ;/ 如果/ H/ [/ i/ ]/ 是/ o/ 的/ 并发/ 操作/ ,/ 则/ 跳/ 过/ 当前/ 位置/ ;/ 遍历/ 结束/ 之后/ ,/ H/ [/ 0/ :/ l/ ]/ 即/ 为/ 操作/ o/ 的/ 因/ 操作/ ./ ITSQ/ 函数/ 是/ 对/ 单个/ 操作/ 转换/ 的/ 封装/ ,/ 表示/ 操作/ o/ 对/ 操作/ 序列/ sq/ 进行/ 包含/ 转换/ ./ 图/ 3/ 描述/ 了/ Suleiman/ 等/ 人/ 的/ HB/ 结构/ ./ 函数/ 3/ ./ Separate/ (/ H/ ,/ o/ )/ :/ l/ ./ 1/ ./ l/ ·/ ·/ =/ -/ 1/ ;/ 2/ ./ FORi/ ·/ ·/ =/ 0upto/ |/ H/ |/ -/ 1/ // // |/ H/ |/ 表示/ H/ 中/ 操作/ 的/ 3/ ./ oi4/ ./ IF/ 犛/ 犞/ o5/ ./ FORj/ ·/ ·/ =/ idowntol/ +/ 2do6/ ./ SWAP/ (/ H/ [/ j/ ]/ ,/ H/ [/ j/ -/ 1/ ]/ )/ ;/ 7/ ./ ENDFOR/ ;/ 8/ ./ l/ ·/ ·/ =/ l/ +/ 1/ ;/ 9/ ./ ENDIF/ ;/ 10/ ./ ENDFOR/ ;/ 11/ ./ RETURNl/ ;/ 从/ 以上/ 的/ 分析/ 可以/ 看出/ ,/ OT/ 算法/ 集成/ 远程/ 操作/ 的/ 性能/ 瓶颈/ 在于/ Separate/ 函数/ ,/ 找出/ 远程/ 操作/ 的/ 并发/ 操作/ 集/ Hc/ 需要/ 耗费/ O/ (/ |/ H/ |/ 2/ )/ 的/ 计算/ 时间/ ./ 函数/ 4/ ./ ITSQ/ (/ o/ ,/ sq/ )/ :/ o/ ./ 1/ ./ o/ ·/ ·/ =/ o/ ;/ 2/ ./ FORi/ ·/ ·/ =/ 0upto/ |/ sq/ |/ -/ 13/ ./ o/ ·/ ·/ =/ IT/ (/ o/ ,/ sq/ [/ i/ ]/ )/ ;/ 4/ ./ IFo/ =/ / // // 如果/ o/ 是/ 空/ 操作/ / 5/ ./ BREAK/ ;/ 6/ ./ ENDIF/ ;/ 7/ ./ ENDFOR/ ;/ 8/ ./ RETURNo/ ;/ Page63/ ./ 3/ 一致性/ 模型/ 协同/ 编辑/ 系统/ 的/ 一致性/ 模型/ 定义/ 为/ 下面/ 的/ 3/ 个/ 条件/ :/ (/ 1/ )/ 因果/ 保持/ ./ 如果/ o1/ →/ o2/ ,/ 则/ 在/ 所有/ 站点/ o1/ 都/ 在/ o2/ 之前/ 执行/ ./ (/ 2/ )/ 结果/ 一致/ ./ 当/ 产生/ 的/ 所有/ 操作/ 在/ 每个/ 站点/ 执行/ 之后/ ,/ 所有/ 的/ 站点/ 得到/ 相同/ 的/ 结果/ ./ (/ 3/ )/ 意图/ 保持/ [/ 28/ ]/ ./ 对于/ 任何/ 一个/ 操作/ o/ ,/ 在/ 远程/ 站点/ 执行/ 的/ 效果/ 与/ 该/ 操作/ 在/ 本地/ 站点/ 执行/ 的/ 效果/ 相同/ ,/ 且/ o/ 的/ 执行/ 不/ 改变/ 并发/ 操作/ 的/ 效果/ ./ 意图/ 保持/ 能够/ 尽量/ 保证/ 最终/ 的/ 结果/ 符合/ 用户/ 的/ 意愿/ ./ 由于/ Sun/ 等/ 人/ [/ 28/ ]/ 的/ 意图/ 定义/ 比较/ 模糊/ ,/ Li/ 等/ 人/ [/ 29/ ]/ 将/ 操作/ 的/ 意图/ 定义/ 成/ 操作/ 作用/ 对象/ 之间/ 的/ 位置/ 关系/ ./ 假如/ 从/ 全局/ 观察/ 所有/ 站点/ 执行/ 的/ 操作/ ,/ 作用/ 对象/ 之间/ 形成/ 了/ 全序/ 的/ 位置/ 关系/ ,/ 遵循/ 这种/ 关系/ 的/ 操作/ 也/ 就/ 意味着/ 操作/ 意图/ 的/ 保持/ ./ 图/ 4/ 描述/ 了/ 3/ 个/ 站点/ 的/ 协同/ 过程/ ./ 在/ 图/ 4/ (/ b/ )/ ~/ (/ e/ )/ 中/ ,/ 有/ 向/ 边/ 的/ 起点/ 所/ 代表/ 的/ 字符/ 在/ 前/ ,/ 终点/ 代表/ 的/ 字符/ 在/ 后/ ./ 图/ 4/ (/ a/ )/ 中/ ,/ 初始/ 位置/ 关系/ 就是/ 初始/ 文档/ 中/ 字符/ 的/ 先后/ 关系/ ,/ 所有/ 站点/ 都/ 是/ 一致/ 的/ ./ 在/ 各个/ 站点/ 的/ 本地/ 操作/ 执行/ 之后/ ,/ y/ 和/ x/ 之间/ 的/ 位置/ 关系/ 就/ 确定/ 了/ ./ 随着/ 远程/ 操作/ 的/ 执行/ ,/ 之前/ 建立/ 的/ 位置/ 关系/ 可能/ 被/ 破坏/ ./ 根据/ 图/ 4/ (/ c/ )/ 能够/ 推导/ 出/ y/ 在/ x/ 前面/ ,/ 而图/ 4/ (/ d/ )/ 中/ 加入/ 远程/ 操作/ 之后/ ,/ x/ 到/ y/ 有/ 了/ 通路/ ,/ 在/ 图/ 中/ 形成/ 了/ 环路/ ,/ 违背/ 了/ 已/ 建立/ 的/ 位置/ 关系/ ./ 图/ 4/ (/ e/ )/ 给出/ 了/ 意图/ 保持/ 的/ 正确/ 结果/ ./ 如果/ 随机/ 定义/ 图/ 4/ (/ a/ )/ 中/ 3/ 个/ 操作/ 之间/ 的/ 全局/ 顺序/ ,/ 所有/ 站点/ 都/ 能/ 得到/ 一致/ 的/ 结果/ ./ 不同/ 的/ 顺序/ 将/ 产生/ 不同/ 的/ 结果/ axyc/ 或者/ ayxc/ ./ 然而/ Sun/ 等/ 人/ 认为/ 在/ 结果/ 一致/ 的/ 前提/ 下/ ,/ 两种/ 结果/ 都/ 能/ 保持/ 意图/ ./ 4MOOT/ 算法/ 协同/ 编辑/ 环境/ 中/ 存在/ 大量/ 的/ 无效/ 操作/ ,/ 即/ 插入/ 某个/ 对象/ 之后/ ,/ 这个/ 对象/ 又/ 被/ 随后/ 的/ 操作/ 删除/ ./ 这样/ 的/ 一对/ 插入/ 删除/ 操作/ 不会/ 改变/ 文档/ 状态/ ,/ 合并/ 的/ 效果/ 等同于/ 空/ 操作/ ./ 如果/ 移除/ HB/ 中/ 的/ 无效/ 操作/ ,/ 能够/ 减少/ 操作/ 历史/ 中/ 的/ 操作/ 数目/ ,/ 从而/ 减少/ 在/ 集成/ 远程/ 操作/ 时所/ 耗费/ 的/ 计算/ 时间/ ./ ABT/ 算法/ 构造/ 了/ 特殊/ 的/ 操作/ 历史/ 结构/ ,/ 获得/ 了/ 更/ 高/ 的/ 计算/ 效率/ ./ 然而/ 站点/ HB/ 的/ 等价/ 操作/ 集合/ 并非/ 是/ 唯一/ 的/ ,/ 与/ ABT/ 相比/ ,/ MOOT/ 算法/ 提出/ 了/ 一种/ 更优/ 的/ HB/ 结构/ ./ 4.1/ HB/ 排列/ 结构/ 在/ 没有/ 使用/ 全序/ 的/ OT/ 算法/ 中/ ,/ 操作/ 历史/ 中/ 的/ 操作/ 按照/ 站点/ 的/ 执行/ 顺序排列/ ./ 在/ 集成/ 远程/ 操作/ 时/ ,/ 首先/ 调用/ Separate/ 函数/ 划分/ 出/ 并发/ 操作/ 集/ Hc/ ,/ 然后/ 调用/ ITSQ/ 函数/ 对/ Hc/ 进行/ 包含/ 转换/ ,/ 总共/ 花费/ 计算/ 时间/ O/ (/ |/ H/ |/ 2/ +/ |/ Hc/ |/ )/ ./ 非/ 全序/ OT/ 算法/ 的/ HB/ 中/ 的/ 操作/ 是/ 按照/ 操作/ 的/ 全序/ 顺序排列/ 的/ ./ 由于/ 并发/ 操作/ 之间/ 并/ 没有/ 自然/ 的/ 先后/ 关系/ ,/ 所以/ 全序/ 的/ 定义/ 依赖于/ 人工干预/ ,/ 并且/ 需要/ 兼容/ 因果关系/ ./ 站点/ 可以/ 按照/ 全局/ 顺序/ 接收/ 操作/ ,/ 而/ 这种/ 方式/ 容易/ 造成/ 比较/ 大/ 的/ 延时/ ./ 站点/ 也/ 可以/ 按照/ 因果/ 顺序/ 接收/ ,/ 如果/ 违背/ 了/ 全局/ 顺序/ 则/ 利用/ Undo/ // Do/ // Redo/ 的/ 模式/ 维护/ 全序/ 的/ HB/ 结构/ ,/ 这种/ 方法/ 需要/ 大量/ 的/ 重复/ 计算/ ,/ 效率/ 非常低/ ./ ABT/ 算法/ 提出/ 了/ 一种/ 特殊/ 的/ 排列/ 结构/ ,/ 即/ 插入/ 操作/ 在/ 前/ 删除/ 操作/ 在/ 后/ ,/ 记/ H/ =/ Hi/ ·/ Hd/ ./ 为了/ 讨论/ 方便/ ,/ 将/ 这种/ 排列/ 结构/ 称作/ IDHB/ ./ 在/ 集成/ 本地/ 操作/ 时/ ,/ 产生/ 的/ 操作/ o/ 被/ 立即/ 执行/ ./ 然后/ ,/ 调用/ ET/ 排除/ 删除/ 操作/ 的/ 影响/ 得到/ o/ ,/ 并/ 广播/ o/ 到/ 其他/ 远程/ 站点/ ./ 同时/ ,/ 为了/ 继续/ 维护/ IDHB/ 这种/ 结构/ ,/ 如果/ o/ 是/ 插入/ 操作/ ,/ 则/ 将/ o/ 添加/ 到/ Hi/ 中/ ;/ 如果/ o/ 是/ 删除/ 操作/ ,/ 则/ 将/ o/ 添加/ 到/ Hd/ 中/ ./ 在/ 集成/ 远程/ 操作/ o/ 时/ ,/ 首先/ 调用/ Separate/ (/ o/ ,/ Hi/ )/ 将/ 插入/ 操作/ 集/ Hi/ 划分/ 成因/ 操作/ 集/ Hih/ 和/ 并发/ 操作/ 集/ Hic/ ./ 操作/ o/ 对/ Hic/ 进行/ 包含/ 转换/ 得到/ o/ ,/ 再/ 对/ Hd/ 进行/ 包含/ 转换/ 得到/ o/ ,/ o/ 就是/ 远程/ 操作/ 在/ 本/ 站点/ 的/ 执行/ 形式/ ./ 当/ o/ 是/ 删除/ 操作/ 时/ ,/ 将/ o/ 添加/ 到/ Hd/ 中/ ,/ 时间/ 复杂度/ 为/ O/ (/ |/ Hi/ |/ 2/ +/ |/ Hic/ |/ +/ |/ Hd/ |/ )/ ;/ 当/ o/ 是/ 插入/ 操作/ 时/ ,/ 将/ o/ 与/ Hd/ 中/ 的/ 每个/ 操作/ 进行/ 交换/ ,/ 最终/ 将/ o/ 添加/ 到/ Hi/ 中/ ,/ 耗费/ 计算/ 时间/ O/ (/ |/ Hi/ |/ 2/ +/ |/ Hic/ |/ +/ 2/ |/ Hd/ |/ )/ ./ 可以/ 看出/ ABT/ 算法/ 在/ 集成/ 远程/ 操作/ 的/ 计算/ 时间/ 主要/ 取决于/ 插入/ 操作/ 集/ 的/ 大小/ ./ Page7/ 在/ 编辑文档/ 时/ ,/ 插入/ 操作/ 的/ 数量/ 明显/ 多于/ 删除/ 操作/ 的/ 数量/ ./ 因此/ ,/ MOOT/ 算法/ 构造/ 了/ 删除/ 操作/ 在/ 前/ 、/ 插入/ 操作/ 在/ 后/ 的/ DIHB/ (/ Delete/ -/ InsertHB/ )/ 结构/ ,/ 使得/ 算法/ 集成/ 远程/ 操作/ 的/ 计算/ 时间/ 取决于/ 较/ 小/ 的/ 操作/ 集/ ./ 4.2/ 意图/ 保持/ 尽管/ HB/ 可以/ 重/ 构成/ 任何/ 等价/ 操作/ 集合/ ,/ 但/ 并/ 不是/ 所有/ 的/ 结构/ 都/ 能/ 遵循/ 一致性/ 模型/ ./ 2014/ 年/ Sun/ 等/ 人/ [/ 40/ ]/ 穷举/ 了/ 造成/ OT/ 算法/ 不能/ 满足/ 意图/ 保持/ 的/ puzzle/ ,/ 得出/ 的/ 结论/ 是/ 所有/ 的/ puzzle/ 都/ 源自/ 于/ 一组/ 特殊/ 的/ 操作/ 位置/ 关系/ (/ o1/ =/ ins/ (/ p/ +/ 1/ ,/ c1/ )/ 、/ o2/ =/ del/ (/ p/ )/ 、/ o3/ =/ ins/ (/ p/ ,/ c2/ )/ 并且/ o1/ ‖/ o2/ ‖/ o3/ )/ ./ 因此/ ,/ 有/ 必要/ 分析/ 在/ 这种/ 特殊/ 情况/ 下/ ,/ DIHB/ 能否/ 实现/ 意图/ 保持/ ./ 图/ 5/ 描述/ 了/ 在/ 这种/ 特殊/ 的/ 场景/ 下/ ,/ DIHB/ 维护/ 数据/ 一致性/ 的/ 过程/ ./ 假设/ 在/ 同一个/ 位置/ 插入/ 字符/ ,/ 站点/ 优先级/ 小/ 的/ 操作/ 位置/ p/ 保持/ 不变/ ,/ 优先级/ 大/ 的/ 操作/ 位置/ p/ 加/ 1/ (/ site1/ </ site3/ )/ ./ 图/ 5/ 中/ ,/ 站点/ 1/ 和/ 站点/ 2/ 的/ 操作/ 历史/ 都/ 是/ 相同/ ,/ 最终/ 的/ 结果/ 也/ 是/ 相同/ 的/ ,/ 即/ 满足/ 了/ Sun/ 等/ 人/ 提出/ 的/ 意图/ 保持/ 条件/ ,/ 但/ 不/ 符合/ Li/ 等/ 人/ 提出/ 的/ 操作/ 位置/ 关系/ 的/ 保持/ ./ 按照/ 作用/ 关系/ 图/ ,/ 可以/ 判断/ y/ 在/ x/ 前面/ ./ 在/ 站点/ 2/ ,/ 由于/ 删除/ 操作/ 会/ 对/ 插入/ 操作/ 的/ 位置/ 造成/ 影响/ ,/ 导致/ 原本/ 不/ 在/ 相同/ 位置/ 的/ 插入/ 操作/ 需要/ 在/ 同一个/ 位置/ 进行/ 比较/ ,/ 经过/ 站点/ 优先级/ 比较/ 之后/ ,/ x/ 出现/ 在/ 了/ y/ 的/ 前面/ ,/ 形成/ 了/ 环路/ ./ 因此/ ,/ 要/ 想/ 保持/ 插入/ 对象/ 之间/ 的/ 位置/ 关系/ ,/ 插入/ 操作/ 需要/ 保存/ 在/ 位置/ p/ 之前/ 所/ 执行/ 的/ 删除/ 操作/ 的/ 信息/ ./ 利用/ Randolph/ 等/ 人/ [/ 19/ ]/ 提出/ 的/ 满足/ TP1/ 和/ TP2/ 条件/ 的/ 包含/ 转换/ 函数/ ,/ 可以/ 实现/ Li/ 等/ 人/ 提出/ 的/ 意图/ 保持/ 标准/ ./ 插入/ 操作/ 添加/ 属性/ nd/ (/ numberofdeletedoperations/ )/ ,/ 记录/ 在/ 位置/ p/ 之前/ 执行/ 的/ 删除/ 操作/ 的/ 数目/ ,/ 相当于/ 保持/ 了/ 插入/ 操作/ 之间/ 的/ 位置/ 关系/ ./ 如果/ 两个/ 相同/ 位置/ 的/ 插入/ 操作/ 进行/ 转换/ ,/ 首先/ 比较/ nd/ 的/ 大小/ ,/ nd/ 大/ 的/ 操作/ 位置/ 加/ 1/ 而/ nd/ 小/ 的/ 操作/ 位置/ 不变/ ,/ 其次/ 再/ 比较/ 站点/ 优先级/ ./ 该/ 方法/ 在/ TTF/ [/ 31/ ]/ 算法/ 中/ 已经/ 证明/ 能够/ 保持/ 作用/ 对象/ 之间/ 的/ 位置/ 关系/ ./ 在/ 转换/ 过程/ 中/ ,/ nd/ 也/ 会/ 根据/ 删除/ 操作/ 而/ 变化/ ./ 给定/ 操作/ o1/ =/ ins/ (/ p/ ,/ c/ ,/ nd/ ,/ id/ )/ 和/ o2/ =/ del/ (/ p/ )/ ,/ 如果/ o1/ ./ p/ >/ o2/ ./ p/ ,/ 则/ o1/ =/ IT/ (/ o1/ ,/ o2/ )/ 并且/ o1/ ./ nd/ 加/ 1/ ./ 在/ 图/ 6/ 中/ ,/ 由于/ nd/ 属性/ 的/ 引入/ ,/ DIHB/ 结构/ 能够/ 保持/ 作用/ 对象/ 之间/ 的/ 位置/ 关系/ ./ 在/ 站点/ 2/ ,/ 站点/ 1/ 的/ 操作/ ins/ (/ 2/ ,/ x/ ,/ 0/ )/ 和/ 站点/ 3/ 的/ 操作/ ins/ (/ 1/ ,/ y/ ,/ 0/ )/ 对/ del/ (/ 1/ )/ 进行/ 转/ 包含/ 转换/ 之后/ 都/ 变成/ 了/ 在/ 位置/ p/ =/ 1/ 上/ 的/ 操作/ ,/ 通过/ 比较/ nd/ ,/ 可以/ 判断/ 出/ y/ 应该/ 在/ x/ 前面/ ,/ 站点/ 3/ 的/ 操作/ 在/ 站点/ 2/ 按照/ 原始/ 形式/ 执行/ ./ 4.3/ ET/ 和/ IT/ 的/ 可逆性/ 重构/ 等价/ 操作/ 历史/ 依赖/ 操作/ 的/ 可/ 交换/ 性/ ./ 根据/ 3.1/ 节/ 的/ 描述/ ,/ 当/ o1/ ./ t/ =/ ins/ 、/ o2/ ./ t/ =/ del/ 且/ o1/ ‖/ o2/ 时/ ,/ IT/ (/ o1/ ,/ o2/ )/ 不是/ 可逆/ 的/ ./ 然而/ ,/ MOOT/ 算法/ 并/ 不会/ 在/ 这种/ 情况/ 下/ 调用/ ET/ (/ o1/ ,/ o2/ )/ ./ 维护/ DIHB/ 结构/ 不/ 需要/ 交换/ 插入/ 操作/ 到/ 删除/ 操作/ 的/ 前面/ ,/ 因此/ 并发/ 操作/ 之间/ 具有/ 可/ 交换/ 性/ ./ 当/ o1/ 和/ o2/ 是/ 因果关系/ 的/ 时候/ ,/ ET/ 也/ 不/ 一定/ 是/ 可逆/ 的/ ./ 例如/ ,/ 来自/ 同一个/ 站点/ 的/ 两个/ 操作/ o1/ =/ ins/ (/ 1/ ,/ a/ )/ 、/ o2/ =/ ins/ (/ 2/ ,/ b/ )/ ,/ o2/ =/ ET/ (/ o2/ ,/ o1/ )/ =/ ins/ (/ 1/ ,/ b/ )/ ,/ 再/ 调用/ IT/ (/ o2/ ,/ o1/ )/ =/ ins/ (/ 1/ ,/ b/ )/ ≠/ o2/ ./ 根据/ 总结/ ,/ 只有/ 当/ 同时/ 出现/ 以下/ 情况/ 时/ ,/ (/ 1/ )/ o1/ ./ t/ =/ o2/ ./ t/ =/ ins/ ;/ (/ 2/ )/ o1/ →/ o2/ ;/ (/ 3/ )/ o2/ ./ p/ =/ o1/ ./ p/ ‖/ o2/ ./ p/ =/ o1/ ./ p/ +/ 1/ ;/ ET/ (/ o2/ ,/ o1/ )/ 不是/ 可逆/ 的/ ,/ 记/ ET/ 返回/ false/ ./ MOOT/ 算法/ 不会/ 向前/ 交换/ HB/ 中/ 两个/ 插入/ 操作/ 的/ 位置/ ,/ 因此/ 除去/ 上述情况/ 的/ 因果/ 操作/ 之间/ 也/ 具有/ 可/ 交换/ 性/ ./ Page8/ 从/ 上面/ 的/ 分析/ 可以/ 看出/ ,/ 当/ HB/ 中/ 两个/ 相邻/ 的/ 插入/ 操作/ 具有/ 特殊/ 位置/ 关系/ 时/ ,/ ET/ 不是/ 可逆/ 的/ ./ 文献/ [/ 41/ ]/ 指出/ 这种/ 关系/ 在/ 远程/ 站点/ 依然/ 成立/ ./ 如果/ 已知/ 操作/ 位置/ 的/ 间距/ ,/ 很/ 容易/ 根据/ 其中/ 一个/ 操作/ 推导/ 出/ 另外/ 一个/ 操作/ ./ 例如/ ,/ 已知/ ET/ (/ o1/ ,/ o2/ )/ =/ false/ 并且/ o1/ ./ p/ -/ o2/ ./ p/ =/ 0/ ,/ 那么/ o1/ 在/ 远程/ 站点/ 的/ HB/ 也/ 位于/ o2/ 之后/ ,/ 并且/ o1/ ./ p/ =/ o2/ ./ p/ ./ 4.4/ 压缩/ 策略/ DIHB/ 结构/ 能够/ 方便/ 地/ 识别/ 出/ 无效/ 操作/ 对/ ./ 在/ 重构/ HB/ 的/ 过程/ 中/ ,/ 需要/ 将/ 删除/ 操作/ 交换/ 到/ 插入/ 操作/ 的/ 前面/ ./ 如果/ 操作/ o1/ 删除/ 的/ 对象/ 就是/ 另外/ 一个/ 操作/ o2/ 插入/ 的/ 对象/ 时/ ,/ 那么/ 操作/ o1/ 依赖于/ o2/ 的/ 存在/ ,/ 无法/ 将/ o1/ 交换/ 到/ o2/ 之前/ 执行/ ./ 在/ 图/ 7/ 中/ ,/ 当/ 调用/ SWAP/ 交换/ del/ (/ 1/ )/ 和/ ins/ (/ 1/ ,/ a/ ,/ 0/ )/ 时/ 返回/ false/ ,/ 可以/ 判断/ 出/ 两个/ 操作/ 是/ 无效/ 操作/ ./ HB/ 中/ 不/ 需要/ 保存/ 无效/ 的/ 操作/ ,/ 移除/ 它们/ 不/ 影响/ 其他/ 操作/ ./ 在/ 本地/ 站点/ ,/ 如果/ 产生/ 的/ 删除/ 操作/ o1/ 不能/ 与/ HB/ 中/ 的/ 插入/ 操作/ o2/ 交换/ ,/ 则/ 从/ HB/ 中/ 移除/ o2/ 并/ 更新/ 与/ o1/ 已/ 交换/ 位置/ 的/ 操作/ 的/ nd/ 属性/ ./ 同时/ ,/ 将/ o1/ 作为/ o2/ 的/ undo/ 操作/ 广播/ 到/ 其他/ 站点/ ./ 当/ 远程/ 站点/ 接收/ 到/ undo/ (/ o2/ )/ 时/ ,/ 首先/ ,/ 在/ HB/ 的/ 第/ k/ 个/ 位置/ 取出/ 该/ 操作/ ;/ 然后/ ,/ 将/ o2/ 与/ k/ +/ 1/ 到/ n/ 位置/ 上/ 的/ 操作/ 逐一/ 交换/ 位置/ 得到/ o2/ ,/ o2/ 的/ 逆/ 操作/ 即为/ o1/ 的/ 执行/ 形式/ ;/ 同时/ 将/ o2/ 从/ HB/ 中/ 删除/ ./ 每个/ 操作/ 都/ 由/ 站点/ id/ 以及/ 逻辑/ 时钟/ num/ 组成/ 的/ 二元/ 组/ 唯一/ 确定/ ,/ 访问/ HB/ 中/ 的/ 任何/ 一个/ 操作/ 是/ 很/ 方便/ 的/ ./ 从/ 上面/ 的/ 过程/ 可以/ 看出/ 集成/ undo/ 操作/ 的/ 时间/ 复杂度/ 是/ 线性/ 的/ ./ 4.5/ Undo/ 扩展/ 作为/ 错误/ 恢复/ 的/ 重要/ 机制/ ,/ 实时/ 协同/ 编辑/ 系统/ 需要/ 支持/ anyundo/ (/ undoanyoperationsatanytime/ )/ [/ 23/ ,/ 42/ ]/ ./ 由于/ MOOT/ 提出/ 的/ 压缩/ 机制/ ,/ HB/ 中/ 的/ 某些/ 操作/ 会/ 被/ 删除/ ,/ 造成/ undo/ 目标/ 操作/ 的/ 丢失/ ./ 为了/ 能够/ 支持/ undo/ 功能/ ,/ 本文/ 给出/ 一种/ 可行/ 的/ 处理/ 方法/ ,/ 即/ 在/ 每个/ 协同/ 站点/ 额外/ 维护/ 完整/ 的/ HB/ (/ FullHB/ ,/ FHB/ )/ 以及/ 压缩/ 过/ 的/ HB/ (/ CompressedHB/ ,/ CHB/ )/ ./ MOOT/ 的/ 压缩/ 策略/ 并非/ 是/ 发出/ 真正/ 的/ undo/ 命令/ ,/ 而是/ 对/ 撤销/ 操作/ 的/ 模拟/ ./ 为了/ 能够/ 区别/ undo/ 操作/ ,/ 可以/ 设置/ 其他/ 的/ 标志/ 来/ 表示/ 删除/ 操作/ 抵消/ 插入/ 操作/ 的/ 请求/ ./ 利用/ 已有/ 的/ undo/ 算法/ 和/ FHB/ 计算/ undo/ // redo/ 操作/ 的/ 执行/ 形式/ o/ ,/ 将/ o/ 加入/ 到/ FHB/ ./ 而/ CHB/ 则/ 用于/ 计算/ 普通/ 操作/ o/ 的/ 执行/ 形式/ ./ 由/ 前面/ 的/ 叙述/ 可知/ ,/ FHB/ 和/ CHB/ 是/ 等价/ 操作/ 集合/ ./ 4.6/ 算法/ 描述/ 每个/ 站点/ 不仅/ 会/ 产生/ 操作/ 也/ 会/ 接收/ 其他/ 站点/ 的/ 操作/ ./ 每个/ 站点/ 需要/ 维护/ 接收/ 队列/ R/ 和/ 状态/ 向量/ 犛/ 犞/ ./ 本地/ 站点/ i/ 产生/ 的/ 操作/ o/ 会/ 被/ 立即/ 执行/ ,/ 然后/ 调用函数/ IntegrateLocal/ 将/ HB/ 重/ 构成/ DIHB/ ,/ 犛/ 犞/ [/ i/ ]/ =/ 犛/ 犞/ [/ i/ ]/ +/ 1/ ,/ 并/ 广播/ 请求/ r/ ./ 算法/ 1/ 排除/ 插入/ 操作/ Hi/ 对/ 操作/ o/ 的/ 影响/ 得到/ o/ ./ 根据/ 前面/ 的/ 叙述/ ,/ 不是/ 所有/ 的/ 操作/ 都/ 能/ 交换/ 执行/ 顺序/ ./ 如果/ SWAP/ (/ o/ ,/ ox/ )/ =/ false/ ,/ 其中/ ox/ ∈/ Hi/ ,/ r/ 表示/ 成/ 六元/ 组/ 〈/ o/ ./ id/ ,/ o/ ./ num/ ,/ flag/ ,/ ox/ ./ id/ ,/ ox/ ./ num/ ,/ o/ ./ c/ 〉/ ,/ 当/ o/ ./ t/ =/ ox/ ./ t/ =/ ins/ 时/ ,/ flag/ =/ (/ o/ ./ p/ -/ ox/ ./ p/ )/ 表示/ o/ 和/ ox/ 的/ 位置/ 关系/ ;/ 当/ o/ ./ t/ =/ del/ 并且/ ox/ ./ t/ =/ ins/ 时/ ,/ flag/ =/ undo/ 表示/ o/ 作为/ ox/ 的/ undo/ 操作/ ./ 如果/ SWAP/ (/ o/ ,/ ox/ )/ =/ true/ ,/ 其中/ ox/ ∈/ Hi/ ,/ r/ 表示/ 成/ 四元组/ 〈/ o/ ./ id/ ,/ o/ ./ num/ ,/ flag/ ,/ o/ 〉/ ./ 算法/ 1/ ./ IntegrateLocal/ ./ 输入/ :/ 站点/ 产生/ 的/ 操作/ o/ 输出/ :/ 广播/ 到/ 其他/ 站点/ 的/ 请求/ r1/ ./ o/ ·/ ·/ =/ o/ ;/ 2/ ./ Fork/ ·/ ·/ =/ |/ Hi/ |/ -/ 1downto03/ ./ [/ o/ ,/ isValid/ ]/ ·/ ·/ =/ ET/ (/ o/ ,/ Hi/ [/ k/ ]/ )/ ;/ 4/ ./ IFisValid/ =/ false5/ ./ r/ ·/ ·/ =/ 〈/ id/ ,/ num/ ,/ 0/ // 1/ // undo/ ,/ Hi/ [/ k/ ]/ ./ id/ ,/ 6/ ./ RETURNr/ ;/ 7/ ./ ELSE8/ ./ IFo/ ./ t/ =/ del9/ ./ IT/ (/ Hi/ [/ k/ ]/ ,/ o/ )/ ;/ 10/ ./ ENDIF11/ ./ ENDIF12/ ./ ENDFOR13/ ./ r/ ·/ ·/ =/ 〈/ id/ ,/ num/ ,/ null/ ,/ o/ 〉/ ;/ 14/ ./ IFo/ ./ t/ =/ ins15/ ./ Hi/ ./ add/ (/ o/ )/ ;/ 16/ ./ ELSE17/ ./ Hd/ ./ add/ (/ o/ )/ ;/ 18/ ./ ENDIF19/ ./ RETURNr/ ;/ Page9/ 站点/ j/ 接收/ 到/ 站点/ i/ 的/ 请求/ 时/ ,/ 首先/ 判断/ 是否/ 满足/ 因果/ 接收/ 条件/ ./ 如果/ 犛/ 犞/ j/ [/ i/ ]/ =/ r/ [/ 2/ ]/ -/ 1/ ,/ 则/ 调用/ IntegrateRemote/ 函数/ ;/ 否则/ ,/ 加入/ 接收/ 请求/ 队列/ R/ ./ 站点/ 调用/ 线程/ 周期性/ 的/ 访问/ R/ ,/ 寻找/ 满足条件/ 的/ 请求/ 并/ 处理/ ./ 在/ 集成/ 远程/ 操作/ 时/ ,/ 根据/ 请求/ r/ 推导/ 出待/ 集成/ 的/ 操作/ o/ ,/ 经过/ 转换/ 得到/ 的/ o/ 就是/ 远程/ 操作/ 在/ 本/ 站点/ 的/ 执行/ 形式/ ./ 如果/ r/ ./ flag/ =/ undo/ ,/ 则/ 根据/ 4.4/ 节/ 描述/ 的/ 过程/ 进行/ 计算/ ;/ 如果/ r/ ./ flag/ =/ 0/ // 1/ ,/ 则/ 在/ HB/ 中/ 的/ 第/ k/ 个/ 位置/ 取出/ 〈/ id/ =/ r/ [/ 4/ ]/ ,/ num/ =/ r/ [/ 5/ ]/ 〉/ 的/ 操作/ ox/ ,/ o/ ./ p/ =/ ox/ ./ p/ +/ 0/ // 1/ ,/ 将/ o/ 与/ k/ +/ 1/ 到/ n/ 位置/ 上/ 的/ 所有/ 操作/ 进行/ 包含/ 转换/ 得到/ o/ ,/ 执行/ o/ ;/ 如果/ flag/ =/ null/ ,/ 则/ 首先/ 调用/ Separate/ (/ o/ ,/ Hd/ )/ 将/ 删除/ 操作/ 集/ Hd/ 转换/ 成因/ 操作/ 集/ Hdh/ 和/ 并发/ 操作/ 集/ Hdc/ ./ 然后/ ,/ 对/ Hdc/ 进行/ 包含/ 转换/ 得到/ o/ ,/ 再/ 对/ Hi/ 进行/ 包含/ 转换/ 得到/ o/ ./ 当/ o/ 是/ 插入/ 操作/ 时/ ,/ 将/ o/ 添加/ 到/ Hi/ 中/ ;/ 当/ o/ 是/ 删除/ 操作/ 时/ ,/ 将/ o/ 对/ 插入/ 操作/ 集/ Hi/ 进行/ 对称/ 包含/ 转换/ ,/ 最终/ 将/ o/ 添加/ 到/ Hd/ 中/ ./ 算法/ 2/ ./ IntegrateRemote/ ./ 输入/ :/ 接收/ 的/ 请求/ r/ 输出/ :/ 远程/ 操作/ o/ 的/ 执行/ 形式/ o1/ ./ IFr/ ./ flag/ =/ undoTHEN2/ ./ o/ ·/ ·/ =/ Hi/ [/ k/ ]/ ;/ // // Hi/ [/ k/ ]/ ./ 〈/ id/ ,/ num/ 〉/ =/ 〈/ r/ [/ 4/ ]/ ,/ r/ [/ 5/ ]/ 〉/ 3/ ./ o/ ·/ ·/ =/ SWAP/ (/ o/ ,/ Hi/ [/ k/ +/ 1/ :/ |/ Hi/ |/ -/ 1/ ]/ )/ ;/ 4/ ./ o/ ·/ ·/ =/ inverse/ (/ o/ )/ ;/ Hi/ ./ delete/ (/ o/ )/ ;/ 5/ ./ ELSEIFr/ ./ flag/ =/ 0/ // 16/ ./ o/ ·/ ·/ =/ Hi/ [/ k/ ]/ ;/ // // Hi/ [/ k/ ]/ ./ 〈/ id/ ,/ num/ 〉/ =/ 〈/ r/ [/ 4/ ]/ ,/ r/ [/ 5/ ]/ 〉/ 7/ ./ o/ ·/ ·/ =/ ins/ (/ o/ ./ p/ +/ 0/ // 1/ ,/ r/ [/ 6/ ]/ ,/ o/ ./ nd/ ,/ r/ [/ 1/ ]/ ,/ r/ [/ 2/ ]/ )/ ;/ 8/ ./ o/ ·/ ·/ =/ ITSQ/ (/ o/ ,/ Hi/ [/ k/ +/ 1/ :/ |/ Hi/ |/ -/ 1/ ]/ )/ ;/ 9/ ./ ELSE10/ ./ o/ ·/ ·/ =/ r/ [/ 4/ ]/ ;/ 11/ ./ ndc12/ ./ o/ ·/ ·/ =/ ITSQ/ (/ o/ ,/ Hdc/ )/ ;/ 13/ ./ IFo/ =/ / THEN14/ ./ RETURNo/ ;/ 15/ ./ ENDIF16/ ./ IFo/ ./ t/ =/ insTHEN17/ ./ o/ ·/ ·/ =/ ITSQ/ (/ o/ ,/ Hi/ )/ ;/ Hi/ ./ add/ (/ o/ )/ ;/ 18/ ./ ELSE19/ ./ ox20/ ./ FORk/ ·/ ·/ =/ 0upto/ |/ Hi/ |/ -/ 121/ ./ oy22/ ./ ox23/ ./ Hi/ [/ k/ ]/ ·/ ·/ =/ IT/ (/ Hi/ [/ k/ ]/ ,/ oy/ )/ ;/ 24/ ./ ENDFOR25/ ./ o/ ·/ ·/ =/ ox/ ;/ Hd/ ./ add/ (/ o/ )/ ;/ 26/ ./ ENDIF27/ ./ ENDIF28/ ./ RETURNo/ ;/ 4.7/ 性能/ 分析/ 本地/ 产生/ 的/ 操作/ o/ 都/ 会/ 被/ 立即/ 执行/ ,/ 耗费/ 计算/ 时间/ O/ (/ 1/ )/ ./ 如果/ o/ ./ t/ =/ ins/ ,/ 调用/ ET/ 排除/ Hi/ 中/ 所有/ 操作/ 的/ 影响/ 并/ 遍历/ Hd/ 计算/ o/ ./ nd/ ,/ 耗费/ 计算/ 时间/ O/ (/ |/ Hi/ |/ +/ Hd/ |/ )/ ;/ 如果/ o/ ./ t/ =/ del/ ,/ 调用/ SWAP/ 将/ o/ 交换/ 到/ 所有/ 插入/ 操作/ 的/ 前面/ ,/ 耗费/ 计算/ 时间/ O/ (/ |/ Hd/ |/ )/ ./ 当/ 站点/ 接收/ 到/ 远程/ 操作/ o/ ,/ 首先/ 调用/ Integrate/ -/ Remote/ 计算/ 出/ o/ 在/ 本/ 站点/ 的/ 执行/ 形式/ o/ ,/ 然后/ 执行/ o/ ./ 如果/ 接收/ 到/ 的/ 请求/ r/ ./ flag/ =/ 0/ // 1/ (/ 本质/ 上/ 接收/ 的/ 是/ 插入/ 操作/ )/ ,/ 则/ 首先/ 在/ Hi/ 找到/ 相关/ 操作/ ok/ 并求/ 出/ o/ ,/ 然后/ 调用/ ITSQ/ (/ o/ ,/ Hi/ [/ k/ +/ 1/ :/ |/ Hi/ |/ -/ 1/ ]/ )/ 计算/ 出/ o/ ,/ 耗费/ 计算/ 时间/ O/ (/ |/ Hi/ |/ )/ ;/ 如果/ r/ 是/ undo/ 请求/ (/ 本质/ 上/ 接收/ 的/ 是/ 删除/ 操作/ )/ ,/ 则/ 也/ 是/ 首先/ 在/ Hi/ 找到/ 相关/ 操作/ ok/ 并/ 调用/ SWAP/ 将/ 其/ 交换/ 到/ Hi/ 的/ 尾部/ 得到/ ok/ ,/ o/ 等于/ ok/ 的/ 逆/ 操作/ ,/ 耗费/ 计算/ 时间/ O/ (/ |/ Hi/ |/ )/ ;/ 如果/ 请求/ r/ ./ flag/ =/ null/ ,/ 则/ 首先/ 调用/ Separate/ 函数/ 将/ H/ 划分/ 成/ Hd/ ·/ Hi/ ,/ 然后/ 调用/ ITSQ/ (/ o/ ,/ Hdc/ +/ Hi/ )/ 计算/ 出/ o/ ,/ 耗费/ 计算/ 时间/ O/ (/ |/ Hd/ |/ 2/ +/ |/ Hdc/ |/ +/ |/ Hi/ |/ )/ ,/ 对于/ 删除/ 操作/ ,/ 还/ 需要/ 将/ o/ 调整/ 到/ Hi/ 之前/ ./ 表/ 1/ 给出/ 了/ 集成/ 操作/ 到/ HB/ 中/ 的/ 计算/ 时间/ 复杂度/ ,/ 包括/ 操作/ 的/ 执行/ 时间/ 以及/ 维护/ DIHB/ 结构/ 的/ 时间/ ./ 插入/ 操作/ 删除/ 操作/ 本地/ 操作/ 都/ 是/ 先/ 执行/ 然后/ 才/ 被/ 集成/ 到/ HB/ 中/ ,/ 因此/ 集成/ 本地/ 操作/ 的/ 过程/ 不会/ 影响/ 操作/ 的/ 执行/ ./ 而/ 接收/ 到/ 的/ 远程/ 操作/ 则/ 要求/ 尽快/ 得到/ 执行/ ,/ 集成/ 远程/ 操作/ 的/ 计算/ 效率/ 决定/ 了/ 操作/ 的/ 响应/ 时间/ ./ 在/ 上面/ 的/ 讨论/ 中/ ,/ 根据/ 〈/ id/ ,/ num/ 〉/ 找到/ 第/ k/ 个/ 位置/ 上/ 的/ 操作/ ,/ 可以/ 通过/ 遍历/ Hi/ 的/ 方式/ 也/ 可以/ 通过/ 建立/ 哈希/ 表来/ 访问/ ./ 算法/ 维护/ HB/ 需要/ 耗费/ O/ (/ |/ H/ |/ )/ 的/ 空间/ ./ 5/ 实例/ 分析/ 本节/ 用/ 一个/ 实例/ 场景/ 来/ 解释/ MOOT/ 算法/ 的/ 执行/ 过程/ ./ 协同/ 场景/ 为/ 3/ 个/ 站点/ 的/ 协同/ ,/ 站点/ 之间/ 的/ 优/ Page10/ 先级/ 设定/ 为/ site1/ </ site2/ </ site3/ ,/ 初始/ 编辑/ 状态/ s/ =/ “/ abc/ ”/ ./ 3/ 个/ 站点/ 并发/ 产生/ 操作/ o1/ =/ ins/ (/ 2/ ,/ y/ )/ 、/ o2/ =/ del/ (/ 1/ )/ 和/ o3/ =/ ins/ (/ 1/ ,/ x/ )/ ./ 站点/ 1/ 在/ 接收/ 到/ o2/ 之后/ 产生/ o4/ =/ ins/ (/ 2/ ,/ z/ )/ ;/ 站点/ 3/ 在/ 接收/ 到/ o1/ 之后/ 产生/ 操作/ o5/ =/ del/ (/ 1/ )/ ./ 各个/ 站点/ 发送/ 、/ 接收/ 操作/ 的/ 顺序/ 如图/ 8/ 所示/ ./ 最终/ 所有/ 站点/ 得到/ 一致/ 的/ 结果/ “/ ayzc/ ”/ ./ 在/ 站点/ 1/ :/ o1/ 立即/ 执行/ ,/ H1/ =/ [/ o1/ ]/ ;/ 接收/ 到/ o2/ ,/ 调用/ IT/ (/ o2/ ,/ o1/ )/ 得到/ o2/ =/ del/ (/ 1/ )/ ,/ 执行/ o2/ ,/ H1/ =/ [/ o2o1/ ]/ ,/ 其中/ o1/ =/ IT/ (/ o1/ ,/ o2/ )/ =/ ins/ (/ 1/ ,/ y/ ,/ 1/ )/ ;/ o4/ 立即/ 执行/ 并/ 对/ o1/ 进行/ 排除/ 转换/ ET/ (/ o4/ ,/ o1/ )/ =/ false/ ,/ 将/ 请求/ r/ =/ 〈/ 1/ ,/ 2/ ,/ 1/ ,/ 1/ ,/ 1/ ,/ z/ 〉/ 广播/ 到/ 其他/ 站点/ ,/ H1/ =/ [/ o2o1o4/ ]/ ;/ 接收/ 到/ o3/ ,/ 由于/ o3/ ‖/ o1/ ‖/ o2/ ,/ o3/ =/ ITSQ/ (/ o3/ ,/ H1/ )/ =/ ins/ (/ 1/ ,/ x/ ,/ 0/ )/ ,/ 执行/ o3/ ,/ H1/ =/ [/ o2o1o4o3/ ]/ ;/ 接收/ 到/ o5/ ,/ 由于/ o5/ 是/ o3/ 的/ undo/ 操作/ ,/ o5/ =/ inverse/ (/ o3/ )/ =/ del/ (/ 1/ )/ ,/ 执行/ o5/ ,/ 将/ o3/ 从/ H1/ 中/ 删除/ ,/ H1/ =/ [/ o2o1o4/ ]/ ./ 此时/ s/ =/ “/ ayzc/ ”/ ./ 在/ 站点/ 2/ :/ o2/ 立即/ 执行/ ,/ H2/ =/ [/ o2/ ]/ ;/ 接收/ 到/ o1/ ,/ o1/ =/ IT/ (/ o1/ ,/ o2/ )/ =/ ins/ (/ 1/ ,/ y/ ,/ 1/ )/ ,/ 执行/ o1/ ,/ H2/ =/ [/ o2o1/ ]/ ;/ 接收/ 到/ o3/ ,/ o3/ =/ ITSQ/ (/ o3/ ,/ H2/ )/ =/ ins/ (/ 1/ ,/ x/ ,/ 0/ )/ ,/ 执行/ o3/ ,/ H2/ =/ [/ o2o1o3/ ]/ ;/ 接收/ 到/ o4/ ,/ 在/ H2/ 中/ 找到/ o1/ ,/ o4/ =/ ins/ (/ 2/ ,/ z/ ,/ 1/ )/ ,/ o4/ =/ IT/ (/ o4/ ,/ o3/ )/ =/ ins/ (/ 3/ ,/ z/ ,/ 1/ )/ ,/ 执行/ o4/ ,/ H2/ =/ [/ o2o1o3o4/ ]/ ;/ 接收/ 到/ o5/ ,/ 由于/ o5/ 是/ o3/ 的/ undo/ 操作/ ,/ o3/ =/ SWAP/ (/ o3/ ,/ o4/ )/ =/ ins/ (/ 1/ ,/ x/ ,/ 0/ )/ ,/ o4/ =/ ins/ (/ 2/ ,/ z/ ,/ 1/ )/ ,/ H2/ =/ [/ o2o1o4o3/ ]/ ,/ o5/ =/ inverse/ (/ o3/ )/ =/ del/ (/ 1/ )/ ,/ 执行/ o5/ ,/ 从/ H2/ 中/ 删除/ o3/ ,/ H2/ =/ [/ o2o1o4/ ]/ ./ 此时/ s/ =/ “/ ayzc/ ”/ ./ 在/ 站点/ 3/ :/ o3/ 立即/ 执行/ ,/ H3/ =/ [/ o3/ ]/ ;/ 接收/ 到/ o1/ ,/ 将/ o1/ 与/ o3/ 进行/ 包含/ 转换/ 得到/ o1/ =/ ins/ (/ 3/ ,/ y/ ,/ 0/ )/ ,/ H3/ =/ [/ o3o1/ ]/ ;/ o5/ 立即/ 执行/ ,/ o5/ =/ SWAP/ (/ o5/ ,/ o1/ )/ =/ del/ (/ 1/ )/ ,/ o1/ =/ IT/ (/ o1/ ,/ o5/ )/ =/ ins/ (/ 2/ ,/ y/ ,/ 1/ )/ ,/ ET/ (/ o5/ ,/ o3/ )/ =/ false/ ,/ 恢复/ o1/ ./ nd/ =/ 0/ ,/ 从/ H3/ 中/ 删除/ o3/ 并/ 将/ r/ =/ 〈/ 3/ ,/ 2/ ,/ undo/ ,/ 3/ ,/ 1/ ,/ x/ 〉/ 发送/ 出去/ ,/ H3/ =/ [/ o1/ ]/ ;/ 接收/ 到/ o2/ ,/ o2/ =/ IT/ (/ o2/ ,/ o1/ )/ =/ del/ (/ 1/ )/ ,/ 执行/ o2/ ,/ H3/ =/ [/ o2o/ / 1/ ]/ ,/ 其中/ o/ / 1/ =/ IT/ (/ o1/ ,/ o2/ )/ =/ ins/ (/ 1/ ,/ y/ ,/ 1/ )/ ;/ 接收/ 到/ o4/ ,/ 在/ H3/ 中/ 查找/ 到/ o/ / 1/ ,/ o4/ =/ ins/ (/ 2/ ,/ z/ ,/ 1/ )/ ,/ 执行/ o4/ ,/ H3/ =/ [/ o2o/ / 1o4/ ]/ ./ 此时/ s/ =/ “/ ayzc/ ”/ ./ 6/ 实验/ 研究/ 由于/ ABT/ 的/ 时间/ 复杂度/ 低于/ 当前/ 其他/ 的/ OT/ 算法/ ,/ 因此/ 本文/ 通过/ 比较/ MOOT/ 和/ ABT/ 算法/ 的/ 性能/ 来检/ MOOT/ 算法/ 的/ 性能/ ./ 所有/ 的/ 算法/ 都/ 采用/ C#/ 编写/ ./ 对比/ 实验/ 运行/ 的/ 计算机/ 配置/ 为/ IntelQuadQ83002/ ./ 5GHz/ 和/ 2GBRAM/ ./ 操作系统/ 是/ Windows7Ultimate32/ ./ 参照/ 文献/ [/ 11/ ,/ 15/ ,/ 37/ ]/ ,/ 实验/ 模拟/ 两个/ 站点/ 之间/ 的/ 协同/ ./ 首先/ ,/ 站点/ 1/ 和/ 站点/ 2/ 并发/ 地/ 产生/ M/ 个/ 操作/ 和/ N/ 个/ 操作/ ;/ 然后/ ,/ 测试/ 将/ 这/ N/ 个/ 操作/ 集成/ 到/ 远程/ 站点/ 1/ 的/ 计算/ 时间/ ./ 在/ 300000/ 个字符/ 的/ 文档/ 上/ 产生/ 插入/ 、/ 删除/ 操作/ ,/ 操作/ 的/ 位置/ 是/ 均匀分布/ 的/ ./ M/ 和/ N/ 的/ 取值/ 在/ 300/ ~/ 3000/ 之间/ ,/ 步长/ 为/ 300/ ./ 测试/ 在/ 插入/ 操作/ 占/ 比例/ 60/ %/ 和/ 80/ %/ 时/ ,/ MOOT/ 和/ ABT/ 算法/ 集成/ 远程/ 操作/ 的/ 计算/ 时间/ ./ 实验/ 结果/ 展示/ 在/ 图/ 9/ ~/ 图/ 12/ 中/ ./ 图/ 9ABT/ 在/ 插入/ 操作/ 比例/ 为/ 60/ %/ 时/ 的/ 计算/ 时间/ 图/ 10MOOT/ 在/ 插入/ 操作/ 比例/ 为/ 60/ %/ 时/ 的/ 计算/ 时间/ Page11/ 图/ 11ABT/ 在/ 插入/ 操作/ 比例/ 为/ 80/ %/ 时/ 的/ 计算/ 时间/ 图/ 12MOOT/ 在/ 插入/ 操作/ 比例/ 为/ 80/ %/ 时/ 的/ 计算/ 时间/ 在/ 插入/ 操作/ 比例/ 为/ 60/ %/ 时/ ,/ MOOT/ 集成/ 远程/ 操作/ 的/ 计算/ 时间/ 比/ ABT/ 提高/ 了/ 20/ %/ 左右/ ,/ 并且/ 二者/ 都/ 随着/ M/ 的/ 增大/ 呈现/ 多项式/ 增长/ ./ ABT/ 耗费/ 大约/ 50s/ 集成/ N/ =/ 2400/ 个/ 操作/ 到/ 远程/ 站点/ HB/ (/ M/ =/ 1500/ 个/ 操作/ )/ 而/ MOOT/ 能/ 集成/ 2700/ 个/ 操作/ ./ 当/ M/ =/ 2100/ 的/ 时候/ ,/ MOOT/ 每/ 集成/ 300/ 个/ 操作/ 需要/ 大约/ 10s/ 的/ 计算/ 时间/ ,/ ABT/ 则/ 需要/ 大约/ 12s/ ./ 在/ 插入/ 操作/ 比例/ 为/ 80/ %/ (/ 文献/ [/ 15/ ]/ 中/ 指出/ 的/ reasonable/ 比例/ )/ 时/ ,/ MOOT/ 计算/ 效率/ 比/ ABT/ 提高/ 了/ 接近/ 10/ 倍/ ./ 当/ M/ =/ 2400/ 的/ 时候/ ,/ MOOT/ 每/ 集成/ 300/ 个/ 操作/ 花费/ 4s/ 的/ 计算/ 时间/ ,/ 而/ ABT/ 需要/ 35s/ ./ 当/ M/ =/ 3000/ 的/ 时候/ ,/ MOOT/ 集成/ 3000/ 个/ 操作/ 总共/ 需要/ 61s/ ,/ 而/ ABT/ 大概/ 需要/ 560s/ ./ 从图/ 9/ 到/ 图/ 12/ 可以/ 看出/ ,/ 随着/ 插入/ 操作/ 增多/ ,/ ABT/ 算法/ 的/ 计算/ 时间/ 不断/ 在/ 增加/ ,/ 而/ MOOT/ 算法/ 的/ 计算/ 时间/ 却/ 在/ 减少/ ./ 假如/ 响应/ 时间/ 要求/ 不/ 高于/ 100ms/ ,/ M/ 和/ N/ 则/ 需要/ 取/ 合适/ 的/ 值/ ./ 例如/ ,/ 当/ 插入/ 比例/ 为/ 80/ %/ 时/ ,/ MOOT/ 算法/ 能够/ 在/ 100ms/ 内/ 集成/ 10/ 个/ 操作/ 到/ M/ =/ 2100/ 的/ 远程/ 站点/ ./ 由于/ 产生/ 的/ 操作/ 位置/ 是/ 均匀分布/ 的/ ,/ 因此/ 无效/ 操作/ 和/ r/ ./ flag/ ≠/ null/ 的/ 比例/ 非常/ 小/ ./ 如果/ 20/ %/ 的/ 删除/ 操作/ 是/ 为了/ 撤销/ 之前/ 插入/ 操作/ 的/ 效果/ ,/ 那么/ 集成/ 操作/ 到/ M/ =/ 3000/ 和/ M/ =/ 2400/ 的/ 远程/ 站点/ 耗费/ 的/ 时间/ 是/ 相等/ 的/ ./ 可以/ 预期/ 在/ 实际/ 应用/ 中/ ,/ MOOT/ 算法/ 计算/ 效率/ 更高/ ./ 总之/ ,/ 与/ ABT/ 算法/ 相比/ ,/ MOOT/ 在/ 集成/ 远程/ 操作/ 时/ 性能/ 上/ 有/ 较/ 大幅度/ 的/ 提升/ ./ 7/ 总结/ MOOT/ 算法/ 利用/ 了/ 协同/ 编辑/ 环境/ 的/ 两个/ 特性/ ,/ 即/ 协同/ 站点/ 的/ 操作/ 历史/ 保存/ 了/ 大量/ 无效/ 操作/ 以及/ 插入/ 操作/ 的/ 比例/ 大于/ 删除/ 操作/ ./ 本文/ 提出/ 的/ DIHB/ 结构/ 能够/ 有效/ 减少/ HB/ 中/ 操作/ 的/ 数量/ ,/ 同时/ 避免/ 算法/ 的/ 时间/ 复杂度/ 依赖于/ 多数/ 操作/ ./ MOOT/ 算法/ 不仅/ 能够/ 满足/ 意图/ 保持/ 的/ 条件/ 而且/ 提高/ 了/ OT/ 算法/ 的/ 计算/ 效率/ ./ 下/ 一步/ 的/ 工作/ ,/ 考虑/ 将/ MOOT/ 算法/ 扩展/ 到/ 支持/ 复杂/ 对象/ 的/ 实时/ 协同/ ./ 

