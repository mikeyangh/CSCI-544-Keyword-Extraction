Page1PaSeM/ :/ 并行/ 无/ 冲突/ 的/ 网络流量/ 会话/ 管理/ 张/ 建宇/ 1/ )/ 周渊/ 2/ )/ 邹维/ 1/ )/ 1/ )/ (/ 北京大学/ 计算机/ 科学技术/ 研究所/ 北京/ 100871/ )/ 2/ )/ (/ 国家/ 计算机网络/ 应急/ 技术/ 处理/ 协调/ 中心/ 北京/ 100029/ )/ 摘要/ 网络/ 会话/ 管理/ 是/ 网络流量/ 监控/ 、/ 状态/ 防火墙/ 、/ 入侵/ 防御/ 、/ 网络地址/ 转换/ 、/ 负载/ 分流/ 等/ 网络/ 在线/ 业务/ 的/ 关键/ 共性/ 技术/ ,/ 对于/ 准确/ 、/ 快速/ 、/ 灵活/ 地/ 跟踪/ 、/ 分析/ 和/ 处置/ 网络流量/ 中/ 的/ 协议/ 交互/ 过程/ 、/ 端/ 对/ 端/ 行为/ 和/ 通信/ 内容/ 起着/ 基础性/ 支撑/ 作用/ ./ 近年来/ ,/ 随着/ P2P/ (/ Peer/ -/ to/ -/ Peer/ )/ 、/ VoIP/ (/ VoiceoverIP/ )/ 、/ 网络/ 流媒体/ 等/ 新兴/ 应用/ 的/ 快速/ 发展/ ,/ 网络流量/ 和/ 会/ 话/ 呈现/ 爆炸式/ 增长/ ,/ 如何/ 实现/ 高效/ 的/ 会/ 话/ 管理/ 成为/ 人们/ 面临/ 的/ 一项/ 挑战/ ./ 文中/ 提出/ 了/ 一种/ 适用/ 于/ 并行执行/ 环境/ 的/ 网络/ 会话/ 管理/ 方案/ PaSeM/ (/ ParallelSessionManagement/ )/ ,/ 采用/ 基于/ 散/ 列表/ 的/ 无锁会/ 话表/ 设计/ 和/ 多种/ 并行/ 策略/ ,/ 讨论/ 并/ 解决/ 了/ 在/ 高速/ 网络/ 环境/ 下/ 面临/ 的/ 各种/ 并行/ 冲突/ 问题/ ,/ 给出/ 了/ 会话表/ 查询/ 和/ 动态/ 管理/ 的/ 高效/ 并行算法/ ,/ 实现/ 了/ 对/ 报文/ 和/ 会/ 话/ 的/ 并行/ 无/ 冲突/ 的/ 高效/ 处理/ ./ 基于/ G/ // G2/ // n1/ 排队模型/ 和/ 空竭/ 服务/ 多重/ 休假/ M/ // G/ +/ D/ // 1/ 排队模型/ 对/ PaSeM/ 的/ 性能/ 进行/ 了/ 理论/ 分析/ ,/ 对于/ 稳态/ 下/ 并行处理/ 单元/ (/ PE/ )/ 数量/ 、/ 任务/ 队列/ 长度/ 、/ 存储/ 开销/ 与/ 报文/ 到达/ 速率/ 、/ 会话/ 到达/ 速率/ 之间/ 的/ 关系/ 以及/ 其它/ 关键/ 参数/ 应/ 满足/ 的/ 条件/ 给出/ 了/ 定量/ 计算方法/ ./ 最后/ ,/ 采用/ 基于/ IXP2400/ 网络/ 处理器/ 的/ 硬件平台/ 进行/ 了/ 原型/ 开发/ 和/ 实验/ ./ 实验/ 结果表明/ ,/ PaSeM/ 对于/ 会话/ 管理/ 和/ 报文/ 处理/ 具有/ 较/ 好/ 的/ 并行/ 加速/ 效果/ ,/ 理论/ 计算/ 值/ 与/ 实验/ 值能/ 较/ 好/ 地/ 吻合/ ,/ 报文/ 处理/ 的/ 并行/ 效率/ 均值/ 接近/ 1/ ,/ 当会话/ 管理/ 单元/ 个数/ 为/ 4/ 时/ ,/ 会话/ 处理/ 并行/ 效率/ 为/ 65.4/ %/ (/ 亦/ 即/ 加速/ 比为/ 2.62/ )/ ,/ 当会话/ 管理/ 单元/ 个数/ 为/ 8/ 时/ ,/ 会话/ 处理/ 并行/ 效率/ 仍然/ 达到/ 了/ 48.3/ %/ (/ 加速/ 比为/ 3.86/ )/ ,/ 能够/ 满足/ 当前/ 高速/ 网络/ 环境/ 流量/ 处理/ 的/ 性能/ 要求/ ;/ 在/ 最大/ 吞吐量/ 负载/ 下/ 队列/ 长度/ 及其/ 变化/ 幅度/ 都/ 处于/ 合理/ 范围/ ,/ 会话表/ 垃圾/ 比率/ 维持/ 在/ 较/ 低/ 的/ 水平/ 上/ (/ 实验/ 结果/ 为/ 小于/ 9/ %/ )/ ,/ 与/ 已有/ 的/ 工作/ 相比/ 为/ 优/ ./ 关键词/ 网络流量/ ;/ 会话/ 管理/ ;/ 会话表/ ;/ 并行处理/ ;/ 并行/ 冲突/ 1/ 引言/ 随着/ P2P/ (/ Peer/ -/ to/ -/ Peer/ )/ 、/ VoIP/ (/ VoiceoverIP/ )/ 、/ 流媒体/ 、/ 移动/ 数据业务/ 等/ 网络应用/ 日新月异/ 的/ 发展/ 以及/ 网络带宽/ 的/ 迅猛/ 增长/ ,/ 网络/ 基础设施/ 和/ 网络系统/ 面临/ 许多/ 新/ 的/ 挑战/ ./ 例如/ ,/ 网络流量/ 监控/ 、/ 入侵/ 检测/ 和/ 防御/ 、/ 状态/ 防火墙/ 、/ 网络地址/ 转换/ (/ NAT/ )/ 、/ 负载/ 分流/ 等/ 网络/ 在线/ 业务/ 均/ 需要/ 围绕/ 网络/ 会话/ 实现/ 对/ 流量/ 的/ 实时/ 、/ 复杂/ 的/ 管理/ 和/ 控制/ [/ 1/ -/ 3/ ]/ ,/ 高速/ 网络/ 环境/ 中/ 网络/ 会话/ 往往/ 达到/ 几百万/ 甚至/ 上/ 千万/ 规模/ ,/ 其/ 核心/ 是/ 实现/ 高效/ 的/ 会/ 话/ 管理/ ./ 一段时间/ 区间/ 内在/ 两个/ 通信/ 端点/ (/ endpoints/ )/ 之间/ 产生/ 的/ 连续/ 报文/ 称为/ 一条/ “/ 会话/ (/ session/ )/ ”/ ./ 会话/ 中/ 的/ 报文/ 含有/ 相同/ 的/ 关键码/ ,/ 如源/ IP地址/ 、/ 目的/ IP地址/ 、/ 源/ TCP/ // UDP/ 端口/ 、/ 目的/ TCP/ // UDP/ 端口/ 和/ IP/ 协议/ 号/ ./ 如图/ 1/ 所示/ ,/ 从/ 时间轴/ 上/ 观察/ ,/ 每条/ 会/ 话/ 的/ 生命周期/ 都/ 包括/ 开始/ 、/ 结束/ 和/ 老化/ 等/ 几个/ 关键点/ [/ 4/ -/ 5/ ]/ ./ 会话/ 管理/ 对/ 每/ 条会/ 话/ 的/ 生命周期/ 和/ 状态/ 变化/ 进行/ 跟踪/ ,/ 在/ 会话表/ (/ sessiontable/ )/ 中/ 记录/ 并/ 及时/ 更新/ 每条/ 会/ 话/ 的/ 信息/ ,/ 包括/ 时间/ 戳/ 、/ 会话/ 状态/ 以及/ 各种/ 业务/ 模块/ 所/ 需/ 的/ 参数/ ,/ 并/ 针对/ 流经/ 的/ 每个/ 报文/ 查询/ 会话表/ ,/ 找到/ 报文/ 所属/ 会话/ 记录/ ./ 业务/ 模块/ 根据/ 这些/ 信息/ 对会/ 话/ 和/ 报文/ 实施/ 各种/ 处理/ 操作/ ,/ 实现/ 对/ 流量/ 的/ 细粒度/ 、/ 精确/ 及/ 基于/ 状态/ 和/ 时间/ 的/ 管理控制/ [/ 1/ -/ 2/ ,/ 5/ ]/ ./ 当会话/ 结束/ 后/ ,/ 则/ 要/ 及时/ 删除/ 回收/ 会话/ 表中/ 过期/ 的/ 会/ 话/ 记录/ ./ 与/ 常见/ 的/ 单向/ (/ unidirectional/ )/ “/ 网络/ 流/ (/ flow/ )/ ”/ [/ 4/ ]/ 不同/ ,/ 网络/ 会话/ 是/ 双向/ (/ bidirectional/ )/ 的/ ,/ 会话/ 的/ 第一个/ 报文/ 传输/ 的/ 方向/ 一般/ 定义/ 为会/ 话/ 的/ “/ 正向/ ”/ ,/ 反之/ 称为/ “/ 反向/ ”/ ,/ 即/ 一条/ “/ 会话/ ”/ 包含/ 正向/ 和/ 反向/ 两条/ “/ 流/ ”/ ./ 两者/ 的/ 应用领域/ 和/ 应用/ 场景/ 有/ 较大/ 的/ 差别/ ./ 前者/ 广泛应用/ 于/ 网络/ 测量/ 领域/ [/ 6/ -/ 9/ ]/ ,/ 所/ 涉及/ 的/ 测量/ 任务/ 往往/ 比较简单/ ,/ 需要/ 记录/ 的/ 流/ 信息/ 较少且/ 对于/ 少量/ 的/ 分类/ 和/ 查询/ 错误/ 不/ 敏感/ ,/ 因而/ 网络/ 流/ 管理/ 的/ 研究/ 重点/ 在于/ :/ 流表/ 结构/ 的/ 设计/ ,/ 即/ 如何/ 将/ 信息压缩/ 保存/ 到/ 容量/ 小/ 、/ 速度/ 快/ 的/ 存储器/ 件/ 中/ ,/ 以/ 降低/ I/ // O/ 访存/ 开销/ 、/ 提高/ 性能/ 以及/ 依托/ 于/ 这些/ 流表/ 结构/ 的/ 高效/ 的/ 查询/ 算法/ ;/ 报文/ 采样/ [/ 6/ ,/ 10/ ]/ 和/ 流/ 采样/ [/ 7/ ,/ 9/ ]/ 技术/ ,/ 研究/ 如何/ 在/ 减轻/ 负载/ 的/ 同时/ 保证/ 测量/ 的/ 精度/ ./ 后者/ 则/ 主要/ 应用/ 于/ 许多/ 复杂/ 的/ 在线/ 业务/ ,/ 特别/ 是/ 一些/ 网络安全/ 业务/ [/ 2/ -/ 3/ ,/ 11/ -/ 14/ ]/ ,/ 以/ 实现/ 对/ 协议/ 交互/ 过程/ 、/ 端/ 对/ 端/ 行为/ 和/ 通信/ 内容/ 的/ 准确/ 、/ 快速/ 、/ 灵活/ 的/ 跟踪/ 、/ 分析/ 和/ 处置/ ./ 例如/ ,/ 状态/ 防火墙/ 需要/ 通过/ 检查/ TCP/ 连接/ 三次/ 握手/ 交互/ 过程/ 的/ 完整性/ 来/ 抵御/ SYN/ 洪泛/ 攻击/ [/ 1/ ]/ ;/ 入侵/ 检/ Page3/ 测系统/ 需要/ 通过/ 将会话/ 正反两方/ 向/ 的/ 状态/ 信息/ 和/ 检测/ 结果/ 进行/ 关联/ 分析/ 来/ 避免/ 误检/ [/ 3/ ,/ 15/ ]/ ;/ 网络地址/ 转换/ (/ NAT/ )/ 在/ 进行/ IP/ 和/ TCP/ // UDP/ 端口/ 资源/ 的/ 动态分配/ 时/ ,/ 也/ 必须/ 以会/ 话/ 为/ 粒度/ ,/ 否则/ 无法/ 保持/ 端/ 对/ 端/ 通信/ 的/ 正确性/ ./ 这些/ 业务/ 与/ 上述/ 基于/ 流/ 的/ 网络/ 测量/ 任务/ 不同/ ,/ 通常/ 需要/ 记录/ 比较/ 多/ 的/ 会/ 话/ 属性/ 信息/ 和/ 状态/ 信息/ ,/ 而且/ 不/ 允许/ 出现/ 会话/ 记录/ 和/ 信息/ 的/ 缺失/ ,/ 因而/ 会话表/ 往往/ 需要/ 占据/ 较大/ 的/ 存储空间/ ./ 另一方面/ ,/ 这些/ 业务/ 对于/ 流经/ 的/ 每/ 条会/ 话/ 和/ 每个/ 报文/ 都/ 要/ 进行/ 检测/ 和/ 处理/ ,/ 不/ 允许/ 出现/ 遗漏/ 和/ 错误/ [/ 16/ ]/ ./ 在/ 这种/ 情况/ 下/ ,/ 随着/ 会话/ 和/ 报文/ 规模/ 的/ 增加/ ,/ 会话表/ 添加/ 、/ 删除/ 和/ 查询/ 的/ 效率/ 往往/ 迅速/ 下降/ ,/ 成为/ 系统/ 主要/ 的/ 性能/ 瓶颈/ ./ 因此/ ,/ 如何/ 实现/ 高效/ 的/ 会/ 话/ 管理/ 成为/ 一项/ 非常/ 具有/ 现实意义/ 的/ 研究课题/ ,/ 其/ 重点/ 在于/ 会话表/ 结构/ 以及/ 会话表/ 的/ 动态/ 管理机制/ 和/ 查询/ 算法/ [/ 5/ ,/ 17/ -/ 18/ ]/ ./ 针对/ 大规模/ 网络流量/ 会话/ 管理/ 问题/ ,/ 本文/ 提出/ 了/ 一种/ 适用/ 于/ 并行执行/ 环境/ 的/ 网络/ 会话/ 管理/ 方案/ PaSeM/ (/ ParallelSessionManagement/ )/ ,/ 采用/ 基于/ 散/ 列表/ 的/ 无锁会/ 话表/ 设计/ ,/ 讨论/ 并/ 解决/ 了/ 在/ 高速/ 网络/ 环境/ 下/ 面临/ 的/ 各种/ 并行/ 冲突/ 问题/ ,/ 给出/ 了/ 会话表/ 查询/ 和/ 动态/ 管理/ 的/ 高效/ 并行算法/ ./ 基于/ G/ // G2/ // n1/ 排队模型/ 和/ 空竭/ 服务/ 多重/ 休假/ M/ // G/ +/ D/ // 1/ 排队模型/ 对/ PaSeM/ 的/ 性能/ 进行/ 了/ 理论/ 分析/ ,/ 对于/ 稳态/ 下/ 并行处理/ 单元/ (/ PE/ )/ 数量/ 、/ 任务/ 队列/ 长度/ 、/ 存储/ 开销/ 与/ 报文/ 到达/ 速率/ 、/ 会话/ 到达/ 速率/ 之间/ 的/ 关系/ 以及/ 其它/ 关键/ 参数/ 应/ 满足/ 的/ 条件/ 给出/ 了/ 定量/ 计算方法/ ./ 最后/ ,/ 采用/ 基于/ IXP2400/ 网络/ 处理器/ 的/ 硬件平台/ 进行/ 了/ 原型/ 开发/ 和/ 实验/ ./ PaSeM/ 在/ 保证/ 业务/ 灵活性/ 的/ 前提/ 下/ 实现/ 了/ 对/ 会/ 话/ 和/ 报文/ 的/ 高速/ 无/ 冲突/ 并行处理/ ./ 2/ 相关/ 工作/ 对于/ 诸如/ 网络/ 流/ 计数/ 、/ 流/ 报文/ 计数/ [/ 19/ -/ 20/ ]/ 等/ 简单/ 的/ 网络流量/ 测量/ 任务/ 来说/ ,/ 精确/ 跟踪/ 和/ 记录/ 每条流/ 的/ 状态/ 是/ 没有/ 必要/ 的/ ,/ 因此/ 人们/ 常/ 采用/ bitmap/ 或/ Bloomfilter/ [/ 21/ ]/ 来/ 压缩/ 记录/ 流/ 信息/ ,/ 并/ 将/ 其/ 置于/ SRAM/ 等/ 高速/ 存储器/ 件/ 中/ ,/ 从而/ 以较/ 小/ 的/ 存储空间/ 开销/ 和/ I/ // O/ 访存/ 开销/ 来/ 获得/ 处理/ 效率/ 的/ 提升/ ./ 例如/ ,/ Estan/ 等/ 人/ 提出/ 了/ 一组/ 基于/ bitmap/ 的/ 流/ 计数/ 算法/ ,/ 以/ 满足/ 网络/ 测量/ 、/ 拒绝服务/ 攻击/ 检测/ 、/ 端口扫描/ 检测/ 和/ 调度/ 等/ 不同/ 应用/ 的/ 需要/ [/ 19/ ]/ ;/ Kumar/ 和/ Xu/ 等/ 人/ 提出/ 了/ 带/ 多组/ 散列/ 函数/ 的/ SCBF/ (/ Space/ -/ CodeBloomFilter/ )/ 并/ 采用/ 多个/ 具有/ 不同/ 采样/ 概率/ 的/ SCBF/ 对/ 报文/ 进行/ 计数/ ,/ 再/ 基于/ 最大/ 似然/ 估计/ 和/ 平均值/ 估计/ 两种/ 方法/ 对流/ 大小/ (/ flowsize/ )/ 进行/ 估算/ [/ 20/ ]/ ./ 为了/ 实现/ 流/ 状态/ 跟踪/ ,/ Bonomi/ 等/ 人/ 提出/ 了/ 一种/ 改进/ 的/ 计数/ 型/ Bloomfilter/ ,/ 对/ 少量/ 流/ 状态/ 信息/ 进行/ 压缩/ 存储/ 和/ 模糊/ 查询/ ,/ 每个/ Bloomfilter/ 单元/ 除了/ 计数器/ 外/ 还/ 包含/ 一个/ 流/ 状态字/ 段/ (/ 一般/ 少于/ 20bits/ )/ ,/ 并/ 增加/ 了/ 一个/ DK/ (/ Don/ ’/ tKnow/ )/ 状态/ 作为/ 产生/ 碰撞/ 时/ 的/ 查询/ 结果/ [/ 22/ ]/ ./ Chang/ 等/ 人/ 则/ 通过/ 扩展/ Bloomfilter/ 单元/ 来/ 缓存/ 报文/ 分类/ 或/ 路由/ 查找/ 的/ 结果/ (/ 如下/ 一跳/ 的/ 输出设备/ 接口/ 位/ 图/ )/ ,/ 同时/ 采用/ 两级/ 散列/ 的/ Bloomfilter/ 结构/ 改善/ 冲突/ ,/ 实现/ 了/ 报文/ 分类/ 和/ 路由/ 查找/ 的/ 加速/ [/ 23/ ]/ ./ 上述/ “/ 紧凑型/ ”/ 结构/ 具有/ 节省/ 存储空间/ 、/ 减少/ I/ // O/ 访存/ 开销/ 方面/ 的/ 优势/ ,/ 适用/ 于/ 一些/ 高速/ 链路/ 上/ 的/ 简单/ 处理/ 任务/ ,/ 不过/ 也/ 存在/ 非常明显/ 的/ 局限/ [/ 22/ ,/ 24/ ]/ :/ (/ 1/ )/ 能够/ 存储/ 的/ 信息量/ 太/ 少/ ;/ (/ 2/ )/ 不/ 支持/ 对流/ 状态/ 信息/ 的/ 精确/ 跟踪/ 、/ 记录/ 和/ 查询/ ;/ (/ 3/ )/ 难以实现/ 记录/ 的/ 删除/ 操作/ 和/ 超时/ 老化/ 机制/ ,/ 因此/ 往往/ 必须/ 周期性地/ 对流/ 表/ 进行/ 重建/ ;/ (/ 4/ )/ 涉及/ 位级/ 内存/ 读写操作/ ,/ 如果/ 存储器/ 件/ 不/ 支持/ 并行/ 和/ 位级/ 寻址/ 的话/ ,/ 则/ 实际/ 存储/ 带宽/ 开销/ 仍然/ 是/ 比较/ 大/ 的/ ./ 因此/ ,/ 从/ 实用性/ 和/ 灵活性/ 角度/ 考虑/ [/ 25/ ]/ ,/ 散/ 列表/ 仍然/ 是/ 最/ 常见/ 的/ 流表/ 结构/ [/ 5/ -/ 6/ ,/ 9/ ,/ 12/ -/ 14/ ]/ ./ NetFlow/ [/ 6/ ]/ 是/ Cisco/ 路由器/ 中/ 广泛/ 采用/ 的/ 流/ 缓存/ 与/ 测量/ 技术/ ,/ 其/ 底层/ 流表/ 结构/ 和/ 流表/ 管理/ 的/ 技术细节/ 尚未/ 公开/ ,/ 有/ 文献/ 宣称/ 是/ 基于/ 散/ 列表/ 的/ 实现/ [/ 9/ ,/ 22/ ]/ ,/ 在/ 高速/ 网络/ 环境/ 中/ 通常/ 需要/ 采用/ 报文/ 采样/ [/ 6/ ,/ 10/ ]/ 或流/ 采样/ [/ 7/ ,/ 9/ ]/ 技术/ 来/ 减轻/ 负载/ ./ Xu/ 等/ 人/ 详细/ 研究/ 了/ 高速/ QoS/ 路由器/ 中/ 的/ 流表/ 设计/ ,/ 针对/ 分布式/ 线卡/ 和/ 集中式/ 转发/ 引擎/ 两种/ 路由器/ 体系结构/ ,/ 分别/ 提出/ 了/ 硬件/ 和/ 软件/ 两套/ 流表/ 设计方案/ [/ 5/ ]/ ,/ 其中/ 硬件/ 流表/ 采用/ 多路/ 组/ 关联/ 缓存/ ,/ 通过/ 动态/ 组/ 关联/ 机制/ 显著/ 降低/ 了/ 缓存/ 溢出/ 比率/ ,/ 并/ 采用/ 流水线/ 设计/ 以/ 实现/ 100/ +/ Gbps/ 的/ 吞吐量/ ;/ 软件/ 流表则/ 采用/ 散/ 列表/ 形式/ ,/ 基于/ 随机/ 模型/ 对/ 过期/ 会话/ 记录/ (/ 垃圾/ )/ 回收/ 机制/ 的/ 性能/ 和/ 存储/ 开销/ 进行/ 了/ 分析/ ,/ 但是/ 对于/ 流表/ 本身/ 的/ 查询/ 性能/ 反而/ 没有/ 做/ 深入研究/ ,/ 而且/ 所/ 采用/ 的/ 实验/ 数据/ 集中/ 网络/ 流/ 规模/ 只有/ 6.5/ 万条/ 左右/ ,/ 与/ 当前/ 实际/ 网络/ 环境/ 的/ 状况/ 存在/ 比较/ 大/ 的/ 差异/ ./ 流量/ 监控/ 、/ 状态/ 防火墙/ 、/ 入侵/ 防御/ 、/ 网络地址/ 转换/ (/ NAT/ )/ 、/ 负载/ 分流/ 等等/ 复杂/ 业务/ 的/ 网络/ 会话表/ 也/ 通常/ 采用/ 散/ 列表/ 的/ 结构/ ,/ 在/ 高速/ 网络/ 环境/ 中/ 往往/ 存在/ 比较严重/ 的/ 性能/ 问题/ ./ 开源/ 项目/ Netfilter/ [/ 12/ ]/ 基于/ 散/ 列表/ 结构/ 实现/ 了/ 一个/ 比较/ 典型/ 的/ 面向/ 网络/ 在线/ 业/ Page4/ 务/ 的/ 会/ 话/ 管理机制/ Conntrack/ ,/ 具有/ 良好/ 的/ 业务/ 可扩展性/ ,/ 但是/ 由于/ 存在/ 如下/ 一些/ 问题/ 而/ 导致/ 其/ 性能/ 表现/ 相当/ 不/ 尽如人意/ :/ (/ 1/ )/ 采用/ 表级/ 全局/ 锁/ 进行/ 会话表/ 的/ 读写/ 互斥/ ,/ 这种/ 大/ 粒度/ 的/ 锁/ 机制/ 造成/ 了/ 严重/ 的/ 性能/ 瓶颈/ ;/ (/ 2/ )/ 会话表/ 的/ 查询/ (/ 快/ 通道/ 任务/ )/ 与会/ 话/ 记录/ 的/ 添加/ 、/ 删除/ (/ 慢/ 通道/ 任务/ )/ 串行/ 执行/ ,/ 导致/ 大量/ 报文/ 的/ 执行/ 路径/ 过长/ ,/ 不仅/ 使得/ 系统/ 吞吐量/ 受到/ 很大/ 影响/ ,/ 而且/ 会/ 带来/ 处理/ 时延/ 的/ 抖动/ 问题/ ;/ (/ 3/ )/ 没表/ 1NetfilterConntrack/ 的/ 性能/ (/ 桥/ 转发/ 模式/ ,/ 报文/ 大小/ 1024/ 字节/ )/ 启用/ NetfilterConntrack/ 前/ 启用/ NetfilterConntrack/ 后/ 为了/ 提高/ 散/ 列表/ 的/ 查询/ 命中率/ 、/ 减少/ 查询/ 开销/ ,/ 文献/ [/ 18/ ]/ 采用/ 计数/ 型/ Bloomfilter/ 对散/ 列表/ 进行/ 改进/ ,/ 其/ 基本/ 思想/ 是/ :/ 为/ 每个/ 散列桶/ 维护/ 一个/ 计数器/ (/ 可/ 保存/ 在/ 片/ 上/ 多通道/ SRAM/ 等/ 高速/ 存储器/ 件/ 中/ )/ ;/ 添加/ 记录/ 时/ ,/ 将/ 关键码/ 输入/ 到/ k/ 个/ 散列/ 函数/ 中/ 进行/ 计算/ 得到/ 散列/ 索引/ ,/ 然后/ 修改/ 散列/ 索引/ 对应/ 的/ 计数器/ 并/ 将/ 记录/ 插入/ 到/ 对应/ 的/ 散列桶/ 或者/ 计数/ 最小/ 的/ 散列桶/ 中/ ;/ 查询/ 时先/ 判断/ 散/ 列表/ 中/ 是否/ 已/ 存在/ 对应/ 的/ 记录/ (/ 即/ 报文/ 关键码/ 对应/ 的/ k/ 个/ 散列桶/ 的/ 计数器/ 均/ 不/ 为/ 零/ )/ 后/ ,/ 再/ 在/ 散列桶/ 中/ 执行/ 顺序/ 匹配/ ,/ 找到/ 对应/ 的/ 记录/ ./ 这种/ 方法/ 虽然/ 减少/ 了/ 散/ 列表/ 查询/ 失败/ 次数/ ,/ 但是/ 以/ 牺牲/ 增量/ 更新/ 的/ 效率/ 为/ 代价/ ,/ 导致/ 每次/ 添加/ 和/ 删除/ 操作/ 都/ 需要/ 对/ k/ 个/ 散列桶/ 中/ 的/ 所有/ 记录/ 进行/ 扫描/ 处理/ ./ 文献/ [/ 26/ ]/ 则/ 针对/ 快速/ 报文/ 分类/ 转发/ 业务/ ,/ 提出/ 在/ 查询/ 散/ 列表/ 之前/ 先/ 进行/ 端口/ 比较/ 和/ 端口/ 匹配/ :/ 通过/ 端口/ 比较/ ,/ 将/ 生命周期/ 较/ 短/ 的/ 流/ 识别/ 出来/ ,/ 直接/ 进行/ 过滤/ 匹配/ 而/ 无需/ 保存/ 记录/ ,/ 以/ 节省/ 存储空间/ ;/ 通过/ 端口/ 匹配/ ,/ 对散/ 列表/ 中/ 是否/ 存在/ 对应/ 的/ 记录/ 进行/ 初步判断/ ,/ 以/ 减少/ 查询/ 失败/ 次数/ ./ 为了/ 更好/ 地/ 利用/ 存储空间/ 并/ 避免/ 查表/ 时间/ 开销/ 的/ 抖动/ ,/ 文献/ [/ 22/ ]/ 采用/ d/ -/ left/ 散列/ 对/ 散/ 列表/ 进行/ 负载/ 均衡/ ,/ 即将/ 散/ 列表/ 切/ 分成/ d/ 个/ 相同/ 大小/ 的/ 子表/ ,/ 散列桶/ 大小/ 固定/ ,/ 采用/ 一个/ 小/ 的/ TCAM/ (/ TernaryContentAddressableMemory/ )/ 来/ 处理/ 溢出/ ,/ 每个/ 子表/ 对应/ 独立/ 的/ 散列/ 函数/ ,/ 添加/ 记录/ 时/ 从/ 各/ 子表/ 对应/ 的/ 散列桶/ 中/ 选择/ 负载/ 最小/ 的/ 那个/ 散列桶/ ./ 这种/ 方法/ 虽然/ 比/ 计数/ 型/ Bloomfilter/ 占用/ 更少/ 的/ 存储空间/ ,/ 但是/ 在/ 进行/ 查询/ 操作/ 时/ 需要/ 同时/ 对/ d/ 个子/ 表/ 进行/ 查询/ ./ 为了/ 降低/ 散/ 列表/ 的/ 碰撞/ 率/ 、/ 减少/ 散列/ 函数/ 的/ 计算/ 开销/ ,/ JenkinsJr/ 对/ 散列/ 算法/ 进行/ 了/ 研究/ ,/ 提出/ 了/ 一种/ 针对/ IP地址/ 和/ TCP/ // UDP/ 端口/ 的/ 散列/ 算法/ 有/ 考虑/ 和/ 利用/ 软硬件/ 平台/ 的/ SMP/ (/ SymmetricalMultiprocessing/ )/ 、/ 硬件/ 多线程/ 、/ 多核/ 、/ 内核/ 多线程/ 以及/ 多通道/ 内存/ 等/ 并行/ 机制/ 来/ 改善/ 性能/ ./ 表/ 1/ 给出/ 了/ 采用/ 双核/ IntelXeon1/ ./ 86GHz/ 处理器/ 的/ Linux/ 系统/ 在/ 启用/ NetfilterConntrack/ 前后/ 桥/ 转发/ 的/ 性能/ 变化/ 情况/ ,/ 可以/ 看出/ ,/ 启用/ NetfilterConntrack/ 后/ 系统/ 支持/ 的/ 最大/ 并发/ 会话/ 速率/ 下降/ 了/ 59.78/ %/ ,/ 吞吐量/ 下降/ 了/ 63.78/ %/ ,/ 而/ CPU/ 负载/ 则/ 增加/ 了/ 一个/ 数量级/ ./ 28.2/ // 235.810/ ./ 2/ // 85.4/ (/ jhash/ )/ [/ 27/ ]/ 并/ 已/ 被/ Linux/ 内核/ 所/ 采纳/ ./ Xu/ 等/ 人/ 则/ 研究/ 了/ 适合/ 于/ 动态/ 组/ 关联/ 硬件/ 流表/ 的/ 散列/ 算法/ ,/ 对位/ 提取/ (/ bitextraction/ )/ 、/ 线性/ 散列/ 函数/ 、/ CRC/ 、/ Rabin/ 散列/ 函数/ 和/ H3/ 等/ 散列/ 算法/ 进行/ 了/ 比较/ 分析/ ,/ 指出/ H3/ 算法/ 适于/ 硬件/ 实现/ 且/ 具有/ 良好/ 的/ 性能/ [/ 5/ ]/ ./ 综上所述/ ,/ 高速/ 网络/ 环境/ 中/ 网络/ 业务/ 的/ 会/ 话/ 管理机制/ 面临/ 着/ 业务/ 弹性/ 与/ 处理/ 性能/ 两个/ 方面/ 的/ 挑战/ ./ 实际/ 的/ 应用/ 系统/ 通常/ 为了/ 满足/ 业务/ 的/ 复杂性/ 和/ 灵活性/ 要求/ 而/ 忽视/ 了/ 性能/ ;/ 已有/ 的/ 研究/ 工作/ 则/ 一般/ 着眼于/ 性能/ 而/ 舍弃/ 了/ 业务/ 的/ 弹性/ ,/ 而且/ 往往/ 过于/ 强调/ 局部/ 操作/ 的/ 性能/ (/ 如/ 查询/ 命中率/ )/ ./ 因此/ ,/ 我们/ 将/ 研究/ 的/ 焦点/ 集中/ 于/ 在/ 多/ 核/ // 多线程/ 处理器/ 、/ 软件/ 多/ 进程/ // 多线程/ 等/ 并行执行/ 环境/ 中/ 如何/ 通过/ 并行/ 机制/ 优化/ 会话/ 管理机制/ 性能/ ,/ 并/ 同时/ 保持良好/ 的/ 业务/ 弹性/ ,/ 从/ 已有/ 的/ 文献/ 来看/ ,/ 这方面/ 的/ 研究/ 还/ 开展/ 得/ 比较/ 少/ ./ 3/ 会话表/ 设计/ 3.1/ 会话表/ 结构/ 如图/ 2/ 所示/ ,/ PaSeM/ 采用/ 与/ Netfilter/ [/ 12/ ]/ 相似/ 的/ 、/ 基于/ 散/ 列表/ 的/ 会话表/ 结构/ ,/ 散/ 列表/ 长度/ 为/ L/ ,/ 散列桶/ 为/ 单向/ 链表/ 结构/ ,/ 采用/ 拉链/ 法/ 解决/ 散列/ 碰撞/ ./ 为了/ 实现/ 访问/ 并行/ ,/ 散/ 列表/ 和/ 散列桶/ 均/ 不设/ 访问/ 互斥/ 锁/ ./ Page5/ 每条/ 会/ 话/ 记录/ 同时/ 存在/ 于/ 两个/ 散列桶/ 之中/ ,/ 这/ 主要/ 是/ 考虑/ 到/ 实际/ 应用/ [/ 12/ ,/ 28/ ]/ 中/ 网络地址/ 转换/ 、/ 四层/ 交换/ 、/ 负载/ 分流/ 等/ 业务/ 涉及/ 对/ 报头/ IP地址/ 、/ TCP/ // UDP/ 端口/ 等/ 会/ 话/ 关键/ 码字/ 段/ 的/ 修改/ ,/ 另一方面/ ,/ 会话/ 关键码/ 中/ 也/ 可能/ 包含/ 有/ 诸如/ 输入/ 设备/ 接口/ [/ 12/ ]/ 等/ 与/ 流量/ 相关/ 的/ 信息/ ,/ 导致/ 会话/ 正向/ 关键码/ 和/ 反向/ 关键码/ 分别/ 映射/ 到/ 不同/ 的/ ID/ (/ 即/ 散列/ 索引/ )/ 上/ ./ 3.2/ 回收/ 缓冲区/ 会话/ 记录/ 采用/ 动态存储分配/ ,/ 并/ 设置/ 一个/ 会话/ 记录/ 回收/ 缓冲区/ ,/ 如图/ 3/ 所示/ ,/ 以/ 先进先出/ 队列/ (/ 称为/ to/ -/ be/ -/ freelist/ )/ 的/ 方式/ 进行/ 组织/ ,/ 并/ 设置/ 全局/ 锁/ 实现/ 对/ 缓冲区/ 的/ 读/ // 写/ 互斥/ ./ 缓冲区/ 中/ 最/ 多/ 包含/ Sf/ 条/ 回收/ 的/ 会/ 话/ 记录/ ,/ 当/ 一条/ 会话/ 记录/ 从会话/ 表中/ 删除/ 回收/ 时/ ,/ 暂时/ 先/ 不/ 释放/ 其/ 存储空间/ ,/ 而是/ 放置/ 到/ 缓存/ 区/ 的/ 队尾/ ,/ 直至/ 该条/ 记录/ 到达/ 缓存/ 区队/ 首/ 并且/ 队列/ 长度/ 超过/ 了/ Sf/ 时/ ,/ 才/ 将/ 其/ 从/ 队列/ 中/ 摘除/ 并/ 释放/ 它/ 的/ 存储空间/ ./ Sf/ 可以/ 根据/ 当前/ 会话/ 到达/ 速率/ 、/ 会话表/ 垃圾/ 回收/ 速率/ (/ 稳态/ 下/ ,/ 与会/ 话/ 到达/ 速率/ 一致/ )/ 以及/ 报文/ 的/ 处理/ 时延/ 进行/ 动态/ 调整/ ./ 3.3/ 会话/ 记录/ 和/ 状态机/ 如表/ 2/ 所示/ ,/ 会话/ 记录/ 通常/ 包括/ 如下/ 一些/ 信息/ :/ (/ 1/ )/ 正向/ 关键码/ (/ FK/ )/ 和/ 正向/ 链表/ 指针/ (/ Next/ )/ ,/ 其中/ 关键/ 码字/ 段/ 存储/ 从/ 报头/ 中/ 提取/ 的/ 字/ 段/ 信息/ 或/ 其散/ 列值/ ,/ 链表/ 指针/ 指向/ 散列桶/ 中/ 的/ 下/ 一条/ 会话/ 记录/ ;/ (/ 2/ )/ 反向/ 关键码/ (/ BK/ )/ 和/ 反向/ 链表/ 指针/ (/ reNext/ )/ ;/ (/ 3/ )/ 报文/ 链表/ 头尾/ 指针/ (/ Pktlist/ )/ ,/ 用于/ 在/ 创建/ 会话/ 记录/ 的/ 过程/ 中/ 缓存/ 到达/ 的/ 报文/ ;/ (/ 4/ )/ 状态/ 信息/ ,/ 包括/ 会话/ 记录/ 建立/ 时间/ (/ Starttime/ )/ 、/ 最近/ 报文/ 到达/ 时间/ 戳/ (/ Timestamp/ )/ 、/ 会话/ 状态/ (/ Sessionstate/ )/ 、/ 老化/ 时间/ 间隔/ (/ Agetime/ )/ 、/ 会话/ 记录/ 状态/ (/ Recordstate/ )/ 等/ ;/ (/ 5/ )/ 业务/ 参数/ (/ Actionpara/ )/ 和/ 统计/ 信息/ (/ Statinfo/ )/ ;/ (/ 6/ )/ 互斥/ 写锁/ (/ Wlock/ )/ ,/ 用于/ 对会话/ 记录/ 字段/ 和/ 报文/ 链表/ 的/ 互斥/ 写/ ./ 其中/ ,/ Sessionstate/ 字段/ 保存/ 了/ 会/ 话/ 本身/ 的/ 状态/ 信息/ ,/ 通常/ 与会/ 话/ 的/ 协议/ 类型/ 相关/ ;/ Agetime/ 字段/ 则/ 与会/ 话/ 的/ 协议/ 类型/ 和/ Sessionstate/ 字段/ 密切相关/ ,/ 一般/ 需要/ 针对/ 不同/ 协议/ 类型/ 以及/ 会话/ 的/ 不同/ 状态/ 设置/ 不同/ 的/ 老化/ 时间/ 间隔/ ,/ 以/ 反映/ 特定/ 应用/ 的/ 特点/ 和/ 需求/ ;/ Recordstate/ 字段/ 则/ 保存/ 了/ 会/ 话/ 记录/ 本身/ 的/ 状态/ ,/ 各/ 状态/ 的/ 定义/ 如表/ 2/ 所示/ ./ 字段/ flNext/ 回收/ 缓冲区/ 中/ 下/ 一条/ 会话/ 记录/ 指针/ FK/ 会话/ 正向/ 关键码/ Next/ 正向/ 链表/ 中/ 下/ 一条/ 会话/ 记录/ 指针/ BK/ 会话/ 反向/ 关键码/ reNext/ 反向/ 链表/ 中/ 下/ 一条/ 会话/ 记录/ 指针/ Pktlist/ 报文/ 链表/ 头尾/ 指针/ Starttime/ 会话/ 记录/ 建立/ 时间/ Timestamp/ 最近/ 报文/ 到达/ 时间/ 戳/ Agetime/ 老化/ 时间/ 间隔/ Sessionstate/ 会话/ 状态/ Recordstate/ 会话/ 记录/ 状态/ Actionpara/ 业务/ 参数/ ,/ 如下/ 一条/ 路由/ 、/ 访问控制/ 规则/ ID/ 等/ Statinfo/ 统计/ 信息/ ,/ 如/ 报文/ 技术/ 、/ 平均/ 报文/ 长度/ 等/ WlockPktlist/ 、/ Sessionstate/ 、/ Recordstate/ 、/ Actionpara/ 、/ 定义/ 1/ ./ “/ FREE/ ”/ 状态/ ./ 会话/ 记录/ 在/ 空闲/ 缓冲区/ 中/ ,/ 未/ 被/ 分配/ 使用/ ./ 定义/ 2/ ./ “/ CREATING/ ”/ 状态/ ./ 会话/ 记录/ 正/ 处于/ 创建/ 过程/ 中/ ,/ 还/ 不能/ 正常/ 使用/ ./ 定义/ 3/ ./ “/ WORKING/ ”/ 状态/ ./ 会话/ 记录/ 已/ 创建/ 完毕/ ,/ 可/ 正常/ 使用/ ./ 定义/ 4/ ./ “/ HALF/ -/ DELETED/ ”/ 状态/ ./ 会话/ 记录/ 已经/ 从/ 正向/ 或/ 反向/ 链表/ 中/ 删除/ ,/ 正等待/ 从/ 另/ 一条/ 链表/ 中/ 删除/ 后/ 回收/ ./ 此/ 状态/ 用于/ 会话/ 记录/ 回收/ 过程/ 中/ 正反/ 向/ 两个/ 链表/ 操作/ 的/ 同步/ ./ 4/ 并行/ 无/ 冲突/ 的/ 会/ 话/ 管理/ 4.1/ 基本/ 思想/ PaSeM/ 针对/ 多核/ // 多线程/ 处理器/ 、/ 软件/ 多/ 进程/ // 多线程/ 等/ 并行/ 环境/ ,/ 通过/ 并行/ 机制/ 来/ 实现/ 高效/ 的/ 会/ 话/ 管理/ 和/ 高速/ 网络流量/ 的/ 处理/ ,/ 主要/ 思想/ 包括/ :/ (/ 1/ )/ 通过/ 快慢/ 通道/ 任务/ 分离/ 实现/ “/ 任务/ 并行/ ”/ ./ 即将/ 针对/ 报文/ 的/ 快/ 通道/ 任务/ 和/ 针对/ 会话/ 的/ 慢/ 通道/ 任务/ 分别/ 交给/ 不同/ 的/ 独立/ 运行/ 模块/ 执行/ ,/ 前者/ 主要/ 包括/ 会话表/ 的/ 查询/ 和/ 会/ 话/ 记录/ 字/ 段/ 信息/ 的/ 更新/ ,/ 后者/ 则/ 主/ Page6/ 要/ 涉及/ 会话/ 记录/ 的/ 添加/ 和/ 删除/ 回收/ ;/ (/ 2/ )/ 采用/ 多个/ 处理单元/ (/ PE/ )/ 负责/ 快/ 通道/ 任务/ 的/ 高速/ 并行处理/ ,/ 实现/ “/ 报文/ 并行/ ”/ ./ PE/ 遵循/ 先来/ 先/ 服务/ (/ FCFS/ )/ 的/ 原则/ 处理/ 报文/ ;/ (/ 3/ )/ 采用/ 多个/ PE/ 负责/ 慢/ 通道/ 任务/ 的/ 高速/ 并行处理/ ,/ 将会话/ 表切/ 分成/ 不同/ 的/ 子表/ ,/ 交由/ 不同/ 的/ PE/ 来/ 负责管理/ ,/ 实现/ “/ 会话/ 并行/ ”/ ;/ (/ 4/ )/ 将会/ 话表/ 的/ 不同/ 子表/ 分别/ 放置/ 于/ 多通道/ 存储器/ 件/ 的/ 不同/ 存储单元/ 中/ ,/ 通过/ “/ I/ // O/ 并行/ ”/ 来/ 提高/ 访存/ 效率/ ;/ (/ 5/ )/ 不同/ 模块/ 以及/ 不同/ PE/ 之间/ 采用/ 异步/ 通信/ 机制/ ,/ 通过/ 队列/ (/ ring/ )/ 传递/ 消息/ 或者/ 报文/ ,/ 进一步提高/ 操作/ 的/ 并行度/ ./ 4.2/ PaSeM/ 并行处理/ 框架/ 基于/ 上述/ 基本/ 思想/ ,/ 提出/ PaSeM/ 的/ 处理/ 框架/ ,/ 如图/ 5/ 所示/ ./ 分类/ 查询/ 模块/ (/ CM/ )/ 中/ 包含/ n1/ 个/ PE/ ,/ 图/ 5PaSeM/ 并行处理/ 框架/ 在/ 会/ 话/ 表中/ 添加/ 一个/ 会话/ 记录/ 涉及/ “/ 正向/ ”/ 和/ “/ 反向/ ”/ 两条/ 会话/ 记录/ 链表/ 的/ 插入/ 操作/ ./ CMPE/ 先/ 通过/ 散列/ 索引/ 确定/ 正向/ 会话/ 记录/ 链表/ 的/ 写者/ 是/ 哪个/ MMPE/ ,/ 然后/ 通过/ 该/ MMPE/ 的/ SR/ 队列/ 向/ 其/ 发送/ 一个/ 至少/ 包含/ 报文/ 指针/ 、/ 散列/ 索引/ 信息/ 的/ 消息/ (/ 记为/ MSGnew/ )/ ./ MMPE/ 收到/ 这个/ MSGnew/ 消息/ 后/ ,/ 创建/ 一条/ 会话/ 记录/ 并/ 将/ 其/ 插入/ 正向/ 会话/ 记录/ 链表/ 头/ ,/ 然后/ 再/ 通过/ CR/ 向/ 负责/ 反向/ 会话/ 记录/ 链表/ 插入/ 操作/ 的/ MMPE/ 发送/ 消息/ (/ 记为/ MSGins/ 消息/ )/ ,/ 通知/ 其/ 将/ 会/ 话/ 记录/ 插入/ 反向/ 会话/ 记录/ 链表/ 头/ ./ 同样/ 地/ ,/ 从会话/ 表中/ 删除/ 一条/ 会话/ 记录/ 也/ 需要/ 分成/ 两步/ 完成/ ,/ 两个/ MMPE/ 各自/ 通过/ 检查/ 会话/ 记录/ 状态/ 将会话/ 记录/ 从/ 链表/ 中/ 删除/ ,/ 不/ 需要/ 通过/ 消息/ 通信/ 进行/ 异步/ 协同/ ./ 会话/ 记录/ 的/ 老化/ 回收/ 也/ 由/ MMPE/ 负责/ ./ MMPE/ 定期/ 或/ 不定期/ 对会话/ 表中/ 的/ 会/ 话/ 记录/ 进行/ 扫描/ 检查/ ,/ 将/ 已经/ 超时/ 老化/ 的/ 会/ 话/ 记录/ 删除/ 回收/ ./ 4.3/ 并行/ 冲突/ 为了/ 保证/ 并行/ 逻辑/ 的/ 正确性/ 并/ 取得/ 较/ 好/ 的/ 并行/ 效率/ ,/ 必须/ 解决/ 高速/ 网络/ 环境/ 下/ 的/ 各种/ 并行/ 冲突/ 问题/ ,/ 包括/ 互斥/ 、/ 同步/ 和/ 死锁/ ./ 这些/ PE/ 从/ 输入/ 队列/ (/ RR/ )/ 中取/ 走/ 报文/ ,/ 以/ 报头/ 中/ 包含/ 的/ 关键码/ 信息/ 代入/ 散列/ 函数/ ,/ 根据/ 计算/ 得到/ 的/ 散列/ 索引/ 找到/ 会话/ 表中/ 对应/ 的/ 散列桶/ (/ 会话/ 记录/ 链表/ )/ ,/ 然后/ 将/ 报文/ 的/ 关键码/ 依次/ 与会/ 话/ 记录/ 链表/ 中/ 各会话/ 记录/ 的/ 关键码/ 进行/ 比较/ ,/ 如果/ 关键码/ 相等/ 且会话/ 记录/ 状态/ Recordstate/ 为/ “/ WORKING/ ”/ 或/ “/ CREATING/ ”/ ,/ 则/ 表明/ 找到/ 了/ 报文/ 对应/ 的/ 会/ 话/ 记录/ ,/ 将/ 报文/ 交给/ 后续/ 的/ 业务/ 模块/ 进行/ 处理/ 即可/ ;/ 否则/ ,/ CMP/ E通/ 知会/ 话表/ 管理/ 模块/ (/ MM/ )/ 创建/ 并/ 添加/ 新/ 的/ 会/ 话/ 记录/ ./ MM/ 中/ 同样/ 包含/ n2/ 个/ PE/ ,/ 每个/ PE/ 都/ 拥有/ 自己/ 独立/ 的/ 输入/ 队列/ (/ 记为/ SR1/ ,/ SR2/ ,/ …/ ,/ SRn2/ )/ ,/ 以/ 避免/ 与/ 其他/ MMPE/ 的/ 访问/ 竞争/ ./ 此外/ ,/ 每个/ MMPE/ 还/ 各自/ 拥有/ 一个/ 与/ 其他/ MMP/ E通/ 信用/ 的/ 队列/ (/ CR/ )/ ,/ 记为/ CR1/ ,/ CR2/ ,/ …/ ,/ CRn2/ ./ 4.3/ ./ 1MMPE/ 间/ 写/ 互斥/ 首先/ ,/ MMPE/ 之间/ 存在/ 对散/ 列桶/ 的/ 写/ 互斥/ (/ 即/ 对/ 链表/ 的/ 插入/ 和/ 删除/ 操作/ 互斥/ )/ ,/ 设置/ 会话表/ 的/ 全局/ 锁/ 或/ 散列桶/ 级/ 锁/ 的/ 做法/ 都/ 会/ 造成/ 很大/ 的/ 性能/ 损失/ ./ 为此/ ,/ PaSeM/ 将会话/ 表切/ 分成/ 若干/ 子表/ ,/ 如图/ 5/ 所示/ ,/ 每个/ MMPE/ 各/ 负责/ 其中/ 一个/ 子表/ 的/ 管理/ ,/ 包括/ 会话/ 记录/ 的/ 插入/ 和/ 删除/ ,/ 以/ 确保/ 每个/ 散列桶/ 都/ 只有/ 固定/ 且/ 唯一/ 的/ 写者/ ./ 4.3/ ./ 2MMPE/ 间通信/ 死锁/ 其次/ ,/ MMPE/ 之间/ 如果/ 不是/ 通过/ CR/ 队列/ 而是/ 通过/ SR/ 队列/ 进行/ 通信/ ,/ 则/ 可能/ 造成/ 死锁/ ./ 设想/ 如下/ 情况/ :/ 有/ 两个/ MMPE/ ,/ PEi/ 和/ PEj/ ,/ 它们/ 各自/ 的/ SRi/ 和/ SRj/ 队列/ 都/ 已/ 满/ ,/ 如果/ PEi/ 要/ 向/ PEj/ 发送/ MSGins/ 消息/ ,/ 必须/ 先/ 等待/ PEj/ 从/ SRj/ 队列/ 中取/ 走/ MSGnew/ 或/ MSGins/ 消息/ ,/ 同样/ PEj/ 向/ PEi/ 发送/ MSGins/ 消息/ 也/ 必须/ 先/ 等待/ PEi/ 从/ SRi/ 队列/ 中取/ 走/ MSGnew/ 或/ MSGins/ 消息/ ,/ 导致/ 这/ 两个/ MMPE/ 进入/ 相互/ 等待/ 的/ 死锁/ 状态/ ./ 为此/ ,/ 如前所述/ ,/ 为/ 每个/ MMPE/ 增设/ 一个/ 独立/ 的/ 通信/ 队列/ CR/ ,/ 并/ 规定/ :/ (/ a/ )/ CR/ 的/ 长度/ 大于/ n2/ γ/ (/ γ/ Page7/ 为/ 大于/ 等于/ 1/ 的/ 常数/ 因子/ )/ ;/ (/ b/ )/ CR/ 队列/ 的/ 优先级/ 高于/ SR/ 队列/ ,/ 即/ MMPE/ 必须/ 优先/ 处理/ CR/ 队列/ 中/ 的/ MSGins/ 消息/ ;/ (/ c/ )/ MMPE/ 每次/ 只能/ 从/ SR/ 队列/ 中取/ 走/ 并/ 处理/ 一个/ MSGnew/ 消息/ ./ 下面/ 给出/ 无/ 死锁/ 证明/ ./ 证明/ ./ 采用/ 反证法/ 证明/ ./ 如果/ 发生/ 了/ 死锁/ ,/ 则/ 存在/ 一个/ 由/ m/ 个/ (/ 2/ / m/ / n2/ )/ MMPE/ 组成/ 的/ 封闭/ 环路/ ,/ 它们/ 的/ CR/ 队列/ 都/ 已/ 满/ ,/ 且/ 每个/ MMPE/ 都/ 因为/ 试图/ 向/ 环路/ 中/ 它/ 的/ 前驱/ MMPE/ 的/ CR/ 队列/ 发送/ MSGins/ 消息/ 而/ 进入/ 等待/ 状态/ ./ 注意/ 到/ MSGins/ 消息/ 是/ 在/ 处理/ MSGnew/ 消息/ 的/ 过程/ 中/ 产生/ 的/ ,/ 因此/ 只有/ 在/ 此/ 过程/ 中/ MMPE/ 才/ 可能/ 进入/ 死锁/ 状态/ ./ 设/ PEm/ 为/ 在/ 时刻/ tm/ 最后/ 一个/ 进入/ 等待/ 状态/ 的/ MMPE/ ,/ 它/ 进入/ 等待/ 状态/ 前/ 最后/ 一次/ 从/ SRm/ 队列/ 取走/ MSGnew/ 消息/ 的/ 时刻/ 为/ tm/ ./ PEk/ 为/ 封闭/ 环路/ 中/ PEm/ 的/ 后继/ ,/ 它/ 进入/ 等待/ 状态/ 的/ 时刻/ 为/ tk/ ,/ tk/ / tm/ ./ 由/ 限定/ (/ b/ )/ 和/ (/ c/ )/ 可知/ ,/ 只有/ 在/ tm/ 时刻/ CRm/ 为/ 空时/ ,/ PEm/ 才能/ 从/ SRm/ 队列/ 中取/ 走/ 一个/ MSGnew/ 消息/ 进行/ 处理/ ./ 由此可知/ tk/ 必定/ 落/ 在/ [/ tm/ ,/ tm/ ]/ 区间/ 内/ ,/ 且/ CRm/ 必须/ 在/ [/ tm/ ,/ tk/ ]/ 区间/ 内/ 被/ 填满/ ,/ 否则/ PEk/ 就/ 不能/ 在/ tk/ 时刻/ 进入/ 等待/ 状态/ ./ 设/ MMPE/ 从/ SR/ 队列/ 中取/ 走/ 一个/ MSGnew/ 消息/ 进行/ 处理/ 到/ 向/ CR/ 队列/ 发送/ MSGins/ 消息/ 所/ 费时间/ 的/ 下限/ 和/ 上限/ 分别/ 为/ Ta/ 和/ Tb/ (/ Ta/ / Tb/ ,/ 且/ Tb/ // Ta/ =/ γ/ )/ ,/ 即/ 一个/ MMPE/ 往/ CR/ 队列/ 发送/ MSGins/ 消息/ 的/ 时间/ 间隔/ 至少/ 为/ Ta/ ./ 从而/ 有/ 与/ 限定/ 条件/ (/ a/ )/ 矛盾/ ./ 因此/ 不会/ 产生/ 死锁/ ./ 证毕/ ./ 4.3/ ./ 3CMPE/ 与/ MMPE/ 间/ 读写/ 互斥/ CMPE/ 与/ MMPE/ 之间/ 同样/ 存在/ 对会话/ 记录/ 链表/ 的/ 读写/ 互斥/ ,/ 为此/ 在/ 执行/ 链表/ 插入/ 和/ 删除/ 操作过程/ 中/ 通过/ “/ 写/ ”/ 原子/ 指令/ 和/ 严格/ 规定/ 的/ 指令/ 次序/ 确保/ 对于/ CMPE/ (/ 读者/ )/ 来说/ 任一/ 时刻/ 链表/ 结构/ 的/ 完整性/ ./ 如果/ MMPE/ (/ 写者/ )/ 要/ 在/ 会/ 话/ 记录/ A/ 和/ C/ 之间/ 插入/ 一个/ 新/ 的/ 会/ 话/ 记录/ B/ ,/ 则/ 应先/ 读取/ A/ 的/ Next/ // reNext/ 字段/ (/ 即/ C/ 的/ 地址/ )/ ,/ 然后/ 用/ “/ 写/ ”/ 原子/ 指令/ 将/ 读取/ 的/ 值/ 填入/ B/ 的/ Next/ // reNext/ 字段/ ,/ 再用/ “/ 写/ ”/ 原子/ 指令/ 将/ B/ 的/ 地址/ 填入/ A/ 的/ Next/ // reNext/ 字段/ ./ 同理/ ,/ 当要/ 删除/ 会话/ 记录/ A/ 和/ C/ 之间/ 的/ 会/ 话/ 记录/ B/ 时/ ,/ 首先/ 应/ 读取/ B/ 的/ Next/ // reNext/ 字段/ (/ 即/ C/ 的/ 地址/ )/ ,/ 然后/ 用/ “/ 写/ ”/ 原子/ 指令/ 将/ 读取/ 的/ 值/ 写入/ A/ 的/ Next/ // reNext/ 字段/ ./ 此外/ ,/ 在/ 从/ 链表/ 中/ 删除/ 会话/ 记录/ B/ 的/ 过程/ 中/ ,/ 可能/ 有/ 一些/ CMPE/ 正在/ 读取/ B/ 的/ 信息/ (/ 如/ 查询/ 链表/ 时/ 正好/ “/ 经过/ ”/ B/ )/ ,/ 而/ 将/ B/ 删除/ 回收/ 后/ 仍然/ 可能/ 存在/ 一些/ 正/ “/ 使用/ ”/ B/ 的/ 报文/ 还/ 没有/ 处理/ 完/ ./ 为了/ 减少/ 不必要/ 的/ 互斥/ 开销/ 并/ 防止/ 产生/ 脏/ 数据/ ,/ B/ 删除/ 后/ 将/ 先/ 暂时/ 存入/ 会话/ 记录/ 回收/ 缓冲区/ 中/ ,/ 并且/ 不/ 释放/ 内存空间/ ,/ 也/ 不/ 清空/ 其中/ 的/ 数据/ (/ 包括/ Next/ // reNext/ 字段/ )/ ,/ 而是/ 等到/ B/ 被/ 移出/ 会话/ 记录/ 回收/ 缓冲区/ 时/ 再/ 执行/ 清空/ 和/ 释放/ 内存空间/ 的/ 操作/ ./ 为了/ 给/ 上述/ 对/ B/ 的/ 访问/ 留出/ 足够/ 多/ 的/ 时间/ ,/ 设置/ 会话/ 记录/ 回收/ 缓冲区/ 大小/ 的/ 阈值/ Sf/ ,/ 如图/ 3/ 所示/ ,/ 使得/ 会话/ 记录/ 回收/ 缓冲区/ 中/ 一直/ 保留/ 有/ Sf/ 个/ 回收/ 的/ 会/ 话/ 记录/ ,/ 从而/ 保证/ B/ 被/ 回收/ 后/ 不会/ 即刻/ 被/ 重新分配/ 出去/ ./ 稳态/ 下/ ,/ Sf/ 的/ 取值/ 与会/ 话/ 到达/ 速率/ 以及/ CMPE/ 处理/ 报文/ 的/ 服务/ 时间/ 相关/ ./ 4.3/ ./ 4/ 重复/ 的/ MSGnew/ 消息/ 快慢/ 通道/ 任务/ 并行/ 的/ 策略/ 以及/ CMPE/ 与/ MMPE/ 之间/ 的/ 异步/ 消息/ 通信/ 机制/ 还/ 可能/ 导致/ 产生/ 重复/ 的/ MSGnew/ 消息/ ./ UDP/ 或/ ICMP/ 等/ 非/ 连接/ 通信/ 、/ TCP/ 报文/ 重传/ 或者/ “/ 洪泛/ ”/ 攻击/ 等/ 都/ 有/ 可能/ 使得/ 会话首/ 报文/ 与/ 同方向/ 后续/ 报文/ 之间/ 到达/ 间隔/ 过/ 小/ ,/ MMPE/ 来不及/ 创建/ 会话/ 记录/ 并/ 将/ 其/ 插入/ 正向/ 会话/ 记录/ 链表/ ,/ 从而/ 导致/ CMPE/ 连续/ 发送/ 相同/ 的/ MSGnew/ 消息/ 给/ MMPE/ ./ 由于/ 散列桶/ 的/ 写者/ 固定/ 且/ 唯一/ ,/ 因此/ 重复/ 的/ MSGnew/ 消息/ 依然/ 会/ 按照/ 先后/ 次序/ 交由/ 同一个/ MMPE/ 处理/ ./ 为此/ ,/ MMPE/ 需要/ 在/ 处理/ 每个/ MSGnew/ 消息/ 前/ 确认/ 一下/ 链表/ 中/ 是否/ 已/ 存在/ 对应/ 的/ 会/ 话/ 记录/ ,/ 如果/ 已经/ 存在/ ,/ 则/ 丢弃/ 重复/ 的/ MSGnew/ 消息/ ./ 由于/ 新会话/ 记录/ 总是/ 插入/ 会话/ 记录/ 链表/ 的/ 头部/ ,/ 因此/ 重复/ 消息/ 的/ 查询/ 开销/ 基本/ 可以/ 忽略不计/ ./ 另一方面/ ,/ 反向/ 报文/ 与会/ 话首/ 报文/ 之间/ 存在/ 协议/ 交互/ 时延/ ,/ 足够/ 让/ 系统/ 完成/ 添加/ 会话/ 记录/ 的/ 工作/ ,/ 因此/ 会话/ 的/ 反向/ 流量/ 通常/ 不会/ 触发/ 重复/ 的/ MSGnew/ 消息/ ./ 4.3/ ./ 5/ 包序/ 控制/ 最后/ ,/ 并行处理/ 还会/ 带来/ 报文/ 的/ 包序/ 控制/ 问题/ ./ 为了/ 保证/ 输入/ 和/ 输出/ 的/ 报文/ 次序/ 一致/ ,/ 在/ 创建/ 和/ 添加/ 会话/ 记录/ 时/ PaSeM/ 将/ 已经/ 到达/ 的/ 报文/ 按照/ 先后/ 次序/ 缓存/ 到/ Pktlist/ 链表/ 中/ ,/ 等待/ 会话/ 记录/ 添加/ 完成/ 后/ 再/ 按照/ 次序/ 将/ 报文/ 交给/ 后继/ 的/ 业务/ 模块/ 处理/ ,/ 从而/ 保证/ 在/ 这个/ 阶段/ 中会/ 话/ 的/ 报文/ 次序/ ./ 在/ 快/ 通道/ 任务/ 执行/ 阶段/ ,/ 由于/ CM/ 对/ 输入/ 的/ 报文/ 采取/ FCFS/ 的/ 策略/ ,/ 且/ 快/ 通道/ 任务/ 相对/ 比较简单/ 且/ 执行/ 分支/ 少/ ,/ 各/ 执行/ 分支/ 的/ 时间/ 开销/ 粒度/ 通常/ 比较/ 均匀/ ,/ 属于/ 同一/ Page8/ 条流/ 的/ 报文/ 的/ 处理/ 时间/ 不会/ 有太大/ 波动/ ,/ 因此/ CM/ 基本/ 能够/ 保持/ 同/ 一条/ 会话/ 同方向/ 的/ 报文/ 次序/ ./ 4.4/ 并行/ 查询/ 算法/ 会话表/ 的/ 并行/ 查询/ 算法/ 如下/ ./ 算法/ 1/ ./ 会话表/ 并行/ 查询/ 算法/ ./ h/ :/ 散列/ 函数/ ,/ L/ :/ 散/ 列表/ 长度/ R/ ./ key/ :/ 会话/ 记录/ 中/ 的/ FK/ 或/ BK/ 字段/ 1/ ./ forallCMPEPi/ ,/ i/ =/ 1/ ,/ 2/ ,/ …/ ,/ n12/ ./ 从/ 队列/ RR/ 中/ 取出/ 一个/ 报文/ PK3/ ./ j/ ←/ h/ (/ PK/ ./ key/ )/ %/ L4/ ./ for/ 散列桶/ bucket/ [/ j/ ]/ 中/ 的/ 每个/ 会话/ 记录/ R5/ ./ if/ (/ R/ ./ key/ =/ PK/ ./ key/ )/ then6/ ./ 获得/ R/ ./ Wlock/ 锁/ ,/ rs/ ←/ R/ ./ Recordstate7/ ./ if/ (/ rs/ =/ WORKING/ )/ then8/ ./ 更新/ R/ ./ Sessionstate/ ,/ R/ ./ Timestamp/ ,/ 9/ ./ elseif/ (/ rs/ =/ CREATING/ )/ then10/ ./ 将/ 报文/ PK/ 插入/ R/ ./ Pktlist/ 链表/ 尾/ 11/ ./ endif12/ ./ 释放/ R/ ./ Wlock/ 锁/ 13/ ./ if/ (/ rs/ ≠/ CREATING/ )/ then/ 将/ 报文/ 交给/ 后/ 14/ ./ exit15/ ./ endif16/ ./ endfor17/ ./ if/ (/ 在/ bucket/ [/ j/ ]/ 中/ 找/ 不到/ 对应/ 的/ 会/ 话/ 记录/ )/ 18/ ./ k/ ←/ j/ %/ n2/ // // 计算/ 该散/ 列桶/ 对应/ 的/ MMPE/ 编号/ 19/ ./ 向/ 队列/ SRk/ 发送/ 一个/ 包含/ j/ 和/ PK/ 指针/ 的/ 20/ ./ endif21/ ./ Endforall/ 各个/ CMPE/ 从/ 队列/ RR/ 中/ 取出/ 报文/ ,/ 根据/ 报文/ 的/ 关键码/ 查询/ 会话表/ ./ 如果/ 查询/ 命中/ (/ hitting/ )/ ,/ 则/ 将/ 报文/ 交给/ 后继/ 业务/ 模块/ ,/ 根据/ 会话/ 记录/ 的/ Recordstate/ 字段/ 执行/ 不同/ 的/ 处理/ ./ 当/ Recordstate/ 为/ “/ HALF/ -/ DELETED/ ”/ 或/ “/ FREE/ ”/ 时/ ,/ 表明/ 有/ MMPE/ 正在/ 执行/ 或/ 已经/ 完成/ 该会/ 话/ 记录/ 的/ 删除/ 回收/ 操作/ ,/ 不过/ 会话/ 记录/ 的/ 数据/ 还/ 暂时/ 不会/ 被/ 清空/ ,/ 因此/ 并/ 不会/ 影响/ 到/ CMPE/ 的/ 执行/ ./ 如果/ 查询/ 失败/ (/ missing/ )/ ,/ 则/ CMPE/ 向/ 对应/ 的/ MMPE/ 发送/ MSGnew/ 消息/ ,/ 创建/ 和/ 添加/ 新/ 的/ 会/ 话/ 记录/ ./ 各个/ CMPE/ 之间/ 的/ 查询/ 操作/ 可以/ 完全/ 并行/ ,/ CMPE/ 与/ MMPE/ 之间/ 也/ 没有/ 散列桶/ 的/ 互斥/ 读写/ 问题/ ,/ 两类/ PE/ 可以/ 各自/ 并行/ 无/ 冲突/ 地/ 工作/ ./ 整个/ 过程/ 中/ 只有/ 在/ 修改/ 会话/ 记录/ 的/ 状态/ 和/ 统计/ 信息/ 以及/ 报文/ 链表/ Pktlist/ 时/ ,/ 才/ 需要/ 加上/ 写锁/ ./ 4.5/ 会话表/ 的/ 动态/ 管理/ MMPE/ 按照/ 优先/ 处理/ CR/ 队列/ (/ 每次/ 处理/ 完/ 队列/ 中/ 的/ 所有/ MSGins/ 消息/ )/ 、/ 其次/ 处理/ SR/ 队列/ (/ 每次/ 处理/ 1/ 个/ MSGnew/ 消息/ )/ 、/ 最后/ 执行/ 垃圾/ 回收/ (/ 扫描/ 会话表/ 、/ 删除/ 回收/ 过期/ 会话/ 记录/ )/ 操作/ 的/ 次序/ 循环/ 工作/ ,/ 算法/ 如下/ ./ 算法/ 2/ ./ 会话表/ 动态/ 管理/ 算法/ ./ R/ :/ MSGins/ 消息/ 所/ 指向/ 的/ 会/ 话/ 记录/ j/ :/ MSGins/ 消息/ 所/ 指向/ 的/ 反向/ 会话/ 记录/ 链表/ (/ 散列桶/ )/ 的/ 1/ ./ forallMMPEQi/ ,/ i/ =/ 1/ ,/ 2/ ,/ …/ ,/ n22/ ./ while/ (/ 队列/ CRi/ 非空/ )/ 3/ ./ 从/ 队列/ CRi/ 中取/ 走/ 一个/ MSGins/ 消息/ ,/ 4/ ./ 将会话/ 记录/ R/ 插入/ 散列桶/ bucket/ [/ j/ ]/ 的/ 链表/ 5/ ./ endwhile6/ ./ if/ (/ 队列/ SRi/ 非空/ )/ then7/ ./ 从/ 队列/ SRi/ 中取/ 走/ 一个/ MSGnew/ 消息/ 8/ ./ 执行/ 会话/ 记录/ 的/ 创建/ 和/ 添加/ 操作/ 9/ ./ else10/ ./ 执行/ 扫描/ 会话表/ 、/ 删除/ 回收/ 过期/ 会话/ 记录/ 的/ 11/ ./ endif12/ ./ endforallMMPE/ 利用/ “/ 空闲/ ”/ 时间/ 扫描/ 它/ 负责/ 的/ 会/ 话/ 子表/ ,/ 将/ 超过/ 老化/ 期限/ (/ 当前/ 时刻/ —/ Timestamp/ >/ Agetime/ )/ 或者/ Recordstate/ 为/ “/ HALF/ -/ DELETED/ ”/ 的/ 会/ 话/ 记录/ 从会话/ 表中/ 删除/ ,/ 并/ 放置/ 到/ 回收/ 缓冲区/ ./ 为了/ 控制/ 一/ 批次/ 垃圾/ 回收/ 操作/ 开销/ 的/ 粒度/ ,/ 避免/ CR/ 和/ SR/ 队列/ 发生/ 溢出/ ,/ 可/ 指定/ 一次/ 扫描/ 的/ 散列桶/ 个数/ (/ Sr/ )/ ./ 此外/ ,/ 为了/ 控制/ 老化/ 扫描/ 的/ 频率/ 、/ 避免/ 耗费/ 过多/ 的/ I/ // O/ 访存/ 开销/ ,/ 可/ 采取/ 一定/ 的/ 保护措施/ ,/ 如/ 限定/ MMPE/ 扫描/ 一遍/ 会话/ 子表/ 的/ 最小/ 时间/ 间隔/ ./ 4.5/ ./ 1/ 创建/ 添加/ 会话/ 记录/ 在/ 会/ 话/ 表中/ 添加/ 一个/ 会话/ 记录/ 涉及/ 到/ 正向/ 和/ 反向/ 两条/ 会话/ 记录/ 链表/ 的/ 插入/ 操作/ ,/ 需要/ 分别/ 由/ 对应/ 的/ 两个/ MMPE/ (/ 记为/ PEi/ 、/ PEj/ )/ 来/ 完成/ ./ PEi/ 先/ 创建/ 新/ 的/ 会/ 话/ 记录/ 并/ 将/ 其/ 插入/ 到/ 正向/ 会话/ 记录/ 链表/ 中/ ,/ 然后/ 通过/ CRj/ 向/ PEj/ 发送/ MSGins/ 消息/ ,/ 由/ PEj/ 将会话/ 记录/ 插入/ 反向/ 会话/ 记录/ 链表/ ./ 完整/ 的/ 算法/ 如下/ ./ 算法/ 3/ ./ 创建/ 添加/ 会话/ 记录/ ./ PK/ :/ MSGnew/ 消息/ 所/ 指向/ 的/ 报文/ k/ :/ MSGnew/ 消息/ 所/ 指向/ 的/ 正向/ 会话/ 记录/ 链表/ (/ 散列桶/ )/ Page9l/ :/ MSGins/ 消息/ 所/ 指向/ 的/ 反向/ 会话/ 记录/ 链表/ (/ 散列桶/ )/ 的/ h/ :/ 散列/ 函数/ ,/ L/ :/ 散/ 列表/ 长度/ 1/ ./ PEi/ 从/ 队列/ SRi/ 中取/ 走/ 一个/ MSGnew/ 消息/ 2/ ./ if/ (/ 查询/ bucket/ [/ k/ ]/ 找到/ 对应/ 的/ 会/ 话/ 记录/ )/ then3/ ./ 忽略/ 重复/ 的/ MSGnew/ 消息/ ,/ 根据/ 会话/ 记录/ 对/ PK4/ ./ endif5/ ./ 创建/ 一个/ 新/ 的/ 会/ 话/ 记录/ R6/ ./ R/ ./ FK/ ←/ PK/ ./ key/ ,/ R/ ./ Recordstate/ ←/ CREATING7/ ./ R/ ./ Starttime/ ,/ R/ ./ Timestamp/ ←/ now8/ ./ 将/ PK/ 插入/ R/ ./ Pktlist/ 链表/ 尾部/ 9/ ./ 将会话/ 记录/ R/ 插入/ 散列桶/ bucket/ [/ k/ ]/ 的/ 链表/ 头部/ 10/ ./ 填写/ 会话/ 记录/ R/ 的/ 其它/ 字段/ 11/ ./ l/ ←/ h/ (/ R/ ./ BK/ )/ %/ L/ ,/ j/ ←/ l/ %/ n212/ ./ 向/ CRj/ 队列/ 发送/ 一个/ 包含/ l/ 和/ R/ 的/ 指针/ 的/ MSGins13/ ./ 获得/ R/ ./ Wlock/ 锁/ 14/ ./ 从头至尾/ 依次/ 释放/ 并/ 处理/ R/ ./ Pktlist/ 链表/ 中/ 的/ 报/ 15/ ./ R/ ./ Recordstate/ ←/ WORKING16/ ./ 释放/ R/ ./ Wlock/ 锁/ 为了/ 检查/ 重复/ 的/ MSGnew/ 消息/ ,/ MMPE/ 需要/ 先/ 查询/ 一次/ 散列桶/ (/ 见/ 算法/ 第/ 2/ 步/ )/ ,/ 如果/ 散列桶/ 已经/ 存在/ 对应/ 的/ 会/ 话/ 记录/ ,/ 则/ 可知/ 当前/ 的/ MSGnew/ 消息/ 为/ 重复/ 发送/ 的/ 消息/ ./ 由于/ 新建/ 的/ 会/ 话/ 记录/ 总是/ 插入/ 到/ 散列桶/ 会/ 话/ 记录/ 链表/ 的/ 头部/ ,/ 因此/ 重复/ 的/ MSGnew/ 消息/ 的/ 处理/ 开销/ 很小/ ,/ 基本/ 可以/ 忽略不计/ ./ 而/ 对于/ 非/ 重复/ 的/ MSGnew/ 消息/ ,/ 考虑/ 到/ 会/ 话/ 首/ 报文/ 的/ 数量/ 通常/ 在/ 总流量/ 中/ 只/ 占/ 较/ 小/ 的/ 比例/ ,/ 因此/ 多余/ 一轮/ 会话/ 记录/ 链表/ 的/ 扫描/ 查询/ 开销/ 还是/ 可以/ 承受/ 的/ ./ 在/ 创建/ 一个/ 新/ 的/ 会/ 话/ 记录/ 时/ ,/ 如果/ 存储空间/ 不足/ ,/ 可以/ 采取/ 丢弃/ 报文/ 的/ “/ 抑制/ ”/ 策略/ ./ 从/ 安全性/ 的/ 角度/ 来/ 考虑/ ,/ 对于/ 过载/ 的/ 流量/ 通常/ 都/ 采取/ 丢弃/ 的/ 做法/ ./ 如果/ 是/ 正常/ 的/ 突发/ 业务/ 流量/ 导致/ 的/ 网络/ 会话/ 激增/ ,/ 则/ TCP/ 协议/ 的/ 重传/ 机制/ 可/ 保证/ 峰值/ 过后/ 业务/ 会话/ 仍然/ 能够/ 正常/ 建立/ ;/ 如果/ 是/ 由于/ 拒绝服务/ 攻击/ 所/ 导致/ 的/ ,/ 则/ 这种/ 策略/ 在/ 一定/ 程度/ 上/ 能够/ 起到/ 类似/ 于/ “/ 首/ 报文/ 丢弃/ ”/ 的/ 防御/ 效果/ ./ 4.5/ ./ 2/ 删除/ 回收/ 会话/ 记录/ 同理/ ,/ 在/ 会/ 话/ 表中/ 删除/ 回收/ 一个/ 会话/ 记录/ 也/ 需要/ 对/ 正向/ 和/ 反向/ 两条/ 会话/ 记录/ 链表/ 进行/ 操作/ ./ PEi/ 负责/ 将会话/ 记录/ 从/ 一条/ 记录/ 链表/ 中/ 删除/ ,/ PEj/ 负责/ 将会话/ 记录/ 从/ 另/ 一条/ 会话/ 记录/ 链表/ 中/ 删除/ 并/ 回收/ 到/ 会/ 话/ 记录/ 回收/ 缓存/ 区中/ ./ 为了/ 避免/ 死锁/ ,/ PEi/ 执行/ 删除/ 操作/ 后/ 不会/ 向/ PEj/ 发送/ 同步/ 消息/ ,/ 即/ PEi/ 、/ PEj/ 各自/ 通过/ 扫描/ 所/ 负责/ 的/ 会/ 话/ 子表/ 完成/ 删除/ 和/ 回收/ 过程/ ./ 这样/ 做/ 虽然/ 会/ 增加/ 过期/ 会话/ 记录/ 删除/ 回收/ 的/ 平均/ 时延/ ,/ 但是/ 并/ 不会/ 增加/ 最坏/ 情况/ 下/ 的/ 时延/ ./ 具体/ 算法/ 如下/ ./ 算法/ 4/ ./ 删除/ 回收/ 会话/ 记录/ ./ i/ :/ MSGnew/ 消息/ 所/ 指向/ 的/ 正向/ 会话/ 记录/ 链表/ (/ 散列桶/ )/ j/ :/ MSGins/ 消息/ 所/ 指向/ 的/ 反向/ 会话/ 记录/ 链表/ (/ 散列桶/ )/ 的/ h/ :/ 散列/ 函数/ ,/ L/ :/ 散/ 列表/ 长度/ 1/ ./ PEi/ 将会话/ 记录/ R/ 从/ 它/ 负责/ 的/ 会/ 话/ 记录/ 链表/ 中/ 2/ ./ 获得/ R/ ./ Wlock/ 锁/ 3/ ./ if/ (/ R/ ./ Recordstate/ =/ HALF/ -/ DELETED/ )/ then4/ ./ R/ ./ Recordstate/ ←/ FREE5/ ./ elseif/ (/ R/ ./ Recordstate/ ≠/ FREE/ )/ 6/ ./ R/ ./ Recordstate/ ←/ HALF/ -/ DELETED7/ ./ endif8/ ./ 释放/ R/ ./ Wlock/ 锁/ 9/ ./ if/ (/ R/ ./ Recordstate/ =/ FREE/ )/ then10/ ./ 将/ R/ 回收/ 到/ 缓冲区/ 中/ ,/ 并/ 保留/ 会话/ 记录/ 的/ 数据/ 11/ ./ if/ (/ 会话/ 记录/ 回收/ 缓存/ 区/ 已/ 满/ )/ then12/ ./ 将/ 缓冲区/ 链表/ 头/ 的/ 会/ 话/ 记录/ 摘除/ ,/ 并/ 释放/ 其/ 13/ ./ endif14/ ./ endif5/ 性能/ 分析/ 评价/ 5.1/ 性能/ 评价/ 模型/ 报文/ 到达/ 具有/ 自/ 相似性/ ,/ 假定/ 报文/ 到达/ 为/ 时间/ 间隔/ 服从/ 均值/ 为/ ab/ // (/ a/ -/ 1/ )/ 、/ 方差/ 为/ ab2/ // [/ (/ a/ -/ 1/ )/ 2/ (/ a/ -/ 2/ )/ ]/ (/ 其中/ a/ >/ 2/ )/ 的/ Pareto/ 分布/ ,/ 报文/ 到达/ 平均/ 速率/ λ/ 1/ =/ (/ a/ -/ 1/ )/ // (/ ab/ )/ ./ 对于/ 会话/ 的/ 首/ 报文/ 和/ 后续/ 报文/ ,/ CMPE/ 在/ 查询/ 会话/ 表时/ 将/ 产生/ 失败/ (/ missing/ )/ 和/ 命中/ (/ hitting/ )/ 两种/ 不同/ 的/ 情况/ ,/ 其/ 服务/ 时间/ 也/ 将/ 遵循/ 两种/ 不同/ 的/ 分布/ ,/ 因而/ CM/ 构成/ 了/ G/ // G2/ // n1/ 型/ 排队/ 系统/ ,/ 如图/ 6/ (/ a/ )/ 所示/ ,/ 其中/ G2/ 表示/ CMPE/ 对于/ RR/ 队列/ 的/ 服务/ 时间/ 独立/ 且/ 服从/ 两类/ 一般/ 概率分布/ ,/ n1/ 为/ CMPE/ 的/ 数目/ ./ 文献/ [/ 5/ ]/ 和/ 文献/ [/ 29/ ]/ 中/ 指出/ ,/ 在/ 骨干网/ 层次/ 观察/ ,/ 网络/ 会话/ 到达/ 和/ 活跃/ 会话/ 数量/ 并/ 没有/ 呈现/ 自/ 相似/ 特性/ ,/ 会话/ 的/ 到达/ 仍然/ 可以/ 视为/ 平均/ 速率/ 为/ λ/ 2/ 的/ 泊松/ 过程/ ,/ 到达/ 时间/ 间隔/ 服从/ 参数/ 为/ 1/ // λ/ 2/ 的/ 负/ 指数/ Page10/ 图/ 6/ 性能/ 评价/ 模型/ 分布/ ./ 假定/ 各/ SR/ 和/ CR/ 队列/ 输入/ 独立/ 同/ 分布/ ,/ 均值/ 为/ λ/ 2/ // n2/ (/ 忽略/ 产生/ 重复/ MSGnew/ 消息/ 的/ 情况/ )/ ,/ 其中/ n2/ 为/ MMPE/ 的/ 数目/ ,/ 亦/ 即/ MSGnew/ 和/ MSGins/ 消息/ 的/ 处理/ 负载/ 将/ 平均/ 分担/ 到/ 各个/ MMPE/ 上/ ./ 由图/ 6/ (/ a/ )/ 可知/ ,/ SR/ 队列/ 的/ 输入/ 为/ G/ // G2/ // n1/ 系统/ 的/ 输出/ ,/ 视其为/ 泊松/ 过程/ ,/ 即/ MSGnew/ 消息/ 的/ 到达/ 时间/ 间隔/ 服从/ 参数/ 为/ n2/ // λ/ 2/ 的/ 负/ 指数分布/ ./ 而/ CR/ 队列/ 的/ 输入/ 取决于/ SR/ 队列/ 的/ 输出/ ,/ 由于/ CR/ 有/ 最高/ 的/ 处理/ 优先级/ ,/ 因此/ CR/ 中/ MSGins/ 消息/ 的/ 等待时间/ 可以/ 忽略不计/ ;/ 又/ ,/ 为/ 方便/ 起/ 见/ ,/ 假定/ 创建/ 添加/ 一条/ 会话/ 记录/ 的/ 工作/ 全部/ 由/ 同一个/ MMPE/ 完成/ ,/ 而/ 不是/ 分/ 由/ 两个/ MMPE/ 负责/ ,/ 由于/ 各/ MMPE/ 之间/ 无/ 差异/ 且/ CR/ 队列/ 的/ 服务/ 时间/ TCR/ 为定/ 长/ 分布/ ,/ 因此/ 这个/ 假定/ 不会/ 对/ 性能/ 评价/ 造成/ 影响/ ./ 综上所述/ ,/ 每个/ MMPE/ 都/ 构成/ 空竭/ 服务/ (/ exhaustiveservice/ )/ 、/ 多重/ 休假/ (/ multiplevacations/ )/ 表/ 3/ 性能/ 评价/ 模型/ 的/ 参数/ 参数/ λ/ 1/ λ/ 2L/ 散/ 列表/ 长度/ d/ 散列桶/ 深度/ Td/ 会话/ 活跃/ 时间/ TxTxrTp/ 读取/ 报文/ 数据/ 的/ 时间/ 开销/ Th/ 计算/ 散列值/ 并/ 读取/ 散/ 列表/ 项/ 的/ 时间/ 开销/ Tb/ 在/ 散列桶/ 中/ 查找/ 一条/ 会话/ 记录/ 的/ 时间/ 开销/ Ta/ 会话/ 老化/ 时间/ 间隔/ Tv/ 执行/ 一/ 批次/ 扫描/ 和/ 回收/ 过期/ 会话/ 记录/ 的/ 时间/ 开销/ (/ 即/ 一次/ “/ 假期/ ”/ 的/ 时长/ )/ TwMMPE/ “/ 忙期/ ”/ 的/ 时长/ Tmv/ 两次/ “/ 忙期/ ”/ 之间/ 多重/ “/ 假期/ ”/ 的/ 时长/ TX/ 队列/ X/ (/ X/ =/ RR/ ,/ SR/ ,/ CR/ )/ 的/ 服务/ 时长/ Sr/ 一次/ “/ 假期/ ”/ 中/ 扫描/ 的/ 散列桶/ 个数/ ,/ 1/ / Sr/ / L/ // n2/ 注/ :/ / (/ 读/ SRAM/ 次数/ ,/ 写/ SRAM/ 次数/ ;/ 读/ SDRAM/ 次数/ ,/ 写/ SDRAM/ 次数/ ;/ 执行/ 指令/ 数/ ,/ 指令/ 的/ 总/ 时钟/ 周期/ 开销/ )/ ,/ 下同/ .#/ Tdf/ =/ 44/ ×/ min/ (/ L/ ,/ 2N/ )/ // (/ 2N/ )/ +/ 70/ ×/ max/ (/ 2N/ -/ L/ ,/ 0/ )/ // (/ 2N/ )/ ./ 通常/ N/ >/ L/ ,/ 因此/ Td/ 的/ M/ // G/ +/ D/ // 1/ 型/ 排队/ 系统/ ,/ 如图/ 6/ (/ b/ )/ 所示/ ,/ 其中/ M/ 表示/ 会话/ 到达/ 过程/ 为泊松/ 分布/ ,/ G/ 表示/ MMPE/ 对于/ SR/ 队列/ 的/ 服务/ 时间/ 独立/ 且/ 服从/ 一般/ 概率分布/ ,/ D/ 表示/ MMPE/ 对于/ CR/ 队列/ 的/ 服务/ 时间/ 服从/ 定/ 长/ 分布/ ./ MMPE/ 只有/ 在/ SR/ 和/ CR/ 队/ 列为/ 空时/ 才能/ 进入/ “/ 休假/ ”/ 期/ (/ 即/ 遵循/ “/ 空竭/ 服务/ ”/ 规则/ )/ ,/ 在/ “/ 休假/ ”/ 期间/ MMPE/ 执行/ 扫描/ 回收/ 过期/ 会话/ 记录/ 的/ 工作/ ,/ 每次/ “/ 休假/ ”/ 时间/ (/ 扫描/ Sr/ 个/ 散列桶/ )/ 为/ 独立/ 于/ 到达/ 和/ 服务/ 过程/ 的/ 独立/ 同/ 分布/ ./ 当/ 一次/ “/ 休假/ ”/ 结束/ 后/ ,/ 若/ SR/ 和/ CR/ 队列/ 仍然/ 为空/ ,/ 就/ 开始/ 另/ 一次/ “/ 休假/ ”/ (/ 即/ 遵循/ “/ 多重/ 休假/ ”/ 规则/ )/ ,/ 对/ 扫描/ 会话/ 子表/ 的/ 频率/ 不/ 做/ 限制/ ;/ 在/ 休假/ 结束/ 时/ ,/ 若/ SR/ 或/ CR/ 队列/ 不为/ 空/ ,/ 就/ 进入/ 新/ 的/ “/ 忙期/ ”/ ./ 性能/ 评价/ 模型/ 的/ 主要参数/ 见表/ 3/ ./ Page115/ ./ 2/ 性能指标/ 主要/ 性能指标/ 如表/ 4/ 所示/ ./ 除了/ 排队模型/ 关注/ 的/ PE/ 数目/ 、/ 队列/ 长度/ 、/ 等待时间/ (/ waitingtime/ )/ 、/ 逗留/ 时间/ (/ sojourntime/ ,/ 即/ 等待时间/ +/ 服务/ 时间/ )/ 等/ 指标/ 外/ ,/ 还/ 包括/ 会话/ 表中会/ 话/ 记录/ 总数/ 和/ 活跃/ 会话/ 记录/ 的/ 数量/ 、/ 垃圾/ 比率/ 、/ 会话/ 记录/ 回收/ 缓冲区/ 大小/ 等/ 指标/ ./ 指标/ n1CMPE/ 数量/ n2MMPE/ 数量/ X/ 队列/ X/ (/ X/ =/ RR/ ,/ SR/ )/ 长度/ ,/ 即/ 在/ 队列/ 中/ 等待/ 的/ 报文/ // 消息/ 数/ LqX/ 队列/ X/ (/ X/ =/ RR/ ,/ SR/ )/ 的/ 等待时间/ WqWX/ 队列/ X/ (/ X/ =/ RR/ ,/ SR/ )/ 的/ 逗留/ 时间/ (/ 等待时间/ +/ 服务/ 时间/ )/ N/ 会话/ 表中会/ 话/ 记录/ 总数/ 均值/ Na/ 会话/ 表中/ 活跃/ 会话/ 记录/ 数量/ 均值/ GR/ 会话表/ 的/ 垃圾/ 比率/ ,/ 即/ (/ N/ -/ Na/ )/ // NaSf/ 会话/ 记录/ 回收/ 缓冲区/ 大小/ 5.3/ 报文/ 处理/ 性能/ 分析/ RR/ 、/ 等待时间/ WqLq/ 量/ n1/ 的/ 下限/ 进行/ 定量分析/ ./ 下面/ 对/ 稳态/ (/ steadystate/ )/ 下/ 队列/ RR/ 的/ 长度/ 给定/ 会话/ 表中/ 的/ 平均/ 会话/ 总数/ N/ ,/ 假设/ 散列桶/ 深/ d/ 服从/ 二项分布/ ,/ 则/ 会/ 话/ 首/ 报文/ 查询/ 时间/ 的/ 概率分布/ 为/ P/ (/ Tb/ =/ xTm2N/ (/ )/ x/ 会话/ 后续/ 报文/ 查询/ 时间/ 的/ 概率分布/ 为/ P/ (/ Tb/ =/ xTm/ 以及/ 采用/ 递推/ 法/ ,/ 可得会/ 话/ 表散/ 列桶/ 深/ d/ 的/ 期望/ :/ E/ (/ d/ )/ =/ ∑/ 2N/ ∑/ 2N/ ∑/ 2N2Nx/ =/ 1x/ =/ 1/ 从而/ 得到/ 会话/ 表散/ 列桶/ 查询/ 时间/ 的/ 概率分布/ 为/ E/ (/ Tb/ |/ missing/ )/ =/ ∑/ 2NE/ (/ Tb/ |/ hitting/ )/ =/ ∑/ 2N/ 以及/ E/ (/ T2b/ |/ missing/ )/ =/ ∑/ 2Nb/ |/ hitting/ )/ =/ ∑/ 2N2N/ ∑/ 2NE/ (/ T2/ =/ L/ (/ Tm/ =/ (/ TmG/ // G2/ // n1/ 排队/ 系统/ 的/ 服务/ 时间/ :/ TRR/ =/ Trr/ +/ Tp/ +/ Th/ +/ Tb/ |/ hitting/ +/ Tu/ 由式/ (/ 4/ )/ ~/ (/ 7/ )/ ,/ 可/ 计算/ 出/ 队列/ RR/ 的/ 服务/ 时间/ 的/ 期望/ E/ (/ TRR/ )/ 以及/ 方差/ E/ (/ T2E/ (/ TRR/ )/ =/ P/ (/ hitting/ )/ E/ (/ TRR/ |/ hitting/ )/ +/ =/ λ/ 1/ -/ λ/ 2/ λ/ 1/ λ/ 2/ (/ Trr/ +/ Tp/ +/ Th/ +/ E/ (/ Tb/ |/ missing/ )/ +/ Tw/ λ/ 1/ =/ Trr/ +/ Tp/ +/ Th/ +/ TwTmf2L/ λ/ 1RR/ )/ =/ P/ (/ hitting/ )/ E/ (/ T2E/ (/ T2/ =/ λ/ 1/ -/ λ/ 2/ λ/ 12/ (/ Trr/ +/ Tp/ +/ Th/ +/ TuE/ (/ T22/ (/ Trr/ +/ Tp/ +/ Th/ +/ TwE/ (/ T2Page12/ (/ 1/ )/ 当/ CMPE/ 的/ 数量/ n1/ =/ 1/ 时/ ,/ CM/ 为/ G/ // G/ // 1/ 排队/ 系统/ ,/ 当/ ρ/ 1/ =/ λ/ 1E/ (/ TRR/ )/ </ 1/ 时/ ,/ 有/ [/ 30/ ]/ λ/ 1E/ (/ T2/ / λ/ 1/ (/ E/ (/ T2/ 当/ CMPE/ 的/ 负载/ ρ/ 1/ =/ λ/ 1E/ (/ TRR/ )/ // n1/ </ 1/ 且/ 充分/ 接近/ 1/ (/ 即/ 处于/ heavytraffic/ 状态/ )/ 时/ ,/ 在/ 稳态/ 下/ Wq/ 近似/ 服从/ 负/ 指数分布/ ,/ 从而/ 有/ [/ 30/ -/ 31/ ]/ 当/ CMPE/ 的/ 负载/ RR/ 近似/ 服从/ 负/ 指数分布/ ,/ 从而/ 有/ [/ 30/ -/ 31/ ]/ 且/ 充分/ 接近/ 1/ (/ 即/ 处于/ heavytraffic/ 状态/ )/ 时/ ,/ 在/ 稳态/ 下/ WqE/ (/ Wq/ λ/ 1/ (/ n1/ (/ ab2/ // (/ (/ a/ -/ 1/ )/ 2/ (/ a/ -/ 2/ )/ )/ )/ +/ E/ (/ T2/ 又/ ,/ 实际/ 情况/ 下/ 采用/ 随机性/ 足够/ 好/ 的/ 散列/ 函数/ 且/ 散/ 列表/ 足够/ 大时/ ,/ 会话/ 记录/ 在/ 会/ 话/ 表中/ 趋向于/ 均/ 5.4/ 会话/ 处理/ 性能/ 分析/ 接下来/ 对/ 稳态/ 下/ 队列/ SR/ 的/ 长度/ LqSR/ 、/ 逗留/ 时间/ WSR/ 以及/ MMPE/ 数量/ n2/ 进行/ 定量/ Wq/ 分析/ ./ MMPE/ 创建/ 添加/ 一条/ 会话/ 记录/ 所/ 花费/ 的/ 总/ 时间/ (/ 即/ M/ // G/ +/ D/ // 1/ 排队/ 系统/ 的/ 服务/ 时间/ )/ 为/ TSR/ +/ TCR/ ,/ 其中/ TSR/ =/ Trr/ +/ Th/ +/ Tb/ |/ missing/ +/ TcE/ (/ TSR/ )/ =/ Trr/ +/ Th/ +/ Tc/ =/ Trr/ +/ Th/ +/ Tc/ 将/ 系统/ 中/ 的/ 有效/ 会话/ 记录/ (/ activeflowrecords/ )/ 看成/ M/ // G/ // 型/ 排队/ 系统/ 中/ 正在/ 接受/ 服务/ 的/ “/ 顾客/ ”/ ,/ 服务/ 时间/ 即/ 为/ 会/ 话/ 的/ 生命周期/ (/ sessionlifespan/ )/ ,/ 则/ E/ (/ WqRR/ )/ =/ λ/ 1/ (/ E/ (/ T2/ 由/ Little/ 公式/ 可算出/ 此时/ 队列/ RR/ 长度/ 的/ 期望/ 为/ E/ (/ Lq/ (/ 2/ )/ 当/ CMPE/ 的/ 数量/ n1/ >/ 1/ 时/ ,/ 由/ 文献/ [/ 30/ ,/ 32/ ]/ 可知/ :/ 2n1E/ (/ TRR/ )/ / E/ (/ WqRR/ )/ -/ (/ n1/ -/ 1/ )/ E2/ (/ TRR/ )/ 匀/ 分布/ ,/ 使得/ E/ (/ T2E/ (/ Wq/ λ/ 1/ (/ n1/ (/ ab2/ // (/ (/ a/ -/ 1/ )/ 2/ (/ a/ -/ 2/ )/ )/ )/ +/ E2/ (/ TRR/ )/ )/ E/ (/ Lq/ 同式/ (/ 13/ )/ ,/ 根据/ E/ (/ WqRR/ )/ ./ 将式/ (/ 9/ )/ 代入/ 式/ (/ 15/ )/ ,/ 展开/ 后/ 可知/ 若/ CM/ 存在/ 稳态/ 则/ CMPE/ 的/ 数量/ n1/ 应/ 满足/ f/ +/ 2LTu2L/ 由/ 文献/ [/ 33/ ]/ 可知/ ,/ 系统/ 中/ 有效/ 会话/ 记录/ 的/ 数目/ 服从/ 泊松/ 分布/ ./ 假定/ 会话/ 的/ 活跃期/ (/ sessionduration/ )/ Td/ 服从/ 均值/ 为/ ea/ +/ δ/ 2/ // 2/ (/ 其中/ σ/ >/ 0/ )/ 的/ 对数/ 正态分布/ [/ 34/ ]/ ,/ 则/ 会/ 话/ 的/ 生命期/ 均值/ 为/ ea/ +/ δ/ 2/ // 2/ +/ Ta/ ,/ 由/ Little/ 公式/ 可得会/ 话/ 表中/ 有效/ 会话/ 记录/ 数量/ 的/ 均值/ 为/ Na/ =/ λ/ 2/ (/ Td/ +/ Ta/ )/ =/ λ/ 2/ (/ ea/ +/ δ/ 2/ // 2/ +/ Ta/ )/ (/ 22/ )/ 稳态/ 下/ 系统/ 内部/ 将/ 维持/ 一种/ 动态/ 的/ 平衡/ 关系/ ,/ 即/ 单位/ 时间/ 内/ 平均/ 新/ 产生/ 的/ 过期/ 会话/ 记录/ 数/ (/ 亦/ 即/ 需要/ 回收/ 的/ 会/ 话/ 记录/ 数/ )/ 与/ 平均/ 新/ 到达/ 的/ 会/ 话/ 数量/ 相同/ ,/ 均/ 为/ λ/ 2/ ./ 由/ MMPE/ 扫描/ 散列桶/ 回收/ 过期/ 会话/ 记录/ 的/ 批处理/ 策略/ (/ 粒度/ 为/ Sr/ )/ 可知/ ,/ 稳态/ 下/ MMPE/ 在/ 一次/ “/ 休假/ ”/ 期间/ 扫描/ 会话/ 记录/ 的/ 次数/ 服从/ 参数/ 为/ Sr/ // L/ 的/ 二项分布/ ,/ 均值/ 为/ 2NSr/ // L/ ./ 同理/ ,/ 稳态/ 下/ MMPE/ 在/ 一次/ “/ 休假/ ”/ 期间/ 删除/ 过期/ 会话/ 记录/ 次数/ 和/ 回收/ 会话/ 记录/ 次数/ 也/ 服从/ 参数/ 为/ Sr/ // L/ 的/ 二项分布/ ,/ 均值/ 分别/ 约/ 为/ 2/ (/ N/ -/ Na/ )/ Sr/ // L/ 和/ (/ N/ -/ Na/ )/ Sr/ // L/ ./ 因此/ ,/ 稳态/ 下/ 执行/ 一/ 批次/ 扫描/ 和/ 回收/ 过期/ 会/ Page13/ 话/ 记录/ (/ 即/ 一次/ “/ 假期/ ”/ )/ 的/ 时间/ 开销/ Tv/ 的/ 期望/ 和/ 方差/ 分别/ 为/ E/ (/ Tv/ )/ =/ SrL/ (/ 2NTs/ 对于/ 空竭/ 服务/ 、/ 多重/ 休假/ 的/ M/ // G/ +/ D/ // 1/ 排队/ 系统/ ,/ 当/ SR/ )/ =/ E/ (/ Lq/ 时/ ,/ SR/ 队列/ 中/ 消息/ 数量/ 的/ 期望/ 为/ [/ 30/ ,/ 35/ ]/ E/ (/ Lq/ 则/ 队列/ SR/ 中/ 消息/ 等待时间/ 、/ 逗留/ 时间/ (/ 等待时间/ +/ 服务/ 时间/ )/ 的/ 期望/ 分别/ 为/ E/ (/ WqE/ (/ WSR/ )/ =/ E/ (/ TSR/ +/ TCR/ )/ +/ E/ (/ Wq/ 其中/ E/ (/ T2/ 录在/ 会话/ 表中/ 趋向于/ 均匀分布/ 时/ ,/ D/ (/ Tv/ )/ 趋近/ 于/ 0/ ;/ 由式/ (/ 19/ )/ 和/ 式/ (/ 21/ )/ 可知/ :/ E/ (/ (/ TSR/ +/ TCR/ )/ 2/ )/ =/ (/ 2/ (/ Trr/ +/ Th/ +/ Ti/ 又/ ,/ 将式/ (/ 20/ )/ 、/ 式/ (/ 21/ )/ 代入/ 式/ (/ 25/ )/ ,/ 展开/ 后/ ,/ 再/ 由/ N/ / Na/ 可得/ 稳态/ 下/ MMPE/ 的/ 数量/ n2/ 应/ 满足/ n2/ >/ λ/ 2/ (/ 2Trr/ +/ 2Th/ +/ 2Ti/ / λ/ 2/ (/ 2Trr/ +/ 2Th/ +/ 2Ti/ 由式/ (/ 29/ )/ 可知/ ,/ 在/ 不/ 限制/ 队列/ SR/ 长度/ 的/ 情况/ 下/ ,/ 调整/ MMPE/ 每/ 批次/ 扫描/ 回收/ 过期/ 会话/ 记录/ 的/ 粒度/ Sr/ 不会/ 对/ MMPE/ 的/ 数量/ n2/ 造成/ 影响/ ./ 5.5/ 存储/ 开销/ 分析/ 下面/ 对/ 稳态/ 下会/ 话表/ 大小/ 、/ 垃圾/ 比率/ 以及/ 回收/ 由/ 文献/ [/ 35/ ]/ 可知/ ,/ MMPE/ “/ 忙期/ ”/ (/ 添加/ 会话/ 记/ 缓冲区/ 大小/ 做/ 定量分析/ ./ 录/ 的/ 时间/ )/ 的/ 平均/ 长度/ 为/ 其中/ LS/ (/ Tv/ )/ 为/ Tv/ 的/ Laplace/ -/ Stieltjes/ 变换/ ;/ MMPE/ “/ 全/ 假期/ ”/ (/ 前后/ 两次/ “/ 忙期/ ”/ 之间/ 的/ 若干次/ 连续/ “/ 假期/ ”/ 之/ 和/ ,/ 扫描/ 回收/ 操会话/ 记录/ 的/ 时间/ )/ 的/ 平均/ 长度/ 为/ 从而/ 稳态/ 下/ 对于/ MMPE/ 的/ 一个/ “/ 忙/ 循环/ ”/ (/ 即/ 一次/ “/ 全/ 假期/ ”/ 加上/ 其后/ 的/ 忙期/ )/ 存在/ 平衡/ 方程/ :/ (/ E/ (/ Tmv/ )/ +/ E/ (/ Tw/ )/ )/ λ/ 2n2/ =/ (/ N/ —/ Na/ )/ E/ (/ Tmv/ )/ SrE/ (/ Tv/ )/ L/ 即/ 在/ “/ 忙/ 循环/ ”/ 期间/ 新/ 产生/ 的/ 过期/ 会话/ 记录/ 数应/ 等于/ 回收/ 的/ 会/ 话/ 记录/ 数/ ./ 将式/ (/ 20/ )/ 、/ (/ 21/ )/ 、/ (/ 23/ )/ 、/ (/ 25/ )/ 和/ 式/ (/ 30/ )/ 、/ (/ 31/ )/ 代入/ 式/ (/ 32/ )/ 后/ ,/ 展开/ 计算/ 得到/ 其中/ ,/ A/ =/ 2/ λ/ 2Tm/ λ/ 2L/ (/ θ/ 1/ +/ θ/ 2/ )/ ,/ C/ =/ (/ n2L/ -/ λ/ 2L/ (/ θ/ 1/ +/ θ/ 2/ )/ )/ Na/ ,/ θ/ 1/ =/ 2Tdf/ +/ Tr/ 再/ 由/ N/ 、/ Na/ 可/ 计算/ 出会/ 话表/ 的/ 垃圾/ 比率/ (/ gar/ -/ bageratio/ )/ [/ 5/ ]/ :/ GR/ =/ (/ N/ -/ Na/ )/ // Na/ ./ 考虑/ 一个/ 报文/ 从/ 进入/ 系统/ 到/ 离开/ 的/ 时间/ 间隔/ 内/ 回收/ 的/ 过期/ 会话/ 记录/ 数目/ (/ 稳态/ 下/ 亦/ 即/ 新/ 到达/ 会话/ 数目/ )/ ,/ 则/ 回收/ 记录/ 缓冲区/ 大/ 小S/ f/ 应/ 满足/ 6/ 实验/ 以/ IntelIXP2400/ 网络/ 处理器/ 、/ 8MBSRAM/ 、/ 1GBSDRAM/ 和/ 4/ 个/ GE/ 多模/ 光网/ 口/ 组成/ 的/ 高速/ 网络/ 处理/ 板卡/ 为/ 实验/ 平台/ ./ IXP2400/ 的/ 工作/ 主频/ 为/ 600MHz/ ,/ 内部/ 包含/ 8/ 个微/ 引擎/ (/ ME/ )/ 和/ 1/ 个/ XScale/ 处理器/ ./ 微/ 引擎/ 支持/ 32/ 位/ RISC/ 指令集/ ,/ 每个/ 微/ 引擎/ 又/ 包含/ 8/ 个/ 有/ 独立/ 寄存器/ 组/ 的/ 硬件/ 线程/ ,/ 线程/ 轮流/ 获得/ 执行/ 权限/ 且/ 线程/ 之间/ 切换/ 为/ 零/ 开销/ ./ 每个/ 硬件/ 线程/ 可以/ 看做/ 一个/ PE/ ./ IXP2400/ 片外/ 存储单元/ 主要/ 包括/ :/ (/ 1/ )/ 工作频率/ 最高/ 为/ 200MHz/ 的/ 双通道/ QDRSRAM/ ,/ 每个/ 通道/ 的/ 峰值/ 带宽/ 为/ 1.6/ GB/ // s/ 、/ 最大/ 容量/ 64MB/ ,/ 支持/ 不/ 包括/ 原子/ 减/ 操作/ 在内/ 的/ 各种/ 原子/ 操作/ ;/ (/ 2/ )/ 工作频率/ 最高/ 为/ 150MHz/ 的/ DDRSDRAM/ (/ 4/ 个/ Bank/ )/ ,/ 峰值/ 带宽/ 为/ 2.4/ GB/ // s/ ,/ 最大/ 容量/ 2GB/ ./ 在/ 原型/ 系统/ 中/ ,/ 散/ 列表/ 、/ 会话/ 记录/ 写锁/ 组成/ 的/ 位串/ (/ bitmap/ )/ 、/ 回收/ 记录/ 缓冲区/ 头尾/ 指针/ 等/ 存储/ 在/ SRAM/ 中/ ,/ 会话/ 记录/ 本身/ 则/ 根据/ 所属/ 子表/ 分别/ 存储/ Page14/ 于/ SDRAM/ 的/ 不同/ Bank/ 中/ ./ 采用/ 源/ IP地址/ 、/ 源/ TCP/ // DUP/ 端口/ 、/ 目的/ IP地址/ 、/ 目的/ TCP/ // DUP/ 端口/ 和/ 协议/ 号/ 作为/ 会话/ 关键码/ ,/ 散/ 列表/ 的/ 散列/ 算法/ 采用/ jhash/ 算法/ [/ 27/ ]/ ./ 对/ 原型/ 系统/ 中/ 各项/ 操作/ 的/ 开销/ (/ 读/ SRAM/ 次数/ ,/ 写/ SRAM/ 次数/ ;/ 读/ SDRAM/ 次数/ ,/ 写/ SDRAM/ 次数/ ;/ 操作/ 所/ 含/ 指令/ 数/ ,/ 操作/ 的/ 时钟/ 周期/ 开销/ )/ 进行/ 了/ 统计/ ,/ 见表/ 3/ ,/ 其中/ 创建/ 会话/ 记录/ 操作/ 的/ 平均/ 开销/ 达到/ 了/ 2920/ 个/ 时钟/ 周期/ ,/ 要/ 远大于/ 其它/ 操作/ 的/ 时间/ 开销/ ./ 6.1/ 实验/ 设置/ 通过/ 若干/ 台/ 流量/ 发生器/ 向/ 实验/ 平台/ 发送/ 64/ 字节/ 大小/ 的/ UDP/ 报文/ ,/ 总/ 发包/ 速率/ 为/ λ/ 1/ ./ 其中/ ,/ 以/ 均匀/ 的/ 时间/ 间隔/ 发送/ 带/ 新/ 的/ 目的/ IP地址/ 和/ UDP/ 端口/ 的/ 报文/ ,/ 发送/ 速率/ 为/ λ/ 2/ ,/ 以/ 这样/ 的/ 报文/ 作为/ 会话首/ 报文/ ,/ 触发/ 原型/ 系统/ 执行/ 创建/ 添加/ 会话/ 记录/ 的/ 操作/ ;/ 其余/ 的/ 报文/ 采用/ 轮询/ 方式/ 分别/ 通过/ 不同/ 的/ UDP/ 会话/ 发送/ 出去/ ,/ 每条/ 会/ 话/ 的/ 生命周期/ 持续/ Td/ 秒/ ./ 通过/ 调整/ 流量/ 发生器/ 的/ 参数/ λ/ 1/ 、/ λ/ 2/ 、/ Td/ 以及/ 原型/ 系统/ 的/ 参数/ L/ 、/ Ta/ 、/ Sr/ ,/ 观察/ 在/ 不/ 丢/ 包/ 条件/ 下/ 系统/ 处于/ 稳态/ 时/ 的/ n1/ 、/ n2/ 、/ N/ 和/ GR/ ,/ 并/ 周期性地/ 记录/ SR/ 和/ Sf/ 的/ 变化/ ,/ 从而/ 对/ 报文/ 吞吐/ 并行/ 加速性/ RR/ 、/ LqLq/ 能/ 、/ 会话/ 吞吐/ 并行/ 加速/ 性能/ 以及/ 存储/ 开销/ (/ 队列/ 长度/ 、/ 回收/ 缓冲区/ 大小/ )/ 进行/ 评估/ ./ 6.2/ 报文/ 并行处理/ 性能/ 并行/ 加速/ 性能/ ./ 实验/ 1/ ./ 报文/ 到达/ 速率/ λ/ 1/ 处于/ 高位/ 时/ 的/ 报文/ 将/ λ/ 2/ 、/ L/ 、/ E/ (/ Td/ )/ 、/ Ta/ 、/ Sr/ 分别/ 取值/ 为/ 1/ 万条/ // s/ 、/ 524288/ 、/ 300s/ 、/ 60s/ 、/ 1/ 个/ ,/ 则/ 稳态/ 下会话/ 表中/ 的/ 活跃/ 会话/ 记录/ 数/ Na/ 应为/ 360/ 万条/ ./ 实际/ 测得会/ 话/ 表中/ 的/ 会/ 话/ 记录/ 总数/ N/ 约/ 为/ 362.5/ 万条/ ,/ 垃圾/ 比率/ GR/ 为/ 0.69/ %/ ,/ 散列桶/ 深/ 均值/ E/ (/ d/ )/ 为/ 14/ ;/ 所需/ MMPE/ (/ 硬图/ 7/ 报文/ 吞吐/ 并行/ 加速/ 性能/ 和/ 排队/ 队列/ 长度/ 变化/ 情况/ (/ 会话/ 速率/ 10000/ 条/ // s/ )/ 件/ 线程/ )/ 数/ n2/ 为/ 1/ 个/ ./ 定义/ 报文/ 处理/ 的/ 并行/ 效率/ (/ parallelefficiency/ )/ =/ 稳态/ 下/ n1/ 个/ CMPE/ 的/ 最大/ 报文/ 吞吐量/ // (/ n1/ ×/ 稳态/ 下/ 单个/ CMPE/ 的/ 最大/ 报文/ 吞吐量/ )/ 测/ 得/ 此时/ 单个/ CMPE/ (/ 硬件/ 线程/ )/ 的/ 最大/ 报文/ 吞吐量/ 约/ 为/ 278.3/ Kpps/ ./ 逐步/ 增加/ CMPE/ (/ 硬件/ 线程/ )/ 的/ 数量/ n1/ ,/ 测试/ 对应/ 的/ 最大/ 报文/ 吞吐量/ 以及/ 报文/ 输入/ 队列/ RR/ 长度/ 变化/ 情况/ ./ 受限于/ 实验/ 平台/ 硬件/ 本身/ 的/ 吞吐能力/ (/ 峰值/ 流量/ 为/ 4Gbps/ )/ ,/ CMPE/ (/ 硬件/ 线程/ )/ 总数/ 只能/ 增加/ 到/ 21/ 个/ ,/ 约/ 占/ IXP2400/ 硬件/ 线程/ 总数/ 的/ 三分之一/ ./ 变化/ 情况/ ./ 随着/ λ/ 1/ 和/ n1/ 的/ 增加/ ,/ Lq/ 升/ ,/ LqRR/ 的/ 最小值/ 基本上/ 保持/ 不变/ 且/ 略有/ 下降/ ,/ 而/ RR/ 的/ 最大值/ 呈/ 明显/ 上升/ 趋势/ ,/ 反映/ 出/ 在/ 所有/ CMLqPE/ 接近/ 满/ 负载/ 的/ 状况/ 下/ 等待/ 被/ 各个/ CMPE/ 处理/ 的/ 报文/ 在/ 队列/ RR/ 中/ 产生/ “/ 累积/ ”/ ,/ 使得/ Lq/ 幅度/ 变大/ ./ 当/ 报文/ 吞吐量/ 达到/ 5.844/ Mpps/ ,/ 接近/ 系统/ 流量/ 负载/ 峰值/ 时/ ,/ Lq21/ )/ ,/ 仍然/ 在/ 比较/ 合理/ 的/ 水平/ 上/ ./ 图/ 7/ (/ a/ )/ 给出/ 了/ 在/ 不/ 丢/ 包/ 情况/ 下/ 最大/ 报文/ 吞吐量/ 随/ CMPE/ (/ 硬件/ 线程/ )/ 数目/ n1/ 的/ 变化/ 情况/ ./ 由图/ 中/ 可知/ ,/ 最大/ 报文/ 吞吐量/ 与/ n1/ 呈/ 线性/ 增长/ 关系/ ,/ 且/ 与/ 理论值/ 能/ 较/ 好/ 地/ 吻合/ ,/ 报文/ 处理/ 的/ 并行/ 效率/ 均值/ 接近/ 1/ ./ 当/ n1/ =/ 1/ 时/ ,/ 最大/ 报文/ 吞吐量/ 达到/ 278.3/ Kpps/ ,/ 对比/ 表/ 1/ 中/ NetfilterConntrack/ 的/ 实验/ 结果/ 可知/ ,/ 在/ 硬件平台/ 性能/ 较逊/ 的/ 情况/ 下/ ,/ PaSeM/ 的/ 该项/ 性能指标/ 仍然/ 超过/ NetfilterConntrack/ 一个/ 数量级/ ./ 当/ n1/ =/ 21/ 时/ ,/ 最大/ 报文/ 吞吐量/ 达到/ 了/ 5.844/ Mpps/ (/ 约/ 3.93/ Gbps/ )/ ./ 图/ 7/ (/ b/ )/ 给出/ 了/ 报文/ 输入/ 队列/ RR/ 的/ 长度/ LqPage15/ 并行/ 加速/ 性能/ ./ 实验/ 2/ ./ 会话/ 到达/ 速率/ λ/ 2/ 处于/ 高位/ 时/ 的/ 报文/ 将/ λ/ 2/ 调整/ 为/ 5/ 万条/ // s/ ,/ 其它/ 条件/ 与/ 实验/ 1/ 相同/ ,/ 则/ 稳态/ 下会话/ 表中/ 的/ 活跃/ 会话/ 记录/ 数/ Na/ 应为/ 1800/ 万条/ ./ 实际/ 测得会/ 话/ 表中/ 的/ 会/ 话/ 记录/ 总数/ N/ 约/ 为/ 1907/ 万条/ ,/ 垃圾/ 比率/ GR/ 约/ 为/ 5.9/ %/ ,/ 散列桶/ 深/ 均值/ E/ (/ d/ )/ 为/ 73/ ;/ 所需/ MMPE/ (/ 硬件/ 线程/ )/ 数/ n2/ 为/ 2/ 个/ ./ 测得/ 此时/ 2/ 个/ CMPE/ (/ 硬件/ 线程/ )/ 的/ 报文/ 吞吐量/ 约/ 为/ 114Kpps/ (/ 单个/ 硬件/ 线程/ 的/ 吞吐量/ 已经/ 小于/ λ/ 2/ )/ ./ 由于/ 此时/ 会话表/ 的/ 负载/ 因子/ (/ loadfactor/ )/ N/ // L/ 较/ 高/ ,/ 导致/ 查询/ 会话表/ 的/ I/ // O/ 访存/ 开销/ 增加/ ,/ 从而/ 使得/ 最大/ 报文/ 吞吐量/ 明显降低/ ./ 将/ CMPE/ (/ 硬件/ 线程/ )/ 的/ 数量/ n1/ 从/ 2/ 逐步/ 增加/ 到/ 16/ ,/ 测/ 得/ 最大/ 报文/ 吞吐量/ 的/ 变化/ 情况/ 如图/ 8/ (/ a/ )/ 所示/ ,/ 报文/ 输入/ 队列/ RR/ 的/ 长度/ Lq/ 知/ ,/ 最大/ 报文/ 吞吐量/ 与/ n1/ 依然/ 呈现/ 线性/ 增长/ 关系/ ,/ 图/ 8/ 报文/ 吞吐/ 并行/ 加速/ 性能/ 和/ 排队/ 队列/ 长度/ 变化/ 情况/ (/ 会话/ 速率/ 50000/ 条/ // s/ )/ 6.3/ 会话/ 并行处理/ 性能/ 实验/ 3/ ./ 将/ L/ 、/ E/ (/ Td/ )/ 、/ Ta/ 、/ Sr/ 分别/ 取值/ 为/ 524288/ 、/ 300s/ 、/ 60s/ 、/ 1/ 个/ ,/ 报文/ 发送/ 速率/ λ/ 1/ 固定/ 为/ 900Kpps/ ./ 逐步/ 增加/ MMPE/ (/ 硬件/ 线程/ )/ 的/ 数量/ n2/ ,/ 测试/ 对应/ 的/ 最大/ 会话/ 吞吐量/ 、/ 并行/ 效率/ 以及/ 队列/ SR/ 长度/ 变化/ 情况/ ./ 定义/ 会话/ 处理/ 的/ 并行/ 效率/ (/ parallelefficiency/ )/ =/ 稳态/ 下/ n2/ 个/ MMPE/ 的/ 最大/ 会话/ 吞吐量/ // (/ n2/ ×/ 稳态/ 下/ 单个/ MMPE/ 的/ 最大/ 会话/ 吞吐量/ )/ (/ 36/ )/ 测/ 得/ 此时/ 单个/ MMPE/ (/ 硬件/ 线程/ )/ 的/ 最大/ 会话/ 吞吐量/ λ/ 2/ 约/ 为/ 3/ 万条/ // s/ ./ 将/ MMPE/ (/ 硬件/ 线程/ )/ 的/ 数量/ n2/ 从/ 1/ 逐步/ 增加/ 至/ 8/ ,/ 则/ 对应/ 的/ 最大/ 会话/ 吞吐量/ 、/ 并行/ 效率/ 的/ 变化/ 情况/ 如图/ 9/ (/ a/ )/ 所示/ ./ 由图/ 中/ 可以/ 看出/ ,/ 最大/ 会话/ 吞吐量/ 与/ n2/ 呈/ 递增/ 关系/ ,/ 且/ 实验/ 值/ 与/ 理论值/ 能/ 较/ 好/ 地/ 吻合/ ./ 当/ n2/ =/ 1/ 时/ ,/ 最大/ 会话/ 吞吐量/ 达到/ 3/ 万条/ // s/ ,/ 对比/ 表/ 1/ 中/ NetfilterConntrack/ 的/ 当/ n1/ =/ 16/ 时/ ,/ 最大/ 报文/ 吞吐量/ 达到/ 了/ 920Kpps/ ;/ 报文/ 处理/ 的/ 并行/ 效率/ 均值/ 仍/ 接近/ 1/ ./ 当/ n1/ 为/ 2/ 时/ ,/ 尽管/ 此时/ 会话首/ 报文/ 数量/ λ/ 2/ 在/ 总流量/ 中/ 占据/ 了/ 相当/ 高/ 的/ 比例/ ,/ 达到/ 43.85/ %/ ,/ 最大/ 报文/ 吞吐量/ 的/ 实验/ 值/ 与/ 理论值/ 仍然/ 能够/ 较/ 好/ 地/ 吻合/ ;/ 另一方面/ ,/ 由于/ 总流量/ λ/ 1/ 相对/ 于/ n1/ 来说/ 并/ 不/ 高/ ,/ Lq/ 比较/ 小/ ,/ 且/ 依然/ 呈现/ 随着/ n1/ 逐步/ 递增/ 的/ 趋势/ —/ —/ —/ 这两点/ 都/ 表明/ CMPE/ 对/ 报文/ 的/ 处理/ 并/ 没有/ 受到/ MMPE/ 的/ 干扰/ ,/ 体现/ 出/ PaSeM/ 无/ 冲突/ 并行/ 加速/ 的/ 效果/ 是/ 比较/ 明显/ 的/ ./ 当/ n1/ 从/ 2/ 增加/ 到/ 16/ 时/ ,/ 会话首/ 报文/ 数量/ λ/ 2/ 在/ 总流量/ 中/ 的/ 比例/ 逐步/ 下降/ 到/ 了/ 5.43/ %/ ,/ 但是/ 最大/ 报文/ 吞吐量/ 的/ 实验/ 值/ 与/ 理论值/ 之间/ 的/ 差距/ 反而/ 逐步/ 扩大/ 到/ 24/ %/ ./ 这/ 主要/ 是/ 由于/ 理论/ 分析模型/ 并/ 没有/ 将/ I/ // O/ 访存/ 带宽/ 的/ 限制/ 考虑/ 进来/ ,/ 因此/ 当/ I/ // O/ 访存/ 开销/ 存在/ 瓶颈/ 时/ 理论值/ 产生/ 了/ 一定/ 的/ 偏差/ ./ 实验/ 结果/ 可知/ ,/ 在/ 硬件平台/ 性能/ 较逊/ 的/ 情况/ 下/ ,/ PaSeM/ 的/ 该项/ 性能指标/ 仍然/ 达到/ 了/ NetfilterConntrack/ 的/ 3.64/ 倍/ ./ 当/ n2/ =/ 8/ 时/ ,/ 最大/ 会话/ 吞吐量/ 达到/ 了/ 11.6/ 万条/ // s/ ,/ 会话/ 表中/ 的/ 会/ 话/ 记录/ 总数/ 达到/ 4470/ 多万条/ ,/ 其中/ 活跃/ 会话/ 约/ 为/ 4176/ 万条/ ,/ 已经/ 达到/ 相当于/ 100/ +/ Gbps/ 网络流量/ 的/ 会/ 话/ 到达/ 速率/ 和/ 并发/ 会话/ 规模/ [/ 5/ ]/ ./ 当/ n2/ =/ 2/ ,/ 3/ ,/ 4/ ,/ 5/ ,/ 6/ ,/ 7/ ,/ 8/ 时/ ,/ 并行/ 效率/ 分别/ 为/ 85/ %/ 、/ 73.3/ %/ 、/ 65.4/ %/ 、/ 59.7/ %/ 、/ 55.2/ %/ 、/ 51.5/ %/ 和/ 48.3/ %/ ,/ 取得/ 了/ 较/ 好/ 的/ 会/ 话/ 并行/ 加速/ 效果/ ./ 随着/ n2/ 的/ 增加/ ,/ MMPE/ 的/ 并行/ 效率/ 呈/ 递减/ 趋势/ ,/ 这/ 主要/ 是/ 由于/ 会话表/ 负载/ 因子/ N/ // L/ 的/ 增长/ 导致/ 查询/ 会话表/ 的/ I/ // O/ 访存/ 开销/ 增加/ ,/ 反过来/ 限制/ 了/ 最大/ 会话/ 吞吐量/ λ/ 2/ 的/ 进一步/ 增长/ ./ 图/ 9/ (/ b/ )/ 给出/ 了/ 队列/ SR/ 的/ 长度/ Lq/ 时/ Lq/ 变化/ 幅度/ 均/ 呈/ 下降/ 趋势/ ./ SR/ 最大值/ 达到/ 183/ ,/ 之后/ 随着/ n2/ 的/ 增加/ ,/ LqPage16/ 图/ 9/ 会话/ 吞吐/ 并行/ 加速/ 性能/ 和/ 排队/ 队列/ 长度/ 变化/ 情况/ (/ 报文/ 速率/ 900Kpps/ )/ 6.4/ 存储/ 开销/ 对/ 实验/ 3/ 中/ 稳态/ 下/ 的/ 会话表/ 规模/ N/ 进行/ 记录/ ,/ 并/ 根据/ 式/ (/ 22/ )/ 可算出/ 同时/ 活跃/ 的/ 会/ 话/ 数/ Na/ ,/ 由此/ 可得会/ 话/ 表中/ 过期/ 会话/ 记录/ 以及/ 垃圾/ 比率/ GR/ 的/ 变化/ 情况/ ,/ 如图/ 10/ 所示/ ./ 由图/ 中/ 可知/ ,/ 在/ 系统/ 处于/ 最大/ 会话/ 吞吐量/ 的/ 情况/ 下/ ,/ GR/ 仍然/ 处于/ 9/ %/ 以下/ ,/ 低于/ 文献/ [/ 5/ ]/ 的/ 指标/ (/ 28/ %/ )/ ./ 对于/ 实验/ 3/ 中/ 队列/ RR/ 和/ SR/ 的/ 长度/ Lq/ 进行/ 记录/ 并求/ 均值/ ,/ 再/ 通过/ Little/ 公式/ 和/ 式/ (/ 34/ )/ 可/ 计算/ 出/ 回收/ 缓冲区/ 大/ 小S/ f/ 的/ 条件/ 值/ ,/ 如图/ 11/ 所示/ ./ 采用/ 此/ 条件/ 值为/ Sf/ 的/ 实验/ 值/ ,/ 在/ 实验/ 过程/ 中/ 没有/ 发生/ 会话/ 丢失/ 的/ 现象/ ,/ 表明/ 计算/ 出/ 的/ 条件/ 值/ 是/ 合理/ 的/ ./ 随着/ 会话/ 吞吐量/ λ/ 2/ 的/ 增加/ ,/ Sf/ 也/ 需要/ 相应/ 地/ 增加/ ,/ 当/ λ/ 2/ 达到/ 11.6/ 万条/ // s/ 时/ ,/ n2/ 和/ N/ 分别/ 为/ 8/ 和/ 4470/ 万条/ ,/ 此时/ Sf/ 只/ 需/ 设置/ 为/ 7548/ 即可/ 满足要求/ ,/ 仅为/ N/ 的/ 万分之/ 1.69/ ./ 7/ 结论/ 与/ 展望/ 本文/ 的/ 工作/ 主要/ 体现/ 在/ 如下/ 几个/ 方面/ :/ (/ 1/ )/ 提出/ 了/ 一种/ 基于/ 并行/ 的/ 网络流量/ 会话/ 管理/ 方案/ PaSeM/ ,/ 基于/ 散/ 列表/ 的/ 无锁会/ 话表/ 设计/ ,/ 采用/ 了/ 任务/ 并行/ 、/ 报文/ 并行/ 、/ 会话/ 并行/ 、/ I/ // O/ 并行/ 和/ 异步/ 通信/ 等/ 多种/ 并行/ 策略/ ;/ (/ 2/ )/ 讨论/ 并/ 解决/ 了/ 在/ 高速/ 网络/ 环境/ 下/ 面临/ 的/ 各种/ 并行/ 冲突/ 问题/ ,/ 给出/ 了/ 高效/ 的/ 会/ 话/ 管理/ 和/ 查询/ 的/ 并行算法/ ;/ (/ 3/ )/ 基于/ 排队/ 理论/ 建立/ 了/ 相应/ 的/ 性能/ 评价/ 模型/ 并/ 进行/ 了/ 理论/ 分析/ ,/ 对于/ 稳态/ 下/ 的/ 性能指标/ 以及/ 关键/ 参数/ 应/ 满足/ 的/ 条件/ 给出/ 了/ 定量/ 计算方法/ ,/ 与/ 这部分/ 类似/ 的/ 理论/ 建模/ 和/ 分析/ 工作/ 还/ 只见/ 于/ 与/ 文献/ [/ 5/ ]/ ./ 该/ 模型/ 的/ 理论/ 计算/ 值/ 与/ 实验/ 值有/ 较/ 高/ 的/ 吻合/ 度/ ,/ 对于/ 实际/ 应用/ 以及/ 今后/ 的/ 研究/ 具有/ 指导意义/ ./ (/ 4/ )/ 实现/ 了/ 一个/ PaSeM/ 的/ 原型/ 并/ 进行/ 了/ 实验/ ,/ 实验/ 结果表明/ PaSeM/ 对于/ 会话/ 管理/ 和/ 报文/ 处理/ 具有/ 较/ 好/ 的/ 并行/ 加速/ 效果/ ,/ 报文/ 处理/ 的/ 并行/ 效率/ 均值/ 接近/ 1/ ,/ 当会话/ 管理/ 单元/ 个数/ 为/ 4/ 时/ ,/ 会话/ 处理/ 并行/ 效率/ 为/ 65.4/ %/ (/ 亦/ 即/ 加速/ 比为/ 2.62/ )/ ,/ 当会话/ 管理/ 单元/ 个数/ 为/ 8/ 时/ ,/ 会话/ 处理/ 并行/ 效率/ 仍然/ 达到/ 了/ 48.3/ %/ (/ 加速/ 比为/ 3.86/ )/ ,/ 能够/ 满足/ 当前/ 高速/ 网络/ 环境/ 流量/ 处理/ 的/ 性能/ 要求/ ;/ 在/ 最大/ 吞吐量/ 负载/ 下/ 排队/ 队列/ 长度/ 及其/ 变化/ 幅度/ 都/ 处于/ 合理/ 范围/ ,/ 会话表/ 垃圾/ 比率/ 维持/ 在/ 较/ 低/ 的/ 水平/ 上/ (/ 实验/ 结果/ 为/ 小于/ 9/ %/ )/ ,/ 与/ 已有/ 的/ 工作/ 相比/ 为/ 优/ ./ 与/ 已有/ 的/ 研究/ 工作/ 相比/ ,/ PaSeM/ 在/ 保证/ 业务/ 灵活性/ 的/ 前提/ 下/ 实现/ 了/ 对/ 会/ 话/ 和/ 报文/ 的/ 高速/ 无/ 冲突/ 并行处理/ ,/ 具备/ 很/ 好/ 的/ 实用性/ ./ 针对/ 并行执行/ 环境/ 中大/ Page17/ 规模/ 网络/ 会话/ 管理/ 问题/ ,/ 根据/ 已有/ 文献/ 来看/ ,/ 这方面/ 的/ 研究/ 工作/ 还/ 开展/ 得/ 比较/ 少/ ./ 进一步/ 的/ 方法/ 改进/ 和/ 研究/ 工作/ 包括/ :/ (/ 1/ )/ 考虑/ 基于/ 松/ 耦合/ 分布式/ 并行处理/ 系统/ (/ 如/ 电信/ 级/ 防火墙/ 或者/ 运营商/ 级/ 流量/ 监控/ 系统/ )/ 以及/ 异构/ 并行/ 系统/ 的/ 应用/ 场景/ ,/ 将/ PE/ 之间/ 通信/ 信道/ 的/ 不可靠性/ 因素/ 考虑/ 进来/ ,/ 对会话/ 记录/ 状态机/ 和/ 并行算法/ 进行/ 扩展/ ,/ 以/ 满足/ 10/ +/ Gbps/ ~/ 100/ +/ Gbps/ 高速/ 带宽/ 下/ 的/ 性能/ 要求/ ;/ (/ 2/ )/ 考虑/ 在/ 专用/ 硬件/ 支持/ 下/ (/ 如/ TCAM/ 、/ Bloomfilter/ 、/ Hash/ 硬件/ )/ 的/ 方法/ 改进/ ,/ 以/ 获得/ 局部/ 性能/ 的/ 改善/ ,/ 如/ 提高/ 散/ 列表/ 的/ 查询/ 命中率/ 、/ 减少/ 查询/ 失败/ 开销/ ./ 

