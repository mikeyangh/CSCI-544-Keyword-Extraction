Page1/ 可/ 扩展/ 路由器/ FIB/ 表/ 分解/ 存储/ 模型/ 陈/ 文龙/ 1/ )/ ,/ 2/ )/ 徐明伟/ 3/ )/ 杨扬/ 2/ )/ 韩冬/ 4/ )/ 1/ )/ (/ 首都师范大学/ 信息/ 工程学院/ 北京/ 100048/ )/ 2/ )/ (/ 北京科技大学/ 计算机/ 与/ 通信/ 工程学院/ 北京/ 100083/ )/ 3/ )/ (/ 清华大学/ 计算机科学/ 与/ 技术/ 系/ 北京/ 100084/ )/ 4/ )/ (/ 北京大学/ 软件/ 与/ 微电子/ 学院/ 北京/ 100080/ )/ 摘要/ FIB/ 表/ 急剧/ 增长/ 是/ 互联网/ 高速/ 发展/ 面临/ 的/ 重要/ 问题/ 之一/ ,/ FIB/ 表/ 分解/ 存储/ 能/ 有效/ 解决/ 该/ 问题/ ./ 现有/ 的/ SPAL/ 技术/ 将/ FIB/ 表较/ 均匀/ 地/ 分解/ 存储/ 在/ 不同/ 线卡/ ,/ 但/ 仍然/ 存在/ 较/ 多/ 的/ 表项/ 冗余/ 存储/ 现象/ ,/ 并且/ 实现/ 复杂/ ./ 对此/ 设计/ 了/ 一种/ 新型/ 的/ 转/ 发表/ 分解/ 存储/ 模型/ (/ DecomposedStorageofFIB/ ,/ DSF/ )/ ,/ 它/ 依据/ IP/ 前缀/ 的/ 前/ 若干/ bit/ 位/ 实现/ 线卡/ 对/ 转/ 发表/ 的/ 分解/ 存储/ ,/ 并/ 只/ 带来/ 极少/ 的/ 冗余/ 存储/ ./ DSF/ 的/ 改进/ 方案/ —/ —/ —/ EDSF/ ,/ 更/ 可/ 使/ 各/ 线卡/ 非常/ 均衡/ 地/ 完成/ 分解/ 存储/ ./ 提出/ 的/ 分解/ 存储/ 模型/ 缓解/ 了/ FIB/ 表项/ 急剧/ 增长/ 问题/ 的/ 解决/ 压力/ ,/ 同时/ 大大/ 节省/ 了/ 硬件资源/ ./ 对于/ 线卡/ 数量/ 更/ 多/ 的/ 可/ 扩展/ 路由器/ 尤为/ 适合/ ./ 通过/ 对/ 当前/ 运营/ 的/ 路由表/ 的/ 分解/ 存储/ 实验/ 研究/ 及/ 与/ 其它/ 方案/ 的/ 比较/ ,/ 验证/ 了/ 文中/ 模型/ 良好/ 的/ 存储/ 性能/ ./ 关键词/ 路由器/ ;/ 路由/ ;/ 转/ 发表/ ;/ 分解/ 存储/ ;/ IP/ 前缀/ 1/ 引言/ 互联网/ 快速/ 发展/ 带来/ 的/ 一个/ 重大/ 问题/ 就是/ 核心/ 路由器/ FIB/ 表/ 的/ 急剧/ 增长/ [/ 1/ ]/ ./ 我们/ 需要/ 在/ 路由器/ 中/ 部署/ 更/ 大容量/ 的/ 路由/ 查找/ 及/ 存储芯片/ ./ 而且/ ,/ 商用/ 路由器/ 普遍/ 采用/ 全/ 冗余/ 备份/ 方法/ 存储/ FIB/ 表项/ ,/ 该/ 方法/ 使得/ 每块/ 线卡/ (/ LineCard/ ,/ LC/ )/ 都/ 要/ 大量/ 扩充/ 硬件资源/ ./ 随之/ 带来/ 的/ 芯片/ 供电/ 和/ 散热/ 处理/ 还会/ 消耗/ 更/ 多/ 的/ 电力/ 资源/ ./ 随着/ 路由器/ 体系/ 向/ 可/ 扩展/ 结构/ 的/ 发展/ [/ 2/ ]/ ,/ 该/ 问题/ 显得/ 更为/ 突出/ ./ FIB/ 表/ 分解/ 存储/ 是/ 解决/ 上述/ 问题/ 的/ 重要/ 手段/ ./ 现有/ FIB/ 表/ 研究/ [/ 3/ -/ 4/ ]/ 主要/ 集中/ 于/ 通过/ 并行处理/ 提高/ 查询/ 速度/ ,/ 只有/ 文献/ [/ 5/ ]/ 提出/ 的/ SPAL/ 技术/ 是/ 一个/ 完备/ 的/ FIB/ 表/ 分解/ 存储/ 方案/ ,/ 但/ 它/ 仍/ 存在/ 大量/ 转发/ 项/ 在/ 多块/ 线卡/ 的/ 冗余/ 存储/ ./ 本文/ 设计/ 了/ 转/ 发表/ 分解/ 存储/ 方法/ (/ DecomposedStorageofFIB/ ,/ DSF/ )/ ./ 它/ 依据/ IP/ 前缀/ 的/ 前/ 若干/ bit/ 位/ 进行/ 转/ 发表/ 分解/ 存储/ ,/ 实现/ 线卡/ 对/ FIB/ 表/ 的/ 部分/ 存储/ ./ 每/ 线卡/ 只/ 需/ 存储系统/ 转/ 发表/ 的/ 一个/ 子表/ ,/ 且/ 每/ 线卡/ 平均/ 存储转发/ 项/ 数量/ 随着/ 线卡/ 数/ 增加/ 而/ 减少/ ./ 模型/ 只/ 需为/ 每块/ 线卡/ 增加/ 存储/ 极少/ 虚拟/ 路由/ ,/ 与/ 真实/ 转发/ 项/ 共存/ 于/ 一个/ 转/ 发表/ 中/ ./ 线卡/ 转发/ 引擎/ 通过/ 最长/ 前缀/ 匹配/ (/ LongestPrefixMatching/ ,/ LPM/ )/ ,/ 既/ 可/ 实现/ 转发/ 下/ 一/ 跳/ 查询/ ,/ 又/ 可/ 实现/ 报文/ 到/ 转发/ 子表/ 的/ 对应/ ./ 针对/ 真实/ 网络/ 中路/ 由/ 前缀/ 分布/ 不/ 均衡/ 特征/ ,/ DSF/ 模型/ 的/ 改进/ 方案/ EDSF/ ,/ 能/ 使/ 各/ 线卡/ 存储/ 的/ 转发/ 项数/ 非常/ 均衡/ ./ DSF/ // EDSF/ 模型/ 可/ 实施/ 于/ 所有/ 进行/ 最长/ 前缀/ 匹配/ 的/ 分布式/ 转发/ 体系/ ./ 而且/ ,/ 针对/ 该/ 模型/ 设计/ 的/ 线卡/ 功能/ 结构/ 与/ 现有/ 商业/ 路由器/ 线卡/ 设计/ 兼容/ ,/ 易/ 实施/ ./ 理论/ 分析/ 及/ 对/ 实际/ 运营/ 路由器/ FIB/ 表/ 的/ 分解/ 结果/ 都/ 表明/ 它/ 能/ 极大/ 地/ 减少/ 整个/ 系统/ 及/ 每/ 线卡/ 存储/ 的/ FIB/ 表项/ ./ 本文/ 提出/ 的/ 分解/ 存储/ 模型/ 较之/ SPAL/ 技术/ ,/ 能/ 实现/ 更为/ 平均/ 的/ 分解/ 存储/ 以及/ 更少/ 的/ 冗余/ 存储/ ./ 其/ 主要/ 特点/ 包括/ :/ (/ 1/ )/ 各/ 线卡/ 分解/ 存储/ 非常/ 均衡/ ,/ 使得/ 线卡/ 所/ 需/ 的/ 最大/ 存储容量/ 变小/ ;/ (/ 2/ )/ 只/ 需/ 增加/ 存储/ 极少/ 的/ 虚拟/ 路由/ 即可/ 实现/ ;/ (/ 3/ )/ 方案/ 适用范围/ 广/ :/ 所有/ 遵循/ LPM/ 的/ 分布式/ 路由/ 转发/ 体系/ ;/ (/ 4/ )/ 与/ 现有/ 商用/ 路由器/ 兼容/ ,/ 我们/ 只/ 需/ 对/ 现有/ 商用/ 路由器/ 线卡/ 功能/ 做/ 极小/ 的/ 改动/ ,/ 便/ 可/ 完成/ DSF/ 模型/ 的/ 实施/ ,/ 易/ 推动/ 其/ 产业化/ 进程/ ./ 本文/ 第/ 2/ 节/ 介绍/ 相关/ 研究/ 工作/ ;/ 第/ 3/ 节/ 介绍/ DSF/ 模型/ ;/ 第/ 4/ 节/ 介绍/ DSF/ 模型/ 实施/ 算法/ 及/ 线卡/ 功能/ 结构/ ;/ 第/ 5/ 节/ 介绍/ 优化/ 的/ DSF/ 模型/ —/ —/ —/ EDSF/ ;/ 第/ 6/ 节为/ 实验/ 及/ 结果/ 分析/ ;/ 第/ 7/ 节/ 总结/ 全文/ ./ 2/ 相关/ 研究/ 文中/ “/ 核心/ 路由表/ ”/ 是/ 指/ 系统对/ 各路/ 由/ 协议/ 所学/ 路由/ 计算/ 后/ 的/ 最佳/ 路由/ ,/ “/ 转/ 发表/ (/ FIB/ )/ ”/ 是/ 指/ 存储/ 在线/ 卡上/ 指导/ 报文/ 转发/ 的/ 信息/ ./ 传统/ 模型/ 中/ ,/ 每块/ 线卡/ 的/ 转/ 发表/ 都/ 是/ 核心/ 路由表/ 的/ 映像/ ./ 然而/ ,/ 该/ 描述/ 在/ 本文/ 提出/ 的/ 新型/ 模型/ 中/ 并/ 不/ 成立/ ./ 另外/ ,/ “/ 真实/ 路由/ ”/ 或/ “/ 路由/ ”/ 也/ 表示/ 核心/ 路由/ ,/ 它/ 对应/ DSF/ 模型/ 中/ 的/ “/ 虚拟/ 路由/ ”/ 描述/ ./ 近年来/ 学者/ 们/ 研究/ 了/ 如何/ 通过/ 并/ 行路/ 由/ 查询/ ,/ 提高/ 转发/ 引擎/ 查询/ 速度/ ./ 文献/ [/ 3/ ]/ 针对/ Trie/ 树/ 路由/ 存储/ 提出/ 了/ 一种/ 基于/ SRAM/ 的/ 多/ 管道/ 并行/ IP/ 查询/ 体系/ ,/ 通过/ 缓存/ 常用/ 路由/ 来/ 均衡/ 各/ 管道/ 流量/ ./ 文献/ [/ 4/ ]/ 设计/ 了/ 一种/ 基于/ 分块/ 路由/ 并行/ 查询/ 的/ 报文/ 转发/ 体系/ :/ IFPLUT/ ./ 它/ 根据/ 转/ 发出/ 接口/ 将/ 转/ 发表/ 分成/ 若干/ 子/ 部分/ ./ 下/ 一/ 跳/ 查询/ 时/ ,/ 所有/ 子/ 部分/ 并行/ 进行/ 路由/ 查询/ ,/ 所有/ 结果/ 中/ IP/ 前缀/ 长度/ 最大/ 的/ 路由/ 即/ 为/ 报文/ 转发/ 的/ 依据/ ./ 文献/ [/ 3/ -/ 4/ ]/ 的/ 主要/ 贡献/ 是/ 提高/ 了/ FIB/ 表/ 查询/ 效率/ ,/ 虽/ 没有/ 实现/ FIB/ 表/ 分解/ 存储/ ,/ 但/ 确为/ 分解/ 存储/ 提供/ 了/ 有/ 价值/ 的/ 参考/ ./ 文献/ [/ 5/ ]/ 为/ 解决/ FIB/ 表/ 扩张/ 问题/ 设计/ 的/ SPAL/ 技术/ 是/ 真正/ 的/ FIB/ 表/ 分解/ 存储/ 方案/ ./ SPAL/ 根据/ 目的/ IP/ 前缀/ 中/ 任意/ n/ 位/ 的/ 值/ 将/ 转/ 发表/ 分解成/ 若干/ 子集/ ,/ 分别/ 存储/ 在/ 不同/ 线卡/ ./ 线卡/ 分析/ 报文/ 目的/ 地址/ 该/ n/ 位值/ ,/ 确定/ 其/ 转发/ 项/ 所在/ 线卡/ ,/ 并/ 向/ 该/ 线卡/ 进行/ 转发/ 查询/ 获得/ 结果/ ./ 虽然/ SPAL/ 缓存/ 查询/ 结果/ ,/ 但/ 新/ 到/ 流量/ 转发/ 项/ 查询/ 时/ 涉及/ 两次/ 线卡/ 间/ 消息传递/ ,/ 增加/ 了/ 转发/ 时延/ ./ 而且/ ,/ 缓存/ 维护/ (/ 新项/ 插入/ 、/ 删除/ 等/ 维护/ )/ 行为/ 带来/ 很大/ 开销/ ./ 最/ 重要/ 的/ ,/ 该/ 方法/ 基于/ SRAM/ 实现/ 且/ 硬件/ 逻辑/ 实现/ 复杂/ ,/ 与/ 现有/ 商业/ 核心/ 路由器/ 实现/ 不/ 兼容/ ./ 另外/ ,/ 该/ 方案/ 中/ 仍会/ 出现/ 较/ 多/ 的/ 转发/ 项/ 冗余/ 存储/ ./ 路由器/ 已/ 向/ 可/ 扩展/ 体系结构/ 发展/ [/ 2/ ]/ ./ 可/ 扩展/ 路由器/ 是/ 由/ 若干个/ 子/ 路由器/ 级/ 连/ 而/ 成/ 的/ 一个/ 统一/ 的/ 路由/ 系统/ ./ 它/ 在/ 功能/ 、/ 性能/ 、/ 接口/ 规模/ 等/ 方面/ ,/ 具有/ 极大/ 的/ 可扩展性/ ./ 其/ 主要/ 优点/ 有/ :/ 保护/ 前期/ 运营/ 投资/ ,/ 提高/ 系统/ 性能/ ,/ 增强/ 可靠性/ ,/ 简化/ 网络拓扑/ 等/ ./ 主要/ 的/ 路由器/ 厂商/ 已/ 开发/ 出/ 相应/ 产品/ [/ 6/ -/ 7/ ]/ ./ 可/ 扩展/ 路由器/ 的/ 一个/ 重要/ 特征/ 是/ 线卡/ 数量/ 急剧/ 增多/ ,/ 所以/ FIB/ 表/ 容量/ 增大/ 导致/ 的/ 消耗/ 更/ 多/ 硬件资源/ 及/ 电能/ 的/ 问题/ 在/ 可/ 扩展/ 路由器/ 中/ 显得/ 更为/ 突出/ ./ 3DSF/ 模型/ 商用/ 核心/ 路由器/ 通常/ 为/ 分布式/ 体系结构/ ,/ 普遍/ Page3/ 采用/ 的/ 转/ 发表/ 存储/ 方法/ 是/ 每块/ 线卡/ 存储/ 所有/ 核心/ 路由表/ 项/ [/ 6/ -/ 8/ ]/ ,/ 称为/ 完全/ 备份/ 存储/ 模型/ (/ FullBackupStorage/ ,/ FBS/ )/ ./ 假设/ 可/ 扩展/ 路由器/ 系统/ 的/ 核心/ 路由表/ 项/ 数量/ 为/ m/ ,/ 线卡/ 总数/ 为/ n/ ,/ 满足/ n/ >/ 1/ (/ 本文/ 不/ 考虑/ 系统/ 仅/ 有/ 一块/ 线卡/ 的/ 情况/ )/ ./ 传统/ FBS/ 模型/ 中/ ,/ 系统/ 存储/ 的/ 转发/ 项/ 总数/ 为/ m/ ×/ n/ ./ 随着/ 路由器/ 路由/ 数量/ 逐渐/ 增大/ ,/ 设备/ 存储/ 代价/ 及/ 查找/ 开销/ 都/ 难以承受/ ./ 而且/ ,/ 因为/ IPv6/ 路由/ 占用/ 更/ 多/ 存储空间/ ,/ IPv6/ 网络/ 的/ 部署/ 将/ 加剧/ 这一/ 矛盾/ ./ 本文/ 的/ DSF/ 模型/ 正是/ 为/ 解决/ 这一/ 矛盾/ 而/ 设计/ 的/ ./ 3.1/ 分解/ 存储/ 定义/ 1/ ./ 对于/ 两个/ 给定/ IP/ 前缀/ PFX1/ :/ Address1/ // Masklen1/ ;/ PFX2/ :/ Address2/ // Masklen2/ ,/ 若/ 满足/ Masklen2/ / Masklen1/ ,/ 且/ 前缀/ 地址/ Address1/ 和/ Address2/ 的/ 二进制/ 前/ Masklen1/ 位/ 完全相同/ ,/ 则/ 称作/ PFX2/ 归属/ PFX1/ ,/ 或/ PFX1/ 包含/ PFX2/ ,/ 记/ 作/ :/ PFX2/ / PFX1/ ./ 如有/ 192.0/ ./ 0.0/ // 2/ / 128.0/ ./ 0.0/ // 1/ 、/ 10.0/ ./ 0.0/ // 8/ / 10.0/ ./ 0.0/ // 8/ ./ 定义/ 2/ (/ 单元/ 前缀/ PFXunit/ )/ ./ 单元/ 前缀/ 是/ 分解/ 存储/ 中/ 依据/ 某种/ 策略/ 指定/ 的/ 一些/ IP/ 前缀/ ./ 单元/ 前缀/ 具有/ 下述/ 特性/ :/ 目的/ IP/ 前缀/ 归属/ 同一/ 单元/ 前缀/ 的/ 若干/ 路由/ 项/ ,/ 存储/ 在/ 同一/ 线卡/ ,/ 一块/ 线卡/ 可/ 拥有/ 多个/ 单元/ 前缀/ ./ 定义/ 3/ (/ 聚集/ 前缀/ PFXaggr/ )/ ./ 包含/ 多个/ 不同/ 单元/ 前缀/ 的/ IP/ 前缀/ 被称作/ 聚集/ 前缀/ ./ 令/ 所有/ 可能/ 的/ 单元/ 前缀/ 集合/ 为/ Sunit/ ,/ 所有/ 可能/ 的/ 聚集/ 前缀/ 集合/ 为/ Saggr/ ./ DSF/ 模型/ 中/ ,/ 单元/ 前缀/ 和/ 聚集/ 前缀/ 的/ 指定/ 方法/ 分别/ 通过/ 规则/ 1/ 和/ 规则/ 2/ 完成/ ./ 规则/ 1/ ./ 对于/ 给定/ 整数/ k/ (/ 0/ </ k/ </ 32/ )/ ,/ 所有/ 掩码/ 长度/ 等于/ k/ 的/ IP/ 前缀/ 被/ 指定/ 为/ 单元/ 前缀/ ./ k/ 被称作/ 分解/ 位/ ,/ 有/ |/ Sunit/ |/ =/ 2k/ ,/ 并令/ PFXunit/ (/ i/ )/ 为/ 前/ k/ 位/ 二进制/ 数/ 等于/ i/ 的/ 单元/ 前缀/ ./ 规则/ 2/ ./ 对于/ 给定/ 整数/ k/ (/ 0/ </ k/ </ 32/ )/ ,/ 掩码/ 长度/ 小于/ k/ 的/ IP/ 前缀/ 被/ 指定/ 为/ 聚集/ 前缀/ ./ 以/ k/ =/ 2/ 为例/ 进一步/ 说明/ ./ 此时/ 单元/ 前缀/ 个数/ 为/ 4/ ,/ 包括/ PFXunit/ (/ 0/ )/ =/ “/ 0.0/ ./ 0.0/ // 2/ ”/ ,/ PFXunit/ (/ 1/ )/ =/ 图/ 1n/ =/ 4/ 和/ n/ =/ 6/ 时/ 单元/ 前缀/ 分配/ 示例/ “/ 64.0/ ./ 0.0/ // 2/ ”/ ,/ PFXunit/ (/ 2/ )/ =/ “/ 128.0/ ./ 0.0/ // 2/ ”/ ,/ PFXunit/ (/ 3/ )/ =/ “/ 192.0/ ./ 0.0/ // 2/ ”/ ;/ 而/ “/ 128.0/ ./ 0.0/ // 1/ ”/ 就是/ 一个/ 聚集/ 前缀/ ./ 所有/ 前缀/ 长度/ 大于/ 等于/ 2/ 的/ IP/ 前缀/ ,/ 总归/ 属于/ 4/ 个/ 单元/ 前缀/ 中/ 的/ 某/ 一个/ ./ 我们/ 将/ 任一/ IP地址/ 视为/ 掩码/ 长度/ 为/ 32/ 的/ IP/ 前缀/ ,/ 则/ 任一/ IP地址/ 总是/ 属于/ 且/ 只/ 属于/ 某一/ 单元/ 前缀/ ./ DSF/ 模型/ 根据/ 线卡/ 数/ n/ 来/ 确定/ 分解/ 位/ k/ 的/ 取值/ ,/ 满足/ DSF/ 模型/ 的/ 单元/ 前缀/ 和/ 聚集/ 前缀/ 都/ 是/ 根据/ 满足/ 式/ (/ 1/ )/ 的/ k/ 值/ 指定/ 而/ 得/ ./ 以/ 4/ 块/ 线卡/ 为例/ ,/ n/ 等于/ 4/ 则/ k/ 等于/ 2/ ,/ 即/ 根据/ IP/ 前缀/ 的/ 前/ 两位/ 进行/ 路由表/ 的/ 分解/ 存储/ ./ 那么/ ,/ 共有/ 4/ 个/ 单元/ 前缀/ ,/ 每块/ 线卡/ 分/ 得/ 一个/ 单元/ 前缀/ ./ IP/ 前缀/ 归属/ “/ 0.0/ ./ 0.0/ // 2/ ”/ 的/ 路由/ 项/ 存储/ 在/ LC0/ 中/ ,/ IP/ 前缀/ 归属/ “/ 64.0/ ./ 0.0/ // 2/ ”/ 的/ 路由/ 项/ 存储/ 在/ LC1/ 中/ ,/ 以此类推/ ./ 对于/ 目的/ 前缀/ 为/ 聚集/ 前缀/ (/ 掩码/ 长度/ 小于/ 2/ )/ 的/ 路由/ 项/ ,/ 会/ 在/ 所有/ 线卡/ 存储/ ./ 当然/ ,/ 路由/ 系统/ 中/ 的/ 线卡/ 数/ 可以/ 为/ 任意/ 值/ ,/ 系统/ 总是/ 以/ 满足/ 式/ (/ 1/ )/ 的/ k/ ,/ 进行/ 单元/ 前缀/ 的/ 指定/ ./ 所以/ ,/ 单元/ 前缀/ 的/ 个数/ 为/ 进一步/ 可/ 得/ 烅/ 烄/ n/ </ |/ Sunit/ |/ </ 2n/ ,/ 当/ n/ 不/ 等于/ 2/ 烆/ 根据/ 均分/ 原则/ 分配/ 单元/ 前缀/ ./ 由式/ (/ 3/ )/ 可/ 得/ 每块/ 线卡/ 拥有/ PFXunit/ 数为/ 1/ 或/ 2/ ,/ 线卡/ 会/ 存储/ IP/ 前缀/ 归属其/ 任一/ 单元/ 前缀/ 的/ 路由/ 项/ ./ 定义/ 4/ ./ 路由/ 系统/ 中/ ,/ 若/ 第/ i/ 个/ 单元/ 前缀/ PFXunit/ (/ i/ )/ 被/ 分配/ 给/ 第/ j/ 块/ 线卡/ LCj/ ,/ 记作/ PFXunit/ (/ i/ )/ / LCj/ ./ 为了/ 描述/ 方便/ ,/ 假设/ 线卡/ 标号/ 为/ 0/ 、/ 1/ 、/ 2/ 依次/ 递增/ ,/ 则/ DSF/ 方案/ 中线/ 卡/ 与/ 单元/ 前缀/ 的/ 分配关系/ 为式/ (/ 4/ )/ ./ 图/ 1/ 所示/ 分解/ 树以/ 线卡/ 数/ 等于/ 4/ 和/ 6/ 为例/ 说明/ 了/ 单元/ 前缀/ 的/ 分配/ 方法/ ./ Page4/ 单元/ 前缀/ 分配/ 后/ ,/ 就/ 可/ 实施/ 对/ FIB/ 表/ 的/ 分解/ 存储/ ./ 一条/ 路由/ 的/ IP/ 前缀/ ,/ 要么/ 归属/ 某个/ 单元/ 前缀/ ,/ 要么/ 本身/ 就是/ 一个/ 聚集/ 前缀/ ./ 对于/ 系统/ 任/ 一条/ 核心/ 路由/ 项/ ,/ 其/ 存储/ 方法/ 遵循/ 规则/ 3/ ./ 规则/ 3/ ./ 令/ 核心/ 路由/ 项/ 的/ 目的/ IP/ 前缀/ 为/ PFXdst/ ,/ 若/ PFXdst/ 为/ 聚集/ 前缀/ ,/ 则/ 通告/ 该/ 路由/ 项给/ 所有/ 线卡/ 存储/ ;/ 否则/ ,/ 该/ IP/ 前缀/ 必/ 归属/ 某个/ 单元/ 前缀/ ,/ 则/ 只/ 通告/ 给/ 某块/ 线卡/ LCj/ 存储/ ,/ 满足/ PFXdst/ / PFXunit/ (/ i/ )/ 和/ PFXunit/ (/ i/ )/ / LCj/ ./ 分解/ 存储/ 过程/ 总结/ 如下/ ./ 首先/ ,/ 根据/ 系统/ 线卡/ 数/ n/ 及式/ (/ 1/ )/ 计算/ 得/ 分解/ 位/ k/ ./ 接着/ ,/ 根据/ k/ 值及/ 规则/ 1/ 得到/ 所有/ 单元/ 前缀/ ./ 最后/ ,/ 依据/ 规则/ 3/ 对/ 核心/ 路由表/ 进行/ 分解/ 存储/ ./ 3.2/ 虚拟/ 路由/ 及/ 数据/ 转发/ FIB/ 表在/ 各/ 线卡/ 分解/ 存储/ 后/ ,/ DSF/ 模型/ 实施/ 的/ 另/ 一/ 关键/ 则/ 是/ 数据/ 层/ 基于/ 此/ 存储/ 规则/ 的/ 报文/ 转发/ 机制/ ./ DSF/ 模型/ 对/ 处理/ 报文/ 的/ 线卡/ 进行/ 角色/ 定义/ ./ 针对/ 系统/ 转发/ 的/ 某个/ IP/ 报文/ ,/ 目的/ 地址/ 归属/ 的/ 单元/ 前缀/ 所在/ 线卡/ ,/ 被称作/ 该报/ 文/ 的/ 宿主/ 线卡/ ,/ 记作/ LCattach/ ./ 以/ 4/ 块/ 线卡/ 为例/ ,/ 单元/ 前缀/ “/ 64.0/ ./ 0.0/ // 2/ ”/ 属于/ LC1/ ,/ 则/ LC1/ 是/ 目的/ 地址/ 为/ 64.0/ ./ 0.1/ 、/ 65.10/ ./ 0.1/ 、/ 100.0/ ./ 0.1/ 等/ 报文/ 的/ 宿主/ 线卡/ ./ 另外/ ,/ 定义/ LCin/ 为/ 接收/ 该报/ 文/ 的/ 线卡/ ,/ LCout/ 为/ 发送/ 该报/ 文/ 的/ 线卡/ ./ DSF/ 模型/ 中/ 报文/ 转发/ 思想/ 是/ :/ 对于/ 待/ 转发/ IP/ 报文/ ,/ 总是/ 在/ 其/ 宿主/ 线卡/ 进行/ LPM/ 查找/ 时/ 才能/ 获得/ 最终/ 转发/ 信息/ ,/ 包括/ 查找/ 失败/ 也/ 在/ 宿主/ 线卡/ 中/ 决策/ ./ 当/ 报文/ 的/ 接收/ 线卡/ 不是/ 其/ 宿主/ 线卡/ 时/ ,/ 通过/ 增加/ 虚拟/ 路由/ 并/ 按/ LPM/ 查询/ 机制/ 将/ 报文/ 发/ 向/ 宿主/ 线卡/ ./ 也就是说/ ,/ 线卡/ 接收/ 报文/ 后/ 只/ 需/ 进行/ LPM/ 处理/ ,/ 若/ 接收/ 线卡/ 就是/ 报文/ 的/ 宿主/ 线卡/ 则/ 可/ 直接/ 获得/ 最终/ 转发/ 信息/ 进行/ 转发/ 处理/ ,/ 否则/ 发送/ 报文/ 到/ 它/ 的/ 宿主/ 线卡/ 再次/ 进行/ LPM/ 查找/ ./ DSF/ 方案/ 用/ 简化/ 、/ 统一/ 的/ 硬件/ LPM/ 查询/ ,/ 集成/ 了/ 报文/ 处理/ 的/ 两个/ 重要/ 功能/ :/ 获取/ 最终/ 转发/ 信息/ 及/ 获取/ 宿主/ 线卡/ 信息/ ./ 一条/ 转发/ 项/ 的/ 描述/ 包括/ 以下/ 主要/ 字/ 段/ :/ 〈/ 目的/ 网段/ ,/ 出线/ 卡号/ ,/ 出/ 接口号/ ,/ 下/ 一/ 跳/ 地址/ 〉/ ./ 对/ 任一/ 单元/ 前缀/ PFXunit/ (/ i/ )/ ,/ 若/ 其/ 分配/ 给/ LCj/ ,/ 系统/ 会/ 构造/ 一条/ 目的/ 网段/ 为/ 该/ 单元/ 前缀/ 的/ 虚拟/ 路由/ :/ 〈/ PFXunit/ (/ i/ )/ ,/ j/ ,/ Inv/ ,/ Inv/ 〉/ (/ Inv/ 表示/ 一个/ 无效/ 值/ )/ ,/ 并/ 通告/ 该/ 路由/ 给/ 除/ LCj/ 外/ 的/ 所有/ 线卡/ 存储/ ./ 这样/ 做/ 的/ 目的/ 是/ ,/ 当除/ LCj/ 外/ 的/ 其它/ 线卡/ 收到/ 目的/ 地址/ 属于/ PFXunit/ (/ i/ )/ 的/ 报文/ ,/ LPM/ 查找/ 后/ 必定会/ 匹配/ 该条/ 虚拟/ 路由/ ,/ 从而/ 转发/ 报文/ 到/ LCj/ ./ 仍以/ 4/ 块/ 线卡/ 为例/ ,/ 单元/ 前缀/ “/ 64.0/ ./ 0.0/ // 2/ ”/ 属于/ LC1/ ,/ 则/ 归属/ “/ 64.0/ ./ 0.0/ // 2/ ”/ 的/ 路由/ 全部/ 存储/ 在/ LC1/ 中/ ./ 并且/ ,/ 系统/ 会/ 在/ 0/ 、/ 2/ 、/ 3/ 号/ 线卡/ 增加/ 一条/ 虚拟/ 路由/ :/ 〈/ “/ 64.0/ ./ 0.0/ // 2/ ”/ ,/ 1/ ,/ Inv/ ,/ Inv/ 〉/ ./ 若/ LC0/ 或/ LC2/ 或/ LC3/ 收到/ 目的/ 地址/ 为/ 64.0/ ./ 0.1/ 的/ 报文/ ,/ LPM/ 查找/ 必/ 匹配/ 该/ 虚拟/ 路由/ ,/ 从而/ 转发/ 报文/ 到/ LC1/ ./ 每个/ 单元/ 前缀/ 对应/ 着/ 一条/ 虚拟/ 路由/ ,/ 而/ 每条/ 虚拟/ 路由/ 会/ 存储/ 到/ (/ n/ -/ 1/ )/ 块/ 线卡/ 上/ ,/ 由式/ (/ 2/ )/ 可/ 得/ 路由器/ 系统/ 总共/ 增加/ 存储/ 的/ 虚拟/ 路由/ 数为/ 总结/ 每块/ 线卡/ 存储/ 的/ FIB/ 表/ 包括/ :/ (/ 1/ )/ 所有/ 聚集/ 前缀/ 路由/ 项/ ;/ (/ 2/ )/ IP/ 前缀/ 归属/ 本/ 线卡/ 所/ 拥有/ 单元/ 前缀/ 的/ 路由/ 项/ ;/ (/ 3/ )/ 其它/ 线卡/ 的/ 单元/ 前缀/ 对应/ 的/ 虚拟/ 路由/ ./ 其中/ ,/ 前/ 2/ 类/ 路由/ 都/ 是/ 系统/ 真实/ 存在/ 的/ 核心/ 路由/ 项/ ./ 真实/ 路由/ 及/ 虚拟/ 路由/ 全部/ 存储/ 进/ FIB/ 表后/ ,/ 各/ 线卡/ 就/ 可/ 通过/ 对/ 报文/ 进行/ LPM/ 处理/ 实现/ 快速/ 转发/ ./ 根据/ 接收/ 报文/ 的/ 角色/ 不同/ ,/ 可以/ 分为/ 两种/ 情况/ :/ (/ 1/ )/ 非/ 宿主/ 线卡/ 接收/ ./ LCin/ 经过/ LPM/ 查找/ 后/ 必定/ 匹配/ 某条/ 虚拟/ 路由/ ,/ 查找/ 结果/ 中/ 出线/ 卡/ 就是/ 该报/ 文/ 的/ LCattach/ ,/ 且/ 得到/ 的/ 出/ 接口号/ 和/ 下/ 一/ 跳/ 都/ 是/ 无效/ 值/ ./ 报文/ 通过/ 内部/ 交换/ 网络/ 到达/ LCattach/ 后/ ,/ LCattach/ 发现/ 边带/ 信息/ 中/ 出/ 接口/ 和/ 下/ 一/ 跳/ 是/ 无效/ 值/ ,/ 于是/ 再次/ 进行/ LPM/ 查找/ ,/ 若/ 查询/ 失败/ 则/ 丢弃/ 报文/ ./ 否则/ ,/ 必/ 匹配/ 某条/ 真实/ 路由/ ,/ 并/ 得到/ 全部/ 转发/ 信息/ ./ 若/ 最终/ 出线/ 卡/ 就是/ LCattach/ ,/ 即/ LCattach/ 与/ LCout/ 角色/ 重合/ ,/ 则/ 直接/ 发送/ ;/ 否则/ ,/ 通过/ 交换/ 网络/ 发/ 往/ 最终/ 的/ LCout/ ,/ LCout/ 发现/ 边带/ 信息/ 已/ 包含/ 所有/ 有效/ 转发/ 信息/ ,/ 则/ 发送/ 报文/ ./ (/ 2/ )/ 宿主/ 线卡/ 接收/ ./ 此时/ 报文/ 的/ LCin/ 与/ LCattach/ 角色/ 重合/ ,/ 报文/ 所/ 需/ 的/ 转发/ 项/ 只/ 可能/ 存储/ 在/ 接收/ 线卡/ ./ LCin/ 进行/ LPM/ 查找/ ,/ 若/ 查询/ 失败/ 则/ 丢弃/ 报文/ ;/ 否则/ ,/ 必/ 匹配/ 某条/ 真实/ 路由/ ,/ 并/ 得到/ 全部/ 有效/ 转发/ 信息/ ./ 若/ 最终/ 出线/ 卡/ 就是/ LCin/ ,/ 即/ LCin/ 、/ LCattach/ 与/ LCout/ 三种/ 线卡/ 角色/ 重合/ ,/ 则/ 直接/ 发送/ ;/ 否则/ ,/ 通过/ 交换/ 网络/ 发/ 往/ 最终/ 的/ LCout/ ,/ LCout/ 发现/ 边带/ 信息/ 已/ 包含/ 所有/ 有效/ 转发/ 信息/ ,/ 发送/ 报文/ ./ DSF/ 模型/ 的/ 报文/ 转发/ 过程/ 中/ ,/ 板间/ 转发/ 次数/ 由/ 两个/ 条件/ 决定/ ,/ 条件/ 1/ :/ LCin/ =/ LCattach/ ;/ 条件/ 2/ :/ LCattach/ =/ LCout/ ,/ 而/ LCin/ 与/ LCout/ 的/ 关系/ 并/ 不/ 影响/ 板间/ 转发/ 次数/ ./ 条件/ 1/ 表示/ 线卡/ 从/ 外部/ 接收/ 的/ 报文/ 的/ 目的/ 地址/ 所/ 需/ 路由/ 在/ 入/ 线卡/ ;/ 条件/ 2/ 表示/ 转发/ 时报/ 文/ 出线/ 卡/ 恰好/ 存储/ 了/ 报文/ 转发/ 所/ 需/ 真实/ 路由/ ./ DSF/ 模型/ 中/ ,/ 上述/ 两个/ 条件/ 都/ 成立/ 则/ 需/ 0/ 次板间/ 转发/ ,/ 任一/ 条件/ 成立/ 则/ 需/ 1/ 次板间/ 转发/ ,/ 都/ 不/ 成立/ 则/ 需/ 2/ 次板间/ 转发/ ./ 3.3/ 无效/ 地址/ 考虑/ 互联网/ 单播/ 路由/ 中/ ,/ 有些/ IP/ 前缀/ 是/ 不/ 可能/ 出现/ Page5/ 的/ ,/ 如/ 私有/ 地址/ 和/ 组播/ 地址/ ./ DSF/ 模型/ 中/ ,/ 如果/ 一个/ 单元/ 前缀/ 覆盖范围/ 完全/ 是/ 这些/ 地址/ ,/ 就/ 无需/ 分配/ ./ 例如/ 针对/ 组播/ 地址/ ,/ 它/ 是/ 二进制/ 1110/ (/ 十进制/ 14/ )/ 开始/ 的/ 地址/ 范围/ ./ 当/ 单元/ 前缀/ 划分/ 位数/ 为/ 4/ 时/ ,/ 组播/ 地址/ 恰好/ 归属于/ 单元/ 前缀/ :/ PFXunit/ (/ 14/ )/ ./ 当/ 单元/ 前缀/ 的/ 划分/ 位数/ 为/ 5/ 时/ ,/ 组播/ 地址/ 恰好/ 归属/ 2/ 个/ 单元/ 前缀/ :/ PFXunit/ (/ 28/ )/ 和/ PFXunit/ (/ 29/ )/ ./ 以此类推/ ,/ 当/ 单元/ 前缀/ 的/ 划分/ 位数/ k/ 大于/ 等于/ 4/ 时/ ,/ 有/ 2/ (/ k/ -/ 4/ )/ 个/ 单元/ 前缀/ 属于/ 组播/ 地址/ 空间/ ,/ 分别/ 是/ PFXunit/ (/ 14/ ×/ 2/ (/ k/ -/ 4/ )/ )/ ,/ PFXunit/ (/ 14/ ×/ 2/ (/ k/ -/ 4/ )/ +/ 1/ )/ ,/ …/ ,/ PFXunit/ (/ 14/ ×/ 2/ (/ k/ -/ 4/ )/ +/ (/ 2/ (/ k/ -/ 4/ )/ -/ 1/ )/ )/ ./ 考虑/ 无效/ 地址/ 的/ 分解/ 存储/ 算法/ 实现/ 时/ ,/ 在/ 本文/ 算法/ 基础/ 上/ 略作/ 修改/ 即可/ ./ 4/ 设计/ 及/ 算法/ 4.1/ 线卡/ 设计图/ 2/ 是/ 基于/ 普遍/ 施用/ 的/ TCAM/ 结构/ ,/ 设计/ 的/ DSF/ 模型/ 线卡/ 硬件/ 功能/ 结构/ ./ 关键/ 模块/ 包括/ :/ Module/ _/ 1/ ,/ 外部/ 接口/ 报文/ 收发/ 模块/ ;/ Module/ _/ 2/ ,/ FIB/ 表/ 查询/ 及/ 转发/ 处理/ 模块/ ;/ Module/ _/ 3/ ,/ 板间/ 报文/ 分析/ 处理/ 模块/ ./ 其中/ ,/ Module/ _/ 2/ 是/ 整个/ 转发/ 引擎/ 的/ 核心/ ,/ 图/ 2/ 支持/ DSF/ 模型/ 的/ 线卡/ 功能/ 结构/ 无论/ DSF/ 模型/ 还是/ 下文/ 介绍/ 的/ EDSF/ 模型/ ,/ 都/ 有/ 一部分/ 报文/ 需要/ 多/ 一次/ LPM/ 查找/ 或/ 多/ 一次/ 板间/ 转发/ ,/ 这/ 就/ 带来/ 两个/ 问题/ :/ 报文/ 转发/ 时延/ 增加/ 、/ 消耗/ 更/ 多/ 的/ 内部/ 交换/ 带宽/ ./ 不过/ ,/ 由于/ 核心/ 路由器/ 普遍/ 采用/ TCAM/ 芯片/ 完成/ LPM/ 查找/ ,/ TCAM/ 查找/ 速度/ 可/ 达到/ 纳秒/ 级/ ,/ 但/ 这/ 对/ 端/ 到/ 端/ 至少/ 毫秒/ 级/ 的/ 传输/ 时延/ 来说/ 影响/ 很小/ ,/ 不/ 影响/ 设备/ 提供/ 的/ 网络/ 服务质量/ ./ 而/ 对于/ 交换/ 带宽/ ,/ 由于/ 目前/ 的/ 分步/ 式/ 核心/ 路由器/ 处理速度/ 瓶颈/ 在线/ 卡/ 本身/ 而/ 不/ 在/ 交换/ 网络/ 上/ ,/ 我们/ 只/ 需/ 通过/ 设置/ 提高/ 交换/ 结构/ 的/ 加速/ 比/ 就/ 可/ 解决/ 内部/ 交换/ 带宽/ 增加/ 的/ 问题/ ./ 另外/ ,/ 我们/ 还/ 可/ 在线/ 卡/ 增加/ 存储/ 常用/ 路由/ (/ PopularRoutes/ )/ ,/ 使得/ 两次/ LPM/ 查找/ 或/ 两次/ 板间/ 转发/ 的/ 情况/ 发生/ 概率/ 大大/ 减小/ ./ 限于/ 篇幅/ ,/ 本文/ 不/ 对/ 该/ 问题/ 深入探讨/ ./ 通过/ TCAM/ 芯片/ 存储转发/ 项/ 的/ IP/ 前缀/ 并/ 实现/ LPM/ 处理/ ./ 静态/ 随机/ 存储器/ (/ SRAM/ )/ 在/ 路由器/ 查找/ 系统/ 中/ 配合/ TCAM/ 查找/ ,/ 用于/ 存储/ 匹配/ 表项/ 信息/ ,/ 即/ LPM/ 查找/ 结果/ :/ 出线/ 卡/ 、/ 出/ 接口/ 、/ 下/ 一/ 跳/ 等/ 信息/ ./ 其中/ ,/ Module/ _/ 1/ 和/ Module/ _/ 2/ 是/ 当前/ 商用/ 高端/ 路由器/ 普遍/ 具备/ 的/ 功能/ [/ 9/ ]/ ,/ 目前/ 的/ 线卡/ 设计/ 中/ 没有/ 标识/ ①/ 所指/ 流程/ ,/ 收到/ 交换/ 网络/ 发来/ 的/ 报文/ 就/ 直接/ 走/ 标识/ ②/ 所指/ 流程/ ,/ 利用/ 边带/ 信息/ 发出/ ./ Module/ _/ 3/ 是/ 专门/ 为/ DSF/ 模型/ 设计/ 的/ ./ 报文/ 从/ 其它/ 线卡/ 经/ 交换/ 网络/ 发到/ 本/ 线卡/ ,/ 由板间/ 报文/ 分析/ 处理/ 模块/ 对/ 报文/ 的/ 边带/ 信息/ (/ 报文/ 内容/ 以外/ 的/ 相关/ 处理/ 信息/ ,/ 如入/ 接口/ 、/ 出/ 接口/ 、/ 下/ 一/ 跳/ 地址/ 等/ )/ 进行/ 分析/ 处理/ ,/ 有/ 两种/ 可能/ :/ (/ 1/ )/ 报文/ 已/ 获得/ 出/ 接口/ 及/ 下/ 一/ 跳/ 信息/ 则/ 直接/ 发送/ (/ 即图/ 2/ 中/ 标识/ ②/ )/ ,/ 对于/ 该报/ 文/ 来说/ 本/ 线卡/ 的/ 角色/ 是/ LCout/ ,/ 该类/ 报文/ 在/ 本/ 线卡/ 会/ 直接/ 通过/ 外部/ 接口/ 发送/ ./ (/ 2/ )/ 报文/ 未/ 获得/ 有效/ 的/ 出/ 接口/ 及/ 下/ 一/ 跳/ 信息/ (/ 即图/ 2/ 中/ 标识/ ①/ )/ ,/ 到/ 本/ 线卡/ 进行/ 最终/ LPM/ 查询/ 及/ 转发/ 处理/ ./ 对于/ 该报/ 文/ 来说/ 本/ 线卡/ 的/ 角色/ 是/ LCattach/ ,/ 该类/ 报文/ 会/ 在/ 本/ 线卡/ 进行/ 最终/ LPM/ 查询/ 及/ 转发/ 处理/ ./ 4.2/ 实施/ 步骤/ 及/ 算法/ DSF/ 模型/ 实施/ 时/ 包括/ 以下/ 步骤/ (/ 它们/ 全在/ 主控板/ 中/ 完成/ ,/ 各/ 线卡/ 只/ 需/ 对/ 主控/ 发来/ 的/ 转发/ 项/ 进行/ 存储/ 即可/ )/ :/ 3/ ./ 虚拟/ 路由/ 存储/ ./ 路由/ 引擎/ 为/ 每个/ 单元/ 前缀/ 构造/ 一条/ 虚拟/ 路由/ ,/ 通告/ 除该/ 单元/ 前缀/ 所属/ 线卡/ 之外/ 的/ 所有/ 线卡/ ./ 见/ 算法/ 2.1/ ./ 参数/ 初始化/ ./ 主控/ 在/ 向/ 线卡/ 分发/ 转发/ 项/ 之前/ 设置/ 参数/ ./ 设置/ 系统核心/ 路由/ 数为/ m/ ;/ 设置/ 线卡/ 数为/ n/ ;/ 根据/ 式/ (/ 1/ )/ 计算/ 单元/ 前缀/ 分解/ 位/ k/ ,/ 即/ 单元/ 前缀/ 掩码/ 长度/ ;/ 计算/ 单元/ 前缀/ 数量/ s/ =/ 2k/ ,/ 也/ 等于/ 虚拟/ 路由/ 数/ ./ 2/ ./ 真实/ 路由/ 分解/ 存储/ ./ 路由/ 引擎/ 对/ 真实/ 路由/ IP/ 前缀/ 分析/ ,/ 若/ 为/ 聚集/ 前缀/ ,/ 对应/ 路由/ 项分/ 发给/ 所有/ 线卡/ 存储/ ;/ 否则/ ,/ 只/ 通告/ 所属/ 单元/ 前缀/ 所在/ 的/ 线卡/ 存储/ ./ 见/ 算法/ 1/ ./ Page6/ 算法/ 1/ ./ Distribute/ -/ Actual/ -/ RT/ ./ 1/ ./ for/ (/ i/ =/ 1/ ;/ i/ </ =/ m/ ;/ i/ ++/ )/ 2/ ./ getmasklenofPFXdstofRTi/ :/ 3/ ./ if/ (/ masklen/ </ k/ )/ 4/ ./ sendRTitoallLC/ ;/ 5/ ./ else6/ ./ getPFXdstofRTi/ ;/ 7/ ./ for/ (/ j/ =/ 1/ ;/ j/ </ =/ |/ PFXunit/ |/ ;/ j/ ++/ )/ 8/ ./ ifPFXdst/ / PFXunit/ [/ j/ ]/ 9/ ./ sendRTitoLCPFXunit/ [/ j/ ]/ belongsto/ ;/ 10/ ./ break/ ;/ 11/ ./ return/ ;/ 算法/ 2/ ./ Distribute/ -/ Virtual/ -/ RT/ ./ 1/ ./ for/ (/ i/ =/ 0/ ;/ i/ </ s/ ;/ i/ ++/ )/ 2/ ./ if/ (/ i/ </ n/ )/ 3/ ./ constructvirtual/ _/ rt/ :/ 4/ ./ sendvirtual/ _/ rttoallLCexceptLCi/ ;/ 5/ ./ else6/ ./ constructvirtual/ _/ rt/ :/ 7/ ./ sendvirtual/ _/ rttoallLCexceptLC/ (/ i/ -/ n/ +/ 1/ )/ ;/ 8/ ./ return/ ;/ 算法/ 假设/ 系统/ 中线/ 卡/ 编号/ 从/ 0/ 开始/ 依次/ 增加/ ,/ 实际/ 环境/ 中/ 并不一定/ 如此/ ./ 此时/ ,/ 算法/ 略作/ 改进/ ,/ 只/ 需/ 给/ 每块/ 线卡/ 额外/ 分配/ 一个/ 依次/ 加/ 的/ 序号/ ,/ 并/ 记载/ 序号/ 与/ 线/ 卡号/ 的/ 对应/ 关系/ ,/ 算法/ 主体/ 思想/ 不变/ ./ 4.3/ 存储/ 分析/ 通过/ 式/ (/ 5/ )/ ,/ 我们/ 可以/ 分析/ 虚拟/ 路由/ 总数/ 、/ 每/ 线卡/ 平均/ 虚拟/ 路由/ 数随/ 线卡/ 数/ 的/ 变化/ 关系/ ,/ 见图/ 3/ ./ 图中/ 虚拟/ 路由/ 总数/ 随/ 线卡/ 数/ 增多/ 有/ 一定/ 的/ 增加/ ,/ 但/ 数量/ 较/ 小/ ,/ 16/ 线卡/ 时/ 也/ 不到/ 250/ 条/ 虚拟/ 路由/ ./ 相对/ 核心/ 路由器/ 多达/ 几十万/ 的/ 路由/ 数/ 来说/ ,/ 影响/ 不大/ ./ 另一方面/ ,/ 每/ 线卡/ 平均/ 存储/ 的/ 虚拟/ 路由/ 数量/ 也/ 随/ 线卡/ 数/ 增加/ 而/ 略有/ 增加/ ,/ 但/ 数值/ 一直/ 较/ 少/ ,/ 16/ 线卡/ 时/ 每/ 线卡/ 增加/ 存储/ 15/ 条/ 虚拟/ 路由/ ./ 所以/ ,/ DSF/ 方案/ 在/ 真实/ FIB/ 表/ 分解/ 存储/ 过程/ 中/ 所/ 增加/ 的/ 虚拟/ 路由/ 数/ 极少/ ,/ 额外/ 存储/ 开销/ 很小/ ./ 接着/ ,/ 我们/ 分析/ 路由器/ 总共/ 存储/ 的/ 转发/ 项数/ 及/ 每/ 线卡/ 平均/ 存储/ 的/ 转发/ 项数/ ./ FBS/ 方案/ 系统/ 存储/ 的/ 转发/ 项/ 总量/ 为/ m/ ×/ n/ ./ DSF/ 模型/ 中/ ,/ 路由/ 存储/ 分为/ 三块/ :/ 聚集/ 前缀/ 真实/ 路由/ 、/ 非/ 聚集/ 前缀/ 真实/ 路由/ 和/ 虚拟/ 路由/ ./ 令/ 聚集/ 前缀/ 路由/ 数为/ m/ ,/ 它们/ 会/ 在/ 每块/ 线卡/ 存储/ ,/ 共为/ n/ ×/ m/ ./ 非/ 聚集/ 前缀/ 路由/ 只会/ 在/ 某/ 一块/ 线卡/ 存储/ ,/ 共/ 存储/ m/ -/ m/ ./ 而/ 对于/ 虚拟/ 路由/ 数量/ ,/ 依据/ 式/ (/ 5/ )/ 计算/ 可得/ ./ 所以/ ,/ DSF/ 方案/ 中/ 系统/ 的/ 转发/ 项/ 总量/ 为/ (/ m/ -/ m/ )/ +/ n/ ×/ m/ +/ (/ 2log2n/ ×/ (/ n/ -/ 1/ )/ )/ ,/ 即/ m/ +/ (/ m/ +/ 2log2n/ )/ ×/ (/ n/ -/ 1/ )/ ./ 由于/ 聚集/ 前缀/ 路由/ 数/ m/ 总是/ 较/ 小/ ,/ 所以/ 相对/ FBS/ 方案/ 中/ m/ ×/ n/ 的/ 转发/ 项/ 数量/ ,/ DSF/ 方案/ 在/ 系统/ 转发/ 项/ 总数/ 和/ 每/ 线卡/ 平均/ 转发/ 项数/ 有/ 很大/ 的/ 减少/ ,/ 大大/ 节省/ 了/ 硬件/ 存储资源/ ./ 5/ 优化/ 模型/ 互联网/ 中/ ,/ 地址/ 分配/ 零乱/ 且/ 不/ 延续/ ,/ 导致/ 路由表/ IP/ 前缀/ 分布/ 极/ 不/ 均衡/ ./ DSF/ 模型/ 虽然/ 能/ 将/ 系统/ 路由/ 分解/ 到/ 各/ 线卡/ ,/ 但/ 各/ 线卡/ 存储转发/ 项/ 数量/ 差别/ 极大/ ./ DSF/ 模型/ 对/ 两个/ 真实/ 路由表/ 的/ 实施/ 结果/ 都/ 说明/ 了/ 该/ 问题/ 的/ 存在/ ,/ 见表/ 2/ 和表/ 3/ ./ 所以/ ,/ 我们/ 设计/ 了/ 优化/ 模型/ :/ EDSF/ (/ EnhancedDSF/ )/ ,/ 希望/ 能/ 将/ FIB/ 表项/ 尽量/ 均匀/ 地/ 分解/ 到/ 各/ 线卡/ ./ 优化/ 方案/ 的/ 转发/ 引擎/ ,/ 仍然/ 通过/ 虚拟/ 路由/ 完成/ 报文/ 到/ 宿主/ 线卡/ LCattach/ 的/ 传送/ ,/ 线卡/ 功能/ 结构/ 与/ 图/ 2/ 一致/ ./ EDSF/ 模型/ 区别/ 于/ DSF/ 模型/ 的/ 主要/ 特征/ 是/ :/ 不同/ 的/ 单元/ 前缀/ 指定/ 策略/ ./ DSF/ 模型/ 的/ 单元/ 前缀/ 掩码/ 长度/ 总时/ 相等/ ,/ EDSF/ 模型/ 却/ 无此/ 约束/ ./ 优化/ 方案/ 主要/ 思想/ 是从/ 第/ 1/ 个/ bit/ 位/ 开始/ ,/ 每次/ 根据/ 路由/ IP/ 前缀/ 一个/ bit/ 位/ 的/ 值/ 对/ 核心/ 路由表/ 进行/ 分解/ ./ 针对/ 每次/ 分解/ ,/ 令该/ bit/ 位值/ 为/ 0/ 的/ 一份/ 为/ SEG0/ ,/ 值为/ 1/ 的/ 一份/ 为/ SEG1/ ./ 只要/ 分/ 得/ 部分/ 的/ 路由/ 数/ 大于/ 基准值/ m/ // 2n/ ,/ 即/ 平均/ 每/ 线卡/ 路由/ 数/ 的/ 1/ // 2/ ,/ 就/ 根据/ 下/ 一/ bit/ 位/ 的/ 值/ 继续/ 分解/ ./ 分解/ 完成/ 后/ ,/ 根据/ 树根/ 节点/ 到/ 每/ 一/ 叶子/ 节点/ 的/ bit/ 位值/ ,/ 生成/ 一个/ 单元/ 前缀/ PFXunit/ ,/ 单元/ 前缀/ 个数/ 就是/ 该/ 分解/ 树/ 的/ 叶子/ 节点/ 数/ ./ 每一/ PFXunit/ 只/ 分配/ 到/ 某/ 一线/ 卡/ ,/ 一块/ 线卡/ 可分/ 得/ 1/ 个/ 或/ 多个/ PFXunit/ ./ 分配/ 依据/ 是/ 归属/ 到/ 每/ 一线/ 卡/ 的/ 多个/ PFXunit/ 所辖/ 真实/ 路由/ 数/ 尽量/ 接近/ ./ 后续/ 处理/ ,/ 如/ 根据/ 单元/ 前缀/ 生成/ 虚拟/ 路由/ ,/ 以及/ 真实/ 路由/ 存储/ 过程/ 与/ 标准/ DSF/ 一致/ ./ 需要/ 说明/ ,/ 上述/ 基准值/ 的/ 指定/ 与/ 方案/ 所/ 需/ 分解/ 均衡/ 粒度/ 相关/ ,/ 基准值/ 越小/ 分解/ 得/ 越/ 平均/ ,/ 但会/ 带来/ 更/ 多/ 的/ 虚拟/ 路由/ ./ 下面/ 我们/ 举例说明/ 分解/ 树/ 产生/ 过程/ ./ 假设/ 某系/ Page7/ 统/ 核心/ 路由表/ 共有/ 100/ 条/ 路由/ ,/ 4/ 块/ 线卡/ ,/ 则/ 基准值/ m/ // 2n/ 为/ 12.5/ ./ 根据/ 前述/ 规则/ ,/ 只要/ 分解/ 后/ 的/ 节点/ 对应/ 的/ 路由/ 数/ 大于/ 12.5/ ,/ 就/ 根据/ 下/ 一/ bit/ 位/ 继续/ 分解/ ./ 图/ 4/ (/ a/ )/ 是/ 该/ 系统/ 对应/ 的/ 分解/ 树/ ,/ 其中/ 树/ 节点/ 圈内/ 数值/ 表示/ 归属/ 该/ 节点/ 前缀/ 的/ 路由/ 数/ ,/ / 外数/ 表示/ 该/ 节点/ 对应/ 前/ 若干/ bit/ 位/ 的/ 值/ ./ 如/ 第一次/ 分解/ ,/ 根据/ IP/ 前缀/ 第/ 1bit/ 位/ 分解/ ./ SEG0/ 有/ 76/ 项/ ,/ 对应/ 节点/ 0/ ,/ SEG1/ 有/ 24/ 项/ ,/ 对应/ 节点/ 1/ ./ 由于/ 节点/ 对应/ 路由/ 数都/ 大于/ 12.5/ ,/ 需要/ 根据/ 下/ 一/ bit/ 位/ 继续/ 分解/ ,/ 直至/ 所有/ 图/ 4/ 基于/ EDSF/ 的/ 分解/ 树/ 示例/ 叶/ 节点/ 每/ 节点/ LC00000010000107001825LC1000015000111101100925LC21010011011101110324LC301111121109111526/ 所有/ 单元/ 前缀/ 都/ 是/ 分解/ 树/ 的/ 叶子/ 节点/ ,/ 则/ 任意/ 两个/ 单元/ 前缀/ 的/ 覆盖范围/ 交集/ 为空/ ./ 所以/ 对于/ 任/ 一路/ 由/ 前缀/ PFXdst/ ,/ 最/ 多只/ 可能/ 归属于/ 一个/ PFXunit/ ./ 由于/ 分解/ 树/ 覆盖/ 了/ IP/ 前缀/ 的/ 全集/ ,/ 而且/ 是从/ 树根/ 开始/ ,/ 依次/ 根据/ 1/ 个/ bit/ 位/ 进行/ 分解/ 的/ ./ 所以/ ,/ 如果/ 一个/ PFXdst/ 不/ 归属/ 任一/ PFXunit/ ,/ 则/ 必有/ 对应/ 的/ 非/ 叶子/ 节点/ ./ 以其为/ 根/ 的/ 子树中/ ,/ 叶子/ 节点/ 代表/ 的/ 单元/ 前缀/ 全部/ 归属/ 该/ PFXdst/ ./ 如图/ 4/ 中/ ,/ 前缀/ 128.0/ ./ 0.0/ // 1/ 不/ 归属/ 分解/ 树/ 任一/ PFXunit/ ,/ 其/ 对应/ 非/ 叶子/ 节点/ 1/ ./ 以/ 节点/ 1/ 为根/ 的/ 子树/ 所有/ 单元/ 前缀/ :/ 128.0/ ./ 0.0/ // 2/ (/ 节点/ 10/ )/ ,/ 192.0/ ./ 0.0/ // 3/ (/ 节点/ 110/ )/ 和/ 224.0/ ./ 0.0/ // 3/ (/ 节点/ 111/ )/ 都/ 归属/ 128.0/ ./ 0.0/ // 1/ ./ EDSF/ 模型/ 在/ 指定/ 单元/ 前缀/ 并/ 分属/ 到/ 各/ 线卡/ 后/ ,/ 对于/ 系统/ 的/ 任一/ 核心/ 路由/ 项/ ,/ 其/ 分解/ 存储/ 方法/ 遵循/ 规则/ 4/ ./ 规则/ 4/ ./ 令/ 一条/ 核心/ 路由/ 目的/ IP/ 前缀/ 为/ PFXdst/ ,/ 若/ PFXdst/ 归属/ 某/ 单元/ 前缀/ PFXunit/ (/ i/ )/ ,/ 即/ 叶子/ 节点/ 对应/ 的/ 路由/ 数都/ 不/ 大于/ 12.5/ ./ 图/ 4/ (/ a/ )/ 中/ ,/ 虚/ 框内/ 节点/ 01/ 分解/ 后/ ,/ 所有/ 路由/ 都/ 被/ 节点/ 011/ 继承/ ,/ 此次/ 分解/ 没有/ 意义/ ./ 所以/ ,/ 可/ 对/ 图/ 4/ (/ a/ )/ 中虚/ 框内/ 结点/ 压缩/ 为/ 一个/ 节点/ ,/ 压缩/ 后/ 的/ 分解/ 树如图/ 4/ (/ b/ )/ 所示/ ./ 分解/ 树/ 生成/ 后/ ,/ 根据/ 路由/ 均分/ 原则/ 将/ 单元/ 前缀/ 归属/ 到/ 各/ 线卡/ ./ 如表/ 1/ ,/ 各/ 线卡/ 分/ 得/ 路由/ 数/ 分别/ 为/ 25/ ,/ 25/ ,/ 24/ ,/ 26/ ./ 表中/ 每个/ 叶子/ 节点/ 对应/ 一个/ 单元/ 前缀/ ,/ 如/ 节点/ 00000/ 对应/ PFXunit/ :/ 0.0/ ./ 0.0/ // 5/ ,/ 节点/ 10/ 对应/ PFXunit/ :/ 128.0/ ./ 0.0/ // 2/ ./ PFXdst/ / PFXunit/ (/ i/ )/ ,/ 则/ 对应/ 转发/ 项/ 存储/ 在/ PFXunit/ (/ i/ )/ 所属/ 的/ 线卡/ ;/ 若/ PFXdst/ 不/ 归属/ 任何/ PFXunit/ ,/ 则/ 对应/ 转发/ 项/ 存储/ 在/ PFXdst/ 对应/ 子树/ 的/ 单元/ 前缀/ 所属/ 线卡/ ./ 以图/ 4/ 及表/ 1/ 进行/ 说明/ ./ 若/ 一条/ 路由/ 前缀/ 为/ 33.0/ ./ 0.0/ // 8/ ,/ 它/ 归属/ 节点/ 001/ 对应/ 的/ 单元/ 前缀/ 32.0/ ./ 0.0/ // 3/ ,/ 该/ 单元/ 前缀/ 分配/ 给/ 了/ LC0/ ,/ 所以/ 将/ 该/ 路由/ 存储/ 在/ LC0/ ./ 若/ 一条/ 路由/ 前缀/ 为/ 128.0/ ./ 0.0/ // 1/ ,/ 不/ 归属/ 任一/ 单元/ 前缀/ ,/ 而/ 对应/ 非/ 叶子/ 节点/ 1/ ./ 以/ 节点/ 1/ 为根/ 的/ 子树有/ 3/ 个/ 叶子/ 结点/ ,/ 其/ 单元/ 前缀/ 分别/ 属于/ LC2/ 和/ LC3/ ./ 所以/ ,/ 前缀/ 为/ 128.0/ ./ 0.0/ // 1/ 的/ 路由/ 项/ 存储/ 在/ LC2/ 和/ LC3/ ./ 现实/ 互联网/ 中/ ,/ 没有/ 前缀/ 长度/ 小于/ 8/ 的/ 路由/ ./ 所以/ ,/ 只有/ 当/ 分解/ 树/ 的/ 深度/ 达到/ 9/ 以上/ 时/ ,/ 真实/ 路由/ 的/ IP/ 前缀/ 才/ 可能/ 出现/ 在/ 分解/ 树/ 的/ 非/ 叶子/ 节点/ 上/ ,/ 此时/ 出现/ 真实/ 路由/ 的/ 冗余/ 存储/ ./ 而/ 一般/ 情况/ ,/ EDSF/ 分解/ 树/ 的/ 深度/ 很难/ 达到/ 9/ 以上/ ./ 所以/ ,/ EDSF/ 模型/ 出现/ 真实/ 路由/ 在/ 多块/ 线卡/ 存储/ 的/ 概率/ 很小/ ./ 真实/ 路由/ 分解/ 存储/ 后/ ,/ 如/ 3.2/ 节/ 描述/ 思想/ ,/ 系统/ 根据/ 单元/ 前缀/ 产生/ 虚拟/ 路由/ 并/ 存储/ ./ 对/ 任一/ 单元/ 前缀/ PFXunit/ (/ i/ )/ ,/ 若/ 其/ 被/ 分配/ 给/ 第/ j/ 块/ 线卡/ ,/ 系统/ 增加/ 一条/ IP/ 前缀/ 为/ 单元/ 前缀/ 的/ 虚拟/ 路由/ :/ 〈/ PFXunit/ (/ i/ )/ ,/ j/ ,/ Inv/ ,/ Inv/ 〉/ (/ Inv/ 表示/ 一个/ 无效/ 值/ )/ 并/ 通告/ 该/ 路由/ 给/ Page8/ 除/ LCj/ 外/ 的/ 所有/ 线卡/ 存储/ ./ 下面/ 给出/ EDSF/ 模型/ 相关/ 算法/ ./ 算法/ 3/ 用于/ EDSF/ 模型/ 分解/ 树/ 生成/ ,/ 是/ 一个/ 递归/ 算法/ ./ 参数/ SETrt/ 表示/ 本次/ 待/ 分解/ 的/ 路由/ 集合/ ,/ 参数/ i/ 表示/ 依据/ 第/ i/ 个/ bit/ 位/ 进行/ 分解/ ./ 首次/ 调用/ 中/ ,/ 参数/ SETrt/ 是/ 所有/ 路由/ 项/ 的/ 集合/ ,/ i/ 等于/ 1/ ./ 只要/ 分得/ 的/ SEG0/ 容量/ 大于/ m/ // 2n/ ,/ 就/ 对/ SEG0/ 进行/ 分解/ ,/ 之后/ 再/ 回朔/ 分解/ SEG1/ ,/ 分解/ 过程/ 是/ 深度/ 优先/ 进行/ ./ 另外/ ,/ 可以/ 对/ 单脉/ 相传/ 的/ 节点/ 进行/ 压缩/ ./ 即/ 一次/ 分解/ 后/ 所有/ 的/ 路由/ 项/ 都/ 由/ 某/ 一子/ 节点/ 继承/ ,/ 则/ 该次/ 分解/ 无需/ 进行/ ,/ 并/ 根据/ 下/ 一/ bit/ 位/ 进行/ 分解/ ./ 算法/ 4/ 描述/ 了/ 系统/ 真实/ 路由/ 项/ 的/ 存储/ 方法/ ./ 若/ 目的/ IP/ 前缀/ PFXdst/ 归属/ 某/ 单元/ 前缀/ PFXunit/ (/ i/ )/ ,/ 则/ 该/ 路由/ 项/ 只/ 存储/ 在/ 一块/ 线卡/ :/ PFXunit/ (/ i/ )/ 所属/ 的/ 线卡/ ,/ 算法/ 会/ 跳出/ 内层/ 循环/ ./ 否则/ ,/ 该/ 路由/ 存储/ 在/ PFXdst/ 对应/ 子树/ 所有/ 叶子/ 节点/ 的/ 单元/ 前缀/ 所属/ 线卡/ ./ 算法/ 会/ 遍历/ 所有/ 单元/ 前缀/ ,/ 只要/ 满足/ PFXunit/ / PFXdst/ ,/ 就/ 把/ 路由/ 存储/ 到/ 该/ 单元/ 前缀/ 所属/ 线卡/ ./ 算法/ 5/ 实现/ 虚拟/ 路由/ 存储/ ./ 依次/ 对/ 每/ 一/ PFXunit/ ,/ 以其为/ 目的/ IP/ 前缀/ 生成/ 虚拟/ 路由/ ,/ 虚拟/ 路由/ 的/ 出线/ 卡是/ 该/ 单元/ 前缀/ 所属/ 线卡/ ,/ 出/ 接口/ 和/ 下/ 一/ 跳/ 为/ 无效/ 值/ ./ 该/ 虚/ 路由/ 存储/ 在/ PFXunit/ 所属/ 线卡/ 之外/ 的/ 其它/ 线卡/ ./ 算法/ 3/ ./ Distribute/ -/ Tree/ (/ SETrt/ ,/ i/ )/ ./ 1/ ./ SEG0issubsetofSETrt/ ,/ satisfiedwith2/ ./ SEG1issubsetofSETrt/ ,/ satisfiedwith3/ ./ if/ (/ |/ SEG0/ |/ >/ m/ // 2n/ )/ Distribute/ -/ Tree/ (/ SEG0/ ,/ i/ +/ 1/ )/ ;/ 4/ ./ if/ (/ |/ SEG1/ |/ >/ m/ // 2n/ )/ Distribute/ -/ Tree/ (/ SEG1/ ,/ i/ +/ 1/ )/ ;/ 5/ ./ return/ ;/ 算法/ 4/ ./ Hand/ -/ Actual/ -/ RT/ ./ 1/ ./ for/ (/ i/ =/ 1/ ;/ i/ </ =/ m/ ;/ i/ ++/ )/ 2/ ./ getPFXdstofRTi/ ;/ 3/ ./ for/ (/ j/ =/ 1/ ;/ j/ </ =/ |/ PFXunit/ |/ ;/ i/ ++/ )/ 4/ ./ ifPFXdst/ / PFXunit/ [/ j/ ]/ 5/ ./ gettheLCPFXunit/ [/ j/ ]/ belongsto/ ;/ 6/ ./ RTiisstoredinthisLC/ ;/ 7/ ./ break/ ;/ 8/ ./ ifPFXunit/ [/ j/ ]/ / PFXdst9/ ./ gettheLCPFXunit/ [/ j/ ]/ belongsto/ ;/ 10/ ./ RTiisstoredinthisLC/ ;/ 11/ ./ return/ ;/ 算法/ 5/ ./ Hand/ -/ Virtual/ -/ RT/ ./ 1/ ./ for/ (/ i/ =/ 1/ ;/ i/ </ =/ |/ PFXunit/ |/ ;/ i/ ++/ )/ 2/ ./ LCjistheLCPFXunit/ [/ i/ ]/ belongsto/ ;/ 3/ ./ constructvirtual/ _/ rt/ :/ 〈/ “/ PFXunit/ (/ i/ )/ ,/ LCj/ ,/ Inv/ ,/ Inv/ ”/ 〉/ ;/ 4/ ./ sendvirtual/ _/ rttoallLCexceptLCj/ ;/ 5/ ./ return/ ;/ 算法/ 实施/ 在/ 主控板/ 完成/ ,/ 各/ 线卡/ 只/ 需/ 对/ 主控/ 引擎/ 发来/ 的/ 转发/ 项/ 进行/ 存储/ 即可/ ./ EDSF/ 模型/ 完成/ 转发/ 项/ 分解/ 存储/ 后/ ,/ 报文/ 转发/ 过程/ 与/ DSF/ 模型/ 相同/ ./ 所以/ ,/ EDSF/ 模型/ 的/ 线卡/ 功能设计/ 与/ DSF/ 模型/ 完全/ 一样/ ,/ 图/ 2/ 所示/ ./ EDSF/ 模型/ 中/ ,/ 每一/ 单元/ 前缀/ 生成/ 一条/ 虚拟/ 路由/ ,/ 而/ 每条/ 虚拟存储/ 在/ (/ n/ -/ 1/ )/ 块/ 线卡/ ./ 所以/ ,/ 系统/ 总共/ 存储/ 虚拟/ 路由/ 数为/ (/ n/ -/ 1/ )/ ×/ |/ Sunit/ |/ ./ 虚拟/ 路由/ 数/ 与/ 线卡/ 数量/ 或/ 单元/ 前缀/ 数/ 成正比/ 关系/ ./ 而/ 对于/ 单元/ 前缀/ 个数/ ,/ 在线/ 卡数/ 一定/ 的/ 情况/ 下/ ,/ 与/ 真实/ 路由/ 数量/ 及/ 路由/ IP/ 前缀/ 分布/ 是否/ 均匀/ 相关/ ./ 路由/ IP/ 前缀/ 分布/ 得/ 越/ 均匀/ ,/ 需要/ 的/ 单元/ 前缀/ 越/ 少/ ;/ 而/ 真实/ 路由/ 越/ 多/ ,/ 则/ 需要/ 的/ 单元/ 前缀/ 越多/ ./ EDSF/ 模型/ 虚拟/ 路由/ 数比/ DSF/ 模型/ 略有/ 增加/ ,/ 但/ 基本/ 维持/ 一个/ 数量级/ ,/ 参见/ 表/ 2/ 、/ 表/ 3/ 实际/ 路由表/ 分析/ ./ 6/ 实验/ 分析/ 实验/ 系统/ 利用/ 5/ 台/ 安装/ Linux/ 操作系统/ 的/ PC机/ 完成/ ./ 交换机/ 模拟/ 路由器/ 内部/ 交换/ 网络/ ,/ PC0/ -/ 3/ 模拟/ 4/ 块/ 线卡/ ,/ PC4/ 模拟/ 主控/ ./ 主控/ 主要/ 负责管理/ 路由表/ 及/ 向/ 线卡/ 分发/ 路由/ ./ 这样/ ,/ 1/ 块/ 主控/ 及/ 4/ 块/ 线卡/ 构成/ 一台/ 可/ 扩展/ 分布式/ 路由/ 系统/ ./ PC0/ -/ 3/ 都/ 安装/ 两块/ 以太网卡/ ,/ Eth0/ 用于/ 联接/ 内部/ 网络/ ,/ Eth1/ 用于/ 路由器/ 系统/ 的/ 外部/ 通信/ ./ 各/ 线卡/ 利用/ CLICK/ [/ 10/ ]/ 模块/ 仿真/ 路由器/ 转发/ 引擎/ ./ CLICK/ 现有/ 功能/ 可/ 支持/ 传统/ FBS/ 模型/ ,/ 而/ 按/ 图/ 2/ 功能/ 整改/ 又/ 可/ 支持/ DSF/ 模型/ 和/ EDSF/ 模型/ ./ 线卡/ 可/ 支持/ 几种/ 模型/ 的/ 功能/ 切换/ ./ 我们/ 获取/ 了/ 真实/ 路由表/ 对/ 各种/ 存储/ 模型/ 进行/ 分析/ ./ Data1/ ①/ 和/ Data2/ ②/ 分别/ 是/ CERNET/ 和/ AS65000/ 真实/ 运营/ 中/ 的/ 路由表/ ./ 在/ 主控/ 上/ 分别/ 注入/ Data1/ 和/ Data2/ 路由表/ ,/ 再/ 查看/ 各/ 线卡/ 转/ 发表/ 存储/ 情况/ ./ 实验/ 分别/ 基于/ 4/ 种/ 转发/ 存储/ 模型/ 进行/ ,/ 实验/ 结果/ 如图/ 5/ 、/ 图/ 6/ 所示/ ./ 其中/ ,/ SPAL/ 模型/ 面向/ Data1/ 最优/ 选择/ 第/ 10/ 及第/ 13/ 位/ 进行/ 分解/ ,/ 面向/ Data2/ 最优/ 选择/ 第/ 14/ 及第/ 15/ 位/ 进行/ 分解/ ./ 我们/ 对/ 数据/ 的/ 进一步/ 整理/ 分析/ 为表/ 2/ 和表/ 3/ ./ 可以/ 看出/ ,/ 相对/ 传统/ 的/ FBS/ 模型/ ,/ 无论/ 线卡/ 数量/ 多少/ 或者/ 不同/ 的/ 路由表/ ,/ DSF/ 模型/ 和/ EDSF/ 模型/ 都/ 能/ ①/ ②/ Page9/ 大量/ 减少/ 系统/ 转发/ 项/ 数量/ ./ DSF/ 模型/ 中/ ,/ 虽然/ 实现/ 转发/ 项/ 分解/ 存储/ ,/ 但/ 各/ 线卡/ 存储/ 的/ 转发/ 项/ 数量/ 差异/ 非常/ 大/ ./ 同时/ ,/ EDSF/ 模型/ 却/ 能/ 实现/ 将/ 路由/ 非常/ 平均/ 地/ 分解/ 存储/ 在/ 各块/ 线卡/ ./ DSF/ 模型/ 和/ EDSF/ 模型/ 增加/ 的/ 虚拟/ 路由/ 数量/ 都/ 很小/ ,/ EDSF/ 较之/ DSF/ ,/ 虚拟/ 路由/ 增加/ 略/ 多/ ./ 相对/ SPAL/ ,/ EDSF/ 模型/ 分解/ 更为/ 平均/ ,/ 带来/ 的/ 额外/ 存储/ 也/ 更少/ ,/ 即/ 最后/ 存储/ 的/ 路由/ 总数/ 更少/ ./ 表/ 2/ 基于/ Data1/ (/ CERNET/ 路由表/ )/ 的/ 不同/ 模型/ 存储/ 分析/ 每/ 线卡/ 最多/ FBS530185301815905400212072DSF2973844850122525353030EDSF133471309304525453063SPAL136541293366072153084/ 表/ 3/ 基于/ Data2/ (/ AS65000/ 路由表/ )/ 的/ 不同/ 模型/ 存储/ 分析/ 每/ 线卡/ 最多/ FBS22443522443567330500897740DSF1103702417801286192224447EDSF57105554480391657224474SPAL5769955709265101990227086/ 上述/ DSF/ // EDSF/ 分解/ 过程/ 中/ ,/ 没有/ 出现/ 某条/ 路由/ 目的/ 前缀/ 是/ 聚集/ 前缀/ 的/ 情况/ ,/ 所以/ 不/ 存在/ 真实/ 路由/ 的/ 冗余/ 存储/ ./ 整个/ 分解/ 存储/ 过程/ 中/ ,/ DSF/ // EDSF/ 模型/ 只/ 增加/ 了/ 少量/ 的/ 虚拟/ 路由/ ,/ 并且/ 不/ 存在/ 一条/ 真实/ 路由/ 的/ 冗余/ 存储/ ,/ 具有/ 很/ 好/ 的/ 存储/ 性能/ ./ 从/ 线卡/ 路由/ 数/ 最大/ 差值/ 和/ 路由/ 存储/ 总数/ 两/ 方面/ 分析/ ,/ 显然/ EDSF/ 模型/ 具有/ 最好/ 的/ 存储/ 性能/ ./ 最后/ ,/ 我们/ 将/ 仿真/ 路由器/ 的/ 外部/ 接口/ 与/ 普通/ PC/ 相连/ ,/ 验证/ DSF/ // EDSF/ 模型/ 能/ 根据/ 灌入/ 路由/ 进行/ 正常/ 报文/ 转发/ ./ 7/ 总结/ 本文/ 设计/ 的/ 转/ 发表/ 分解/ 存储/ 模型/ 以/ IP/ 前缀/ 的/ 前/ 若干/ bit/ 位/ 进行/ 分解/ 存储/ ,/ 实现/ 线卡/ 对/ FIB/ 表/ 的/ 分解/ 存储/ ./ 该/ 模型/ 在/ 各/ 线卡/ 增加/ 少量/ 虚拟/ 路由/ 与/ 真实/ 路由/ 项/ 共存/ 于/ 一个/ 转/ 发表/ ./ 线卡/ 转发/ 引擎/ 的/ LPM/ 查询/ 集成/ 了/ 对/ 虚拟/ 路由/ 和/ 真实/ 路由/ 项/ 的/ 查找/ ,/ 既/ 可/ 实现/ 转发/ 下/ 一/ 跳/ 查询/ ,/ 又/ 可/ 实现/ 报文/ 到/ 转发/ 子表/ 的/ 对应/ ./ DSF/ 模型/ 大大降低/ 了/ 系统/ 总共/ 存储转发/ 条目/ 及/ 各/ 线卡/ 存储转发/ 条目/ ,/ 节省/ 了/ 硬件资源/ 及/ 电能/ 开销/ ./ 而且/ ,/ 本文/ 还/ 针对/ 真实/ 网络/ 中路/ 由/ IP/ 前缀/ 分布/ 不/ 均衡/ 特征/ ,/ 设计/ 了/ 改进/ 方案/ EDSF/ ,/ 它/ 使/ 各/ 线卡/ 存储/ 的/ 转发/ 项数/ 非常/ 均衡/ ./ 与/ 现有/ SPAL/ 技术/ 比较/ ,/ 在/ 路由/ 存储/ 的/ 均衡/ 度及/ 冗余/ 率/ 方面/ 都/ 有/ 了/ 进一步/ 的/ 改进/ 及/ 提高/ ./ 根据/ 对/ 当前/ 正在/ 运营/ 的/ 两个/ 路由器/ 路由表/ 数据/ 进行/ 分析/ ,/ 证明/ 了/ 本文/ 分解/ 存储/ 方法/ 的/ 优越性/ ./ 而且/ ,/ 无论/ DSF/ 模型/ 或/ EDSF/ 模型/ ,/ 都/ 有/ 较/ 强/ 兼容性/ ,/ 只/ 需/ 在/ 现有/ 商业/ 路由器/ 上/ 做/ 极小/ 的/ 改动/ 即可/ 实现/ ./ 所以/ ,/ 该/ 方法/ 可/ 快速/ 进入/ 产业化/ 进程/ ,/ 具有/ 很/ 好/ 的/ 现实意义/ ./ 对于/ 线卡/ 数量/ 更/ 多/ 的/ 可/ 扩展/ 路由器/ ,/ 本文/ 的/ 分解/ 存储/ 方法/ 尤为/ 适合/ ./ 致谢/ 本/ 论文/ 工作/ 在/ 清华大学/ 完成/ ,/ 感谢/ 清华大学/ 网络/ 研究所/ 的/ 支持/ !/ 

