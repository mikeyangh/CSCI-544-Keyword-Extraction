Page1/ 片上/ 网络延时/ 差异/ 对/ 存储系统/ 公平性/ 的/ 影响/ 及/ 对策/ 刘胜/ 陈书明/ 尹亚明/ 陈胜刚/ 谷会涛/ 陈小文/ 王耀华/ (/ 国防科学技术大学/ 计算机/ 学院/ 长沙/ 410073/ )/ 摘要/ 研究/ 了/ 在/ 基于/ 片上/ 网络/ (/ NetworkonChip/ ,/ NoC/ )/ 结构/ 的/ 单芯片/ 多处理器/ (/ ChipMultipleProcessors/ ,/ CMPs/ )/ 中/ ,/ 访存/ 请求/ 的/ NoC/ 延时/ 差异/ 对/ 存储系统/ 的/ 公平性/ 带来/ 的/ 影响/ ./ 针对/ 该/ 问题/ 进行/ 了/ 理论/ 分析/ 、/ 抽象/ ,/ 并/ 构建/ 试验/ 模型/ ,/ 从/ 网络/ 规模/ 、/ 报文/ 比例/ 等/ 4/ 个/ 方面/ 对/ 造成/ 访存/ 请求/ 的/ NoC/ 延时/ 差异/ 的/ 原因/ 进行/ 了/ 讨论/ ./ 最后/ 提出/ 了/ 一种/ 基于/ 片上/ 网络延时/ 的/ 存储器/ 访问/ 调度/ 方法/ (/ SchedulingBasedonNoCLatency/ ,/ SBNL/ )/ ,/ 与/ 传统/ 的/ 方法/ 相比/ ,/ 能够/ 将/ NoC/ 延时/ 差异/ 对/ 访存/ 请求/ 公平性/ 的/ 影响/ 降低/ 20/ %/ 左右/ ,/ 并/ 带来/ 15.7/ %/ 的/ 执行/ 效率/ 提升/ ./ 关键词/ 片上/ 网络/ ;/ 延时/ 差异/ ;/ 存储/ ;/ 公平性/ ;/ 调度/ 1/ 引言/ CMPs/ 是/ 一种/ 公认/ 的/ 能够/ 有效/ 利用/ 单片/ 集成/ 超过/ 10/ 亿个/ 晶体管/ 能力/ 的/ 体系结构/ ./ 目前/ 的/ CMPs/ 已/ 逐渐/ 从多核/ (/ multi/ -/ core/ ,/ 4/ ~/ 16cores/ )/ 向/ 众核/ (/ many/ -/ core/ ,/ 16/ ~/ 256cores/ )/ 发展/ ,/ 如/ Intel/ 公司/ 的/ 8/ 核/ 的/ Xeon/ 处理器/ [/ 1/ ]/ 、/ STI/ 联盟/ 的/ 9/ 核/ Cell/ [/ 2/ ]/ 、/ SUN/ 公司/ 的/ 8/ 核/ UltraSPARCT2/ [/ 3/ ]/ 、/ Tilera/ 公司/ 64/ 核/ 的/ TILEPro64/ 和/ 100/ 核/ 的/ TILEGM/ -/ 100/ [/ 4/ -/ 5/ ]/ 、/ Intel/ 公司/ 的/ 80/ 核/ Teraflop/ [/ 6/ ]/ 等/ ./ 当/ 处理器/ 中核/ 的/ 数目/ 到达/ 一定/ 规模/ 时/ ,/ 传统/ 的/ 共享/ 总线/ 模式/ 在/ 带宽/ 、/ 功耗/ 、/ 延时/ 及/ 全局/ 同步/ 等/ 问题/ 上均/ 遇到/ 了/ 难以逾越/ 的/ 障碍/ ./ NoC/ 技术/ 以/ 成本/ 低廉/ 的/ 点对点/ 分组/ 互连/ 取代/ 传统/ Page2/ 的/ 总线/ 模式/ ,/ 能够/ 较/ 好地解决/ 上述/ 问题/ [/ 7/ ]/ ./ “/ 存储/ 墙/ ”/ 是/ 伴随/ 着/ 现代/ 处理器/ 的/ 出现/ 就/ 一直/ 存在/ 的/ 问题/ [/ 8/ ]/ ./ 在/ CMPs/ 中/ ,/ 这一/ 问题/ 依然/ 存在/ 甚至/ 更加/ 突出/ ./ CMPs/ 系统/ 中/ 的/ PE/ 一般/ 通过/ NoC/ 进行/ 信息/ 交换/ 并/ 共享/ 存储资源/ ./ 在/ 所有/ 共享/ 的/ 存储资源/ 中/ ,/ 片外/ 存储资源/ 将/ 对系统/ 的/ 性能/ 产生/ 重要/ 影响/ [/ 9/ ]/ ./ 由于/ 受到/ 芯片/ 管脚/ 的/ 约束/ 和/ 制造/ 工艺/ 的/ 限制/ ,/ 片/ 外存储器/ 控制器/ 的/ 数目/ 、/ 位置/ 和/ 带宽/ 均/ 为/ 受限/ 的/ ,/ CMPs/ 相对/ 于/ 传统/ 的/ 多处理机系统/ 其/ 存储资源/ 更加/ 珍贵/ ,/ 因而/ 需要/ 更加/ 公平合理/ 地/ 在线/ 程/ 之间/ 进行/ 分配/ ./ 片外/ 存储资源/ 不/ 公平/ 分配/ 会/ 导致/ 以下/ 问题/ [/ 10/ -/ 12/ ]/ :/ (/ 1/ )/ 由于/ 某些/ 线程/ 被/ 不公平地/ 赋予/ 较/ 高/ 的/ 优先级/ ,/ 会/ 使/ 另外/ 某些/ 线程/ 的/ 访存/ 请求/ 等待/ 过长/ ,/ 从而/ 影响/ 系统/ 的/ 整体/ 性能/ ;/ (/ 2/ )/ 会/ 使/ 系统软件/ 级/ 程序/ (/ 如/ 操作系统/ 或/ 虚拟机/ )/ 中/ 的/ 基于/ 线程/ 优先级/ 调度/ 的/ 策略/ 失效/ ;/ (/ 3/ )/ 减少/ 了/ 应用程序/ 的/ 性能/ 可预测性/ ./ 存储系统/ 的/ 公平性/ 从/ 本质/ 上/ 讲/ 是/ 提高/ 访存/ 请求/ 的/ 服务质量/ (/ QualityofService/ ,/ QoS/ )/ 从而/ 提高/ 系统/ 整体/ 性能/ 的/ 问题/ ./ 随着/ NoC/ 规模/ 的/ 扩大/ ,/ 访存/ 请求/ 的/ NoC/ 延时/ 差异/ 已/ 逐渐/ 成为/ 影响/ 访存/ 公平性/ 的/ 一个/ 重要/ 因素/ ,/ 如/ 在/ 64/ 结点/ 的/ CMPs/ 中/ 不同/ PE/ 访存/ 请求/ 的/ NoC/ 延时/ 差异/ 已达/ 180/ 个/ 时钟/ 周期/ (/ 详情/ 见/ 第/ 4/ 节/ )/ ,/ 而/ 一般/ 情况/ 下/ 外部/ 存储器/ 的/ 访问/ 延时/ 只有/ 几十/ 到/ 几百/ 拍/ ./ 已有/ 的/ 存储器/ 调度/ 算法/ [/ 10/ -/ 12/ ]/ ,/ 只/ 考虑/ 到/ 了/ 不同/ 线程/ 的/ 访存/ 请求/ 在/ 存储器/ 控制器/ 内部/ 的/ 相互影响/ ,/ 在/ 高效/ 利用/ 存储/ 带宽/ 的/ 前提/ 下/ 通过/ 策略/ 保证/ 不同/ 线程/ 的/ 访存/ 公平性/ ,/ 但是/ 忽略/ 了/ CMPs/ 中/ NoC/ 延时/ 差异/ 对/ 访存/ 公平性/ 的/ 影响/ ./ 本文/ 将/ 对/ 这/ 一/ 因素/ 进行/ 深入分析/ ,/ 并/ 提出/ 解决方案/ ./ 本文/ 的/ 主要/ 贡献/ 如下/ :/ (/ 1/ )/ 首次/ 提出/ NoC/ 延时/ 差异/ 将/ 成为/ 影响/ 外部/ 存储器/ 访问/ 公平性/ 的/ 重要/ 因素/ ;/ (/ 2/ )/ 对/ NoC/ 延时/ 差异/ 影响/ 访存/ 公平性/ 的/ 现象/ 进行/ 了/ 分析/ 建模/ 并/ 构建/ 了/ 模拟/ 平台/ ,/ 分析/ 了/ 影响/ 外部/ 存储系统/ 公平性/ 的/ 4/ 个/ 因素/ ;/ (/ 3/ )/ 提出/ 了/ SBNL/ (/ SchedulingBasedonNetworkLatency/ )/ 的/ 存储器/ 访问/ 调度/ 方法/ ,/ 该/ 方法/ 与/ 传统/ 的/ 调度/ 方法/ 相比/ 能够/ 有效/ 地/ 减少/ NoC/ 延时/ 差异/ 对/ 访存/ 请求/ 公平性/ 的/ 影响/ ,/ 并/ 带来/ 一定/ 的/ 系统/ 效率/ 提升/ ./ 2/ 相关/ 研究/ 工作/ 已有/ 很多/ 人员/ 对外部/ 存储系统/ 的/ 公平性/ 及/ QoS/ 进行/ 了/ 研究/ ./ 关于/ 在/ 存储器/ 控制器/ (/ MemoryController/ ,/ MC/ )/ 上/ 采取/ 策略/ 调节/ 不同/ 线程/ 的/ 访存/ 公平性/ 的/ 观点/ 最早/ 出现/ 在/ Nesbit/ 等/ 人/ [/ 10/ ]/ 的/ 文章/ ,/ 作者/ 基于/ 网络/ 公平/ 队列/ 的/ 概念/ 提出/ 了/ NFQ/ (/ NetworkFairQueuing/ )/ 调度/ 算法/ ,/ 其/ QoS/ 目标/ 为/ :/ 一个/ 线程/ i/ 如果/ 被/ 分配/ 了/ 系统/ 存储/ 带宽/ 的/ φ/ i/ 部分/ ,/ 那么/ 其/ 运行/ 速度/ 不应/ 比/ 一个/ 相同/ 的/ 线程/ 单独/ 运行/ 在/ 一个/ 频率/ 是/ 原有/ 存储系统/ 频率/ φ/ i/ 的/ 存储系统/ 中慢/ ./ Mutlu/ 等/ 人/ [/ 11/ -/ 12/ ]/ 认为/ NFQ/ 算法/ 在/ 某些/ 情况/ 下/ 并/ 不能/ 确保/ 公平/ ,/ 并且/ 不同/ 的/ 线程/ 同时/ 运行/ 时/ ,/ 获取/ 存储/ 带宽/ 并/ 不/ 意味着/ 一定/ 能/ 取得/ 相对/ 应/ 的/ 性能/ ./ 因此/ 提出/ 了/ 一种/ 新/ 的/ STFM/ (/ Stall/ -/ TimeFairMemory/ )/ 调度/ 算法/ ,/ 该/ 方法/ 的/ QoS/ 定义/ 为/ :/ 如果/ CMPs/ 中/ 运行/ 的/ 线程/ 具有/ 相同/ 的/ 优先级/ ,/ 那么/ 其/ 存储器/ 相关/ 的/ 减速/ (/ 在/ MC/ 中/ 由于/ 其它/ 线程/ 的/ 影响/ )/ 应该/ 相同/ ./ 已有/ 的/ 存储器/ 调度/ 算法/ ,/ 均/ 是/ 在/ 采用/ FR/ -/ FCFS/ (/ First/ -/ ReadyFirst/ -/ Come/ -/ First/ -/ Service/ )/ 调度/ 方法/ 的/ 基础/ 上/ 增加/ 了/ QoS/ 方面/ 的/ 考虑/ ./ 这些/ 方法/ 仅/ 考虑/ 到/ 了/ 不同/ 线程/ 的/ 访存/ 请求/ 在/ 存储器/ 控制器/ 内部/ 的/ 相互影响/ ,/ 在/ 高效/ 利用/ 存储/ 带宽/ 的/ 前提/ 下/ 通过/ 策略/ 保证/ 不同/ 线程/ 的/ 访存/ 公平性/ ,/ 但是/ 忽略/ 了/ CMPs/ 中/ NoC/ 延时/ 差异/ 对/ 访存/ 公平性/ 的/ 影响/ ./ 将/ 存储器/ 系统/ 的/ 特点/ 和/ NoC/ 控制/ 结合/ 起来/ 研究/ 的/ 工作/ 在/ 最近/ 得到/ 了/ 较/ 多/ 的/ 关注/ ./ Dutt/ 提出/ 了/ 面向/ 存储器/ 的/ NoC/ 设计/ 方法学/ [/ 13/ ]/ ,/ 认为/ 随着/ 芯片/ 集成/ 规模/ 的/ 扩大/ ,/ 片上/ 资源/ 主要/ 被/ 存储资源/ 占据/ ,/ 同时/ 许多/ 存储/ 敏感/ 的/ 应用/ 被/ 映射/ 到/ 芯片/ 上/ ,/ 因而/ 必须/ 在/ NoC/ 设计/ 的/ 早期/ 就/ 考虑/ 存储器/ 相关/ 的/ 事宜/ (/ 如/ 划分/ 层次/ 和/ 访问/ 结构/ 等/ )/ ./ Jang/ 等/ 人/ [/ 14/ ]/ 设计/ 了/ 一种/ 考虑/ SDRAM/ 特性/ 的/ NoC/ 路由器/ ,/ 该/ 路由器/ 赋予/ 报文/ 不同/ 的/ 优先级/ 以/ 减少/ SDRAM/ 的/ Bank/ 冲突/ 和/ 数据总线/ 竞争/ 问题/ ,/ 从而/ 提高/ 了/ SDRAM/ 系统/ 的/ 总体/ 性能/ ./ Yuan/ 等/ 人/ [/ 15/ ]/ 观察/ 到/ 在/ GP/ -/ GPU/ (/ GeneralPur/ -/ pose/ -/ GraphicProcessorUnit/ )/ 体系结构/ 中/ ,/ 每/ 一个/ 核/ 发出/ 的/ 请求/ 本身/ 具有/ 较/ 高/ 的/ SDRAM/ 行/ 访问/ 局部性/ ,/ 但是/ 经过/ 片上/ 网络/ 传输/ 之后/ 行/ 访问/ 局部性/ 遭到/ 了/ 破坏/ ./ 作者/ 通过/ 在/ NoC/ 设计/ 中/ 实现/ 的/ “/ HoldGrant/ ”/ 和/ “/ Row/ -/ MatchingHoldGrant/ ”/ 两种/ 仲裁/ 策略/ 保证/ 了/ 这种/ 行/ 访问/ 局部性/ ,/ 从而/ 采用/ 简单/ 的/ FCFS/ 调度/ 策略/ 就/ 可以/ 得到/ 与/ FR/ -/ FCFS/ 相近/ 的/ 效果/ ./ 关于/ CMPs/ 片上/ 存储系统/ 特别/ 是/ 片/ 上/ Cache/ 系统/ 的/ 访问/ 公平性/ 问题/ 的/ 研究/ 已经/ 相当/ 广泛/ ./ Fedorova/ 提出/ 了/ Cache/ 公平/ 的/ 线程/ 调度/ 算法/ [/ 16/ ]/ ,/ 可以/ 有效/ 地/ 解决/ 共享/ L2/ 中/ 的/ 线程/ 冲突/ 问题/ ./ Chang/ [/ 17/ ]/ 提出/ 了/ 协同/ Cache/ (/ CooperativeCache/ )/ 机制/ ,/ 通过/ 在/ 私有/ L2/ 基础/ 上/ 引入/ Cache/ 间/ 干净/ 数据/ 的/ 搬/ Page3/ 移/ ,/ 可以/ 在/ 不/ 增加/ 存储/ 延时/ 的/ 基础/ 上/ 隔离线/ 程/ 冲突/ ./ 此外/ ,/ Abts/ 等/ 人/ [/ 18/ ]/ 提出/ 了/ 在/ 大量/ 的/ PE/ 、/ 少量/ 的/ MC/ 的/ NoC/ 中/ 如何/ 放置/ MC/ 的/ 问题/ ,/ 给出/ 了/ 能够/ 使/ 最大/ 通道/ 负载/ (/ MaximumChannelLoad/ )/ 最小/ 的/ MC/ 放置/ 方法/ :/ 菱形/ 放置/ 法/ ./ 同时/ 在/ 提出/ 了/ CDR/ (/ Class/ -/ basedDeterministicRouting/ )/ 路由/ 算法/ ,/ 能够/ 对/ 处理器/ -/ 存储器/ 型/ 冲突/ (/ Processor/ -/ MemoryTraffic/ )/ 进行/ 负载平衡/ ./ 该/ 文献/ 和/ 本文/ 讨论/ 的/ 出发点/ 不同/ ,/ 但/ 其/ 研究/ 内容/ 却/ 很/ 有/ 参考价值/ ./ 据/ 我们/ 所知/ ,/ 目前/ 还/ 没有/ 关于/ 片上/ 网络延时/ 的/ 差异/ 对外部/ 系统/ 的/ 访存/ 公平性/ 的/ 影响/ 这方面/ 的/ 研究成果/ 发表/ ,/ 因而/ 迫切需要/ 对/ 这/ 一/ 问题/ 在/ 理论/ 和/ 试验/ 方面/ 进行/ 分析/ 建模/ 并/ 提出/ 较/ 好/ 的/ 解决方案/ ./ 3/ 片上/ 网络延时/ 差异/ 的/ 现象/ 、/ 原因/ 及/ 参数/ 化/ 建模/ 在/ 基于/ NoC/ 结构/ 的/ CMPs/ 中/ ,/ 外部/ 存储器/ 的/ 请求/ 起/ 始于/ 最后/ 一级/ Cache/ (/ LastLevelCache/ ,/ LLC/ )/ 的/ 缺失/ 请求/ ./ 如果/ 是/ 读/ 请求/ ,/ 则/ 在/ 缺失/ 状态/ 处理/ 寄存器/ 组/ (/ MissStatusHandlingRegister/ ,/ MSHR/ )/ 记录/ 之后/ ,/ 通过/ NoC/ 传输/ 至/ 目标/ MC/ ,/ 在/ MC/ 经过/ 仲裁/ 选择/ 并/ 向/ SDRAM/ 发送/ 访存/ 命令/ ,/ 从/ SDRAM/ 返回/ 的/ 数据/ 再次/ 进入/ NoC/ 中/ 并/ 最终/ 返回/ 给/ LLC/ ,/ 同时/ 完成/ MSHR/ 的/ 状态/ 更新/ ./ 写/ 请求/ 的/ 处理/ 与/ 上述/ 过程/ 类似/ ,/ 只不过/ 前者/ 从/ SDRAM/ 向/ LLC/ 返回/ 的/ 是/ 请求/ 的/ 数据/ ,/ 后者/ 返回/ 的/ 是/ 写/ 确认/ 信息/ ./ 因而/ 我们/ 能够/ 得到/ 式/ (/ 1/ )/ ,/ 任何/ 一个/ 访问/ 外部/ 存储器/ 的/ 请求/ 延时/ 可以/ 分为/ 三/ 部分/ :/ 访存/ 请求/ 发/ 向/ 目标/ SDRAM/ 在/ NoC/ 中/ 的/ 延时/ Treq/ 、/ 访存/ 请求/ 在/ 目标/ SDRAM/ 中/ 的/ 处理/ 延时/ Tmem/ 和/ 从/ 目标/ SDRAM/ 得到/ 的/ 数据/ 或/ 写/ 确认/ 信息/ 返回/ 给/ 请求/ 源/ 结点/ 在/ NoC/ 中/ 的/ 延时/ Treturn/ ./ 在/ 这里/ 我们/ 忽略/ 了/ 访存/ 请求/ 从/ 网络/ 报文/ 解析/ 为/ 请求/ 信号/ 和/ 返回/ 数/ 打包/ 为/ 网络/ 报文/ 所/ 花费/ 的/ 时间/ ,/ 这样/ 能够/ 简化/ 下述/ 分析/ 过程/ ,/ 并且/ 对/ 问题/ 实质/ 影响/ 不大/ ./ 式/ (/ 1/ )/ 中/ 的/ Treq/ 和/ Treturn/ 均/ 可/ 视为/ NoC/ 中/ 的/ 报文/ 延时/ ,/ 在/ 采用/ 虫/ 孔/ 路由/ 的/ NoC/ 中/ ,/ 报文/ 的/ 无/ 冲突/ 延时/ 包含/ 两/ 部分/ :/ 报文/ 头/ 传输/ 延时/ 和/ 后续/ 微片/ (/ flit/ )/ 连续/ 传输/ 延时/ ./ 如式/ (/ 2/ )/ 所示/ [/ 19/ ]/ ,/ Γ/ 1p/ 是/ 一个/ 报文/ 在/ NoC/ 中/ 传输/ 所/ 花费/ 的/ 时间/ ;/ hi/ ,/ j/ 是/ 结点/ i/ 到/ 结点/ j/ 之间/ 的/ 跳步/ 数/ ;/ tc/ 为/ 无/ 拥塞/ 时/ 一个/ 微片/ 通过/ 一个/ 开关/ 和/ 一条/ 链路/ 所/ 需要/ 的/ 时间/ ;/ L/ 为/ 报文/ 的/ 长度/ ;/ b/ 为/ 链路/ 带宽/ ./ 在/ 考虑/ 网络/ 冲突/ 的/ NoC/ 中/ ,/ 引入/ tw/ 这一/ 参数/ ,/ tw/ 表示/ 存在/ 拥塞/ 时报/ 文头/ 在/ 开/ 关节点/ 处/ 平均/ 等待时间/ ,/ 式/ (/ 2/ )/ 将/ 变为/ 式/ (/ 3/ )/ :/ 而式/ (/ 1/ )/ 中/ 的/ Tmem/ 由/ 文献/ [/ 20/ ]/ 可知/ ,/ 主要/ 由/ 存储器/ 带宽/ 受限/ 导致/ 的/ 停顿/ Tm/ _/ bw/ 和/ 存储器/ 本身/ 的/ 延时/ Tm/ _/ latency/ 两/ 方面/ 的/ 因素/ 构成/ ,/ 如式/ (/ 4/ )/ 所示/ ./ 将式/ (/ 4/ )/ 和/ 式/ (/ 3/ )/ 代入/ 到式/ (/ 1/ )/ 中/ ,/ 得到/ 在/ 基于/ NoC/ 结构/ 的/ CMPs/ 中/ ,/ 外部/ 存储器/ 的/ 访问/ 延时/ ,/ 如式/ (/ 5/ )/ 所示/ ./ 在/ 确定/ 的/ NoC/ 参数/ 及/ 报文/ 协议/ 下/ ,/ 式/ (/ 5/ )/ 中/ 的/ 参数/ tc/ 、/ Lreq/ 、/ Lreturn/ 和/ b/ 为/ 固定/ 常数/ ,/ 并且/ 由/ SDRAM/ 的/ 特性/ 可知/ [/ 21/ ]/ ,/ Tm/ _/ latency/ 的/ 变化/ 范围/ 相对/ 较/ 小/ (/ 如/ 在/ 采用/ 开页/ 策略/ 的/ SDRAM/ 中行/ 命中/ 与行/ 冲突/ 的/ 延时/ 一般/ 相差/ 十几/ 拍/ 左右/ )/ ./ 因此/ 不同/ 访存/ 请求/ 的/ 访存/ 延时/ 的/ 差异/ 主要/ 体现/ 在/ hi/ ,/ j/ 、/ tw/ 和/ Tm/ _/ bw/ 这/ 3/ 个/ 参数/ ,/ 其中/ hi/ ,/ j/ 主要/ 由/ 请求/ 结点/ 与/ MC/ 的/ 相对/ 位置/ 、/ 网络/ 规模/ 、/ MC/ 在/ NoC/ 中/ 的/ 位置/ 等/ 因数/ 决定/ ,/ tw/ 主要/ 由/ 应用程序/ 的/ 通信/ 、/ 访存/ 特性/ (/ 如/ 通信/ 流量/ 模型/ 、/ 报文/ 注入/ 率/ 、/ 访存/ 报文/ 所/ 占/ 比重/ 等/ )/ 决定/ ,/ Tm/ _/ bw/ 主要/ 由/ 存储器/ 带宽/ 、/ 存储器/ 调度/ 策略/ 等/ 决定/ ./ 显然/ 在/ 基于/ NoC/ 结构/ 的/ CMPs/ 中/ ,/ 外部/ 存储器/ 的/ 访问/ 延时/ 由/ 多种/ 因素/ 共同/ 决定/ ,/ 具有/ 动态/ 特征/ ,/ 因而/ 不/ 能够/ 精确/ 预测/ ./ 本文/ 第/ 4/ 节/ 构建/ 模拟/ 平台/ ,/ 对/ 上述/ 构成/ Ttotal/ 差异/ 的/ 原因/ 进行/ 综合/ 分析/ ./ 由式/ (/ 3/ )/ 可知/ ,/ 片上/ 网络延时/ 由/ hi/ ,/ j/ 和/ tw/ 决定/ ,/ 前者/ 具有/ 确定性/ ,/ 后者/ 具有/ 随机性/ ./ 我们/ 考虑/ 图/ 1/ 所示/ 的/ 情况/ :/ 在/ 8/ ×/ 8/ 的/ 2/ 维/ mesh/ 结构/ 下/ ,/ 采用/ X/ -/ Y/ 维序/ 路由/ ,/ MC/ 放置/ 在/ 芯片/ 的/ 上下/ 两端/ ,/ 结点/ a/ 和/ 结点/ b/ 分别/ 访问/ 同一/ 外存/ 空间/ (/ MC1/ 控制/ 的/ 一段/ 外存/ 空间/ )/ ,/ 由于/ 结点/ a/ 和/ MC1/ 的/ 距离/ 比/ 结点/ b/ 和/ MC1/ 的/ 距离/ 大/ (/ hi/ ,/ j/ _/ a/ =/ 15/ ,/ hi/ ,/ j/ _/ b/ =/ 1/ )/ ,/ 则/ 结点/ a/ 的/ 访存/ 请求/ 在/ NoC/ 中/ 的/ 延时/ 要/ 远远/ 大于/ 结点/ b/ 的/ 访存/ 请求/ 在/ NoC/ 中/ 的/ 延时/ ./ 即/ 对应/ 式/ (/ 1/ )/ 中/ Treq/ _/ a/ / Treq/ _/ b/ 且/ Treturn/ _/ a/ / Treturn/ _/ b/ ,/ 现有/ 的/ 存储器/ 调度/ 策略/ 一般/ 采用/ FCFS/ 或/ 修改/ 的/ FR/ -/ FCFS/ 调度/ 方法/ ,/ 这些/ 方法/ 保证/ 了/ 不同/ 线程/ 的/ Tm/ _/ bw/ 相差/ 不/ 大/ ,/ 即/ Tmem/ _/ a/ ≈/ Tmem/ _/ b/ ./ 由/ Page4/ 式/ (/ 1/ )/ 易知/ Ttotal/ _/ a/ / Ttotal/ _/ b/ ,/ 即/ 不同/ 的/ 结点/ 对/ 同一/ 外存/ 空间/ 的/ 访问/ 延时/ 差异/ 较大/ (/ 这种/ 差异/ 根据/ 第/ 4/ 节/ 的/ 模拟/ 在/ 256/ 结点/ 下可达/ 400/ 拍/ 以上/ )/ ./ 同样/ 的/ 道理/ 我们/ 可以/ 推出/ 同一/ 节点/ 对/ 不同/ 外部/ 存储空间/ 的/ 访问/ 延时/ 也/ 具有/ 很大/ 的/ 差异/ ./ 由式/ (/ 5/ )/ 可以/ 看出/ 在/ NoC/ 规模/ 、/ MC/ 数目/ 及/ 位置/ 固定/ 的/ 情况/ 下/ ,/ 不同/ 结点/ 访存/ 的/ hi/ ,/ j/ 必然/ 存在/ 较大/ 差异/ ,/ 可/ 供/ 我们/ 调节/ 的/ 主要参数/ 是/ Tm/ _/ bw/ ,/ 我们/ 可以/ 采用/ 一定/ 的/ 策略/ 使/ 距离/ MC/ 较远/ 的/ 结点/ 在/ 竞争/ 访存/ 通道/ 时/ 具有/ 较/ 高/ 的/ 优先级/ ,/ 即当/ 某个/ 请求/ 的/ hi/ ,/ j/ 值/ 较大/ 时/ ,/ 使/ 其/ Tm/ _/ bw/ 值较/ 小/ ,/ 从而/ 避免/ 或/ 减弱/ NoC/ 的/ 延时/ 差异/ 对/ 访存/ 公平性/ 的/ 影响/ ,/ 这/ 也/ 是/ 本文/ 第/ 5/ 节/ 提出/ 的/ SBNL/ 调度/ 方法/ 的/ 由/ 来/ ./ 图/ 1/ 不同/ 结点/ 对/ 同一/ 外存/ 空间/ 访问/ 的/ NoC/ 差异性/ 示意图/ 4/ 片上/ 网络延时/ 差异/ 对/ 存储系统/ 的/ 公平性/ 的/ 影响/ 因素/ 分析/ 4.1/ 模拟/ 平台/ 的/ 搭建/ 本文/ 构建/ 了/ 一个/ 节拍/ 精确/ 的/ NoC/ +/ MC/ 模拟/ 平台/ ,/ 并/ 采用/ 合成/ 的/ 流量/ 模型/ 对/ 影响/ 存储系统/ 公平性/ 的/ 各种因素/ 进行/ 分析/ ./ 该/ 模拟/ 平台/ 主要/ 由/ 一个/ NoC/ 模拟器/ 和/ 多个/ SDRAM/ 的/ MC/ 模型/ 组合而成/ ./ 能够/ 全面/ 模拟/ 不同/ PE/ 对/ 不同/ 存储空间/ 的/ 访存/ 请求/ 在/ NoC/ 上/ 同时/ 存在/ ,/ 并/ 经过/ 仲裁/ 进而/ 访问/ MC/ ,/ 然后/ 返回/ 数据/ 的/ 过程/ ./ NoC/ 的/ 主要参数/ 如表/ 1/ 所示/ ./ 在/ 模拟/ 时/ 我们/ 采用/ 了/ 开环/ 模拟/ 的/ 方法/ ,/ 通过/ Bernoulli/ 过程/ 向/ 每个/ 结点/ 注入/ 报文/ [/ 19/ ]/ ,/ 在/ 模拟器/ 经过/ 预热/ 之后/ 统计/ 每个/ 访存/ 请求/ 花费/ 的/ 节拍/ 数/ ,/ 然后/ 再进一步/ 处理/ ./ 路由器/ 之间/ 的/ 线/ 延时/ 参数/ 名称/ 拓扑/ 结构/ PE/ 的/ 数目/ MC/ 的/ 数目/ 路由/ 延时/ 交换/ 策略/ 通道/ 缓冲/ 数目/ 虚/ 通道/ 数目/ 路由/ 算法/ 报文/ 大小/ NoC/ +/ MC/ 模拟/ 平台/ 中/ 的/ MC/ 的/ 主要参数/ 如表/ 2/ 所示/ ,/ 每个/ MC/ 固定/ 连接/ 4/ 个/ PE/ ,/ 拥有/ 一个/ 存储器/ 通道/ ,/ 控制/ 8/ 个/ SDRAMBanks/ 和/ 256MB/ 的/ 空间/ ./ SDRAM/ 的/ 时序/ 参数/ 模型/ 如表/ 3/ 所示/ ,/ 该/ 模型/ 从/ Micron/ 公司/ 的/ SDRAM/ 参数/ 手册/ 抽象/ 而/ 来/ ,/ 能够/ 精确/ 地/ 模拟/ 存储器/ 主要/ 的/ 时序/ 约束/ ,/ 如/ 存储器/ 命令/ 的/ 延时/ 、/ 不同/ 存储器/ 命令/ 之间/ 的/ 最小/ 间隔/ 、/ 刷新周期/ 等/ ./ 参数/ 名称/ 参数值/ 参数/ 名称/ 参数值/ tRCDtCAStBLtRAS18cyclestRFC51cyclestRP4/ ./ 2/ 评价/ 函数/ 对/ CMPs/ 片外/ 存储系统/ 的/ 公平性/ 进行/ 评测/ 并/ 不是/ 一件/ 容易/ 的/ 事情/ ,/ 已有/ 的/ 研究/ 工作/ 从/ 不同/ 的/ 角度/ 定义/ 了/ 存储系统/ 的/ QoS/ 目标/ [/ 10/ -/ 11/ ]/ ,/ 这些/ QoS/ 目标/ 也/ 可以/ 当成/ CMPs/ 片外/ 存储系统/ 的/ 公平性/ 的/ 评价/ 函数/ ./ 然而/ 已/ 存在/ 的/ QoS/ 目标/ 都/ 是从/ 系统/ 的/ 角度/ 出发/ ,/ 其/ 本身/ 受/ 许多/ 其它/ 因素/ 的/ 影响/ (/ 如/ Cache/ 抖动/ 等/ )/ ,/ 并且/ 不利于/ 数学/ 建模/ ./ 因此/ 本文/ 直接/ 从式/ (/ 1/ )/ 定义/ 的/ Ttotal/ 出发/ ,/ 通过/ 对/ Ttotal/ 的/ 不同/ 组成部分/ 进行/ 数学/ 统计/ ,/ 进而/ 对/ CMPs/ 片外/ 存储系统/ 的/ 公平性/ 进行/ 评测/ ./ 将/ 一段时间/ 内访存/ 请求/ 的/ 总/ 延时/ 、/ 访存/ 请求/ 在/ MC/ 和/ 存储器/ 中/ 的/ 延时/ 和/ 访存/ 请求/ 在/ NoC/ 中/ 的/ 延时/ 分别/ 定义/ 为/ 集合/ A/ 、/ B/ 和/ C/ ,/ 且/ 假设/ 一共/ 记录/ 了/ NPage5/ 个/ 访存/ 请求/ ,/ 即/ A/ =/ {/ Ttotal/ _/ i/ |/ i/ =/ 1/ ,/ 2/ ,/ …/ ,/ N/ }/ ,/ B/ =/ {/ Tmem/ _/ i/ |/ i/ =/ 1/ ,/ 2/ ,/ …/ ,/ N/ }/ ,/ C/ =/ {/ TNoC/ _/ i/ |/ i/ =/ 1/ ,/ 2/ ,/ …/ ,/ N/ }/ ./ 本文/ 采用/ 式/ (/ 6/ )/ ~/ (/ 8/ )/ 3/ 个/ 函数/ 即/ 平均/ 访存/ 延时/ Taverage/ 、/ 延时/ 均/ 方差/ LSD/ (/ LatencyStandardDevia/ -/ tion/ )/ 和/ NoC/ 延时/ 非/ 均匀/ 性/ 比例/ UFRNoC/ 来/ 进行/ 分析/ ./ 其中/ Taverage/ 表示/ 所有/ 访存/ 请求/ 的/ 平均/ 延时/ ;/ LSD/ 衡量/ 了/ 集合/ A/ 中/ 的/ 所有/ 访存/ 延时/ 与/ 平均/ 延时/ 的/ 偏离/ 程度/ ,/ 即/ 访存/ 请求/ 的/ 公平性/ ;/ UFRNoC/ 表示/ 了/ NoC/ 延时/ 的/ 差异/ 占/ 访存/ 请求/ 非/ 公平性/ 的/ 比例/ ,/ UFRNoC/ 的/ 范围/ 在/ 0/ 与/ 1/ 之间/ ,/ 其值/ 越/ 接近/ 于/ 1/ 说明/ NoC/ 延时/ 的/ 差异/ 对外部/ 存储器/ 的/ 公平性/ 影响/ 越/ 严重/ ./ UFRNoC/ =/ StandardDeviation/ (/ C/ )/ +/ StandardDeviation/ (/ B/ )/ 4.3/ 影响/ 访存/ 请求/ 公平性/ 的/ 因素/ 分析/ 本/ 节/ 分析/ 了/ 网络/ 规模/ 、/ MC/ 的/ 位置/ 、/ 报文/ 注入/ 率/ 、/ 报文/ 比例/ 这/ 4/ 种/ 因素/ 对外部/ 存储系统/ 公平性/ 的/ 影响/ ./ 由于/ 前/ 三者/ 概念/ 明确/ ,/ 这里/ 主要/ 讨论/ 报文/ 比例/ 这一/ 因素/ 的/ 由/ 来/ ./ 将/ 应用程序/ 中/ 不同/ 线程/ 之间/ 的/ 片图/ 2/ 不同/ 网络/ 规模/ 下/ 的/ 访存/ 公平性/ 分析/ 如图/ 2/ (/ a/ )/ 所示/ ,/ 在/ 相同/ 的/ 报文/ 注入/ 率下/ ,/ 网络/ 规模/ 越大/ ,/ 每个/ 访存/ 请求/ 的/ 访存/ 延时/ 也/ 越/ 大/ ./ 在/ 相同/ 规模/ 的/ 网络/ 中/ ,/ 每个/ 访存/ 请求/ 的/ 延时/ 随着/ 报文/ 注入/ 率/ 的/ 变高/ 而/ 变大/ ./ 如图/ 2/ (/ b/ )/ 所示/ ,/ 在/ 相同/ 的/ 报文/ 注入/ 率下/ ,/ 访存/ 请求/ 的/ 均/ 方差/ 随着/ 网络/ 规模/ 的/ 增加/ 而/ 变大/ ,/ 即/ 访存/ 请求/ 延时/ 随着/ 网络/ 规模/ 的/ 扩大/ 而/ 变得/ 越来越/ 分散/ ./ 同时/ ,/ 在/ 注入/ 率/ 比较/ 低时/ ,/ 访存/ 请求/ 的/ 均/ 方差/ 和/ 变化/ 范围/ 都/ 较/ 小/ ,/ 而/ 在/ 中等/ 注入/ 率/ 和/ 高/ 注入/ 率下/ ,/ 访存/ 请求/ 的/ 均/ 方差/ 比较/ 大/ ./ 如图/ 2/ (/ c/ )/ 所示/ ,/ 上报/ 文/ (/ 包片/ 上/ 远程/ 共享/ Cache/ 的/ 访问/ 、/ Cache/ 协议/ 的/ 维护/ 等/ )/ 定义/ 为/ 普通/ 报文/ ,/ 将/ 访问/ 外部/ 存储器/ 的/ 报文/ (/ 包括/ 外存/ 数据/ 请求/ 和/ 数据/ 返回/ 等/ )/ 定义/ 为/ 访存/ 报文/ ,/ 普通/ 报文/ 与/ 访存/ 报文/ 的/ 比值/ 称为/ 报文/ 比例/ ./ 报文/ 比例/ 的/ 范围/ ,/ 在/ 目前/ 的/ 文献/ 中尚/ 没有/ 明确/ 的/ 结论/ ./ 我们/ 可以/ 进行/ 如下/ 定性分析/ ,/ 决定/ 普通/ 报文/ 与/ 访存/ 报文/ 的/ 比例/ 的/ 最/ 重要/ 因素/ 是/ 片/ 上/ LLC/ (/ 假设/ 为/ 二级/ Cache/ ,/ 且/ 不/ 考虑/ 片上/ 存储器/ 为/ 便签/ 式/ 存储器/ 的/ 情况/ )/ 的/ 共享/ 情况/ ./ 如果/ L2/ 完全/ 私有/ ,/ 则/ NoC/ 中/ 的/ 报文/ 将/ 全部/ 是/ 访问/ 外部/ 存储器/ 的/ 报文/ ;/ 如果/ L2/ 是/ 分布式/ 共享/ 的/ ,/ 那么/ 普通/ 报文/ 与/ 访存/ 报文/ 的/ 比例/ 取决于/ 远程/ L2/ 和/ 片/ 外存储器/ 的/ 访问/ 比率/ (/ 和/ 应用程序/ 本身/ 的/ 特征/ 相关/ )/ 以及/ 所/ 采用/ 的/ Cache/ 一致性/ 方案/ ./ 根据/ 文献/ [/ 17/ ]/ ,/ 在/ 分布式/ 共享/ L2/ 中/ ,/ 远程/ L2/ 和/ 片/ 外存储器/ 的/ 访问/ 比例/ 主要/ 在/ 11/ 到/ 431/ 范围/ 之间/ ./ 因而/ 下文/ 论述/ 中/ 我们/ 分析/ 报文/ 比例/ 从/ 全部/ 是/ 访存/ 报文/ 到/ 501/ 这一/ 范围/ 对/ 访存/ 请求/ 公平性/ 的/ 影响/ ,/ 并且/ 以/ 301/ 作为/ 一个/ 经验值/ 进行/ 讨论/ ./ 我们/ 分别/ 模拟/ 了/ 2/ ×/ 2/ 、/ 4/ ×/ 4/ 、/ 8/ ×/ 8/ 和/ 16/ ×/ 16/ 的/ 2DMesh/ 结构/ 在/ 不同/ 注入/ 率下/ ,/ 结点/ 直接/ 发送/ 报文/ 的/ 情况/ (/ 普通/ 报文/ 与/ 访存/ 报文/ 的/ 比例/ 为/ 301/ ,/ MC/ 采用/ FCFS/ 方法/ 调度/ )/ ./ 在/ 模拟/ 平台/ 预热/ (/ 经过/ 10/ 万次/ 报文/ 传输/ )/ 后/ 每个/ 结点/ 向/ 不同/ 的/ MC/ 发送/ 1/ 万次/ 报文/ ,/ 记录/ 所有/ 的/ 访存/ 请求/ 的/ 延时/ 并/ 进行/ 处理/ ,/ 得到/ 图/ 2/ 所示/ 结果/ ./ 尽管/ NoC/ 延时/ 差异/ 在/ 访存/ 请求/ 非/ 公平性/ 中/ 的/ 比例/ 存在/ 波动/ (/ 在/ 中等/ 注入/ 率时/ 存在/ 下降/ )/ ,/ 但/ 还是/ 占据/ 一定/ 的/ 分量/ ,/ 特别/ 是/ 64/ 、/ 256/ 结点/ 时/ 都/ 超过/ 了/ 50/ %/ ./ 因而/ 能够/ 得出/ ,/ 随着/ 网络/ 规模/ 的/ 扩大/ ,/ 网络/ 负载/ 的/ 增加/ ,/ NoC/ 延时/ 差异/ 已/ 逐渐/ 成为/ 影响/ 访存/ 公平性/ 的/ 一个/ 重要/ 因素/ ,/ 必须/ 予以考虑/ ./ 在/ 已经/ 商品化/ 的/ 基于/ NoC/ 的/ 众核/ CMPs/ 中/ [/ 5/ -/ 6/ ]/ ,/ MC/ 均/ 放置/ 在/ 芯片/ 的/ 上下/ 两端/ (/ 如图/ 1/ 所示/ )/ ./ 文献/ [/ 15/ ,/ 18/ ]/ 提出/ 了/ MC/ 的/ 菱形/ 放置/ 方法/ (/ 如/ Page6/ 图/ 3/ 所示/ 黑色/ 的/ PE/ 或/ router/ 拥有/ 外部/ 存储器/ 控制器/ )/ ,/ 本文/ 用/ NoC/ +/ MC/ 模拟/ 平台/ 对/ MC/ 上/ 下端/ 放置/ 和/ MC/ 菱形/ 放置/ 分别/ 进行/ 模拟/ (/ NoC/ 规模/ 为/ 8/ ×/ 8/ ,/ MC/ 采用/ FCFS/ 调度/ 策略/ ,/ 普通/ 报文/ 与/ 访存/ 报文/ 的/ 比例/ 为/ 301/ )/ ,/ 得到/ 图/ 4/ 所示/ 的/ 结果/ ./ 由图/ 4/ 可知/ MC/ 菱形/ 放置/ 法比上/ 下端/ 放置/ 法/ 拥有/ 更/ 高/ 的/ 报文/ 吞吐/ 率/ ,/ 这/ 与/ 文献/ [/ 20/ ]/ 分析/ 结果/ 一致/ ,/ 此外/ MC/ 菱形/ 放置/ 法/ 能够/ 在/ 一定/ 程度/ 上/ 减少/ 访存/ 请求/ 的/ 延时/ ,/ 提高/ 访存/ 请求/ 延时/ 的/ 公平性/ ,/ 因此/ 如果/ 忽略/ 这种/ 放置/ 方法/ 对/ NoC/ 均匀/ 性/ 和/ 可扩展性/ 带来/ 的/ 问题/ ,/ MC/ 菱形/ 放置/ 法是/ 一种/ 不错/ 的/ 选择/ ./ 图/ 4MC/ 上/ 下端/ 放置/ 与/ MC/ 菱形/ 放置/ 分析/ 结果/ 对比/ 报文/ 比例/ 和/ 应用程序/ 相关/ ,/ 是/ 影响/ 访存/ 请求/ 公平性/ 的/ 一个/ 重要/ 因素/ ./ 在/ 64/ 结点/ 的/ NoC/ 平台/ 下/ (/ MC/ 上/ 下端/ 放置/ ,/ FCFS/ 调度/ )/ ,/ 分别/ 在/ 重/ 负载/ (/ 注入/ 率/ 0.26/ )/ 、/ 中等/ 负载/ (/ 注入/ 率/ 0.18/ )/ 、/ 轻/ 负载/ (/ 注入/ 率/ 0.06/ )/ 采用/ 不同/ 的/ 报文/ 比例/ 进行/ 模拟/ ,/ 得出/ 如图/ 5/ 所示/ 结果/ ./ 可知/ ,/ 报文/ 负载/ 越重/ ,/ 访存/ 请求/ 的/ Taverage/ 、/ 图/ 5/ 不同/ 报文/ 比例/ 下/ 的/ 访存/ 公平性/ 分析/ 5SBNL/ 访存/ 调度/ 方法/ 通过/ 第/ 3/ 节/ 的/ 定性分析/ 和/ 第/ 4/ 节/ 的/ 定量/ 模拟/ ,/ 我们/ 发现/ 在/ MC/ 采用/ 上/ 下端/ 放置/ 的/ 芯片/ 布局/ 方法/ 中/ ,/ NoC/ 延时/ 差异/ 这一/ 因素/ 对外/ 存/ 访问/ 公平性/ 影响/ 较大/ ,/ 并且/ 随着/ 网络/ 规模/ 、/ 报文/ 注入/ 率/ 的/ 提高/ 而/ 变得/ LSD/ 和/ UNRNoC/ 均/ 越/ 大/ ./ 在/ 相同/ 的/ 报文/ 负载/ 下/ ,/ 报文/ 比例/ 越小/ (/ 即/ 访存/ 报文/ 越/ 多/ )/ ,/ 访存/ 请求/ 的/ 平均/ 延时/ 越大/ ,/ 在/ 报文/ 比例/ 大于/ 某一/ 区间/ 之后/ ,/ 访存/ 请求/ 平均/ 延时/ 变小/ ,/ 访存/ 请求/ 的/ 均/ 方差/ 也/ 变小/ ./ NoC/ 延时/ 差异/ 在/ 访存/ 请求/ 非/ 公平性/ 中/ 的/ 比例/ 随着/ 报文/ 比例/ 的/ 变化/ 存在/ 最小值/ ,/ 这个/ 最小值/ 与/ 网络/ 负载/ 相关/ ./ 日趋严重/ ,/ 因而/ 迫切需要/ 研究/ 人员/ 提出/ 较/ 好/ 的/ 解决方案/ ./ 本节/ 我们/ 提出/ SBNL/ 访存/ 调度/ 方法/ ,/ 这种/ 调度/ 方法/ 从/ 不同/ 的/ 线程/ 访问/ 外部/ 存储器/ 的/ 优先级/ 入手/ ,/ 通过/ 在/ 每个/ MC/ 中/ 增加/ NoC/ 延时/ 预估/ 表/ ,/ 赋予/ 距离/ MC/ 较远/ 的/ 请求/ 较/ 高/ 的/ 访存/ 优先级/ ,/ 同时/ 兼顾/ 访存/ 效率/ ,/ 能够/ 对/ 访存/ 公平性/ 和/ 系统/ 性能/ 进行/ 有效/ 的/ 改/ Page7/ 善/ ,/ 并且/ 对/ 现有/ 的/ 软硬件/ 结构/ 改动/ 较/ 小/ ./ 5.1/ 主要/ 方法/ (/ 1/ )/ 当访存/ 请求/ 进入/ MC/ 时/ ,/ 由/ 请求/ 源/ 节点/ 坐标/ 查找/ 对应/ 的/ NoC/ 预估/ 延时/ ,/ 作为/ 初始/ 的/ 优先级/ ;/ 当/ 存储器/ 通道/ 处理/ 一个/ 访存/ 请求/ 时/ ,/ 通道/ 中/ 的/ 其它/ 请求/ 的/ 优先级/ 加/ t/ (/ 根据/ 通道/ 中/ 的/ 请求/ 是/ 行/ 命中/ 、/ 行/ 关闭/ 还是/ 行/ 冲突/ ,/ t/ 进行/ 相应/ 的/ 变化/ )/ ;/ (/ 2/ )/ 设/ Pmax/ 为/ 当前/ 通道/ 队列/ 中/ 的/ 请求/ 的/ 最高/ 优先级/ ,/ 将/ Pmax/ 与/ 参考/ 优先级/ Pref/ 进行/ 比较/ ,/ 若/ Pmax/ </ Pref/ 则/ 采用/ FR/ -/ FCFS/ 调度/ 方法/ ;/ 若/ Pmax/ / Pref/ 则/ 跳入/ (/ 3/ )/ ;/ (/ 3/ )/ 具有/ Pmax/ 优先级/ 的/ 请求/ 优先/ 处理/ ./ SBNL/ 调度/ 方法/ 是/ 一种/ 充分考虑/ NoC/ 延时/ 差异/ 的/ 存储器/ 调度/ 方法/ ,/ 通过/ 在/ MC/ 的/ 入口处/ 设立/ NoC/ 延时/ 预估/ 表/ ,/ 按照/ 访存/ 请求/ 的/ 源/ 节点/ 在/ NoC/ 延时/ 预估/ 表/ 获取/ 相应/ 的/ 延时/ 预估/ 值/ ./ 这样/ 在/ 存储器/ 调度/ 时若/ 发现/ 某个/ 线程/ 的/ 请求/ 到达/ MC/ 之前/ 已经/ 花费/ 了/ 过/ 多/ 的/ 时间/ ,/ 则/ 调高该/ 请求/ 的/ 优先级/ ./ NoC/ 延时/ 预估/ 表/ 和/ Pref/ 可/ 由/ 操作系统/ 或/ 程序员/ 根据/ 网络/ 规模/ 、/ 应用程序/ 的/ 特性/ 等/ 提前/ 配置/ ,/ 具有/ 较强/ 的/ 灵活性/ ./ 5.2/ 参数设置/ 依据/ 在/ 5.1/ 节/ 阐述/ 的/ SBNL/ 调度/ 方法/ 中/ ,/ 每个/ PE/ _/ i/ 在/ MC/ _/ j/ 中/ 的/ NoC/ 预估/ 值/ 由/ 平均/ 网络/ 跳步/ 数/ 、/ 网络/ 负载/ 权重/ 、/ 线程/ 公平/ 因子/ 三/ 方面/ 因素/ 决定/ ,/ 其中/ 平均/ 网络/ 跳步/ 数在/ 一定/ NoC/ 规模/ 和/ 确定性/ 路由/ 策略/ 下/ 是/ 固定/ 的/ ;/ 网络/ 负载/ 权重/ 和/ 应用程序/ 的/ 报文/ 负载/ 相关/ ,/ 操作系统/ 或/ 程序员/ 可以/ 根据/ 不同/ 的/ 应用/ 设置/ 不同/ 的/ 网络/ 负载/ 权重/ ;/ 在/ 之前/ 的/ 论述/ 中/ 我们/ 只/ 考虑/ 应用/ 中/ 不同/ 的/ 线程/ 具有/ 相同/ 的/ 访存/ 优先级/ 的/ 情况/ ,/ 这里/ 增加/ 了/ 线程/ 公平/ 因子/ 这一/ 因素/ ,/ 操作系统/ 或/ 程序员/ 可以/ 通过/ 改变/ 某个/ PE/ 的/ NoC/ 预估/ 值来/ 调整/ 其/ 对应/ 线程/ 的/ 访存/ 优先级/ ./ t/ 的/ 值/ 主要/ 受限于/ 两/ 方面/ 的/ 因素/ :/ (/ 1/ )/ 外部/ 存储器/ 的/ 本身/ 参数/ ./ 不同/ 的/ 存储/ 模型/ 具有/ 不同/ 的/ 行/ 命中/ 、/ 行/ 关闭/ 、/ 行/ 冲突/ 的/ 访问/ 节拍/ 数/ (/ 如/ 在/ 我们/ 选取/ 的/ DRAM/ 模型/ [/ 21/ ]/ 中/ 上述/ 节拍/ 分别/ 为/ 9/ 、/ 14/ 、/ 18/ )/ ;/ (/ 2/ )/ MC/ 与/ 外部/ 存储器/ 的/ 频率/ 比值/ ./ Pref/ 的/ 值/ 取决于/ 操作系统/ 或/ 程序员/ 对/ 线程/ 的/ 访存/ 请求/ 延时/ 超出/ 平均/ 访存/ 延时/ 的/ 容忍/ 程度/ ,/ Pref/ 越小/ 表示/ 应用程序/ 对外/ 存/ 系统/ 的/ 访问/ 公平性/ 要求/ 越/ 严格/ ,/ 当/ Pref/ 无限大/ 时/ ,/ SBNL/ 调度/ 方法/ 就/ 转换成/ 了/ 传统/ 的/ FR/ -/ FCFS/ 调度/ 方法/ ./ 5.3/ 实现/ 开销/ 由/ 上述/ 方法/ 可知/ ,/ SBNL/ 方法/ 主要/ 的/ 硬件/ 实现/ 开销/ 包括/ NoC/ 延时/ 预估/ 表/ 、/ 参考/ 优先级/ Pref/ 寄存器/ 、/ 加法器/ 、/ 比较/ 器/ 等/ ./ 假设/ 网络/ 规模/ 为/ N/ ×/ N/ ,/ NoC/ 延时/ 预估/ 表/ 的/ 每一项/ 有/ 16bit/ ,/ MC/ 为/ M/ 个/ ,/ 每个/ MC/ 中/ 包含/ 一个/ 同时/ 容纳/ 16/ 个/ 访存/ 请求/ 的/ 通道/ ,/ 则/ 主要/ 的/ 硬件/ 开销/ 包括/ 2M/ ×/ N2/ 个/ 字节/ 的/ 存储空间/ 、/ 16/ ×/ M/ 个/ 16/ 位/ 的/ 加法器/ 和/ 15/ ×/ M/ 个/ 16/ 位/ 的/ 比较/ 器/ ,/ 硬件/ 开销/ 不大/ ./ 5.4/ 性能/ 分析/ 我们/ 将/ 采用/ 以下/ 两种/ 方法/ 分析/ 所/ 提出/ 的/ SBNL/ 调度/ 方法/ 相比/ 于/ 传统/ 的/ FR/ -/ FCFS/ 方法/ 在/ 公平性/ 和/ 效率/ 方面/ 的/ 提升/ ./ 我们/ 选取/ Δ/ LSD/ %/ =/ LSDFR/ -/ FCFS/ -/ LSDSBNLLSDFR/ -/ FCFSSBNL/ 调度/ 方法/ 相比/ 传统/ 的/ 方法/ 在/ 提高/ 系统/ 访问/ 外存/ 公平性/ 的/ 评价/ 参数/ ./ 分别/ 在/ NoC/ +/ MC/ 模拟/ 平台/ 为/ 2/ ×/ 2/ 、/ 4/ ×/ 4/ 、/ 8/ ×/ 8/ 、/ 16/ ×/ 16/ 网络/ 规模/ 下/ ,/ MC/ 上/ 下端/ 放置/ 、/ 中等/ 报文/ 注入/ 率/ (/ 在/ NoC/ 为/ 2/ ×/ 2/ 、/ 4/ ×/ 4/ 、/ 8/ ×/ 8/ 、/ 16/ ×/ 16/ 规模/ 下/ ,/ 其值/ 分别/ 为/ 采用/ 0.35/ 、/ 0.25/ 、/ 0.18/ 和/ 0.06/ )/ 和/ 报文/ 比例/ 为/ 301/ 的/ 情况/ 下/ ,/ 使/ 每个/ 结点/ 向/ 其它/ 结点/ 均匀/ 发送/ 报文/ ./ 其中/ SBNL/ 调度/ 方法/ 中/ 的/ NoC/ 延时/ 预估/ 表/ 设置/ 为/ 8/ ×/ hi/ ,/ j/ ,/ 假定/ MC/ 与/ 外部/ 存储器/ 的/ 频率/ 为/ 41/ (/ 即/ 根据/ 行/ 命中/ 、/ 行/ 关闭/ 还是/ 行/ 冲突/ ,/ t/ 分别/ 设置/ 为/ 36/ 、/ 56/ 和/ 72/ )/ ,/ 假定/ 操作系统/ 或/ 程序员/ 对/ 线程/ 的/ 访存/ 请求/ 延时/ 超出/ 平均/ 访存/ 延时/ 的/ 容忍/ 程度/ 为/ 访存/ 平均/ 延时/ 的/ 6/ 倍/ (/ 则/ 由/ 图/ 2/ (/ a/ )/ 得/ :/ 在/ 2/ ×/ 2/ 、/ 4/ ×/ 4/ 、/ 8/ ×/ 8/ 、/ 16/ ×/ 16/ 规模/ 下/ ,/ Pref/ 的/ 值/ 分别/ 为/ 720/ 、/ 1000/ 、/ 2100/ 和/ 2520/ )/ ./ 我们/ 统计/ 了/ 不同/ 的/ 网络/ 规模/ 下/ 的/ LSDFR/ -/ FCFS/ 、/ LSDSBNL/ 及/ Δ/ LSD/ %/ 的/ 值/ 如表/ 4/ 所示/ ./ 由表/ 4/ 可知/ ,/ SBNL/ 调度/ 方法/ 相比/ 传统/ 的/ 方法/ ,/ 在/ 不同/ 的/ 网络/ 规模/ 下均/ 能/ 显著/ 地/ 降低/ 访问/ 外存/ 请求/ 的/ 延时/ 均/ 方差/ ,/ 提高/ 了/ 访问/ 外存/ 请求/ 的/ 公平性/ ,/ 同时/ 随着/ 网络/ 规模/ 的/ 扩大/ ,/ SBNL/ 调度/ 方法/ 对/ 访存/ 公平性/ 的/ 提升/ 效果/ 愈/ 明显/ ./ 网络/ 规模/ LSDFR/ -/ FCFSLSDSBNL/ Δ/ LSD/ // %/ 2/ ×/ 24/ ×/ 48/ ×/ 816/ ×/ 1686.7/ 同时/ 我们/ 给出/ 在/ 网络/ 规模/ 为/ 8/ ×/ 8/ 下/ ,/ 不同/ 的/ 报文/ 注入/ 率/ 和/ 报文/ 比例/ 下/ Δ/ LSD/ %/ 的/ 详细/ 值/ (/ SBNL/ 调度/ 方法/ 的/ 延时/ 预估/ 表值/ 随/ 报文/ 注入/ 率/ 增加/ 而/ 加大/ ,/ 其余/ 参数/ 不变/ )/ ,/ 如表/ 5/ 所示/ ./ 从表/ 5/ 中/ 可以/ 得出/ Page8/ 如下/ 结论/ :/ 在/ 网络/ 规模/ 为/ 8/ ×/ 8/ 时/ ,/ SBNL/ 调度/ 方法/ 均/ 能够/ 有效/ 地/ 降低/ 访存/ 请求/ 的/ 均/ 方差/ (/ 平均/ 在/ 20/ %/ 左右/ ,/ 最大/ 达到/ 36.5/ %/ )/ ,/ 提高/ 系统/ 访存/ 的/ 公平性/ ./ 随着/ 报文/ 注入/ 率/ 的/ 增加/ ,/ SBNL/ 方法/ 对/ 访存/ 公平性/ 的/ 提升/ 愈/ 明显/ ,/ 这/ 是因为/ 报文/ 注入/ 率/ 的/ 增加/ 将会/ 引起/ 更/ 多/ 的/ 网络/ 拥塞/ ,/ 使/ NoC/ 延时/ 的/ 不/ 均匀/ 性/ 更加/ 显著/ ,/ SBNL/ 方法/ 能够/ 发挥/ 较大/ 的/ 作用/ ./ 当/ 报文/ 中/ 包含/ 的/ 访存/ 报文/ 较/ 少时/ ,/ SBNL/ 方法/ 对/ 访存/ 公平性/ 的/ 提升/ 较/ 小/ ,/ 这/ 是因为/ 同一/ 时刻/ MC/ 通道/ 中/ 包含/ 的/ 访存/ 请求/ 个数/ 有限/ ,/ SBNL/ 方法/ 发挥/ 的/ 余地/ 有限/ ./ 表/ 564/ 结点/ 下/ SBNL/ 与/ FR/ -/ FCFS/ 方法/ 的/ Δ/ 犔/ 犛犇/ %/ 值/ 报文/ 比例/ 全部/ 36.529/ ./ 814.128/ ./ 85136.228/ ./ 320.319/ ./ 710125.822/ ./ 118.615/ ./ 015122.523/ ./ 513.411/ ./ 520124.320/ ./ 012.711/ ./ 325115.214/ ./ 111.910/ ./ 230110.18/ ./ 86.53/ ./ 43519.78/ ./ 56.55/ ./ 74017.36/ ./ 26.34/ ./ 9/ 此外/ ,/ 为了/ 评估/ SBNL/ 方法/ 对系统/ 全局性/ 能/ 的/ 提升/ ,/ 本文/ 在/ 网络/ 规模/ 为/ 8/ ×/ 8/ 的/ NoC/ +/ MC/ 平台/ 上/ 进行/ 固定/ 负载/ 情况/ 下/ 线程/ 运行/ 情况/ 的/ 试验/ ./ 在/ 平台/ 预热/ 之后/ ,/ 为/ 每个/ PE/ 安排/ 了/ 5000/ 个/ 访存/ 请求/ (/ 同一个/ PE/ 的/ 访存/ 请求/ 拥有/ 不同/ 的/ 行/ 局部性/ ,/ 在/ 数据/ 返回/ 之前/ ,/ 每个/ PE/ 允许/ 最/ 多/ 发送/ 4/ 个/ 访存/ 请求/ )/ ,/ 在/ 系统/ 运行/ 时/ ,/ 若/ 某个/ PE/ 共/ 接受/ 的/ 访存/ 数据/ 的/ 数目/ 达到/ 5000/ ,/ 则/ 认为/ 该/ PE/ 的/ 工作/ 完成/ ,/ 不再/ 发送/ 新/ 的/ 请求/ ./ 在/ 报文/ 比例/ 为/ 301/ ,/ 中等/ 负载/ 情况/ 下/ ,/ 分别/ 运行/ SBNL/ 调度/ 方法/ 和/ FR/ -/ FCFS/ 方法/ ,/ 统计/ 了/ 在/ 不同/ 的/ 时间段/ (/ 以/ 500/ 个/ 时钟/ 周期/ 为/ 采样/ 单位/ )/ 运行/ 结束/ 的/ PE/ 的/ 数目/ ./ 如图/ 6/ 所示/ ,/ 采用/ SBNL/ 调度/ 方法/ 时/ ,/ 在/ 系统/ 运行/ 到/ 17000/ 节拍/ 时/ ,/ 有/ 6/ 个/ PE/ 完成/ 了/ 5000/ 个访/ 存图/ 664/ 结点/ 下/ 固定/ 工作/ 负载/ PE/ 完成/ 的/ 节拍/ 分布图/ 请求/ 的/ 既定/ 任务/ ,/ 而/ 在/ 21500/ 节拍/ 时/ ,/ 64/ 个/ PE/ 均/ 完成/ 了/ 既定/ 的/ 访存/ 任务/ ;/ 而/ 采用/ FR/ -/ FCFS/ 调度/ 方法/ ,/ 在/ 系统/ 运行/ 到/ 19500/ 节拍/ 时/ ,/ 第一个/ PE/ 才/ 完成/ 了/ 既定/ 的/ 访存/ 任务/ ,/ 在/ 26000/ 节拍/ 时/ ,/ 全部/ PE/ 才/ 完成/ 了/ 既定/ 的/ 访存/ 任务/ ./ 可见/ ,/ 相比/ FR/ -/ FCFS/ 方法/ ,/ SBNL/ 方法/ 能够/ 显著/ 地/ 减少/ 定额/ 工作/ 负载/ 的/ 平均/ 完成/ 时间/ 和/ 最后/ 完成/ 时间/ (/ 分别/ 为/ 12.8/ %/ 和/ 15.7/ %/ )/ ./ 5.5/ 与/ 已有/ 的/ NFQ/ 和/ STFM/ 方法/ 比较/ NFQ/ 方法/ [/ 10/ ]/ 和/ STFM/ 方法/ [/ 11/ ]/ 均/ 没有/ 考虑/ NoC/ 延时/ 的/ 差异/ ./ 如/ NFQ/ 方法/ 以/ 线程/ 访存/ 请求/ 到达/ MC/ 的/ 时间/ 作为/ 访存/ 请求/ 虚拟/ 运行/ 时间/ 的/ 开始/ ,/ 这/ 显然/ 是/ 不/ 准确/ 的/ ,/ 在/ 基于/ NoC/ 的/ 系统/ 中/ ,/ 这种/ 方法/ 将会/ 完全/ 忽略/ 访存/ 请求/ 的/ NoC/ 延时/ ;/ STFM/ 调度/ 方法/ 中/ 的/ Tshare/ 直接/ 由/ PE/ 计算/ 并/ 立即/ 传递/ 到/ MC/ 中/ ,/ 这/ 在/ 基于/ NoC/ 的/ CMPs/ 结构/ 中是/ 不/ 可能/ 实现/ 的/ ./ 本文/ 提出/ 的/ 方法/ 充分考虑/ NoC/ 延时/ 的/ 差异/ ,/ 并且/ 能够/ 与/ NFS/ 和/ STFM/ 方法/ 相结合/ ,/ 因而/ 具有/ 比较/ 明显/ 的/ 优势/ ./ 6/ 总结/ 及/ 进一步/ 的/ 研究/ NoC/ 延时/ 差异/ 逐渐/ 成为/ 影响/ CMPs/ 中/ 不同/ 线程/ 访问/ 外部/ 存储器/ 公平性/ 的/ 一个/ 重要/ 因素/ ,/ 本文/ 对/ 这/ 一/ 问题/ 进行/ 了/ 建模/ 并/ 构建/ 了/ 模拟/ 平台/ ,/ 从/ 4/ 个/ 方面/ 分析/ 了/ 对外部/ 存储系统/ 公平性/ 的/ 影响/ ,/ 提出/ 了/ SBNL/ 的/ 存储器/ 访问/ 调度/ 方法/ ./ 该/ 方法/ 与/ 传统/ 的/ 调度/ 方法/ 相比/ ,/ 能够/ 有效/ 地/ 减少/ NoC/ 延时/ 差异/ 对/ 访存/ 请求/ 公平性/ 的/ 影响/ ./ 下/ 一步/ 的/ 工作/ 是/ 在/ 系统/ 级/ 模拟/ 平台/ 中/ 寻求/ SBNL/ 方法/ 的/ 优化/ 及/ 改进/ 措施/ ./ 

